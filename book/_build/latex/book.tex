%% Generated by Sphinx.
\def\sphinxdocclass{jupyterBook}
\documentclass[letterpaper,10pt,english]{jupyterBook}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}
%% turn off hyperref patch of \index as sphinx.xdy xindy module takes care of
%% suitable \hyperpage mark-up, working around hyperref-xindy incompatibility
\PassOptionsToPackage{hyperindex=false}{hyperref}
%% memoir class requires extra handling
\makeatletter\@ifclassloaded{memoir}
{\ifdefined\memhyperindexfalse\memhyperindexfalse\fi}{}\makeatother

\PassOptionsToPackage{booktabs}{sphinx}
\PassOptionsToPackage{colorrows}{sphinx}

\PassOptionsToPackage{warn}{textcomp}

\catcode`^^^^00a0\active\protected\def^^^^00a0{\leavevmode\nobreak\ }
\usepackage{cmap}
\usepackage{fontspec}
\defaultfontfeatures[\rmfamily,\sffamily,\ttfamily]{}
\usepackage{amsmath,amssymb,amstext}
\usepackage{polyglossia}
\setmainlanguage{english}



\setmainfont{FreeSerif}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Italic,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldItalic
]
\setsansfont{FreeSans}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]
\setmonofont{FreeMono}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]



\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\contentsname}{Cover}}

\usepackage{sphinxmessages}



        % Start of preamble defined in sphinx-jupyterbook-latex %
         \usepackage[Latin,Greek]{ucharclasses}
        \usepackage{unicode-math}
        % fixing title of the toc
        \addto\captionsenglish{\renewcommand{\contentsname}{Contents}}
        \hypersetup{
            pdfencoding=auto,
            psdextra
        }
        % End of preamble defined in sphinx-jupyterbook-latex %
        

\title{The Neuroscience of AI}
\date{May 02, 2025}
\release{}
\author{Richard Young}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{intro::doc}}


\begin{DUlineblock}{0em}
\item[] \sphinxstylestrong{\Large Preface}
\end{DUlineblock}

\sphinxAtStartPar
This handbook bridges neuroscience and artificial intelligence, exploring how biological principles inspire and inform computational models. Each chapter combines theoretical foundations with practical Python implementations.

\begin{DUlineblock}{0em}
\item[] \sphinxstylestrong{\large Evidence\sphinxhyphen{}Based Educational Design}
\end{DUlineblock}

\sphinxAtStartPar
This book has been carefully designed using evidence\sphinxhyphen{}based educational principles to maximize learning effectiveness:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Clear Learning Objectives}: Each chapter begins with specific learning objectives that outline what you will be able to accomplish.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Knowledge Connections}: Special sections highlight relationships between concepts across different chapters, helping you build an integrated understanding.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Real\sphinxhyphen{}World Applications}: Application callout boxes connect abstract concepts to concrete, practical implementations in both research and industry.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual Consistency}: Diagrams and figures follow a consistent color scheme and design language (blue for neuroscience concepts, green for AI components, purple for hybrid approaches). The deep learning chapter (Chapter 10) exemplifies this approach with standardized SVG visualizations for neural architectures, optimization algorithms, regularization techniques, and biological parallels, making complex concepts immediately accessible through visual learning.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Comprehensive Glossary}: An alphabetically organized reference of key terms with cross\sphinxhyphen{}references to relevant chapters.

\end{enumerate}

\sphinxAtStartPar
The book is organized into five parts, progressing from foundational neuroscience concepts to cutting\sphinxhyphen{}edge AI applications:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brains \& Inspiration}: Fundamental neuroscience concepts relevant to AI

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brains Meet Math \& Data}: Quantitative approaches and data analysis techniques

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Learning Machines}: Classic and modern machine learning approaches

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Frontier Models}: State\sphinxhyphen{}of\sphinxhyphen{}the\sphinxhyphen{}art AI architectures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reflection \& Futures}: Emerging trends and ethical considerations

\end{enumerate}

\sphinxAtStartPar
Each chapter includes code examples, diagrams, and hands\sphinxhyphen{}on exercises to reinforce concepts.

\begin{DUlineblock}{0em}
\item[] \sphinxstylestrong{\large Recent Updates}
\end{DUlineblock}

\sphinxAtStartPar
We are pleased to announce that all chapters and appendices are now fully implemented with comprehensive content:

\begin{DUlineblock}{0em}
\item[] \sphinxstylestrong{\large Core Chapters}
\end{DUlineblock}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Foundations}: Neurons, neural circuits, brain regions, and their parallels to AI architectures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Spatial Navigation}: Grid cells, place cells, and cognitive maps with computational implementations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual Perception}: Visual processing pathways, object recognition, and computational vision models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Network Neuroscience}: Brain networks, connectivity, and computational approaches for modeling network dynamics

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neurostimulation \& Plasticity}: Neural plasticity mechanisms, neuromodulatory systems, and brain stimulation techniques

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Information Theory in Neuroscience}: Coding principles, mutual information, and efficient coding in neural systems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data Science Pipeline}: Preprocessing, analysis, and visualization techniques for neuroscience data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Machine Learning Foundations}: Supervised, unsupervised, and reinforcement learning with biological parallels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Deep Learning Fundamentals}: Neural networks, backpropagation, optimization techniques, and regularization methods with comprehensive visual diagrams illustrating neural architectures, optimization algorithms, regularization techniques, and biological parallels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sequence Processing Models}: RNNs, attention mechanisms, and transformer architectures with biological parallels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Large Language Models}: Comprehensive overview of LLM architectures, fine\sphinxhyphen{}tuning approaches, and connections to neural language processing

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal \& Diffusion Models}: Multimodal learning architectures, diffusion model principles, and neural multimodal integration

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Future Research Directions}: Neuromorphic computing, continual learning, AI for neuroscience, and ethical considerations

\end{itemize}

\begin{DUlineblock}{0em}
\item[] \sphinxstylestrong{\large Enhanced Appendices}
\end{DUlineblock}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Comprehensive Glossary}: Alphabetically organized glossary of key terms with cross\sphinxhyphen{}references to relevant chapters

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Math \& Python Mini\sphinxhyphen{}Refresher}: Comprehensive review of essential linear algebra, calculus, probability, and core Python libraries for NeuroAI

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dataset Catalogue}: Extensive collection of neuroscience, AI, and NeuroAI\sphinxhyphen{}specific datasets with usage examples

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Google Colab Setup}: Detailed guide to setting up and optimizing Google Colab for NeuroAI research, including memory management, data handling, and visualization techniques

\end{itemize}

\sphinxAtStartPar
Each chapter and appendix includes practical code labs, detailed figures, and extensive references to help readers implement and experiment with these technologies.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Cover

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{cover::doc}]{\sphinxcrossref{Cover}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part I · Brains \& Inspiration

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part1/ch01_intro::doc}]{\sphinxcrossref{Chapter 1: Introduction to Neuroscience ↔ AI}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part1/ch02_neuro_foundations::doc}]{\sphinxcrossref{Chapter 2: Neuroscience Foundations for AI}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part1/ch03_spatial_navigation::doc}]{\sphinxcrossref{Chapter 3: Spatial Navigation – Place \& Grid Cells}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part1/ch04_perception_pipeline::doc}]{\sphinxcrossref{Chapter 4: Perception Pipeline – Visual Cortex → CNNs}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part II · Brains Meet Math \& Data

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part2/ch05_brain_networks::doc}]{\sphinxcrossref{Chapter 5: Default\sphinxhyphen{}Mode vs Executive Control Networks}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part2/ch06_neurostimulation::doc}]{\sphinxcrossref{Chapter 6: Neurostimulation \& Plasticity}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part2/ch07_information_theory::doc}]{\sphinxcrossref{Chapter 7: Information Theory Essentials}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part2/ch08_data_science_pipeline::doc}]{\sphinxcrossref{Chapter 8: Data\sphinxhyphen{}Science Pipeline in Python}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part III · Learning Machines

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part3/ch09_ml_foundations::doc}]{\sphinxcrossref{Chapter 9: Classical Machine\sphinxhyphen{}Learning Foundations}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part3/ch10_deep_learning::doc}]{\sphinxcrossref{Chapter 10: Deep Learning: Training \& Optimisation}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part3/ch11_sequence_models::doc}]{\sphinxcrossref{Chapter 11: Sequence Models: RNN → Attention → Transformer}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part IV · Frontier Models

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part4/ch12_large_language_models::doc}]{\sphinxcrossref{Chapter 12: Large Language Models \& Fine\sphinxhyphen{}Tuning}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part4/ch13_multimodal_models::doc}]{\sphinxcrossref{Chapter 13: Multimodal \& Diffusion Models}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part V · Ethics \& Futures

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part5/ch15_ethical_ai::doc}]{\sphinxcrossref{Chapter 15: Ethical AI \sphinxhyphen{} Considerations for NeuroAI}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part5/ch16_future_directions::doc}]{\sphinxcrossref{Chapter 16: Where Next for Neuro\sphinxhyphen{}AI?}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Part VI · Advanced Applications

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch17_bci_human_ai_interfaces::doc}]{\sphinxcrossref{Brain\sphinxhyphen{}Computer Interfaces and Human\sphinxhyphen{}AI Interaction}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch18_neuromorphic_computing::doc}]{\sphinxcrossref{Chapter 18: Neuromorphic Computing}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch19_cognitive_neuro_dl::doc}]{\sphinxcrossref{Cognitive Neuroscience and Deep Learning}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch20_case_studies::doc}]{\sphinxcrossref{Case Studies in NeuroAI}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch21_ai_for_neuro_discovery::doc}]{\sphinxcrossref{Chapter 21: AI for Neuroscience Discovery}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch22_embodied_ai_robotics::doc}]{\sphinxcrossref{Chapter 22: Embodied AI and Robotics}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch24_quantum_computing_neuroai::doc}]{\sphinxcrossref{Chapter 24: Quantum Computing and NeuroAI}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{part6/ch23_lifelong_learning::doc}]{\sphinxcrossref{Chapter 23: Lifelong Learning}}}

\end{itemize}
\end{itemize}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Appendices

\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{appendices/glossary::doc}]{\sphinxcrossref{Glossary}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{appendices/math_python_refresher::doc}]{\sphinxcrossref{Appendix A: Math \& Python Mini\sphinxhyphen{}Refresher}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{appendices/dataset_catalogue::doc}]{\sphinxcrossref{Appendix B: Dataset Catalogue}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{appendices/colab_setup::doc}]{\sphinxcrossref{Appendix C: Google Colab Setup for NeuroAI}}}

\end{itemize}
\end{itemize}

\sphinxstepscope


\part{Cover}

\sphinxstepscope


\chapter{Cover Page}
\label{\detokenize{cover:cover-page}}\label{\detokenize{cover::doc}}
\begin{titlepage}
    \centering
    \vspace*{5cm}
    {\Huge\bfseries The Neuroscience of AI\par}
    \vspace{2cm}
    {\Large\itshape Richard Young\par}
    \vspace{4cm}
    \includegraphics[width=0.6\textwidth]{nai_transparent.png}
    \vfill
\end{titlepage}
\clearpage

\sphinxstepscope


\part{Part I · Brains \& Inspiration}

\sphinxstepscope


\chapter{Chapter 1: Introduction to Neuroscience ↔ AI}
\label{\detokenize{part1/ch01_intro:chapter-1-introduction-to-neuroscience-ai}}\label{\detokenize{part1/ch01_intro::doc}}
\begin{sphinxadmonition}{note}{Learning Objectives}

\sphinxAtStartPar
By the end of this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Trace} the historical development of neuroscience and AI as interconnected fields

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Identify} key parallels between biological neural systems and artificial neural networks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Explain} how biological principles have inspired major AI advances

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Describe} how modern AI tools contribute to neuroscience research

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implement} basic simulations demonstrating bio\sphinxhyphen{}inspired computational principles

\end{itemize}
\end{sphinxadmonition}


\section{1.1 Historical Context}
\label{\detokenize{part1/ch01_intro:historical-context}}
\sphinxAtStartPar
The relationship between neuroscience and artificial intelligence is deeply intertwined, with each field influencing the other across decades of research. Understanding this history helps frame modern developments in both disciplines.

\sphinxAtStartPar
\sphinxincludegraphics{{neuro_ai_timeline_large}.svg}
\sphinxstyleemphasis{Figure 1.1: Historical timeline showing the parallel development of neuroscience and AI, with key moments of cross\sphinxhyphen{}fertilization.}

\sphinxAtStartPar
\sphinxincludegraphics{{neuro_ai_history_large}.svg}
\sphinxstyleemphasis{Figure 1.2: Key milestones in the parallel development of neuroscience and artificial intelligence, showing how the fields have converged over time.}

\sphinxAtStartPar
\sphinxincludegraphics{{neuron_vs_perceptron_large}.svg}
\sphinxstyleemphasis{Figure 1.3: Comparison between a biological neuron and an artificial perceptron, showing structural and functional parallels.}


\subsection{1.1.1 Early Foundations}
\label{\detokenize{part1/ch01_intro:early-foundations}}
\sphinxAtStartPar
The foundational ideas that would become AI emerged from attempts to understand and model how the brain processes information:

\sphinxAtStartPar
\sphinxstylestrong{Cybernetics (1940s\sphinxhyphen{}1950s)} established the concept of feedback control systems, inspired by how biological organisms maintain homeostasis. Norbert Wiener defined cybernetics as “the scientific study of control and communication in the animal and the machine,” highlighting the cross\sphinxhyphen{}disciplinary approach.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}feedback\PYGZus{}system}\PYG{p}{(}\PYG{n}{target}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{n}{gain}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{steps}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate a simple feedback control system with noise.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{state} \PYG{o}{=} \PYG{n}{initial\PYGZus{}state}
    \PYG{n}{states} \PYG{o}{=} \PYG{p}{[}\PYG{n}{state}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Measure error (difference between current state and target)}
        \PYG{n}{error} \PYG{o}{=} \PYG{n}{target} \PYG{o}{\PYGZhy{}} \PYG{n}{state}
        
        \PYG{c+c1}{\PYGZsh{} Apply correction based on error and gain factor}
        \PYG{n}{correction} \PYG{o}{=} \PYG{n}{gain} \PYG{o}{*} \PYG{n}{error}
        
        \PYG{c+c1}{\PYGZsh{} Add some noise to simulate real\PYGZhy{}world conditions}
        \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update state}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{state} \PYG{o}{+} \PYG{n}{correction} \PYG{o}{+} \PYG{n}{noise}
        \PYG{n}{states}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{states}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example: Simulate homeostatic control (like body temperature regulation)}
\PYG{n}{target\PYGZus{}value} \PYG{o}{=} \PYG{l+m+mf}{37.0}  \PYG{c+c1}{\PYGZsh{} Target temperature (e.g., human body temperature)}
\PYG{n}{initial\PYGZus{}value} \PYG{o}{=} \PYG{l+m+mf}{36.0}  \PYG{c+c1}{\PYGZsh{} Starting below target}

\PYG{c+c1}{\PYGZsh{} Compare different gain factors}
\PYG{n}{gains} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{gain} \PYG{o+ow}{in} \PYG{n}{gains}\PYG{p}{:}
    \PYG{n}{states} \PYG{o}{=} \PYG{n}{simple\PYGZus{}feedback\PYGZus{}system}\PYG{p}{(}\PYG{n}{target\PYGZus{}value}\PYG{p}{,} \PYG{n}{initial\PYGZus{}value}\PYG{p}{,} \PYG{n}{gain}\PYG{o}{=}\PYG{n}{gain}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{states}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gain = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{gain}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{target\PYGZus{}value}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Target}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Steps}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{System State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feedback Control System (Cybernetic Principle)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} plt.show()  \PYGZsh{} Uncomment to display the plot}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{McCulloch \& Pitts Neurons (1943)} provided the first mathematical model of a neuron, showing how simple logical operations could be performed by binary threshold units. This model represented neurons as boolean logic gates that fire when their inputs exceed a threshold—a framework that remains influential today.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{mcculloch\PYGZus{}pitts\PYGZus{}neuron}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{,} \PYG{n}{threshold}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of a McCulloch\PYGZhy{}Pitts neuron.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        inputs: Binary input values (0 or 1)}
\PYG{l+s+sd}{        weights: Connection weights (typically 1 or \PYGZhy{}1 for excitatory/inhibitory)}
\PYG{l+s+sd}{        threshold: Activation threshold}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        1 if weighted sum of inputs meets/exceeds threshold, 0 otherwise}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{i} \PYG{o}{*} \PYG{n}{w} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{w} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{threshold} \PYG{k}{else} \PYG{l+m+mi}{0}

\PYG{c+c1}{\PYGZsh{} Example: Implement logical operations with McCulloch\PYGZhy{}Pitts neurons}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{logical\PYGZus{}AND}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{mcculloch\PYGZus{}pitts\PYGZus{}neuron}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{logical\PYGZus{}OR}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{mcculloch\PYGZus{}pitts\PYGZus{}neuron}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{logical\PYGZus{}NOT}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{mcculloch\PYGZus{}pitts\PYGZus{}neuron}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Test the logical operations}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{McCulloch\PYGZhy{}Pitts Neuron Implementation:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AND(0,0) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}AND}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Expected: 0}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AND(1,0) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}AND}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Expected: 0}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AND(0,1) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}AND}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Expected: 0}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AND(1,1) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}AND}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Expected: 1}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{OR(0,0) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}OR}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} Expected: 0}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{OR(1,0) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}OR}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} Expected: 1}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NOT(0) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}NOT}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}       \PYG{c+c1}{\PYGZsh{} Expected: 1}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NOT(1) =}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{logical\PYGZus{}NOT}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}       \PYG{c+c1}{\PYGZsh{} Expected: 0}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Von Neumann Architecture (1945)} established the foundational computing paradigm that separates memory and processing—quite different from the brain’s integrated approach. Despite this architectural divergence, von Neumann drew inspiration from neuroscience, writing about neural networks and brain\sphinxhyphen{}like computing in his unfinished work “The Computer and the Brain” (1958).


\subsection{1.1.2 Neural Networks: First Wave}
\label{\detokenize{part1/ch01_intro:neural-networks-first-wave}}
\sphinxAtStartPar
The late 1950s and 1960s brought significant developments in neural network research, directly inspired by biological principles:

\sphinxAtStartPar
\sphinxstylestrong{The Perceptron (1957)} was developed by Frank Rosenblatt as the first trainable neural network model. Unlike the static McCulloch\sphinxhyphen{}Pitts neuron, the perceptron featured an adaptive learning algorithm that modified connection weights based on errors—mirroring aspects of neural plasticity.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Perceptron}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple perceptron implementation.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            n\PYGZus{}inputs: Number of input features}
\PYG{l+s+sd}{            learning\PYGZus{}rate: Learning rate for weight updates}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize weights with small random values (including bias)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}inputs} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Make a prediction for the given inputs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Add bias input}
        \PYG{n}{inputs\PYGZus{}with\PYGZus{}bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Calculate weighted sum}
        \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{inputs\PYGZus{}with\PYGZus{}bias}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Apply step activation function}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{training\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train the perceptron on the given data.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{total\PYGZus{}error} \PYG{o}{=} \PYG{l+m+mi}{0}
            
            \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{training\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Make prediction}
                \PYG{n}{prediction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
                \PYG{c+c1}{\PYGZsh{} Calculate error}
                \PYG{n}{error} \PYG{o}{=} \PYG{n}{label} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction}
                \PYG{n}{total\PYGZus{}error} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}
                
                \PYG{k}{if} \PYG{n}{error} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Update weights (including bias)}
                    \PYG{n}{inputs\PYGZus{}with\PYGZus{}bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{error} \PYG{o}{*} \PYG{n}{inputs\PYGZus{}with\PYGZus{}bias}
            
            \PYG{c+c1}{\PYGZsh{} If no errors, we\PYGZsq{}ve converged}
            \PYG{k}{if} \PYG{n}{total\PYGZus{}error} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{k}{break}
                
\PYG{c+c1}{\PYGZsh{} Example: Train a perceptron to learn the AND function}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} AND function}

\PYG{n}{perceptron} \PYG{o}{=} \PYG{n}{Perceptron}\PYG{p}{(}\PYG{n}{n\PYGZus{}inputs}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{perceptron}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Perceptron Implementation for AND Function:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{inputs} \PYG{o+ow}{in} \PYG{n}{X}\PYG{p}{:}
    \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{perceptron}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Inputs: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{inputs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Prediction: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{prediction}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Limitations and AI Winter (1969\sphinxhyphen{}1980s)}: Marvin Minsky and Seymour Papert’s book “Perceptrons” (1969) highlighted the inability of single\sphinxhyphen{}layer perceptrons to learn non\sphinxhyphen{}linearly separable functions like XOR. This critique, combined with computational limitations of the era, led to the first “AI winter”—a period of reduced funding and interest in neural network research.


\subsection{1.1.3 Revival and Modern Neural Networks}
\label{\detokenize{part1/ch01_intro:revival-and-modern-neural-networks}}
\sphinxAtStartPar
Interest in neural networks resurged in the 1980s and 1990s, driven by several key developments:

\sphinxAtStartPar
\sphinxstylestrong{Backpropagation Algorithm (1986)} by Rumelhart, Hinton, and Williams solved the training problem for multi\sphinxhyphen{}layer networks, enabling them to learn complex, non\sphinxhyphen{}linear patterns. Though the algorithm itself doesn’t directly model biological learning processes, it shares conceptual similarities with error\sphinxhyphen{}driven learning in the brain.

\sphinxAtStartPar
\sphinxstylestrong{Deep Learning Renaissance (2006\sphinxhyphen{}present)} began with breakthroughs in unsupervised pre\sphinxhyphen{}training for deep networks by Hinton, Bengio, and others. The increasing availability of computational resources and large datasets has enabled neural networks of unprecedented scale and capability, including models with billions of parameters.

\sphinxAtStartPar
Today, neuroscience and AI maintain a productive bidirectional relationship:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Deep learning models inform hypotheses about brain function

\item {} 
\sphinxAtStartPar
Neuroscience insights continue to inspire architectural innovations in AI

\item {} 
\sphinxAtStartPar
Tools from both fields are increasingly used to explore the other

\end{itemize}


\section{1.2 Levels of Analysis}
\label{\detokenize{part1/ch01_intro:levels-of-analysis}}
\sphinxAtStartPar
To bridge neuroscience and AI effectively, we need conceptual frameworks that span both disciplines. David Marr’s influential three\sphinxhyphen{}level approach provides an elegant structure for this comparison.


\subsection{1.2.1 Marr’s Three Levels}
\label{\detokenize{part1/ch01_intro:marr-s-three-levels}}
\sphinxAtStartPar
David Marr (1982) proposed analyzing information processing systems at three distinct levels:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational Level}: What is the system trying to accomplish and why?
\begin{itemize}
\item {} 
\sphinxAtStartPar
The goals, functions, and abstract problems being solved

\item {} 
\sphinxAtStartPar
Example: Object recognition, prediction, decision\sphinxhyphen{}making

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Algorithmic Level}: What specific representations and procedures implement the computation?
\begin{itemize}
\item {} 
\sphinxAtStartPar
The information formats and processing approaches

\item {} 
\sphinxAtStartPar
Example: Hierarchical feature extraction, error backpropagation

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implementational Level}: How are the algorithms physically realized?
\begin{itemize}
\item {} 
\sphinxAtStartPar
The physical substrate and mechanisms

\item {} 
\sphinxAtStartPar
Example: Neurons and synapses vs. silicon transistors

\end{itemize}

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{marrs\PYGZus{}levels\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate Marr\PYGZsq{}s three levels for object recognition.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{marrs\PYGZus{}levels} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{computational}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Identify objects regardless of viewpoint, lighting, and context}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ai}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Classify images into predefined categories with high accuracy}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{algorithmic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical processing from simple features (edges) to complex patterns (shapes) to object identities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ai}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Convolutional neural network with feature extraction, pooling, and classification layers}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementational}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neurons connected by synapses, organized in specialized regions (V1→V2→V4→IT)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ai}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Matrix multiplications and non\PYGZhy{}linear activations implemented on GPU hardware}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{marrs\PYGZus{}levels}

\PYG{c+c1}{\PYGZsh{} Display the comparison of Marr\PYGZsq{}s levels between brain and AI systems}
\PYG{n}{marrs\PYGZus{}comparison} \PYG{o}{=} \PYG{n}{marrs\PYGZus{}levels\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{level}\PYG{p}{,} \PYG{n}{systems} \PYG{o+ow}{in} \PYG{n}{marrs\PYGZus{}comparison}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}\PYGZhy{}\PYGZhy{} }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{level}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ LEVEL \PYGZhy{}\PYGZhy{}\PYGZhy{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Brain: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{systems}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brain}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AI:    }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{systems}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ai}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This framework helps us identify where brain\sphinxhyphen{}inspired AI systems truly parallel biological processing versus where they diverge. Often, modern AI systems implement similar computational and algorithmic principles to the brain but through radically different implementations.


\subsection{1.2.2 From Neurons to Networks to Behavior}
\label{\detokenize{part1/ch01_intro:from-neurons-to-networks-to-behavior}}
\sphinxAtStartPar
Neuroscience operates across multiple scales of analysis, each with parallels in artificial systems:


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Level
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Neuroscience
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Artificial Intelligence
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
Micro
&
\sphinxAtStartPar
Neurons, synapses, ion channels
&
\sphinxAtStartPar
Artificial neurons, weights, activation functions
\\
\sphinxhline
\sphinxAtStartPar
Meso
&
\sphinxAtStartPar
Circuits, columns, local networks
&
\sphinxAtStartPar
Layers, blocks, attention heads
\\
\sphinxhline
\sphinxAtStartPar
Macro
&
\sphinxAtStartPar
Brain regions, functional networks
&
\sphinxAtStartPar
Full models, system architectures
\\
\sphinxhline
\sphinxAtStartPar
Behavioral
&
\sphinxAtStartPar
Perception, cognition, decision\sphinxhyphen{}making
&
\sphinxAtStartPar
Computer vision, NLP, reinforcement learning
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxAtStartPar
This multi\sphinxhyphen{}scale view emphasizes that both brains and AI systems achieve complex behavior through hierarchical organization of simpler components, though the details differ substantially.


\subsection{1.2.3 Computational Neuroscience Approaches}
\label{\detokenize{part1/ch01_intro:computational-neuroscience-approaches}}
\sphinxAtStartPar
Computational neuroscience seeks to understand neural systems through mathematical models and simulations, forming a natural bridge to AI:

\sphinxAtStartPar
\sphinxstylestrong{Biophysical Models} capture the detailed dynamics of neurons and synapses:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hodgkin\sphinxhyphen{}Huxley models of action potentials

\item {} 
\sphinxAtStartPar
Compartmental models of dendritic integration

\item {} 
\sphinxAtStartPar
Synaptic plasticity models (STDP, homeostasis)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Network Models} focus on collective dynamics and computation:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Recurrent network models of working memory

\item {} 
\sphinxAtStartPar
Attractor networks for decision\sphinxhyphen{}making

\item {} 
\sphinxAtStartPar
Predictive coding models of perception

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Normative Models} ask why the brain operates as it does:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Bayesian inference frameworks

\item {} 
\sphinxAtStartPar
Free energy principle

\item {} 
\sphinxAtStartPar
Optimal control theory

\end{itemize}

\sphinxAtStartPar
These approaches have directly influenced AI architectures, from spiking neural networks to probabilistic generative models.


\section{1.3 Key Parallels}
\label{\detokenize{part1/ch01_intro:key-parallels}}
\sphinxAtStartPar
Despite very different physical substrates, biological and artificial neural systems share fundamental computational principles. Here we explore key parallels that highlight their common heritage.


\subsection{1.3.1 Information Processing Units}
\label{\detokenize{part1/ch01_intro:information-processing-units}}
\sphinxAtStartPar
At their core, both biological and artificial systems use simple processing units combined into powerful networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{biological\PYGZus{}neuron\PYGZus{}model}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{,} \PYG{n}{threshold}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simplified model of biological neuron activation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{inputs} \PYG{o}{*} \PYG{n}{weights}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Non\PYGZhy{}linear activation with refractory period}
    \PYG{k}{if} \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} Spike and refractory period (in ms)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} No spike, no refractory period}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{artificial\PYGZus{}neuron\PYGZus{}model}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{,} \PYG{n}{bias}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Standard artificial neuron with ReLU activation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{weighted\PYGZus{}sum} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{inputs} \PYG{o}{*} \PYG{n}{weights}\PYG{p}{)} \PYG{o}{+} \PYG{n}{bias}
    \PYG{c+c1}{\PYGZsh{} ReLU activation function}
    \PYG{k}{return} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{weighted\PYGZus{}sum}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compare action potential with artificial neuron activation}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}activations}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the difference between biological and artificial neuron activation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Input stimulus values}
    \PYG{n}{stimulus} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Biological neuron (simplified threshold model)}
    \PYG{n}{bio\PYGZus{}outputs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n}{stimulus}\PYG{p}{:}
        \PYG{n}{spike}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{biological\PYGZus{}neuron\PYGZus{}model}\PYG{p}{(}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{)}
        \PYG{n}{bio\PYGZus{}outputs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{spike} \PYG{o}{*} \PYG{l+m+mi}{5}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Scale for visualization}
        
    \PYG{c+c1}{\PYGZsh{} Artificial neuron (ReLU)}
    \PYG{n}{art\PYGZus{}outputs} \PYG{o}{=} \PYG{p}{[}\PYG{n}{artificial\PYGZus{}neuron\PYGZus{}model}\PYG{p}{(}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)} \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n}{stimulus}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Plot comparison}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{bio\PYGZus{}outputs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Biological (Threshold)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{art\PYGZus{}outputs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Artificial (ReLU)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Stimulus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparing Biological vs. Artificial Neuron Activation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}
    
\PYG{c+c1}{\PYGZsh{} compare\PYGZus{}activations().show()  \PYGZsh{} Uncomment to display}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Biological Neurons} are cellular information processors with:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dendritic integration of thousands of inputs

\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}linear activation via action potentials

\item {} 
\sphinxAtStartPar
Temporal dynamics (spiking, refractory periods)

\item {} 
\sphinxAtStartPar
Multiple time scales of operation

\item {} 
\sphinxAtStartPar
Extreme energy efficiency (\textasciitilde{}10\textasciicircum{}\sphinxhyphen{}16 joules per operation)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Artificial Neurons} are mathematical abstractions that capture key computational features:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Weighted summation of inputs

\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}linear activation functions (ReLU, sigmoid, etc.)

\item {} 
\sphinxAtStartPar
Static, discrete\sphinxhyphen{}time operation (typically)

\item {} 
\sphinxAtStartPar
Focus on rate\sphinxhyphen{}based rather than spike\sphinxhyphen{}based processing

\item {} 
\sphinxAtStartPar
Higher energy consumption (\textasciitilde{}10\textasciicircum{}\sphinxhyphen{}9 joules per operation)

\end{itemize}

\sphinxAtStartPar
While artificial neurons greatly simplify the complexity of biological neurons, they preserve the essential computational motif: inputs are weighted, summed, and non\sphinxhyphen{}linearly transformed to produce output.


\subsection{1.3.2 Network Architectures}
\label{\detokenize{part1/ch01_intro:network-architectures}}
\sphinxAtStartPar
Both biological and artificial systems organize neurons into structured networks that determine information flow:

\sphinxAtStartPar
\sphinxstylestrong{Biological Networks} feature:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Layered organization (e.g., cortical layers)

\item {} 
\sphinxAtStartPar
Both feedforward and recurrent connections

\item {} 
\sphinxAtStartPar
Specialized regions for different processes

\item {} 
\sphinxAtStartPar
Multi\sphinxhyphen{}scale organization (columns, areas, systems)

\item {} 
\sphinxAtStartPar
Complex connectivity patterns (small\sphinxhyphen{}world properties)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Artificial Networks} have evolved increasingly sophisticated architectures:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Deep feedforward networks (MLPs, CNNs)

\item {} 
\sphinxAtStartPar
Recurrent architectures (RNNs, LSTMs)

\item {} 
\sphinxAtStartPar
Attention\sphinxhyphen{}based systems (Transformers)

\item {} 
\sphinxAtStartPar
Graph neural networks

\item {} 
\sphinxAtStartPar
Modular, multi\sphinxhyphen{}model architectures

\end{itemize}

\sphinxAtStartPar
Recent AI innovations like attention mechanisms and residual connections have interesting parallels in the brain, suggesting convergent discovery of efficient architectural principles.


\subsection{1.3.3 Learning Mechanisms}
\label{\detokenize{part1/ch01_intro:learning-mechanisms}}
\sphinxAtStartPar
Learning allows both biological and artificial systems to adapt to environmental regularities:

\sphinxAtStartPar
\sphinxstylestrong{Biological Learning} involves:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hebbian plasticity (“neurons that fire together, wire together”)

\item {} 
\sphinxAtStartPar
Spike\sphinxhyphen{}timing\sphinxhyphen{}dependent plasticity (STDP)

\item {} 
\sphinxAtStartPar
Neuromodulatory signals (dopamine, acetylcholine)

\item {} 
\sphinxAtStartPar
Structural changes (synaptogenesis, pruning)

\item {} 
\sphinxAtStartPar
Multiple time scales (short\sphinxhyphen{}term to lifelong)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Artificial Learning} typically employs:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Gradient\sphinxhyphen{}based optimization

\item {} 
\sphinxAtStartPar
Backpropagation of errors

\item {} 
\sphinxAtStartPar
Various loss functions targeting different objectives

\item {} 
\sphinxAtStartPar
Regularization techniques

\item {} 
\sphinxAtStartPar
Transfer learning and meta\sphinxhyphen{}learning

\end{itemize}

\sphinxAtStartPar
While the specific mechanisms differ substantially, both systems fundamentally adapt connection strengths to minimize errors and optimize performance on relevant tasks.


\subsection{1.3.4 Representational Properties}
\label{\detokenize{part1/ch01_intro:representational-properties}}
\sphinxAtStartPar
How information is encoded and transformed is a key parallel between neural systems:

\sphinxAtStartPar
\sphinxstylestrong{Distributed Representations} are used by both systems:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Information is encoded across populations of units

\item {} 
\sphinxAtStartPar
Provides robustness to noise and damage

\item {} 
\sphinxAtStartPar
Enables efficient generalization

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Feature Extraction} is a shared organizing principle:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Simple features combine into increasingly complex representations

\item {} 
\sphinxAtStartPar
Abstraction increases along processing pathways

\item {} 
\sphinxAtStartPar
Enables recognition invariant to irrelevant variations

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Attentional Mechanisms} focus processing on relevant information:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Selective enhancement of important signals

\item {} 
\sphinxAtStartPar
Suppression of irrelevant information

\item {} 
\sphinxAtStartPar
Dynamic routing of information flow

\end{itemize}

\sphinxAtStartPar
These shared representational strategies highlight how both biological and artificial systems solve similar computational challenges.


\section{1.4 Case Studies}
\label{\detokenize{part1/ch01_intro:case-studies}}
\sphinxAtStartPar
Examining specific domains where neuroscience and AI intersect provides concrete examples of their productive relationship.


\subsection{1.4.1 Object Recognition: Visual Cortex vs. CNNs}
\label{\detokenize{part1/ch01_intro:object-recognition-visual-cortex-vs-cnns}}
\sphinxAtStartPar
Visual processing represents one of the clearest examples of neuroscience informing AI development:

\sphinxAtStartPar
\sphinxstylestrong{Visual Cortex Organization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hierarchical processing pathway (V1→V2→V4→IT)

\item {} 
\sphinxAtStartPar
Simple cells detect oriented edges; complex cells detect movement

\item {} 
\sphinxAtStartPar
Increasing receptive field size and abstraction along the pathway

\item {} 
\sphinxAtStartPar
Dorsal “where” and ventral “what” streams

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{CNN Parallels}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hierarchical layer structure with increasing abstraction

\item {} 
\sphinxAtStartPar
Convolutional filters detect oriented edges in early layers

\item {} 
\sphinxAtStartPar
Pooling operations provide translation invariance (like complex cells)

\item {} 
\sphinxAtStartPar
Higher layers develop object detectors similar to IT neurons

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}feature\PYGZus{}hierarchy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate the hierarchy of features in visual processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{feature\PYGZus{}hierarchy} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{level1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1 simple cells: Oriented edges, bars, gratings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cnn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{First conv layer: Edge detectors, Gabor\PYGZhy{}like filters}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{level2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V2: Combinations of edges, contours, texture patterns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cnn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mid\PYGZhy{}level conv layers: Corners, textures, simple shapes}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{level3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V4: Shape fragments, curved contours, color patterns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cnn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Higher conv layers: Object parts, complex patterns}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{level4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IT: Object\PYGZhy{}selective cells, face cells, scene cells}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cnn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Final layers: Object detectors, scene classifiers}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} In a real notebook, this would generate a visualization of the hierarchy}
    \PYG{k}{return} \PYG{n}{feature\PYGZus{}hierarchy}

\end{sphinxVerbatim}

\sphinxAtStartPar
The parallels between primate vision and CNNs are so strong that CNN activations can predict neural responses in visual cortex with remarkable accuracy. Yamins et al. (2014) showed that the internal representations of CNNs trained on object recognition match neural recordings from macaque IT better than any previous computational model.


\subsection{1.4.2 Reinforcement Learning and Reward Systems}
\label{\detokenize{part1/ch01_intro:reinforcement-learning-and-reward-systems}}
\sphinxAtStartPar
Reinforcement learning (RL) algorithms draw direct inspiration from neural reward systems:

\sphinxAtStartPar
\sphinxstylestrong{Brain Reward Mechanisms}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dopaminergic neurons encode reward prediction errors

\item {} 
\sphinxAtStartPar
Ventral striatum and orbitofrontal cortex represent expected value

\item {} 
\sphinxAtStartPar
Basal ganglia implement action selection through competitive dynamics

\item {} 
\sphinxAtStartPar
Multiple learning systems (model\sphinxhyphen{}free and model\sphinxhyphen{}based)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{RL Algorithms}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Temporal difference learning captures dopamine\sphinxhyphen{}like prediction errors

\item {} 
\sphinxAtStartPar
Value function approximation parallels striatal value encoding

\item {} 
\sphinxAtStartPar
Actor\sphinxhyphen{}critic architectures reflect basal ganglia organization

\item {} 
\sphinxAtStartPar
Model\sphinxhyphen{}free and model\sphinxhyphen{}based RL mirror distinct neural learning systems

\end{itemize}

\sphinxAtStartPar
This bidirectional relationship has been particularly fruitful: neuroscience findings directly informed RL algorithms, while RL concepts now provide theoretical frameworks for interpreting neural data.


\subsection{1.4.3 Memory Systems and Neural Networks}
\label{\detokenize{part1/ch01_intro:memory-systems-and-neural-networks}}
\sphinxAtStartPar
Memory processes in the brain have inspired various artificial architectures:

\sphinxAtStartPar
\sphinxstylestrong{Hippocampal Memory System}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Specialized for one\sphinxhyphen{}shot learning of episodic memories

\item {} 
\sphinxAtStartPar
Pattern separation (dentate gyrus) and pattern completion (CA3)

\item {} 
\sphinxAtStartPar
Consolidation of memories from hippocampus to neocortex

\item {} 
\sphinxAtStartPar
Replay of experiences during sleep for memory reinforcement

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Artificial Memory Systems}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Memory\sphinxhyphen{}augmented neural networks (e.g., Neural Turing Machines)

\item {} 
\sphinxAtStartPar
Differentiable Neural Computers with external memory matrices

\item {} 
\sphinxAtStartPar
Episodic memory modules in reinforcement learning agents

\item {} 
\sphinxAtStartPar
Replay buffers in experience replay for deep RL

\end{itemize}

\sphinxAtStartPar
These artificial memory systems don’t replicate biological processes in detail but employ similar computational strategies for rapid learning and efficient storage.


\section{1.5 Current Challenges}
\label{\detokenize{part1/ch01_intro:current-challenges}}
\sphinxAtStartPar
Despite significant progress, substantial gaps remain between biological and artificial neural systems.


\subsection{1.5.1 Scale and Complexity Differences}
\label{\detokenize{part1/ch01_intro:scale-and-complexity-differences}}
\sphinxAtStartPar
Brains vastly exceed current AI systems in scale and complexity:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The human brain contains \textasciitilde{}86 billion neurons and \textasciitilde{}100 trillion synapses

\item {} 
\sphinxAtStartPar
Neurons themselves are complex computational units with thousands of inputs

\item {} 
\sphinxAtStartPar
Brain networks exhibit small\sphinxhyphen{}world topology with high clustering and short path lengths

\item {} 
\sphinxAtStartPar
Multiple neurotransmitter systems modulate neural dynamics and learning

\end{itemize}

\sphinxAtStartPar
While modern AI systems reach billions of parameters, they remain simpler in structure and typically lack the multi\sphinxhyphen{}scale organization of brains.


\subsection{1.5.2 Energy Efficiency Gap}
\label{\detokenize{part1/ch01_intro:energy-efficiency-gap}}
\sphinxAtStartPar
Perhaps the most dramatic difference is in energy consumption:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}efficiency}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare energy efficiency of brains vs. AI systems.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Energy usage data in watts}
    \PYG{n}{systems} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Human Brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{20}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mouse Brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.001}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}3 Training (peak)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.5e6}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Estimated}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AlphaGo vs Lee Sedol}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e3}\PYG{p}{,}     \PYG{c+c1}{\PYGZsh{} Estimated}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Typical GPU Inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{250}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Operations per second (estimated)}
    \PYG{n}{ops\PYGZus{}per\PYGZus{}second} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Human Brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e16}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Very rough estimate}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mouse Brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e14}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Very rough estimate}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}3 Training (peak)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e20}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AlphaGo vs Lee Sedol}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e15}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Typical GPU Inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1e12}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Calculate operations per joule (efficiency)}
    \PYG{n}{efficiency} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{system}\PYG{p}{:} \PYG{n}{ops\PYGZus{}per\PYGZus{}second}\PYG{p}{[}\PYG{n}{system}\PYG{p}{]} \PYG{o}{/} \PYG{n}{systems}\PYG{p}{[}\PYG{n}{system}\PYG{p}{]} \PYG{k}{for} \PYG{n}{system} \PYG{o+ow}{in} \PYG{n}{systems}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Return comparison data}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power\PYGZus{}usage\PYGZus{}watts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{systems}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ops\PYGZus{}per\PYGZus{}second}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{ops\PYGZus{}per\PYGZus{}second}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ops\PYGZus{}per\PYGZus{}joule}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{efficiency}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}advantage\PYGZus{}factor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{efficiency}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Human Brain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{/} \PYG{n}{efficiency}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}3 Training (peak)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}

\PYG{n}{efficiency\PYGZus{}data} \PYG{o}{=} \PYG{n}{compare\PYGZus{}efficiency}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The human brain is approximately }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{efficiency\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brain\PYGZus{}advantage\PYGZus{}factor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ times more energy\PYGZhy{}efficient than AI training.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The brain’s extreme energy efficiency stems from several factors:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Sparse activity patterns (only \textasciitilde{}1\sphinxhyphen{}2\% of neurons active simultaneously)

\item {} 
\sphinxAtStartPar
Information encoded in spike timing as well as rates

\item {} 
\sphinxAtStartPar
Adaptive metabolic regulation based on computational demands

\item {} 
\sphinxAtStartPar
Co\sphinxhyphen{}localization of memory and processing (no von Neumann bottleneck)

\end{itemize}

\sphinxAtStartPar
Neuromorphic computing efforts aim to narrow this gap by implementing brain\sphinxhyphen{}inspired architectures in efficient hardware, but significant challenges remain.


\subsection{1.5.3 Interpretability Issues}
\label{\detokenize{part1/ch01_intro:interpretability-issues}}
\sphinxAtStartPar
Both systems present interpretability challenges, but for different reasons:

\sphinxAtStartPar
\sphinxstylestrong{Brain Interpretability Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Limited recording capabilities (small subsets of neurons)

\item {} 
\sphinxAtStartPar
Multi\sphinxhyphen{}scale organization complicates analysis

\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}linear dynamics create emergent properties

\item {} 
\sphinxAtStartPar
Difficulty isolating specific functions experimentally

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AI Interpretability Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Distributed representations lack clear semantic meaning

\item {} 
\sphinxAtStartPar
Complex models contain billions of parameters

\item {} 
\sphinxAtStartPar
Black\sphinxhyphen{}box nature obscures decision processes

\item {} 
\sphinxAtStartPar
Lack of theoretical understanding of deep learning

\end{itemize}

\sphinxAtStartPar
Interestingly, techniques developed to understand one system often transfer to the other, with methods like dimensionality reduction and representational similarity analysis being applied in both fields.


\subsection{1.5.4 Generalization Capabilities}
\label{\detokenize{part1/ch01_intro:generalization-capabilities}}
\sphinxAtStartPar
Brains and AI systems differ markedly in how they generalize:

\sphinxAtStartPar
\sphinxstylestrong{Biological Generalization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Sample\sphinxhyphen{}efficient learning from limited examples

\item {} 
\sphinxAtStartPar
Strong transfer between related tasks

\item {} 
\sphinxAtStartPar
Robust to distributional shifts

\item {} 
\sphinxAtStartPar
Common sense and causal understanding

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Artificial Generalization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Often requires large training datasets

\item {} 
\sphinxAtStartPar
Limited transfer to new domains

\item {} 
\sphinxAtStartPar
Vulnerability to adversarial examples and distribution shifts

\item {} 
\sphinxAtStartPar
Struggles with causal reasoning

\end{itemize}

\sphinxAtStartPar
Recent approaches like meta\sphinxhyphen{}learning, few\sphinxhyphen{}shot learning, and self\sphinxhyphen{}supervised learning aim to close this gap, often drawing inspiration from biological learning principles.


\section{1.6 Key Insights}
\label{\detokenize{part1/ch01_intro:key-insights}}
\sphinxAtStartPar
The ongoing dialogue between neuroscience and AI yields insights in both directions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological inspiration remains valuable for AI}: Neural principles continue to inspire innovations in architecture, learning algorithms, and representation formats. Brain\sphinxhyphen{}inspired approaches like attention mechanisms and predictive coding have led to breakthrough performance in AI systems.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience can validate and inspire computational approaches}: Comparing artificial and biological systems helps identify universal computational principles versus implementation\sphinxhyphen{}specific details. The convergent evolution of similar solutions suggests underlying computational fundamentals.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AI provides tools and models to test neuroscience theories}: Neural networks offer computational laboratories to test theories of brain function. Successful AI systems can generate testable hypotheses about neural mechanisms.

\end{itemize}

\sphinxAtStartPar
As both fields advance, their ongoing collaboration promises deeper understanding of intelligence in both natural and artificial systems.

\begin{sphinxadmonition}{note}{Chapter Summary}

\sphinxAtStartPar
In this chapter, we explored:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The \sphinxstylestrong{historical co\sphinxhyphen{}evolution} of neuroscience and AI, from early cybernetics to modern deep learning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional inspiration} between biological neural networks and artificial neural networks

\item {} 
\sphinxAtStartPar
Key \sphinxstylestrong{structural parallels} between neural circuits and artificial network architectures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Functional parallels} in learning mechanisms, from Hebbian plasticity to backpropagation

\item {} 
\sphinxAtStartPar
The \sphinxstylestrong{complementary strengths} of biological and artificial systems

\item {} 
\sphinxAtStartPar
How AI serves as both a \sphinxstylestrong{tool for neuroscience} and a \sphinxstylestrong{beneficiary of biological insights}

\item {} 
\sphinxAtStartPar
Current \sphinxstylestrong{research frontiers} at the intersection of the fields

\item {} 
\sphinxAtStartPar
The importance of a \sphinxstylestrong{multidisciplinary approach} to advancing both fields

\end{itemize}

\sphinxAtStartPar
This chapter provides the foundation for the detailed explorations of specific neural systems and their artificial counterparts in subsequent chapters.
\end{sphinxadmonition}

\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 2 (Neuroscience Foundations)}: Builds directly on this introduction with a detailed exploration of neural anatomy, circuits, and plasticity, providing the biological groundwork for AI concepts.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 7 (Information Theory)}: Expands on communication and information processing principles first introduced in the cybernetics section (1.1.1).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 9 (ML Foundations)}: Takes the artificial neural network concepts introduced here and develops them into complete learning frameworks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 10 (Deep Learning)}: The backpropagation algorithm mentioned in section 1.1.3 becomes central to training the deep networks discussed in Chapter 10.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 14 (Future Directions)}: The challenges identified in section 1.5 inform many of the research directions explored in the final chapter.

\end{itemize}
\end{sphinxadmonition}


\section{1.7 Further Reading \& Media}
\label{\detokenize{part1/ch01_intro:further-reading-media}}

\subsection{Foundational Papers}
\label{\detokenize{part1/ch01_intro:foundational-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hassabis, D., Kumaran, D., Summerfield, C., \& Botvinick, M. (2017). Neuroscience\sphinxhyphen{}inspired artificial intelligence. \sphinxstyleemphasis{Neuron, 95}(2), 245\sphinxhyphen{}258.

\item {} 
\sphinxAtStartPar
Marblestone, A. H., Wayne, G., \& Kording, K. P. (2016). Toward an integration of deep learning and neuroscience. \sphinxstyleemphasis{Frontiers in Computational Neuroscience, 10}, 94.

\item {} 
\sphinxAtStartPar
Lake, B. M., Ullman, T. D., Tenenbaum, J. B., \& Gershman, S. J. (2017). Building machines that learn and think like people. \sphinxstyleemphasis{Behavioral and Brain Sciences, 40}, E253.

\end{itemize}


\subsection{Books}
\label{\detokenize{part1/ch01_intro:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Churchland, P. S., \& Sejnowski, T. J. (2016). \sphinxstyleemphasis{The computational brain}. MIT press.

\item {} 
\sphinxAtStartPar
Dayan, P., \& Abbott, L. F. (2001). \sphinxstyleemphasis{Theoretical neuroscience: computational and mathematical modeling of neural systems}. MIT press.

\item {} 
\sphinxAtStartPar
Kriegeskorte, N., \& Douglas, P. K. (2018). Cognitive computational neuroscience. \sphinxstyleemphasis{Nature Neuroscience, 21}(9), 1148\sphinxhyphen{}1160.

\end{itemize}


\subsection{Videos and Lectures}
\label{\detokenize{part1/ch01_intro:videos-and-lectures}}\begin{itemize}
\item {} 
\sphinxAtStartPar
“From Neuroscience to Artificial Intelligence and Back Again” \sphinxhyphen{} Surya Ganguli (Stanford)

\item {} 
\sphinxAtStartPar
“The Deep Learning Revolution and Its Implications for Neuroscience” \sphinxhyphen{} Terry Sejnowski (Salk Institute)

\item {} 
\sphinxAtStartPar
Neuromatch Academy Core Computational Neuroscience tutorials (freely available online)

\end{itemize}

\sphinxstepscope


\chapter{Chapter 2: Neuroscience Foundations for AI}
\label{\detokenize{part1/ch02_neuro_foundations:chapter-2-neuroscience-foundations-for-ai}}\label{\detokenize{part1/ch02_neuro_foundations::doc}}
\begin{sphinxadmonition}{note}{Learning Objectives}

\sphinxAtStartPar
By the end of this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Identify} the key components of biological neurons and their computational analogs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Explain} the processes of neural signaling, synaptic transmission, and plasticity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compare} biological learning mechanisms with artificial neural network training approaches

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Describe} the functional organization of major brain systems and their AI counterparts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implement} basic neuron simulations and Hebbian learning rules in Python

\end{itemize}
\end{sphinxadmonition}


\section{2.0 Why This Chapter?}
\label{\detokenize{part1/ch02_neuro_foundations:why-this-chapter}}
\sphinxAtStartPar
Before we leap into convolutional networks, policy gradients, or billion\sphinxhyphen{}parameter transformers, we need mental “ground truth” about the biological machine that inspired all of them. By the end of this chapter you should be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Sketch a real neuron and label the parts that correspond (roughly!) to weights, bias, and activation in an artificial unit.

\item {} 
\sphinxAtStartPar
Explain why Hebb’s 1949 slogan “cells that fire together wire together” foreshadows the weight\sphinxhyphen{}update rule inside a modern optimiser.

\item {} 
\sphinxAtStartPar
Map the cortex–hippocampus–basal\sphinxhyphen{}ganglia trio onto supervised, episodic\sphinxhyphen{}memory, and reinforcement\sphinxhyphen{}learning motifs.

\item {} 
\sphinxAtStartPar
Run—and modify—a minimal leaky\sphinxhyphen{}integrate\sphinxhyphen{}and\sphinxhyphen{}fire simulator with a local Hebbian learning rule.

\end{itemize}

\sphinxAtStartPar
Keep two caveats in mind throughout:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The metaphors run in both directions but never line up perfectly; equivalence is neither the goal nor the reality.

\item {} 
\sphinxAtStartPar
Biological plausibility is a spectrum, not a binary. Sometimes we pursue it to understand brains, sometimes to inspire better silicon algorithms, and sometimes we happily ignore it for the sake of performance.

\end{itemize}


\section{2.1 Neuron Anatomy \& Electrophysiology}
\label{\detokenize{part1/ch02_neuro_foundations:neuron-anatomy-electrophysiology}}
\sphinxAtStartPar
At the basic level, brains and computers both traffic in “bits” of information, but their substrates look very different.


\subsection{Structure cheat\sphinxhyphen{}sheet}
\label{\detokenize{part1/ch02_neuro_foundations:structure-cheat-sheet}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dendrites}: tree\sphinxhyphen{}like input fibres. Thousands of synapses live on tiny protrusions called spines.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Soma} (cell body): sums incoming currents; site of most protein synthesis.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Axon hillock}: narrow neck where action potentials are born if the membrane hits threshold.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Axon}: long cable (up to a metre in the human motor neuron) that propagates spikes.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Synaptic terminal}: packs vesicles filled with neurotransmitter; releases them into the synaptic cleft.

\end{itemize}


\subsection{Electrical basics}
\label{\detokenize{part1/ch02_neuro_foundations:electrical-basics}}
\sphinxAtStartPar
At rest a neuron sits ≈ –70 mV inside relative to outside. Ion channels act as nano\sphinxhyphen{}switches for Na⁺, K⁺, Ca²⁺, Cl⁻. When excitatory post\sphinxhyphen{}synaptic potentials (EPSPs) depolarise the membrane to roughly –55 mV, voltage\sphinxhyphen{}gated Na⁺ channels open, causing a 1 ms “action potential” hump. After the refractory period the game can restart, making a spike train whose frequency encodes information.


\subsection{Chemical messenger story}
\label{\detokenize{part1/ch02_neuro_foundations:chemical-messenger-story}}
\sphinxAtStartPar
An arriving spike triggers Ca²⁺ influx, vesicles fuse, and transmitter molecules (e.g. glutamate, GABA, dopamine) drift across a 20 nm synaptic cleft. The postsynaptic membrane hosts ligand\sphinxhyphen{}gated channels that either depolarise (excitatory) or hyperpolarise (inhibitory). Note that the sign of the synapse is fixed by receptor type; a glutamatergic synapse never “turns negative.”


\subsection{Analogy to an artificial perceptron}
\label{\detokenize{part1/ch02_neuro_foundations:analogy-to-an-artificial-perceptron}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Dendritic spine → input line xᵢ

\item {} 
\sphinxAtStartPar
Synaptic strength (number \& efficacy of receptors) → weight wᵢ

\item {} 
\sphinxAtStartPar
Somatic integration → weighted sum Σ wᵢxᵢ

\end{itemize}

\sphinxAtStartPar
\sphinxincludegraphics{{neuronal_signaling}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 2.1: Neuronal signaling mechanisms showing ion channels, action potential generation, and neurotransmitter release at the synapse.}

\begin{sphinxadmonition}{note}{Real\sphinxhyphen{}World Application: Neuromorphic Computing}

\sphinxAtStartPar
The unique properties of biological neurons have inspired specialized hardware implementations:

\sphinxAtStartPar
\sphinxstylestrong{IBM’s TrueNorth Chip}
\begin{itemize}
\item {} 
\sphinxAtStartPar
1 million digital neurons and 256 million synapses

\item {} 
\sphinxAtStartPar
4,096 neurosynaptic cores

\item {} 
\sphinxAtStartPar
Uses only 70mW of power (compared to \textasciitilde{}100W for GPUs)

\item {} 
\sphinxAtStartPar
Applications: pattern recognition, anomaly detection, real\sphinxhyphen{}time sensing

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Intel’s Loihi Chip}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Implements spiking neural networks (SNNs) in hardware

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}learning capabilities through STDP\sphinxhyphen{}based plasticity

\item {} 
\sphinxAtStartPar
125× more energy efficient than GPU implementations for certain workloads

\item {} 
\sphinxAtStartPar
Applications: gesture recognition, robotic control, sparse data processing

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{SpiNNaker (Spiking Neural Network Architecture)}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Many\sphinxhyphen{}core computer architecture designed for brain modeling

\item {} 
\sphinxAtStartPar
Can simulate up to a billion neurons in real\sphinxhyphen{}time

\item {} 
\sphinxAtStartPar
Used in the Human Brain Project for detailed neural simulations

\item {} 
\sphinxAtStartPar
Applications: computational neuroscience, robot control, edge AI

\end{itemize}

\sphinxAtStartPar
These systems capture key aspects of neural computation including:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Event\sphinxhyphen{}driven processing (only compute when signals arrive)

\item {} 
\sphinxAtStartPar
Massive parallelism with simple processing units

\item {} 
\sphinxAtStartPar
Co\sphinxhyphen{}location of memory and computation (avoiding the von Neumann bottleneck)

\item {} 
\sphinxAtStartPar
Inherent fault tolerance and graceful degradation

\end{itemize}
\end{sphinxadmonition}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Firing threshold → activation function f(⋅)

\item {} 
\sphinxAtStartPar
All\sphinxhyphen{}or\sphinxhyphen{}nothing spike → binary output y

\end{itemize}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[height=300\sphinxpxdimen]{{neuron_vs_perceptron}.svg}
\caption{Side\sphinxhyphen{}by\sphinxhyphen{}side cartoon: biological neuron (labelled) vs perceptron diagram.}\label{\detokenize{part1/ch02_neuro_foundations:neuron-vs-perceptron}}\end{figure}

\sphinxAtStartPar
But note three mismatches:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Time}: ANNs usually compute in static passes; real neurons integrate continuously.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Signal space}: Perceptron inputs are dimensionless numbers; dendrites receive precise spike timings and neuro\sphinxhyphen{}chemical signatures.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Activation}: An action potential is always the same height; in ANNs the output can vary (sigmoid, ReLU, etc.). Information in brains is carried more by timing and rate than amplitude.

\end{enumerate}


\section{2.2 Neural Circuits \& Layers}
\label{\detokenize{part1/ch02_neuro_foundations:neural-circuits-layers}}
\sphinxAtStartPar
The human cerebral cortex folds a 2\sphinxhyphen{}mm\sphinxhyphen{}thick sheet into six histological layers. A canonical microcircuit (largely conserved across vision, audition, touch) routes signals like a clever factory conveyor belt.


\subsection{Layer guide (sensory cortex example)}
\label{\detokenize{part1/ch02_neuro_foundations:layer-guide-sensory-cortex-example}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L4}: main input station from thalamus; packed with spiny stellate cells.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L2/3}: intra\sphinxhyphen{}cortical relay; outputs to neighbouring columns.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L5}: thick pyramidal neurons project to sub\sphinxhyphen{}cortical targets and back to thalamus.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L6}: feedback to thalamus; modulates gain.

\end{itemize}


\subsection{Feed\sphinxhyphen{}forward vs recurrent}
\label{\detokenize{part1/ch02_neuro_foundations:feed-forward-vs-recurrent}}
\sphinxAtStartPar
Early textbooks sold the cortex as a stack of feed\sphinxhyphen{}forward filters. We now know that \textasciitilde{}80\% of synapses are horizontal or feedback. This recurrence enables context, expectation, and predictive coding—features still being imported into AI via ResNets, U\sphinxhyphen{}Nets, and transformers.


\subsection{Convergence \& divergence}
\label{\detokenize{part1/ch02_neuro_foundations:convergence-divergence}}
\sphinxAtStartPar
A macaque V1 neuron might receive 6,000 synapses and send its axon to tens of thousands. Fan\sphinxhyphen{}in/out mirrors the fully\sphinxhyphen{}connected layers in a multilayer perceptron (MLP). However, cortical networks balance excitation with \textasciitilde{}20\% inhibitory interneurons that sculpt activity and prevent runaway excitation—a biological answer to the exploding\sphinxhyphen{}gradient problem.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[height=350\sphinxpxdimen]{{cortical_column_vs_ann}.svg}
\caption{Schematic of a cortical column with arrows marking feed\sphinxhyphen{}forward, lateral, and feedback paths; alongside a 3\sphinxhyphen{}layer ANN highlighting similar motifs.}\label{\detokenize{part1/ch02_neuro_foundations:cortical-column-vs-ann}}\end{figure}


\section{2.3 Learning \& Plasticity}
\label{\detokenize{part1/ch02_neuro_foundations:learning-plasticity}}
\sphinxAtStartPar
Donald Hebb (1949) proposed: “When an axon of cell A is near enough to excite cell B and repeatedly or persistently takes part in firing it, some growth process or metabolic change takes place in one or both cells.” Translation: correlated activity strengthens the synapse.


\subsection{3 flavours you’ll encounter:}
\label{\detokenize{part1/ch02_neuro_foundations:flavours-you-ll-encounter}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Classical Hebbian}: Δwᵢⱼ = η·xᵢ·yⱼ (pre × post).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Spike\sphinxhyphen{}Timing\sphinxhyphen{}Dependent Plasticity (STDP)}: weight change depends on Δt = t\_post – t\_pre. Δw ∝ exp(–|Δt|/τ) with positive sign if pre leads post, negative otherwise.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BCM Theory} (Bienenstock, Cooper, Munro): introduces a sliding threshold ϑ\_M; synapses potentiate above it and depress below, producing competition and homeostasis.

\end{enumerate}


\subsection{Long\sphinxhyphen{}term potentiation \& depression}
\label{\detokenize{part1/ch02_neuro_foundations:long-term-potentiation-depression}}
\sphinxAtStartPar
In hippocampal slices, high\sphinxhyphen{}frequency bursts (≈ 100 Hz) can double EPSP size for hours—a cellular memory trace called LTP. Low\sphinxhyphen{}frequency trains (≈ 1 Hz) cause LTD. Molecular mediators include NMDA\sphinxhyphen{}receptor\sphinxhyphen{}gated Ca²⁺ entry and cascades that add or remove AMPA receptors.


\subsection{Gradient descent vs. plasticity}
\label{\detokenize{part1/ch02_neuro_foundations:gradient-descent-vs-plasticity}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Locality}: Hebbian rules need only xᵢ and yⱼ; back\sphinxhyphen{}prop needs global error δ.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Signs}: LTP/LTD gate only the learning rate, not the instantaneous error direction.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Timing}: STDP encodes millisecond precision; SGD deals in batch steps.

\end{itemize}

\sphinxAtStartPar
Research crossroads: can we design learning algorithms that marry back\sphinxhyphen{}prop efficiency with Hebbian locality? Ideas include feedback alignment, target propagation, and predictive coding networks.


\section{2.4 Brain Organisation Cheat\sphinxhyphen{}sheet}
\label{\detokenize{part1/ch02_neuro_foundations:brain-organisation-cheat-sheet}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cortex}: hierarchical feature extractor \& planner. ANN analogy = deep feed\sphinxhyphen{}forward \& recurrent stacks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hippocampus}: indexes episodes via place cells and pattern separation. Analogy = content\sphinxhyphen{}addressable memory / auto\sphinxhyphen{}encoder bottleneck.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Basal ganglia}: dopamine\sphinxhyphen{}gated winner\sphinxhyphen{}take\sphinxhyphen{}all loop that learns action values. Analogy = actor\sphinxhyphen{}critic reinforcement learner.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cerebellum}: supervised error\sphinxhyphen{}corrector for timing \& coordination; millions of tiny granule cells converge on Purkinje output. Analogy = massively parallel shallow learners (think ensemble boosting).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Thalamus}: smart relay \& attention gate, not just a dumb switchboard. Analogy = transformer attention head that routes information based on context.

\end{itemize}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[height=300\sphinxpxdimen]{{brain_regions_table}.svg}
\caption{Table with five rows (region, main job, canonical cell type, ML metaphor).}\label{\detokenize{part1/ch02_neuro_foundations:brain-regions-table}}\end{figure}

\begin{sphinxadmonition}{tip}{Tip:}
\sphinxAtStartPar
Evolution re\sphinxhyphen{}uses building blocks. The same Hebbian synapse supports vision in occipital cortex and monetary reward learning in orbitofrontal cortex—proof that algorithmic principles scale.
\end{sphinxadmonition}


\section{2.5 Code Lab – Spikes \& Hebbian Learning}
\label{\detokenize{part1/ch02_neuro_foundations:code-lab-spikes-hebbian-learning}}
\sphinxAtStartPar
Fire up Python 3.10+, NumPy, and Matplotlib. The following single cell is intentionally explicit rather than hyper\sphinxhyphen{}optimised so readers can tweak each line.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Leaky\PYGZhy{}Integrate\PYGZhy{}and\PYGZhy{}Fire neuron + Hebbian 2\PYGZhy{}neuron network}
\PYG{c+c1}{\PYGZsh{} Author: R. Young \PYGZam{} ChatGPT, 2025}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{} Part A: single LIF neuron \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{T} \PYG{o}{=} \PYG{l+m+mi}{300}      \PYG{c+c1}{\PYGZsh{} ms total simulation time}
\PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mf}{0.1}     \PYG{c+c1}{\PYGZsh{} ms time step}
\PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{T}\PYG{o}{/}\PYG{n}{dt}\PYG{p}{)}

\PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{20.0}       \PYG{c+c1}{\PYGZsh{} membrane time constant (ms)}
\PYG{n}{V\PYGZus{}rest} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.0}     \PYG{c+c1}{\PYGZsh{} mV}
\PYG{n}{V\PYGZus{}thresh} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{54.0}   \PYG{c+c1}{\PYGZsh{} spike threshold (mV)}
\PYG{n}{V\PYGZus{}reset} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{80.0}    \PYG{c+c1}{\PYGZsh{} reset potential (mV)}
\PYG{n}{R\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{10.0}         \PYG{c+c1}{\PYGZsh{} MΩ}
\PYG{n}{I\PYGZus{}ext} \PYG{o}{=} \PYG{l+m+mf}{1.8}        \PYG{c+c1}{\PYGZsh{} nA external current}

\PYG{n}{V} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
\PYG{n}{V}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{V\PYGZus{}rest}
\PYG{n}{spikes} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{dV} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{V\PYGZus{}rest}\PYG{p}{)} \PYG{o}{+} \PYG{n}{R\PYGZus{}m}\PYG{o}{*}\PYG{n}{I\PYGZus{}ext}\PYG{p}{)} \PYG{o}{/} \PYG{n}{tau\PYGZus{}m}
    \PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt}\PYG{o}{*}\PYG{n}{dV}
    \PYG{k}{if} \PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{V\PYGZus{}thresh}\PYG{p}{:}
        \PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{20.0}     \PYG{c+c1}{\PYGZsh{} for pretty spike in plot}
        \PYG{n}{V}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{V\PYGZus{}reset}
        \PYG{n}{spikes}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{t}\PYG{o}{*}\PYG{n}{dt}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{} Part B: 2\PYGZhy{}neuron Hebbian network \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{eta} \PYG{o}{=} \PYG{l+m+mf}{0.01}                \PYG{c+c1}{\PYGZsh{} learning rate}
\PYG{n}{w} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mf}{0.1}   \PYG{c+c1}{\PYGZsh{} weight matrix}
\PYG{n}{pre\PYGZus{}spike\PYGZus{}prob} \PYG{o}{=} \PYG{l+m+mf}{0.05}     \PYG{c+c1}{\PYGZsh{} probability pre neuron fires each ms}

\PYG{n}{w\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{)}\PYG{p}{:}        \PYG{c+c1}{\PYGZsh{} training epochs}
    \PYG{n}{pre} \PYG{o}{=} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{pre\PYGZus{}spike\PYGZus{}prob}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}
    \PYG{n}{post\PYGZus{}input} \PYG{o}{=} \PYG{n}{pre} \PYG{o}{@} \PYG{n}{w}        \PYG{c+c1}{\PYGZsh{} simple linear sum}
    \PYG{n}{post} \PYG{o}{=} \PYG{p}{(}\PYG{n}{post\PYGZus{}input} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} threshold non\PYGZhy{}linearity}
    
    \PYG{c+c1}{\PYGZsh{} Hebbian update: Δw = η * pre\PYGZca{}T * post}
    \PYG{n}{dw} \PYG{o}{=} \PYG{n}{eta} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{pre}\PYG{p}{,} \PYG{n}{post}\PYG{p}{)}
    \PYG{n}{w} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dw}
    \PYG{n}{w\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{w}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{w\PYGZus{}history} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{w\PYGZus{}history}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{} Visualisation \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{11}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Membrane potential trace}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{o}{*}\PYG{n}{dt}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mf}{1.2}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set}\PYG{p}{(}\PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Leaky\PYGZhy{}Integrate\PYGZhy{}and\PYGZhy{}Fire Trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
          \PYG{n}{xlabel}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time (ms)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ylabel}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Membrane potential (mV)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n}{spikes}\PYG{p}{:}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{s}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Weight matrix evolution heat\PYGZhy{}map}
\PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{w\PYGZus{}history}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
                  \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{magma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set}\PYG{p}{(}\PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hebbian Weight Growth}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
          \PYG{n}{xlabel}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Training step}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ylabel}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Weight index}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Try\sphinxhyphen{}this\sphinxhyphen{}now exercises}
\label{\detokenize{part1/ch02_neuro_foundations:try-this-now-exercises}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Increase τₘ to 40 ms; observe slower decay \& higher firing rate.

\item {} 
\sphinxAtStartPar
Make one synapse inhibitory in Part B by initialising it negative; trace how competition evolves.

\item {} 
\sphinxAtStartPar
Replace the binary post\sphinxhyphen{}neuron with a noisy sigmoid: σ(β · input) and watch weight saturation.

\end{enumerate}

\begin{sphinxadmonition}{note}{Note:}
\sphinxAtStartPar
Complete code for this lab is available in the accompanying \sphinxcode{\sphinxupquote{ch02\_demo.py}} file.
\end{sphinxadmonition}


\section{2.6 Key Take\sphinxhyphen{}aways}
\label{\detokenize{part1/ch02_neuro_foundations:key-take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Biological neurons fire at kilohertz at best, yet 86 billion of them work in parallel while consuming only 20 W—roughly a dim light bulb.

\item {} 
\sphinxAtStartPar
Plasticity is local and continuous. Back\sphinxhyphen{}prop is global and episodic. Bridging the gap is an active frontier (see “feedback alignment”).

\item {} 
\sphinxAtStartPar
Studying the real brain supplies “design priors” that have already birthed convolution, recurrence, attention, and spiking ASICs. Ignoring biology wholesale risks reinventing wheels—or worse, building brittle systems that fail outside curated datasets.

\end{itemize}

\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Back}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 1 (Introduction)}: This chapter expands on the historical biological inspirations for artificial neural networks introduced in Chapter 1’s sections on key parallels and historical context.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 3 (Spatial Navigation)}: The hippocampus, introduced in section 2.4, plays a critical role in spatial navigation through place cells, which will be explored in detail in Chapter 3.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 4 (Perception Pipeline)}: The cortical circuit organization (section 2.2) provides the foundation for understanding how visual perception is organized in the brain.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 7 (Information Theory)}: Hebbian plasticity and neural coding concepts connect to information\sphinxhyphen{}theoretic principles of efficient coding and redundancy reduction.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 10 (Deep Learning)}: The discussion of biological learning (section 2.3) contrasts with deep learning optimization algorithms like backpropagation covered in Chapter 10.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 11 (Sequence Models)}: Recurrent connections described in section 2.2 form the biological basis for sequence processing that inspired artificial recurrent neural networks.

\end{itemize}
\end{sphinxadmonition}


\section{2.7 Further Reading \& Media}
\label{\detokenize{part1/ch02_neuro_foundations:further-reading-media}}

\subsection{Books}
\label{\detokenize{part1/ch02_neuro_foundations:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Bear, Connors \& Paradiso – \sphinxstyleemphasis{Neuroscience: Exploring the Brain}, 4th ed., Ch 2\sphinxhyphen{}3, 23\sphinxhyphen{}27.

\item {} 
\sphinxAtStartPar
Dayan \& Abbott – \sphinxstyleemphasis{Theoretical Neuroscience}, Ch 8 (spike\sphinxhyphen{}based plasticity).

\end{itemize}


\subsection{Articles}
\label{\detokenize{part1/ch02_neuro_foundations:articles}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Song, Miller \& Abbott (2000) – “Competitive Hebbian Learning Through STDP”, \sphinxstyleemphasis{Nat. Neuro}.

\item {} 
\sphinxAtStartPar
Lillicrap et al. (2020) – “Backpropagation and the Brain”, \sphinxstyleemphasis{Nat. Rev. Neurosci}.

\end{itemize}


\subsection{Videos / MOOCs}
\label{\detokenize{part1/ch02_neuro_foundations:videos-moocs}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Crash Course Neuroscience Ep 1\sphinxhyphen{}3 (Intro \& Neuron Anatomy).

\item {} 
\sphinxAtStartPar
3Blue1Brown – “What is a Neural Network?” for the ANN perspective.

\item {} 
\sphinxAtStartPar
Neuromatch Academy (YouTube) – Model neurons \& STDP day.

\end{itemize}


\subsection{Software / Demos}
\label{\detokenize{part1/ch02_neuro_foundations:software-demos}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Brian2 simulator (Python) – friendly spiking\sphinxhyphen{}network sandbox.

\item {} 
\sphinxAtStartPar
NEST / NEURON – large\sphinxhyphen{}scale brain simulators if you crave HPC.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 3: Spatial Navigation – Place \& Grid Cells}
\label{\detokenize{part1/ch03_spatial_navigation:chapter-3-spatial-navigation-place-grid-cells}}\label{\detokenize{part1/ch03_spatial_navigation::doc}}

\section{3.0 Chapter Goals}
\label{\detokenize{part1/ch03_spatial_navigation:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the neural basis of spatial navigation

\item {} 
\sphinxAtStartPar
Explore the organizational principles of place and grid cells

\item {} 
\sphinxAtStartPar
Connect spatial coding in the brain to computational principles in AI

\item {} 
\sphinxAtStartPar
Implement simple models of neural spatial representation

\end{itemize}


\section{3.1 Hippocampal Formation: Organization and Cell Types}
\label{\detokenize{part1/ch03_spatial_navigation:hippocampal-formation-organization-and-cell-types}}
\sphinxAtStartPar
The hippocampal formation is a brain structure critical for spatial navigation and memory formation. This section examines its anatomical organization and the specialized cells that form the brain’s navigational system.


\subsection{Anatomical Organization}
\label{\detokenize{part1/ch03_spatial_navigation:anatomical-organization}}
\sphinxAtStartPar
The hippocampal formation consists of several interconnected regions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hippocampus proper (CA1\sphinxhyphen{}CA3)}: Processes and stores spatial memories

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dentate gyrus (DG)}: Performs pattern separation of similar spatial inputs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Entorhinal cortex (EC)}: Serves as the main interface between hippocampus and neocortex

\end{itemize}




\subsection{Cellular Organization: The Pyramidal Cell}
\label{\detokenize{part1/ch03_spatial_navigation:cellular-organization-the-pyramidal-cell}}
\sphinxAtStartPar
The principal cells in the hippocampus are pyramidal neurons, which have:
\begin{itemize}
\item {} 
\sphinxAtStartPar
A triangular cell body (soma)

\item {} 
\sphinxAtStartPar
Apical dendrites extending toward the surface

\item {} 
\sphinxAtStartPar
Basal dendrites reaching outward and downward

\item {} 
\sphinxAtStartPar
A single axon that projects to other regions

\end{itemize}

\sphinxAtStartPar
This cellular architecture is significant because:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
The layered organization creates a structured processing pipeline

\item {} 
\sphinxAtStartPar
The dendritic arbors receive thousands of inputs from different sources

\item {} 
\sphinxAtStartPar
The hierarchical arrangement enables complex pattern recognition

\end{enumerate}

\sphinxAtStartPar
The pyramidal cell architecture parallels the computational structure seen in artificial neural networks, particularly in how information flows through layers and combines across multiple inputs. This similarity is not coincidental—early neural network designs were inspired by these biological principles.


\section{3.2 Place Cells: The Brain’s Spatial Address System}
\label{\detokenize{part1/ch03_spatial_navigation:place-cells-the-brain-s-spatial-address-system}}
\sphinxAtStartPar
Place cells are pyramidal neurons in the hippocampus (primarily in regions CA1 and CA3) that exhibit location\sphinxhyphen{}specific firing patterns.

\sphinxAtStartPar
\sphinxincludegraphics{{place_grid_cells}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 3.1: Comparison of place cell and grid cell activity patterns. Place cells fire in specific locations within an environment, while grid cells exhibit repeating hexagonal firing patterns across the entire space.}


\subsection{Discovery and Properties}
\label{\detokenize{part1/ch03_spatial_navigation:discovery-and-properties}}
\sphinxAtStartPar
John O’Keefe discovered place cells in 1971 while recording from freely moving rats. These neurons show remarkable properties:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Each cell fires strongly when the animal is in a specific location (“place field”)

\item {} 
\sphinxAtStartPar
Place fields are typically 20\sphinxhyphen{}50 cm in diameter in a rat\sphinxhyphen{}sized environment

\item {} 
\sphinxAtStartPar
Different place cells code for different locations, creating a distributed map

\item {} 
\sphinxAtStartPar
The collection of all place cells forms a complete representation of the environment

\end{itemize}




\subsection{Key Properties of Place Cells}
\label{\detokenize{part1/ch03_spatial_navigation:key-properties-of-place-cells}}
\sphinxAtStartPar
Place cells exhibit several important characteristics that make them ideal for spatial representation:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Spatial Specificity}: Place cells remain silent most of the time, firing only when the animal enters a specific location.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Environmental Remapping}: When moved to a new environment, place cells can:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Undergo “global remapping” where cells completely change their firing locations

\item {} 
\sphinxAtStartPar
Show “rate remapping” where the same locations are encoded but with different firing rates

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stable but Plastic Representation}: Place fields are stable over days or weeks in familiar environments but can rapidly reorganize when environments change.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal Integration}: Place cell firing integrates various inputs:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Visual landmarks

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}motion cues (velocity, direction)

\item {} 
\sphinxAtStartPar
Olfactory and tactile information

\item {} 
\sphinxAtStartPar
Goal location and task demands

\end{itemize}

\end{enumerate}


\subsection{Computational Principles}
\label{\detokenize{part1/ch03_spatial_navigation:computational-principles}}
\sphinxAtStartPar
Place cells effectively implement a form of \sphinxstylestrong{sparse coding}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Only a small subset of neurons is active at any given location

\item {} 
\sphinxAtStartPar
This creates an efficient, low\sphinxhyphen{}energy representation

\item {} 
\sphinxAtStartPar
The sparse code is resistant to noise and damage

\end{itemize}

\sphinxAtStartPar
These principles parallel design features in many AI systems:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Sparse representations in machine learning reduce overfitting

\item {} 
\sphinxAtStartPar
One\sphinxhyphen{}hot encoding systems for categorical data

\item {} 
\sphinxAtStartPar
Locality\sphinxhyphen{}sensitive hashing for nearest\sphinxhyphen{}neighbor lookups

\end{itemize}


\section{3.3 Grid Cells: The Brain’s Coordinate System}
\label{\detokenize{part1/ch03_spatial_navigation:grid-cells-the-brain-s-coordinate-system}}
\sphinxAtStartPar
While place cells provide discrete location encoding, grid cells in the medial entorhinal cortex (MEC) create a continuous, metric representation of space.


\subsection{Discovery and Patterns}
\label{\detokenize{part1/ch03_spatial_navigation:discovery-and-patterns}}
\sphinxAtStartPar
Discovered by Edvard and May\sphinxhyphen{}Britt Moser in 2005, grid cells fire in a remarkably regular pattern:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Each grid cell fires at multiple locations arranged in a hexagonal lattice

\item {} 
\sphinxAtStartPar
The firing fields are evenly spaced throughout the environment

\item {} 
\sphinxAtStartPar
The spacing and orientation are consistent within cell clusters

\item {} 
\sphinxAtStartPar
Different grid cells have different scales (spacing between firing fields)

\end{itemize}




\subsection{Grid Cell Organization}
\label{\detokenize{part1/ch03_spatial_navigation:grid-cell-organization}}
\sphinxAtStartPar
Grid cells are organized into modules based on their spatial scale:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dorsal MEC contains cells with smaller grid spacing (\textasciitilde{}25 cm)

\item {} 
\sphinxAtStartPar
Ventral MEC contains cells with larger grid spacing (\textasciitilde{}3 m)

\item {} 
\sphinxAtStartPar
Each module contains cells with similar spacing but offset grid phases

\item {} 
\sphinxAtStartPar
This creates a combinatorial code that can represent vast spaces with relatively few neurons

\end{itemize}

\sphinxAtStartPar
This organization is reminiscent of how convolutional neural networks (CNNs) operate:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Each kernel in a CNN scans across an input field (like the repeating grid fields)

\item {} 
\sphinxAtStartPar
Different kernels detect different features (like differently phased grid cells)

\item {} 
\sphinxAtStartPar
The hierarchical scaling of feature detectors in CNNs parallels the scaling of grid spacing

\end{itemize}


\subsection{Geometric Efficiency of Hexagonal Grids}
\label{\detokenize{part1/ch03_spatial_navigation:geometric-efficiency-of-hexagonal-grids}}
\sphinxAtStartPar
The hexagonal lattice pattern is mathematically optimal for spatial encoding:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Hexagonal packing is the most efficient way to cover a 2D plane with circles

\item {} 
\sphinxAtStartPar
It minimizes the number of cells needed to represent a given area

\item {} 
\sphinxAtStartPar
It provides the highest spatial resolution with a given number of neurons

\end{enumerate}

\sphinxAtStartPar
This geometric efficiency principle also appears in computer vision and signal processing:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hexagonal grids have been used in certain specialized CNN architectures

\item {} 
\sphinxAtStartPar
Hexagonal sampling grids can provide better coverage with fewer points

\item {} 
\sphinxAtStartPar
Certain image compression algorithms leverage similar geometric efficiencies

\end{itemize}


\section{3.4 The Navigation Circuit: From Single Cells to Systems}
\label{\detokenize{part1/ch03_spatial_navigation:the-navigation-circuit-from-single-cells-to-systems}}
\sphinxAtStartPar
Place and grid cells do not operate in isolation but form part of a larger navigation system that includes several specialized cell types:


\subsection{Head Direction Cells}
\label{\detokenize{part1/ch03_spatial_navigation:head-direction-cells}}
\sphinxAtStartPar
Found in multiple brain regions including the thalamus and retrosplenial cortex:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Act like a neural compass, firing when the animal faces a specific direction

\item {} 
\sphinxAtStartPar
Maintain consistent preferred directions across environments

\item {} 
\sphinxAtStartPar
Are calibrated by visual landmarks and updated by vestibular input

\end{itemize}


\subsection{Border/Boundary Cells}
\label{\detokenize{part1/ch03_spatial_navigation:border-boundary-cells}}
\sphinxAtStartPar
Located in the subiculum and entorhinal cortex:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Fire when the animal is near environmental boundaries (walls, edges, cliffs)

\item {} 
\sphinxAtStartPar
Help anchor the spatial map to physical landmarks

\item {} 
\sphinxAtStartPar
Provide error correction for path integration

\end{itemize}


\subsection{Conjunctive Cells}
\label{\detokenize{part1/ch03_spatial_navigation:conjunctive-cells}}
\sphinxAtStartPar
Found primarily in deeper layers of the entorhinal cortex:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Combine properties of grid cells and head direction cells

\item {} 
\sphinxAtStartPar
Fire in grid patterns but only when the animal faces certain directions

\item {} 
\sphinxAtStartPar
Enhance the system’s ability to encode complex trajectories

\end{itemize}


\subsection{Path Integration}
\label{\detokenize{part1/ch03_spatial_navigation:path-integration}}
\sphinxAtStartPar
The navigation circuit performs path integration (dead reckoning):
\begin{itemize}
\item {} 
\sphinxAtStartPar
Tracking position based solely on self\sphinxhyphen{}motion cues (velocity, direction)

\item {} 
\sphinxAtStartPar
Grid cells are believed to be the computational substrate for this process

\item {} 
\sphinxAtStartPar
Works even in darkness but accumulates error over time

\item {} 
\sphinxAtStartPar
Periodically calibrated by sensory information (vision, borders, landmarks)

\end{itemize}


\section{3.5 Parallels to Convolutional Neural Networks}
\label{\detokenize{part1/ch03_spatial_navigation:parallels-to-convolutional-neural-networks}}
\sphinxAtStartPar
The spatial representation system in the brain shares remarkable similarities with CNNs, providing mutual inspiration between neuroscience and AI.


\subsection{Structural Similarities}
\label{\detokenize{part1/ch03_spatial_navigation:structural-similarities}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Receptive Fields}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Place cells have spatially localized receptive fields

\item {} 
\sphinxAtStartPar
CNN neurons similarly respond to specific regions of the input space

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Grid cells at different scales form a natural hierarchy

\item {} 
\sphinxAtStartPar
CNNs use hierarchical layers to process information at different scales

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Regular Sampling}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Grid cells sample space in a regular pattern

\item {} 
\sphinxAtStartPar
CNN convolutional filters scan across inputs in a regular grid

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Invariant Representations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Place cells maintain consistent fields despite minor environmental changes

\item {} 
\sphinxAtStartPar
CNNs develop translation\sphinxhyphen{}invariant representations through pooling operations

\end{itemize}

\end{enumerate}


\subsection{Computational Principles}
\label{\detokenize{part1/ch03_spatial_navigation:id1}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Weight Sharing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Grid cells use the same firing pattern repeated across space

\item {} 
\sphinxAtStartPar
CNNs use the same weights (kernels) applied across different parts of the input

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sparse Coding}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Only a subset of place/grid cells is active at any time

\item {} 
\sphinxAtStartPar
ReLU activations in CNNs create sparse representations

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multi\sphinxhyphen{}scale Processing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Grid cells operate at multiple spatial scales

\item {} 
\sphinxAtStartPar
CNN architectures use multiple layers to detect features at different scales

\end{itemize}

\end{enumerate}


\subsection{Inspiration Exchange}
\label{\detokenize{part1/ch03_spatial_navigation:inspiration-exchange}}
\sphinxAtStartPar
Neuroscience has informed AI:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Early CNN architectures were inspired by visual cortex organization

\item {} 
\sphinxAtStartPar
Grid\sphinxhyphen{}like representations have been adapted for reinforcement learning

\end{itemize}

\sphinxAtStartPar
AI has informed neuroscience:
\begin{itemize}
\item {} 
\sphinxAtStartPar
CNN visualization techniques help interpret neural recordings

\item {} 
\sphinxAtStartPar
Network models test theories about navigation circuit function

\end{itemize}


\section{3.6 Code Lab: Modeling Spatial Representations}
\label{\detokenize{part1/ch03_spatial_navigation:code-lab-modeling-spatial-representations}}
\sphinxAtStartPar
This section provides practical implementations of computational models that capture key aspects of place and grid cells.


\subsection{Place Cell Model}
\label{\detokenize{part1/ch03_spatial_navigation:place-cell-model}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{cm}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Axes3D}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{gaussian\PYGZus{}2d}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a 2D Gaussian function centered at (x0, y0)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{x0}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{sigma\PYGZus{}x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{+} \PYG{p}{(}\PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{n}{y0}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{sigma\PYGZus{}y}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}place\PYGZus{}cell\PYGZus{}population}\PYG{p}{(}\PYG{n}{n\PYGZus{}cells}\PYG{p}{,} \PYG{n}{env\PYGZus{}size}\PYG{p}{,} \PYG{n}{field\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a population of place cells covering an environment}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    n\PYGZus{}cells: Number of place cells}
\PYG{l+s+sd}{    env\PYGZus{}size: Size of the environment (width, height)}
\PYG{l+s+sd}{    field\PYGZus{}size: Size of place fields (sigma\PYGZus{}x, sigma\PYGZus{}y)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    centers: Place field centers for each cell}
\PYG{l+s+sd}{    sigmas: Place field sizes for each cell}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Randomly distribute place field centers}
    \PYG{n}{centers} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}cells}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{*} \PYG{n}{env\PYGZus{}size}
    
    \PYG{c+c1}{\PYGZsh{} Vary place field sizes slightly}
    \PYG{n}{base\PYGZus{}sigma} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{field\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{sigmas} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n}{base\PYGZus{}sigma}\PYG{p}{,} \PYG{n}{base\PYGZus{}sigma} \PYG{o}{*} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}cells}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{sigmas} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{sigmas}\PYG{p}{,} \PYG{n}{base\PYGZus{}sigma} \PYG{o}{*} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{base\PYGZus{}sigma} \PYG{o}{*} \PYG{l+m+mf}{1.5}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas}

\PYG{c+c1}{\PYGZsh{} Create environment grid}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create population of place cells}
\PYG{n}{n\PYGZus{}place\PYGZus{}cells} \PYG{o}{=} \PYG{l+m+mi}{50}
\PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas} \PYG{o}{=} \PYG{n}{create\PYGZus{}place\PYGZus{}cell\PYGZus{}population}\PYG{p}{(}
    \PYG{n}{n\PYGZus{}place\PYGZus{}cells}\PYG{p}{,} \PYG{n}{env\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{,} \PYG{n}{field\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize a few example place cells}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate place field}
    \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0} \PYG{o}{=} \PYG{n}{centers}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
    \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y} \PYG{o}{=} \PYG{n}{sigmas}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
    \PYG{n}{place\PYGZus{}field} \PYG{o}{=} \PYG{n}{gaussian\PYGZus{}2d}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{place\PYGZus{}field}\PYG{p}{,} \PYG{n}{extent}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Place Cell }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Function to encode a position with place cells}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encode\PYGZus{}position}\PYG{p}{(}\PYG{n}{position}\PYG{p}{,} \PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Encode a position using the place cell population\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{position}
    \PYG{n}{activities} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{)}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{activities}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{gaussian\PYGZus{}2d}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{activities}

\PYG{c+c1}{\PYGZsh{} Plot place cell population activity for a sample position}
\PYG{n}{sample\PYGZus{}position} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mf}{4.0}\PYG{p}{,} \PYG{l+m+mf}{7.0}\PYG{p}{)}
\PYG{n}{activities} \PYG{o}{=} \PYG{n}{encode\PYGZus{}position}\PYG{p}{(}\PYG{n}{sample\PYGZus{}position}\PYG{p}{,} \PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}place\PYGZus{}cells}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activities}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Place Cell ID}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Population Activity at Position }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sample\PYGZus{}position}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Show the position and place fields}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{)}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{,} \PYG{n}{sigmas}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{o}{*}\PYG{n}{sample\PYGZus{}position}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Place Field Centers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Grid Cell Model}
\label{\detokenize{part1/ch03_spatial_navigation:grid-cell-model}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}grid\PYGZus{}pattern}\PYG{p}{(}\PYG{n}{center}\PYG{p}{,} \PYG{n}{spacing}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Generate a grid cell firing pattern}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    center: Offset of the grid pattern}
\PYG{l+s+sd}{    spacing: Distance between grid fields}
\PYG{l+s+sd}{    orientation: Rotation of the grid pattern (radians)}
\PYG{l+s+sd}{    size: Size of the environment}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    grid\PYGZus{}pattern: 2D array with grid pattern}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{width}\PYG{p}{,} \PYG{n}{height} \PYG{o}{=} \PYG{n}{size}
    \PYG{n}{grid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{height}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define the three basis vectors for the grid (120° apart)}
    \PYG{n}{theta1} \PYG{o}{=} \PYG{n}{orientation}
    \PYG{n}{theta2} \PYG{o}{=} \PYG{n}{orientation} \PYG{o}{+} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{3}
    \PYG{n}{theta3} \PYG{o}{=} \PYG{n}{orientation} \PYG{o}{+} \PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{3}
    
    \PYG{n}{v1} \PYG{o}{=} \PYG{n}{spacing} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta1}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{v2} \PYG{o}{=} \PYG{n}{spacing} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta2}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{v3} \PYG{o}{=} \PYG{n}{spacing} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta3}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate grid pattern using interference of three plane waves}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{height}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{width}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Position relative to grid offset}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{j} \PYG{o}{\PYGZhy{}} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{y} \PYG{o}{=} \PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{pos} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate interference pattern from three waves}
            \PYG{n}{f1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{pos}\PYG{p}{,} \PYG{n}{v1}\PYG{p}{)} \PYG{o}{/} \PYG{n}{spacing}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{f2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{pos}\PYG{p}{,} \PYG{n}{v2}\PYG{p}{)} \PYG{o}{/} \PYG{n}{spacing}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{f3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{pos}\PYG{p}{,} \PYG{n}{v3}\PYG{p}{)} \PYG{o}{/} \PYG{n}{spacing}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Sum the waves and scale to [0, 1]}
            \PYG{n}{grid}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{f1} \PYG{o}{+} \PYG{n}{f2} \PYG{o}{+} \PYG{n}{f3} \PYG{o}{+} \PYG{l+m+mi}{3}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{6}
    
    \PYG{k}{return} \PYG{n}{grid}

\PYG{c+c1}{\PYGZsh{} Generate and visualize grid cell patterns at different scales}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{grid\PYGZus{}spacings} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{25}\PYG{p}{]}
\PYG{n}{orientations} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{8}\PYG{p}{]}
\PYG{n}{centers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{45}\PYG{p}{,} \PYG{l+m+mi}{55}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{55}\PYG{p}{,} \PYG{l+m+mi}{45}\PYG{p}{)}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{spacing}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{,} \PYG{n}{center}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{grid\PYGZus{}spacings}\PYG{p}{,} \PYG{n}{orientations}\PYG{p}{,} \PYG{n}{centers}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{grid\PYGZus{}pattern} \PYG{o}{=} \PYG{n}{generate\PYGZus{}grid\PYGZus{}pattern}\PYG{p}{(}\PYG{n}{center}\PYG{p}{,} \PYG{n}{spacing}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{grid\PYGZus{}pattern}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Grid Cell: Spacing=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{spacing}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Orientation=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{orientation}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Show how grid cells at different scales combine to precisely encode location}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}combined\PYGZus{}grid\PYGZus{}encoding}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot how grids at different scales combine to encode location uniquely\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Number of grid modules}
    \PYG{n}{n\PYGZus{}modules} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{c+c1}{\PYGZsh{} Scales}
    \PYG{n}{scales} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{]}
    \PYG{c+c1}{\PYGZsh{} Orientations}
    \PYG{n}{orientations} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create a small environment}
    \PYG{n}{size} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n}{environment} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate grid activations for each module}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{scale}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{scales}\PYG{p}{,} \PYG{n}{orientations}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{grid} \PYG{o}{=} \PYG{n}{generate\PYGZus{}grid\PYGZus{}pattern}\PYG{p}{(}\PYG{p}{(}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{scale}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Normalize to [0, 1]}
        \PYG{n}{grid} \PYG{o}{=} \PYG{p}{(}\PYG{n}{grid} \PYG{o}{\PYGZhy{}} \PYG{n}{grid}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{grid}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{grid}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Assign to RGB channel}
        \PYG{n}{environment}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{grid}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{environment}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Combined Grid Cell Representation (RGB = different scales)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RGB = Different grid cell modules}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}combined\PYGZus{}grid\PYGZus{}encoding}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Path Integration Model}
\label{\detokenize{part1/ch03_spatial_navigation:path-integration-model}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}path\PYGZus{}integration}\PYG{p}{(}\PYG{n}{initial\PYGZus{}pos}\PYG{p}{,} \PYG{n}{velocity}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate path integration with accumulating error.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        initial\PYGZus{}pos: Starting position (x, y)}
\PYG{l+s+sd}{        velocity: List of velocity vectors [(vx, vy), ...]}
\PYG{l+s+sd}{        dt: Time step}
\PYG{l+s+sd}{        noise\PYGZus{}level: Amount of noise in velocity estimation}
\PYG{l+s+sd}{        n\PYGZus{}steps: Number of steps to simulate}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        true\PYGZus{}positions: Actual positions}
\PYG{l+s+sd}{        estimated\PYGZus{}positions: Positions estimated through path integration}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{true\PYGZus{}pos} \PYG{o}{=} \PYG{p}{[}\PYG{n}{initial\PYGZus{}pos}\PYG{p}{]}
    \PYG{n}{estimated\PYGZus{}pos} \PYG{o}{=} \PYG{p}{[}\PYG{n}{initial\PYGZus{}pos}\PYG{p}{]}
    
    \PYG{n}{current\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{initial\PYGZus{}pos}\PYG{p}{)}
    \PYG{n}{current\PYGZus{}est} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{initial\PYGZus{}pos}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Get current velocity (may cycle through provided velocities)}
        \PYG{n}{v} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{velocity}\PYG{p}{[}\PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{velocity}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add noise to velocity for the estimation}
        \PYG{n}{v\PYGZus{}noisy} \PYG{o}{=} \PYG{n}{v} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update positions}
        \PYG{n}{current\PYGZus{}true} \PYG{o}{=} \PYG{n}{current\PYGZus{}true} \PYG{o}{+} \PYG{n}{v} \PYG{o}{*} \PYG{n}{dt}
        \PYG{n}{current\PYGZus{}est} \PYG{o}{=} \PYG{n}{current\PYGZus{}est} \PYG{o}{+} \PYG{n}{v\PYGZus{}noisy} \PYG{o}{*} \PYG{n}{dt}
        
        \PYG{n}{true\PYGZus{}pos}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}true}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{estimated\PYGZus{}pos}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}est}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{true\PYGZus{}pos}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{estimated\PYGZus{}pos}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{n}{initial\PYGZus{}position} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Circular movement}
\PYG{n}{velocities} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{angle} \PYG{o+ow}{in} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{velocities}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{true\PYGZus{}path}\PYG{p}{,} \PYG{n}{estimated\PYGZus{}path} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}path\PYGZus{}integration}\PYG{p}{(}
    \PYG{n}{initial\PYGZus{}position}\PYG{p}{,} \PYG{n}{velocities}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the paths}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{true\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{true\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True path}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{estimated\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{estimated\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
         \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Estimated path (path integration)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{true\PYGZus{}path}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{true\PYGZus{}path}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Start}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Path Integration with Accumulating Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{3.7 Neural Representations and CNN Principles}
\label{\detokenize{part1/ch03_spatial_navigation:neural-representations-and-cnn-principles}}
\sphinxAtStartPar
This section directly connects the brain’s spatial representation system to the principles underlying convolutional neural networks.

\sphinxAtStartPar
\sphinxincludegraphics{{cognitive_maps}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 3.2: Cognitive maps in the brain and their AI applications. The hippocampus, entorhinal cortex, prefrontal cortex, and parietal cortex work together to form a neural representation of space that can be modeled as a graph structure for navigation.}


\subsection{Shared Computational Motifs}
\label{\detokenize{part1/ch03_spatial_navigation:shared-computational-motifs}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local Receptive Fields}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Place cells fire for specific locations in physical space

\item {} 
\sphinxAtStartPar
CNN neurons activate for specific regions in the input space

\item {} 
\sphinxAtStartPar
Both create a topographic mapping of their respective domains

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Feature Extraction}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Grid cells at different scales (modules) encode space at multiple resolutions

\item {} 
\sphinxAtStartPar
CNNs use successive layers to detect features at increasingly abstract levels

\item {} 
\sphinxAtStartPar
This multi\sphinxhyphen{}resolution approach enables efficient encoding of complex patterns

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pattern Completion and Pattern Separation}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal circuits perform pattern completion (filling in missing spatial information)

\item {} 
\sphinxAtStartPar
They also perform pattern separation (distinguishing similar locations)

\item {} 
\sphinxAtStartPar
CNNs similarly learn to generalize across similar inputs while maintaining class distinctions

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Coordinate Transforms}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The navigation system performs coordinate transformations (egocentric to allocentric)

\item {} 
\sphinxAtStartPar
CNNs perform analogous transformations through their layered architecture

\item {} 
\sphinxAtStartPar
Both systems convert raw input into increasingly abstract representations

\end{itemize}

\end{enumerate}


\subsection{Applications in AI}
\label{\detokenize{part1/ch03_spatial_navigation:applications-in-ai}}
\sphinxAtStartPar
These principles have informed developments in AI:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{DeepMind’s Grid\sphinxhyphen{}like Representations}: When trained on navigation tasks, artificial agents spontaneously develop grid\sphinxhyphen{}like representations similar to entorhinal grid cells.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Successor Representations}: This reinforcement learning technique, inspired by hippocampal predictive coding, represents states based on future visitation patterns.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory\sphinxhyphen{}Augmented Neural Networks}: Systems like Differentiable Neural Computers (DNCs) incorporate hippocampal\sphinxhyphen{}inspired memory systems to store and retrieve information.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Reinforcement Learning}: Multi\sphinxhyphen{}scale policy approaches inspired by the brain’s hierarchical representation of space and goals.

\end{enumerate}


\section{3.8 Take\sphinxhyphen{}aways}
\label{\detokenize{part1/ch03_spatial_navigation:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
The hippocampus contains specialized cells (place cells, grid cells) that form a coordinate system for navigation

\item {} 
\sphinxAtStartPar
The cellular organization of these systems creates efficient, sparse coding of spatial information

\item {} 
\sphinxAtStartPar
The regular, multi\sphinxhyphen{}scale nature of grid cells parallels the design principles of convolutional networks

\item {} 
\sphinxAtStartPar
Neural systems balance competing demands: specificity vs. generalization, precision vs. efficiency

\item {} 
\sphinxAtStartPar
Understanding biological implementations of spatial processing has directly informed AI architecture design

\item {} 
\sphinxAtStartPar
Conversely, computational models help us understand biological systems through testable predictions

\end{itemize}


\section{3.9 Further Reading \& Media}
\label{\detokenize{part1/ch03_spatial_navigation:further-reading-media}}

\subsection{Key Papers}
\label{\detokenize{part1/ch03_spatial_navigation:key-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
O’Keefe, J., \& Dostrovsky, J. (1971). “The hippocampus as a spatial map.” \sphinxstyleemphasis{Brain Research}, 34(1), 171\sphinxhyphen{}175.

\item {} 
\sphinxAtStartPar
Moser, E. I., Kropff, E., \& Moser, M. B. (2008). “Place cells, grid cells, and the brain’s spatial representation system.” \sphinxstyleemphasis{Annual Review of Neuroscience}, 31, 69\sphinxhyphen{}89.

\item {} 
\sphinxAtStartPar
Banino, A., Barry, C., Uria, B., Blundell, C., Lillicrap, T., Mirowski, P., … \& Kumaran, D. (2018). “Vector\sphinxhyphen{}based navigation using grid\sphinxhyphen{}like representations in artificial agents.” \sphinxstyleemphasis{Nature}, 557(7705), 429\sphinxhyphen{}433.

\item {} 
\sphinxAtStartPar
Cueva, C. J., \& Wei, X. X. (2018). “Emergence of grid\sphinxhyphen{}like representations by training recurrent neural networks to perform spatial localization.” \sphinxstyleemphasis{Science}, 361(6400), 337\sphinxhyphen{}341.

\end{itemize}


\subsection{Videos and Lectures}
\label{\detokenize{part1/ch03_spatial_navigation:videos-and-lectures}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Edvard Moser – Nobel Lecture on Grid Cells (2014)

\item {} 
\sphinxAtStartPar
“How Do We Find Our Way? Grid Cells in the Brain” (Frontiers for Young Minds video)

\item {} 
\sphinxAtStartPar
DeepMind’s Podcast Episode on Neuroscience and AI

\end{itemize}


\subsection{Tutorials and Resources}
\label{\detokenize{part1/ch03_spatial_navigation:tutorials-and-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Kloosterman, F. (2021). “Analyzing navigational data and neural activity.” \sphinxstyleemphasis{Current Protocols}, 1(4), e107.

\item {} 
\sphinxAtStartPar
Chen, Z., Kloosterman, F., Wilson, M. A., \& Brown, E. N. (2012). “Uncovering spatial topology represented by rat hippocampal population neuronal codes.” \sphinxstyleemphasis{Journal of Computational Neuroscience}, 33(2), 227\sphinxhyphen{}255.

\item {} 
\sphinxAtStartPar
Neuromatch Academy tutorials on spatial navigation and reinforcement learning

\end{itemize}

\sphinxstepscope


\chapter{Chapter 4: Perception Pipeline – Visual Cortex → CNNs}
\label{\detokenize{part1/ch04_perception_pipeline:chapter-4-perception-pipeline-visual-cortex-cnns}}\label{\detokenize{part1/ch04_perception_pipeline::doc}}

\section{4.0 Chapter Goals}
\label{\detokenize{part1/ch04_perception_pipeline:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Trace the visual processing pipeline from retina to higher cortical areas

\item {} 
\sphinxAtStartPar
Understand receptive fields and hierarchical feature extraction

\item {} 
\sphinxAtStartPar
Connect biological vision to convolutional neural networks

\item {} 
\sphinxAtStartPar
Implement simple visual filters and feature detectors

\end{itemize}


\section{4.1 Visual System Architecture}
\label{\detokenize{part1/ch04_perception_pipeline:visual-system-architecture}}
\sphinxAtStartPar
The visual system represents one of the most extensively studied sensory pathways in neuroscience, offering rich insights that have directly influenced artificial intelligence. This section explores how visual information flows from the eye through successively more complex processing stages.

\sphinxAtStartPar
\sphinxincludegraphics{{visual_pathway}.svg}
\sphinxstyleemphasis{Figure 4.1: The visual processing pathway from retina through subcortical structures to cortical areas, showing parallel processing streams.}


\subsection{4.1.1 From Retina to LGN to Primary Visual Cortex}
\label{\detokenize{part1/ch04_perception_pipeline:from-retina-to-lgn-to-primary-visual-cortex}}
\sphinxAtStartPar
Visual processing begins in the retina, which is actually an extension of the brain rather than a simple sensor:

\sphinxAtStartPar
\sphinxstylestrong{Retinal Processing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Photoreceptors (rods and cones) transduce light into neural signals

\item {} 
\sphinxAtStartPar
Horizontal, bipolar, and amacrine cells perform initial processing

\item {} 
\sphinxAtStartPar
Retinal ganglion cells form center\sphinxhyphen{}surround receptive fields

\item {} 
\sphinxAtStartPar
\textasciitilde{}1 million ganglion cell axons form the optic nerve from each eye

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{patches}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Circle}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{ndimage}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{center\PYGZus{}surround\PYGZus{}receptive\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{n}{center\PYGZus{}sigma}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{surround\PYGZus{}sigma}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{n}{center\PYGZus{}weight}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{surround\PYGZus{}weight}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a center\PYGZhy{}surround receptive field similar to retinal ganglion cells.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{grid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{grid}\PYG{p}{,} \PYG{n}{grid}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create center and surround Gaussians}
    \PYG{n}{center} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{yy}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{center\PYGZus{}sigma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{surround} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{yy}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{surround\PYGZus{}sigma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine to form center\PYGZhy{}surround}
    \PYG{n}{receptive\PYGZus{}field} \PYG{o}{=} \PYG{n}{center\PYGZus{}weight} \PYG{o}{*} \PYG{n}{center} \PYG{o}{\PYGZhy{}} \PYG{n}{surround\PYGZus{}weight} \PYG{o}{*} \PYG{n}{surround}
    
    \PYG{k}{return} \PYG{n}{receptive\PYGZus{}field}

\PYG{c+c1}{\PYGZsh{} Create ON\PYGZhy{}center and OFF\PYGZhy{}center receptive fields}
\PYG{n}{on\PYGZus{}center\PYGZus{}rf} \PYG{o}{=} \PYG{n}{center\PYGZus{}surround\PYGZus{}receptive\PYGZus{}field}\PYG{p}{(}\PYG{n}{center\PYGZus{}weight}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{surround\PYGZus{}weight}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
\PYG{n}{off\PYGZus{}center\PYGZus{}rf} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{on\PYGZus{}center\PYGZus{}rf}

\PYG{c+c1}{\PYGZsh{} Visualize the receptive fields}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{im1} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{on\PYGZus{}center\PYGZus{}rf}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RdBu\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ON\PYGZhy{}center Receptive Field}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im1}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{im2} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{off\PYGZus{}center\PYGZus{}rf}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RdBu\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{OFF\PYGZhy{}center Receptive Field}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im2}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} plt.show()  \PYGZsh{} Uncomment to display}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Lateral Geniculate Nucleus (LGN)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Subcortical relay station in the thalamus

\item {} 
\sphinxAtStartPar
Maintains retinotopic organization (spatial mapping)

\item {} 
\sphinxAtStartPar
Separates input into parallel channels:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Parvocellular pathway (P cells): High resolution, color

\item {} 
\sphinxAtStartPar
Magnocellular pathway (M cells): Motion, low contrast sensitivity

\item {} 
\sphinxAtStartPar
Koniocellular pathway (K cells): Blue\sphinxhyphen{}yellow color, other functions

\end{itemize}

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Primary Visual Cortex (V1)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Located in the occipital lobe

\item {} 
\sphinxAtStartPar
First stage of cortical visual processing

\item {} 
\sphinxAtStartPar
Organized in retinotopic map of visual field

\item {} 
\sphinxAtStartPar
Divided into six layers with distinct cell types and connections

\item {} 
\sphinxAtStartPar
Contains orientation\sphinxhyphen{}selective cells (simple and complex)

\item {} 
\sphinxAtStartPar
Processes basic features: orientation, spatial frequency, color, motion

\end{itemize}

\sphinxAtStartPar
From V1, information flows to higher visual areas (V2, V3, V4, etc.) that extract increasingly complex features.


\subsection{4.1.2 Ventral vs Dorsal Streams: “What” vs “Where”}
\label{\detokenize{part1/ch04_perception_pipeline:ventral-vs-dorsal-streams-what-vs-where}}
\sphinxAtStartPar
Visual processing bifurcates into two main pathways beyond V1 and V2:

\sphinxAtStartPar
\sphinxstylestrong{Ventral Stream (the “What” pathway)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Flows from V1 → V2 → V4 → Inferior Temporal (IT) cortex

\item {} 
\sphinxAtStartPar
Specializes in object recognition and form processing

\item {} 
\sphinxAtStartPar
Receptive fields increase in size and complexity along the pathway

\item {} 
\sphinxAtStartPar
Culminates in cells that respond to complex objects regardless of position, size, or lighting

\item {} 
\sphinxAtStartPar
Lesions cause object recognition deficits (visual agnosia)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Dorsal Stream (the “Where”/”How” pathway)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Flows from V1 → V2 → V3 → Middle Temporal (MT/V5) → Posterior Parietal cortex

\item {} 
\sphinxAtStartPar
Specializes in spatial relationships and motion

\item {} 
\sphinxAtStartPar
Processes location, movement, and action\sphinxhyphen{}relevant properties

\item {} 
\sphinxAtStartPar
Critical for visuomotor coordination and spatial attention

\item {} 
\sphinxAtStartPar
Lesions cause spatial awareness deficits (e.g., hemispatial neglect)

\end{itemize}

\sphinxAtStartPar
This dual\sphinxhyphen{}pathway organization has inspired various dual\sphinxhyphen{}stream architectures in artificial intelligence, particularly for tasks requiring both recognition and localization.


\subsection{4.1.3 Hierarchical Organization of Visual Cortex}
\label{\detokenize{part1/ch04_perception_pipeline:hierarchical-organization-of-visual-cortex}}
\sphinxAtStartPar
The visual cortex exhibits a clear hierarchical organization:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{display\PYGZus{}visual\PYGZus{}hierarchy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Display the visual processing hierarchy and key properties.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{visual\PYGZus{}areas} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field\PYGZus{}size}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZti{}1°}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}complexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Oriented edges, bars, gratings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{invariance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Minimal position invariance}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field\PYGZus{}size}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZti{}2\PYGZhy{}4°}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}complexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Contours, textures, illusory contours}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{invariance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Limited position invariance}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field\PYGZus{}size}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZti{}4\PYGZhy{}8°}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}complexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shape fragments, curvature, color}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{invariance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Moderate position and size invariance}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IT (PIT/CIT/AIT)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field\PYGZus{}size}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZti{}10\PYGZhy{}30°}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}complexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Object parts, faces, complex shapes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{invariance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Strong invariance to position, size, and viewpoint}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Visual Processing Hierarchy \PYGZhy{} Ventral Stream}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{*} \PYG{l+m+mi}{80}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}8}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RF Size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}15}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature Complexity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}35}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Invariance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}30}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{*} \PYG{l+m+mi}{80}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{area} \PYG{o+ow}{in} \PYG{n}{visual\PYGZus{}areas}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{area}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}8}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{area}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{receptive\PYGZus{}field\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}15}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{area}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{feature\PYGZus{}complexity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}35}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{area}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{invariance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{\PYGZlt{}30}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key principles of this hierarchical organization include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Progressive Abstraction}: Higher areas represent more complex features and objects

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Increasing Receptive Field Size}: Receptive fields become larger at higher levels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Growing Invariance}: Higher areas show greater invariance to transformations (position, size, etc.)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Declining Retinotopy}: Spatial organization becomes less precise in higher areas

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Increasing Response Latency}: Processing time increases along the hierarchy

\end{enumerate}


\subsection{4.1.4 Feedback Connections and Top\sphinxhyphen{}Down Processing}
\label{\detokenize{part1/ch04_perception_pipeline:feedback-connections-and-top-down-processing}}
\sphinxAtStartPar
While the visual system is often explained as a feedforward hierarchy, feedback connections are equally important:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Feedback projections outnumber feedforward connections in the visual cortex

\item {} 
\sphinxAtStartPar
Higher areas send predictions to lower areas

\item {} 
\sphinxAtStartPar
Feedback modulates response properties and selectivity

\item {} 
\sphinxAtStartPar
Facilitates attention, expectation, and context effects

\item {} 
\sphinxAtStartPar
Enables perceptual completion and object disambiguation

\end{itemize}

\sphinxAtStartPar
These recurrent connections enable the visual system to integrate prior knowledge and context with incoming sensory signals, forming the basis for predictive processing frameworks.


\section{4.2 Receptive Fields}
\label{\detokenize{part1/ch04_perception_pipeline:receptive-fields}}
\sphinxAtStartPar
Receptive fields—the regions of visual space that influence a neuron’s response—are fundamental to understanding visual processing in both biological and artificial systems.

\sphinxAtStartPar
\sphinxincludegraphics{{receptive_fields}.svg}
\sphinxstyleemphasis{Figure 4.2: Different types of receptive fields in the visual pathway, from center\sphinxhyphen{}surround to oriented bars to complex pattern detectors.}


\subsection{4.2.1 Simple, Complex, and Hypercomplex Cells}
\label{\detokenize{part1/ch04_perception_pipeline:simple-complex-and-hypercomplex-cells}}
\sphinxAtStartPar
Hubel and Wiesel’s groundbreaking work in the 1960s identified three main classes of cells in the visual cortex:

\sphinxAtStartPar
\sphinxstylestrong{Simple Cells}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Linear summation of inputs within precisely defined excitatory and inhibitory regions

\item {} 
\sphinxAtStartPar
Selective for orientation, position, and size of stimuli

\item {} 
\sphinxAtStartPar
Predictable responses based on exact stimulus location

\item {} 
\sphinxAtStartPar
Example: cells that respond to bars or edges with specific orientations at precise locations

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}cell\PYGZus{}model}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{orientation\PYGZus{}deg}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{center\PYGZus{}x}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{center\PYGZus{}y}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate a simple cell in V1 using a Gabor filter.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        image: Input image (grayscale)}
\PYG{l+s+sd}{        orientation\PYGZus{}deg: Preferred orientation in degrees}
\PYG{l+s+sd}{        sigma\PYGZus{}x, sigma\PYGZus{}y: Gaussian envelope widths}
\PYG{l+s+sd}{        center\PYGZus{}x, center\PYGZus{}y: Center coordinates}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Simple cell response to the input image}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Convert orientation to radians}
    \PYG{n}{orientation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{n}{orientation\PYGZus{}deg}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a grid of coordinates}
    \PYG{n}{rows}\PYG{p}{,} \PYG{n}{cols} \PYG{o}{=} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{cols}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{rows}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{cols}\PYG{o}{/}\PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{n}{center\PYGZus{}x}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{n}{rows}\PYG{o}{/}\PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{n}{center\PYGZus{}y}
    
    \PYG{c+c1}{\PYGZsh{} Rotate coordinates}
    \PYG{n}{x\PYGZus{}theta} \PYG{o}{=} \PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{orientation}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{orientation}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}theta} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{orientation}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{orientation}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Gabor filter components}
    \PYG{n}{gaussian} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{x\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{sigma\PYGZus{}x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{sigma\PYGZus{}y}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{sinusoid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{x\PYGZus{}theta} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{sigma\PYGZus{}x}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Gabor filter (receptive field)}
    \PYG{n}{gabor} \PYG{o}{=} \PYG{n}{gaussian} \PYG{o}{*} \PYG{n}{sinusoid}
    
    \PYG{c+c1}{\PYGZsh{} Apply the filter (convolve with the image)}
    \PYG{n}{response} \PYG{o}{=} \PYG{n}{ndimage}\PYG{o}{.}\PYG{n}{convolve}\PYG{p}{(}\PYG{n}{image}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{,} \PYG{n}{gabor}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{constant}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{response}\PYG{p}{,} \PYG{n}{gabor}

\PYG{c+c1}{\PYGZsh{} Example usage (with a synthetic edge image)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}edge\PYGZus{}image}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{angle\PYGZus{}deg}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{,} \PYG{n}{edge\PYGZus{}position}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{edge\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a simple edge image for demonstration.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{angle} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{n}{angle\PYGZus{}deg}\PYG{p}{)}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Rotate coordinates}
    \PYG{n}{x\PYGZus{}rot} \PYG{o}{=} \PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create edge}
    \PYG{n}{edge} \PYG{o}{=} \PYG{p}{(}\PYG{n}{x\PYGZus{}rot} \PYG{o}{\PYGZgt{}} \PYG{n}{edge\PYGZus{}position}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Smooth the edge slightly}
    \PYG{n}{edge} \PYG{o}{=} \PYG{n}{ndimage}\PYG{o}{.}\PYG{n}{gaussian\PYGZus{}filter}\PYG{p}{(}\PYG{n}{edge}\PYG{p}{,} \PYG{n}{sigma}\PYG{o}{=}\PYG{n}{edge\PYGZus{}width}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{edge}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Complex Cells}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Respond to oriented edges and bars regardless of exact position

\item {} 
\sphinxAtStartPar
Maintain orientation selectivity but exhibit spatial invariance

\item {} 
\sphinxAtStartPar
Often modeled as combining outputs from multiple simple cells

\item {} 
\sphinxAtStartPar
Example: cells that respond to a vertical edge anywhere within their receptive field

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{complex\PYGZus{}cell\PYGZus{}model}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{orientation\PYGZus{}deg}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{positions}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{spacing}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate a complex cell by combining responses from multiple simple cells.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        image: Input image}
\PYG{l+s+sd}{        orientation\PYGZus{}deg: Preferred orientation}
\PYG{l+s+sd}{        sigma\PYGZus{}x, sigma\PYGZus{}y: Filter parameters}
\PYG{l+s+sd}{        positions: Number of simple cells to combine}
\PYG{l+s+sd}{        spacing: Spacing between simple cell centers}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Complex cell response}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate responses from multiple simple cells at different positions}
    \PYG{n}{responses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{positions}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate position offset}
        \PYG{n}{offset} \PYG{o}{=} \PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{positions} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{*} \PYG{n}{spacing}
        
        \PYG{c+c1}{\PYGZsh{} Get simple cell response}
        \PYG{n}{simple\PYGZus{}response}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{simple\PYGZus{}cell\PYGZus{}model}\PYG{p}{(}
            \PYG{n}{image}\PYG{p}{,} \PYG{n}{orientation\PYGZus{}deg}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}x}\PYG{p}{,} \PYG{n}{sigma\PYGZus{}y}\PYG{p}{,} \PYG{n}{center\PYGZus{}x}\PYG{o}{=}\PYG{n}{offset}\PYG{p}{,} \PYG{n}{center\PYGZus{}y}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{n}{responses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{simple\PYGZus{}response}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Complex cell combines simple cell responses (maximum response at each point)}
    \PYG{n}{complex\PYGZus{}response} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{o}{.}\PYG{n}{reduce}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{complex\PYGZus{}response}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Hypercomplex (End\sphinxhyphen{}Stopped) Cells}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Selective for specific stimulus properties beyond orientation

\item {} 
\sphinxAtStartPar
Respond to line endings, curvature, or corners

\item {} 
\sphinxAtStartPar
Can be direction\sphinxhyphen{}selective or sensitive to specific motion patterns

\item {} 
\sphinxAtStartPar
Example: cells that respond to a line segment of specific length but not to a longer line

\end{itemize}

\sphinxAtStartPar
These cell types implement a hierarchical feature detection system, where complex cells build invariance to position, and hypercomplex cells detect more specialized features needed for object recognition.


\subsection{4.2.2 Gabor Filters and Orientation Selectivity}
\label{\detokenize{part1/ch04_perception_pipeline:gabor-filters-and-orientation-selectivity}}
\sphinxAtStartPar
The orientation selectivity of V1 cells is well\sphinxhyphen{}modeled by Gabor filters—sinusoidal gratings modulated by a Gaussian envelope:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}gabor\PYGZus{}filters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize Gabor filters at different orientations and frequencies.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{orientations} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{45}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{135}\PYG{p}{]}
    \PYG{n}{frequencies} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{]}
    
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{frequencies}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{orientations}\PYG{p}{)}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{freq} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{frequencies}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{orient} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{orientations}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create Gabor filter}
            \PYG{n}{sigma\PYGZus{}x} \PYG{o}{=} \PYG{l+m+mi}{10}
            \PYG{n}{sigma\PYGZus{}y} \PYG{o}{=} \PYG{l+m+mi}{10}
            
            \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{21}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{21}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Rotate coordinates}
            \PYG{n}{orient\PYGZus{}rad} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{n}{orient}\PYG{p}{)}
            \PYG{n}{x\PYGZus{}theta} \PYG{o}{=} \PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{orient\PYGZus{}rad}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{orient\PYGZus{}rad}\PYG{p}{)}
            \PYG{n}{y\PYGZus{}theta} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{orient\PYGZus{}rad}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{orient\PYGZus{}rad}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Create Gabor filter}
            \PYG{n}{gaussian} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{x\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{y\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{sigma\PYGZus{}x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{sinusoid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{freq} \PYG{o}{*} \PYG{n}{x\PYGZus{}theta}\PYG{p}{)}
            \PYG{n}{gabor} \PYG{o}{=} \PYG{n}{gaussian} \PYG{o}{*} \PYG{n}{sinusoid}
            
            \PYG{c+c1}{\PYGZsh{} Display the filter}
            \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{gabor}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RdBu\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{orient}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{°, f=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{freq}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} plt.show()  \PYGZsh{} Uncomment to display}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key properties of Gabor filters that match V1 neurophysiology:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Orientation Selectivity}: Responds strongly to edges/gratings at a preferred orientation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Spatial Frequency Selectivity}: Tuned to specific scales or frequencies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Localization}: Well\sphinxhyphen{}defined in both spatial and frequency domains

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Phase Sensitivity}: Different cells prefer different phases of gratings

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bandwidth}: Cells have specific tuning widths for orientation and frequency

\end{enumerate}

\sphinxAtStartPar
The orientation preference of neurons in V1 is organized in a systematic way:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Cells with similar orientation preferences cluster in “orientation columns”

\item {} 
\sphinxAtStartPar
Adjacent columns represent gradually changing orientations, forming “pinwheels”

\item {} 
\sphinxAtStartPar
This organization efficiently covers the space of all possible orientations

\end{itemize}


\subsection{4.2.3 Center\sphinxhyphen{}Surround Organization}
\label{\detokenize{part1/ch04_perception_pipeline:center-surround-organization}}
\sphinxAtStartPar
Center\sphinxhyphen{}surround receptive fields are foundational to early visual processing:

\sphinxAtStartPar
\sphinxstylestrong{Retinal Ganglion Cells}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
ON\sphinxhyphen{}center cells: Excited by light in center, inhibited by light in surround

\item {} 
\sphinxAtStartPar
OFF\sphinxhyphen{}center cells: Inhibited by light in center, excited by light in surround

\item {} 
\sphinxAtStartPar
Function as contrast detectors and edge enhancers

\item {} 
\sphinxAtStartPar
Perform efficient coding by reducing redundancy in natural images

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{LGN Cells}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Maintain the center\sphinxhyphen{}surround organization from retinal inputs

\item {} 
\sphinxAtStartPar
P cells: Small receptive fields, color\sphinxhyphen{}opponent (red\sphinxhyphen{}green)

\item {} 
\sphinxAtStartPar
M cells: Larger receptive fields, higher contrast sensitivity

\item {} 
\sphinxAtStartPar
K cells: Blue\sphinxhyphen{}yellow color opponency

\end{itemize}

\sphinxAtStartPar
This center\sphinxhyphen{}surround organization implements a form of local normalization and contrast enhancement that is also found in early layers of CNNs.


\subsection{4.2.4 Feature Hierarchy from V1 to IT}
\label{\detokenize{part1/ch04_perception_pipeline:feature-hierarchy-from-v1-to-it}}
\sphinxAtStartPar
As we move from V1 through the ventral stream to IT cortex, cells respond to increasingly complex features:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{feature\PYGZus{}hierarchy\PYGZus{}visual}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualization of the feature hierarchy in the ventral visual stream.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{areas} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IT}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{features} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Oriented edges, bars}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Contours, textures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shape fragments, curves}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Objects, faces, scenes}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} This would generate a visualization in a real notebook}
    \PYG{n}{feature\PYGZus{}map} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{areas}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{:} \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{areas}\PYG{p}{)}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
    \PYG{k}{return} \PYG{n}{feature\PYGZus{}map}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{V1}: Orientation, spatial frequency, edges, local features

\sphinxAtStartPar
\sphinxstylestrong{V2}: Combinations of orientations, contours, textures
\begin{itemize}
\item {} 
\sphinxAtStartPar
Responds to illusory contours

\item {} 
\sphinxAtStartPar
Sensitive to border ownership

\item {} 
\sphinxAtStartPar
Begins processing figure\sphinxhyphen{}ground relationships

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{V4}: Shape fragments, curvature, color
\begin{itemize}
\item {} 
\sphinxAtStartPar
Object\sphinxhyphen{}part selective responses

\item {} 
\sphinxAtStartPar
Moderate invariance to size and position

\item {} 
\sphinxAtStartPar
Attention strongly modulates responses

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{IT Cortex}: Objects, faces, complex patterns
\begin{itemize}
\item {} 
\sphinxAtStartPar
Cells selective for specific object categories

\item {} 
\sphinxAtStartPar
“Grandmother cells” that respond to particular face identities

\item {} 
\sphinxAtStartPar
High invariance to transformations (position, size, viewpoint)

\item {} 
\sphinxAtStartPar
Organized in specialized modules (e.g., fusiform face area)

\end{itemize}

\sphinxAtStartPar
This hierarchical feature organization is a key principle that directly inspired convolutional neural networks.


\section{4.3 CNN Parallels}
\label{\detokenize{part1/ch04_perception_pipeline:cnn-parallels}}
\sphinxAtStartPar
Convolutional Neural Networks (CNNs) incorporate many principles from the visual system, representing a striking example of neuroscience\sphinxhyphen{}inspired AI.

\sphinxAtStartPar
\sphinxincludegraphics{{cnn_visual_cortex}.svg}
\sphinxstyleemphasis{Figure 4.3: Parallels between the visual cortex hierarchy and layers of a convolutional neural network.}


\subsection{4.3.1 Convolutional Layers as Receptive Fields}
\label{\detokenize{part1/ch04_perception_pipeline:convolutional-layers-as-receptive-fields}}
\sphinxAtStartPar
Convolutional layers in CNNs implement the same basic principle as receptive fields in the visual cortex:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleConvNet}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleConvNet}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} First convolutional layer \PYGZhy{} similar to V1 simple cells}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Second convolutional layer \PYGZhy{} similar to V2}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Fully connected layers \PYGZhy{} similar to higher visual areas}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{16} \PYG{o}{*} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{120}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{,} \PYG{l+m+mi}{84}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{84}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 output classes}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Conv + ReLU + Max Pooling: detection + spatial invariance}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{max\PYGZus{}pool2d}\PYG{p}{(}\PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{max\PYGZus{}pool2d}\PYG{p}{(}\PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Flatten to vector for fully connected layers}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{16} \PYG{o}{*} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{l+m+mi}{5}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Fully connected layers with ReLU}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{x}

\PYG{c+c1}{\PYGZsh{} Create a simple CNN}
\PYG{n}{simple\PYGZus{}cnn} \PYG{o}{=} \PYG{n}{SimpleConvNet}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Initialize with random image (1 channel, 28x28 pixels)}
\PYG{n}{sample\PYGZus{}input} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize the first layer filters after training (in a real notebook)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}filters}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the filters learned in the first convolutional layer.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Extract filters from the first layer}
    \PYG{n}{filters} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{conv1}\PYG{o}{.}\PYG{n}{weight}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For demonstration purpose, just return the filter shapes}
    \PYG{k}{return} \PYG{n}{filters}\PYG{o}{.}\PYG{n}{shape}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key parallels between convolutional layers and visual receptive fields:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local Connectivity}: Convolutional filters only connect to a small region of the input, just like receptive fields

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Weight Sharing}: The same filter is applied across the entire input, similar to how V1 cells with the same orientation preference process different parts of the visual field

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}: Deeper layers process the outputs of earlier layers to detect more complex patterns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Detectors}: First\sphinxhyphen{}layer filters often learn Gabor\sphinxhyphen{}like patterns similar to V1 cells

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parameter Efficiency}: Both systems reduce parameters through spatial weight sharing

\end{enumerate}


\subsection{4.3.2 Pooling Operations and Invariance}
\label{\detokenize{part1/ch04_perception_pipeline:pooling-operations-and-invariance}}
\sphinxAtStartPar
Pooling layers in CNNs create invariance to small transformations, analogous to complex cells in V1:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}pooling}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate how pooling creates invariance to small translations.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a small translated version of the image}
    \PYG{n}{rows}\PYG{p}{,} \PYG{n}{cols} \PYG{o}{=} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{translation} \PYG{o}{=} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} Translate by 1 pixel}
    
    \PYG{n}{translated\PYGZus{}image} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    \PYG{n}{translated\PYGZus{}image}\PYG{p}{[}\PYG{n}{translation}\PYG{p}{:}\PYG{p}{,} \PYG{n}{translation}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{image}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{translation}\PYG{p}{,} \PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{translation}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Apply max pooling to both images}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{max\PYGZus{}pool}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{pool\PYGZus{}size}\PYG{p}{,} \PYG{n}{stride}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{result} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{n}{stride}\PYG{p}{,} \PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{n}{stride}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{pool\PYGZus{}size}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{pool\PYGZus{}size}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{result}\PYG{p}{[}\PYG{n}{i}\PYG{o}{/}\PYG{o}{/}\PYG{n}{stride}\PYG{p}{,} \PYG{n}{j}\PYG{o}{/}\PYG{o}{/}\PYG{n}{stride}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{img}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{pool\PYGZus{}size}\PYG{p}{,} \PYG{n}{j}\PYG{p}{:}\PYG{n}{j}\PYG{o}{+}\PYG{n}{pool\PYGZus{}size}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{result}
    
    \PYG{n}{pooled\PYGZus{}orig} \PYG{o}{=} \PYG{n}{max\PYGZus{}pool}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{pool\PYGZus{}size}\PYG{p}{,} \PYG{n}{stride}\PYG{p}{)}
    \PYG{n}{pooled\PYGZus{}trans} \PYG{o}{=} \PYG{n}{max\PYGZus{}pool}\PYG{p}{(}\PYG{n}{translated\PYGZus{}image}\PYG{p}{,} \PYG{n}{pool\PYGZus{}size}\PYG{p}{,} \PYG{n}{stride}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute similarity between pooled representations}
    \PYG{n}{similarity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{pooled\PYGZus{}orig}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{pooled\PYGZus{}trans}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Return results (would visualize in a real notebook)}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{original\PYGZus{}shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pooled\PYGZus{}shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{pooled\PYGZus{}orig}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{similarity\PYGZus{}after\PYGZus{}pooling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{similarity}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Parallels between pooling and biological visual processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Translation Invariance}: Max pooling creates robustness to exact positioning, similar to complex cells

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality Reduction}: Pooling reduces spatial dimensions, similar to increasing receptive field sizes in higher visual areas

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Invariance}: Stacking convolutional and pooling layers creates increasing invariance, mirroring the ventral stream

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Integration}: Pooling helps integrate features over local regions

\end{enumerate}

\sphinxAtStartPar
The increasing invariance to transformations is a key feature of the ventral stream that CNNs replicate through their architecture.


\subsection{4.3.3 Feature Hierarchies in Deep Networks}
\label{\detokenize{part1/ch04_perception_pipeline:feature-hierarchies-in-deep-networks}}
\sphinxAtStartPar
Deep CNNs develop feature hierarchies strikingly similar to the visual cortex:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}cnn\PYGZus{}hierarchy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate the hierarchy of features learned in different CNN layers.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{cnn\PYGZus{}hierarchy} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{layer1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Edges, textures, colors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biological\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1 simple cells (oriented edge detectors)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Small (e.g., 5x5 pixels)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{layer2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Corners, contours, simple textures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biological\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V2 cells (contour integration)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Medium (effective size grows)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{layer3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Object parts, complex textures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biological\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V4 cells (shape fragments)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Large (encompasses significant portion of image)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{layer4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Object detectors, category\PYGZhy{}specific features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biological\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IT cells (object and category selective)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{receptive\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Very large (most of the image)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{cnn\PYGZus{}hierarchy}
\end{sphinxVerbatim}

\sphinxAtStartPar
Zeiler and Fergus (2014) demonstrated this hierarchy by visualizing features learned at different layers of a CNN:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{First Layer}: Oriented edges, color blobs (like V1)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Middle Layers}: Textures, patterns, object parts (like V2/V4)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Deep Layers}: Object detectors, category\sphinxhyphen{}specific features (like IT)

\end{enumerate}

\sphinxAtStartPar
This emergent hierarchy develops through training, without being explicitly programmed—a case of convergent evolution between biological and artificial systems.


\subsection{4.3.4 Visualization of CNN Features}
\label{\detokenize{part1/ch04_perception_pipeline:visualization-of-cnn-features}}
\sphinxAtStartPar
Techniques to visualize CNN features have revealed striking similarities to biological vision:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{feature\PYGZus{}visualization\PYGZus{}techniques}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Summarize techniques for visualizing CNN features.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{techniques} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Activation Maximization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Optimize input to maximize activation of specific neurons}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{insight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reveals preferred stimuli of units, similar to neurophysiology experiments}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Deconvolution \PYGZam{} Guided Backprop}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Back\PYGZhy{}project activations to input space to visualize what activated units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{insight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shows what patterns in input space drive specific features}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feature Inversion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reconstruct image from feature representations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{insight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reveals what information is preserved at each layer}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GradCAM}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use gradients to identify important regions for classification}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{insight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shows attention\PYGZhy{}like focus on diagnostic image regions}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{techniques}
\end{sphinxVerbatim}

\sphinxAtStartPar
These visualization techniques have revealed that:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Early CNN layers develop Gabor\sphinxhyphen{}like filters similar to V1 neurons

\item {} 
\sphinxAtStartPar
Intermediate layers detect combinations of edges and textures

\item {} 
\sphinxAtStartPar
Deep layers contain units selective for specific objects or parts

\item {} 
\sphinxAtStartPar
CNNs develop specialized detectors for faces, text, and other categories

\end{enumerate}

\sphinxAtStartPar
The similarity between CNN feature visualization and neurophysiological recordings is one of the most compelling connections between artificial and biological vision.


\section{4.4 From Biology to Deep Learning}
\label{\detokenize{part1/ch04_perception_pipeline:from-biology-to-deep-learning}}
\sphinxAtStartPar
The development of CNNs represents a clear example of neuroscience directly inspiring AI advances.


\subsection{4.4.1 Hubel \& Wiesel’s Discoveries → Neocognitron → LeNet → AlexNet}
\label{\detokenize{part1/ch04_perception_pipeline:hubel-wiesel-s-discoveries-neocognitron-lenet-alexnet}}
\sphinxAtStartPar
The lineage from visual neuroscience to modern deep learning is direct and well\sphinxhyphen{}documented:

\sphinxAtStartPar
\sphinxstylestrong{Hubel \& Wiesel (1960s)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Discovered simple and complex cells in cat visual cortex

\item {} 
\sphinxAtStartPar
Identified hierarchical processing and receptive fields

\item {} 
\sphinxAtStartPar
Won Nobel Prize in 1981 for this groundbreaking work

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Neocognitron (Fukushima, 1980)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
First computational model directly inspired by Hubel \& Wiesel

\item {} 
\sphinxAtStartPar
Introduced alternating feature detection and pooling layers

\item {} 
\sphinxAtStartPar
Pioneered the basic CNN architecture but lacked effective training

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{LeNet (LeCun et al., 1989\sphinxhyphen{}1998)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Added backpropagation to train the network end\sphinxhyphen{}to\sphinxhyphen{}end

\item {} 
\sphinxAtStartPar
Developed for handwritten digit recognition (MNIST)

\item {} 
\sphinxAtStartPar
Demonstrated the effectiveness of convolutional architecture

\item {} 
\sphinxAtStartPar
Limited by computational constraints of the era

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AlexNet (Krizhevsky et al., 2012)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Scaled up CNN approach with GPU implementation

\item {} 
\sphinxAtStartPar
Won ImageNet competition by large margin

\item {} 
\sphinxAtStartPar
Triggered the deep learning revolution

\item {} 
\sphinxAtStartPar
Maintained the same biological inspiration from earlier work

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{cnn\PYGZus{}evolution\PYGZus{}timeline}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a timeline of CNN evolution from biological inspiration to modern architectures.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{timeline} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1959\PYGZhy{}1968}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hubel \PYGZam{} Wiesel discover simple and complex cells in visual cortex}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1980}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fukushima}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s Neocognitron: First hierarchical convolutional architecture}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1989}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LeCun introduces backpropagation for training CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1998}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LeNet\PYGZhy{}5 demonstrates effective digit recognition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2012}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AlexNet wins ImageNet, starts deep learning revolution}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2014}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{VGGNet and GoogLeNet deepen and refine architectures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2015}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ResNet introduces skip connections, enabling very deep networks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2017+}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Advanced architectures (DenseNet, EfficientNet) optimize CNN design}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{timeline}
\end{sphinxVerbatim}

\sphinxAtStartPar
This direct lineage demonstrates how neuroscience insights laid the foundation for transformative AI advances decades later.


\subsection{4.4.2 Biological Constraints vs Engineering Solutions}
\label{\detokenize{part1/ch04_perception_pipeline:biological-constraints-vs-engineering-solutions}}
\sphinxAtStartPar
While CNNs draw inspiration from biology, they also diverge in significant ways:

\sphinxAtStartPar
\sphinxstylestrong{Biological Features Maintained}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Local receptive fields and hierarchical processing

\item {} 
\sphinxAtStartPar
Feature detection followed by pooling for invariance

\item {} 
\sphinxAtStartPar
Increasingly complex feature representations

\item {} 
\sphinxAtStartPar
Parallel processing of different visual attributes

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Engineering Departures}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Backpropagation (biologically implausible in its standard form)

\item {} 
\sphinxAtStartPar
Separate forward and backward passes

\item {} 
\sphinxAtStartPar
Weight sharing across entire feature maps

\item {} 
\sphinxAtStartPar
Supervised training with labeled examples

\item {} 
\sphinxAtStartPar
Batch normalization and other engineering optimizations

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}bio\PYGZus{}vs\PYGZus{}engineering}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare biological visual systems with CNN engineering approaches.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{comparison} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Learning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hebbian learning, STDP, reinforcement, unsupervised}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Backpropagation, supervised learning with labels}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Architecture}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recurrent connections, feedback pathways, modulatory inputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Primarily feedforward, limited recurrence in some designs}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Activation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spiking neurons with temporal dynamics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Continuous\PYGZhy{}valued activations (ReLU, etc.)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Efficiency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Extremely energy efficient, sparse activity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Computationally intensive, dense computation}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Learning Speed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fast one\PYGZhy{}shot learning for some tasks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Requires many examples, but improving with few\PYGZhy{}shot methods}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{comparison}
\end{sphinxVerbatim}

\sphinxAtStartPar
These differences represent engineering pragmatism: CNNs adopt biologically\sphinxhyphen{}inspired principles where helpful but diverge where engineering solutions are more effective.


\subsection{4.4.3 Normalization and Gain Control Mechanisms}
\label{\detokenize{part1/ch04_perception_pipeline:normalization-and-gain-control-mechanisms}}
\sphinxAtStartPar
Both biological and artificial visual systems implement normalization:

\sphinxAtStartPar
\sphinxstylestrong{Biological Normalization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Contrast normalization in retina and LGN

\item {} 
\sphinxAtStartPar
Cross\sphinxhyphen{}orientation inhibition in V1

\item {} 
\sphinxAtStartPar
Surround suppression effects

\item {} 
\sphinxAtStartPar
Divisive normalization across neural populations

\item {} 
\sphinxAtStartPar
Adaptation to prevailing input statistics

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{CNN Normalization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Batch normalization

\item {} 
\sphinxAtStartPar
Layer normalization

\item {} 
\sphinxAtStartPar
Instance normalization

\item {} 
\sphinxAtStartPar
Group normalization

\item {} 
\sphinxAtStartPar
Local response normalization (used in AlexNet)

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{normalization\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate the effect of normalization in neural processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Create sample activations}
    \PYG{n}{activations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{gamma}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{scale}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Skewed distribution}
    
    \PYG{c+c1}{\PYGZsh{} Apply divisive normalization (simplified model)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{divisive\PYGZus{}normalization}\PYG{p}{(}\PYG{n}{act}\PYG{p}{,} \PYG{n}{sigma}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{neighborhood\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{normalized} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{act}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{act}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Define local neighborhood}
            \PYG{n}{start} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{neighborhood\PYGZus{}size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{act}\PYG{p}{)}\PYG{p}{,} \PYG{n}{i} \PYG{o}{+} \PYG{n}{neighborhood\PYGZus{}size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{neighborhood} \PYG{o}{=} \PYG{n}{act}\PYG{p}{[}\PYG{n}{start}\PYG{p}{:}\PYG{n}{end}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Compute normalization factor}
            \PYG{n}{norm\PYGZus{}factor} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{sigma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{neighborhood}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Normalize}
            \PYG{n}{normalized}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{act}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n}{norm\PYGZus{}factor}
        
        \PYG{k}{return} \PYG{n}{normalized}
    
    \PYG{n}{normalized\PYGZus{}activations} \PYG{o}{=} \PYG{n}{divisive\PYGZus{}normalization}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compare statistics}
    \PYG{n}{stats} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{original\PYGZus{}mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{original\PYGZus{}std}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{original\PYGZus{}max}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{normalized\PYGZus{}mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{normalized\PYGZus{}activations}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{normalized\PYGZus{}std}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{normalized\PYGZus{}activations}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{normalized\PYGZus{}max}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{normalized\PYGZus{}activations}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{stats}
\end{sphinxVerbatim}

\sphinxAtStartPar
Normalization serves several key functions:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Stabilizes training by controlling activation distributions

\item {} 
\sphinxAtStartPar
Enables efficient coding by adapting to input statistics

\item {} 
\sphinxAtStartPar
Enhances discriminability by emphasizing differences

\item {} 
\sphinxAtStartPar
Manages the dynamic range of neural responses

\end{enumerate}

\sphinxAtStartPar
The parallel implementation of normalization in both systems highlights its computational importance.


\subsection{4.4.4 Attention Mechanisms}
\label{\detokenize{part1/ch04_perception_pipeline:attention-mechanisms}}
\sphinxAtStartPar
Attention mechanisms represent another area of convergence:

\sphinxAtStartPar
\sphinxstylestrong{Visual Attention in the Brain}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Selective enhancement of relevant visual regions

\item {} 
\sphinxAtStartPar
Spotlight or zoom lens models of spatial attention

\item {} 
\sphinxAtStartPar
Feature\sphinxhyphen{}based attention that enhances specific attributes

\item {} 
\sphinxAtStartPar
Modulation by frontal and parietal control networks

\item {} 
\sphinxAtStartPar
Enhanced processing and perceptual quality in attended regions

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Attention in Deep Learning}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Spatial attention mechanisms in CNNs

\item {} 
\sphinxAtStartPar
Channel attention (e.g., Squeeze\sphinxhyphen{}and\sphinxhyphen{}Excitation Networks)

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}attention in Transformers (now integrated into vision models)

\item {} 
\sphinxAtStartPar
Cross\sphinxhyphen{}attention between modalities

\item {} 
\sphinxAtStartPar
Hard attention (selecting specific regions) vs. soft attention (weighting)

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{attention\PYGZus{}mechanisms}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare biological and artificial attention mechanisms.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{attention\PYGZus{}comparison} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spatial Attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enhanced processing at attended locations, controlled by FEF/IPS}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spatial attention maps, region proposal networks, visual transformers}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feature Attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enhanced processing of attended features across visual field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Channel attention mechanisms, feature emphasizing}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Increased firing rates, improved discriminability, reduced latency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Weighted feature maps, selected processing pathways}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Control}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Top\PYGZhy{}down control from prefrontal and parietal cortex}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Learned attention weights, explicit guidance mechanisms}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{attention\PYGZus{}comparison}
\end{sphinxVerbatim}

\sphinxAtStartPar
Recent CNN architectures increasingly incorporate attention mechanisms, moving beyond pure feedforward processing toward more brain\sphinxhyphen{}like dynamic routing of information.


\section{4.5 Beyond Feedforward Processing}
\label{\detokenize{part1/ch04_perception_pipeline:beyond-feedforward-processing}}
\sphinxAtStartPar
While early CNNs focused on feedforward processing, both biological vision and cutting\sphinxhyphen{}edge AI incorporate more complex processing dynamics.


\subsection{4.5.1 Recurrence in Visual Processing}
\label{\detokenize{part1/ch04_perception_pipeline:recurrence-in-visual-processing}}
\sphinxAtStartPar
The visual cortex contains extensive recurrent connections:

\sphinxAtStartPar
\sphinxstylestrong{Biological Recurrence}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Local recurrent circuits within cortical areas

\item {} 
\sphinxAtStartPar
Feedback connections from higher to lower areas

\item {} 
\sphinxAtStartPar
Horizontal connections linking neurons within layers

\item {} 
\sphinxAtStartPar
Temporal dynamics and sustained activity patterns

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AI Recurrence}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Recurrent convolutional networks

\item {} 
\sphinxAtStartPar
Convolutional LSTMs

\item {} 
\sphinxAtStartPar
CORnet and similar biologically\sphinxhyphen{}inspired models

\item {} 
\sphinxAtStartPar
Transformer\sphinxhyphen{}based architectures with self\sphinxhyphen{}attention

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{RecurrentConvLayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simple implementation of a recurrent convolutional layer.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{output\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{RecurrentConvLayer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}channels} \PYG{o}{=} \PYG{n}{input\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}channels} \PYG{o}{=} \PYG{n}{output\PYGZus{}channels}
        
        \PYG{c+c1}{\PYGZsh{} Forward connection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}forward} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}
            \PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{output\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{n}{padding}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Recurrent connection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}recurrent} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}
            \PYG{n}{output\PYGZus{}channels}\PYG{p}{,} \PYG{n}{output\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{n}{padding}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activation function}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{n}{inplace}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{prev\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{h\PYGZus{}new} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add recurrent connection if previous state exists}
        \PYG{k}{if} \PYG{n}{prev\PYGZus{}state} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{h\PYGZus{}new} \PYG{o}{=} \PYG{n}{h\PYGZus{}new} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}recurrent}\PYG{p}{(}\PYG{n}{prev\PYGZus{}state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply non\PYGZhy{}linearity}
        \PYG{n}{h\PYGZus{}new} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{h\PYGZus{}new}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{h\PYGZus{}new}
\end{sphinxVerbatim}

\sphinxAtStartPar
Recurrent processing enables:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Integration of information over time

\item {} 
\sphinxAtStartPar
Refinement of initial representations

\item {} 
\sphinxAtStartPar
Context\sphinxhyphen{}sensitive processing

\item {} 
\sphinxAtStartPar
Figure\sphinxhyphen{}ground segmentation

\item {} 
\sphinxAtStartPar
Perceptual completion and illusion

\end{enumerate}

\sphinxAtStartPar
Incorporating recurrence brings AI systems closer to biological vision and can improve performance on challenging tasks.


\subsection{4.5.2 Predictive Coding and Generative Models}
\label{\detokenize{part1/ch04_perception_pipeline:predictive-coding-and-generative-models}}
\sphinxAtStartPar
The brain appears to implement predictive processing, which has inspired generative models in AI:

\sphinxAtStartPar
\sphinxstylestrong{Predictive Coding in the Brain}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Higher levels predict lower\sphinxhyphen{}level activity

\item {} 
\sphinxAtStartPar
Prediction errors drive learning and updating

\item {} 
\sphinxAtStartPar
Balances bottom\sphinxhyphen{}up evidence with top\sphinxhyphen{}down predictions

\item {} 
\sphinxAtStartPar
Explains effects like end\sphinxhyphen{}stopping and non\sphinxhyphen{}classical receptive fields

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Corresponding AI Approaches}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Variational autoencoders (VAEs)

\item {} 
\sphinxAtStartPar
Generative adversarial networks (GANs)

\item {} 
\sphinxAtStartPar
Diffusion models

\item {} 
\sphinxAtStartPar
Hierarchical predictive coding models

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predictive\PYGZus{}coding\PYGZus{}model}\PYG{p}{(}\PYG{n}{input\PYGZus{}image}\PYG{p}{,} \PYG{n}{prediction}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simplified implementation of predictive coding update.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Compute prediction error}
    \PYG{n}{prediction\PYGZus{}error} \PYG{o}{=} \PYG{n}{input\PYGZus{}image} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction}
    
    \PYG{c+c1}{\PYGZsh{} Update predictions to minimize error}
    \PYG{n}{new\PYGZus{}prediction} \PYG{o}{=} \PYG{n}{prediction} \PYG{o}{+} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{prediction\PYGZus{}error}
    
    \PYG{c+c1}{\PYGZsh{} Return updated prediction and error}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prediction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{new\PYGZus{}prediction}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prediction\PYGZus{}error}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{prediction\PYGZus{}error}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{error\PYGZus{}magnitude}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{)}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Predictive coding offers a unified framework for understanding perception, learning, and attention in both biological and artificial systems.


\subsection{4.5.3 Integration of Context and Prior Knowledge}
\label{\detokenize{part1/ch04_perception_pipeline:integration-of-context-and-prior-knowledge}}
\sphinxAtStartPar
Both biological and advanced artificial vision systems integrate contextual information:

\sphinxAtStartPar
\sphinxstylestrong{Contextual Effects in Biological Vision}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Scene context influences object recognition

\item {} 
\sphinxAtStartPar
Prior knowledge shapes perception of ambiguous stimuli

\item {} 
\sphinxAtStartPar
Contour integration and grouping phenomena

\item {} 
\sphinxAtStartPar
Long\sphinxhyphen{}range connections create context\sphinxhyphen{}dependent responses

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AI Approaches to Context}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Scene graph models

\item {} 
\sphinxAtStartPar
Contextual attention mechanisms

\item {} 
\sphinxAtStartPar
Memory networks that maintain context

\item {} 
\sphinxAtStartPar
Multimodal systems integrating vision with language

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{contextual\PYGZus{}influence\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate how context influences perception.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Example of ambiguous stimuli with different contexts}
    \PYG{n}{contexts} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context\PYGZus{}A}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The chef carefully placed the \PYGZus{}\PYGZus{}\PYGZus{} on the dining table.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The courier delivered the \PYGZus{}\PYGZus{}\PYGZus{} to the customer.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ambiguous\PYGZus{}stimulus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{plate}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} Could be dinner plate or tectonic plate}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Simulated perception based on context (would be model outputs in practice)}
    \PYG{n}{perceptions} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context\PYGZus{}A}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{interpretation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dinner plate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.95}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{associated\PYGZus{}features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{round}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ceramic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{food\PYGZhy{}related}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{interpretation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shipment package}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.82}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{associated\PYGZus{}features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cardboard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shipping label}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{delivery}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{contexts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{contexts}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{perceptions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{perceptions}\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Integrating context and prior knowledge brings artificial systems closer to human\sphinxhyphen{}like perception with its robust, context\sphinxhyphen{}sensitive interpretation.


\subsection{4.5.4 The Free Energy Principle}
\label{\detokenize{part1/ch04_perception_pipeline:the-free-energy-principle}}
\sphinxAtStartPar
The free energy principle provides a unifying theoretical framework that may explain many aspects of brain function:

\sphinxAtStartPar
\sphinxstylestrong{Key Concepts}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The brain minimizes prediction error (free energy)

\item {} 
\sphinxAtStartPar
Perception is inference about the causes of sensory data

\item {} 
\sphinxAtStartPar
Learning improves the generative model to better predict inputs

\item {} 
\sphinxAtStartPar
Attention allocates resources to minimize expected free energy

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AI Implementations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Variational inference methods

\item {} 
\sphinxAtStartPar
Active inference models

\item {} 
\sphinxAtStartPar
Energy\sphinxhyphen{}based models

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}supervised predictive learning approaches

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{free\PYGZus{}energy\PYGZus{}calculation}\PYG{p}{(}\PYG{n}{sensory\PYGZus{}data}\PYG{p}{,} \PYG{n}{predicted\PYGZus{}data}\PYG{p}{,} \PYG{n}{model\PYGZus{}complexity}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simplified calculation of free energy.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Prediction error component (accuracy)}
    \PYG{n}{prediction\PYGZus{}error} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{sensory\PYGZus{}data} \PYG{o}{\PYGZhy{}} \PYG{n}{predicted\PYGZus{}data}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Complexity penalty (regularization)}
    \PYG{n}{complexity\PYGZus{}cost} \PYG{o}{=} \PYG{n}{model\PYGZus{}complexity}
    
    \PYG{c+c1}{\PYGZsh{} Free energy combines both terms}
    \PYG{n}{free\PYGZus{}energy} \PYG{o}{=} \PYG{n}{prediction\PYGZus{}error} \PYG{o}{+} \PYG{n}{complexity\PYGZus{}cost}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{free\PYGZus{}energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{free\PYGZus{}energy}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prediction\PYGZus{}error}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{prediction\PYGZus{}error}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{complexity\PYGZus{}cost}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{complexity\PYGZus{}cost}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
The free energy principle provides a theoretical bridge between biological and artificial intelligence, suggesting fundamental computational principles that may underlie both.


\section{4.6 Code Lab}
\label{\detokenize{part1/ch04_perception_pipeline:code-lab}}
\sphinxAtStartPar
Let’s explore practical implementations of visual processing concepts from both biological and artificial systems.


\subsection{4.6.1 Implementing Simple Gabor Filters}
\label{\detokenize{part1/ch04_perception_pipeline:implementing-simple-gabor-filters}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{ndimage}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{skimage}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{data}\PYG{p}{,} \PYG{n}{color}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}gabor\PYGZus{}filter}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{25}\PYG{p}{,} \PYG{n}{sigma}\PYG{o}{=}\PYG{l+m+mf}{3.0}\PYG{p}{,} \PYG{n}{theta}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{lambda\PYGZus{}}\PYG{o}{=}\PYG{l+m+mf}{5.0}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{psi}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a Gabor filter kernel.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        size: Size of the kernel}
\PYG{l+s+sd}{        sigma: Standard deviation of the Gaussian envelope}
\PYG{l+s+sd}{        theta: Orientation (in radians)}
\PYG{l+s+sd}{        lambda\PYGZus{}: Wavelength of sinusoidal component}
\PYG{l+s+sd}{        gamma: Spatial aspect ratio}
\PYG{l+s+sd}{        psi: Phase offset}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Gabor kernel}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate grid}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Rotation}
    \PYG{n}{x\PYGZus{}theta} \PYG{o}{=} \PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}theta} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Gaussian envelope}
    \PYG{n}{gb} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{x\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{p}{(}\PYG{n}{gamma} \PYG{o}{*} \PYG{n}{y\PYGZus{}theta}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{sigma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Sinusoidal carrier}
    \PYG{n}{gb} \PYG{o}{*}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{x\PYGZus{}theta} \PYG{o}{/} \PYG{n}{lambda\PYGZus{}} \PYG{o}{+} \PYG{n}{psi}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{gb}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}gabor\PYGZus{}bank}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{num\PYGZus{}orientations}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Apply a bank of Gabor filters to an image.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{2}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Convert to grayscale if color}
        \PYG{n}{image} \PYG{o}{=} \PYG{n}{color}\PYG{o}{.}\PYG{n}{rgb2gray}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create filters at different orientations}
    \PYG{n}{orientations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{num\PYGZus{}orientations}\PYG{p}{)}
    \PYG{n}{responses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{filters} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{theta} \PYG{o+ow}{in} \PYG{n}{orientations}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create filter}
        \PYG{n}{gabor\PYGZus{}kernel} \PYG{o}{=} \PYG{n}{create\PYGZus{}gabor\PYGZus{}filter}\PYG{p}{(}\PYG{n}{theta}\PYG{o}{=}\PYG{n}{theta}\PYG{p}{)}
        \PYG{n}{filters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{gabor\PYGZus{}kernel}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply filter}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{ndimage}\PYG{o}{.}\PYG{n}{convolve}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{gabor\PYGZus{}kernel}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nearest}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{responses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{response}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{responses}\PYG{p}{,} \PYG{n}{filters}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{gabor\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Load sample image}
    \PYG{n}{image} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{camera}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply Gabor filters}
    \PYG{n}{responses}\PYG{p}{,} \PYG{n}{filters} \PYG{o}{=} \PYG{n}{apply\PYGZus{}gabor\PYGZus{}bank}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualization code (would generate plots in real notebook)}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{image\PYGZus{}shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{num\PYGZus{}filters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{filters}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{filter\PYGZus{}shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{filters}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response\PYGZus{}shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{responses}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}
    \PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Run the demo}
\PYG{n}{gabor\PYGZus{}result} \PYG{o}{=} \PYG{n}{gabor\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Applied }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{gabor\PYGZus{}result}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{num\PYGZus{}filters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ Gabor filters to image of shape }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{gabor\PYGZus{}result}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{image\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{4.6.2 Building a Basic Convolutional Layer}
\label{\detokenize{part1/ch04_perception_pipeline:building-a-basic-convolutional-layer}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{transforms}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{transforms}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{MNIST}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{n+nn}{.}\PYG{n+nn}{data}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{DataLoader}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleV1Model}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simple CNN model inspired by V1 processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}orientations}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{num\PYGZus{}scales}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleV1Model}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}orientations} \PYG{o}{=} \PYG{n}{num\PYGZus{}orientations}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}scales} \PYG{o}{=} \PYG{n}{num\PYGZus{}scales}
        
        \PYG{c+c1}{\PYGZsh{} Simple cells (orientation\PYGZhy{}selective filters)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{simple\PYGZus{}cells} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{[}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{num\PYGZus{}orientations}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{o}{+}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{i}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{+}\PYG{n}{i}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}scales}\PYG{p}{)}
        \PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Complex cells (pooling for position invariance)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{complex\PYGZus{}cells} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{[}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}scales}\PYG{p}{)}
        \PYG{p}{]}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Apply simple and complex cells at each scale}
        \PYG{n}{responses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{simple}\PYG{p}{,} \PYG{n}{complex\PYGZus{}pool} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{simple\PYGZus{}cells}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{complex\PYGZus{}cells}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simple cell response}
            \PYG{n}{simple\PYGZus{}response} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{simple}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Complex cell response (pooling)}
            \PYG{n}{complex\PYGZus{}response} \PYG{o}{=} \PYG{n}{complex\PYGZus{}pool}\PYG{p}{(}\PYG{n}{simple\PYGZus{}response}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Flatten and add to responses}
            \PYG{n}{responses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{complex\PYGZus{}response}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{complex\PYGZus{}response}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Concatenate all responses}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{combined}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}v1\PYGZus{}model}\PYG{p}{(}\PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train a V1\PYGZhy{}inspired model on MNIST.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Set device}
    \PYG{n}{device} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{device}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cuda}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{is\PYGZus{}available}\PYG{p}{(}\PYG{p}{)} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cpu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Load MNIST dataset}
    \PYG{n}{transform} \PYG{o}{=} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Compose}\PYG{p}{(}\PYG{p}{[}\PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ToTensor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Normalize}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{MNIST}\PYG{p}{(}\PYG{n}{root}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{train}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{download}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{transform}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{train\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleV1Model}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For demonstration only \PYGZhy{} return model architecture}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1\PYGZhy{}inspired CNN}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{architecture}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Show model architecture}
\PYG{n}{v1\PYGZus{}model\PYGZus{}info} \PYG{o}{=} \PYG{n}{train\PYGZus{}v1\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model architecture: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{v1\PYGZus{}model\PYGZus{}info}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{architecture}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{4.6.3 Feature Visualization Techniques}
\label{\detokenize{part1/ch04_perception_pipeline:feature-visualization-techniques}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{feature\PYGZus{}vis\PYGZus{}demo}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{layer\PYGZus{}idx}\PYG{p}{,} \PYG{n}{feature\PYGZus{}map\PYGZus{}idx}\PYG{p}{,} \PYG{n}{iterations}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implement activation maximization to visualize what activates a specific feature.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        model: Pretrained CNN}
\PYG{l+s+sd}{        layer\PYGZus{}idx: Index of layer to visualize}
\PYG{l+s+sd}{        feature\PYGZus{}map\PYGZus{}idx: Index of feature map to visualize}
\PYG{l+s+sd}{        iterations: Number of optimization iterations}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Synthesized image that maximally activates the feature}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Note: This is a simplified outline of the technique}
    
    \PYG{c+c1}{\PYGZsh{} Create a random image}
    \PYG{n}{image} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{224}\PYG{p}{,} \PYG{l+m+mi}{224}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
    
    \PYG{c+c1}{\PYGZsh{} Convert to tensor}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{requires\PYGZus{}grad}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Optimization loop}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{iterations}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{activations} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Here we would:}
        \PYG{c+c1}{\PYGZsh{} 1. Forward pass through the network up to target layer}
        \PYG{c+c1}{\PYGZsh{} 2. Extract activation of target feature map}
        \PYG{c+c1}{\PYGZsh{} 3. Compute loss (negative activation to maximize)}
        \PYG{c+c1}{\PYGZsh{} 4. Backward pass to get gradients on input}
        \PYG{c+c1}{\PYGZsh{} 5. Update input image with gradients}
        \PYG{c+c1}{\PYGZsh{} 6. Apply constraints (e.g., regularization)}
        
        \PYG{c+c1}{\PYGZsh{} For demonstration, return placeholder}
        \PYG{n}{activations}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iteration }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: [simulated activation]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For this code template, return a description}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technique}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Activation Maximization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{target}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Layer }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer\PYGZus{}idx}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Feature Map }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{feature\PYGZus{}map\PYGZus{}idx}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{iterations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{iterations}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{result}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{In a real implementation, returns the synthesized image}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subsection{4.6.4 Transfer Learning with Pre\sphinxhyphen{}trained CNNs}
\label{\detokenize{part1/ch04_perception_pipeline:transfer-learning-with-pre-trained-cnns}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{models}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{models}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Adam}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{transfer\PYGZus{}learning\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate transfer learning with a pre\PYGZhy{}trained CNN.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Load pre\PYGZhy{}trained model}
    \PYG{n}{resnet} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{resnet18}\PYG{p}{(}\PYG{n}{pretrained}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Freeze early layers}
    \PYG{k}{for} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{resnet}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{param}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad} \PYG{o}{=} \PYG{k+kc}{False}
    
    \PYG{c+c1}{\PYGZsh{} Replace final fully connected layer}
    \PYG{n}{num\PYGZus{}features} \PYG{o}{=} \PYG{n}{resnet}\PYG{o}{.}\PYG{n}{fc}\PYG{o}{.}\PYG{n}{in\PYGZus{}features}
    \PYG{n}{num\PYGZus{}classes} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} e.g., for a custom dataset}
    \PYG{n}{resnet}\PYG{o}{.}\PYG{n}{fc} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{num\PYGZus{}features}\PYG{p}{,} \PYG{n}{num\PYGZus{}classes}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create optimizer for only the new layer}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{Adam}\PYG{p}{(}\PYG{n}{resnet}\PYG{o}{.}\PYG{n}{fc}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} In a real implementation, we would:}
    \PYG{c+c1}{\PYGZsh{} 1. Load custom dataset}
    \PYG{c+c1}{\PYGZsh{} 2. Create data loaders}
    \PYG{c+c1}{\PYGZsh{} 3. Train the modified model}
    \PYG{c+c1}{\PYGZsh{} 4. Evaluate performance}
    
    \PYG{c+c1}{\PYGZsh{} For this template, return the model architecture}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ResNet\PYGZhy{}18 with transfer learning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{frozen\PYGZus{}layers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{All except final FC layer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trainable\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{resnet}\PYG{o}{.}\PYG{n}{fc}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{total\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{resnet}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Get transfer learning details}
\PYG{n}{transfer\PYGZus{}details} \PYG{o}{=} \PYG{n}{transfer\PYGZus{}learning\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{efficiency} \PYG{o}{=} \PYG{p}{(}\PYG{n}{transfer\PYGZus{}details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trainable\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{/} \PYG{n}{transfer\PYGZus{}details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{total\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{100}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transfer learning trains }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{efficiency}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{} of total parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{4.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part1/ch04_perception_pipeline:take-aways}}
\sphinxAtStartPar
The relationship between biological vision and CNNs demonstrates the power of neuroscience\sphinxhyphen{}inspired AI:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Feature Extraction is Universal}: Both biological vision and CNNs build complex representations from simple features through hierarchical processing.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local to Global Processing Works}: Processing visual information with local receptive fields that grow in size and complexity is a powerful and efficient approach.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Detection Plus Invariance}: The separation of feature detection (simple cells/convolutional layers) and invariance operations (complex cells/pooling layers) is fundamental to both systems.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Beyond Feedforward}: While CNNs began as purely feedforward, both biological vision and cutting\sphinxhyphen{}edge AI increasingly incorporate recurrence, feedback, and context.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Convergent Evolution}: The strong similarities between features learned by CNNs and those observed in the visual cortex suggest fundamental principles of efficient visual processing.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional Insights}: Neuroscience continues to inspire AI innovations, while AI implementations help test and refine theories about biological vision.

\end{enumerate}

\sphinxAtStartPar
This bidirectional flow of insights exemplifies the value of interdisciplinary research between neuroscience and artificial intelligence.


\section{4.8 Further Reading \& Media}
\label{\detokenize{part1/ch04_perception_pipeline:further-reading-media}}

\subsection{Foundational Papers}
\label{\detokenize{part1/ch04_perception_pipeline:foundational-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hubel, D. H., \& Wiesel, T. N. (1962). Receptive fields, binocular interaction and functional architecture in the cat’s visual cortex. \sphinxstyleemphasis{The Journal of physiology, 160}(1), 106\sphinxhyphen{}154.

\item {} 
\sphinxAtStartPar
Fukushima, K. (1980). Neocognitron: A self\sphinxhyphen{}organizing neural network model for a mechanism of pattern recognition unaffected by shift in position. \sphinxstyleemphasis{Biological cybernetics, 36}(4), 193\sphinxhyphen{}202.

\item {} 
\sphinxAtStartPar
LeCun, Y., Bottou, L., Bengio, Y., \& Haffner, P. (1998). Gradient\sphinxhyphen{}based learning applied to document recognition. \sphinxstyleemphasis{Proceedings of the IEEE, 86}(11), 2278\sphinxhyphen{}2324.

\item {} 
\sphinxAtStartPar
Krizhevsky, A., Sutskever, I., \& Hinton, G. E. (2012). Imagenet classification with deep convolutional neural networks. \sphinxstyleemphasis{Advances in neural information processing systems, 25}.

\end{itemize}


\subsection{Biological Vision}
\label{\detokenize{part1/ch04_perception_pipeline:biological-vision}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Felleman, D. J., \& Van Essen, D. C. (1991). Distributed hierarchical processing in the primate cerebral cortex. \sphinxstyleemphasis{Cerebral cortex, 1}(1), 1\sphinxhyphen{}47.

\item {} 
\sphinxAtStartPar
Carandini, M., Demb, J. B., Mante, V., Tolhurst, D. J., Dan, Y., Olshausen, B. A., … \& Rust, N. C. (2005). Do we know what the early visual system does?. \sphinxstyleemphasis{Journal of Neuroscience, 25}(46), 10577\sphinxhyphen{}10597.

\item {} 
\sphinxAtStartPar
DiCarlo, J. J., Zoccolan, D., \& Rust, N. C. (2012). How does the brain solve visual object recognition?. \sphinxstyleemphasis{Neuron, 73}(3), 415\sphinxhyphen{}434.

\end{itemize}


\subsection{CNN Visualization \& Analysis}
\label{\detokenize{part1/ch04_perception_pipeline:cnn-visualization-analysis}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Zeiler, M. D., \& Fergus, R. (2014). Visualizing and understanding convolutional networks. \sphinxstyleemphasis{European conference on computer vision} (pp. 818\sphinxhyphen{}833).

\item {} 
\sphinxAtStartPar
Yamins, D. L., Hong, H., Cadieu, C. F., Solomon, E. A., Seibert, D., \& DiCarlo, J. J. (2014). Performance\sphinxhyphen{}optimized hierarchical models predict neural responses in higher visual cortex. \sphinxstyleemphasis{Proceedings of the National Academy of Sciences, 111}(23), 8619\sphinxhyphen{}8624.

\item {} 
\sphinxAtStartPar
Olah, C., Mordvintsev, A., \& Schubert, L. (2017). Feature visualization. \sphinxstyleemphasis{Distill, 2}(11), e7.

\end{itemize}


\subsection{Advanced Topics}
\label{\detokenize{part1/ch04_perception_pipeline:advanced-topics}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Kriegeskorte, N. (2015). Deep neural networks: a new framework for modeling biological vision and brain information processing. \sphinxstyleemphasis{Annual review of vision science, 1}, 417\sphinxhyphen{}446.

\item {} 
\sphinxAtStartPar
Kietzmann, T. C., McClure, P., \& Kriegeskorte, N. (2019). Deep neural networks in computational neuroscience. \sphinxstyleemphasis{Oxford Research Encyclopedia of Neuroscience}.

\item {} 
\sphinxAtStartPar
Kubilius, J., Schrimpf, M., Nayebi, A., Bear, D., Yamins, D. L., \& DiCarlo, J. J. (2018). CORnet: Modeling the neural mechanisms of core object recognition. \sphinxstyleemphasis{BioRxiv}, 408385.

\end{itemize}


\subsection{Books}
\label{\detokenize{part1/ch04_perception_pipeline:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Wandell, B. A. (1995). \sphinxstyleemphasis{Foundations of vision}. Sinauer Associates.

\item {} 
\sphinxAtStartPar
Palmer, S. E. (1999). \sphinxstyleemphasis{Vision science: Photons to phenomenology}. MIT press.

\item {} 
\sphinxAtStartPar
Goodfellow, I., Bengio, Y., \& Courville, A. (2016). \sphinxstyleemphasis{Deep learning}. MIT press.

\item {} 
\sphinxAtStartPar
DiCarlo, Zoccolan \& Rust (2012) \sphinxhyphen{} “How Does the Brain Solve Visual Object Recognition?”

\item {} 
\sphinxAtStartPar
Kriegeskorte (2015) \sphinxhyphen{} “Deep Neural Networks: A New Framework for Modeling Biological Vision”

\item {} 
\sphinxAtStartPar
Yamins \& DiCarlo (2016) \sphinxhyphen{} “Using goal\sphinxhyphen{}driven deep learning models to understand sensory cortex”

\end{itemize}


\bigskip\hrule\bigskip



\section{In\sphinxhyphen{}Depth Content}
\label{\detokenize{part1/ch04_perception_pipeline:in-depth-content}}
\sphinxAtStartPar
\sphinxincludegraphics{{cortical_column_vs_ann}.svg}


\subsection{The Human Visual System}
\label{\detokenize{part1/ch04_perception_pipeline:the-human-visual-system}}
\sphinxAtStartPar
The visual processing pipeline begins with the retina, where photoreceptors convert light into electrical signals. These signals pass through retinal ganglion cells, which perform the first stage of processing \sphinxhyphen{} edge detection and contrast enhancement through center\sphinxhyphen{}surround receptive fields. The signals then travel via the optic nerve to the lateral geniculate nucleus (LGN) of the thalamus, which acts as a relay station, before reaching the primary visual cortex (V1) in the occipital lobe.

\sphinxAtStartPar
In V1, neurons have small receptive fields that respond to oriented edges in specific parts of the visual field. As information flows to higher areas (V2, V4, IT cortex), neurons have progressively larger receptive fields and respond to more complex patterns \sphinxhyphen{} from corners and simple shapes to specific objects or faces. This hierarchical organization forms the basis for the layered architecture in artificial neural networks designed for visual processing.


\subsection{Receptive Fields and Hierarchies}
\label{\detokenize{part1/ch04_perception_pipeline:receptive-fields-and-hierarchies}}
\sphinxAtStartPar
A key discovery by Hubel and Wiesel in the 1960s was that neurons in the visual cortex act as feature detectors. Simple cells in V1 respond to oriented edges at specific locations, complex cells respond to oriented edges regardless of exact position, and hypercomplex cells (end\sphinxhyphen{}stopped cells) respond to edges of specific lengths or corners.

\sphinxAtStartPar
The receptive field of a visual neuron is the region of visual space that, when stimulated, affects the firing of that neuron. As visual information progresses through the cortical hierarchy, receptive fields become larger and encode more complex features:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
V1 neurons: Oriented edges, spatial frequency, color

\item {} 
\sphinxAtStartPar
V2 neurons: Contours, figure\sphinxhyphen{}ground separation

\item {} 
\sphinxAtStartPar
V4 neurons: Shape features, curvature

\item {} 
\sphinxAtStartPar
IT neurons: Complex objects, faces

\end{enumerate}

\sphinxAtStartPar
This progressive abstraction of visual features \sphinxhyphen{} from simple to complex \sphinxhyphen{} is the key insight that informed the development of convolutional neural networks.


\subsection{Convolutional Neural Networks}
\label{\detokenize{part1/ch04_perception_pipeline:convolutional-neural-networks}}
\sphinxAtStartPar
CNNs mirror the architecture of the visual cortex in several key ways:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Convolutional layers}: Like visual cortex neurons, CNN filters scan across the image and respond to specific patterns within their receptive field. Early layers detect simple features (edges, textures) while deeper layers combine these to detect complex objects.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local connectivity}: Rather than connecting to every input pixel (as in fully\sphinxhyphen{}connected networks), CNN neurons connect only to a small region, similar to the receptive fields in the visual system.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical processing}: CNNs stack multiple layers, progressively building more complex representations \sphinxhyphen{} from edges to textures to object parts to whole objects.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pooling operations}: These provide translation invariance by summarizing features across small spatial regions, similar to how complex cells in V1 respond to oriented edges regardless of their exact position.

\end{enumerate}

\sphinxAtStartPar
Individual CNN neurons, like cortical neurons, respond to inputs in a restricted region (their receptive field) and collectively form a retinotopic map of visual space.


\subsection{Examples of Biological Inspiration}
\label{\detokenize{part1/ch04_perception_pipeline:examples-of-biological-inspiration}}
\sphinxAtStartPar
Hubel and Wiesel’s discovery of edge\sphinxhyphen{}detecting cells in the cat visual cortex foreshadowed the edge\sphinxhyphen{}detecting filters learned by the first layer of CNNs. When visualized, the filters learned by the first convolutional layer of networks like AlexNet show striking similarity to the Gabor\sphinxhyphen{}like filters found in V1 neurons.


\subsection{Python/PyTorch Code Examples}
\label{\detokenize{part1/ch04_perception_pipeline:python-pytorch-code-examples}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{models}\PYG{p}{,} \PYG{n}{transforms}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{PIL}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Image}

\PYG{c+c1}{\PYGZsh{} Implementing Gabor filters \PYGZhy{} similar to V1 simple cell receptive fields}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{gabor\PYGZus{}filter}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{lambda\PYGZus{}val}\PYG{p}{,} \PYG{n}{theta}\PYG{p}{,} \PYG{n}{sigma}\PYG{p}{,} \PYG{n}{gamma}\PYG{p}{,} \PYG{n}{psi}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a Gabor filter (similar to V1 simple cell receptive fields)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    size (int): Size of the filter}
\PYG{l+s+sd}{    lambda\PYGZus{}val (float): Wavelength}
\PYG{l+s+sd}{    theta (float): Orientation in radians}
\PYG{l+s+sd}{    sigma (float): Standard deviation of the Gaussian envelope}
\PYG{l+s+sd}{    gamma (float): Spatial aspect ratio}
\PYG{l+s+sd}{    psi (float): Phase offset}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    np.array: Gabor filter kernel}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Rotation}
    \PYG{n}{x\PYGZus{}theta} \PYG{o}{=} \PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}theta} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{x} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{+} \PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Gabor function}
    \PYG{n}{gb} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{x\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{gamma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{y\PYGZus{}theta}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{sigma}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{x\PYGZus{}theta} \PYG{o}{/} \PYG{n}{lambda\PYGZus{}val} \PYG{o}{+} \PYG{n}{psi}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{gb}

\PYG{c+c1}{\PYGZsh{} Create and visualize a bank of Gabor filters with different orientations}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}gabor\PYGZus{}bank}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Parameters}
    \PYG{n}{size} \PYG{o}{=} \PYG{l+m+mi}{31}
    \PYG{n}{lambda\PYGZus{}val} \PYG{o}{=} \PYG{l+m+mf}{10.0}
    \PYG{n}{sigma} \PYG{o}{=} \PYG{l+m+mf}{5.0}
    \PYG{n}{gamma} \PYG{o}{=} \PYG{l+m+mf}{0.5}
    \PYG{n}{psi} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{c+c1}{\PYGZsh{} Create filters at different orientations}
    \PYG{n}{orientations} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{]}
    \PYG{n}{filters} \PYG{o}{=} \PYG{p}{[}\PYG{n}{gabor\PYGZus{}filter}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{lambda\PYGZus{}val}\PYG{p}{,} \PYG{n}{theta}\PYG{p}{,} \PYG{n}{sigma}\PYG{p}{,} \PYG{n}{gamma}\PYG{p}{,} \PYG{n}{psi}\PYG{p}{)} \PYG{k}{for} \PYG{n}{theta} \PYG{o+ow}{in} \PYG{n}{orientations}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Visualize}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes} \PYG{o}{=} \PYG{n}{axes}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{filt}\PYG{p}{,} \PYG{n}{theta}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{filters}\PYG{p}{,} \PYG{n}{orientations}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{filt}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Orientation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{theta}\PYG{o}{*}\PYG{l+m+mi}{180}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{l+s+si}{:}\PYG{l+s+s1}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{°}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{filters}

\PYG{c+c1}{\PYGZsh{} A simple CNN to demonstrate visual processing hierarchy}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleCNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleCNN}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} First conv layer \PYGZhy{} like V1 simple cells (edge detectors)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Second conv layer \PYGZhy{} like V2 (combining edges into shapes)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Third conv layer \PYGZhy{} like V4 (more complex shapes)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Final layer \PYGZhy{} like IT (object recognition)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64} \PYG{o}{*} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} For MNIST digits (10 classes)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Hierarchical feature extraction}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{F}\PYG{o}{.}\PYG{n}{max\PYGZus{}pool2d}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Conv + pooling (like complex cells)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{F}\PYG{o}{.}\PYG{n}{max\PYGZus{}pool2d}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Greater invariance}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{F}\PYG{o}{.}\PYG{n}{max\PYGZus{}pool2d}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Higher\PYGZhy{}level features}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{64} \PYG{o}{*} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{l+m+mi}{3}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Flatten}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Classification}
        \PYG{k}{return} \PYG{n}{x}

\PYG{c+c1}{\PYGZsh{} Function to visualize the activations at different layers \PYGZhy{} like recording from different visual areas}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}layer\PYGZus{}activations}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{image\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Load and preprocess image}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{Image}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}\PYG{o}{.}\PYG{n}{convert}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Convert to grayscale}
    \PYG{n}{transform} \PYG{o}{=} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Compose}\PYG{p}{(}\PYG{p}{[}
        \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Resize}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ToTensor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{p}{]}\PYG{p}{)}
    \PYG{n}{img\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{transform}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Add batch dimension}
    
    \PYG{c+c1}{\PYGZsh{} Hook to capture activations}
    \PYG{n}{activations} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{hook\PYGZus{}fn}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{hook}\PYG{p}{(}\PYG{n}{module}\PYG{p}{,} \PYG{n+nb}{input}\PYG{p}{,} \PYG{n}{output}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{activations}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{output}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{hook}
    
    \PYG{c+c1}{\PYGZsh{} Register hooks}
    \PYG{n}{hooks} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{hooks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{conv1}\PYG{o}{.}\PYG{n}{register\PYGZus{}forward\PYGZus{}hook}\PYG{p}{(}\PYG{n}{hook\PYGZus{}fn}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{hooks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{conv2}\PYG{o}{.}\PYG{n}{register\PYGZus{}forward\PYGZus{}hook}\PYG{p}{(}\PYG{n}{hook\PYGZus{}fn}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{hooks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{conv3}\PYG{o}{.}\PYG{n}{register\PYGZus{}forward\PYGZus{}hook}\PYG{p}{(}\PYG{n}{hook\PYGZus{}fn}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Forward pass}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{img\PYGZus{}tensor}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Remove hooks}
    \PYG{k}{for} \PYG{n}{hook} \PYG{o+ow}{in} \PYG{n}{hooks}\PYG{p}{:}
        \PYG{n}{hook}\PYG{o}{.}\PYG{n}{remove}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize activations from different layers}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} First layer (V1\PYGZhy{}like)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V1\PYGZhy{}like Filter }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Second layer (V2\PYGZhy{}like)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V2\PYGZhy{}like Filter }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Third layer (V4\PYGZhy{}like)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conv3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V4\PYGZhy{}like Filter }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Using a pre\PYGZhy{}trained model to visualize hierarchical features}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}pretrained\PYGZus{}features}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Load pre\PYGZhy{}trained VGG16 model}
    \PYG{n}{vgg} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{vgg16}\PYG{p}{(}\PYG{n}{pretrained}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print the model architecture to see the hierarchical organization}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{vgg}\PYG{o}{.}\PYG{n}{features}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot filters from the first convolutional layer (edge detectors like V1)}
    \PYG{n}{filters} \PYG{o}{=} \PYG{n}{vgg}\PYG{o}{.}\PYG{n}{features}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{weight}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize filter values to 0\PYGZhy{}1 range for display}
    \PYG{n}{filters} \PYG{o}{=} \PYG{p}{(}\PYG{n}{filters} \PYG{o}{\PYGZhy{}} \PYG{n}{filters}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{filters}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{filters}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot first 16 filters}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes} \PYG{o}{=} \PYG{n}{axes}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{filters}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Filter }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{c+c1}{\PYGZsh{} gabor\PYGZus{}bank = visualize\PYGZus{}gabor\PYGZus{}bank()}
\PYG{c+c1}{\PYGZsh{} model = SimpleCNN()}
\PYG{c+c1}{\PYGZsh{} visualize\PYGZus{}layer\PYGZus{}activations(model, \PYGZsq{}path\PYGZus{}to\PYGZus{}image.jpg\PYGZsq{})}
\PYG{c+c1}{\PYGZsh{} visualize\PYGZus{}pretrained\PYGZus{}features()}
\end{sphinxVerbatim}


\subsection{Suggested Readings}
\label{\detokenize{part1/ch04_perception_pipeline:suggested-readings}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hubel \& Wiesel (1962), “Receptive fields, binocular interaction and functional architecture in the cat’s visual cortex,” Journal of Physiology – Classic paper detailing edge\sphinxhyphen{}detecting neurons (historical context for CNN inspiration).

\item {} 
\sphinxAtStartPar
Fukushima (1980), “Neocognitron: A self\sphinxhyphen{}organizing neural network model for a mechanism of pattern recognition unaffected by shift in position,” Biol. Cybernetics – Early CNN\sphinxhyphen{}like model influenced by neuroscience.

\item {} 
\sphinxAtStartPar
Yamins \& DiCarlo (2016), “Using goal\sphinxhyphen{}driven deep learning models to understand sensory cortex,” Nature Neuroscience – Demonstrates that deep CNNs not only draw inspiration from the brain but can predict neural responses in the primate visual system, validating CNNs as models of vision.

\end{itemize}


\subsection{Supplementary Videos/Lectures}
\label{\detokenize{part1/ch04_perception_pipeline:supplementary-videos-lectures}}\begin{itemize}
\item {} 
\sphinxAtStartPar
TED\sphinxhyphen{}Ed: “How Your Eyes Make Sense of the World” – Visual explanation of the human visual processing pathway.

\item {} 
\sphinxAtStartPar
Stanford CS231n (Convolutional Neural Networks for Visual Recognition) – Lecture 1 – Introduction that connects biological vision to CNN design (includes historical notes on Hubel \& Wiesel).

\item {} 
\sphinxAtStartPar
“Do convolutional neural networks mimic the human visual system?” (MIT Quest for Intelligence seminar) – Discusses the parallels and differences between CNNs and actual brain networks for vision.

\end{itemize}

\sphinxstepscope


\part{Part II · Brains Meet Math \& Data}

\sphinxstepscope


\chapter{Chapter 5: Default\sphinxhyphen{}Mode vs Executive Control Networks}
\label{\detokenize{part2/ch05_brain_networks:chapter-5-default-mode-vs-executive-control-networks}}\label{\detokenize{part2/ch05_brain_networks::doc}}

\section{5.0 Chapter Goals}
\label{\detokenize{part2/ch05_brain_networks:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand large\sphinxhyphen{}scale brain networks and their functional significance

\item {} 
\sphinxAtStartPar
Contrast default\sphinxhyphen{}mode and executive control networks

\item {} 
\sphinxAtStartPar
Connect network dynamics to cognitive functions

\item {} 
\sphinxAtStartPar
Explore computational models of brain network interactions

\item {} 
\sphinxAtStartPar
Apply network analysis approaches to neural data

\item {} 
\sphinxAtStartPar
Draw parallels between brain network dynamics and artificial intelligence

\end{itemize}


\section{5.1 Network Neuroscience Fundamentals}
\label{\detokenize{part2/ch05_brain_networks:network-neuroscience-fundamentals}}

\subsection{From Local Circuits to Distributed Networks}
\label{\detokenize{part2/ch05_brain_networks:from-local-circuits-to-distributed-networks}}
\sphinxAtStartPar
The brain is not a collection of isolated regions but a highly integrated system of networks spanning different spatial scales. While individual neurons form local circuits through synaptic connections, these circuits in turn connect to form large\sphinxhyphen{}scale networks that coordinate activity across brain regions.

\sphinxAtStartPar
Network neuroscience has emerged as a framework to understand how these interconnected systems give rise to cognitive functions and behavior. Rather than focusing on the activity of individual regions, network approaches emphasize the patterns of communication between regions and how these interactions enable complex information processing.


\subsection{Methods for Studying Brain Networks}
\label{\detokenize{part2/ch05_brain_networks:methods-for-studying-brain-networks}}
\sphinxAtStartPar
Several complementary techniques allow us to observe brain networks in action:

\sphinxAtStartPar
\sphinxstylestrong{Functional MRI (fMRI)} measures blood\sphinxhyphen{}oxygen\sphinxhyphen{}level\sphinxhyphen{}dependent (BOLD) signals across the brain, providing an indirect measure of neural activity. While its temporal resolution is limited (typically 1\sphinxhyphen{}2 seconds), its spatial resolution allows researchers to map functional connections across the entire brain.

\sphinxAtStartPar
\sphinxstylestrong{Electroencephalography (EEG)} and \sphinxstylestrong{Magnetoencephalography (MEG)} detect electrical signals and magnetic fields generated by neuronal activity, respectively. They offer millisecond\sphinxhyphen{}level temporal precision but more limited spatial resolution compared to fMRI.

\sphinxAtStartPar
\sphinxstylestrong{Diffusion MRI} measures the diffusion of water molecules to map structural connections (white matter tracts) between brain regions, providing the physical substrate for network communication.


\subsection{Functional vs Structural Connectivity}
\label{\detokenize{part2/ch05_brain_networks:functional-vs-structural-connectivity}}
\sphinxAtStartPar
Brain networks can be characterized in two fundamental ways:

\sphinxAtStartPar
\sphinxstylestrong{Structural connectivity} refers to the physical connections (axonal pathways) linking different brain regions. These anatomical connections, especially long\sphinxhyphen{}range white matter tracts, form the physical infrastructure for information transfer.

\sphinxAtStartPar
\sphinxstylestrong{Functional connectivity} refers to the statistical dependencies between the activity patterns of different brain regions. Two regions with highly correlated activity are considered functionally connected, regardless of whether they share direct structural connections.

\sphinxAtStartPar
While structural connections constrain possible functional interactions, functional connectivity is dynamic and context\sphinxhyphen{}dependent, changing with cognitive demands and states of consciousness.


\subsection{Network Metrics and Their Interpretation}
\label{\detokenize{part2/ch05_brain_networks:network-metrics-and-their-interpretation}}
\sphinxAtStartPar
Graph theory provides mathematical tools to analyze brain networks, where brain regions are represented as nodes and their connections as edges:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Degree}: The number of connections a region has, indicating its connectivity importance

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Clustering coefficient}: The extent to which a region’s neighbors are connected to each other, reflecting local integration

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Path length}: The minimum number of steps needed to travel between two regions, indicating network efficiency

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Modularity}: The degree to which a network can be divided into distinct communities or modules

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Centrality measures}: Metrics that identify hub regions crucial for network communication

\end{itemize}

\sphinxAtStartPar
These metrics help characterize network organization and reveal principles of brain function, such as small\sphinxhyphen{}world architecture (high clustering with short path lengths) and rich\sphinxhyphen{}club organization (highly connected hubs that preferentially connect to each other).


\section{5.2 The Default Mode Network (DMN)}
\label{\detokenize{part2/ch05_brain_networks:the-default-mode-network-dmn}}

\subsection{Discovery and Components}
\label{\detokenize{part2/ch05_brain_networks:discovery-and-components}}
\sphinxAtStartPar
The default mode network (DMN) was discovered serendipitously in the late 1990s. Researchers noticed that certain brain regions consistently showed decreased activity during demanding tasks compared to rest, suggesting a “default mode” of brain function that is active when we are not engaged in explicit tasks.

\sphinxAtStartPar
The core regions of the DMN include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Medial prefrontal cortex (mPFC)}: Involved in self\sphinxhyphen{}referential processing and social cognition

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Posterior cingulate cortex (PCC)/precuneus}: Associated with autobiographical memory and self\sphinxhyphen{}awareness

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Angular gyri}: Integrative hubs involved in semantic processing and memory

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hippocampal formation}: Critical for memory encoding and retrieval

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Lateral temporal cortex}: Involved in conceptual processing and semantic memory

\end{itemize}

\sphinxAtStartPar
\sphinxincludegraphics{{brain_networks}.svg}

\sphinxAtStartPar
The DMN is often referred to as a “task\sphinxhyphen{}negative” network because its activity typically decreases during externally\sphinxhyphen{}directed tasks, though this terminology has been debated as our understanding of its functions has evolved.


\subsection{Self\sphinxhyphen{}Referential Processing}
\label{\detokenize{part2/ch05_brain_networks:self-referential-processing}}
\sphinxAtStartPar
One key function of the DMN is self\sphinxhyphen{}referential thinking \sphinxhyphen{} reflecting on our own thoughts, feelings, and experiences. The medial prefrontal cortex is particularly active when we think about ourselves, our traits, or our emotional states.

\sphinxAtStartPar
This introspective capacity may underlie metacognition, the ability to monitor and evaluate our own cognitive processes. Self\sphinxhyphen{}referential processing also supports social cognition, as we often understand others by referencing our own experiences and mental states.


\subsection{Mind\sphinxhyphen{}Wandering and Creativity}
\label{\detokenize{part2/ch05_brain_networks:mind-wandering-and-creativity}}
\sphinxAtStartPar
The DMN is highly active during mind\sphinxhyphen{}wandering, when our thoughts drift away from the immediate environment to internally generated content. This “stimulus\sphinxhyphen{}independent thought” occurs frequently in daily life \sphinxhyphen{} studies suggest people spend 30\sphinxhyphen{}50\% of their waking hours mind\sphinxhyphen{}wandering.

\sphinxAtStartPar
Rather than being purely wasteful, mind\sphinxhyphen{}wandering serves important functions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Autobiographical planning

\item {} 
\sphinxAtStartPar
Creative problem\sphinxhyphen{}solving

\item {} 
\sphinxAtStartPar
Maintaining a sense of personal identity

\item {} 
\sphinxAtStartPar
Simulating social interactions

\end{itemize}

\sphinxAtStartPar
DMN activity has been linked to creative cognition, particularly during the “incubation” phase when we step away from a problem. The network may facilitate the formation of novel associations between previously unconnected ideas, supporting moments of insight.


\subsection{Relation to Memory and Imagination}
\label{\detokenize{part2/ch05_brain_networks:relation-to-memory-and-imagination}}
\sphinxAtStartPar
The DMN plays a crucial role in both remembering the past and imagining the future. This “mental time travel” relies on the construction of scenes and episodes from stored knowledge, engaging similar neural machinery for both retrospection and prospection.

\sphinxAtStartPar
The hippocampus, which connects with core DMN regions, contributes to this process by retrieving and recombining memory elements into coherent representations. This explains why patients with hippocampal damage show deficits not only in recalling past events but also in imagining novel future scenarios.

\sphinxAtStartPar
The DMN’s role in imagination extends beyond temporal simulations to counterfactual thinking (considering “what might have been”) and creating fictional scenarios, highlighting its broader involvement in generative mental processes.


\section{5.3 Executive Control Networks}
\label{\detokenize{part2/ch05_brain_networks:executive-control-networks}}

\subsection{Frontoparietal Control Network}
\label{\detokenize{part2/ch05_brain_networks:frontoparietal-control-network}}
\sphinxAtStartPar
The frontoparietal control network (FPCN) is a set of regions primarily including:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dorsolateral prefrontal cortex (dlPFC)}: Critical for working memory and cognitive control

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Anterior cingulate cortex (ACC)}: Involved in performance monitoring and conflict detection

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Posterior parietal cortex}: Supporting attentional selection and goal\sphinxhyphen{}directed behavior

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Anterior insula}: Contributing to salience detection and network switching

\end{itemize}

\sphinxAtStartPar
This network activates during tasks requiring cognitive control, such as response inhibition, task switching, and working memory maintenance. It is sometimes called a “task\sphinxhyphen{}positive” network because its activity typically increases during externally\sphinxhyphen{}directed, goal\sphinxhyphen{}oriented tasks.

\sphinxAtStartPar
The FPCN is particularly engaged when tasks involve:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Maintaining and manipulating information in working memory

\item {} 
\sphinxAtStartPar
Implementing rule\sphinxhyphen{}based behaviors

\item {} 
\sphinxAtStartPar
Inhibiting prepotent responses

\item {} 
\sphinxAtStartPar
Flexibly shifting between task demands

\end{itemize}


\subsection{Salience Network}
\label{\detokenize{part2/ch05_brain_networks:salience-network}}
\sphinxAtStartPar
The salience network, anchored by the anterior insula and dorsal anterior cingulate cortex, plays a crucial role in detecting behaviorally relevant stimuli and coordinating network dynamics.

\sphinxAtStartPar
This network acts as a switch between the DMN and the frontoparietal control network, engaging appropriate resources based on current demands. When salient events are detected, the salience network helps transition from introspective processing to goal\sphinxhyphen{}directed executive control.

\sphinxAtStartPar
The anterior insula, in particular, is involved in interoception \sphinxhyphen{} awareness of internal bodily states \sphinxhyphen{} suggesting that physiological signals influence network dynamics and cognitive processing.


\subsection{Cognitive Control Functions}
\label{\detokenize{part2/ch05_brain_networks:cognitive-control-functions}}
\sphinxAtStartPar
Executive control networks support a range of cognitive control functions:

\sphinxAtStartPar
\sphinxstylestrong{Inhibitory control} allows us to suppress inappropriate responses and resist interference from distractors, critical for maintaining goal\sphinxhyphen{}directed behavior in the face of competing stimuli.

\sphinxAtStartPar
\sphinxstylestrong{Conflict monitoring}, primarily associated with the anterior cingulate cortex, detects when our automatic responses conflict with task goals, signaling the need for increased control.

\sphinxAtStartPar
\sphinxstylestrong{Task\sphinxhyphen{}set maintenance} keeps relevant rules and goals active to guide behavior, while \sphinxstylestrong{task\sphinxhyphen{}switching} enables flexible shifts between different cognitive operations based on changing demands.

\sphinxAtStartPar
These functions collectively enable adaptive behavior in complex environments, where goals must be maintained despite distractions, and strategies must be adjusted in response to changing circumstances.


\subsection{Working Memory and Attention}
\label{\detokenize{part2/ch05_brain_networks:working-memory-and-attention}}
\sphinxAtStartPar
Working memory—the ability to temporarily maintain and manipulate information—is a core function supported by executive networks, particularly the dorsolateral prefrontal cortex.

\sphinxAtStartPar
Models of working memory have evolved from static “storage buffers” to dynamic processes involving the selective maintenance of relevant information through sustained attention. The frontoparietal network implements this process by:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Selecting relevant information for processing

\item {} 
\sphinxAtStartPar
Maintaining representations through persistent neural activity

\item {} 
\sphinxAtStartPar
Protecting these representations from interference

\item {} 
\sphinxAtStartPar
Manipulating information according to task demands

\end{enumerate}

\sphinxAtStartPar
Attention, closely linked to working memory, involves selecting certain stimuli for enhanced processing while filtering out irrelevant information. Executive networks implement both top\sphinxhyphen{}down attentional control (based on goals and expectations) and bottom\sphinxhyphen{}up capture (based on stimulus salience).


\section{5.4 Network Interactions}
\label{\detokenize{part2/ch05_brain_networks:network-interactions}}

\subsection{Anti\sphinxhyphen{}Correlation and Competitive Dynamics}
\label{\detokenize{part2/ch05_brain_networks:anti-correlation-and-competitive-dynamics}}
\sphinxAtStartPar
One of the most striking findings in network neuroscience is the anti\sphinxhyphen{}correlated relationship between the default mode network and executive control networks. When one network increases in activity, the other typically decreases.

\sphinxAtStartPar
\sphinxincludegraphics{{network_dynamics}.svg}

\sphinxAtStartPar
This pattern, first observed in resting\sphinxhyphen{}state fMRI studies, suggests a competitive relationship between internal, self\sphinxhyphen{}generated cognition and external, task\sphinxhyphen{}focused attention. The anti\sphinxhyphen{}correlation is strongest during demanding cognitive tasks but persists even during rest.

\sphinxAtStartPar
The degree of segregation between these networks has functional significance—reduced anti\sphinxhyphen{}correlation has been observed in conditions including aging, ADHD, and schizophrenia, suggesting that appropriate network segregation supports optimal cognitive functioning.


\subsection{Task\sphinxhyphen{}Positive vs Task\sphinxhyphen{}Negative Networks}
\label{\detokenize{part2/ch05_brain_networks:task-positive-vs-task-negative-networks}}
\sphinxAtStartPar
The terms “task\sphinxhyphen{}positive” and “task\sphinxhyphen{}negative” emerged from early observations that executive networks increase activity during tasks while the DMN decreases. However, this dichotomy has been challenged by more nuanced findings:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
The DMN activates during certain types of tasks, particularly those involving social cognition, autobiographical memory, or semantic processing

\item {} 
\sphinxAtStartPar
Different portions of the DMN show distinct activation patterns during different cognitive states

\item {} 
\sphinxAtStartPar
The relationship between networks depends on task demands and individual differences

\end{enumerate}

\sphinxAtStartPar
Rather than strict opposition, these networks may represent complementary modes of cognition that are differentially engaged based on current demands and priorities.


\subsection{Dynamic Network Reconfiguration}
\label{\detokenize{part2/ch05_brain_networks:dynamic-network-reconfiguration}}
\sphinxAtStartPar
Brain networks are not static but undergo continuous reconfiguration in response to changing cognitive demands. This dynamic reorganization occurs across multiple timescales:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Rapid (millisecond to second) reconfiguration in response to immediate demands

\item {} 
\sphinxAtStartPar
Medium\sphinxhyphen{}term (minutes to hours) adjustments reflecting learning or fatigue

\item {} 
\sphinxAtStartPar
Long\sphinxhyphen{}term (days to years) changes corresponding to development or skill acquisition

\end{itemize}

\sphinxAtStartPar
Network reconfiguration involves changes in both the strength of connections and the patterns of interaction between networks. Periods of transition between cognitive states show unique network configurations, suggesting that the brain passes through specific “network states” as it shifts between different cognitive operations.

\sphinxAtStartPar
Modern approaches to studying these dynamics include sliding\sphinxhyphen{}window analyses, dynamic functional connectivity, and state\sphinxhyphen{}space models that capture moment\sphinxhyphen{}to\sphinxhyphen{}moment fluctuations in network organization.


\subsection{Balance and Dysregulation in Disorders}
\label{\detokenize{part2/ch05_brain_networks:balance-and-dysregulation-in-disorders}}
\sphinxAtStartPar
The appropriate balance between networks supports adaptive cognition, while dysregulation contributes to various neuropsychiatric conditions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Depression} often involves hyperactivity of the DMN, particularly in regions involved in rumination

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ADHD} is associated with reduced anti\sphinxhyphen{}correlation between DMN and executive networks, perhaps contributing to attentional lapses

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Schizophrenia} shows altered connectivity within and between networks, potentially underlying disrupted thought processes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Autism} features atypical connectivity patterns, particularly in networks supporting social cognition

\end{itemize}

\sphinxAtStartPar
These observations have led to reconceptualizing many disorders as “network pathologies” rather than dysfunction of isolated regions. This perspective helps explain why diverse symptoms often co\sphinxhyphen{}occur within disorders and why interventions that modulate network dynamics may have broad therapeutic effects.


\section{5.5 Computational Approaches}
\label{\detokenize{part2/ch05_brain_networks:computational-approaches}}

\subsection{Graph Theoretical Models}
\label{\detokenize{part2/ch05_brain_networks:graph-theoretical-models}}
\sphinxAtStartPar
Graph theory provides a powerful framework for modeling and analyzing brain networks. In this approach, brain regions are represented as nodes, and their functional or structural connections as edges.

\sphinxAtStartPar
Key graph\sphinxhyphen{}theoretical measures applied to brain networks include:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{networkx}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nx}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Create a simple brain network graph}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}brain\PYGZus{}network}\PYG{p}{(}\PYG{n}{num\PYGZus{}regions}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{connection\PYGZus{}density}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a simple brain network using random connections with community structure.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        num\PYGZus{}regions: Number of brain regions (nodes)}
\PYG{l+s+sd}{        connection\PYGZus{}density: Probability of connection between regions}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        G: NetworkX graph representing brain network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create random adjacency matrix with some structure}
    \PYG{c+c1}{\PYGZsh{} (DMN community and Executive community)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} For reproducibility}
    \PYG{n}{adj\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{num\PYGZus{}regions}\PYG{p}{,} \PYG{n}{num\PYGZus{}regions}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} DMN community (first half of nodes)}
    \PYG{n}{dmn\PYGZus{}size} \PYG{o}{=} \PYG{n}{num\PYGZus{}regions} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{connection\PYGZus{}density} \PYG{o}{*} \PYG{l+m+mf}{1.5}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Higher within\PYGZhy{}community density}
                \PYG{n}{weight} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{l+m+mf}{0.5}  \PYG{c+c1}{\PYGZsh{} Stronger weights (0.5\PYGZhy{}1.0)}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}  \PYG{c+c1}{\PYGZsh{} Symmetric}
    
    \PYG{c+c1}{\PYGZsh{} Executive community (second half of nodes)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}size}\PYG{p}{,} \PYG{n}{num\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{num\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{connection\PYGZus{}density} \PYG{o}{*} \PYG{l+m+mf}{1.5}\PYG{p}{:}
                \PYG{n}{weight} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{l+m+mf}{0.5}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
    
    \PYG{c+c1}{\PYGZsh{} Between\PYGZhy{}community connections (sparser)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}size}\PYG{p}{,} \PYG{n}{num\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{connection\PYGZus{}density} \PYG{o}{*} \PYG{l+m+mf}{0.5}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Lower between\PYGZhy{}community density}
                \PYG{n}{weight} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.3} \PYG{o}{+} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Weaker weights (0.1\PYGZhy{}0.4)}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
                \PYG{n}{adj\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
    
    \PYG{c+c1}{\PYGZsh{} Create graph from adjacency matrix}
    \PYG{n}{G} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{from\PYGZus{}numpy\PYGZus{}array}\PYG{p}{(}\PYG{n}{adj\PYGZus{}matrix}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add attributes to nodes}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{dmn\PYGZus{}size}\PYG{p}{:}
            \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}
    
    \PYG{k}{return} \PYG{n}{G}\PYG{p}{,} \PYG{n}{adj\PYGZus{}matrix}

\PYG{c+c1}{\PYGZsh{} Calculate common graph theory metrics}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}network\PYGZus{}metrics}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Calculate common graph theoretical metrics for the brain network.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        G: NetworkX graph representing brain network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        metrics: Dictionary of network metrics}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{metrics} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Node\PYGZhy{}level metrics}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{degree}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{nx}\PYG{o}{.}\PYG{n}{degree}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{clustering}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{betweenness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{betweenness\PYGZus{}centrality}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Network\PYGZhy{}level metrics}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{avg\PYGZus{}path\PYGZus{}length}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{average\PYGZus{}shortest\PYGZus{}path\PYGZus{}length}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{global\PYGZus{}efficiency}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{global\PYGZus{}efficiency}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{modularity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{community}\PYG{o}{.}\PYG{n}{modularity}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} 
                                                  \PYG{p}{[}\PYG{p}{\PYGZob{}}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{d} \PYG{o+ow}{in} \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} 
                                                    \PYG{k}{if} \PYG{n}{d}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                                                   \PYG{p}{\PYGZob{}}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{d} \PYG{o+ow}{in} \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} 
                                                    \PYG{k}{if} \PYG{n}{d}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Small\PYGZhy{}worldness (approximation)}
    \PYG{c+c1}{\PYGZsh{} Compare clustering and path length to random graph}
    \PYG{n}{G\PYGZus{}rand} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{random\PYGZus{}reference}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{niter}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{C\PYGZus{}rand} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{average\PYGZus{}clustering}\PYG{p}{(}\PYG{n}{G\PYGZus{}rand}\PYG{p}{)}
    \PYG{n}{L\PYGZus{}rand} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{average\PYGZus{}shortest\PYGZus{}path\PYGZus{}length}\PYG{p}{(}\PYG{n}{G\PYGZus{}rand}\PYG{p}{)}
    
    \PYG{n}{C} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{average\PYGZus{}clustering}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    \PYG{n}{L} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{average\PYGZus{}shortest\PYGZus{}path\PYGZus{}length}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    
    \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{small\PYGZus{}worldness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{C}\PYG{o}{/}\PYG{n}{C\PYGZus{}rand}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{L}\PYG{o}{/}\PYG{n}{L\PYGZus{}rand}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{metrics}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{c+c1}{\PYGZsh{} G, adj\PYGZus{}matrix = create\PYGZus{}brain\PYGZus{}network(num\PYGZus{}regions=20)}
\PYG{c+c1}{\PYGZsh{} metrics = calculate\PYGZus{}network\PYGZus{}metrics(G)}
\end{sphinxVerbatim}

\sphinxAtStartPar
These metrics capture important organizational principles:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Small\sphinxhyphen{}world architecture}: Brain networks show high clustering (efficient local processing) combined with short path lengths (efficient global communication)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Modularity}: Networks organize into communities with dense within\sphinxhyphen{}module connections and sparser between\sphinxhyphen{}module connections

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hub organization}: Certain regions act as highly connected hubs that facilitate communication between modules

\end{enumerate}

\sphinxAtStartPar
These properties support the efficient integration of information while maintaining specialized processing, balancing segregation and integration.


\subsection{Dynamic Causal Modeling}
\label{\detokenize{part2/ch05_brain_networks:dynamic-causal-modeling}}
\sphinxAtStartPar
Dynamic Causal Modeling (DCM) provides a framework for inferring causal interactions between brain regions based on their observed activity. Unlike functional connectivity, which only captures statistical dependencies, DCM attempts to model the directional influence of one region on another.

\sphinxAtStartPar
DCM combines a neural model (describing how neural populations interact) with a hemodynamic model (describing how neural activity translates to measured signals like BOLD responses). This allows researchers to test hypotheses about the directionality and strength of connections.

\sphinxAtStartPar
For example, DCM can help determine whether activity in the salience network causally influences the switching between default mode and executive networks, or whether these dynamics emerge from other processes.

\sphinxAtStartPar
The approach involves:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Defining a set of candidate models with different connection architectures

\item {} 
\sphinxAtStartPar
Estimating parameters for each model based on observed data

\item {} 
\sphinxAtStartPar
Comparing models to determine which best explains the observed dynamics

\end{enumerate}


\subsection{Neural Mass Models}
\label{\detokenize{part2/ch05_brain_networks:neural-mass-models}}
\sphinxAtStartPar
Neural mass models aim to capture the collective behavior of large neural populations, bridging the gap between single\sphinxhyphen{}neuron dynamics and whole\sphinxhyphen{}brain networks.

\sphinxAtStartPar
These models typically represent each brain region as a dynamical system characterized by a few state variables (such as mean membrane potential and firing rate). Regions are coupled through excitatory and inhibitory connections to form networks.

\sphinxAtStartPar
A simple neural mass model for coupled brain regions might be described by equations like:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}mass\PYGZus{}model}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A simplified neural mass model for two coupled brain regions }
\PYG{l+s+sd}{    (DMN and Executive Network)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        t: Time point}
\PYG{l+s+sd}{        state: Current state variables [E1, I1, E2, I2]}
\PYG{l+s+sd}{               E1, I1: Excitatory and inhibitory populations in region 1 (DMN)}
\PYG{l+s+sd}{               E2, I2: Excitatory and inhibitory populations in region 2 (Executive)}
\PYG{l+s+sd}{        params: Dictionary of parameters}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        derivatives: Rate of change for each state variable}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{E1}\PYG{p}{,} \PYG{n}{I1}\PYG{p}{,} \PYG{n}{E2}\PYG{p}{,} \PYG{n}{I2} \PYG{o}{=} \PYG{n}{state}
    
    \PYG{c+c1}{\PYGZsh{} Extract parameters}
    \PYG{n}{tau\PYGZus{}e} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tau\PYGZus{}e}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Time constant for excitatory populations}
    \PYG{n}{tau\PYGZus{}i} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tau\PYGZus{}i}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Time constant for inhibitory populations}
    \PYG{n}{w\PYGZus{}ee} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}ee}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Excitatory to excitatory weight (within\PYGZhy{}region)}
    \PYG{n}{w\PYGZus{}ei} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}ei}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Excitatory to inhibitory weight (within\PYGZhy{}region)}
    \PYG{n}{w\PYGZus{}ie} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}ie}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Inhibitory to excitatory weight (within\PYGZhy{}region)}
    \PYG{n}{w\PYGZus{}ii} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}ii}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Inhibitory to inhibitory weight (within\PYGZhy{}region)}
    \PYG{n}{w\PYGZus{}12} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}12}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Connection weight from region 1 to 2 (negative for anti\PYGZhy{}correlation)}
    \PYG{n}{w\PYGZus{}21} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}21}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}    \PYG{c+c1}{\PYGZsh{} Connection weight from region 2 to 1 (negative for anti\PYGZhy{}correlation)}
    \PYG{n}{I\PYGZus{}ext1} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}ext1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} External input to region 1}
    \PYG{n}{I\PYGZus{}ext2} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}ext2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} External input to region 2}
    
    \PYG{c+c1}{\PYGZsh{} Sigmoid activation function}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute derivatives}
    \PYG{n}{dE1} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{tau\PYGZus{}e}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{E1} \PYG{o}{+} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{w\PYGZus{}ee}\PYG{o}{*}\PYG{n}{E1} \PYG{o}{\PYGZhy{}} \PYG{n}{w\PYGZus{}ie}\PYG{o}{*}\PYG{n}{I1} \PYG{o}{+} \PYG{n}{w\PYGZus{}21}\PYG{o}{*}\PYG{n}{E2} \PYG{o}{+} \PYG{n}{I\PYGZus{}ext1}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{dI1} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{tau\PYGZus{}i}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{I1} \PYG{o}{+} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{w\PYGZus{}ei}\PYG{o}{*}\PYG{n}{E1} \PYG{o}{\PYGZhy{}} \PYG{n}{w\PYGZus{}ii}\PYG{o}{*}\PYG{n}{I1}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{dE2} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{tau\PYGZus{}e}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{E2} \PYG{o}{+} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{w\PYGZus{}ee}\PYG{o}{*}\PYG{n}{E2} \PYG{o}{\PYGZhy{}} \PYG{n}{w\PYGZus{}ie}\PYG{o}{*}\PYG{n}{I2} \PYG{o}{+} \PYG{n}{w\PYGZus{}12}\PYG{o}{*}\PYG{n}{E1} \PYG{o}{+} \PYG{n}{I\PYGZus{}ext2}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{dI2} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{tau\PYGZus{}i}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{I2} \PYG{o}{+} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{w\PYGZus{}ei}\PYG{o}{*}\PYG{n}{E2} \PYG{o}{\PYGZhy{}} \PYG{n}{w\PYGZus{}ii}\PYG{o}{*}\PYG{n}{I2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{[}\PYG{n}{dE1}\PYG{p}{,} \PYG{n}{dI1}\PYG{p}{,} \PYG{n}{dE2}\PYG{p}{,} \PYG{n}{dI2}\PYG{p}{]}
\end{sphinxVerbatim}

\sphinxAtStartPar
These models can reproduce key features of brain dynamics, including:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Oscillatory behavior at different frequencies

\item {} 
\sphinxAtStartPar
Phase synchronization between regions

\item {} 
\sphinxAtStartPar
State transitions in response to parameter changes

\item {} 
\sphinxAtStartPar
Complex spatiotemporal patterns of activity

\end{itemize}

\sphinxAtStartPar
By adjusting connection strengths and other parameters, researchers can explore how network architecture influences dynamics and test hypotheses about mechanisms underlying observed phenomena.


\subsection{Links to Reservoir Computing}
\label{\detokenize{part2/ch05_brain_networks:links-to-reservoir-computing}}
\sphinxAtStartPar
The brain’s recurrent network architecture has inspired artificial neural network approaches like reservoir computing. Reservoir computing systems consist of:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
A large, randomly connected recurrent neural network (the “reservoir”)

\item {} 
\sphinxAtStartPar
Input connections that feed signals into the reservoir

\item {} 
\sphinxAtStartPar
Output connections that read out from the reservoir’s activity

\end{enumerate}

\sphinxAtStartPar
The key insight is that complex, dynamic reservoirs can transform inputs into high\sphinxhyphen{}dimensional representations that make classification or prediction tasks easier to solve. The reservoir itself remains fixed (untrained), while only the output connections are adjusted through learning.

\sphinxAtStartPar
This approach bears interesting parallels to brain network dynamics:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The intrinsic activity of brain networks provides a complex, high\sphinxhyphen{}dimensional state space

\item {} 
\sphinxAtStartPar
Different cognitive tasks may utilize different readouts from this ongoing activity

\item {} 
\sphinxAtStartPar
The anti\sphinxhyphen{}correlation between default mode and executive networks might represent different operating regimes within this dynamical system

\end{itemize}

\sphinxAtStartPar
Echo State Networks and Liquid State Machines are two common implementations of reservoir computing that have been used to model aspects of brain function, including working memory, sequence learning, and temporal integration.


\section{5.6 Code Lab}
\label{\detokenize{part2/ch05_brain_networks:code-lab}}

\subsection{Network Analysis of Brain Connectivity Data}
\label{\detokenize{part2/ch05_brain_networks:network-analysis-of-brain-connectivity-data}}
\sphinxAtStartPar
Let’s explore how to analyze brain connectivity data using Python. We’ll simulate a dataset representing functional connectivity between brain regions and apply network analysis techniques:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{networkx}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nx}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}

\PYG{c+c1}{\PYGZsh{} Create simulated connectivity matrix for 10 brain regions}
\PYG{c+c1}{\PYGZsh{} (5 DMN regions, 5 Executive regions)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}connectivity\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{seed}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Generate a simulated functional connectivity matrix between brain regions}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        conn\PYGZus{}matrix: Connectivity matrix (correlation values)}
\PYG{l+s+sd}{        region\PYGZus{}names: List of region names}
\PYG{l+s+sd}{        network\PYGZus{}labels: Network assignment for each region}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{n}{seed}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define regions}
    \PYG{n}{dmn\PYGZus{}regions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mPFC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Precuneus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{AngularL}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{AngularR}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{exec\PYGZus{}regions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dlPFC\PYGZus{}L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dlPFC\PYGZus{}R}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{IPS\PYGZus{}L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{IPS\PYGZus{}R}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ACC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{region\PYGZus{}names} \PYG{o}{=} \PYG{n}{dmn\PYGZus{}regions} \PYG{o}{+} \PYG{n}{exec\PYGZus{}regions}
    \PYG{n}{network\PYGZus{}labels} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mi}{5} \PYG{o}{+} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mi}{5}
    
    \PYG{n}{n\PYGZus{}regions} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Start with random correlation matrix}
    \PYG{n}{random\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{,} \PYG{n}{n\PYGZus{}regions}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.3}
    \PYG{n}{conn\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{random\PYGZus{}matrix} \PYG{o}{+} \PYG{n}{random\PYGZus{}matrix}\PYG{o}{.}\PYG{n}{T}  \PYG{c+c1}{\PYGZsh{} Make it symmetric}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{fill\PYGZus{}diagonal}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Diagonal is 1 (self\PYGZhy{}correlation)}
    
    \PYG{c+c1}{\PYGZsh{} Set high within\PYGZhy{}network connectivity}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{j}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} High DMN internal connectivity}
                \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.6} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.3}
                
                \PYG{c+c1}{\PYGZsh{} High Executive internal connectivity}
                \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.3}
    
    \PYG{c+c1}{\PYGZsh{} Set negative between\PYGZhy{}network connectivity (anti\PYGZhy{}correlation)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.4}
            \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Ensure symmetry}
    
    \PYG{c+c1}{\PYGZsh{} Ensure values are in [\PYGZhy{}1, 1] range}
    \PYG{n}{conn\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{network\PYGZus{}labels}

\PYG{c+c1}{\PYGZsh{} Plot connectivity matrix as a heatmap}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}connectivity\PYGZus{}heatmap}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{network\PYGZus{}labels}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize connectivity matrix as a heatmap with network boundaries}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a mask for the upper triangle (redundant in symmetric matrix)}
    \PYG{n}{mask} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{triu}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set up custom colormap with white center}
    \PYG{n}{cmap} \PYG{o}{=} \PYG{n}{sns}\PYG{o}{.}\PYG{n}{diverging\PYGZus{}palette}\PYG{p}{(}\PYG{l+m+mi}{230}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{as\PYGZus{}cmap}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot heatmap}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{sns}\PYG{o}{.}\PYG{n}{heatmap}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{n}{mask}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} 
                \PYG{n}{vmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                \PYG{n}{square}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidths}\PYG{o}{=}\PYG{l+m+mf}{.5}\PYG{p}{,} 
                \PYG{n}{xticklabels}\PYG{o}{=}\PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{yticklabels}\PYG{o}{=}\PYG{n}{region\PYGZus{}names}\PYG{p}{,}
                \PYG{n}{cbar\PYGZus{}kws}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shrink}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{.5}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add network boundary lines}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add network labels}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{7.5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{7.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Functional Connectivity Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate and visualize network metrics}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}brain\PYGZus{}network}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{network\PYGZus{}labels}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Convert connectivity matrix to a graph and analyze network properties}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        conn\PYGZus{}matrix: Connectivity matrix}
\PYG{l+s+sd}{        region\PYGZus{}names: Names of brain regions}
\PYG{l+s+sd}{        network\PYGZus{}labels: Network assignment for each region}
\PYG{l+s+sd}{        threshold: Threshold for including connections}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create weighted graph from absolute connectivity values}
    \PYG{c+c1}{\PYGZsh{} (direction of correlation doesn\PYGZsq{}t affect network measures)}
    \PYG{n}{adj\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{threshold}\PYG{p}{)}
    \PYG{n}{G} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{from\PYGZus{}numpy\PYGZus{}array}\PYG{p}{(}\PYG{n}{adj\PYGZus{}matrix}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add node attributes}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{network}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{network\PYGZus{}labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{name}
        \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{network}
    
    \PYG{c+c1}{\PYGZsh{} Calculate network metrics}
    \PYG{n}{degree} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{nx}\PYG{o}{.}\PYG{n}{degree}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{clustering} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{clustering}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{betweenness} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{betweenness\PYGZus{}centrality}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{normalized}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compile results}
    \PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Region}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{region\PYGZus{}names}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{network\PYGZus{}labels}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Degree}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{n}{degree}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{n}{clustering}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Betweenness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{n}{betweenness}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate community structure}
    \PYG{n}{communities} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{community}\PYG{o}{.}\PYG{n}{greedy\PYGZus{}modularity\PYGZus{}communities}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Detected communities:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{comm} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{communities}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Community }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{p}{[}\PYG{n}{region\PYGZus{}names}\PYG{p}{[}\PYG{n}{node}\PYG{p}{]}\PYG{+w}{ }\PYG{k}{for}\PYG{+w}{ }\PYG{n}{node}\PYG{+w}{ }\PYG{o+ow}{in}\PYG{+w}{ }\PYG{n}{comm}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the network}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define positions (circular layout with DMN and Executive separated)}
    \PYG{n}{pos} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{dmn\PYGZus{}indices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{network\PYGZus{}labels}\PYG{p}{)} \PYG{k}{if} \PYG{n}{label} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{exec\PYGZus{}indices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{network\PYGZus{}labels}\PYG{p}{)} \PYG{k}{if} \PYG{n}{label} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} DMN nodes on the left}
    \PYG{n}{angles} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}indices}\PYG{p}{)}\PYG{p}{,} \PYG{n}{endpoint}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{radius} \PYG{o}{=} \PYG{l+m+mi}{5}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}indices}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{pos}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angles}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angles}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Executive nodes on the right}
    \PYG{n}{angles} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{exec\PYGZus{}indices}\PYG{p}{)}\PYG{p}{,} \PYG{n}{endpoint}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{exec\PYGZus{}indices}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{pos}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angles}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angles}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Node colors by network}
    \PYG{n}{node\PYGZus{}colors} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{skyblue}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{label} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{salmon}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{for} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n}{network\PYGZus{}labels}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Node sizes by betweenness centrality}
    \PYG{n}{node\PYGZus{}sizes} \PYG{o}{=} \PYG{p}{[}\PYG{n}{betweenness}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{3000} \PYG{o}{+} \PYG{l+m+mi}{500} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Edge weights for width}
    \PYG{n}{edge\PYGZus{}weights} \PYG{o}{=} \PYG{p}{[}\PYG{n}{G}\PYG{p}{[}\PYG{n}{u}\PYG{p}{]}\PYG{p}{[}\PYG{n}{v}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{3} \PYG{k}{for} \PYG{n}{u}\PYG{p}{,} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{G}\PYG{o}{.}\PYG{n}{edges}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Draw the graph}
    \PYG{n}{nx}\PYG{o}{.}\PYG{n}{draw\PYGZus{}networkx}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{pos}\PYG{o}{=}\PYG{n}{pos}\PYG{p}{,} 
                    \PYG{n}{node\PYGZus{}color}\PYG{o}{=}\PYG{n}{node\PYGZus{}colors}\PYG{p}{,} 
                    \PYG{n}{node\PYGZus{}size}\PYG{o}{=}\PYG{n}{node\PYGZus{}sizes}\PYG{p}{,}
                    \PYG{n}{width}\PYG{o}{=}\PYG{n}{edge\PYGZus{}weights}\PYG{p}{,}
                    \PYG{n}{with\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
                    \PYG{n}{labels}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{n}{i}\PYG{p}{:} \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{G}\PYG{o}{.}\PYG{n}{nodes}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                    \PYG{n}{font\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
                    \PYG{n}{font\PYGZus{}weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                    \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brain Network Graph}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot metrics by network}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{metrics} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Degree}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Betweenness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{metric} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{metrics}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{sns}\PYG{o}{.}\PYG{n}{boxplot}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{n}{metric}\PYG{p}{,} \PYG{n}{data}\PYG{o}{=}\PYG{n}{df}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axs}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{metric}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ by Network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{df}\PYG{p}{,} \PYG{n}{G}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{c+c1}{\PYGZsh{} conn\PYGZus{}matrix, region\PYGZus{}names, network\PYGZus{}labels = generate\PYGZus{}connectivity\PYGZus{}matrix()}
\PYG{c+c1}{\PYGZsh{} plot\PYGZus{}connectivity\PYGZus{}heatmap(conn\PYGZus{}matrix, region\PYGZus{}names, network\PYGZus{}labels)}
\PYG{c+c1}{\PYGZsh{} metrics\PYGZus{}df, G = analyze\PYGZus{}brain\PYGZus{}network(conn\PYGZus{}matrix, region\PYGZus{}names, network\PYGZus{}labels)}
\end{sphinxVerbatim}


\subsection{Simulating Coupled Oscillator Networks}
\label{\detokenize{part2/ch05_brain_networks:simulating-coupled-oscillator-networks}}
\sphinxAtStartPar
Brain networks can be modeled as systems of coupled oscillators, where each oscillator represents a brain region with its own intrinsic frequency. The following code simulates this type of system to explore how coupling affects network dynamics:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{integrate}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{solve\PYGZus{}ivp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{animation}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{animation}

\PYG{c+c1}{\PYGZsh{} Kuramoto model of coupled oscillators}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{kuramoto\PYGZus{}model}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{phases}\PYG{p}{,} \PYG{n}{omega}\PYG{p}{,} \PYG{n}{K}\PYG{p}{,} \PYG{n}{A}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Kuramoto model of coupled oscillators}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        t: Time point}
\PYG{l+s+sd}{        phases: Current phase of each oscillator (in radians)}
\PYG{l+s+sd}{        omega: Natural frequencies of oscillators}
\PYG{l+s+sd}{        K: Coupling strength}
\PYG{l+s+sd}{        A: Adjacency matrix defining connections}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        dphases: Rate of change of phases}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{phases}\PYG{p}{)}
    \PYG{n}{dphases} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{dphases}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{omega}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Natural frequency}
        
        \PYG{c+c1}{\PYGZsh{} Add coupling terms}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{dphases}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{K} \PYG{o}{*} \PYG{n}{A}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{phases}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{phases}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            
    \PYG{k}{return} \PYG{n}{dphases}

\PYG{c+c1}{\PYGZsh{} Simulating network dynamics with Kuramoto model}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}brain\PYGZus{}oscillators}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{region\PYGZus{}names}\PYG{p}{,} \PYG{n}{network\PYGZus{}labels}\PYG{p}{,} 
                               \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{K}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate brain regions as coupled oscillators using the Kuramoto model}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        conn\PYGZus{}matrix: Connectivity matrix}
\PYG{l+s+sd}{        region\PYGZus{}names: Names of brain regions}
\PYG{l+s+sd}{        network\PYGZus{}labels: Network assignment for each region}
\PYG{l+s+sd}{        duration: Simulation duration (seconds)}
\PYG{l+s+sd}{        dt: Time step}
\PYG{l+s+sd}{        K: Coupling strength}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        t: Time points}
\PYG{l+s+sd}{        phases: Phases of oscillators over time}
\PYG{l+s+sd}{        order\PYGZus{}param: Order parameter (synchronization measure) over time}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}regions} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{region\PYGZus{}names}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set natural frequencies \PYGZhy{} different frequency bands for DMN and Executive}
    \PYG{c+c1}{\PYGZsh{} DMN regions: slower oscillations (alpha/theta range)}
    \PYG{c+c1}{\PYGZsh{} Executive regions: faster oscillations (beta range)}
    \PYG{n}{omega} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{network\PYGZus{}labels}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{omega}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{8} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{4}  \PYG{c+c1}{\PYGZsh{} 8\PYGZhy{}12 Hz (alpha)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{omega}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{15} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} 15\PYGZhy{}25 Hz (beta)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize by 2π for phase calculations}
    \PYG{n}{omega} \PYG{o}{=} \PYG{n}{omega} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}
    
    \PYG{c+c1}{\PYGZsh{} Use absolute connectivity values for coupling (negative correlations still couple)}
    \PYG{n}{A} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{conn\PYGZus{}matrix}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initial phases (random)}
    \PYG{n}{phases\PYGZus{}0} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}
    
    \PYG{c+c1}{\PYGZsh{} Time points}
    \PYG{n}{t\PYGZus{}span} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{)}
    \PYG{n}{t\PYGZus{}eval} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Solve the differential equations}
    \PYG{n}{sol} \PYG{o}{=} \PYG{n}{solve\PYGZus{}ivp}\PYG{p}{(}
        \PYG{k}{lambda} \PYG{n}{t}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:} \PYG{n}{kuramoto\PYGZus{}model}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{omega}\PYG{p}{,} \PYG{n}{K}\PYG{p}{,} \PYG{n}{A}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{t\PYGZus{}span}\PYG{p}{,}
        \PYG{n}{phases\PYGZus{}0}\PYG{p}{,}
        \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RK45}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{n}{t\PYGZus{}eval}\PYG{o}{=}\PYG{n}{t\PYGZus{}eval}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate order parameter (measure of synchronization)}
    \PYG{c+c1}{\PYGZsh{} r = 1 means perfect synchronization, r = 0 means no synchronization}
    \PYG{n}{phases} \PYG{o}{=} \PYG{n}{sol}\PYG{o}{.}\PYG{n}{y}
    \PYG{n}{order\PYGZus{}param} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t\PYGZus{}eval}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{dmn\PYGZus{}order} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t\PYGZus{}eval}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}order} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t\PYGZus{}eval}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{dmn\PYGZus{}indices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{network\PYGZus{}labels}\PYG{p}{)} \PYG{k}{if} \PYG{n}{label} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{exec\PYGZus{}indices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{network\PYGZus{}labels}\PYG{p}{)} \PYG{k}{if} \PYG{n}{label} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t\PYGZus{}eval}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Global synchronization}
        \PYG{n}{r} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{n}{j} \PYG{o}{*} \PYG{n}{phases}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{n\PYGZus{}regions}\PYG{p}{)}
        \PYG{n}{order\PYGZus{}param}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{r}
        
        \PYG{c+c1}{\PYGZsh{} DMN synchronization}
        \PYG{n}{r\PYGZus{}dmn} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{n}{j} \PYG{o}{*} \PYG{n}{phases}\PYG{p}{[}\PYG{n}{dmn\PYGZus{}indices}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}indices}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{dmn\PYGZus{}order}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{r\PYGZus{}dmn}
        
        \PYG{c+c1}{\PYGZsh{} Executive synchronization}
        \PYG{n}{r\PYGZus{}exec} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{n}{j} \PYG{o}{*} \PYG{n}{phases}\PYG{p}{[}\PYG{n}{exec\PYGZus{}indices}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{exec\PYGZus{}indices}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{exec\PYGZus{}order}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{r\PYGZus{}exec}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot individual phases}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{211}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{network\PYGZus{}labels}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unwrap}\PYG{p}{(}\PYG{n}{phases}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}nolegend\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unwrap}\PYG{p}{(}\PYG{n}{phases}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}nolegend\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add legend entries (only once)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Phase / 2π}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Oscillator Phases}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot order parameters}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{212}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{order\PYGZus{}param}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Global}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}order}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{exec\PYGZus{}order}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Order Parameter}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Synchronization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{sol}\PYG{o}{.}\PYG{n}{t}\PYG{p}{,} \PYG{n}{phases}\PYG{p}{,} \PYG{n}{order\PYGZus{}param}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}order}\PYG{p}{,} \PYG{n}{exec\PYGZus{}order}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{c+c1}{\PYGZsh{} conn\PYGZus{}matrix, region\PYGZus{}names, network\PYGZus{}labels = generate\PYGZus{}connectivity\PYGZus{}matrix()}
\PYG{c+c1}{\PYGZsh{} t, phases, order\PYGZus{}param, dmn\PYGZus{}order, exec\PYGZus{}order = simulate\PYGZus{}brain\PYGZus{}oscillators(conn\PYGZus{}matrix, region\PYGZus{}names, network\PYGZus{}labels)}
\end{sphinxVerbatim}


\subsection{Visualizing Network Dynamics}
\label{\detokenize{part2/ch05_brain_networks:visualizing-network-dynamics}}
\sphinxAtStartPar
Let’s simulate how external tasks or stimulation might affect the balance between DMN and executive networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{c+c1}{\PYGZsh{} Simulate a simple brain network model with DMN and Executive Network dynamics}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}brain\PYGZus{}networks}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{600}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{task\PYGZus{}timing}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate time series data from DMN and Executive Network with anti\PYGZhy{}correlation}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    duration: simulation length in seconds}
\PYG{l+s+sd}{    sampling\PYGZus{}rate: Hz}
\PYG{l+s+sd}{    noise\PYGZus{}level: amount of random fluctuation}
\PYG{l+s+sd}{    task\PYGZus{}timing: list of tuples (start\PYGZus{}time, end\PYGZus{}time) for task periods}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    time: time points}
\PYG{l+s+sd}{    dmn\PYGZus{}activity: simulated DMN time series}
\PYG{l+s+sd}{    exec\PYGZus{}activity: simulated executive network time series}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create time axis}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Base oscillations (slow intrinsic fluctuations \PYGZti{}0.1 Hz)}
    \PYG{n}{freq\PYGZus{}dmn} \PYG{o}{=} \PYG{l+m+mf}{0.05}  \PYG{c+c1}{\PYGZsh{} DMN fluctuation frequency}
    \PYG{n}{freq\PYGZus{}exec} \PYG{o}{=} \PYG{l+m+mf}{0.03}  \PYG{c+c1}{\PYGZsh{} Exec network fluctuation frequency}
    
    \PYG{c+c1}{\PYGZsh{} Generate intrinsic oscillations}
    \PYG{n}{dmn\PYGZus{}activity} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{freq\PYGZus{}dmn} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}activity} \PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{freq\PYGZus{}exec} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add random noise}
    \PYG{n}{dmn\PYGZus{}activity} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}activity} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add anti\PYGZhy{}correlation factor (when one goes up, the other tends to go down)}
    \PYG{n}{anticorr\PYGZus{}factor} \PYG{o}{=} \PYG{l+m+mf}{0.4}
    \PYG{n}{dmn\PYGZus{}activity} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{anticorr\PYGZus{}factor} \PYG{o}{*} \PYG{n}{exec\PYGZus{}activity}
    \PYG{n}{exec\PYGZus{}activity} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{anticorr\PYGZus{}factor} \PYG{o}{*} \PYG{n}{dmn\PYGZus{}activity}
    
    \PYG{c+c1}{\PYGZsh{} Simulate task engagement (executive network up, DMN down)}
    \PYG{k}{if} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{start}\PYG{p}{,} \PYG{n}{end} \PYG{o+ow}{in} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
            \PYG{n}{start\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{start} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
            \PYG{n}{end\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{end} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} During task: boost executive network and suppress DMN}
            \PYG{n}{task\PYGZus{}mask} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}mask}\PYG{p}{[}\PYG{n}{start\PYGZus{}idx}\PYG{p}{:}\PYG{n}{end\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
            
            \PYG{n}{exec\PYGZus{}activity} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{task\PYGZus{}mask}
            \PYG{n}{dmn\PYGZus{}activity} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{task\PYGZus{}mask}
    
    \PYG{c+c1}{\PYGZsh{} Normalize}
    \PYG{n}{dmn\PYGZus{}activity} \PYG{o}{=} \PYG{p}{(}\PYG{n}{dmn\PYGZus{}activity} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}activity}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}activity}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}activity} \PYG{o}{=} \PYG{p}{(}\PYG{n}{exec\PYGZus{}activity} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{exec\PYGZus{}activity}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{exec\PYGZus{}activity}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}activity}\PYG{p}{,} \PYG{n}{exec\PYGZus{}activity}

\PYG{c+c1}{\PYGZsh{} Visualize network dynamics}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}network\PYGZus{}timeseries}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}activity}\PYG{p}{,} \PYG{n}{exec\PYGZus{}activity}\PYG{p}{,} \PYG{n}{task\PYGZus{}timing}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}activity}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Default Mode Network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{exec\PYGZus{}activity}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive Control Network}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight task periods}
    \PYG{k}{if} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{start}\PYG{p}{,} \PYG{n}{end} \PYG{o+ow}{in} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{start}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{p}{(}\PYG{n}{start} \PYG{o}{+} \PYG{n}{end}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mf}{1.8}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{horizontalalignment}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (seconds)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Network Activity (z\PYGZhy{}score)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simulated DMN vs Executive Network Dynamics}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add correlation coefficient}
    \PYG{n}{corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}activity}\PYG{p}{,} \PYG{n}{exec\PYGZus{}activity}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{corr}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{transAxes}\PYG{p}{,}
             \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot a sliding window correlation analysis}
    \PYG{n}{window\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{10}
    \PYG{n}{step\PYGZus{}size} \PYG{o}{=} \PYG{n}{window\PYGZus{}size} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    
    \PYG{n}{sliding\PYGZus{}corr} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{window\PYGZus{}centers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{window\PYGZus{}size}\PYG{p}{,} \PYG{n}{step\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{window\PYGZus{}dmn} \PYG{o}{=} \PYG{n}{dmn\PYGZus{}activity}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}
        \PYG{n}{window\PYGZus{}exec} \PYG{o}{=} \PYG{n}{exec\PYGZus{}activity}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}
        \PYG{n}{corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{window\PYGZus{}dmn}\PYG{p}{,} \PYG{n}{window\PYGZus{}exec}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{sliding\PYGZus{}corr}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{corr}\PYG{p}{)}
        \PYG{n}{window\PYGZus{}centers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{time}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{n}{window\PYGZus{}size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{window\PYGZus{}centers}\PYG{p}{,} \PYG{n}{sliding\PYGZus{}corr}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (seconds)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN\PYGZhy{}Executive Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sliding Window Correlation Analysis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight task periods}
    \PYG{k}{if} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{start}\PYG{p}{,} \PYG{n}{end} \PYG{o+ow}{in} \PYG{n}{task\PYGZus{}timing}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{start}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Simulate tDCS effects on network balance}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}tdcs\PYGZus{}effect}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{300}\PYG{p}{,} \PYG{n}{stim\PYGZus{}period}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target\PYGZus{}network}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate how tDCS might affect the balance between DMN and Executive Network}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    duration: total simulation time in seconds}
\PYG{l+s+sd}{    stim\PYGZus{}period: tuple of (start, end) time for stimulation in seconds}
\PYG{l+s+sd}{    target\PYGZus{}network: which network to stimulate (\PYGZsq{}DMN\PYGZsq{} or \PYGZsq{}Executive\PYGZsq{})}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Standard simulation without stimulation}
    \PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn}\PYG{p}{,} \PYG{n}{exec\PYGZus{}net} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}brain\PYGZus{}networks}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{n}{duration}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a stimulation time series (effect of tDCS)}
    \PYG{n}{stim\PYGZus{}effect} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)}
    \PYG{n}{stim\PYGZus{}start\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{time} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{stim\PYGZus{}end\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{time} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Ramp up effect}
    \PYG{n}{ramp\PYGZus{}duration} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} seconds for effect to reach maximum}
    \PYG{n}{ramp\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{ramp\PYGZus{}duration} \PYG{o}{*} \PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)} \PYG{o}{/} \PYG{n}{duration}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Ramp up}
    \PYG{n}{ramp\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{stim\PYGZus{}start\PYGZus{}idx}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{stim\PYGZus{}start\PYGZus{}idx} \PYG{o}{+} \PYG{n}{ramp\PYGZus{}samples}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{stim\PYGZus{}effect}\PYG{p}{[}\PYG{n}{ramp\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{ramp\PYGZus{}indices}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plateau}
    \PYG{n}{plateau\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{stim\PYGZus{}start\PYGZus{}idx} \PYG{o}{+} \PYG{n}{ramp\PYGZus{}samples}\PYG{p}{,} \PYG{n}{stim\PYGZus{}end\PYGZus{}idx}\PYG{p}{)}
    \PYG{n}{stim\PYGZus{}effect}\PYG{p}{[}\PYG{n}{plateau\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}
    
    \PYG{c+c1}{\PYGZsh{} Ramp down}
    \PYG{n}{ramp\PYGZus{}down\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{stim\PYGZus{}end\PYGZus{}idx}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{stim\PYGZus{}end\PYGZus{}idx} \PYG{o}{+} \PYG{n}{ramp\PYGZus{}samples}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{stim\PYGZus{}effect}\PYG{p}{[}\PYG{n}{ramp\PYGZus{}down\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{ramp\PYGZus{}down\PYGZus{}indices}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply effect to target network}
    \PYG{n}{dmn\PYGZus{}stim} \PYG{o}{=} \PYG{n}{dmn}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}stim} \PYG{o}{=} \PYG{n}{exec\PYGZus{}net}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{stim\PYGZus{}magnitude} \PYG{o}{=} \PYG{l+m+mf}{0.8}
    
    \PYG{k}{if} \PYG{n}{target\PYGZus{}network} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Stimulating DMN increases DMN and decreases Executive}
        \PYG{n}{dmn\PYGZus{}stim} \PYG{o}{+}\PYG{o}{=} \PYG{n}{stim\PYGZus{}effect} \PYG{o}{*} \PYG{n}{stim\PYGZus{}magnitude}
        \PYG{n}{exec\PYGZus{}stim} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{stim\PYGZus{}effect} \PYG{o}{*} \PYG{p}{(}\PYG{n}{stim\PYGZus{}magnitude} \PYG{o}{*} \PYG{l+m+mf}{0.6}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Secondary effect on other network}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Stimulating Executive increases Executive and decreases DMN}
        \PYG{n}{exec\PYGZus{}stim} \PYG{o}{+}\PYG{o}{=} \PYG{n}{stim\PYGZus{}effect} \PYG{o}{*} \PYG{n}{stim\PYGZus{}magnitude}
        \PYG{n}{dmn\PYGZus{}stim} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{stim\PYGZus{}effect} \PYG{o}{*} \PYG{p}{(}\PYG{n}{stim\PYGZus{}magnitude} \PYG{o}{*} \PYG{l+m+mf}{0.6}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Secondary effect on other network}
    
    \PYG{c+c1}{\PYGZsh{} Re\PYGZhy{}normalize}
    \PYG{n}{dmn\PYGZus{}stim} \PYG{o}{=} \PYG{p}{(}\PYG{n}{dmn\PYGZus{}stim} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}stim}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}stim}\PYG{p}{)}
    \PYG{n}{exec\PYGZus{}stim} \PYG{o}{=} \PYG{p}{(}\PYG{n}{exec\PYGZus{}stim} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{exec\PYGZus{}stim}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{exec\PYGZus{}stim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN (baseline)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{exec\PYGZus{}net}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive (baseline)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{yellow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{p}{(}\PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mf}{1.8}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tDCS: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{target\PYGZus{}network}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
             \PYG{n}{horizontalalignment}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Baseline Network Dynamics}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{dmn\PYGZus{}stim}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DMN (with tDCS)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{exec\PYGZus{}stim}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Executive (with tDCS)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{stim\PYGZus{}period}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{yellow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Effect of tDCS on }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{target\PYGZus{}network}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (seconds)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate correlation changes due to stimulation}
    \PYG{n}{baseline\PYGZus{}corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{dmn}\PYG{p}{,} \PYG{n}{exec\PYGZus{}net}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{stim\PYGZus{}corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{dmn\PYGZus{}stim}\PYG{p}{,} \PYG{n}{exec\PYGZus{}stim}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Baseline DMN\PYGZhy{}Executive correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{baseline\PYGZus{}corr}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{With tDCS to }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{target\PYGZus{}network}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{stim\PYGZus{}corr}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Change in anti\PYGZhy{}correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{stim\PYGZus{}corr}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{baseline\PYGZus{}corr}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example calls:}
\PYG{c+c1}{\PYGZsh{} time\PYGZus{}series, dmn, exec\PYGZus{}net = simulate\PYGZus{}brain\PYGZus{}networks(task\PYGZus{}timing=[(100, 150), (300, 350)])}
\PYG{c+c1}{\PYGZsh{} plot\PYGZus{}network\PYGZus{}timeseries(time\PYGZus{}series, dmn, exec\PYGZus{}net, task\PYGZus{}timing=[(100, 150), (300, 350)])}
\PYG{c+c1}{\PYGZsh{} simulate\PYGZus{}tdcs\PYGZus{}effect(target\PYGZus{}network=\PYGZsq{}Executive\PYGZsq{})}
\end{sphinxVerbatim}


\section{5.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part2/ch05_brain_networks:take-aways}}

\subsection{Brain Function Emerges from Network Interactions}
\label{\detokenize{part2/ch05_brain_networks:brain-function-emerges-from-network-interactions}}
\sphinxAtStartPar
The brain’s complex functions emerge not from isolated regions but from the dynamic interactions between distributed networks. The default mode and executive control networks represent complementary systems that support different modes of cognition, with the former specialized for internal, self\sphinxhyphen{}referential processing and the latter for external, goal\sphinxhyphen{}directed behavior.

\sphinxAtStartPar
The anti\sphinxhyphen{}correlated relationship between these networks highlights the brain’s ability to shift resources based on current demands. This dynamic reconfiguration allows for rapid transitions between different cognitive states—from focused attention to mind\sphinxhyphen{}wandering, from perception to introspection.

\sphinxAtStartPar
Network neuroscience provides a framework for understanding how these interactions give rise to cognitive functions, moving beyond traditional region\sphinxhyphen{}based approaches toward a more integrative understanding of brain dynamics.


\subsection{Balance Between Networks Supports Adaptive Cognition}
\label{\detokenize{part2/ch05_brain_networks:balance-between-networks-supports-adaptive-cognition}}
\sphinxAtStartPar
The appropriate balance between networks is critical for adaptive cognition. Excessive dominance of either network may lead to maladaptive function:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Overactivation of executive networks without adequate DMN activity might impair creativity, self\sphinxhyphen{}reflection, and long\sphinxhyphen{}term planning

\item {} 
\sphinxAtStartPar
Overactivation of the DMN without sufficient executive control might lead to rumination, difficulty with focused attention, and reduced task performance

\end{itemize}

\sphinxAtStartPar
This balance shifts appropriately in healthy individuals, allowing for focused attention when needed and constructive mind\sphinxhyphen{}wandering when appropriate. Disruption of this balance contributes to various disorders, including ADHD, depression, and schizophrenia.

\sphinxAtStartPar
The dynamic coupling between networks also supports transitions between exploration (broadly sampling possibilities) and exploitation (focusing on optimal solutions), a tension relevant to both biological and artificial intelligence.


\subsection{Network Properties Constrain and Enable Computation}
\label{\detokenize{part2/ch05_brain_networks:network-properties-constrain-and-enable-computation}}
\sphinxAtStartPar
The structural and functional organization of brain networks both constrains and enables cognitive computation. Properties such as small\sphinxhyphen{}world architecture, modularity, and rich\sphinxhyphen{}club organization support efficient information processing by balancing integration and segregation.

\sphinxAtStartPar
These principles may inform artificial intelligence design:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Modular, semi\sphinxhyphen{}specialized networks} may outperform monolithic architectures for certain tasks, mirroring the brain’s specialized yet integrated networks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dynamic resource allocation} between different processing modes might enhance adaptive learning and problem\sphinxhyphen{}solving

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Graph\sphinxhyphen{}theoretic properties} like small\sphinxhyphen{}world organization could inspire more efficient neural network architectures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Anti\sphinxhyphen{}correlated systems} may provide useful tension between complementary processing modes

\end{enumerate}

\sphinxAtStartPar
The brain’s network architecture represents an evolutionary solution to complex information processing under biological constraints. Understanding these organizing principles may inspire new approaches to artificial intelligence that incorporate lessons from network neuroscience.


\section{5.8 Further Reading \& Media}
\label{\detokenize{part2/ch05_brain_networks:further-reading-media}}

\subsection{Key Papers}
\label{\detokenize{part2/ch05_brain_networks:key-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Raichle, M. E., MacLeod, A. M., Snyder, A. Z., Powers, W. J., Gusnard, D. A., \& Shulman, G. L. (2001). A default mode of brain function. \sphinxstyleemphasis{Proceedings of the National Academy of Sciences}, 98(2), 676\sphinxhyphen{}682.
\begin{itemize}
\item {} 
\sphinxAtStartPar
The foundational paper that first identified the default mode network and its unique properties

\end{itemize}

\item {} 
\sphinxAtStartPar
Fox, M. D., Snyder, A. Z., Vincent, J. L., Corbetta, M., Van Essen, D. C., \& Raichle, M. E. (2005). The human brain is intrinsically organized into dynamic, anticorrelated functional networks. \sphinxstyleemphasis{Proceedings of the National Academy of Sciences}, 102(27), 9673\sphinxhyphen{}9678.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Classic paper demonstrating the anti\sphinxhyphen{}correlation between default mode and task\sphinxhyphen{}positive networks

\end{itemize}

\item {} 
\sphinxAtStartPar
Cole, M. W., Reynolds, J. R., Power, J. D., Repovs, G., Anticevic, A., \& Braver, T. S. (2013). Multi\sphinxhyphen{}task connectivity reveals flexible hubs for adaptive task control. \sphinxstyleemphasis{Nature Neuroscience}, 16(9), 1348\sphinxhyphen{}1355.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Explores how executive control networks flexibly reconfigure based on task demands

\end{itemize}

\item {} 
\sphinxAtStartPar
Bassett, D. S., \& Sporns, O. (2017). Network neuroscience. \sphinxstyleemphasis{Nature Neuroscience}, 20(3), 353\sphinxhyphen{}364.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Comprehensive review of network approaches to understanding brain organization

\end{itemize}

\item {} 
\sphinxAtStartPar
Buckner, R. L., Andrews\sphinxhyphen{}Hanna, J. R., \& Schacter, D. L. (2008). The brain’s default network: Anatomy, function, and relevance to disease. \sphinxstyleemphasis{Annals of the New York Academy of Sciences}, 1124(1), 1\sphinxhyphen{}38.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Detailed exploration of DMN functions and their relevance to clinical conditions

\end{itemize}

\end{itemize}


\subsection{Books}
\label{\detokenize{part2/ch05_brain_networks:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Sporns, O. (2010). \sphinxstyleemphasis{Networks of the Brain}. MIT Press.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Comprehensive introduction to network neuroscience principles and applications

\end{itemize}

\item {} 
\sphinxAtStartPar
Northoff, G. (2013). \sphinxstyleemphasis{Unlocking the Brain: Volume 2: Consciousness}. Oxford University Press.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Explores connections between brain networks and consciousness, with emphasis on DMN

\end{itemize}

\item {} 
\sphinxAtStartPar
Petersen, S. E., \& Sporns, O. (2015). \sphinxstyleemphasis{Brain Networks and Cognitive Architectures}. Oxford University Press.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Connects brain network organization to cognitive functions

\end{itemize}

\end{itemize}


\subsection{Online Resources}
\label{\detokenize{part2/ch05_brain_networks:online-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.humanconnectome.org/}{Human Connectome Project}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Large\sphinxhyphen{}scale project mapping brain connectivity with extensive data resources

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.coursera.org/learn/network-neuroscience}{Brain Networks Course}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Online course covering foundations of network neuroscience

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://github.com/brain-networks/brainnetworks}{Network Neuroscience Tools}
\begin{itemize}
\item {} 
\sphinxAtStartPar
GitHub repository with tools for brain network analysis

\end{itemize}

\end{itemize}


\subsection{Videos and Lectures}
\label{\detokenize{part2/ch05_brain_networks:videos-and-lectures}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.youtube.com/watch?v=n1CeFv1wJAA}{“Default Mode Network” by Marcus Raichle}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Lecture by the scientist who first identified the DMN

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.youtube.com/watch?v=ApmRl9urTbM}{“Functional Brain Networks” by Olaf Sporns}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Overview of network approaches to studying brain function

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.youtube.com/watch?v=n82PFe3bogM}{“Resting State fMRI” by Stephen Smith}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Explanation of resting\sphinxhyphen{}state functional connectivity methods

\end{itemize}

\end{itemize}


\subsection{Tutorials and Code}
\label{\detokenize{part2/ch05_brain_networks:tutorials-and-code}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://sites.google.com/site/bctnet/}{Brain Connectivity Toolbox}
\begin{itemize}
\item {} 
\sphinxAtStartPar
MATLAB toolbox for network analysis of connectivity data

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://nilearn.github.io/stable/index.html}{Nilearn}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Python library for statistical analysis of neuroimaging data, including network analysis

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://networkx.org/}{NetworkX}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Python library for complex network analysis applicable to brain networks

\end{itemize}

\end{itemize}

\sphinxstepscope


\chapter{Chapter 6: Neurostimulation \& Plasticity}
\label{\detokenize{part2/ch06_neurostimulation:chapter-6-neurostimulation-plasticity}}\label{\detokenize{part2/ch06_neurostimulation::doc}}

\section{6.0 Chapter Goals}
\label{\detokenize{part2/ch06_neurostimulation:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand mechanisms of neural plasticity

\item {} 
\sphinxAtStartPar
Explore neuromodulatory systems (dopamine, acetylcholine, etc.)

\item {} 
\sphinxAtStartPar
Connect plasticity to learning algorithms

\item {} 
\sphinxAtStartPar
Investigate non\sphinxhyphen{}invasive brain stimulation techniques

\item {} 
\sphinxAtStartPar
Explore computational models of neural plasticity and stimulation

\item {} 
\sphinxAtStartPar
Apply neuroscience concepts to AI systems

\end{itemize}


\section{6.1 Neural Plasticity Mechanisms}
\label{\detokenize{part2/ch06_neurostimulation:neural-plasticity-mechanisms}}
\sphinxAtStartPar
Neural plasticity refers to the brain’s remarkable ability to modify its structure and function in response to experience. This section explores the fundamental mechanisms that enable learning and adaptation in biological neural networks.


\subsection{Hebbian Learning: Cells That Fire Together, Wire Together}
\label{\detokenize{part2/ch06_neurostimulation:hebbian-learning-cells-that-fire-together-wire-together}}
\sphinxAtStartPar
Donald Hebb’s seminal postulate (1949) established the foundation of modern neural plasticity theory: “When an axon of cell A is near enough to excite cell B and repeatedly or persistently takes part in firing it, some growth process or metabolic change takes place in one or both cells such that A’s efficiency, as one of the cells firing B, is increased.”

\sphinxAtStartPar
This principle is often simplified as “cells that fire together, wire together.” Mathematically, classical Hebbian learning can be expressed as:
\begin{equation*}
\begin{split}\Delta w_{ij} = \eta \cdot x_i \cdot y_j\end{split}
\end{equation*}
\sphinxAtStartPar
Where:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(\Delta w_{ij}\) is the change in synaptic weight

\item {} 
\sphinxAtStartPar
\(\eta\) is the learning rate

\item {} 
\sphinxAtStartPar
\(x_i\) is the presynaptic activity

\item {} 
\sphinxAtStartPar
\(y_j\) is the postsynaptic activity

\end{itemize}

\sphinxAtStartPar
While elegant, pure Hebbian learning is unstable as it creates positive feedback loops that can lead to runaway excitation. This necessitates additional regulatory mechanisms.


\subsection{Long\sphinxhyphen{}Term Potentiation (LTP) and Depression (LTD)}
\label{\detokenize{part2/ch06_neurostimulation:long-term-potentiation-ltp-and-depression-ltd}}
\sphinxAtStartPar
LTP and LTD are cellular mechanisms that implement Hebbian learning by strengthening or weakening synapses.

\sphinxAtStartPar
\sphinxstylestrong{Long\sphinxhyphen{}Term Potentiation (LTP):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
High\sphinxhyphen{}frequency stimulation (≈100 Hz) can induce lasting increases in synaptic strength

\item {} 
\sphinxAtStartPar
NMDA receptors act as coincidence detectors that require both presynaptic glutamate release and postsynaptic depolarization

\item {} 
\sphinxAtStartPar
Calcium influx through NMDA receptors activates CaMKII, leading to AMPA receptor insertion and synaptic strengthening

\item {} 
\sphinxAtStartPar
First demonstrated in hippocampal slices by Bliss and Lømo (1973)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Long\sphinxhyphen{}Term Depression (LTD):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Low\sphinxhyphen{}frequency stimulation (≈1 Hz) induces sustained decreases in synaptic strength

\item {} 
\sphinxAtStartPar
Moderate calcium influx activates phosphatases rather than kinases

\item {} 
\sphinxAtStartPar
Results in AMPA receptor internalization and synaptic weakening

\end{itemize}

\sphinxAtStartPar
LTP and LTD can last from hours to months and provide a cellular basis for memory formation and learning.


\subsection{Spike\sphinxhyphen{}Timing\sphinxhyphen{}Dependent Plasticity (STDP)}
\label{\detokenize{part2/ch06_neurostimulation:spike-timing-dependent-plasticity-stdp}}
\sphinxAtStartPar
STDP refines Hebbian learning by incorporating the precise timing relationship between pre\sphinxhyphen{} and postsynaptic spikes:
\begin{itemize}
\item {} 
\sphinxAtStartPar
If a presynaptic neuron fires slightly before a postsynaptic neuron (within \textasciitilde{}20ms), the synapse strengthens (LTP)

\item {} 
\sphinxAtStartPar
If a presynaptic neuron fires after a postsynaptic neuron, the synapse weakens (LTD)

\item {} 
\sphinxAtStartPar
The magnitude of change decreases exponentially with the time difference

\end{itemize}

\sphinxAtStartPar
This temporal precision allows neural networks to learn causal relationships and temporal sequences. Mathematically, STDP can be modeled as:
\begin{equation*}
\begin{split}\Delta w = \begin{cases}
A_+ \cdot e^{-\Delta t / \tau_+} & \text{if } \Delta t > 0 \\
-A_- \cdot e^{\Delta t / \tau_-} & \text{if } \Delta t < 0
\end{cases}\end{split}
\end{equation*}
\sphinxAtStartPar
Where \(\Delta t = t_{post} - t_{pre}\) is the timing difference between spikes.


\subsection{Homeostatic Plasticity}
\label{\detokenize{part2/ch06_neurostimulation:homeostatic-plasticity}}
\sphinxAtStartPar
While Hebbian mechanisms enable specific changes in response to activity patterns, homeostatic plasticity maintains network stability:

\sphinxAtStartPar
\sphinxstylestrong{Synaptic Scaling:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Global adjustment of all synapses to maintain a target activity level

\item {} 
\sphinxAtStartPar
Multiplicative scaling preserves relative differences between synapses

\item {} 
\sphinxAtStartPar
Occurs over longer timescales (days) than Hebbian plasticity

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Metaplasticity:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
“Plasticity of plasticity” \sphinxhyphen{} adjustment of plasticity thresholds based on history

\item {} 
\sphinxAtStartPar
Bienenstock\sphinxhyphen{}Cooper\sphinxhyphen{}Munro (BCM) theory introduces sliding threshold for potentiation/depression

\item {} 
\sphinxAtStartPar
Higher activity raises threshold, making LTP harder and LTD easier

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Intrinsic Plasticity:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Adjustment of neuronal excitability through ion channel modulation

\item {} 
\sphinxAtStartPar
Compensates for changes in synaptic inputs to maintain stable firing rates

\end{itemize}

\sphinxAtStartPar
These homeostatic mechanisms prevent neuronal silence or seizure\sphinxhyphen{}like overactivity while allowing meaningful learning to occur.


\subsection{Structural vs. Functional Plasticity}
\label{\detokenize{part2/ch06_neurostimulation:structural-vs-functional-plasticity}}
\sphinxAtStartPar
Neural plasticity operates on multiple timescales and involves both functional and structural changes:

\sphinxAtStartPar
\sphinxincludegraphics{{plasticity_mechanisms}.svg}

\sphinxAtStartPar
\sphinxstylestrong{Functional Plasticity:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Changes in synaptic strength without morphological alterations

\item {} 
\sphinxAtStartPar
Occurs rapidly (minutes to hours)

\item {} 
\sphinxAtStartPar
Mediated by receptor trafficking, phosphorylation, and neurotransmitter release changes

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Structural Plasticity:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Formation, elimination, and morphological changes of synaptic connections

\item {} 
\sphinxAtStartPar
Occurs more slowly (hours to days)

\item {} 
\sphinxAtStartPar
Involves dendritic spine growth/retraction, axonal sprouting, and synaptogenesis

\item {} 
\sphinxAtStartPar
Converts temporary memories into more permanent forms

\end{itemize}


\subsection{Critical Periods and Adult Plasticity}
\label{\detokenize{part2/ch06_neurostimulation:critical-periods-and-adult-plasticity}}
\sphinxAtStartPar
Critical periods are developmental windows of heightened plasticity:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Visual system critical period: Ocular dominance plasticity occurs readily in young animals but diminishes in adulthood

\item {} 
\sphinxAtStartPar
Language acquisition: Enhanced capacity to learn languages without accent before puberty

\item {} 
\sphinxAtStartPar
Molecular regulators include perineuronal nets, myelin\sphinxhyphen{}associated inhibitors, and GABA maturation

\end{itemize}

\sphinxAtStartPar
While adult plasticity is more restricted, substantial rewiring remains possible:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampus and associative cortical areas maintain higher plasticity throughout life

\item {} 
\sphinxAtStartPar
Adult neurogenesis occurs in specific brain regions (hippocampus, subventricular zone)

\item {} 
\sphinxAtStartPar
Environmental enrichment, exercise, and certain neurostimulation protocols can reactivate juvenile\sphinxhyphen{}like plasticity

\end{itemize}


\section{6.2 Neuromodulatory Systems}
\label{\detokenize{part2/ch06_neurostimulation:neuromodulatory-systems}}
\sphinxAtStartPar
Neuromodulators are chemical messengers that regulate neural activity and plasticity on broader spatial and temporal scales than fast neurotransmitters. They constitute the brain’s internal control system for learning and adaptation.

\sphinxAtStartPar
\sphinxincludegraphics{{neuromodulatory_systems}.svg}


\subsection{Dopamine: The Reward Signal}
\label{\detokenize{part2/ch06_neurostimulation:dopamine-the-reward-signal}}
\sphinxAtStartPar
The dopaminergic system plays a crucial role in reward\sphinxhyphen{}based learning and motivation:

\sphinxAtStartPar
\sphinxstylestrong{Anatomical Organization:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Nigrostriatal pathway (substantia nigra → striatum): Motor control

\item {} 
\sphinxAtStartPar
Mesolimbic pathway (VTA → nucleus accumbens, amygdala): Reward learning

\item {} 
\sphinxAtStartPar
Mesocortical pathway (VTA → prefrontal cortex): Executive function, working memory

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Receptor Types:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
D1\sphinxhyphen{}like receptors (D1, D5): Coupled to Gs proteins, increase cAMP, generally excitatory

\item {} 
\sphinxAtStartPar
D2\sphinxhyphen{}like receptors (D2, D3, D4): Coupled to Gi proteins, decrease cAMP, generally inhibitory

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Key Functions:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Reward prediction error signaling: Phasic dopamine release encodes the difference between expected and actual rewards

\item {} 
\sphinxAtStartPar
Incentive salience: Makes rewarding stimuli “wanted” rather than just “liked”

\item {} 
\sphinxAtStartPar
Working memory gating: Controls information flow into prefrontal working memory circuits

\item {} 
\sphinxAtStartPar
Motor program selection: Facilitates movement initiation via basal ganglia circuits

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Plasticity Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
D1 receptor activation enhances LTP in striatum and prefrontal cortex

\item {} 
\sphinxAtStartPar
Can convert LTD to LTP when timed appropriately with synaptic activity

\item {} 
\sphinxAtStartPar
Provides the third factor in three\sphinxhyphen{}factor learning rules (Hebbian plasticity gated by reward)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Computational Parallel:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Temporal difference (TD) learning in reinforcement learning algorithms

\item {} 
\sphinxAtStartPar
Actor\sphinxhyphen{}critic models with dopamine as the TD error signal

\item {} 
\sphinxAtStartPar
Reward\sphinxhyphen{}modulated STDP in neuromorphic computing

\end{itemize}


\subsection{Acetylcholine: The Attention Modulator}
\label{\detokenize{part2/ch06_neurostimulation:acetylcholine-the-attention-modulator}}
\sphinxAtStartPar
The cholinergic system regulates attention, arousal, and memory formation:

\sphinxAtStartPar
\sphinxstylestrong{Anatomical Organization:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Basal forebrain nuclei (including nucleus basalis) → widespread cortical projections

\item {} 
\sphinxAtStartPar
Brainstem nuclei → thalamus, midbrain, and other subcortical structures

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Receptor Types:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Nicotinic receptors: Ionotropic, fast\sphinxhyphen{}acting, enhance neural excitability

\item {} 
\sphinxAtStartPar
Muscarinic receptors: Metabotropic, slower modulatory effects via G\sphinxhyphen{}protein signaling

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Key Functions:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Attention: Enhances processing of behaviorally relevant stimuli

\item {} 
\sphinxAtStartPar
Signal\sphinxhyphen{}to\sphinxhyphen{}noise ratio: Increases response to relevant inputs while suppressing background activity

\item {} 
\sphinxAtStartPar
Cortical plasticity: Enables experience\sphinxhyphen{}dependent map reorganization

\item {} 
\sphinxAtStartPar
Memory encoding: Essential for forming new episodic memories

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Plasticity Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Enhances LTP in hippocampus when released during learning

\item {} 
\sphinxAtStartPar
Lowers threshold for spike\sphinxhyphen{}timing\sphinxhyphen{}dependent plasticity

\item {} 
\sphinxAtStartPar
Enables map reorganization in sensory cortices during learning

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Computational Parallel:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Attention mechanisms in artificial neural networks

\item {} 
\sphinxAtStartPar
Dropout regularization (mimicking fluctuating acetylcholine levels during sleep/wake cycles)

\item {} 
\sphinxAtStartPar
Precision weighting in predictive coding models

\end{itemize}


\subsection{Norepinephrine: The Alertness Signal}
\label{\detokenize{part2/ch06_neurostimulation:norepinephrine-the-alertness-signal}}
\sphinxAtStartPar
The noradrenergic system regulates arousal and behavioral flexibility:

\sphinxAtStartPar
\sphinxstylestrong{Anatomical Organization:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Primary source: Locus coeruleus

\item {} 
\sphinxAtStartPar
Widespread projections throughout cerebral cortex, cerebellum, brainstem, and spinal cord

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Receptor Types:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
α1: Excitatory, increases neural responsiveness

\item {} 
\sphinxAtStartPar
α2: Inhibitory, provides negative feedback to locus coeruleus

\item {} 
\sphinxAtStartPar
β1, β2: Enhance excitability and synaptic transmission

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Key Functions:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Arousal regulation: Transitions between sleep, drowsiness, and alertness

\item {} 
\sphinxAtStartPar
Attention shifting: Facilitates reorienting to novel or significant stimuli

\item {} 
\sphinxAtStartPar
Stress response: Coordinates physiological responses to threat

\item {} 
\sphinxAtStartPar
Memory consolidation: Enhances storage of emotionally salient information

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Plasticity Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Enhances LTP in amygdala (emotional learning)

\item {} 
\sphinxAtStartPar
Promotes memory consolidation when released during emotional arousal

\item {} 
\sphinxAtStartPar
Facilitates synaptic tagging, determining which memories are stored long\sphinxhyphen{}term

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Computational Parallel:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Exploration\sphinxhyphen{}exploitation tradeoff in reinforcement learning

\item {} 
\sphinxAtStartPar
Learning rate adjustment based on environmental novelty or uncertainty

\item {} 
\sphinxAtStartPar
Adaptive gain control in attention networks

\end{itemize}


\subsection{Serotonin: The Mood Regulator}
\label{\detokenize{part2/ch06_neurostimulation:serotonin-the-mood-regulator}}
\sphinxAtStartPar
The serotonergic system influences mood, impulse control, and time horizons for decision\sphinxhyphen{}making:

\sphinxAtStartPar
\sphinxstylestrong{Anatomical Organization:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Primary source: Raphe nuclei in brainstem

\item {} 
\sphinxAtStartPar
Projects widely throughout cortex, limbic system, and spinal cord

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Receptor Types:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Seven families (5\sphinxhyphen{}HT1\sphinxhyphen{}7) with at least 14 known subtypes

\item {} 
\sphinxAtStartPar
Diverse effects depending on receptor subtype and location

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Key Functions:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Mood regulation: Balanced activity essential for emotional stability

\item {} 
\sphinxAtStartPar
Impulse control: Inhibits premature responding and aggression

\item {} 
\sphinxAtStartPar
Appetite and sleep regulation: Modulates hypothalamic functions

\item {} 
\sphinxAtStartPar
Social behavior: Influences social cognition and interaction

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Plasticity Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Complex and often region\sphinxhyphen{}specific effects on plasticity

\item {} 
\sphinxAtStartPar
Promotes neurogenesis in hippocampus

\item {} 
\sphinxAtStartPar
Facilitates ocular dominance plasticity in visual cortex

\item {} 
\sphinxAtStartPar
Modulates stress effects on plasticity

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Computational Parallel:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Temporal discounting in reinforcement learning

\item {} 
\sphinxAtStartPar
Mood\sphinxhyphen{}dependent learning bias in decision models

\item {} 
\sphinxAtStartPar
Inhibitory control in cognitive architectures

\end{itemize}


\subsection{Interactions and Integration}
\label{\detokenize{part2/ch06_neurostimulation:interactions-and-integration}}
\sphinxAtStartPar
Neuromodulatory systems do not operate in isolation but form a complex, interconnected regulatory network:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dopamine\sphinxhyphen{}acetylcholine interactions in striatum control learning from rewards

\item {} 
\sphinxAtStartPar
Norepinephrine\sphinxhyphen{}serotonin balance influences impulsivity and patience

\item {} 
\sphinxAtStartPar
Dopamine\sphinxhyphen{}serotonin balance regulates approach vs. avoidance behaviors

\item {} 
\sphinxAtStartPar
Acetylcholine\sphinxhyphen{}norepinephrine interactions control attention allocation

\end{itemize}

\sphinxAtStartPar
This orchestrated control enables sophisticated regulation of neural plasticity across different brain states and behavioral contexts.


\section{6.3 Brain Stimulation Techniques}
\label{\detokenize{part2/ch06_neurostimulation:brain-stimulation-techniques}}
\sphinxAtStartPar
Brain stimulation techniques allow direct manipulation of neural activity and plasticity. These methods span from non\sphinxhyphen{}invasive approaches accessible to researchers and clinicians to invasive procedures reserved for specific clinical populations.

\sphinxAtStartPar
\sphinxincludegraphics{{neurostimulation_techniques}.svg}


\subsection{Transcranial Direct Current Stimulation (tDCS)}
\label{\detokenize{part2/ch06_neurostimulation:transcranial-direct-current-stimulation-tdcs}}
\sphinxAtStartPar
tDCS applies weak direct electrical current to the scalp to modulate brain activity:

\sphinxAtStartPar
\sphinxstylestrong{Mechanism:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Low\sphinxhyphen{}intensity direct current (typically 1\sphinxhyphen{}2 mA) delivered through scalp electrodes

\item {} 
\sphinxAtStartPar
Anodal stimulation: Increases neural excitability by slightly depolarizing neurons

\item {} 
\sphinxAtStartPar
Cathodal stimulation: Decreases neural excitability by slightly hyperpolarizing neurons

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Physiological Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
During stimulation: Shifts in resting membrane potential without directly triggering action potentials

\item {} 
\sphinxAtStartPar
After\sphinxhyphen{}effects: NMDA receptor\sphinxhyphen{}dependent changes in synaptic strength (LTP\sphinxhyphen{}like)

\item {} 
\sphinxAtStartPar
Secondary changes in neurotransmitter systems (GABA, glutamate, dopamine)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Spatial Resolution:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Limited by large electrode size (traditional setup)

\item {} 
\sphinxAtStartPar
High\sphinxhyphen{}definition tDCS (HD\sphinxhyphen{}tDCS) uses smaller electrodes for improved focality

\item {} 
\sphinxAtStartPar
Computational models help optimize montages for targeted effects

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Working memory enhancement via dorsolateral prefrontal cortex stimulation

\item {} 
\sphinxAtStartPar
Motor learning facilitation through primary motor cortex stimulation

\item {} 
\sphinxAtStartPar
Mood regulation in depression through frontal asymmetry modulation

\item {} 
\sphinxAtStartPar
Pain reduction via motor cortex or thalamic stimulation

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Limitations:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Significant individual variability in response

\item {} 
\sphinxAtStartPar
Modest effect sizes and variable reproducibility

\item {} 
\sphinxAtStartPar
Limited spatial precision compared to other techniques

\end{itemize}


\subsection{Transcranial Magnetic Stimulation (TMS)}
\label{\detokenize{part2/ch06_neurostimulation:transcranial-magnetic-stimulation-tms}}
\sphinxAtStartPar
TMS uses rapidly changing magnetic fields to induce electrical currents in brain tissue:

\sphinxAtStartPar
\sphinxstylestrong{Mechanism:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Brief, strong magnetic field (1\sphinxhyphen{}2 Tesla) induces electrical currents via electromagnetic induction

\item {} 
\sphinxAtStartPar
Current flow in neural tissue can elicit action potentials

\item {} 
\sphinxAtStartPar
Effects depend on stimulation protocol and brain state during application

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Protocols:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Single\sphinxhyphen{}pulse TMS: Brief neural activation or disruption

\item {} 
\sphinxAtStartPar
Paired\sphinxhyphen{}pulse TMS: Measures cortical inhibition and facilitation

\item {} 
\sphinxAtStartPar
Repetitive TMS (rTMS):
\begin{itemize}
\item {} 
\sphinxAtStartPar
Low\sphinxhyphen{}frequency (≤1 Hz): Generally inhibitory

\item {} 
\sphinxAtStartPar
High\sphinxhyphen{}frequency (≥5 Hz): Generally excitatory

\item {} 
\sphinxAtStartPar
Theta\sphinxhyphen{}burst stimulation: More rapid induction of plasticity

\end{itemize}

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Spatial and Temporal Resolution:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Better spatial precision than tDCS (\textasciitilde{}1\sphinxhyphen{}2 cm)

\item {} 
\sphinxAtStartPar
Excellent temporal precision (sub\sphinxhyphen{}millisecond)

\item {} 
\sphinxAtStartPar
Depth limited to cortical structures without special coils

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
FDA\sphinxhyphen{}approved for treatment\sphinxhyphen{}resistant depression

\item {} 
\sphinxAtStartPar
Therapeutic applications in anxiety disorders, OCD, and addiction

\item {} 
\sphinxAtStartPar
Motor rehabilitation after stroke

\item {} 
\sphinxAtStartPar
Mapping cortical functions and connectivity

\item {} 
\sphinxAtStartPar
“Virtual lesion” approach in cognitive neuroscience

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Limitations:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Requires specialized equipment and trained operators

\item {} 
\sphinxAtStartPar
Can be uncomfortable due to muscle activation and loud clicking

\item {} 
\sphinxAtStartPar
Potential seizure risk in predisposed individuals

\end{itemize}


\subsection{Deep Brain Stimulation (DBS)}
\label{\detokenize{part2/ch06_neurostimulation:deep-brain-stimulation-dbs}}
\sphinxAtStartPar
DBS involves surgically implanted electrodes delivering electrical pulses to specific deep brain structures:

\sphinxAtStartPar
\sphinxstylestrong{Mechanism:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Implanted electrodes connected to programmable pulse generator

\item {} 
\sphinxAtStartPar
Continuous or intermittent high\sphinxhyphen{}frequency stimulation (typically 130\sphinxhyphen{}180 Hz)

\item {} 
\sphinxAtStartPar
Creates functional inhibition within stimulated nucleus while activating output fibers

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Target Areas:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Movement disorders: Subthalamic nucleus, globus pallidus, thalamus

\item {} 
\sphinxAtStartPar
Psychiatric conditions: Anterior limb of internal capsule, nucleus accumbens, subgenual cingulate

\item {} 
\sphinxAtStartPar
Epilepsy: Anterior nucleus of thalamus, centromedian nucleus

\item {} 
\sphinxAtStartPar
Experimental targets: Fornix and nucleus basalis for Alzheimer’s disease

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Effects:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Immediate symptom relief in movement disorders

\item {} 
\sphinxAtStartPar
Gradual improvement in psychiatric conditions

\item {} 
\sphinxAtStartPar
Modulation of network activity beyond the stimulation site

\item {} 
\sphinxAtStartPar
Potential neuroplasticity induction with long\sphinxhyphen{}term use

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Parkinson’s disease: Remarkably effective for motor symptoms

\item {} 
\sphinxAtStartPar
Essential tremor: Typically targeting the thalamus

\item {} 
\sphinxAtStartPar
Dystonia: Often targeting globus pallidus

\item {} 
\sphinxAtStartPar
Treatment\sphinxhyphen{}resistant OCD (FDA approved under Humanitarian Device Exemption)

\item {} 
\sphinxAtStartPar
Experimental treatment for depression, addiction, and dementia

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Limitations:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Invasive neurosurgical procedure with associated risks

\item {} 
\sphinxAtStartPar
High cost and limited accessibility

\item {} 
\sphinxAtStartPar
Need for battery replacement and ongoing adjustments

\item {} 
\sphinxAtStartPar
Potential side effects including mood changes, speech issues, and impulse control disorders

\end{itemize}


\subsection{Other Neurostimulation Approaches}
\label{\detokenize{part2/ch06_neurostimulation:other-neurostimulation-approaches}}
\sphinxAtStartPar
\sphinxstylestrong{Transcranial Alternating Current Stimulation (tACS):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Delivers oscillating current at specific frequencies to entrain brain rhythms

\item {} 
\sphinxAtStartPar
Can influence cognitive functions associated with specific oscillatory bands (theta for memory, alpha for attention, etc.)

\item {} 
\sphinxAtStartPar
More frequency\sphinxhyphen{}specific effects than tDCS, potentially enabling more targeted cognitive modulation

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Transcranial Focused Ultrasound (tFUS):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Uses focused acoustic energy to modulate neural activity

\item {} 
\sphinxAtStartPar
Superior spatial resolution (millimeter precision) compared to tDCS/TMS

\item {} 
\sphinxAtStartPar
Can reach deep brain structures non\sphinxhyphen{}invasively

\item {} 
\sphinxAtStartPar
Currently primarily experimental but showing clinical promise

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Vagus Nerve Stimulation (VNS):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Stimulates the vagus nerve in neck via implanted device or non\sphinxhyphen{}invasive auricular stimulation

\item {} 
\sphinxAtStartPar
Approved for epilepsy and depression

\item {} 
\sphinxAtStartPar
Enhances plasticity by engaging multiple neuromodulatory systems

\item {} 
\sphinxAtStartPar
Paired with rehabilitation can enhance recovery from stroke or TBI

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Optogenetics (Research Tool):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Uses light\sphinxhyphen{}sensitive proteins (opsins) to control genetically\sphinxhyphen{}defined neuron populations

\item {} 
\sphinxAtStartPar
Unparalleled precision in circuit control (millisecond temporal and cell\sphinxhyphen{}type specificity)

\item {} 
\sphinxAtStartPar
Primarily a research tool in animal models, with human applications limited by gene delivery requirements

\item {} 
\sphinxAtStartPar
Has revolutionized understanding of circuit function and plasticity mechanisms

\end{itemize}


\section{6.4 Cognitive Enhancement Applications}
\label{\detokenize{part2/ch06_neurostimulation:cognitive-enhancement-applications}}
\sphinxAtStartPar
Neurostimulation techniques have been applied to enhance various cognitive domains, with applications spanning from basic research to clinical interventions.


\subsection{Memory Augmentation}
\label{\detokenize{part2/ch06_neurostimulation:memory-augmentation}}
\sphinxAtStartPar
\sphinxstylestrong{Working Memory Enhancement:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Left DLPFC stimulation with anodal tDCS improves capacity and manipulation

\item {} 
\sphinxAtStartPar
Effects appear larger in individuals with lower baseline performance

\item {} 
\sphinxAtStartPar
Theta\sphinxhyphen{}frequency stimulation (4\sphinxhyphen{}8 Hz) using tACS enhances performance on n\sphinxhyphen{}back tasks

\item {} 
\sphinxAtStartPar
Combined with cognitive training, may produce longer\sphinxhyphen{}lasting benefits

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Long\sphinxhyphen{}term Memory Improvement:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Stimulation during encoding phase of memory formation shows greater effects than during retrieval

\item {} 
\sphinxAtStartPar
Temporal lobe tDCS enhances verbal and episodic memory formation

\item {} 
\sphinxAtStartPar
Slow oscillation tDCS during slow\sphinxhyphen{}wave sleep enhances memory consolidation

\item {} 
\sphinxAtStartPar
Hippocampal\sphinxhyphen{}targeted stimulation methods in development for memory disorders

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Mechanisms:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Enhanced neural synchrony between prefrontal and parietal regions for working memory

\item {} 
\sphinxAtStartPar
Facilitated LTP\sphinxhyphen{}like processes in hippocampal\sphinxhyphen{}cortical networks for long\sphinxhyphen{}term memory

\item {} 
\sphinxAtStartPar
Improved coordination of memory reactivation during consolidation

\item {} 
\sphinxAtStartPar
Modulation of cholinergic and glutamatergic signaling essential for memory function

\end{itemize}


\subsection{Attention Modulation}
\label{\detokenize{part2/ch06_neurostimulation:attention-modulation}}
\sphinxAtStartPar
\sphinxstylestrong{Sustained Attention:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Right frontal tDCS improves vigilance and reduces fatigue effects

\item {} 
\sphinxAtStartPar
Alpha\sphinxhyphen{}frequency tACS to parietal cortex stabilizes attentional focus

\item {} 
\sphinxAtStartPar
Effects enhanced when stimulation timed to individual alpha phase

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Selective Attention:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Right parietal stimulation enhances spatial attention and reduces neglect symptoms

\item {} 
\sphinxAtStartPar
Alpha suppression via tACS improves filtering of distractors

\item {} 
\sphinxAtStartPar
Gamma\sphinxhyphen{}band stimulation enhances feature binding and object perception

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Mechanisms:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Enhanced top\sphinxhyphen{}down control signals from frontal regions

\item {} 
\sphinxAtStartPar
Improved signal\sphinxhyphen{}to\sphinxhyphen{}noise ratio in sensory processing

\item {} 
\sphinxAtStartPar
Modulation of alpha oscillations that normally gate information flow

\item {} 
\sphinxAtStartPar
Potential enhancement of cholinergic function, mimicking endogenous attention systems

\end{itemize}


\subsection{Motor Learning Facilitation}
\label{\detokenize{part2/ch06_neurostimulation:motor-learning-facilitation}}
\sphinxAtStartPar
\sphinxstylestrong{Skill Acquisition:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Primary motor cortex (M1) anodal tDCS accelerates motor sequence learning

\item {} 
\sphinxAtStartPar
Effects most pronounced during acquisition phase rather than retention

\item {} 
\sphinxAtStartPar
Cerebellar stimulation particularly effective for adaptation and error\sphinxhyphen{}based learning

\item {} 
\sphinxAtStartPar
Paired associative stimulation (PAS) strengthens specific motor circuits

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Consolidation Enhancement:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Post\sphinxhyphen{}training stimulation during rest periods boosts consolidation

\item {} 
\sphinxAtStartPar
Sleep combined with stimulation shows synergistic effects on motor memory

\item {} 
\sphinxAtStartPar
Stimulation\sphinxhyphen{}induced increases in slow\sphinxhyphen{}wave activity correlate with improved retention

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Rehabilitation after stroke or injury

\item {} 
\sphinxAtStartPar
Sports training and performance optimization

\item {} 
\sphinxAtStartPar
Recovery of fine motor skills in aging

\item {} 
\sphinxAtStartPar
Musician training and performance

\end{itemize}


\subsection{Clinical Applications}
\label{\detokenize{part2/ch06_neurostimulation:clinical-applications}}
\sphinxAtStartPar
\sphinxstylestrong{Stroke Rehabilitation:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Inhibitory stimulation to contralesional hemisphere and/or excitatory to ipsilesional hemisphere

\item {} 
\sphinxAtStartPar
Based on interhemispheric competition model of recovery

\item {} 
\sphinxAtStartPar
Most effective when paired with targeted behavioral therapy

\item {} 
\sphinxAtStartPar
Emerging evidence for connectivity\sphinxhyphen{}based personalized targeting

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Depression Treatment:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Left DLPFC stimulation to address frontal hypoactivity in depression

\item {} 
\sphinxAtStartPar
High\sphinxhyphen{}frequency rTMS FDA\sphinxhyphen{}approved for treatment\sphinxhyphen{}resistant depression

\item {} 
\sphinxAtStartPar
tDCS shows promise as a more accessible alternative

\item {} 
\sphinxAtStartPar
Accelerated protocols (multiple daily sessions) reduce treatment timeframe

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Cognitive Decline:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Multifocal tDCS approaches target large\sphinxhyphen{}scale networks affected in dementia

\item {} 
\sphinxAtStartPar
Stimulation paired with cognitive training shows greater benefits

\item {} 
\sphinxAtStartPar
Early intervention may be critical before substantial neurodegeneration

\item {} 
\sphinxAtStartPar
Both compensatory (recruiting intact areas) and restorative (enhancing affected circuits) approaches

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Addiction and Impulse Control:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dorsolateral prefrontal cortex stimulation reduces cravings

\item {} 
\sphinxAtStartPar
May strengthen top\sphinxhyphen{}down control over limbic reward circuits

\item {} 
\sphinxAtStartPar
Preliminary evidence for reduced consumption in alcohol and tobacco users

\item {} 
\sphinxAtStartPar
Combines effectively with cognitive behavioral therapy

\end{itemize}


\section{6.5 Computational Models}
\label{\detokenize{part2/ch06_neurostimulation:computational-models}}
\sphinxAtStartPar
Computational models provide a bridge between neuroscience and AI, allowing insights from plasticity and neurostimulation to inform machine learning approaches and vice versa.


\subsection{Reinforcement Learning and Dopamine}
\label{\detokenize{part2/ch06_neurostimulation:reinforcement-learning-and-dopamine}}
\sphinxAtStartPar
The striking correspondence between dopamine signals and temporal difference errors in reinforcement learning represents one of the most successful intersections of neuroscience and AI:

\sphinxAtStartPar
\sphinxstylestrong{Actor\sphinxhyphen{}Critic Architecture:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Parallels basal ganglia organization

\item {} 
\sphinxAtStartPar
Critic (ventral striatum): Learns state values and computes prediction errors

\item {} 
\sphinxAtStartPar
Actor (dorsal striatum): Selects actions based on learned policy

\item {} 
\sphinxAtStartPar
Dopamine signals function as the TD error that drives learning in both components

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Temporal Difference Learning:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
TD error: δ = r + γV(s’) \sphinxhyphen{} V(s)

\item {} 
\sphinxAtStartPar
Closely matches the pattern of phasic dopamine firing

\item {} 
\sphinxAtStartPar
Explains shift from reward to predictive cue with learning

\item {} 
\sphinxAtStartPar
Accounts for dopamine suppression when expected rewards are omitted

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Computational Implementation:}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{dopamine\PYGZus{}based\PYGZus{}rl}\PYG{p}{(}\PYG{n}{n\PYGZus{}states}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{discount\PYGZus{}factor}\PYG{o}{=}\PYG{l+m+mf}{0.9}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate dopamine\PYGZhy{}like reward prediction error in reinforcement learning\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Environment: simple chain with rewards at the end}
    \PYG{n}{reward} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}states}\PYG{p}{)}
    \PYG{n}{reward}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Reward at the end state}
    
    \PYG{c+c1}{\PYGZsh{} Initialize value function (prediction of future reward)}
    \PYG{n}{V} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}states}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Storage for plotting}
    \PYG{n}{values\PYGZus{}over\PYGZus{}time} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{prediction\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Learning loop}
    \PYG{k}{for} \PYG{n}{trial} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Start at state 0}
        \PYG{n}{state} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{values\PYGZus{}this\PYGZus{}trial} \PYG{o}{=} \PYG{p}{[}\PYG{n}{V}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
        \PYG{n}{trial\PYGZus{}prediction\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Move through the chain}
        \PYG{k}{while} \PYG{n}{state} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}states} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Move to next state}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{state} \PYG{o}{+} \PYG{l+m+mi}{1}
            
            \PYG{c+c1}{\PYGZsh{} Get reward}
            \PYG{n}{r} \PYG{o}{=} \PYG{n}{reward}\PYG{p}{[}\PYG{n}{next\PYGZus{}state}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Compute prediction error (dopamine\PYGZhy{}like signal)}
            \PYG{n}{prediction\PYGZus{}error} \PYG{o}{=} \PYG{n}{r} \PYG{o}{+} \PYG{n}{discount\PYGZus{}factor} \PYG{o}{*} \PYG{n}{V}\PYG{p}{[}\PYG{n}{next\PYGZus{}state}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{V}\PYG{p}{[}\PYG{n}{state}\PYG{p}{]}
            \PYG{n}{trial\PYGZus{}prediction\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update value function}
            \PYG{n}{V}\PYG{p}{[}\PYG{n}{state}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{prediction\PYGZus{}error}
            
            \PYG{c+c1}{\PYGZsh{} Store values for plotting}
            \PYG{n}{values\PYGZus{}this\PYGZus{}trial}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{V}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Move to next state}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
        
        \PYG{n}{values\PYGZus{}over\PYGZus{}time}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{values\PYGZus{}this\PYGZus{}trial}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{prediction\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{trial\PYGZus{}prediction\PYGZus{}errors}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{V}\PYG{p}{,} \PYG{n}{values\PYGZus{}over\PYGZus{}time}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}errors}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Three\sphinxhyphen{}Factor Learning Rules:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Extends Hebbian plasticity with dopaminergic modulation

\item {} 
\sphinxAtStartPar
Weight change: Δw = η · pre · post · dopamine

\item {} 
\sphinxAtStartPar
Eligibility traces: Synaptic “tags” allow delayed reward to affect recent synaptic activity

\item {} 
\sphinxAtStartPar
Bridges reinforcement learning and neurobiological plasticity

\end{itemize}


\subsection{Neural Network Plasticity Rules}
\label{\detokenize{part2/ch06_neurostimulation:neural-network-plasticity-rules}}
\sphinxAtStartPar
Biologically\sphinxhyphen{}inspired learning rules offer alternatives to backpropagation that may be more neurally plausible:

\sphinxAtStartPar
\sphinxstylestrong{STDP Implementation:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Local learning rule using only information available at the synapse

\item {} 
\sphinxAtStartPar
Weight update based on spike timing without global error signals

\item {} 
\sphinxAtStartPar
Can extract statistical regularities from input patterns

\item {} 
\sphinxAtStartPar
Used in neuromorphic computing systems like SpiNNaker and BrainScaleS

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Homeostatic Regulation:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Synaptic scaling in artificial networks:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Multiplicative scaling: w\_i → w\_i * (target\_activity / actual\_activity)

\item {} 
\sphinxAtStartPar
Preserves relative synaptic weights while regulating overall activity

\end{itemize}

\item {} 
\sphinxAtStartPar
Intrinsic plasticity: Adaptive thresholds that maintain target firing rates

\item {} 
\sphinxAtStartPar
Crucial for stable learning in recurrent networks and systems trained on streaming data

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Implementation Example:}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{stdp\PYGZus{}update}\PYG{p}{(}\PYG{n}{pre\PYGZus{}times}\PYG{p}{,} \PYG{n}{post\PYGZus{}times}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{,} \PYG{n}{A\PYGZus{}plus}\PYG{o}{=}\PYG{l+m+mf}{0.005}\PYG{p}{,} \PYG{n}{A\PYGZus{}minus}\PYG{o}{=}\PYG{l+m+mf}{0.0025}\PYG{p}{,} \PYG{n}{tau}\PYG{o}{=}\PYG{l+m+mf}{20.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Update synaptic weights according to STDP rule}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} pre\PYGZus{}times: spike times of presynaptic neurons}
\PYG{l+s+sd}{    \PYGZhy{} post\PYGZus{}times: spike times of postsynaptic neurons}
\PYG{l+s+sd}{    \PYGZhy{} weights: current synaptic weights}
\PYG{l+s+sd}{    \PYGZhy{} A\PYGZus{}plus: LTP learning rate}
\PYG{l+s+sd}{    \PYGZhy{} A\PYGZus{}minus: LTD learning rate}
\PYG{l+s+sd}{    \PYGZhy{} tau: time constant of STDP window}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} updated weights}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{new\PYGZus{}weights} \PYG{o}{=} \PYG{n}{weights}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For each synapse (pre\PYGZhy{}post pair)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{pre\PYGZus{}spikes} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pre\PYGZus{}times}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{post\PYGZus{}spikes} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{post\PYGZus{}times}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} For each pair of pre and post spikes}
            \PYG{k}{for} \PYG{n}{t\PYGZus{}pre} \PYG{o+ow}{in} \PYG{n}{pre\PYGZus{}spikes}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{t\PYGZus{}post} \PYG{o+ow}{in} \PYG{n}{post\PYGZus{}spikes}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Compute time difference}
                    \PYG{n}{delta\PYGZus{}t} \PYG{o}{=} \PYG{n}{t\PYGZus{}post} \PYG{o}{\PYGZhy{}} \PYG{n}{t\PYGZus{}pre}
                    
                    \PYG{c+c1}{\PYGZsh{} Apply STDP rule}
                    \PYG{k}{if} \PYG{n}{delta\PYGZus{}t} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Post after pre \PYGZhy{}\PYGZgt{} LTP}
                        \PYG{n}{dw} \PYG{o}{=} \PYG{n}{A\PYGZus{}plus} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{delta\PYGZus{}t} \PYG{o}{/} \PYG{n}{tau}\PYG{p}{)}
                        \PYG{n}{new\PYGZus{}weights}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dw}
                    \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Pre after post \PYGZhy{}\PYGZgt{} LTD}
                        \PYG{n}{dw} \PYG{o}{=} \PYG{n}{A\PYGZus{}minus} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{delta\PYGZus{}t} \PYG{o}{/} \PYG{n}{tau}\PYG{p}{)}
                        \PYG{n}{new\PYGZus{}weights}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{dw}
    
    \PYG{c+c1}{\PYGZsh{} Apply weight constraints (optional)}
    \PYG{n}{new\PYGZus{}weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{new\PYGZus{}weights}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{new\PYGZus{}weights}
\end{sphinxVerbatim}


\subsection{Meta\sphinxhyphen{}Learning in AI}
\label{\detokenize{part2/ch06_neurostimulation:meta-learning-in-ai}}
\sphinxAtStartPar
Paralleling neuromodulatory systems, meta\sphinxhyphen{}learning approaches adjust how networks learn:

\sphinxAtStartPar
\sphinxstylestrong{Learning Rate Modulation:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dynamic adjustment of learning rates analogous to neuromodulation

\item {} 
\sphinxAtStartPar
Cyclical learning rate schedules inspired by oscillatory brain dynamics

\item {} 
\sphinxAtStartPar
Adaptive optimizers (Adam, RMSProp) as artificial meta\sphinxhyphen{}plasticity systems

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Implementation Example:}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{n+nn}{.}\PYG{n+nn}{data}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{DataLoader}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}with\PYGZus{}lr\PYGZus{}schedule}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{epochs}\PYG{p}{,} \PYG{n}{lr\PYGZus{}schedule}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Train a model with a specific learning rate schedule}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    model: PyTorch neural network}
\PYG{l+s+sd}{    train\PYGZus{}loader: DataLoader with training data}
\PYG{l+s+sd}{    criterion: Loss function}
\PYG{l+s+sd}{    epochs: Number of training epochs}
\PYG{l+s+sd}{    lr\PYGZus{}schedule: Function that takes epoch number and returns learning rate}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    losses: List of training losses}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{learning\PYGZus{}rates} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Get learning rate for this epoch (neuromodulation\PYGZhy{}like)}
        \PYG{n}{lr} \PYG{o}{=} \PYG{n}{lr\PYGZus{}schedule}\PYG{p}{(}\PYG{n}{epoch}\PYG{p}{)}
        \PYG{n}{learning\PYGZus{}rates}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{lr}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create optimizer with current learning rate}
        \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{lr}\PYG{p}{)}
        
        \PYG{n}{running\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mf}{0.0}
        \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{targets} \PYG{o+ow}{in} \PYG{n}{train\PYGZus{}loader}\PYG{p}{:}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{running\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            
        \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{=} \PYG{n}{running\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train\PYGZus{}loader}\PYG{p}{)}
        \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{epoch\PYGZus{}loss}\PYG{p}{)}
        
    \PYG{k}{return} \PYG{n}{losses}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rates}

\PYG{c+c1}{\PYGZsh{} Different learning rate schedules (analogous to different neuromodulation patterns)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{constant\PYGZus{}lr}\PYG{p}{(}\PYG{n}{epoch}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{lr}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decaying\PYGZus{}lr}\PYG{p}{(}\PYG{n}{epoch}\PYG{p}{,} \PYG{n}{initial\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{decay}\PYG{o}{=}\PYG{l+m+mf}{0.9}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{initial\PYGZus{}lr} \PYG{o}{*} \PYG{p}{(}\PYG{n}{decay} \PYG{o}{*}\PYG{o}{*} \PYG{n}{epoch}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{cyclical\PYGZus{}lr}\PYG{p}{(}\PYG{n}{epoch}\PYG{p}{,} \PYG{n}{min\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{n}{max\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{cycle\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{min\PYGZus{}lr} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{p}{(}\PYG{n}{max\PYGZus{}lr} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}lr}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{epoch} \PYG{o}{/} \PYG{n}{cycle\PYGZus{}length}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Attention Mechanisms:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}attention in transformers as analogous to cholinergic modulation

\item {} 
\sphinxAtStartPar
Selective enhancement of relevant inputs while suppressing distractors

\item {} 
\sphinxAtStartPar
Parallels acetylcholine’s role in signal\sphinxhyphen{}to\sphinxhyphen{}noise enhancement

\item {} 
\sphinxAtStartPar
Key\sphinxhyphen{}query\sphinxhyphen{}value operations conceptually similar to neuromodulatory gating

\end{itemize}


\subsection{Stimulation Effects on Neural Networks}
\label{\detokenize{part2/ch06_neurostimulation:stimulation-effects-on-neural-networks}}
\sphinxAtStartPar
Models of brain stimulation can inform novel approaches to AI optimization:

\sphinxAtStartPar
\sphinxstylestrong{Simulating tDCS in Neural Networks:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Modeled as shifts in neuronal excitability or response bias

\item {} 
\sphinxAtStartPar
Implementation example:

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{tDCSNeuralNetwork}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{tDCSNeuralNetwork}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} tDCS modulation parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{anodal\PYGZus{}regions} \PYG{o}{=} \PYG{k+kc}{None}  \PYG{c+c1}{\PYGZsh{} Neurons with increased excitability}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cathodal\PYGZus{}regions} \PYG{o}{=} \PYG{k+kc}{None}  \PYG{c+c1}{\PYGZsh{} Neurons with decreased excitability}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{modulation\PYGZus{}strength} \PYG{o}{=} \PYG{l+m+mf}{0.2}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{set\PYGZus{}stimulation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{anodal\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{cathodal\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{strength}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Set which neurons receive stimulation}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{anodal\PYGZus{}regions} \PYG{o}{=} \PYG{n}{anodal\PYGZus{}mask}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cathodal\PYGZus{}regions} \PYG{o}{=} \PYG{n}{cathodal\PYGZus{}mask}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{modulation\PYGZus{}strength} \PYG{o}{=} \PYG{n}{strength}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} First layer}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply tDCS effects to hidden layer activations (modulating excitability)}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{anodal\PYGZus{}regions} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Increase activity in stimulated regions}
            \PYG{n}{mask} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{mask}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{anodal\PYGZus{}regions}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{modulation\PYGZus{}strength}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{+} \PYG{n}{mask}
            
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cathodal\PYGZus{}regions} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Decrease activity in inhibited regions}
            \PYG{n}{mask} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{mask}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cathodal\PYGZus{}regions}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{modulation\PYGZus{}strength}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{mask}
        
        \PYG{c+c1}{\PYGZsh{} Continue forward pass}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Oscillatory Entrainment:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
tACS\sphinxhyphen{}inspired approaches add oscillatory components to network activation

\item {} 
\sphinxAtStartPar
Phase alignment between internal dynamics and external oscillations

\item {} 
\sphinxAtStartPar
Potential for enhanced information routing in complex networks

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Network Connectivity Modulation:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Graph theoretical approaches to identify optimal stimulation targets

\item {} 
\sphinxAtStartPar
Enhanced activation of hub nodes for network\sphinxhyphen{}wide effects

\item {} 
\sphinxAtStartPar
Personalized stimulation based on individual network architecture

\end{itemize}


\subsection{Fine\sphinxhyphen{}Tuning AI Models}
\label{\detokenize{part2/ch06_neurostimulation:fine-tuning-ai-models}}
\sphinxAtStartPar
Fine\sphinxhyphen{}tuning pre\sphinxhyphen{}trained AI models parallels how brain stimulation enhances learning in existing neural circuits:

\sphinxAtStartPar
\sphinxstylestrong{Transfer Learning Parallels:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pre\sphinxhyphen{}trained models as analogous to developed brain circuitry

\item {} 
\sphinxAtStartPar
Fine\sphinxhyphen{}tuning as selective enhancement of plasticity in specific circuits

\item {} 
\sphinxAtStartPar
Both approaches more efficient than training/learning from scratch

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Adapter Modules:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Small, trainable components added to pre\sphinxhyphen{}trained models

\item {} 
\sphinxAtStartPar
Conceptually similar to targeted plasticity in specific brain pathways

\item {} 
\sphinxAtStartPar
Efficiently adapt existing knowledge to new tasks

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Low\sphinxhyphen{}Rank Adaptation (LoRA):}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Minimal parameter updates through low\sphinxhyphen{}rank decomposition of weight changes

\item {} 
\sphinxAtStartPar
Analogous to minimal interventions of neurostimulation

\item {} 
\sphinxAtStartPar
Preserves core knowledge while enabling task\sphinxhyphen{}specific adaptation

\end{itemize}


\section{6.6 Code Lab: Neurostimulation and Learning Simulations}
\label{\detokenize{part2/ch06_neurostimulation:code-lab-neurostimulation-and-learning-simulations}}
\sphinxAtStartPar
We’ve incorporated several code examples throughout this chapter to illustrate key concepts. Here, we’ll pull these together into a complete simulation framework for exploring how neurostimulation might influence learning in neural systems.


\subsection{Simulating tDCS Effects on Learning}
\label{\detokenize{part2/ch06_neurostimulation:simulating-tdcs-effects-on-learning}}
\sphinxAtStartPar
This simulation demonstrates how tDCS\sphinxhyphen{}like stimulation might affect learning in a neural network:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{n+nn}{.}\PYG{n+nn}{data}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{DataLoader}\PYG{p}{,} \PYG{n}{TensorDataset}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}tdcs\PYGZus{}learning}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate how tDCS might affect the learning of a classification task\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate data for a classification task}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create two\PYGZhy{}class classification problem}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{500}
    \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{l+m+mi}{20}
    
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Task depends heavily on specific features (e.g., features 5\PYGZhy{}10)}
    \PYG{n}{w} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}
    \PYG{n}{w}\PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{:}\PYG{l+m+mi}{10}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} These features are important}
    
    \PYG{c+c1}{\PYGZsh{} Generate labels}
    \PYG{n}{logits} \PYG{o}{=} \PYG{n}{X} \PYG{o}{@} \PYG{n}{w}
    \PYG{n}{y} \PYG{o}{=} \PYG{p}{(}\PYG{n}{logits} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split data}
    \PYG{n}{train\PYGZus{}X}\PYG{p}{,} \PYG{n}{train\PYGZus{}y} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{400}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{400}\PYG{p}{]}
    \PYG{n}{test\PYGZus{}X}\PYG{p}{,} \PYG{n}{test\PYGZus{}y} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{l+m+mi}{400}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{l+m+mi}{400}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{train\PYGZus{}X}\PYG{p}{,} \PYG{n}{train\PYGZus{}y}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} 
                              \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{test\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{test\PYGZus{}X}\PYG{p}{,} \PYG{n}{test\PYGZus{}y}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} 
                             \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create two identical models}
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{model\PYGZus{}baseline} \PYG{o}{=} \PYG{n}{tDCSNeuralNetwork}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{model\PYGZus{}tdcs} \PYG{o}{=} \PYG{n}{tDCSNeuralNetwork}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Stimulate neurons that process the relevant features (5\PYGZhy{}10)}
    \PYG{c+c1}{\PYGZsh{} In a real brain, we wouldn\PYGZsq{}t know which neurons are important,}
    \PYG{c+c1}{\PYGZsh{} but this simplification helps illustrate the concept}
    \PYG{n}{model\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{set\PYGZus{}stimulation}\PYG{p}{(}\PYG{n}{anodal\PYGZus{}mask}\PYG{o}{=}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{strength}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training setup}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{BCEWithLogitsLoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer\PYGZus{}baseline} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model\PYGZus{}baseline}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    \PYG{n}{optimizer\PYGZus{}tdcs} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{baseline\PYGZus{}train\PYGZus{}acc} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{tdcs\PYGZus{}train\PYGZus{}acc} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{baseline\PYGZus{}test\PYGZus{}acc} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{tdcs\PYGZus{}test\PYGZus{}acc} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Train baseline model}
        \PYG{n}{model\PYGZus{}baseline}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{total} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{targets} \PYG{o+ow}{in} \PYG{n}{train\PYGZus{}loader}\PYG{p}{:}
            \PYG{n}{optimizer\PYGZus{}baseline}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model\PYGZus{}baseline}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer\PYGZus{}baseline}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n}{pred} \PYG{o}{=} \PYG{p}{(}\PYG{n}{outputs} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{correct} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{==} \PYG{n}{targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{total} \PYG{o}{+}\PYG{o}{=} \PYG{n}{targets}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{n}{baseline\PYGZus{}train\PYGZus{}acc}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{correct} \PYG{o}{/} \PYG{n}{total}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Train tDCS model}
        \PYG{n}{model\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{total} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{targets} \PYG{o+ow}{in} \PYG{n}{train\PYGZus{}loader}\PYG{p}{:}
            \PYG{n}{optimizer\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model\PYGZus{}tdcs}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n}{pred} \PYG{o}{=} \PYG{p}{(}\PYG{n}{outputs} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{correct} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{==} \PYG{n}{targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{total} \PYG{o}{+}\PYG{o}{=} \PYG{n}{targets}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{n}{tdcs\PYGZus{}train\PYGZus{}acc}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{correct} \PYG{o}{/} \PYG{n}{total}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate on test set}
        \PYG{n}{model\PYGZus{}baseline}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{model\PYGZus{}tdcs}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{baseline\PYGZus{}correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{tdcs\PYGZus{}correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{total} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{targets} \PYG{o+ow}{in} \PYG{n}{test\PYGZus{}loader}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Baseline model}
                \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model\PYGZus{}baseline}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
                \PYG{n}{pred} \PYG{o}{=} \PYG{p}{(}\PYG{n}{outputs} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
                \PYG{n}{baseline\PYGZus{}correct} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{==} \PYG{n}{targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} tDCS model}
                \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model\PYGZus{}tdcs}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
                \PYG{n}{pred} \PYG{o}{=} \PYG{p}{(}\PYG{n}{outputs} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
                \PYG{n}{tdcs\PYGZus{}correct} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{==} \PYG{n}{targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{n}{total} \PYG{o}{+}\PYG{o}{=} \PYG{n}{targets}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{n}{baseline\PYGZus{}test\PYGZus{}acc}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{baseline\PYGZus{}correct} \PYG{o}{/} \PYG{n}{total}\PYG{p}{)}
        \PYG{n}{tdcs\PYGZus{}test\PYGZus{}acc}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{tdcs\PYGZus{}correct} \PYG{o}{/} \PYG{n}{total}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{baseline\PYGZus{}train\PYGZus{}acc}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Baseline}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{tdcs\PYGZus{}train\PYGZus{}acc}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{With tDCS}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{baseline\PYGZus{}test\PYGZus{}acc}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Baseline}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{tdcs\PYGZus{}test\PYGZus{}acc}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{With tDCS}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Effect of Simulated tDCS on Learning Performance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.05}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Final test accuracy (Baseline): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{baseline\PYGZus{}test\PYGZus{}acc}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Final test accuracy (With tDCS): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{tdcs\PYGZus{}test\PYGZus{}acc}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improvement with tDCS: }\PYG{l+s+si}{\PYGZob{}}\PYG{p}{(}\PYG{n}{tdcs\PYGZus{}test\PYGZus{}acc}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{baseline\PYGZus{}test\PYGZus{}acc}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{100}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This simulation demonstrates how tDCS\sphinxhyphen{}like stimulation of relevant neural populations can accelerate learning and improve performance, paralleling findings from neurostimulation research in humans.


\subsection{Modeling Neuromodulatory Systems}
\label{\detokenize{part2/ch06_neurostimulation:modeling-neuromodulatory-systems}}
\sphinxAtStartPar
This example simulates how different neuromodulatory “states” (implemented as learning rate schedules) affect neural network training:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}neuromodulatory\PYGZus{}states}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare how different neuromodulatory states (learning rate schedules) affect learning\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate data}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{generate\PYGZus{}toy\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}data} \PYG{o}{=} \PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{train\PYGZus{}data}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create models with identical initialization}
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{model1} \PYG{o}{=} \PYG{n}{SimpleNet}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} \PYGZdq{}Baseline\PYGZdq{} state}
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{model2} \PYG{o}{=} \PYG{n}{SimpleNet}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} \PYGZdq{}Dopaminergic\PYGZdq{} state (high initial learning rate)}
    \PYG{n}{torch}\PYG{o}{.}\PYG{n}{manual\PYGZus{}seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{model3} \PYG{o}{=} \PYG{n}{SimpleNet}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} \PYGZdq{}Noradrenergic\PYGZdq{} state (cyclical learning rate)}
    
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{l+m+mi}{50}
    
    \PYG{c+c1}{\PYGZsh{} Train with different learning rate schedules (neuromodulatory states)}
    \PYG{n}{losses1}\PYG{p}{,} \PYG{n}{lrs1} \PYG{o}{=} \PYG{n}{train\PYGZus{}with\PYGZus{}lr\PYGZus{}schedule}\PYG{p}{(}\PYG{n}{model1}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{epochs}\PYG{p}{,} 
                                           \PYG{k}{lambda} \PYG{n}{e}\PYG{p}{:} \PYG{n}{constant\PYGZus{}lr}\PYG{p}{(}\PYG{n}{e}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{losses2}\PYG{p}{,} \PYG{n}{lrs2} \PYG{o}{=} \PYG{n}{train\PYGZus{}with\PYGZus{}lr\PYGZus{}schedule}\PYG{p}{(}\PYG{n}{model2}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{epochs}\PYG{p}{,} 
                                           \PYG{k}{lambda} \PYG{n}{e}\PYG{p}{:} \PYG{n}{decaying\PYGZus{}lr}\PYG{p}{(}\PYG{n}{e}\PYG{p}{,} \PYG{n}{initial\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{decay}\PYG{o}{=}\PYG{l+m+mf}{0.9}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{losses3}\PYG{p}{,} \PYG{n}{lrs3} \PYG{o}{=} \PYG{n}{train\PYGZus{}with\PYGZus{}lr\PYGZus{}schedule}\PYG{p}{(}\PYG{n}{model3}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{epochs}\PYG{p}{,} 
                                           \PYG{k}{lambda} \PYG{n}{e}\PYG{p}{:} \PYG{n}{cyclical\PYGZus{}lr}\PYG{p}{(}\PYG{n}{e}\PYG{p}{,} \PYG{n}{min\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{n}{max\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Baseline State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dopaminergic State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noradrenergic State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Curves with Different Neuromodulatory States}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lrs1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Baseline State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lrs2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dopaminergic State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lrs3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noradrenergic State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuromodulatory State Dynamics}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This example illustrates how different neuromodulatory “states” can optimize learning for different situations \sphinxhyphen{} consistent learning for stable environments (baseline), rapid early learning for salient rewards (dopaminergic), or attention to both global patterns and local details (noradrenergic).


\section{6.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part2/ch06_neurostimulation:take-aways}}
\sphinxAtStartPar
This chapter has explored the fundamental mechanisms of neural plasticity, the neuromodulatory systems that regulate them, and the neurostimulation techniques that can influence them. Key insights include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural plasticity operates on multiple timescales and through various mechanisms}
\begin{itemize}
\item {} 
\sphinxAtStartPar
From rapid synaptic changes (LTP/LTD, STDP) to slower structural remodeling

\item {} 
\sphinxAtStartPar
Both Hebbian and homeostatic processes are necessary for stable learning

\item {} 
\sphinxAtStartPar
Different brain regions maintain different plasticity capacities throughout life

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromodulatory systems act as the brain’s control panel for learning and adaptation}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dopamine signals reward prediction errors and drives reinforcement learning

\item {} 
\sphinxAtStartPar
Acetylcholine enhances attention and regulates signal\sphinxhyphen{}to\sphinxhyphen{}noise ratio

\item {} 
\sphinxAtStartPar
Norepinephrine modulates arousal and exploration\sphinxhyphen{}exploitation balance

\item {} 
\sphinxAtStartPar
Serotonin influences mood, impulsivity, and temporal discounting

\item {} 
\sphinxAtStartPar
These systems interact in complex ways to orchestrate adaptive behavior

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neurostimulation techniques provide tools to modulate brain activity and plasticity}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}invasive methods (tDCS, TMS) offer accessible approaches to influence cortical function

\item {} 
\sphinxAtStartPar
Invasive techniques (DBS) provide more targeted modulation for clinical conditions

\item {} 
\sphinxAtStartPar
Effects depend on stimulation parameters, brain state, and individual differences

\item {} 
\sphinxAtStartPar
Most effective when combined with behavioral training or rehabilitation

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational models bridge neuroscience and AI}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Reinforcement learning algorithms parallel dopaminergic learning systems

\item {} 
\sphinxAtStartPar
Biologically\sphinxhyphen{}inspired plasticity rules offer alternatives to backpropagation

\item {} 
\sphinxAtStartPar
Meta\sphinxhyphen{}learning and neuromodulation share conceptual frameworks

\item {} 
\sphinxAtStartPar
Stimulation and fine\sphinxhyphen{}tuning use similar principles to enhance learning in existing networks

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive enhancement applications span multiple domains}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Memory augmentation through targeted stimulation of memory circuits

\item {} 
\sphinxAtStartPar
Attention modulation by enhancing relevant networks

\item {} 
\sphinxAtStartPar
Motor learning facilitation through optimized plasticity in motor circuits

\item {} 
\sphinxAtStartPar
Clinical applications for rehabilitation, treatment, and cognitive preservation

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
Understanding the interplay between plasticity mechanisms, neuromodulatory systems, and external stimulation not only advances our knowledge of the brain but also inspires new approaches to artificial intelligence. As these fields continue to converge, we can expect increasingly sophisticated models of learning and adaptation that draw from the remarkable flexibility of biological neural systems.


\section{6.8 Further Reading \& Media}
\label{\detokenize{part2/ch06_neurostimulation:further-reading-media}}

\subsection{Neural Plasticity}
\label{\detokenize{part2/ch06_neurostimulation:neural-plasticity}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Citri, A., \& Malenka, R. C. (2008). “Synaptic plasticity: multiple forms, functions, and mechanisms.” \sphinxstyleemphasis{Neuropsychopharmacology}, 33(1), 18\sphinxhyphen{}41.

\item {} 
\sphinxAtStartPar
Zenke, F., Agnes, E. J., \& Gerstner, W. (2015). “Diverse synaptic plasticity mechanisms orchestrated to form and retrieve memories in spiking neural networks.” \sphinxstyleemphasis{Nature Communications}, 6(1), 1\sphinxhyphen{}13.

\item {} 
\sphinxAtStartPar
Turrigiano, G. (2012). “Homeostatic synaptic plasticity: local and global mechanisms for stabilizing neuronal function.” \sphinxstyleemphasis{Cold Spring Harbor Perspectives in Biology}, 4(1), a005736.

\end{itemize}


\subsection{Neuromodulatory Systems}
\label{\detokenize{part2/ch06_neurostimulation:id1}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Dayan, P., \& Yu, A. J. (2006). “Phasic norepinephrine: a neural interrupt signal for unexpected events.” \sphinxstyleemphasis{Network: Computation in Neural Systems}, 17(4), 335\sphinxhyphen{}350.

\item {} 
\sphinxAtStartPar
Schultz, W. (2016). “Dopamine reward prediction error coding.” \sphinxstyleemphasis{Dialogues in Clinical Neuroscience}, 18(1), 23\sphinxhyphen{}32.

\item {} 
\sphinxAtStartPar
Avery, M. C., \& Krichmar, J. L. (2017). “Neuromodulatory systems and their interactions: a review of models, theories, and experiments.” \sphinxstyleemphasis{Frontiers in Neural Circuits}, 11, 108.

\end{itemize}


\subsection{Brain Stimulation}
\label{\detokenize{part2/ch06_neurostimulation:brain-stimulation}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Nitsche, M. A., \& Paulus, W. (2011). “Transcranial direct current stimulation–update 2011.” \sphinxstyleemphasis{Restorative Neurology and Neuroscience}, 29(6), 463\sphinxhyphen{}492.

\item {} 
\sphinxAtStartPar
Polanía, R., Nitsche, M. A., \& Ruff, C. C. (2018). “Studying and modifying brain function with non\sphinxhyphen{}invasive brain stimulation.” \sphinxstyleemphasis{Nature Neuroscience}, 21(2), 174\sphinxhyphen{}187.

\item {} 
\sphinxAtStartPar
Johnson, M. D., Lim, H. H., Netoff, T. I., Connolly, A. T., Johnson, N., Roy, A., … \& Vitek, J. L. (2013). “Neuromodulation for brain disorders: challenges and opportunities.” \sphinxstyleemphasis{IEEE Transactions on Biomedical Engineering}, 60(3), 610\sphinxhyphen{}624.

\end{itemize}


\subsection{Computational Models and AI}
\label{\detokenize{part2/ch06_neurostimulation:computational-models-and-ai}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Marblestone, A. H., Wayne, G., \& Kording, K. P. (2016). “Toward an integration of deep learning and neuroscience.” \sphinxstyleemphasis{Frontiers in Computational Neuroscience}, 10, 94.

\item {} 
\sphinxAtStartPar
Richards, B. A., Lillicrap, T. P., Beaudoin, P., Bengio, Y., Bogacz, R., Christensen, A., … \& Kording, K. P. (2019). “A deep learning framework for neuroscience.” \sphinxstyleemphasis{Nature Neuroscience}, 22(11), 1761\sphinxhyphen{}1770.

\item {} 
\sphinxAtStartPar
Wang, J. X., Kurth\sphinxhyphen{}Nelson, Z., Kumaran, D., Tirumala, D., Soyer, H., Leibo, J. Z., … \& Botvinick, M. (2018). “Prefrontal cortex as a meta\sphinxhyphen{}reinforcement learning system.” \sphinxstyleemphasis{Nature Neuroscience}, 21(6), 860\sphinxhyphen{}868.

\end{itemize}


\subsection{Videos and Online Resources}
\label{\detokenize{part2/ch06_neurostimulation:videos-and-online-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
“Brain Hacking: Does tDCS make you smarter?” (Seeker YouTube channel)

\item {} 
\sphinxAtStartPar
“The Plastic Brain” (BBC documentary on neuroplasticity)

\item {} 
\sphinxAtStartPar
Two Minute Papers: “AI Learns to Learn (Meta\sphinxhyphen{}learning)”

\item {} 
\sphinxAtStartPar
Neuromatch Academy \sphinxhyphen{} Computational Neuroscience course (online lectures on plasticity and learning)

\item {} 
\sphinxAtStartPar
Huberman Lab Podcast \sphinxhyphen{} Episodes on neuroplasticity and neuromodulation

\end{itemize}

\sphinxstepscope


\chapter{Chapter 7: Information Theory Essentials}
\label{\detokenize{part2/ch07_information_theory:chapter-7-information-theory-essentials}}\label{\detokenize{part2/ch07_information_theory::doc}}

\section{7.0 Chapter Goals}
\label{\detokenize{part2/ch07_information_theory:chapter-goals}}
\sphinxAtStartPar
Information theory provides essential mathematical tools for quantifying and analyzing information processing in both neural and artificial systems. By the end of this chapter, you should be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Calculate and interpret fundamental information\sphinxhyphen{}theoretic measures like entropy, mutual information, and KL divergence

\item {} 
\sphinxAtStartPar
Apply information\sphinxhyphen{}theoretic analyses to neural data and understand their implications

\item {} 
\sphinxAtStartPar
Implement efficient coding principles in computational models

\item {} 
\sphinxAtStartPar
Explain how information theory connects neuroscience and machine learning

\item {} 
\sphinxAtStartPar
Use Python to compute information measures on various types of data

\end{itemize}


\section{7.1 Fundamentals of Information Theory}
\label{\detokenize{part2/ch07_information_theory:fundamentals-of-information-theory}}

\subsection{Shannon’s Entropy: Quantifying Uncertainty}
\label{\detokenize{part2/ch07_information_theory:shannon-s-entropy-quantifying-uncertainty}}
\sphinxAtStartPar
The central concept in information theory is entropy, which measures the uncertainty or randomness in a probability distribution. For a discrete random variable \(X\) with possible values \(\{x_1, x_2, ..., x_n\}\) and probability mass function \(p(x)\), the entropy \(H(X)\) is defined as:
\begin{equation*}
\begin{split}H(X) = -\sum_{i=1}^{n} p(x_i) \log_2 p(x_i)\end{split}
\end{equation*}
\sphinxAtStartPar
\sphinxincludegraphics{{entropy_illustration}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 7.1: The binary entropy function showing how uncertainty is maximized at p=0.5 (equal probabilities) and minimized at p=0 or p=1 (complete certainty).}

\sphinxAtStartPar
Entropy is measured in bits when using log base 2, and represents the average number of bits needed to encode values of the random variable. A few key properties:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Entropy is always non\sphinxhyphen{}negative

\item {} 
\sphinxAtStartPar
Entropy is maximized when all outcomes are equally likely

\item {} 
\sphinxAtStartPar
Entropy is minimized (zero) when one outcome has probability 1

\end{itemize}

\begin{sphinxadmonition}{note}{Applications in AI and Real Life}

\sphinxAtStartPar
\sphinxstylestrong{AI Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model Evaluation}: Models with lower entropy predictions are more confident (though not necessarily correct)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model Compression}: Information\sphinxhyphen{}theoretic principles guide model pruning and quantization

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Learning Algorithms}: Maximum entropy methods provide a principled approach to machine learning when knowledge is limited

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Selection}: High\sphinxhyphen{}entropy features typically carry more information for classification tasks

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Real\sphinxhyphen{}World Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data Compression}: ZIP, JPEG, PNG all rely on entropy coding techniques (Huffman, arithmetic coding)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cryptography}: Secure encryption requires high\sphinxhyphen{}entropy (unpredictable) keys

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Natural Language Processing}: Language models estimate word probabilities and maximize entropy for diverse generation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience}: Neural spike patterns can be analyzed to determine information content

\end{itemize}
\end{sphinxadmonition}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{entropy}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate the Shannon entropy of a probability distribution.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        p: array of probabilities that sum to 1}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        entropy value in bits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Remove zeros to avoid log(0) issues}
    \PYG{n}{p} \PYG{o}{=} \PYG{n}{p}\PYG{p}{[}\PYG{n}{p} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example: Calculate entropy of a fair coin toss}
\PYG{n}{p\PYGZus{}fair} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Entropy of fair coin: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{entropy}\PYG{p}{(}\PYG{n}{p\PYGZus{}fair}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example: Calculate entropy of a biased coin toss}
\PYG{n}{p\PYGZus{}biased} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{]}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Entropy of biased coin: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{entropy}\PYG{p}{(}\PYG{n}{p\PYGZus{}biased}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize entropy for a binary variable as p varies from 0 to 1}
\PYG{n}{p\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{l+m+mf}{0.999}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{entropies} \PYG{o}{=} \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{p}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{p}\PYG{p}{)}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{p}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{p\PYGZus{}values}\PYG{p}{]}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{p\PYGZus{}values}\PYG{p}{,} \PYG{n}{entropies}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Probability of outcome 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy of a Binary Variable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Joint and Conditional Entropy}
\label{\detokenize{part2/ch07_information_theory:joint-and-conditional-entropy}}
\sphinxAtStartPar
For two random variables \(X\) and \(Y\), the joint entropy \(H(X,Y)\) measures the combined uncertainty:
\begin{equation*}
\begin{split}H(X,Y) = -\sum_{x \in X} \sum_{y \in Y} p(x,y) \log_2 p(x,y)\end{split}
\end{equation*}
\sphinxAtStartPar
Conditional entropy \(H(Y|X)\) quantifies the remaining uncertainty in \(Y\) after observing \(X\):
\begin{equation*}
\begin{split}H(Y|X) = -\sum_{x \in X} p(x) \sum_{y \in Y} p(y|x) \log_2 p(y|x)\end{split}
\end{equation*}
\sphinxAtStartPar
The chain rule of entropy relates these concepts:
\begin{equation*}
\begin{split}H(X,Y) = H(X) + H(Y|X)\end{split}
\end{equation*}

\subsection{Mutual Information: Quantifying Shared Information}
\label{\detokenize{part2/ch07_information_theory:mutual-information-quantifying-shared-information}}
\sphinxAtStartPar
Mutual information \(I(X;Y)\) measures the reduction in uncertainty about one variable given knowledge of another:
\begin{equation*}
\begin{split}I(X;Y) = H(X) - H(X|Y) = H(Y) - H(Y|X) = H(X) + H(Y) - H(X,Y)\end{split}
\end{equation*}
\sphinxAtStartPar
\sphinxincludegraphics{{mutual_information}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 7.2: Venn diagram representation of mutual information as the overlap between entropies of X and Y, showing the relationship between joint, conditional, and marginal entropies.}

\sphinxAtStartPar
This symmetric measure ranges from 0 (independent variables) to \(\min(H(X), H(Y))\) (one variable completely determines the other).

\begin{sphinxadmonition}{note}{Mutual Information in AI and Neuroscience}

\sphinxAtStartPar
\sphinxstylestrong{AI Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Selection}: MI identifies which features provide the most information about target classes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Representation Learning}: Maximizing MI between representations and inputs in self\sphinxhyphen{}supervised learning (e.g., InfoNCE loss in contrastive learning)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model Interpretability}: MI can measure which neurons/features capture important input attributes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Information Bottleneck}: Networks trained to maximize MI with targets while minimizing MI with inputs generalize better

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Coding}: Quantifies how much information spike trains carry about stimuli

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain Connectivity}: Functional connectivity between brain regions can be measured using MI

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory Processing}: MI helps analyze how sensory information is transformed through neural pathways

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Population Decoding}: Reveals which groups of neurons collectively encode behaviorally relevant information

\end{itemize}
\end{sphinxadmonition}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{mutual\PYGZus{}information}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate the mutual information between two continuous variables.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        x, y: arrays of observations}
\PYG{l+s+sd}{        bins: number of bins for discretization}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        mutual information value in bits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create joint histogram}
    \PYG{n}{joint\PYGZus{}hist}\PYG{p}{,} \PYG{n}{x\PYGZus{}edges}\PYG{p}{,} \PYG{n}{y\PYGZus{}edges} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram2d}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bins}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize to get joint probability}
    \PYG{n}{joint\PYGZus{}prob} \PYG{o}{=} \PYG{n}{joint\PYGZus{}hist} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}hist}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get marginal probabilities}
    \PYG{n}{x\PYGZus{}prob} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}prob} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate mutual information}
    \PYG{n}{mi} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{mi} \PYG{o}{+}\PYG{o}{=} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{/} \PYG{p}{(}\PYG{n}{x\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{*} \PYG{n}{y\PYGZus{}prob}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{mi}

\PYG{c+c1}{\PYGZsh{} Example: Mutual information between correlated variables}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n} \PYG{o}{=} \PYG{l+m+mi}{1000}
\PYG{c+c1}{\PYGZsh{} Generate correlated data}
\PYG{n}{corr} \PYG{o}{=} \PYG{l+m+mf}{0.8}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{corr} \PYG{o}{*} \PYG{n}{x} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{corr}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mutual information: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mutual\PYGZus{}information}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{y}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize MI for different correlation values}
\PYG{n}{correlation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.99}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n}{mi\PYGZus{}values} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n}{correlation}\PYG{p}{:}
    \PYG{n}{y\PYGZus{}corr} \PYG{o}{=} \PYG{n}{c} \PYG{o}{*} \PYG{n}{x} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{c}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}
    \PYG{n}{mi\PYGZus{}values}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mutual\PYGZus{}information}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y\PYGZus{}corr}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{correlation}\PYG{p}{,} \PYG{n}{mi\PYGZus{}values}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation coefficient}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual information (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information vs. Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Kullback\sphinxhyphen{}Leibler Divergence}
\label{\detokenize{part2/ch07_information_theory:kullback-leibler-divergence}}
\sphinxAtStartPar
The KL divergence \(D_{KL}(P||Q)\) measures how one probability distribution \(P\) differs from a reference distribution \(Q\):
\begin{equation*}
\begin{split}D_{KL}(P||Q) = \sum_{i} P(i) \log_2 \frac{P(i)}{Q(i)}\end{split}
\end{equation*}
\sphinxAtStartPar
Key properties:
\begin{itemize}
\item {} 
\sphinxAtStartPar
KL divergence is always non\sphinxhyphen{}negative

\item {} 
\sphinxAtStartPar
\(D_{KL}(P||Q) = 0\) if and only if \(P = Q\)

\item {} 
\sphinxAtStartPar
KL divergence is non\sphinxhyphen{}symmetric: \(D_{KL}(P||Q) \neq D_{KL}(Q||P)\)

\end{itemize}

\sphinxAtStartPar
A symmetrized version is the Jensen\sphinxhyphen{}Shannon divergence:
\begin{equation*}
\begin{split}JSD(P||Q) = \frac{1}{2}D_{KL}(P||M) + \frac{1}{2}D_{KL}(Q||M)\end{split}
\end{equation*}
\sphinxAtStartPar
where \(M = \frac{1}{2}(P + Q)\).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{kl\PYGZus{}divergence}\PYG{p}{(}\PYG{n}{p}\PYG{p}{,} \PYG{n}{q}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate the KL divergence between two distributions.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        p, q: array of probabilities that sum to 1}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        KL divergence in bits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Filter out zeros to avoid division issues}
    \PYG{n}{mask} \PYG{o}{=} \PYG{p}{(}\PYG{n}{p} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{q} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{p}\PYG{p}{,} \PYG{n}{q} \PYG{o}{=} \PYG{n}{p}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{,} \PYG{n}{q}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{]}
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p} \PYG{o}{/} \PYG{n}{q}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example: KL divergence between Gaussians}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{n}{p} \PYG{o}{=} \PYG{n}{stats}\PYG{o}{.}\PYG{n}{norm}\PYG{o}{.}\PYG{n}{pdf}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Standard normal}
\PYG{n}{q} \PYG{o}{=} \PYG{n}{stats}\PYG{o}{.}\PYG{n}{norm}\PYG{o}{.}\PYG{n}{pdf}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Shifted and wider normal}

\PYG{c+c1}{\PYGZsh{} Normalize to ensure they sum to 1}
\PYG{n}{p} \PYG{o}{=} \PYG{n}{p} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}
\PYG{n}{q} \PYG{o}{=} \PYG{n}{q} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{q}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{KL(P||Q): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{kl\PYGZus{}divergence}\PYG{p}{(}\PYG{n}{p}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{q}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{KL(Q||P): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{kl\PYGZus{}divergence}\PYG{p}{(}\PYG{n}{q}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{p}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{p}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{P \PYGZti{} N(0,1)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{q}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Q \PYGZti{} N(1,1.5)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Probability density}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KL Divergence Between Distributions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Channel Capacity}
\label{\detokenize{part2/ch07_information_theory:channel-capacity}}
\sphinxAtStartPar
In communication systems, channel capacity represents the maximum rate at which information can be transmitted reliably over a noisy channel. For a discrete memoryless channel, the capacity \(C\) is:
\begin{equation*}
\begin{split}C = \max_{p(x)} I(X;Y)\end{split}
\end{equation*}
\sphinxAtStartPar
where \(p(x)\) is the input distribution. For a Gaussian channel with signal power \(P\) and noise power \(N\), the capacity is:
\begin{equation*}
\begin{split}C = \frac{1}{2}\log_2(1 + \frac{P}{N})\end{split}
\end{equation*}
\sphinxAtStartPar
This concept is crucial in neuroscience for understanding the information\sphinxhyphen{}carrying capacity of neural circuits.

\begin{sphinxadmonition}{note}{Channel Capacity in Neural and Artificial Systems}

\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Implications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Bandwidth}: Limits how much information a single neuron can transmit (typically 2\sphinxhyphen{}3 bits per spike)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Population Coding}: Brain overcomes single\sphinxhyphen{}neuron capacity limits by distributing information across many neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Energy Constraints}: Neurons balance information transmission against metabolic costs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory Bottlenecks}: Optic nerve’s \textasciitilde{}1 million axons create an information bottleneck requiring efficient coding

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Engineering Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Communication Systems}: Shannon’s capacity theorem revolutionized telecommunications by establishing fundamental limits

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{5G Networks}: Modern wireless systems approach Shannon capacity with sophisticated coding (LDPC, turbo codes)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Interfaces}: Designing optimal neural recording/stimulation devices requires understanding neural channel capacities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AI System Design}: Network width and depth choices implicitly reflect channel capacity considerations

\end{itemize}
\end{sphinxadmonition}


\section{7.2 Neural Coding \& Efficiency}
\label{\detokenize{part2/ch07_information_theory:neural-coding-efficiency}}

\subsection{Efficient Coding Hypothesis}
\label{\detokenize{part2/ch07_information_theory:efficient-coding-hypothesis}}
\sphinxAtStartPar
Proposed by Horace Barlow in the 1960s, the efficient coding hypothesis states that sensory systems have evolved to efficiently represent natural stimuli by reducing redundancy and maximizing information transmission given metabolic constraints.

\sphinxAtStartPar
\sphinxincludegraphics{{efficient_coding}.svg}

\sphinxAtStartPar
\sphinxstyleemphasis{Figure 7.3: Efficient coding principles in neural systems. The brain adapts to input statistics to create representations that maximize information while minimizing resources through redundancy reduction and sparse coding.}

\sphinxAtStartPar
Key principles:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Neurons should encode independent features of the environment

\item {} 
\sphinxAtStartPar
Neural codes should minimize redundancy

\item {} 
\sphinxAtStartPar
Coding strategies should be adapted to the statistics of natural stimuli

\end{itemize}

\begin{sphinxadmonition}{note}{Efficient Coding: From Brains to AI Systems}

\sphinxAtStartPar
\sphinxstylestrong{Biological Implementations:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual System}: Retinal ganglion cells adapt to luminance statistics; V1 neurons encode oriented edges (sparse components of natural images)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Auditory System}: Cochlear filters adapt to natural sound statistics with 1/f power distributions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Olfactory System}: Sparse odor coding with minimal overlapping representations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptation}: Sensory neurons dynamically adjust to stimulus statistics to maintain optimal information transmission

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{AI Applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sparse Autoencoders}: Learn efficient, sparse representations similar to V1 receptive fields

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive Coding Networks}: Optimize to minimize prediction errors, similar to brain’s predictive processing

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model Compression}: Pruning, quantization, and knowledge distillation guided by information\sphinxhyphen{}theoretic principles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generative Models}: VAEs and diffusion models incorporate information compression principles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Architecture Search}: Information Bottleneck principles guide efficient network design

\end{itemize}
\end{sphinxadmonition}


\subsection{Redundancy Reduction}
\label{\detokenize{part2/ch07_information_theory:redundancy-reduction}}
\sphinxAtStartPar
Natural signals contain statistical regularities and redundancies. Efficient neural coding reduces these redundancies through:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Decorrelation}: Neurons respond to different features, minimizing correlations between their activities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive coding}: Only unpredicted information is transmitted

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptation}: Sensory systems adapt to the statistics of their input

\end{enumerate}

\sphinxAtStartPar
The correlation coefficient between two neurons’ activities \(x_i\) and \(x_j\) is:
\begin{equation*}
\begin{split}\rho_{ij} = \frac{cov(x_i, x_j)}{\sigma_i \sigma_j}\end{split}
\end{equation*}
\sphinxAtStartPar
An efficient code would minimize these correlations.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}neural\PYGZus{}correlations}\PYG{p}{(}\PYG{n}{spike\PYGZus{}trains}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate pairwise correlations between neural spike trains.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}trains: array of shape (n\PYGZus{}neurons, n\PYGZus{}timepoints)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        correlation matrix of shape (n\PYGZus{}neurons, n\PYGZus{}neurons)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{spike\PYGZus{}trains}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{correlations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{correlations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{spike\PYGZus{}trains}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{spike\PYGZus{}trains}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{correlations}

\PYG{c+c1}{\PYGZsh{} Simulate some neural data}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{n\PYGZus{}timepoints} \PYG{o}{=} \PYG{l+m+mi}{1000}

\PYG{c+c1}{\PYGZsh{} Create correlated spike trains}
\PYG{n}{base} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}
\PYG{n}{noise\PYGZus{}level} \PYG{o}{=} \PYG{l+m+mf}{0.3}
\PYG{n}{spike\PYGZus{}trains} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{base} \PYG{o}{+} \PYG{n}{noise\PYGZus{}level} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate and visualize correlations}
\PYG{n}{corr\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}neural\PYGZus{}correlations}\PYG{p}{(}\PYG{n}{spike\PYGZus{}trains}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coolwarm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Correlation Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Check average correlation to assess redundancy}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average pairwise correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{triu}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Sparse Coding}
\label{\detokenize{part2/ch07_information_theory:sparse-coding}}
\sphinxAtStartPar
Sparse coding aims to represent input data using a small number of active neurons from a large population. This approach:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Reduces energy consumption (fewer spikes)

\item {} 
\sphinxAtStartPar
Increases memory capacity

\item {} 
\sphinxAtStartPar
Facilitates pattern recognition and generalization

\end{enumerate}

\sphinxAtStartPar
The sparseness of a neural code can be measured using the population sparseness metric:
\begin{equation*}
\begin{split}S_p = \frac{(\frac{1}{n}\sum_i |r_i|)^2}{\frac{1}{n}\sum_i r_i^2}\end{split}
\end{equation*}
\sphinxAtStartPar
where \(r_i\) is the response of neuron \(i\), and \(n\) is the number of neurons. \(S_p\) ranges from 0 (dense code) to 1 (maximally sparse).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}sparseness}\PYG{p}{(}\PYG{n}{population\PYGZus{}activity}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate population sparseness of neural activity.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        population\PYGZus{}activity: array of shape (n\PYGZus{}neurons, n\PYGZus{}samples)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        sparseness values for each sample}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{population\PYGZus{}activity}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{sparseness} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{r} \PYG{o}{=} \PYG{n}{population\PYGZus{}activity}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{r}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Avoid division by zero}
            \PYG{n}{sparseness}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{r}\PYG{p}{)}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{sparseness}

\PYG{c+c1}{\PYGZsh{} Simulate neural populations with different levels of sparseness}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{100}
\PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{10}

\PYG{c+c1}{\PYGZsh{} Dense coding (many neurons active)}
\PYG{n}{dense\PYGZus{}pop} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Sparse coding (few neurons active)}
\PYG{n}{sparse\PYGZus{}pop} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{active\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{sparse\PYGZus{}pop}\PYG{p}{[}\PYG{n}{active\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{2}

\PYG{c+c1}{\PYGZsh{} Calculate sparseness}
\PYG{n}{dense\PYGZus{}sparseness} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}sparseness}\PYG{p}{(}\PYG{n}{dense\PYGZus{}pop}\PYG{p}{)}
\PYG{n}{sparse\PYGZus{}sparseness} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}sparseness}\PYG{p}{(}\PYG{n}{sparse\PYGZus{}pop}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average sparseness (dense): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dense\PYGZus{}sparseness}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average sparseness (sparse): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{sparse\PYGZus{}sparseness}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{dense\PYGZus{}pop}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dense Population}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Sparseness: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dense\PYGZus{}sparseness}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sample}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{sparse\PYGZus{}pop}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sparse Population}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Sparseness: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{sparse\PYGZus{}sparseness}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sample}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Predictive Coding}
\label{\detokenize{part2/ch07_information_theory:predictive-coding}}
\sphinxAtStartPar
Predictive coding posits that neural systems encode and transmit only the “prediction errors” or deviations from expected input, rather than the raw sensory information. This framework:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Minimizes redundancy by transmitting only what’s unpredicted

\item {} 
\sphinxAtStartPar
Forms a hierarchical structure where higher levels predict lower levels

\item {} 
\sphinxAtStartPar
Explains phenomena like sensory adaptation and context effects

\end{enumerate}

\sphinxAtStartPar
Mathematically, if \(y\) is the sensory input and \(\hat{y}\) is the prediction, the prediction error \(e\) is:
\begin{equation*}
\begin{split}e = y - \hat{y}\end{split}
\end{equation*}
\sphinxAtStartPar
Only this error signal is transmitted, allowing for efficient resource use.


\section{7.3 Information Measures in Neuroscience}
\label{\detokenize{part2/ch07_information_theory:information-measures-in-neuroscience}}

\subsection{Spike Train Information}
\label{\detokenize{part2/ch07_information_theory:spike-train-information}}
\sphinxAtStartPar
Neural spike trains carry information through both their rate and timing patterns. To quantify this information, we can:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Direct method}: Estimate the mutual information between stimulus and response directly

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Indirect methods}: Use specific information\sphinxhyphen{}theoretic quantities like stimulus\sphinxhyphen{}specific information

\end{enumerate}

\sphinxAtStartPar
For a spike train response \(r\) to stimulus \(s\), the information transmitted is:
\begin{equation*}
\begin{split}I(S;R) = \sum_{s,r} p(s,r) \log_2 \frac{p(s,r)}{p(s)p(r)}\end{split}
\end{equation*}
\sphinxAtStartPar
This can be decomposed into different coding aspects (rate vs. timing).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{spike\PYGZus{}train\PYGZus{}information}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{response}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate mutual information between stimulus and neural response.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        stimulus: array of stimulus values}
\PYG{l+s+sd}{        response: array of neural responses to the stimulus}
\PYG{l+s+sd}{        bins: number of bins for discretization}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        mutual information in bits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Discretize continuous variables}
    \PYG{n}{s\PYGZus{}bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{)}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{r\PYGZus{}bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{response}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{response}\PYG{p}{)}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{s\PYGZus{}discrete} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{s\PYGZus{}bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    \PYG{n}{r\PYGZus{}discrete} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{response}\PYG{p}{,} \PYG{n}{r\PYGZus{}bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Calculate joint and marginal probabilities}
    \PYG{n}{joint\PYGZus{}counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{,} \PYG{n}{bins}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{s}\PYG{p}{,} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{s\PYGZus{}discrete}\PYG{p}{,} \PYG{n}{r\PYGZus{}discrete}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{joint\PYGZus{}counts}\PYG{p}{[}\PYG{n}{s}\PYG{p}{,} \PYG{n}{r}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{n}{joint\PYGZus{}prob} \PYG{o}{=} \PYG{n}{joint\PYGZus{}counts} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}counts}\PYG{p}{)}
    \PYG{n}{s\PYGZus{}prob} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{r\PYGZus{}prob} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate mutual information}
    \PYG{n}{mi} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{s}\PYG{p}{,} \PYG{n}{r}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{mi} \PYG{o}{+}\PYG{o}{=} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{s}\PYG{p}{,} \PYG{n}{r}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{s}\PYG{p}{,} \PYG{n}{r}\PYG{p}{]} \PYG{o}{/} \PYG{p}{(}\PYG{n}{s\PYGZus{}prob}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{*} \PYG{n}{r\PYGZus{}prob}\PYG{p}{[}\PYG{n}{r}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{mi}

\PYG{c+c1}{\PYGZsh{} Simulate neural tuning curves}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{l+m+mi}{1000}
\PYG{n}{stimulus} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Stimulus orientation}

\PYG{c+c1}{\PYGZsh{} Neuron with orientation tuning}
\PYG{n}{preferred\PYGZus{}orientation} \PYG{o}{=} \PYG{l+m+mi}{0}
\PYG{n}{tuning\PYGZus{}width} \PYG{o}{=} \PYG{l+m+mf}{0.5}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{stim}\PYG{p}{,} \PYG{n}{preferred}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Von Mises tuning curve (circular Gaussian)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{stim} \PYG{o}{\PYGZhy{}} \PYG{n}{preferred}\PYG{p}{)} \PYG{o}{/} \PYG{n}{width}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{width}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Generate noisy neural responses}
\PYG{n}{mean\PYGZus{}response} \PYG{o}{=} \PYG{n}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{preferred\PYGZus{}orientation}\PYG{p}{,} \PYG{n}{tuning\PYGZus{}width}\PYG{p}{)}
\PYG{n}{response} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{poisson}\PYG{p}{(}\PYG{n}{mean\PYGZus{}response} \PYG{o}{*} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Poisson spiking}

\PYG{c+c1}{\PYGZsh{} Calculate information}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stimulus\PYGZhy{}response information: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{spike\PYGZus{}train\PYGZus{}information}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{response}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize tuning curve}
\PYG{n}{stim\PYGZus{}range} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{tuning} \PYG{o}{=} \PYG{n}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{stim\PYGZus{}range}\PYG{p}{,} \PYG{n}{preferred\PYGZus{}orientation}\PYG{p}{,} \PYG{n}{tuning\PYGZus{}width}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{stim\PYGZus{}range}\PYG{p}{,} \PYG{n}{tuning}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stimulus orientation (rad)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean response}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Tuning Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{response}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stimulus orientation (rad)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noisy Neural Responses}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Neural Decoding Approaches}
\label{\detokenize{part2/ch07_information_theory:neural-decoding-approaches}}
\sphinxAtStartPar
Neural decoding aims to recover stimulus information from neural activity. Information\sphinxhyphen{}theoretic approaches include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Maximum likelihood decoding}: \(\hat{s} = \arg\max_s p(r|s)\)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bayesian decoding}: \(p(s|r) \propto p(r|s)p(s)\)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Population vector decoding}: Using the combined activity of a neural population

\end{enumerate}

\sphinxAtStartPar
The decoding accuracy provides a lower bound on the information content of neural activity.


\subsection{Information Bottleneck Theory}
\label{\detokenize{part2/ch07_information_theory:information-bottleneck-theory}}
\sphinxAtStartPar
Information bottleneck theory, introduced by Tishby et al., provides a framework for understanding the trade\sphinxhyphen{}off between compression and prediction in neural systems. The objective is to find a compressed representation \(T\) of input \(X\) that preserves relevant information about output \(Y\):
\begin{equation*}
\begin{split}\min_{p(t|x)} I(X;T) - \beta I(T;Y)\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\beta\) controls the trade\sphinxhyphen{}off between compression \((I(X;T))\) and prediction \((I(T;Y))\).

\sphinxAtStartPar
This has found applications in understanding neural coding and deep learning.


\subsection{Representational Similarity Analysis}
\label{\detokenize{part2/ch07_information_theory:representational-similarity-analysis}}
\sphinxAtStartPar
Representational Similarity Analysis (RSA) compares representational geometries between brain regions or between brains and models. The key steps are:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Compute representational dissimilarity matrices (RDMs) for neural data and models

\item {} 
\sphinxAtStartPar
Compare these RDMs using correlation or other metrics

\end{enumerate}

\sphinxAtStartPar
The information shared between representations can be quantified using metrics based on KL divergence or mutual information.


\section{7.4 Noise, Variability \& Information}
\label{\detokenize{part2/ch07_information_theory:noise-variability-information}}

\subsection{Signal vs Noise in Neural Systems}
\label{\detokenize{part2/ch07_information_theory:signal-vs-noise-in-neural-systems}}
\sphinxAtStartPar
Neural systems exhibit intrinsic variability that affects information processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural variability}: Spike count variance often follows Poisson statistics (variance ≈ mean)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Signal\sphinxhyphen{}to\sphinxhyphen{}noise ratio (SNR)}: \(SNR = \frac{\sigma_{signal}^2}{\sigma_{noise}^2}\)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Fisher information}: Measures how well a parameter can be estimated from noisy observations

\end{enumerate}

\sphinxAtStartPar
The Cramér\sphinxhyphen{}Rao lower bound states that the variance of any unbiased estimator is at least as high as the inverse of the Fisher information.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}snr}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{noise}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate signal\PYGZhy{}to\PYGZhy{}noise ratio.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        signal: array of signal values}
\PYG{l+s+sd}{        noise: array of noise values}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        SNR in decibels}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{signal\PYGZus{}power} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{signal}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{noise\PYGZus{}power} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{noise}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{snr} \PYG{o}{=} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{signal\PYGZus{}power} \PYG{o}{/} \PYG{n}{noise\PYGZus{}power}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{snr}

\PYG{c+c1}{\PYGZsh{} Simulate signal with noise}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{n}{signal} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}
\PYG{n}{noise\PYGZus{}levels} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{]}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{noise\PYGZus{}levels}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{noise} \PYG{o}{=} \PYG{n}{noise\PYGZus{}level} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{noisy\PYGZus{}signal} \PYG{o}{=} \PYG{n}{signal} \PYG{o}{+} \PYG{n}{noise}
    
    \PYG{n}{snr} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}snr}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{noise}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{signal}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{noisy\PYGZus{}signal}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noisy signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noise level: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{noise\PYGZus{}level}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, SNR: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{snr}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ dB}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Stochastic Resonance}
\label{\detokenize{part2/ch07_information_theory:stochastic-resonance}}
\sphinxAtStartPar
Stochastic resonance is a counter\sphinxhyphen{}intuitive phenomenon where adding noise to a system can enhance signal detection. In neural systems, moderate noise can help weak signals cross thresholds that they wouldn’t reach otherwise.

\sphinxAtStartPar
The information transmission in a system with stochastic resonance follows an inverted U\sphinxhyphen{}shape as a function of noise intensity: too little noise doesn’t help, while too much noise overwhelms the signal.


\subsection{Population Coding Strategies}
\label{\detokenize{part2/ch07_information_theory:population-coding-strategies}}
\sphinxAtStartPar
Neural systems use population coding to improve reliability and increase information content. Key strategies include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Redundant coding}: Multiple neurons encode similar information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distributed coding}: Information is spread across many neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Correlation structure}: The pattern of correlations affects information content

\end{enumerate}

\sphinxAtStartPar
The information capacity of a population of \(n\) independent neurons can scale linearly with \(n\), but correlations typically reduce this capacity.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}population\PYGZus{}coding}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{correlation}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate a population of neurons with specified correlation structure.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        n\PYGZus{}neurons: number of neurons in the population}
\PYG{l+s+sd}{        correlation: correlation coefficient between neurons}
\PYG{l+s+sd}{        n\PYGZus{}trials: number of trials to simulate}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        population activity matrix of shape (n\PYGZus{}neurons, n\PYGZus{}trials)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create correlation matrix}
    \PYG{n}{corr\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    \PYG{n}{corr\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{corr\PYGZus{}matrix} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{correlation}
    
    \PYG{c+c1}{\PYGZsh{} Cholesky decomposition to generate correlated Gaussian data}
    \PYG{n}{L} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{cholesky}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{)}
    \PYG{n}{uncorrelated} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{p}{)}
    \PYG{n}{population\PYGZus{}activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{uncorrelated}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{population\PYGZus{}activity}

\PYG{c+c1}{\PYGZsh{} Simulate populations with different correlation structures}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{20}
\PYG{n}{correlation\PYGZus{}levels} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{]}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{corr} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{correlation\PYGZus{}levels}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{population} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}population\PYGZus{}coding}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{corr}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Estimate population information capacity}
    \PYG{c+c1}{\PYGZsh{} Simple approximation based on eigenvalue spectrum of correlation matrix}
    \PYG{n}{corr\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{population}\PYG{p}{)}
    \PYG{n}{eigenvalues} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eigvalsh}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{)}
    \PYG{n}{information\PYGZus{}capacity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{eigenvalues}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coolwarm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{corr}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Info Capacity: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{information\PYGZus{}capacity}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ bits}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Bayesian Inference and Uncertainty}
\label{\detokenize{part2/ch07_information_theory:bayesian-inference-and-uncertainty}}
\sphinxAtStartPar
Neural systems appear to implement Bayesian inference, combining prior knowledge with new evidence to form posterior beliefs. Information theory helps quantify uncertainty in these computations through:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Entropy}: Representing overall uncertainty

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{KL divergence}: Measuring the information gain when updating from prior to posterior

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mutual information}: Quantifying how much new observations reduce uncertainty

\end{enumerate}

\sphinxAtStartPar
The information gained from an observation \(x\) about parameter \(\theta\) is:
\begin{equation*}
\begin{split}IG = D_{KL}(p(\theta|x) || p(\theta))\end{split}
\end{equation*}

\section{7.5 Information Flow in Networks}
\label{\detokenize{part2/ch07_information_theory:information-flow-in-networks}}

\subsection{Directed Information}
\label{\detokenize{part2/ch07_information_theory:directed-information}}
\sphinxAtStartPar
Directed information measures the causal influence of one process on another, accounting for feedback. For time series \(X^n\) and \(Y^n\), the directed information is:
\begin{equation*}
\begin{split}I(X^n \rightarrow Y^n) = \sum_{i=1}^{n} I(X^i; Y_i | Y^{i-1})\end{split}
\end{equation*}
\sphinxAtStartPar
This captures asymmetric information flow, unlike mutual information.


\subsection{Transfer Entropy}
\label{\detokenize{part2/ch07_information_theory:transfer-entropy}}
\sphinxAtStartPar
Transfer entropy quantifies the directed flow of information between systems:
\begin{equation*}
\begin{split}TE_{X \rightarrow Y} = \sum p(y_{t+1}, y_t, x_t) \log_2 \frac{p(y_{t+1} | y_t, x_t)}{p(y_{t+1} | y_t)}\end{split}
\end{equation*}
\sphinxAtStartPar
It measures how much knowing the past of \(X\) reduces uncertainty about the future of \(Y\) beyond what is already predictable from \(Y\)’s past.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}transfer\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{source}\PYG{p}{,} \PYG{n}{target}\PYG{p}{,} \PYG{n}{delay}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate transfer entropy from source to target time series.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        source: array of source time series}
\PYG{l+s+sd}{        target: array of target time series}
\PYG{l+s+sd}{        delay: time delay to consider}
\PYG{l+s+sd}{        bins: number of bins for discretization}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        transfer entropy in bits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{source}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{delay}
    
    \PYG{c+c1}{\PYGZsh{} Discretize data}
    \PYG{n}{s\PYGZus{}bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{source}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{source}\PYG{p}{)}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{t\PYGZus{}bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{target}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{target}\PYG{p}{)}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{s\PYGZus{}disc} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{source}\PYG{p}{,} \PYG{n}{s\PYGZus{}bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    \PYG{n}{t\PYGZus{}disc} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{target}\PYG{p}{,} \PYG{n}{t\PYGZus{}bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Calculate probabilities}
    \PYG{n}{p\PYGZus{}t\PYGZus{}future} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}
    \PYG{n}{p\PYGZus{}t\PYGZus{}past} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}
    \PYG{n}{p\PYGZus{}joint\PYGZus{}tt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{,} \PYG{n}{bins}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{p\PYGZus{}joint\PYGZus{}tts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{,} \PYG{n}{bins}\PYG{p}{,} \PYG{n}{bins}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{t\PYGZus{}past} \PYG{o}{=} \PYG{n}{t\PYGZus{}disc}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{n}{t\PYGZus{}future} \PYG{o}{=} \PYG{n}{t\PYGZus{}disc}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{n}{delay}\PYG{p}{]}
        \PYG{n}{s\PYGZus{}past} \PYG{o}{=} \PYG{n}{s\PYGZus{}disc}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        
        \PYG{n}{p\PYGZus{}t\PYGZus{}future}\PYG{p}{[}\PYG{n}{t\PYGZus{}future}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        \PYG{n}{p\PYGZus{}t\PYGZus{}past}\PYG{p}{[}\PYG{n}{t\PYGZus{}past}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        \PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{t\PYGZus{}past}\PYG{p}{,} \PYG{n}{t\PYGZus{}future}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        \PYG{n}{p\PYGZus{}joint\PYGZus{}tts}\PYG{p}{[}\PYG{n}{t\PYGZus{}past}\PYG{p}{,} \PYG{n}{t\PYGZus{}future}\PYG{p}{,} \PYG{n}{s\PYGZus{}past}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{n}{p\PYGZus{}t\PYGZus{}future} \PYG{o}{/}\PYG{o}{=} \PYG{n}{n}
    \PYG{n}{p\PYGZus{}t\PYGZus{}past} \PYG{o}{/}\PYG{o}{=} \PYG{n}{n}
    \PYG{n}{p\PYGZus{}joint\PYGZus{}tt} \PYG{o}{/}\PYG{o}{=} \PYG{n}{n}
    \PYG{n}{p\PYGZus{}joint\PYGZus{}tts} \PYG{o}{/}\PYG{o}{=} \PYG{n}{n}
    
    \PYG{c+c1}{\PYGZsh{} Calculate transfer entropy}
    \PYG{n}{te} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{p\PYGZus{}joint\PYGZus{}tts}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                    \PYG{n}{te} \PYG{o}{+}\PYG{o}{=} \PYG{n}{p\PYGZus{}joint\PYGZus{}tts}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p\PYGZus{}joint\PYGZus{}tts}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{*} \PYG{n}{p\PYGZus{}t\PYGZus{}past}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} 
                                                        \PYG{p}{(}\PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{*} \PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{/} \PYG{n}{p\PYGZus{}t\PYGZus{}past}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{te}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Transfer entropy should be non\PYGZhy{}negative}

\PYG{c+c1}{\PYGZsh{} Simulate coupled systems with different coupling strengths}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{1000}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{coupling\PYGZus{}strengths} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{coupling} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{coupling\PYGZus{}strengths}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} System 1 drives System 2 with specified coupling strength}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initial conditions}
    \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{y}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate coupled logistic maps}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{3.9} \PYG{o}{*} \PYG{n}{x}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{x}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Independent system}
        \PYG{n}{y}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{3.9} \PYG{o}{*} \PYG{p}{(}\PYG{n}{coupling} \PYG{o}{*} \PYG{n}{x}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{coupling}\PYG{p}{)} \PYG{o}{*} \PYG{n}{y}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{n}{coupling} \PYG{o}{*} \PYG{n}{x}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{coupling}\PYG{p}{)} \PYG{o}{*} \PYG{n}{y}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate transfer entropies}
    \PYG{n}{te\PYGZus{}x\PYGZus{}to\PYGZus{}y} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}transfer\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
    \PYG{n}{te\PYGZus{}y\PYGZus{}to\PYGZus{}x} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}transfer\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{900}\PYG{p}{:}\PYG{l+m+mi}{950}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{System X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{y}\PYG{p}{[}\PYG{l+m+mi}{900}\PYG{p}{:}\PYG{l+m+mi}{950}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{System Y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Coupling: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{coupling}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{TE X→Y: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{te\PYGZus{}x\PYGZus{}to\PYGZus{}y}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, TE Y→X: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{te\PYGZus{}y\PYGZus{}to\PYGZus{}x}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Causal Density}
\label{\detokenize{part2/ch07_information_theory:causal-density}}
\sphinxAtStartPar
Causal density measures the overall level of causal interactivity in a network, defined as the average transfer entropy between all pairs of nodes:
\begin{equation*}
\begin{split}CD = \frac{1}{n(n-1)} \sum_{i \neq j} TE_{X_i \rightarrow X_j}\end{split}
\end{equation*}
\sphinxAtStartPar
This metric helps characterize complex networks by their causal interconnectedness.


\subsection{Integrated Information Theory}
\label{\detokenize{part2/ch07_information_theory:integrated-information-theory}}
\sphinxAtStartPar
Integrated Information Theory (IIT) aims to quantify consciousness by measuring the amount of information integrated across neural systems. The core quantity, integrated information (Φ), represents information that cannot be decomposed into independent parts:
\begin{equation*}
\begin{split}\Phi = \min_{P} [ D_{KL}(p(X_t | X_{t-1}) || p^{(P)}(X_t | X_{t-1})) ]\end{split}
\end{equation*}
\sphinxAtStartPar
where \(p^{(P)}\) is the product of the probability distributions for the system divided according to partition \(P\).

\sphinxAtStartPar
High Φ indicates that the system integrates information in a way that cannot be reduced to its parts, a proposed correlate of consciousness.

\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Back}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 1 (Introduction)}: The cybernetics section (1.1.1) introduced early information processing concepts that are formalized here as Shannon’s information theory.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 2 (Neuroscience Foundations)}: Neural coding strategies discussed in section 2.1 can be quantitatively analyzed using the information\sphinxhyphen{}theoretic measures presented in this chapter.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 10 (Deep Learning)}: The information bottleneck principle covered in section 7.6 provides important theoretical insights into how deep networks learn and generalize.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 11 (Sequence Models)}: Information\sphinxhyphen{}theoretic measures like entropy and cross\sphinxhyphen{}entropy become critical loss functions for language and sequence modeling.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 12 (LLMs)}: The efficient coding principles in section 7.2 help explain how large language models compress knowledge from training data.

\end{itemize}
\end{sphinxadmonition}


\section{7.6 Code Lab – Information Analysis in Python}
\label{\detokenize{part2/ch07_information_theory:code-lab-information-analysis-in-python}}
\sphinxAtStartPar
Let’s implement some practical information\sphinxhyphen{}theoretic analyses on real\sphinxhyphen{}world data.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import necessary libraries}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}

\PYG{c+c1}{\PYGZsh{} Set random seed for reproducibility}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example 1: Entropy and Mutual Information of Spike Trains}
\label{\detokenize{part2/ch07_information_theory:example-1-entropy-and-mutual-information-of-spike-trains}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a Poisson spike train.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        rate: firing rate in Hz}
\PYG{l+s+sd}{        duration: duration in seconds}
\PYG{l+s+sd}{        dt: time step in seconds}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        binary spike train array}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}prob} \PYG{o}{=} \PYG{n}{rate} \PYG{o}{*} \PYG{n}{dt}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{spike\PYGZus{}prob}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Generate spike trains with different rates and correlations}
\PYG{n}{duration} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} seconds}
\PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mf}{0.001}     \PYG{c+c1}{\PYGZsh{} 1ms bins}
\PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Independent spike trains}
\PYG{n}{rates} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Hz}
\PYG{n}{independent\PYGZus{}trains} \PYG{o}{=} \PYG{p}{[}\PYG{n}{generate\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}\PYG{n}{r}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{rates}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Calculate entropy of each spike train}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}spike\PYGZus{}train\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{spike\PYGZus{}train}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate entropy of spike counts in windows.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Count spikes in windows}
    \PYG{n}{n\PYGZus{}windows} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spike\PYGZus{}train}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{n}{window\PYGZus{}size}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{spike\PYGZus{}train}\PYG{p}{[}\PYG{n}{i}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{)} 
                       \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate probability distribution}
    \PYG{n}{values}\PYG{p}{,} \PYG{n}{counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{counts}\PYG{p}{,} \PYG{n}{return\PYGZus{}counts}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{probs} \PYG{o}{=} \PYG{n}{counts} \PYG{o}{/} \PYG{n}{n\PYGZus{}windows}
    
    \PYG{c+c1}{\PYGZsh{} Calculate entropy}
    \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{probs} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{probs} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate mutual information between pairs of spike trains}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}spike\PYGZus{}train\PYGZus{}mi}\PYG{p}{(}\PYG{n}{train1}\PYG{p}{,} \PYG{n}{train2}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate mutual information between spike counts in windows.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}windows} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train1}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{n}{window\PYGZus{}size}
    \PYG{n}{counts1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{train1}\PYG{p}{[}\PYG{n}{i}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{)} 
                        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{counts2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{train2}\PYG{p}{[}\PYG{n}{i}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{)} 
                        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate mutual information using scikit\PYGZhy{}learn}
    \PYG{n}{counts1\PYGZus{}disc} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{minimum}\PYG{p}{(}\PYG{n}{counts1}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Limit to prevent sparsity issues}
    \PYG{n}{counts2\PYGZus{}disc} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{minimum}\PYG{p}{(}\PYG{n}{counts2}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}\PYG{p}{(}\PYG{n}{counts1\PYGZus{}disc}\PYG{p}{,} \PYG{n}{counts2\PYGZus{}disc}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate and display entropies and mutual information}
\PYG{n}{entropies} \PYG{o}{=} \PYG{p}{[}\PYG{n}{calculate\PYGZus{}spike\PYGZus{}train\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{train}\PYG{p}{)} \PYG{k}{for} \PYG{n}{train} \PYG{o+ow}{in} \PYG{n}{independent\PYGZus{}trains}\PYG{p}{]}

\PYG{n}{mi\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mi\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}spike\PYGZus{}train\PYGZus{}mi}\PYG{p}{(}\PYG{n}{independent\PYGZus{}trains}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{independent\PYGZus{}trains}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spike Train Entropies (bits):}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{r}\PYG{p}{,} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{,} \PYG{n}{entropies}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rate }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ Hz: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{,} \PYG{n}{entropies}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy vs. Firing Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{mi\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information Between Spike Trains}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Train Index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Train Index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mi\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example 2: Information Bottleneck Demonstration}
\label{\detokenize{part2/ch07_information_theory:example-2-information-bottleneck-demonstration}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{information\PYGZus{}bottleneck\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate the information bottleneck principle on a toy dataset.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate synthetic data: X (input) \PYGZhy{}\PYGZgt{} T (compressed representation) \PYGZhy{}\PYGZgt{} Y (target)}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{1000}
    
    \PYG{c+c1}{\PYGZsh{} Create a scenario where X has 10 dimensions but only 3 are relevant for Y}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{relevant\PYGZus{}dims} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}
    \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{relevant\PYGZus{}dims}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{Y} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Y} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Binary classification target}
    
    \PYG{c+c1}{\PYGZsh{} Apply dimensionality reduction with different compression levels}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
    
    \PYG{n}{compression\PYGZus{}dims} \PYG{o}{=} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{)}
    \PYG{n}{mutual\PYGZus{}info\PYGZus{}values} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{n\PYGZus{}dims} \PYG{o+ow}{in} \PYG{n}{compression\PYGZus{}dims}\PYG{p}{:}
        \PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}dims}\PYG{p}{)}
        \PYG{n}{T} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Discretize continuous values for MI calculation}
        \PYG{n}{T\PYGZus{}binned} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{T}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{T}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{T\PYGZus{}binned}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{T}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{T}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{T}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate I(T;Y) \PYGZhy{} the preserved relevant information}
        \PYG{n}{mi\PYGZus{}sum} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{T}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mi\PYGZus{}sum} \PYG{o}{+}\PYG{o}{=} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}\PYG{p}{(}\PYG{n}{T\PYGZus{}binned}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}
        
        \PYG{n}{mutual\PYGZus{}info\PYGZus{}values}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mi\PYGZus{}sum}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate the \PYGZdq{}information curve\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{compression\PYGZus{}dims}\PYG{p}{,} \PYG{n}{mutual\PYGZus{}info\PYGZus{}values}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} 
                \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True relevant dimensions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Number of dimensions in compressed representation (T)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information I(T;Y) (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information Bottleneck Principle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information bottleneck shows that we only need 3 dimensions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{to capture almost all relevant information about Y.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{information\PYGZus{}bottleneck\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example 3: Transfer Entropy in Neural Spike Trains}
\label{\detokenize{part2/ch07_information_theory:example-3-transfer-entropy-in-neural-spike-trains}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}transfer\PYGZus{}entropy\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate transfer entropy on simulated coupled neurons.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simulate two coupled neurons}
    \PYG{n}{n\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{5000}
    \PYG{n}{coupling} \PYG{o}{=} \PYG{l+m+mf}{0.3}
    
    \PYG{c+c1}{\PYGZsh{} Generate baseline spike probabilities}
    \PYG{n}{rate1} \PYG{o}{=} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Base firing probability for neuron 1}
    \PYG{n}{rate2} \PYG{o}{=} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Base firing probability for neuron 2}
    
    \PYG{n}{neuron1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    \PYG{n}{neuron2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Neuron 1 has an independent firing pattern}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{rate1}\PYG{p}{:}
            \PYG{n}{neuron1}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Neuron 2 is influenced by neuron 1 (with delay=1)}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{influence} \PYG{o}{=} \PYG{n}{coupling} \PYG{o}{*} \PYG{n}{neuron1}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{p}{(}\PYG{n}{rate2} \PYG{o}{+} \PYG{n}{influence}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{neuron2}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Calculate transfer entropy (simple implementation)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}te}\PYG{p}{(}\PYG{n}{source}\PYG{p}{,} \PYG{n}{target}\PYG{p}{,} \PYG{n}{delay}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simplified transfer entropy calculation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{joint\PYGZus{}counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [target\PYGZus{}past, source\PYGZus{}past, target\PYGZus{}future]}
        
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{delay}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{source}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{n}{delay}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{s\PYGZus{}past} \PYG{o}{=} \PYG{n}{source}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{n}{delay}\PYG{p}{]}
            \PYG{n}{t\PYGZus{}past} \PYG{o}{=} \PYG{n}{target}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{n}{delay}\PYG{p}{]}
            \PYG{n}{t\PYGZus{}future} \PYG{o}{=} \PYG{n}{target}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}
            
            \PYG{n}{joint\PYGZus{}counts}\PYG{p}{[}\PYG{n}{t\PYGZus{}past}\PYG{p}{,} \PYG{n}{s\PYGZus{}past}\PYG{p}{,} \PYG{n}{t\PYGZus{}future}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        
        \PYG{c+c1}{\PYGZsh{} Normalize to get probabilities}
        \PYG{n}{joint\PYGZus{}prob} \PYG{o}{=} \PYG{n}{joint\PYGZus{}counts} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}counts}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Marginal probabilities}
        \PYG{n}{p\PYGZus{}t\PYGZus{}past} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{p\PYGZus{}joint\PYGZus{}ts\PYGZus{}past} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{p\PYGZus{}joint\PYGZus{}tt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate transfer entropy}
        \PYG{n}{te} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} t\PYGZus{}past}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} s\PYGZus{}past}
                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} t\PYGZus{}future}
                    \PYG{k}{if} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{p\PYGZus{}joint\PYGZus{}ts\PYGZus{}past}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                        \PYG{n}{te} \PYG{o}{+}\PYG{o}{=} \PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{joint\PYGZus{}prob}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]} \PYG{o}{*} \PYG{n}{p\PYGZus{}t\PYGZus{}past}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} 
                                                            \PYG{p}{(}\PYG{n}{p\PYGZus{}joint\PYGZus{}ts\PYGZus{}past}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{*} \PYG{n}{p\PYGZus{}joint\PYGZus{}tt}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{k}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{te}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Ensure non\PYGZhy{}negative}
    
    \PYG{c+c1}{\PYGZsh{} Calculate transfer entropy in both directions}
    \PYG{n}{te\PYGZus{}1\PYGZus{}to\PYGZus{}2} \PYG{o}{=} \PYG{n}{simple\PYGZus{}te}\PYG{p}{(}\PYG{n}{neuron1}\PYG{p}{,} \PYG{n}{neuron2}\PYG{p}{)}
    \PYG{n}{te\PYGZus{}2\PYGZus{}to\PYGZus{}1} \PYG{o}{=} \PYG{n}{simple\PYGZus{}te}\PYG{p}{(}\PYG{n}{neuron2}\PYG{p}{,} \PYG{n}{neuron1}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transfer Entropy (Neuron 1 → Neuron 2): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{te\PYGZus{}1\PYGZus{}to\PYGZus{}2}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transfer Entropy (Neuron 2 → Neuron 1): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{te\PYGZus{}2\PYGZus{}to\PYGZus{}1}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the spike trains}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{neuron1}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{100}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron 1 (Driver)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{neuron2}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{100}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron 2 (Driven)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot cross\PYGZhy{}correlation to show relationship}
    \PYG{n}{max\PYGZus{}lag} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{xcorr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{max\PYGZus{}lag} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{lags} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{max\PYGZus{}lag}\PYG{p}{,} \PYG{n}{max\PYGZus{}lag} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{lag} \PYG{o+ow}{in} \PYG{n}{lags}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{lag} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Neuron1 leads}
            \PYG{n}{xcorr}\PYG{p}{[}\PYG{n}{lag} \PYG{o}{+} \PYG{n}{max\PYGZus{}lag}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{neuron1}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{neuron2}\PYG{p}{[}\PYG{p}{:}\PYG{n}{lag}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{k}{elif} \PYG{n}{lag} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Neuron2 leads}
            \PYG{n}{xcorr}\PYG{p}{[}\PYG{n}{lag} \PYG{o}{+} \PYG{n}{max\PYGZus{}lag}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{neuron1}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{]}\PYG{p}{,} \PYG{n}{neuron2}\PYG{p}{[}\PYG{n}{lag}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} No lag}
            \PYG{n}{xcorr}\PYG{p}{[}\PYG{n}{lag} \PYG{o}{+} \PYG{n}{max\PYGZus{}lag}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{neuron1}\PYG{p}{,} \PYG{n}{neuron2}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lags}\PYG{p}{,} \PYG{n}{xcorr}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Lag (Neuron 1 → Neuron 2)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cross\PYGZhy{}correlation Between Neurons}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{simple\PYGZus{}transfer\PYGZus{}entropy\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example 4: Information Theory in Reinforcement Learning}
\label{\detokenize{part2/ch07_information_theory:example-4-information-theory-in-reinforcement-learning}}
\sphinxAtStartPar
Reinforcement learning and information theory are deeply connected in both neuroscience and artificial intelligence. Let’s explore how information\sphinxhyphen{}theoretic concepts apply to reinforcement learning through a GridWorld example.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{info\PYGZus{}theory\PYGZus{}rl\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate information\PYGZhy{}theoretic principles in reinforcement learning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{colors}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{ListedColormap}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{patches}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Rectangle}
    
    \PYG{c+c1}{\PYGZsh{} Define a simple grid world environment}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{GridWorld}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size} \PYG{o}{=} \PYG{n}{size}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{noise} \PYG{o}{=} \PYG{n}{noise}  \PYG{c+c1}{\PYGZsh{} Probability of random action}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{states} \PYG{o}{=} \PYG{n}{size} \PYG{o}{*} \PYG{n}{size}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{actions} \PYG{o}{=} \PYG{l+m+mi}{4}  \PYG{c+c1}{\PYGZsh{} Up, Right, Down, Left}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal} \PYG{o}{=} \PYG{p}{(}\PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Define rewards: \PYGZhy{}0.1 for each step, +1 for goal, \PYGZhy{}1 for obstacles}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rewards} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rewards}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}
            
            \PYG{c+c1}{\PYGZsh{} Add some obstacles}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{obstacles} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{]}
            \PYG{k}{for} \PYG{n}{obs} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{obstacles}\PYG{p}{:}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rewards}\PYG{p}{[}\PYG{n}{obs}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1.0}
                
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} With some probability, take a random action}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{noise}\PYG{p}{:}
                \PYG{n}{action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
                
            \PYG{c+c1}{\PYGZsh{} Move according to action: 0=up, 1=right, 2=down, 3=left}
            \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos}
            \PYG{k}{if} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:} \PYG{n}{y} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Up}
            \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:} \PYG{n}{x} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{x} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Right}
            \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:} \PYG{n}{y} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Down}
            \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:} \PYG{n}{x} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Left}
            
            \PYG{c+c1}{\PYGZsh{} Check if this is an obstacle}
            \PYG{k}{if} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{obstacles}\PYG{p}{:}
                \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{k+kc}{False}  \PYG{c+c1}{\PYGZsh{} Can\PYGZsq{}t move to obstacles}
            
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos} \PYG{o}{=} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
            \PYG{n}{reward} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rewards}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{]}
            \PYG{n}{done} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos} \PYG{o}{==} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{)}
            
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple Q\PYGZhy{}learning agent}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{QLearningAgent}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{states}\PYG{p}{,} \PYG{n}{actions}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{discount}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{Q} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{states}\PYG{p}{,} \PYG{n}{actions}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lr} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{=} \PYG{n}{discount}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{epsilon} \PYG{o}{=} \PYG{n}{epsilon}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}visits} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{states}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}action\PYGZus{}visits} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{states}\PYG{p}{,} \PYG{n}{actions}\PYG{p}{)}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}state\PYGZus{}idx}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{            }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Convert (x,y) to state index.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{state}
            \PYG{k}{return} \PYG{n}{y} \PYG{o}{*} \PYG{n}{size} \PYG{o}{+} \PYG{n}{x}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{state\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}state\PYGZus{}idx}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}visits}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
            
            \PYG{c+c1}{\PYGZsh{} Epsilon\PYGZhy{}greedy policy}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{epsilon}\PYG{p}{:}
                \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{state\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}state\PYGZus{}idx}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}
            \PYG{n}{next\PYGZus{}state\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}state\PYGZus{}idx}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}action\PYGZus{}visits}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
            
            \PYG{c+c1}{\PYGZsh{} Q\PYGZhy{}learning update}
            \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{done}\PYG{p}{:}
                \PYG{n}{target} \PYG{o}{=} \PYG{n}{reward} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{next\PYGZus{}state\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{target} \PYG{o}{=} \PYG{n}{reward}
                
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lr} \PYG{o}{*} \PYG{p}{(}\PYG{n}{target} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Function to calculate the entropy of a policy}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}policy\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Convert Q\PYGZhy{}values to policy probabilities using softmax}
        \PYG{n}{policy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{n}{Q\PYGZus{}values}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
                
        \PYG{c+c1}{\PYGZsh{} Calculate entropy for each state}
        \PYG{n}{entropies} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{Q\PYGZus{}values}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{p} \PYG{o}{=} \PYG{n}{policy}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}
            \PYG{n}{entropies}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{entropies}\PYG{p}{,} \PYG{n}{policy}
    
    \PYG{c+c1}{\PYGZsh{} Function to visualize the grid world, policy, and information measures}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}grid\PYGZus{}world}\PYG{p}{(}\PYG{n}{env}\PYG{p}{,} \PYG{n}{agent}\PYG{p}{,} \PYG{n}{episode}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert agent\PYGZsq{}s Q\PYGZhy{}values to policy and calculate entropy}
        \PYG{n}{policy\PYGZus{}entropies}\PYG{p}{,} \PYG{n}{policy} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}policy\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{agent}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get the best actions for each state}
        \PYG{n}{best\PYGZus{}actions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{agent}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate information gain (approximation based on state visits)}
        \PYG{n}{prior} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Uniform prior}
        \PYG{n}{posterior} \PYG{o}{=} \PYG{n}{agent}\PYG{o}{.}\PYG{n}{state\PYGZus{}visits} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{agent}\PYG{o}{.}\PYG{n}{state\PYGZus{}visits}\PYG{p}{)}
        \PYG{n}{posterior}\PYG{p}{[}\PYG{n}{posterior} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}10}  \PYG{c+c1}{\PYGZsh{} Avoid log(0)}
        
        \PYG{n}{information\PYGZus{}gain} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{posterior}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{information\PYGZus{}gain}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{posterior}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]} \PYG{o}{/} \PYG{n}{prior}\PYG{p}{[}\PYG{n}{s}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape for visualization}
        \PYG{n}{policy\PYGZus{}entropy\PYGZus{}grid} \PYG{o}{=} \PYG{n}{policy\PYGZus{}entropies}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
        \PYG{n}{information\PYGZus{}gain\PYGZus{}grid} \PYG{o}{=} \PYG{n}{information\PYGZus{}gain}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create Grid World visualization}
        \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{131}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Grid World (Episode }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{episode}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot the grid}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot goal and obstacles}
        \PYG{n}{goal\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{goal\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{obs} \PYG{o+ow}{in} \PYG{n}{env}\PYG{o}{.}\PYG{n}{obstacles}\PYG{p}{:}
            \PYG{n}{obs\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
            \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{obs\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot current position}
        \PYG{n}{pos\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{pos\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot policy arrows}
        \PYG{k}{for} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{state\PYGZus{}idx} \PYG{o}{=} \PYG{n}{y} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{+} \PYG{n}{x}
                \PYG{k}{if} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{env}\PYG{o}{.}\PYG{n}{obstacles} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)} \PYG{o}{!=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{:}
                    \PYG{n}{action} \PYG{o}{=} \PYG{n}{best\PYGZus{}actions}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{]}
                    \PYG{k}{if} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Up}
                        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Right}
                        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Down}
                        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Left}
                        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}aspect}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{invert\PYGZus{}yaxis}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} To match the state indices}
        
        \PYG{c+c1}{\PYGZsh{} Plot policy entropy}
        \PYG{n}{ax2} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{132}\PYG{p}{)}
        \PYG{n}{im2} \PYG{o}{=} \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{policy\PYGZus{}entropy\PYGZus{}grid}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Policy Entropy (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im2}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add obstacles and goal markers}
        \PYG{k}{for} \PYG{n}{obs} \PYG{o+ow}{in} \PYG{n}{env}\PYG{o}{.}\PYG{n}{obstacles}\PYG{p}{:}
            \PYG{n}{obs\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                                 \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{obs\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{n}{goal\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                              \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{goal\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot information gain}
        \PYG{n}{ax3} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{133}\PYG{p}{)}
        \PYG{n}{im3} \PYG{o}{=} \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{information\PYGZus{}gain\PYGZus{}grid}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{plasma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information Gain (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im3}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax3}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add obstacles and goal markers}
        \PYG{k}{for} \PYG{n}{obs} \PYG{o+ow}{in} \PYG{n}{env}\PYG{o}{.}\PYG{n}{obstacles}\PYG{p}{:}
            \PYG{n}{obs\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{obs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                                 \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{obs\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{n}{goal\PYGZus{}rect} \PYG{o}{=} \PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{goal}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                              \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{goal\PYGZus{}rect}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train the agent and visualize}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{env} \PYG{o}{=} \PYG{n}{GridWorld}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}
    \PYG{n}{agent} \PYG{o}{=} \PYG{n}{QLearningAgent}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{states}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{actions}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{discount}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training parameters}
    \PYG{n}{n\PYGZus{}episodes} \PYG{o}{=} \PYG{l+m+mi}{500}
    \PYG{n}{max\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Track rewards for plotting}
    \PYG{n}{episode\PYGZus{}rewards} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{policy\PYGZus{}entropies} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Train the agent}
    \PYG{k}{for} \PYG{n}{episode} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}episodes} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{total\PYGZus{}reward} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{done} \PYG{o}{=} \PYG{k+kc}{False}
        \PYG{n}{steps} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{while} \PYG{o+ow}{not} \PYG{n}{done} \PYG{o+ow}{and} \PYG{n}{steps} \PYG{o}{\PYGZlt{}} \PYG{n}{max\PYGZus{}steps}\PYG{p}{:}
            \PYG{n}{action} \PYG{o}{=} \PYG{n}{agent}\PYG{o}{.}\PYG{n}{get\PYGZus{}action}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
            \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{action}\PYG{p}{)}
            \PYG{n}{agent}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
            \PYG{n}{total\PYGZus{}reward} \PYG{o}{+}\PYG{o}{=} \PYG{n}{reward}
            \PYG{n}{steps} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        
        \PYG{n}{episode\PYGZus{}rewards}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{total\PYGZus{}reward}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate average policy entropy for this episode}
        \PYG{n}{entropy}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{calculate\PYGZus{}policy\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{agent}\PYG{o}{.}\PYG{n}{Q}\PYG{p}{)}
        \PYG{n}{policy\PYGZus{}entropies}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{entropy}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Visualize at specific episodes}
        \PYG{k}{if} \PYG{n}{episode} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{500}\PYG{p}{]}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Episode }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{episode}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Total Reward: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}reward}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Average Policy Entropy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{entropy}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{visualize\PYGZus{}grid\PYGZus{}world}\PYG{p}{(}\PYG{n}{env}\PYG{p}{,} \PYG{n}{agent}\PYG{p}{,} \PYG{n}{episode}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot learning curve and policy entropy over training}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{episode\PYGZus{}rewards}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Total Reward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{policy\PYGZus{}entropies}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Average Policy Entropy (bits)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Policy Entropy During Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Information\PYGZhy{}theoretic interpretation of RL:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. Policy entropy decreases as the agent becomes more certain about optimal actions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2. Information gain is highest in states that were unexpectedly valuable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. The agent maximizes reward while minimizing surprise (free energy principle)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{4. The exploration\PYGZhy{}exploitation trade\PYGZhy{}off can be formalized as an information\PYGZhy{}gathering process}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{info\PYGZus{}theory\PYGZus{}rl\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{7.7 Information Theory in Modern Deep Learning}
\label{\detokenize{part2/ch07_information_theory:information-theory-in-modern-deep-learning}}
\sphinxAtStartPar
Information theory has become increasingly important in understanding and improving modern deep learning systems. In this section, we’ll explore how information\sphinxhyphen{}theoretic principles apply to neural networks.


\subsection{Information Bottleneck in Deep Neural Networks}
\label{\detokenize{part2/ch07_information_theory:information-bottleneck-in-deep-neural-networks}}
\sphinxAtStartPar
Tishby and colleagues proposed that deep neural networks can be understood through the information bottleneck principle, where each layer progressively compresses information about the input while preserving information relevant to the output. This perspective views deep learning as an iterative optimization of the information bottleneck trade\sphinxhyphen{}off.

\sphinxAtStartPar
The learning dynamics in DNNs typically show two phases:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Fitting phase}: The network increases I(T;Y) \sphinxhyphen{} mutual information between representations and labels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compression phase}: The network decreases I(T;X) \sphinxhyphen{} mutual information between representations and inputs

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}information\PYGZus{}plane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Conceptual visualization of the information plane dynamics of deep learning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This is a conceptual visualization of Information Bottleneck trajectories}
    
    \PYG{c+c1}{\PYGZsh{} Create a meshgrid for the information plane}
    \PYG{n}{I\PYGZus{}TX} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{I\PYGZus{}TY} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{I\PYGZus{}TX}\PYG{p}{,} \PYG{n}{I\PYGZus{}TY}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define a hypothetical \PYGZdq{}information bottleneck curve\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This is just for visualization \PYGZhy{} real curves would come from actual DNN training}
    \PYG{n}{max\PYGZus{}I\PYGZus{}TY} \PYG{o}{=} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{X}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{Z} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}I\PYGZus{}TY} \PYG{o}{\PYGZhy{}} \PYG{n}{Y}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define some trajectories for different layers}
    \PYG{n}{layer1\PYGZus{}tx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{layer1\PYGZus{}ty} \PYG{o}{=} \PYG{l+m+mf}{2.9} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{layer1\PYGZus{}tx}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{layer2\PYGZus{}tx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{layer2\PYGZus{}ty} \PYG{o}{=} \PYG{l+m+mf}{2.8} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.6} \PYG{o}{*} \PYG{n}{layer2\PYGZus{}tx}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{layer3\PYGZus{}tx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{layer3\PYGZus{}ty} \PYG{o}{=} \PYG{l+m+mf}{2.7} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.7} \PYG{o}{*} \PYG{n}{layer3\PYGZus{}tx}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create figure}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot the information plane with contours}
    \PYG{n}{contour} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distance from optimal IB curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark the optimal IB curve}
    \PYG{n}{optimal\PYGZus{}tx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{optimal\PYGZus{}ty} \PYG{o}{=} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{optimal\PYGZus{}tx}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{optimal\PYGZus{}tx}\PYG{p}{,} \PYG{n}{optimal\PYGZus{}ty}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Optimal IB curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot layer trajectories during training}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{layer1\PYGZus{}tx}\PYG{p}{,} \PYG{n}{layer1\PYGZus{}ty}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Layer 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{layer2\PYGZus{}tx}\PYG{p}{,} \PYG{n}{layer2\PYGZus{}ty}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Layer 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{layer3\PYGZus{}tx}\PYG{p}{,} \PYG{n}{layer3\PYGZus{}ty}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Layer 3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add arrows to indicate direction}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{layer1\PYGZus{}tx}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{n}{layer1\PYGZus{}ty}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{layer2\PYGZus{}tx}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{n}{layer2\PYGZus{}ty}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{layer3\PYGZus{}tx}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{n}{layer3\PYGZus{}ty}\PYG{p}{[}\PYG{l+m+mi}{70}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add labels for the phases}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Fitting Phase}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Compression Phase}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I(T;X) \PYGZhy{} Information about input}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I(T;Y) \PYGZhy{} Information about output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information Plane Dynamics in Deep Neural Networks}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{visualize\PYGZus{}information\PYGZus{}plane}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Variational Information Bottleneck}
\label{\detokenize{part2/ch07_information_theory:variational-information-bottleneck}}
\sphinxAtStartPar
The variational information bottleneck (VIB) provides a practical way to implement the information bottleneck principle in neural networks:
\begin{equation*}
\begin{split}\mathcal{L}_{VIB} = -I(T;Y) + \beta I(T;X)\end{split}
\end{equation*}
\sphinxAtStartPar
where β controls the trade\sphinxhyphen{}off. This can be approximated using variational methods, forming the basis for many regularization techniques.


\subsection{Information\sphinxhyphen{}Theoretic Generalization Bounds}
\label{\detokenize{part2/ch07_information_theory:information-theoretic-generalization-bounds}}
\sphinxAtStartPar
Information theory provides bounds on generalization error. The generalization error can be bounded by:
\begin{equation*}
\begin{split}\mathbb{E}[gen(w)] \leq \sqrt{\frac{I(W;S)}{2m}}\end{split}
\end{equation*}
\sphinxAtStartPar
where \(I(W;S)\) is the mutual information between weights and training data, and \(m\) is the sample size. This bound suggests that limiting information between weights and training data improves generalization.


\subsection{Connections to Computational Neuroscience}
\label{\detokenize{part2/ch07_information_theory:connections-to-computational-neuroscience}}
\sphinxAtStartPar
Recent work has shown remarkable parallels between information processing in deep neural networks and the brain:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Efficient Coding}: Both systems optimize information transfer under constraints

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}: Progressive abstraction and compression through layers

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Phase Transitions}: Both exhibit rich dynamics in information flow during learning

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}info\PYGZus{}theory\PYGZus{}connections}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize connections between information theory, neuroscience, and deep learning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a 3x3 grid to represent concepts}
    \PYG{n}{categories} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information Theory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuroscience}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Deep Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{concepts} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information Theory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KL Divergence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuroscience}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Efficient Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sparse Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predictive Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Deep Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Regularization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Compression}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Generalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Create a grid layout}
    \PYG{n}{gs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{GridSpec}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{width\PYGZus{}ratios}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{height\PYGZus{}ratios}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot the titles}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{category} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{categories}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{n}{gs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{category}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Main concept area}
    \PYG{n}{ax\PYGZus{}main} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{n}{gs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a circular layout for concepts}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{networkx}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nx}
    \PYG{n}{G} \PYG{o}{=} \PYG{n}{nx}\PYG{o}{.}\PYG{n}{Graph}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add nodes with positions on a circle}
    \PYG{n}{n\PYGZus{}concepts} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{v}\PYG{p}{)} \PYG{k}{for} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{concepts}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{radius} \PYG{o}{=} \PYG{l+m+mi}{1}
    \PYG{n}{angle\PYGZus{}step} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{/} \PYG{n}{n\PYGZus{}concepts}
    
    \PYG{c+c1}{\PYGZsh{} Add all concept nodes}
    \PYG{n}{node\PYGZus{}idx} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{n}{node\PYGZus{}positions} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{node\PYGZus{}colors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{category} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{categories}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{color} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}3498db}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}2ecc71}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}e74c3c}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{concept} \PYG{o+ow}{in} \PYG{n}{concepts}\PYG{p}{[}\PYG{n}{category}\PYG{p}{]}\PYG{p}{:}
            \PYG{n}{angle} \PYG{o}{=} \PYG{n}{node\PYGZus{}idx} \PYG{o}{*} \PYG{n}{angle\PYGZus{}step}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}
            \PYG{n}{y} \PYG{o}{=} \PYG{n}{radius} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}
            \PYG{n}{G}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{n}{concept}\PYG{p}{)}
            \PYG{n}{node\PYGZus{}positions}\PYG{p}{[}\PYG{n}{concept}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
            \PYG{n}{node\PYGZus{}colors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{color}\PYG{p}{)}
            \PYG{n}{node\PYGZus{}idx} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Add carefully chosen edges to represent relationships}
    \PYG{n}{connections} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Efficient Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Entropy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Compression}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KL Divergence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sparse Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KL Divergence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Regularization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predictive Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Generalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Efficient Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Compression}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sparse Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Regularization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predictive Coding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Generalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{source}\PYG{p}{,} \PYG{n}{target} \PYG{o+ow}{in} \PYG{n}{connections}\PYG{p}{:}
        \PYG{n}{G}\PYG{o}{.}\PYG{n}{add\PYGZus{}edge}\PYG{p}{(}\PYG{n}{source}\PYG{p}{,} \PYG{n}{target}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw the graph}
    \PYG{n}{nx}\PYG{o}{.}\PYG{n}{draw}\PYG{p}{(}\PYG{n}{G}\PYG{p}{,} \PYG{n}{pos}\PYG{o}{=}\PYG{n}{node\PYGZus{}positions}\PYG{p}{,} \PYG{n}{with\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{node\PYGZus{}color}\PYG{o}{=}\PYG{n}{node\PYGZus{}colors}\PYG{p}{,} 
            \PYG{n}{node\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3000}\PYG{p}{,} \PYG{n}{font\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{font\PYGZus{}weight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
            \PYG{n}{edge\PYGZus{}color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax\PYGZus{}main}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Footer text}
    \PYG{n}{ax\PYGZus{}footer} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{n}{gs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{ax\PYGZus{}footer}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information theory provides a common language linking neuroscience and deep learning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                  \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{,} \PYG{n}{fontstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{italic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax\PYGZus{}footer}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}info\PYGZus{}theory\PYGZus{}connections}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Practical Applications in Deep Learning}
\label{\detokenize{part2/ch07_information_theory:practical-applications-in-deep-learning}}
\sphinxAtStartPar
Information theory has informed several advancements in deep learning:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Regularization Techniques}: Information\sphinxhyphen{}theoretic regularizers like variational dropout and weight uncertainty

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Architecture Design}: Information\sphinxhyphen{}theoretic principles guide the design of skip connections and attention mechanisms

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Explainability}: Quantifying information flow helps understand “black box” deep networks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Optimization}: Information\sphinxhyphen{}geometric methods provide insights into learning dynamics

\end{enumerate}


\section{7.8 Take\sphinxhyphen{}aways}
\label{\detokenize{part2/ch07_information_theory:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Information theory provides a quantitative framework for understanding information processing in neural and artificial systems.

\item {} 
\sphinxAtStartPar
Entropy, mutual information, and KL divergence are fundamental measures for analyzing neural codes.

\item {} 
\sphinxAtStartPar
Efficient coding principles like redundancy reduction and sparse coding are observed in both biological and artificial neural networks.

\item {} 
\sphinxAtStartPar
Information flows asymmetrically in neural circuits, which can be captured by directional measures like transfer entropy.

\item {} 
\sphinxAtStartPar
The trade\sphinxhyphen{}off between compression and prediction in neural systems is formalized by information bottleneck theory, which has parallels in deep learning.

\item {} 
\sphinxAtStartPar
Neural variability and correlations critically affect the information content of population codes.

\item {} 
\sphinxAtStartPar
Information\sphinxhyphen{}theoretic measures can reveal the causal structure of neural networks and provide insights into integrated information processing.

\item {} 
\sphinxAtStartPar
Modern deep learning can be understood through information\sphinxhyphen{}theoretic principles, with layers performing progressive compression while preserving task\sphinxhyphen{}relevant information.

\item {} 
\sphinxAtStartPar
Both brains and artificial neural networks appear to optimize similar information\sphinxhyphen{}theoretic objectives under different constraints.

\end{itemize}


\section{7.9 Further Reading \& Media}
\label{\detokenize{part2/ch07_information_theory:further-reading-media}}

\subsection{Books}
\label{\detokenize{part2/ch07_information_theory:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Cover, T. M., \& Thomas, J. A. (2006). \sphinxstyleemphasis{Elements of Information Theory} (2nd ed.). Wiley\sphinxhyphen{}Interscience.

\item {} 
\sphinxAtStartPar
MacKay, D. J. C. (2003). \sphinxstyleemphasis{Information Theory, Inference, and Learning Algorithms}. Cambridge University Press.

\item {} 
\sphinxAtStartPar
Rieke, F., Warland, D., de Ruyter van Steveninck, R., \& Bialek, W. (1997). \sphinxstyleemphasis{Spikes: Exploring the Neural Code}. MIT Press.

\item {} 
\sphinxAtStartPar
Stone, J. V. (2018). \sphinxstyleemphasis{Information Theory: A Tutorial Introduction}. Sebtel Press.

\item {} 
\sphinxAtStartPar
Poldrack, R. A. (2022). \sphinxstyleemphasis{The Physics of Cognition: Information Theoretic Foundations of Consciousness}. MIT Press.

\end{itemize}


\subsection{Articles}
\label{\detokenize{part2/ch07_information_theory:articles}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Shannon, C. E. (1948). “A Mathematical Theory of Communication,” \sphinxstyleemphasis{Bell System Technical Journal}.

\item {} 
\sphinxAtStartPar
Fairhall, A. L., Lewen, G. D., Bialek, W., \& de Ruyter van Steveninck, R. R. (2001). “Efficiency and ambiguity in an adaptive neural code,” \sphinxstyleemphasis{Nature}.

\item {} 
\sphinxAtStartPar
Tishby, N., Pereira, F. C., \& Bialek, W. (2000). “The information bottleneck method,” \sphinxstyleemphasis{arXiv}.

\item {} 
\sphinxAtStartPar
Timme, N. M., \& Lapish, C. (2018). “A Tutorial for Information Theory in Neuroscience,” \sphinxstyleemphasis{eNeuro}.

\item {} 
\sphinxAtStartPar
Shwartz\sphinxhyphen{}Ziv, R., \& Tishby, N. (2017). “Opening the black box of deep neural networks via information,” \sphinxstyleemphasis{arXiv:1703.00810}.

\item {} 
\sphinxAtStartPar
Saxe, A. M., et al. (2019). “Information theory of deep learning,” \sphinxstyleemphasis{Journal of Statistical Mechanics: Theory and Experiment}.

\item {} 
\sphinxAtStartPar
Alemi, A. A., et al. (2016). “Deep variational information bottleneck,” \sphinxstyleemphasis{arXiv:1612.00410}.

\item {} 
\sphinxAtStartPar
Palmer, S. E., Marre, O., Berry, M. J., \& Bialek, W. (2015). “Predictive information in a sensory population,” \sphinxstyleemphasis{PNAS}.

\item {} 
\sphinxAtStartPar
Rubin, J., et al. (2022). “The Information Theory of Synaptic Plasticity,” \sphinxstyleemphasis{Neuron}.

\item {} 
\sphinxAtStartPar
Pezzulo, G., et al. (2022). “Active inference: A neurally plausible computational theory of cognition,” \sphinxstyleemphasis{Trends in Neurosciences}.

\end{itemize}


\subsection{Review Articles Connecting Information Theory to Modern AI \& Neuroscience}
\label{\detokenize{part2/ch07_information_theory:review-articles-connecting-information-theory-to-modern-ai-neuroscience}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Neftci, E. O., \& Averbeck, B. B. (2019). “Reinforcement learning in artificial and biological systems,” \sphinxstyleemphasis{Nature Machine Intelligence}.

\item {} 
\sphinxAtStartPar
Zador, A. M. (2019). “A critique of pure learning and what artificial neural networks can learn from animal brains,” \sphinxstyleemphasis{Nature Communications}.

\item {} 
\sphinxAtStartPar
Richards, B. A., et al. (2019). “A deep learning framework for neuroscience,” \sphinxstyleemphasis{Nature Neuroscience}.

\item {} 
\sphinxAtStartPar
Friston, K. (2010). “The free\sphinxhyphen{}energy principle: a unified brain theory?” \sphinxstyleemphasis{Nature Reviews Neuroscience}.

\item {} 
\sphinxAtStartPar
Whittington, J. C. R., \& Bogacz, R. (2022). “Theories of Error Back\sphinxhyphen{}Propagation in the Brain,” \sphinxstyleemphasis{Trends in Cognitive Sciences}.

\end{itemize}


\subsection{Online Resources}
\label{\detokenize{part2/ch07_information_theory:online-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
“Information Theory, Pattern Recognition, and Neural Networks,” David MacKay’s Cambridge lectures (YouTube).

\item {} 
\sphinxAtStartPar
“Information Theory and Machine Learning,” lectures by Naftali Tishby (YouTube).

\item {} 
\sphinxAtStartPar
“Neural Information Processing Systems (NeurIPS) tutorials on Information Theory and Deep Learning” (available online).

\item {} 
\sphinxAtStartPar
Information Theory and its Applications, Stanford online course materials by Tsachy Weissman.

\item {} 
\sphinxAtStartPar
“Neural Data Science,” Coursera course by Associate Professor Konrad Kording.

\item {} 
\sphinxAtStartPar
“Neuromatch Academy: Computational Neuroscience,” particularly the units on Information Theory and Reinforcement Learning.

\end{itemize}


\subsection{Software Tools}
\label{\detokenize{part2/ch07_information_theory:software-tools}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Information Dynamics Toolkit (IDTxl): Python library for information\sphinxhyphen{}theoretic analysis of neural data.

\item {} 
\sphinxAtStartPar
PyEntropy: Python toolkit for entropy and information estimation.

\item {} 
\sphinxAtStartPar
TRENTOOL: MATLAB toolbox for transfer entropy analysis.

\item {} 
\sphinxAtStartPar
dit: Python package for discrete information theory.

\item {} 
\sphinxAtStartPar
Infotopo: Python toolbox for topological information data analysis.

\item {} 
\sphinxAtStartPar
information\sphinxhyphen{}bottleneck: Python implementation of the Information Bottleneck method.

\item {} 
\sphinxAtStartPar
nninfo: Neural network information\sphinxhyphen{}theoretic measures.

\item {} 
\sphinxAtStartPar
CausalKinetiX: Causal inference tools using information\sphinxhyphen{}theoretic principles.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 8: Data\sphinxhyphen{}Science Pipeline in Python}
\label{\detokenize{part2/ch08_data_science_pipeline:chapter-8-data-science-pipeline-in-python}}\label{\detokenize{part2/ch08_data_science_pipeline::doc}}

\section{8.0 Chapter Goals}
\label{\detokenize{part2/ch08_data_science_pipeline:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Master the data science workflow for neuroscience applications

\item {} 
\sphinxAtStartPar
Implement robust preprocessing, analysis, visualization, and modeling techniques

\item {} 
\sphinxAtStartPar
Work with real neural datasets through practical examples

\item {} 
\sphinxAtStartPar
Create reproducible analysis pipelines for neuroscience experiments

\end{itemize}


\section{8.1 Neural Data Types \& Sources}
\label{\detokenize{part2/ch08_data_science_pipeline:neural-data-types-sources}}
\sphinxAtStartPar
\sphinxincludegraphics{{neural_data_pipeline}.svg}
\sphinxstyleemphasis{Figure 8.1: The data science pipeline for neural data, showing the progression from data acquisition through processing, analysis, and interpretation.}

\sphinxAtStartPar
Neural data comes in many forms, each requiring specialized processing approaches.


\subsection{8.1.1 Spike Trains and Local Field Potentials (LFPs)}
\label{\detokenize{part2/ch08_data_science_pipeline:spike-trains-and-local-field-potentials-lfps}}
\sphinxAtStartPar
Spike trains represent the precise timing of action potentials from individual neurons, while LFPs reflect the summed electrical activity of local neural populations.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{c+c1}{\PYGZsh{} Simulating spike train data}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}\PYG{n}{firing\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a simulated spike train with Poisson statistics.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        firing\PYGZus{}rate: Average firing rate in Hz}
\PYG{l+s+sd}{        duration: Recording duration in seconds}
\PYG{l+s+sd}{        dt: Time bin size in seconds}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        times: Array of spike times}
\PYG{l+s+sd}{        binary\PYGZus{}spikes: Binary array with 1s indicating spikes}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}bins} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{binary\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{n}{n\PYGZus{}bins}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{firing\PYGZus{}rate} \PYG{o}{*} \PYG{n}{dt}
    \PYG{n}{times} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{binary\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{n}{dt}
    
    \PYG{k}{return} \PYG{n}{times}\PYG{p}{,} \PYG{n}{binary\PYGZus{}spikes}

\PYG{c+c1}{\PYGZsh{} Simulating LFP data}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}lfp}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{n}{frequencies}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{]}\PYG{p}{,} \PYG{n}{amplitudes}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate simulated LFP data with specified oscillatory components.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        duration: Recording duration in seconds}
\PYG{l+s+sd}{        dt: Time bin size in seconds}
\PYG{l+s+sd}{        frequencies: List of frequency components to include (Hz)}
\PYG{l+s+sd}{        amplitudes: Amplitudes for each frequency component}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        time: Time points}
\PYG{l+s+sd}{        lfp: LFP signal}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}bins} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}bins}\PYG{p}{)} \PYG{o}{*} \PYG{n}{dt}
    
    \PYG{n}{lfp} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}bins}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{freq}\PYG{p}{,} \PYG{n}{amp} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{frequencies}\PYG{p}{,} \PYG{n}{amplitudes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{lfp} \PYG{o}{+}\PYG{o}{=} \PYG{n}{amp} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{freq} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add some noise}
    \PYG{n}{lfp} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}bins}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{time}\PYG{p}{,} \PYG{n}{lfp}

\PYG{c+c1}{\PYGZsh{} Visualize spike train and LFP}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{binary\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}
        \PYG{n}{firing\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{time}\PYG{p}{,} \PYG{n}{lfp} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}lfp}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{n}{duration}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{n}{dt}\PYG{p}{)}
    
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{sharex}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot spike train raster}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{eventplot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{spike\PYGZus{}times}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lineoffsets}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linelengths}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Train}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot LFP}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{lfp}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude (μV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Local Field Potential}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{8.1.2 EEG, MEG, and fMRI Data}
\label{\detokenize{part2/ch08_data_science_pipeline:eeg-meg-and-fmri-data}}
\sphinxAtStartPar
These non\sphinxhyphen{}invasive recording techniques offer different spatial and temporal resolutions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{EEG (Electroencephalography)}: High temporal resolution (milliseconds), limited spatial resolution

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{MEG (Magnetoencephalography)}: Similar to EEG but with improved spatial resolution

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{fMRI (functional Magnetic Resonance Imaging)}: Excellent spatial resolution (millimeters), poor temporal resolution (seconds)

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}and\PYGZus{}preprocess\PYGZus{}eeg}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Example function to load and preprocess EEG data.}
\PYG{l+s+sd}{    In practice, you would use libraries like MNE for this.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} In actual implementation, replace with:}
    \PYG{c+c1}{\PYGZsh{} import mne}
    \PYG{c+c1}{\PYGZsh{} raw = mne.io.read\PYGZus{}raw\PYGZus{}fif(filename, preload=True)}
    \PYG{c+c1}{\PYGZsh{} raw.filter(1, 40)  \PYGZsh{} Bandpass filter between 1\PYGZhy{}40 Hz}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{For EEG data, typical preprocessing includes:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. Loading data (MNE Python)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2. Filtering (typically bandpass between 1\PYGZhy{}40 Hz)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. Artifact rejection/correction (ICA for eye movements)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{4. Epoching around events of interest}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{5. Baseline correction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate some preprocessed data}
    \PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{32}
    \PYG{n}{n\PYGZus{}times} \PYG{o}{=} \PYG{l+m+mi}{1000}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5}
    
    \PYG{c+c1}{\PYGZsh{} Add some alpha oscillations (8\PYGZhy{}12 Hz)}
    \PYG{n}{times} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}times}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{250.0}  \PYG{c+c1}{\PYGZsh{} Assuming 250 Hz sampling rate}
    \PYG{n}{alpha\PYGZus{}oscillation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}
    \PYG{n}{data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{alpha\PYGZus{}oscillation} \PYG{o}{*} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Add to first few channels}
    
    \PYG{k}{return} \PYG{n}{data}\PYG{p}{,} \PYG{n}{times}
\end{sphinxVerbatim}


\subsection{8.1.3 Calcium Imaging}
\label{\detokenize{part2/ch08_data_science_pipeline:calcium-imaging}}
\sphinxAtStartPar
Calcium imaging measures intracellular calcium concentration changes as a proxy for neural activity.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process\PYGZus{}calcium\PYGZus{}data}\PYG{p}{(}\PYG{n}{raw\PYGZus{}fluorescence}\PYG{p}{,} \PYG{n}{frame\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Basic processing for calcium imaging data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        raw\PYGZus{}fluorescence: Matrix where rows are neurons and columns are frames}
\PYG{l+s+sd}{        frame\PYGZus{}rate: Imaging frame rate in Hz}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        df\PYGZus{}f: Delta F / F}
\PYG{l+s+sd}{        activity: Deconvolved neural activity estimate}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}frames} \PYG{o}{=} \PYG{n}{raw\PYGZus{}fluorescence}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}frames}\PYG{p}{)} \PYG{o}{/} \PYG{n}{frame\PYGZus{}rate}
    
    \PYG{c+c1}{\PYGZsh{} Calculate baseline (F0) as the 10th percentile over a sliding window}
    \PYG{n}{window\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{frame\PYGZus{}rate} \PYG{o}{*} \PYG{l+m+mi}{30}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 30 seconds window}
    \PYG{n}{baseline} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{raw\PYGZus{}fluorescence}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}frames}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{start} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{t} \PYG{o}{\PYGZhy{}} \PYG{n}{window\PYGZus{}size}\PYG{p}{)}
            \PYG{n}{end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{n\PYGZus{}frames}\PYG{p}{,} \PYG{n}{t} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{baseline}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{percentile}\PYG{p}{(}\PYG{n}{raw\PYGZus{}fluorescence}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{start}\PYG{p}{:}\PYG{n}{end}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate ΔF/F}
    \PYG{n}{df\PYGZus{}f} \PYG{o}{=} \PYG{p}{(}\PYG{n}{raw\PYGZus{}fluorescence} \PYG{o}{\PYGZhy{}} \PYG{n}{baseline}\PYG{p}{)} \PYG{o}{/} \PYG{n}{baseline}
    
    \PYG{c+c1}{\PYGZsh{} In real applications, you would deconvolve to estimate spike rates}
    \PYG{c+c1}{\PYGZsh{} Here, we use a simple threshold\PYGZhy{}based approach}
    \PYG{n}{activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{df\PYGZus{}f}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Detect calcium transients using a simple threshold}
        \PYG{n}{activity}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{convolve}\PYG{p}{(}
            \PYG{p}{(}\PYG{n}{df\PYGZus{}f}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{df\PYGZus{}f}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Exponential kernel}
            \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{df\PYGZus{}f}\PYG{p}{,} \PYG{n}{activity}
\end{sphinxVerbatim}


\subsection{8.1.4 Behavioral Measurements}
\label{\detokenize{part2/ch08_data_science_pipeline:behavioral-measurements}}
\sphinxAtStartPar
Integrating neural activity with behavior is crucial for understanding neural function.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{correlate\PYGZus{}neural\PYGZus{}behavioral\PYGZus{}data}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{,} \PYG{n}{behavior}\PYG{p}{,} \PYG{n}{lag\PYGZus{}range}\PYG{o}{=}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{l+m+mi}{500}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute cross\PYGZhy{}correlation between neural activity and behavioral measurements.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}activity: Neural activity time series}
\PYG{l+s+sd}{        behavior: Behavioral measurement time series}
\PYG{l+s+sd}{        lag\PYGZus{}range: Range of lags to compute in ms}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        lags: Array of lag times in ms}
\PYG{l+s+sd}{        cross\PYGZus{}corr: Cross\PYGZhy{}correlation values}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Ensure inputs are standardized}
    \PYG{n}{neural\PYGZus{}activity} \PYG{o}{=} \PYG{p}{(}\PYG{n}{neural\PYGZus{}activity} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{)}
    \PYG{n}{behavior} \PYG{o}{=} \PYG{p}{(}\PYG{n}{behavior} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{behavior}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{behavior}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute cross\PYGZhy{}correlation}
    \PYG{n}{lags} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{lag\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lag\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{cross\PYGZus{}corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{[}\PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{)}\PYG{p}{:}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}
                   \PYG{n}{behavior}\PYG{p}{[}\PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{lag}\PYG{p}{)}\PYG{p}{:}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{behavior}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{behavior}\PYG{p}{)}\PYG{o}{+}\PYG{n}{lag}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{lag} \PYG{o+ow}{in} \PYG{n}{lags}
    \PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{lags}\PYG{p}{,} \PYG{n}{cross\PYGZus{}corr}
\end{sphinxVerbatim}


\section{8.2 Data Preprocessing}
\label{\detokenize{part2/ch08_data_science_pipeline:data-preprocessing}}
\sphinxAtStartPar
Proper preprocessing is critical for reliable results.


\subsection{8.2.1 Filtering and Artifact Removal}
\label{\detokenize{part2/ch08_data_science_pipeline:filtering-and-artifact-removal}}
\sphinxAtStartPar
Signal filtering removes noise and isolates frequency bands of interest.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{preprocess\PYGZus{}neural\PYGZus{}signal}\PYG{p}{(}\PYG{n}{signal\PYGZus{}data}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} 
                             \PYG{n}{notch\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mi}{60}\PYG{p}{,} \PYG{n}{bandpass}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply common preprocessing steps to neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        signal\PYGZus{}data: Raw neural signal}
\PYG{l+s+sd}{        sampling\PYGZus{}rate: Sampling rate in Hz}
\PYG{l+s+sd}{        notch\PYGZus{}freq: Frequency to remove (e.g., 60 Hz line noise)}
\PYG{l+s+sd}{        bandpass: Tuple of (low, high) frequencies for bandpass filter}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        filtered\PYGZus{}signal: Preprocessed signal}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal} \PYG{k}{as} \PYG{n}{sp\PYGZus{}signal}
    
    \PYG{c+c1}{\PYGZsh{} Apply notch filter to remove line noise}
    \PYG{n}{notch\PYGZus{}b}\PYG{p}{,} \PYG{n}{notch\PYGZus{}a} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{iirnotch}\PYG{p}{(}\PYG{n}{notch\PYGZus{}freq}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
    \PYG{n}{notch\PYGZus{}filtered} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{notch\PYGZus{}b}\PYG{p}{,} \PYG{n}{notch\PYGZus{}a}\PYG{p}{,} \PYG{n}{signal\PYGZus{}data}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply bandpass filter}
    \PYG{n}{nyquist} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}
    \PYG{n}{low}\PYG{p}{,} \PYG{n}{high} \PYG{o}{=} \PYG{n}{bandpass}
    \PYG{n}{b}\PYG{p}{,} \PYG{n}{a} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{p}{[}\PYG{n}{low}\PYG{o}{/}\PYG{n}{nyquist}\PYG{p}{,} \PYG{n}{high}\PYG{o}{/}\PYG{n}{nyquist}\PYG{p}{]}\PYG{p}{,} \PYG{n}{btype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{bandpass\PYGZus{}filtered} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{notch\PYGZus{}filtered}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{bandpass\PYGZus{}filtered}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{detect\PYGZus{}artifacts}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Detect artifacts in neural data using amplitude thresholding.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        signal: Neural signal}
\PYG{l+s+sd}{        threshold: Number of standard deviations for threshold}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        artifact\PYGZus{}indices: Indices where artifacts were detected}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{signal\PYGZus{}std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)}
    \PYG{n}{artifact\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold} \PYG{o}{*} \PYG{n}{signal\PYGZus{}std}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Expand artifact regions by 100 samples in each direction}
    \PYG{n}{expanded\PYGZus{}indices} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n}{artifact\PYGZus{}indices}\PYG{p}{:}
        \PYG{n}{expanded\PYGZus{}indices}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{idx}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{idx}\PYG{o}{+}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{expanded\PYGZus{}indices}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{8.2.2 Dimensionality Reduction Techniques}
\label{\detokenize{part2/ch08_data_science_pipeline:dimensionality-reduction-techniques}}
\sphinxAtStartPar
Neural datasets often have high dimensionality, requiring techniques to extract meaningful structure.

\sphinxAtStartPar
\sphinxincludegraphics{{dimensionality_reduction}.svg}
\sphinxstyleemphasis{Figure 8.2: Comparison of dimensionality reduction techniques for neural data, showing how high\sphinxhyphen{}dimensional data can be projected into lower\sphinxhyphen{}dimensional spaces using PCA, t\sphinxhyphen{}SNE, and UMAP.}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}dimensionality\PYGZus{}reduction}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pca}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply dimensionality reduction to neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        data: Neural data array (samples × features)}
\PYG{l+s+sd}{        method: Dimensionality reduction method (\PYGZsq{}pca\PYGZsq{}, \PYGZsq{}tsne\PYGZsq{}, or \PYGZsq{}umap\PYGZsq{})}
\PYG{l+s+sd}{        n\PYGZus{}components: Number of dimensions in output}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        reduced\PYGZus{}data: Data in reduced dimensions}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{manifold}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{TSNE}
    
    \PYG{c+c1}{\PYGZsh{} Standardize data}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
    \PYG{n}{scaled\PYGZus{}data} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pca}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
        \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
        \PYG{n}{explained\PYGZus{}variance} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{explained\PYGZus{}variance\PYGZus{}ratio\PYGZus{}}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explained variance: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{explained\PYGZus{}variance}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tsne}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{TSNE}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}components}\PYG{p}{,} \PYG{n}{perplexity}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}
        \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{umap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{umap}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{umap}\PYG{o}{.}\PYG{n}{UMAP}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
            \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
        \PYG{k}{except} \PYG{n+ne}{ImportError}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{UMAP not installed. Install with: pip install umap\PYGZhy{}learn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{k+kc}{None}
    
    \PYG{k}{return} \PYG{n}{reduced\PYGZus{}data}
\end{sphinxVerbatim}


\subsection{8.2.3 Feature Extraction}
\label{\detokenize{part2/ch08_data_science_pipeline:feature-extraction}}
\sphinxAtStartPar
Extract meaningful features from raw neural data.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{extract\PYGZus{}frequency\PYGZus{}features}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} 
                              \PYG{n}{freq\PYGZus{}bands}\PYG{o}{=}\PYG{p}{[}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{13}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Extract frequency band features from neural signal.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        signal: Neural time series}
\PYG{l+s+sd}{        sampling\PYGZus{}rate: Sampling rate in Hz}
\PYG{l+s+sd}{        freq\PYGZus{}bands: List of frequency bands to extract (delta, theta, alpha, beta, gamma)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        band\PYGZus{}powers: Dictionary of power in each frequency band}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal} \PYG{k}{as} \PYG{n}{sp\PYGZus{}signal}
    
    \PYG{c+c1}{\PYGZsh{} Compute power spectral density}
    \PYG{n}{freqs}\PYG{p}{,} \PYG{n}{psd} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{welch}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{l+m+mi}{1024}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate power in each frequency band}
    \PYG{n}{band\PYGZus{}powers} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{band\PYGZus{}names} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{delta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{beta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gamma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{p}{(}\PYG{n}{band\PYGZus{}name}\PYG{p}{,} \PYG{p}{(}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{)}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{band\PYGZus{}names}\PYG{p}{,} \PYG{n}{freq\PYGZus{}bands}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Find frequency indices within the band}
        \PYG{n}{idx\PYGZus{}band} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logical\PYGZus{}and}\PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{low}\PYG{p}{,} \PYG{n}{freqs} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{high}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Calculate mean power in band}
        \PYG{n}{band\PYGZus{}powers}\PYG{p}{[}\PYG{n}{band\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{psd}\PYG{p}{[}\PYG{n}{idx\PYGZus{}band}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{band\PYGZus{}powers}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{extract\PYGZus{}spike\PYGZus{}features}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Extract features from spike train data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}times: Array of spike times in seconds}
\PYG{l+s+sd}{        duration: Total duration of recording in seconds}
\PYG{l+s+sd}{        bin\PYGZus{}size: Bin size for rate calculation in seconds}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        features: Dictionary of spike train features}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create binned spike counts}
    \PYG{n}{n\PYGZus{}bins} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{n}{bin\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{n\PYGZus{}bins} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}counts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bins}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate features}
    \PYG{n}{features} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{/} \PYG{n}{duration}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} in Hz}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cv}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Coefficient of variation}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{burst\PYGZus{}index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{3}\PYG{p}{)} \PYG{o}{/} \PYG{n}{n\PYGZus{}bins}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Fraction of bins with \PYGZgt{}3 spikes}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fano\PYGZus{}factor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{var}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts}\PYG{p}{)} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Fano factor}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{features}
\end{sphinxVerbatim}


\subsection{8.2.4 Normalization Approaches}
\label{\detokenize{part2/ch08_data_science_pipeline:normalization-approaches}}
\sphinxAtStartPar
Proper normalization is essential for comparing across different recordings or subjects.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{normalize\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zscore}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Normalize neural data using different approaches.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        data: Neural data array}
\PYG{l+s+sd}{        method: Normalization method (\PYGZsq{}zscore\PYGZsq{}, \PYGZsq{}minmax\PYGZsq{}, or \PYGZsq{}robust\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        normalized\PYGZus{}data: Normalized data}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zscore}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Z\PYGZhy{}score normalization (mean=0, std=1)}
        \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{normalized\PYGZus{}data} \PYG{o}{=} \PYG{p}{(}\PYG{n}{data} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Avoid division by zero}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{minmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Min\PYGZhy{}max normalization (range [0, 1])}
        \PYG{n}{min\PYGZus{}val} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{max\PYGZus{}val} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{normalized\PYGZus{}data} \PYG{o}{=} \PYG{p}{(}\PYG{n}{data} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}val}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{p}{(}\PYG{n}{max\PYGZus{}val} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}val}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{robust}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Robust scaling using median and IQR}
        \PYG{n}{median} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{q75}\PYG{p}{,} \PYG{n}{q25} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{percentile}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{75}\PYG{p}{,} \PYG{l+m+mi}{25}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{iqr} \PYG{o}{=} \PYG{n}{q75} \PYG{o}{\PYGZhy{}} \PYG{n}{q25}
        \PYG{n}{normalized\PYGZus{}data} \PYG{o}{=} \PYG{p}{(}\PYG{n}{data} \PYG{o}{\PYGZhy{}} \PYG{n}{median}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{iqr} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{normalized\PYGZus{}data}
\end{sphinxVerbatim}


\section{8.3 Exploratory Analysis}
\label{\detokenize{part2/ch08_data_science_pipeline:exploratory-analysis}}
\sphinxAtStartPar
Effective exploratory analysis reveals patterns and guides subsequent modeling.


\subsection{8.3.1 Descriptive Statistics for Neural Data}
\label{\detokenize{part2/ch08_data_science_pipeline:descriptive-statistics-for-neural-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}neural\PYGZus{}statistics}\PYG{p}{(}\PYG{n}{spike\PYGZus{}trains}\PYG{p}{,} \PYG{n}{lfp\PYGZus{}signals}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute basic statistics for neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}trains: Dictionary of neuron\PYGZus{}id \PYGZhy{}\PYGZgt{} spike times}
\PYG{l+s+sd}{        lfp\PYGZus{}signals: Dictionary of channel\PYGZus{}id \PYGZhy{}\PYGZgt{} LFP signal}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        stats: Dictionary of statistics}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{stats} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spiking}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lfp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Spiking statistics}
    \PYG{k}{for} \PYG{n}{neuron\PYGZus{}id}\PYG{p}{,} \PYG{n}{spikes} \PYG{o+ow}{in} \PYG{n}{spike\PYGZus{}trains}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
            \PYG{n}{isi} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Inter\PYGZhy{}spike intervals}
            \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spiking}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{neuron\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{spikes}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{spikes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mean\PYGZus{}isi}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cv\PYGZus{}isi}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{burst\PYGZus{}index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{isi} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.01}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Fraction of ISIs \PYGZlt{} 10 ms}
            \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} LFP statistics}
    \PYG{k}{for} \PYG{n}{channel\PYGZus{}id}\PYG{p}{,} \PYG{n}{lfp} \PYG{o+ow}{in} \PYG{n}{lfp\PYGZus{}signals}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lfp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{channel\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mean}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{lfp}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{lfp}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{lfp}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{lfp}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{power}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{lfp}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{stats}
\end{sphinxVerbatim}


\subsection{8.3.2 Visualization Techniques}
\label{\detokenize{part2/ch08_data_science_pipeline:visualization-techniques}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{lfp\PYGZus{}data}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create common visualizations for neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}times: List of spike times in seconds}
\PYG{l+s+sd}{        lfp\PYGZus{}data: LFP signal array}
\PYG{l+s+sd}{        sampling\PYGZus{}rate: Sampling rate in Hz}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal} \PYG{k}{as} \PYG{n}{sp\PYGZus{}signal}
    
    \PYG{c+c1}{\PYGZsh{} Create figure with multiple plots}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{,} \PYG{n}{sharex}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Time axis for LFP (assuming LFP starts at time 0)}
    \PYG{n}{t\PYGZus{}lfp} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{lfp\PYGZus{}data}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}
    
    \PYG{c+c1}{\PYGZsh{} Plot 1: Raw LFP trace}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t\PYGZus{}lfp}\PYG{p}{,} \PYG{n}{lfp\PYGZus{}data}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP (μV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raw LFP Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 2: Spectrogram}
    \PYG{n}{f}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{spectrogram}\PYG{p}{(}\PYG{n}{lfp\PYGZus{}data}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{noverlap}\PYG{o}{=}\PYG{l+m+mi}{128}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx}\PYG{p}{)}\PYG{p}{,} \PYG{n}{shading}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gouraud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP Spectrogram}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 3: Spike raster}
    \PYG{k}{if} \PYG{n}{spike\PYGZus{}times}\PYG{o}{.}\PYG{n}{size} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{eventplot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{spike\PYGZus{}times}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lineoffsets}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linelengths}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}firing\PYGZus{}rate\PYGZus{}heatmap}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times\PYGZus{}dict}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a heatmap of firing rates over time.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}times\PYGZus{}dict: Dictionary mapping neuron\PYGZus{}id to spike times}
\PYG{l+s+sd}{        bin\PYGZus{}size: Bin size for rate calculation in seconds}
\PYG{l+s+sd}{        duration: Total duration; if None, inferred from data}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    
    \PYG{c+c1}{\PYGZsh{} Determine duration if not provided}
    \PYG{k}{if} \PYG{n}{duration} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{all\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times\PYGZus{}dict}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{duration} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{all\PYGZus{}spikes}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{all\PYGZus{}spikes}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mf}{1.0}
    
    \PYG{c+c1}{\PYGZsh{} Create time bins}
    \PYG{n}{bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration} \PYG{o}{+} \PYG{n}{bin\PYGZus{}size}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{neuron\PYGZus{}ids} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times\PYGZus{}dict}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate binned spike counts}
    \PYG{n}{binned\PYGZus{}rates} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{neuron\PYGZus{}ids}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}id} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{neuron\PYGZus{}ids}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{counts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times\PYGZus{}dict}\PYG{p}{[}\PYG{n}{neuron\PYGZus{}id}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bins}\PYG{p}{)}
        \PYG{n}{binned\PYGZus{}rates}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{counts} \PYG{o}{/} \PYG{n}{bin\PYGZus{}size}  \PYG{c+c1}{\PYGZsh{} Convert to Hz}
    
    \PYG{c+c1}{\PYGZsh{} Sort neurons by average firing rate}
    \PYG{n}{avg\PYGZus{}rates} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{binned\PYGZus{}rates}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{sort\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{avg\PYGZus{}rates}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Descending order}
    \PYG{n}{binned\PYGZus{}rates} \PYG{o}{=} \PYG{n}{binned\PYGZus{}rates}\PYG{p}{[}\PYG{n}{sort\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}
    \PYG{n}{sorted\PYGZus{}ids} \PYG{o}{=} \PYG{p}{[}\PYG{n}{neuron\PYGZus{}ids}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{sort\PYGZus{}idx}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Plot heatmap}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{binned\PYGZus{}rates}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                  \PYG{n}{extent}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{neuron\PYGZus{}ids}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron (sorted by firing rate)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate Heatmap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{cbar} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}
    \PYG{n}{cbar}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{8.3.3 Dimensionality Reduction and Visualization}
\label{\detokenize{part2/ch08_data_science_pipeline:dimensionality-reduction-and-visualization}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}neural\PYGZus{}trajectories}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{,} \PYG{n}{times}\PYG{p}{,} \PYG{n}{events}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pca}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize neural trajectories using dimensionality reduction.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}activity: Array of shape (n\PYGZus{}neurons, n\PYGZus{}timepoints)}
\PYG{l+s+sd}{        times: Time points corresponding to neural activity}
\PYG{l+s+sd}{        events: Optional dictionary of event\PYGZus{}name \PYGZhy{}\PYGZgt{} event\PYGZus{}times}
\PYG{l+s+sd}{        method: Dimensionality reduction method (\PYGZsq{}pca\PYGZsq{} or \PYGZsq{}tsne\PYGZsq{})}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Axes3D}
    
    \PYG{c+c1}{\PYGZsh{} Transpose to (n\PYGZus{}timepoints, n\PYGZus{}neurons) for sklearn}
    \PYG{n}{activity\PYGZus{}T} \PYG{o}{=} \PYG{n}{neural\PYGZus{}activity}\PYG{o}{.}\PYG{n}{T}
    
    \PYG{c+c1}{\PYGZsh{} Apply dimensionality reduction}
    \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{n}{apply\PYGZus{}dimensionality\PYGZus{}reduction}\PYG{p}{(}\PYG{n}{activity\PYGZus{}T}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{n}{method}\PYG{p}{,} \PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create 3D trajectory plot}
    \PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Color dots based on time}
    \PYG{n}{scatter} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}
                        \PYG{n}{c}\PYG{o}{=}\PYG{n}{times}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot trajectory line}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} 
           \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark events if provided}
    \PYG{k}{if} \PYG{n}{events} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{colors} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{tab10}\PYG{o}{.}\PYG{n}{colors}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{event\PYGZus{}name}\PYG{p}{,} \PYG{n}{event\PYGZus{}times}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{events}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{event\PYGZus{}time} \PYG{o+ow}{in} \PYG{n}{event\PYGZus{}times}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Find closest timepoint}
                \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{times} \PYG{o}{\PYGZhy{}} \PYG{n}{event\PYGZus{}time}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}
                          \PYG{n}{color}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{[}\PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{colors}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{n}{event\PYGZus{}name} \PYG{k}{if} \PYG{n}{event\PYGZus{}time} \PYG{o}{==} \PYG{n}{event\PYGZus{}times}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{method}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Component 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{method}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Component 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{method}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Component 3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Trajectories (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{method}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{events} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{scatter}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{8.3.4 Time\sphinxhyphen{}Frequency Analysis}
\label{\detokenize{part2/ch08_data_science_pipeline:time-frequency-analysis}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}time\PYGZus{}frequency}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wavelet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Perform time\PYGZhy{}frequency analysis on neural signals.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        signal: Time series data}
\PYG{l+s+sd}{        sampling\PYGZus{}rate: Sampling rate in Hz}
\PYG{l+s+sd}{        method: Method to use (\PYGZsq{}stft\PYGZsq{}, \PYGZsq{}wavelet\PYGZsq{}, or \PYGZsq{}multitaper\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        time: Time points}
\PYG{l+s+sd}{        frequencies: Frequency values}
\PYG{l+s+sd}{        power: Time\PYGZhy{}frequency power values}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal} \PYG{k}{as} \PYG{n}{sp\PYGZus{}signal}
    
    \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stft}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Short\PYGZhy{}time Fourier transform}
        \PYG{n}{f}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{spectrogram}\PYG{p}{(}
            \PYG{n}{signal}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{noverlap}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{20}\PYG{p}{)}
        \PYG{n}{power} \PYG{o}{=} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Convert to dB}
        \PYG{k}{return} \PYG{n}{t}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{n}{power}
    
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wavelet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Continuous wavelet transform}
        \PYG{c+c1}{\PYGZsh{} Define frequencies of interest (1\PYGZhy{}100 Hz, logarithmically spaced)}
        \PYG{n}{frequencies} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logspace}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Time vector}
        \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}
        
        \PYG{c+c1}{\PYGZsh{} Compute wavelet transform (simplified example)}
        \PYG{n}{power} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{frequencies}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{freq} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{frequencies}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Calculate appropriate scales for Morlet wavelet}
            \PYG{n}{scale} \PYG{o}{=} \PYG{n}{sampling\PYGZus{}rate} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{freq}\PYG{p}{)}
            \PYG{n}{wavelet} \PYG{o}{=} \PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{morlet2}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{scale}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{scale}\PYG{p}{,} \PYG{n}{w}\PYG{o}{=}\PYG{l+m+mi}{6}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Convolve signal with wavelet}
            \PYG{n}{power}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{sp\PYGZus{}signal}\PYG{o}{.}\PYG{n}{convolve}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{wavelet}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
        
        \PYG{k}{return} \PYG{n}{time}\PYG{p}{,} \PYG{n}{frequencies}\PYG{p}{,} \PYG{n}{power}
    
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{multitaper}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Multitaper method (using spectrum\PYGZus{}fft function)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Multitaper method requires specialized libraries like nitime or spectrum.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Using spectrogram method instead.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{compute\PYGZus{}time\PYGZus{}frequency}\PYG{p}{(}\PYG{n}{signal}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stft}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{8.4 Statistical Modeling}
\label{\detokenize{part2/ch08_data_science_pipeline:statistical-modeling}}

\subsection{8.4.1 Generalized Linear Models for Neural Data}
\label{\detokenize{part2/ch08_data_science_pipeline:generalized-linear-models-for-neural-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit\PYGZus{}neural\PYGZus{}glm}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts}\PYG{p}{,} \PYG{n}{covariates}\PYG{p}{,} \PYG{n}{family}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{poisson}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Fit a generalized linear model to neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}counts: Array of spike counts (n\PYGZus{}trials, n\PYGZus{}neurons)}
\PYG{l+s+sd}{        covariates: Array of predictor variables (n\PYGZus{}trials, n\PYGZus{}features)}
\PYG{l+s+sd}{        family: Distribution family (\PYGZsq{}poisson\PYGZsq{}, \PYGZsq{}binomial\PYGZsq{}, or \PYGZsq{}gaussian\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        results: GLM results dictionary}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{statsmodels}\PYG{n+nn}{.}\PYG{n+nn}{api}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sm}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
    
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{spike\PYGZus{}counts}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create DataFrame for StatsModels}
        \PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{covariates}\PYG{p}{)}
        \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spike\PYGZus{}count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{spike\PYGZus{}counts}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Define model formula}
        \PYG{n}{endog} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spike\PYGZus{}count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{exog} \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{add\PYGZus{}constant}\PYG{p}{(}\PYG{n}{df}\PYG{o}{.}\PYG{n}{drop}\PYG{p}{(}\PYG{n}{columns}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spike\PYGZus{}count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Fit GLM with appropriate family}
        \PYG{k}{if} \PYG{n}{family} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{poisson}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{GLM}\PYG{p}{(}\PYG{n}{endog}\PYG{p}{,} \PYG{n}{exog}\PYG{p}{,} \PYG{n}{family}\PYG{o}{=}\PYG{n}{sm}\PYG{o}{.}\PYG{n}{families}\PYG{o}{.}\PYG{n}{Poisson}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{family} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{binomial}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{GLM}\PYG{p}{(}\PYG{n}{endog}\PYG{p}{,} \PYG{n}{exog}\PYG{p}{,} \PYG{n}{family}\PYG{o}{=}\PYG{n}{sm}\PYG{o}{.}\PYG{n}{families}\PYG{o}{.}\PYG{n}{Binomial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} gaussian}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{GLM}\PYG{p}{(}\PYG{n}{endog}\PYG{p}{,} \PYG{n}{exog}\PYG{p}{,} \PYG{n}{family}\PYG{o}{=}\PYG{n}{sm}\PYG{o}{.}\PYG{n}{families}\PYG{o}{.}\PYG{n}{Gaussian}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
        \PYG{n}{model\PYGZus{}results} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Store results}
        \PYG{n}{results}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{neuron\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coefficients}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{params}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pvalues}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{pvalues}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{deviance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{deviance}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{aic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{aic}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{bic}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{summary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}results}\PYG{o}{.}\PYG{n}{summary}\PYG{p}{(}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\subsection{8.4.2 Point Process Models for Spike Trains}
\label{\detokenize{part2/ch08_data_science_pipeline:point-process-models-for-spike-trains}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit\PYGZus{}point\PYGZus{}process\PYGZus{}model}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{covariates}\PYG{p}{,} \PYG{n}{covariate\PYGZus{}times}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Fit a point process model to spike train data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        spike\PYGZus{}times: Array of spike times in ms}
\PYG{l+s+sd}{        covariates: Dictionary of covariate\PYGZus{}name \PYGZhy{}\PYGZgt{} covariate\PYGZus{}values}
\PYG{l+s+sd}{        covariate\PYGZus{}times: Time points for covariates}
\PYG{l+s+sd}{        window\PYGZus{}size: Window size in ms for history effects}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        model\PYGZus{}results: Point process model results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This is a simplified example of point process modeling}
    \PYG{c+c1}{\PYGZsh{} Real implementations would use specialized libraries}
    
    \PYG{c+c1}{\PYGZsh{} Bin spikes (1 ms bins)}
    \PYG{n}{max\PYGZus{}time} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{covariate\PYGZus{}times}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{covariate\PYGZus{}times}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}time} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}counts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bins}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Interpolate covariates to match spike bins}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{interpolate}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{interp1d}
    
    \PYG{n}{interp\PYGZus{}covariates} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{values} \PYG{o+ow}{in} \PYG{n}{covariates}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{f} \PYG{o}{=} \PYG{n}{interp1d}\PYG{p}{(}\PYG{n}{covariate\PYGZus{}times}\PYG{p}{,} \PYG{n}{values}\PYG{p}{,} \PYG{n}{kind}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{bounds\PYGZus{}error}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{fill\PYGZus{}value}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{extrapolate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{interp\PYGZus{}covariates}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{f}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create design matrix with history terms}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{interp\PYGZus{}covariates}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{covariates}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add spike history terms}
    \PYG{k}{for} \PYG{n}{lag} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{window\PYGZus{}size} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{history} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts}\PYG{p}{)}
        \PYG{n}{history}\PYG{p}{[}\PYG{n}{lag}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{spike\PYGZus{}counts}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{]}
        \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{history}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Fit GLM (Poisson regression)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PoissonRegressor}
    
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{PoissonRegressor}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} L2 regularization}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{spike\PYGZus{}counts}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate model performance}
    \PYG{n}{predicted} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n}{ll} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{spike\PYGZus{}counts} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{predicted} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{predicted}\PYG{p}{)}
    
    \PYG{n}{feature\PYGZus{}names} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{covariates}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{history\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{window\PYGZus{}size} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coefficients}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{feature\PYGZus{}names}\PYG{p}{,} \PYG{n}{model}\PYG{o}{.}\PYG{n}{coef\PYGZus{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}likelihood}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{ll}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\subsection{8.4.3 Bayesian Approaches}
\label{\detokenize{part2/ch08_data_science_pipeline:bayesian-approaches}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit\PYGZus{}bayesian\PYGZus{}neural\PYGZus{}model}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{covariates}\PYG{p}{,} \PYG{n}{model\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Fit a Bayesian model to neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}data: Neural activity data (n\PYGZus{}samples, n\PYGZus{}neurons)}
\PYG{l+s+sd}{        covariates: Predictor variables (n\PYGZus{}samples, n\PYGZus{}features)}
\PYG{l+s+sd}{        model\PYGZus{}type: Type of model (\PYGZsq{}linear\PYGZsq{}, \PYGZsq{}hierarchical\PYGZsq{}, or \PYGZsq{}mixture\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        model\PYGZus{}results: Dictionary of model results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Note: This is a placeholder for Bayesian modeling}
    \PYG{c+c1}{\PYGZsh{} In practice, you would use PyMC3, Stan, or other Bayesian libraries}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Bayesian modeling in neuroscience typically uses:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. PyMC3 or PyMC for Python\PYGZhy{}based probabilistic programming}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2. Stan for high\PYGZhy{}performance Bayesian inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. BayesOpt for Bayesian optimization of models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Linear Bayesian model: y \PYGZti{} Normal(X*β, σ)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{with priors: β \PYGZti{} Normal(0, τ), σ \PYGZti{} HalfCauchy(5)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hierarchical}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical Bayesian model for neurons with shared parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Individual neuron parameters drawn from population distribution}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mixture}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mixture model for detecting different neural states or clusters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Return placeholder results}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{model\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}type}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}neurons}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}covariates}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{covariates}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{message}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{This is a placeholder for actual Bayesian modeling with PyMC or Stan.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\subsection{8.4.4 Model Validation Techniques}
\label{\detokenize{part2/ch08_data_science_pipeline:model-validation-techniques}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{validate\PYGZus{}neural\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cross\PYGZus{}validation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}splits}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Validate a neural data model using various techniques.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        model: Fitted model object with predict method}
\PYG{l+s+sd}{        X: Features/covariates}
\PYG{l+s+sd}{        y: Target variable (neural activity)}
\PYG{l+s+sd}{        method: Validation method (\PYGZsq{}cross\PYGZus{}validation\PYGZsq{}, \PYGZsq{}bootstrap\PYGZsq{}, or \PYGZsq{}timeseries\PYGZus{}split\PYGZsq{})}
\PYG{l+s+sd}{        n\PYGZus{}splits: Number of splits for cross\PYGZhy{}validation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        metrics: Dictionary of validation metrics}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{KFold}\PYG{p}{,} \PYG{n}{TimeSeriesSplit}\PYG{p}{,} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{,} \PYG{n}{r2\PYGZus{}score}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{n}{metrics} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cross\PYGZus{}validation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} K\PYGZhy{}fold cross\PYGZhy{}validation}
        \PYG{n}{kf} \PYG{o}{=} \PYG{n}{KFold}\PYG{p}{(}\PYG{n}{n\PYGZus{}splits}\PYG{o}{=}\PYG{n}{n\PYGZus{}splits}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
        
        \PYG{n}{mse\PYGZus{}scores} \PYG{o}{=} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{scoring}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{neg\PYGZus{}mean\PYGZus{}squared\PYGZus{}error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cv}\PYG{o}{=}\PYG{n}{kf}\PYG{p}{)}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{scoring}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cv}\PYG{o}{=}\PYG{n}{kf}\PYG{p}{)}
        
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bootstrap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Bootstrap validation}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{resample}
        
        \PYG{n}{mse\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}splits}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create bootstrap sample}
            \PYG{n}{X\PYGZus{}boot}\PYG{p}{,} \PYG{n}{y\PYGZus{}boot} \PYG{o}{=} \PYG{n}{resample}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{n}{i}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Fit model on bootstrap sample}
            \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}boot}\PYG{p}{,} \PYG{n}{y\PYGZus{}boot}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Predict on original data}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute metrics}
            \PYG{n}{mse\PYGZus{}scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{r2\PYGZus{}scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{timeseries\PYGZus{}split}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Time series cross\PYGZhy{}validation}
        \PYG{n}{tscv} \PYG{o}{=} \PYG{n}{TimeSeriesSplit}\PYG{p}{(}\PYG{n}{n\PYGZus{}splits}\PYG{o}{=}\PYG{n}{n\PYGZus{}splits}\PYG{p}{)}
        
        \PYG{n}{mse\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{train\PYGZus{}idx}\PYG{p}{,} \PYG{n}{test\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n}{tscv}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{n}{train\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{test\PYGZus{}idx}\PYG{p}{]}
            \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{n}{train\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{test\PYGZus{}idx}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Fit and predict}
            \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute metrics}
            \PYG{n}{mse\PYGZus{}scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{r2\PYGZus{}scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mse\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{mse\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{metrics}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2\PYGZus{}std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{metrics}
\end{sphinxVerbatim}


\section{8.5 Machine Learning Applications}
\label{\detokenize{part2/ch08_data_science_pipeline:machine-learning-applications}}

\subsection{8.5.1 Supervised Learning for Neural Decoding}
\label{\detokenize{part2/ch08_data_science_pipeline:supervised-learning-for-neural-decoding}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}decoding}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{classifier\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{svm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Decode stimuli or behavior from neural activity.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}data: Neural features (n\PYGZus{}samples, n\PYGZus{}features)}
\PYG{l+s+sd}{        stimulus: Target variable to decode (n\PYGZus{}samples,)}
\PYG{l+s+sd}{        test\PYGZus{}size: Proportion of data to use for testing}
\PYG{l+s+sd}{        classifier\PYGZus{}type: Type of classifier (\PYGZsq{}svm\PYGZsq{}, \PYGZsq{}rf\PYGZsq{}, or \PYGZsq{}lda\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        results: Dictionary of decoding results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{svm}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{SVC}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{ensemble}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{RandomForestClassifier}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{discriminant\PYGZus{}analysis}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearDiscriminantAnalysis}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{,} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{classification\PYGZus{}report}
    
    \PYG{c+c1}{\PYGZsh{} Split data}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{stimulus}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{n}{test\PYGZus{}size}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Standardize features}
    \PYG{n}{scaler} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train\PYGZus{}scaled} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test\PYGZus{}scaled} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Select and train classifier}
    \PYG{k}{if} \PYG{n}{classifier\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{svm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{classifier} \PYG{o}{=} \PYG{n}{SVC}\PYG{p}{(}\PYG{n}{kernel}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{C}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{probability}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{classifier\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{classifier} \PYG{o}{=} \PYG{n}{RandomForestClassifier}\PYG{p}{(}\PYG{n}{n\PYGZus{}estimators}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{classifier\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lda}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{classifier} \PYG{o}{=} \PYG{n}{LinearDiscriminantAnalysis}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{classifier}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}scaled}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Make predictions}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{classifier}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}scaled}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}prob} \PYG{o}{=} \PYG{n}{classifier}\PYG{o}{.}\PYG{n}{predict\PYGZus{}proba}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}scaled}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{hasattr}\PYG{p}{(}\PYG{n}{classifier}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{predict\PYGZus{}proba}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{else} \PYG{k+kc}{None}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate performance}
    \PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
    \PYG{n}{conf\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
    \PYG{n}{class\PYGZus{}report} \PYG{o}{=} \PYG{n}{classification\PYGZus{}report}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{,} \PYG{n}{output\PYGZus{}dict}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compile results}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classifier\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{classifier\PYGZus{}type}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{accuracy}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{confusion\PYGZus{}matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{conf\PYGZus{}matrix}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{class\PYGZus{}report}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classifier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{classifier}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{scaler}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{scaler}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{if} \PYG{n}{y\PYGZus{}prob} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{prediction\PYGZus{}probabilities}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{y\PYGZus{}prob}
    
    \PYG{k}{return} \PYG{n}{results}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}decoding\PYGZus{}results}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize neural decoding results.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        decoding\PYGZus{}results: Results from neural\PYGZus{}decoding function}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
    
    \PYG{c+c1}{\PYGZsh{} Create figure with subplots}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot confusion matrix}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{heatmap}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{confusion\PYGZus{}matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{annot}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{fmt}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Blues}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{n}{xticklabels}\PYG{o}{=}\PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{yticklabels}\PYG{o}{=}\PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Confusion Matrix}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot class performance}
    \PYG{n}{classes} \PYG{o}{=} \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{]}
    \PYG{n}{f1\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{f1\PYGZhy{}score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n}{classes}\PYG{p}{]}
    
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{classes}\PYG{p}{,} \PYG{n}{f1\PYGZus{}scores}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F1 Score by Class}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F1 Score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{8.5.2 Unsupervised Learning for Pattern Discovery}
\label{\detokenize{part2/ch08_data_science_pipeline:unsupervised-learning-for-pattern-discovery}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{discover\PYGZus{}neural\PYGZus{}patterns}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Discover patterns in neural data using unsupervised learning.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}data: Neural activity data (n\PYGZus{}samples, n\PYGZus{}features)}
\PYG{l+s+sd}{        method: Method to use (\PYGZsq{}clustering\PYGZsq{}, \PYGZsq{}hmm\PYGZsq{}, or \PYGZsq{}nmf\PYGZsq{})}
\PYG{l+s+sd}{        n\PYGZus{}clusters: Number of clusters/components to find}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        results: Dictionary with pattern discovery results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{cluster}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{KMeans}\PYG{p}{,} \PYG{n}{DBSCAN}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{NMF}\PYG{p}{,} \PYG{n}{PCA}
    
    \PYG{c+c1}{\PYGZsh{} Standardize data}
    \PYG{n}{scaled\PYGZus{}data} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} K\PYGZhy{}means clustering}
        \PYG{n}{kmeans} \PYG{o}{=} \PYG{n}{KMeans}\PYG{p}{(}\PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{n}{n\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
        \PYG{n}{clusters} \PYG{o}{=} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{fit\PYGZus{}predict}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute cluster statistics}
        \PYG{n}{cluster\PYGZus{}stats} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}clusters}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{cluster\PYGZus{}data} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data}\PYG{p}{[}\PYG{n}{clusters} \PYG{o}{==} \PYG{n}{i}\PYG{p}{]}
            \PYG{n}{cluster\PYGZus{}stats}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{cluster\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{percentage}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{cluster\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{/} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{100}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mean}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{cluster\PYGZus{}data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{cluster\PYGZus{}data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{clusters}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}centers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{cluster\PYGZus{}centers\PYGZus{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}stats}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{cluster\PYGZus{}stats}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inertia}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{inertia\PYGZus{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}clusters}
        \PYG{p}{\PYGZcb{}}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Hidden Markov Model}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{hmmlearn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{hmm}
            
            \PYG{c+c1}{\PYGZsh{} Fit HMM}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{hmm}\PYG{o}{.}\PYG{n}{GaussianHMM}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{covariance\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{full}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
            \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Decode states}
            \PYG{n}{states} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{)}
            
            \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{states}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{states}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{state\PYGZus{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{o}{.}\PYG{n}{means\PYGZus{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{state\PYGZus{}covars}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{o}{.}\PYG{n}{covars\PYGZus{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transition\PYGZus{}matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{o}{.}\PYG{n}{transmat\PYGZus{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}states}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}clusters}
            \PYG{p}{\PYGZcb{}}
            
        \PYG{k}{except} \PYG{n+ne}{ImportError}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{hmmlearn not installed. Install with: pip install hmmlearn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} Fallback to k\PYGZhy{}means}
            \PYG{k}{return} \PYG{n}{discover\PYGZus{}neural\PYGZus{}patterns}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{n}{n\PYGZus{}clusters}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nmf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Non\PYGZhy{}negative Matrix Factorization}
        \PYG{c+c1}{\PYGZsh{} Ensure data is non\PYGZhy{}negative}
        \PYG{n}{min\PYGZus{}val} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
        \PYG{n}{shifted\PYGZus{}data} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}val} \PYG{k}{if} \PYG{n}{min\PYGZus{}val} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{neural\PYGZus{}data}
        
        \PYG{c+c1}{\PYGZsh{} Fit NMF}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{NMF}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
        \PYG{n}{W} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{shifted\PYGZus{}data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Weights}
        \PYG{n}{H} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{components\PYGZus{}}  \PYG{c+c1}{\PYGZsh{} Components}
        
        \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nmf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{W}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{components}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{H}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}components}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}clusters}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reconstruction\PYGZus{}error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{o}{.}\PYG{n}{reconstruction\PYGZus{}err\PYGZus{}}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}neural\PYGZus{}patterns}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{times}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize patterns discovered in neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        pattern\PYGZus{}results: Results from discover\PYGZus{}neural\PYGZus{}patterns function}
\PYG{l+s+sd}{        neural\PYGZus{}data: Original neural data}
\PYG{l+s+sd}{        times: Time points corresponding to neural data (optional)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
    
    \PYG{c+c1}{\PYGZsh{} Create figure with subplots}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reduce dimensionality for visualization}
    \PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{reduced\PYGZus{}data} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 1: PCA with clusters or states}
    \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{labels} \PYG{o}{=} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{else} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{states}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{n}{scatter} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{labels}\PYG{p}{,} 
                               \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Transform cluster centers to PCA space}
            \PYG{n}{centers} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}centers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{centers}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{scatter}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cluster/State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PCA Projection with }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ Labels}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
    \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} NMF}
        \PYG{c+c1}{\PYGZsh{} For NMF, color by the dominant component}
        \PYG{n}{dominant\PYGZus{}comp} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{scatter} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reduced\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{dominant\PYGZus{}comp}\PYG{p}{,} 
                               \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{scatter}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dominant Component}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PCA Projection with Dominant NMF Component}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PC1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PC2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 2: Pattern profiles}
    \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{center} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}centers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{center}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cluster }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cluster Centers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{mean} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{state\PYGZus{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{mean}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{State }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{State Means}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} NMF}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{comp} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{components}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{comp}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Component }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NMF Components}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 3: Time series (if time information provided)}
    \PYG{k}{if} \PYG{n}{times} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{n}{labels} \PYG{o}{=} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{else} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{states}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Plot the first 3 neurons with cluster/state coloring}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{times}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
                
            \PYG{c+c1}{\PYGZsh{} Color the background by state/cluster}
            \PYG{n}{n\PYGZus{}labels} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{cmap} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{get\PYGZus{}cmap}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}labels}\PYG{p}{)}
            
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{mask} \PYG{o}{=} \PYG{n}{labels} \PYG{o}{==} \PYG{n}{label}
                \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{mask}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{segments} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{(}\PYG{p}{[}\PYG{k+kc}{False}\PYG{p}{]}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{,} \PYG{p}{[}\PYG{k+kc}{False}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
                    \PYG{n}{segments} \PYG{o}{=} \PYG{n}{segments}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
                    
                    \PYG{k}{for} \PYG{n}{start}\PYG{p}{,} \PYG{n}{end} \PYG{o+ow}{in} \PYG{n}{segments}\PYG{p}{:}
                        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{times}\PYG{p}{[}\PYG{n}{start}\PYG{p}{]}\PYG{p}{,} \PYG{n}{times}\PYG{p}{[}\PYG{n}{end}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural Activity with Clusters/States}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Activity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            
        \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} NMF}
            \PYG{c+c1}{\PYGZsh{} Plot component activations over time}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}components}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{times}\PYG{p}{,} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comp }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Component Activations Over Time}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Activation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot 4: Additional analysis}
    \PYG{k}{if} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}means}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Silhouette score plot or cluster distribution}
        \PYG{n}{sizes} \PYG{o}{=} \PYG{p}{[}\PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{stats} \PYG{o+ow}{in} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cluster\PYGZus{}stats}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
        \PYG{n}{labels} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cluster }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sizes}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{pie}\PYG{p}{(}\PYG{n}{sizes}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{n}{labels}\PYG{p}{,} \PYG{n}{autopct}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZpc{}1.1f}\PYG{l+s+si}{\PYGZpc{}\PYGZpc{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{startangle}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cluster Distribution}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Transition matrix as heatmap}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
        \PYG{n}{sns}\PYG{o}{.}\PYG{n}{heatmap}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transition\PYGZus{}matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{annot}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Blues}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{HMM Transition Matrix}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{To State}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{From State}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
    \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} NMF}
        \PYG{c+c1}{\PYGZsh{} Component importance or reconstruction error}
        \PYG{n}{explained\PYGZus{}var} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{var}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{explained\PYGZus{}var\PYGZus{}ratio} \PYG{o}{=} \PYG{n}{explained\PYGZus{}var} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{explained\PYGZus{}var}\PYG{p}{)}
        
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{explained\PYGZus{}var\PYGZus{}ratio}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{explained\PYGZus{}var\PYGZus{}ratio}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Component Variance Contribution}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Component}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Variance Ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{8.5.3 Deep Learning Approaches for Neural Data}
\label{\detokenize{part2/ch08_data_science_pipeline:deep-learning-approaches-for-neural-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}neural\PYGZus{}network\PYGZus{}model}\PYG{p}{(}\PYG{n}{input\PYGZus{}shape}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{,} \PYG{n}{model\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cnn}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create deep learning models for neural data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        input\PYGZus{}shape: Shape of input data (e.g., (time\PYGZus{}steps, features))}
\PYG{l+s+sd}{        output\PYGZus{}size: Number of output classes or continuous outputs}
\PYG{l+s+sd}{        model\PYGZus{}type: Type of model (\PYGZsq{}cnn\PYGZsq{}, \PYGZsq{}rnn\PYGZsq{}, or \PYGZsq{}transformer\PYGZsq{})}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        model: Compiled neural network model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This is a placeholder for deep learning models}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Building deep neural networks for neural data typically requires:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. TensorFlow or PyTorch for implementing the models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2. Careful consideration of input data shape and temporal dynamics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. Appropriate regularization to prevent overfitting with limited data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cnn}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNNs are useful for spatial patterns in neural data, e.g., EEG topographies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Typical architecture: Conv1D layers for temporal data or Conv2D for images}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rnn}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RNNs/LSTMs are ideal for temporal sequences in neural data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Typical architecture: LSTM or GRU layers followed by dense layers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transformer}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transformers with attention can model long\PYGZhy{}range dependencies in neural data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Typical architecture: Self\PYGZhy{}attention layers with position encoding}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Return placeholder results}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{model\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}type}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{input\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{input\PYGZus{}shape}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{output\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{output\PYGZus{}size}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{message}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{This is a placeholder for actual deep learning model implementation}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\subsection{8.5.4 Transfer Learning and Domain Adaptation}
\label{\detokenize{part2/ch08_data_science_pipeline:transfer-learning-and-domain-adaptation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{transfer\PYGZus{}learning\PYGZus{}neural\PYGZus{}model}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{source\PYGZus{}labels}\PYG{p}{,} \PYG{n}{target\PYGZus{}data}\PYG{p}{,} \PYG{n}{target\PYGZus{}labels}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply transfer learning for neural data analysis.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        source\PYGZus{}data: Data from source domain}
\PYG{l+s+sd}{        source\PYGZus{}labels: Labels from source domain}
\PYG{l+s+sd}{        target\PYGZus{}data: Data from target domain}
\PYG{l+s+sd}{        target\PYGZus{}labels: Labels from target domain (can be limited)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        results: Transfer learning results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{ensemble}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{RandomForestClassifier}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}
    
    \PYG{c+c1}{\PYGZsh{} This is a simplified example of transfer learning}
    \PYG{c+c1}{\PYGZsh{} In practice, you would use neural networks and proper domain adaptation}
    
    \PYG{c+c1}{\PYGZsh{} Split target data into train/test}
    \PYG{n}{X\PYGZus{}target\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}target\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}target\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}target\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{target\PYGZus{}data}\PYG{p}{,} \PYG{n}{target\PYGZus{}labels}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Baseline model: train on target data only}
    \PYG{n}{baseline\PYGZus{}model} \PYG{o}{=} \PYG{n}{RandomForestClassifier}\PYG{p}{(}\PYG{n}{n\PYGZus{}estimators}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{baseline\PYGZus{}model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}target\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}target\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{baseline\PYGZus{}pred} \PYG{o}{=} \PYG{n}{baseline\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}target\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{baseline\PYGZus{}acc} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}target\PYGZus{}test}\PYG{p}{,} \PYG{n}{baseline\PYGZus{}pred}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Transfer learning approach: train on source + target data}
    \PYG{n}{combined\PYGZus{}X\PYGZus{}train} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{X\PYGZus{}target\PYGZus{}train}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{combined\PYGZus{}y\PYGZus{}train} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{[}\PYG{n}{source\PYGZus{}labels}\PYG{p}{,} \PYG{n}{y\PYGZus{}target\PYGZus{}train}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{n}{transfer\PYGZus{}model} \PYG{o}{=} \PYG{n}{RandomForestClassifier}\PYG{p}{(}\PYG{n}{n\PYGZus{}estimators}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{transfer\PYGZus{}model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{combined\PYGZus{}X\PYGZus{}train}\PYG{p}{,} \PYG{n}{combined\PYGZus{}y\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{transfer\PYGZus{}pred} \PYG{o}{=} \PYG{n}{transfer\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}target\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{transfer\PYGZus{}acc} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}target\PYGZus{}test}\PYG{p}{,} \PYG{n}{transfer\PYGZus{}pred}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Feature\PYGZhy{}based transfer (simple approach)}
    \PYG{c+c1}{\PYGZsh{} Train on source data, use predicted probabilities as features for target model}
    \PYG{n}{source\PYGZus{}model} \PYG{o}{=} \PYG{n}{RandomForestClassifier}\PYG{p}{(}\PYG{n}{n\PYGZus{}estimators}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{source\PYGZus{}model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{source\PYGZus{}labels}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get predicted probabilities as features}
    \PYG{n}{source\PYGZus{}features\PYGZus{}train} \PYG{o}{=} \PYG{n}{source\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict\PYGZus{}proba}\PYG{p}{(}\PYG{n}{X\PYGZus{}target\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{source\PYGZus{}features\PYGZus{}test} \PYG{o}{=} \PYG{n}{source\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict\PYGZus{}proba}\PYG{p}{(}\PYG{n}{X\PYGZus{}target\PYGZus{}test}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train target model with these features}
    \PYG{n}{feature\PYGZus{}transfer\PYGZus{}model} \PYG{o}{=} \PYG{n}{RandomForestClassifier}\PYG{p}{(}\PYG{n}{n\PYGZus{}estimators}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{feature\PYGZus{}transfer\PYGZus{}model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{source\PYGZus{}features\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}target\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{feature\PYGZus{}transfer\PYGZus{}pred} \PYG{o}{=} \PYG{n}{feature\PYGZus{}transfer\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{source\PYGZus{}features\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{feature\PYGZus{}transfer\PYGZus{}acc} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}target\PYGZus{}test}\PYG{p}{,} \PYG{n}{feature\PYGZus{}transfer\PYGZus{}pred}\PYG{p}{)}
    
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{baseline\PYGZus{}accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{baseline\PYGZus{}acc}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{combined\PYGZus{}transfer\PYGZus{}accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{transfer\PYGZus{}acc}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{feature\PYGZus{}transfer\PYGZus{}accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{feature\PYGZus{}transfer\PYGZus{}acc}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{baseline\PYGZus{}model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{baseline\PYGZus{}model}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transfer\PYGZus{}model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{transfer\PYGZus{}model}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{feature\PYGZus{}transfer\PYGZus{}model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{feature\PYGZus{}transfer\PYGZus{}model}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\section{8.6 Code Lab: Building an End\sphinxhyphen{}to\sphinxhyphen{}End Pipeline}
\label{\detokenize{part2/ch08_data_science_pipeline:code-lab-building-an-end-to-end-pipeline}}
\sphinxAtStartPar
Let’s implement a complete neural data pipeline from preprocessing to analysis and visualization.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}data\PYGZus{}pipeline}\PYG{p}{(}\PYG{n}{raw\PYGZus{}data\PYGZus{}file}\PYG{p}{,} \PYG{n}{metadata\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    End\PYGZhy{}to\PYGZhy{}end pipeline for neural data analysis.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        raw\PYGZus{}data\PYGZus{}file: Path to raw neural data file}
\PYG{l+s+sd}{        metadata\PYGZus{}file: Path to experiment metadata}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        results: Dictionary of analysis results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{ensemble}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{RandomForestClassifier}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{,} \PYG{n}{classification\PYGZus{}report}
    
    \PYG{c+c1}{\PYGZsh{} Step 1: Load and preprocess data}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 1: Loading and preprocessing data...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulated data loading (replace with actual loading code)}
    \PYG{c+c1}{\PYGZsh{} For demonstration, we\PYGZsq{}ll generate synthetic data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate multi\PYGZhy{}channel neural recordings (20 channels, 100000 samples)}
    \PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{100000}
    \PYG{n}{sampling\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mi}{1000}  \PYG{c+c1}{\PYGZsh{} Hz}
    
    \PYG{c+c1}{\PYGZsh{} Generate random neural data with some oscillatory components}
    \PYG{n}{raw\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5}
    
    \PYG{c+c1}{\PYGZsh{} Add alpha oscillations (8\PYGZhy{}12 Hz) to some channels}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}
    \PYG{n}{alpha} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}
    \PYG{n}{raw\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{alpha} \PYG{o}{*} \PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Add beta oscillations (15\PYGZhy{}30 Hz) to other channels}
    \PYG{n}{beta} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}
    \PYG{n}{raw\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{:}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{beta} \PYG{o}{*} \PYG{l+m+mf}{1.5}
    
    \PYG{c+c1}{\PYGZsh{} Add gamma oscillations (30\PYGZhy{}80 Hz) to other channels}
    \PYG{n}{gamma} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{50} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}
    \PYG{n}{raw\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{:}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{gamma} \PYG{o}{*} \PYG{l+m+mf}{1.0}
    
    \PYG{c+c1}{\PYGZsh{} Simulate artifacts}
    \PYG{n}{artifact\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n}{artifact\PYGZus{}indices}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{idx} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}samples} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{100}\PYG{p}{:}
            \PYG{n}{raw\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{:}\PYG{n}{idx}\PYG{o}{+}\PYG{l+m+mi}{100}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{5}
    
    \PYG{c+c1}{\PYGZsh{} Simulate experimental conditions/events}
    \PYG{n}{conditions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rest}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{task\PYGZus{}A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{task\PYGZus{}B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{events} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{l+m+mi}{10000}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{+} \PYG{l+m+mi}{5000} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}samples}\PYG{p}{:}
            \PYG{n}{cond} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{conditions}\PYG{p}{)}
            \PYG{n}{events}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{start\PYGZus{}time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{i} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{end\PYGZus{}time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{n}{i} \PYG{o}{+} \PYG{l+m+mi}{5000}\PYG{p}{)} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{condition}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{cond}
            \PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{n}{events\PYGZus{}df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{events}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 2: Preprocessing}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 2: Applying filters and artifact removal...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Filter data}
    \PYG{n}{filtered\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{raw\PYGZus{}data}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{preprocess\PYGZus{}neural\PYGZus{}signal}\PYG{p}{(}
            \PYG{n}{raw\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{notch\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mi}{60}\PYG{p}{,} \PYG{n}{bandpass}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Detect and interpolate artifacts}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{artifacts} \PYG{o}{=} \PYG{n}{detect\PYGZus{}artifacts}\PYG{p}{(}\PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{artifacts}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simple interpolation for artifacts}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n}{artifacts}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{j} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{10} \PYG{o+ow}{and} \PYG{n}{j} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}samples} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{10}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Linear interpolation}
                    \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}
                        \PYG{p}{[}\PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{10}\PYG{p}{:}\PYG{n}{j}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} 
                         \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 3: Feature extraction}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 3: Extracting features...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate power in different frequency bands for each channel}
    \PYG{n}{freq\PYGZus{}bands} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{delta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{beta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{13}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gamma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{80}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Extract features in windows}
    \PYG{n}{window\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1000}  \PYG{c+c1}{\PYGZsh{} 1 second}
    \PYG{n}{step\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{500}  \PYG{c+c1}{\PYGZsh{} 0.5 second overlap}
    
    \PYG{n}{n\PYGZus{}windows} \PYG{o}{=} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples} \PYG{o}{\PYGZhy{}} \PYG{n}{window\PYGZus{}size}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{n}{step\PYGZus{}size} \PYG{o}{+} \PYG{l+m+mi}{1}
    \PYG{n}{features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{freq\PYGZus{}bands}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{w} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{start} \PYG{o}{=} \PYG{n}{w} \PYG{o}{*} \PYG{n}{step\PYGZus{}size}
        \PYG{n}{end} \PYG{o}{=} \PYG{n}{start} \PYG{o}{+} \PYG{n}{window\PYGZus{}size}
        
        \PYG{k}{for} \PYG{n}{ch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{window\PYGZus{}data} \PYG{o}{=} \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{ch}\PYG{p}{,} \PYG{n}{start}\PYG{p}{:}\PYG{n}{end}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Extract frequency features}
            \PYG{n}{freq\PYGZus{}features} \PYG{o}{=} \PYG{n}{extract\PYGZus{}frequency\PYGZus{}features}\PYG{p}{(}
                \PYG{n}{window\PYGZus{}data}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{freq\PYGZus{}bands}\PYG{o}{=}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{freq\PYGZus{}bands}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Store features}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{band} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{freq\PYGZus{}bands}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{features}\PYG{p}{[}\PYG{n}{w}\PYG{p}{,} \PYG{n}{ch} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{freq\PYGZus{}bands}\PYG{p}{)} \PYG{o}{+} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{freq\PYGZus{}features}\PYG{p}{[}\PYG{n}{band\PYGZus{}names}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create labels based on experimental conditions}
    \PYG{n}{labels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{object}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{w} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{window\PYGZus{}time} \PYG{o}{=} \PYG{p}{(}\PYG{n}{w} \PYG{o}{*} \PYG{n}{step\PYGZus{}size} \PYG{o}{+} \PYG{n}{window\PYGZus{}size}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}
        
        \PYG{c+c1}{\PYGZsh{} Find corresponding event}
        \PYG{k}{for} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{event} \PYG{o+ow}{in} \PYG{n}{events\PYGZus{}df}\PYG{o}{.}\PYG{n}{iterrows}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{event}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{start\PYGZus{}time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{window\PYGZus{}time} \PYG{o}{\PYGZlt{}} \PYG{n}{event}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{end\PYGZus{}time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{labels}\PYG{p}{[}\PYG{n}{w}\PYG{p}{]} \PYG{o}{=} \PYG{n}{event}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{condition}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
                \PYG{k}{break}
        
        \PYG{k}{if} \PYG{n}{labels}\PYG{p}{[}\PYG{n}{w}\PYG{p}{]} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} No matching event}
            \PYG{n}{labels}\PYG{p}{[}\PYG{n}{w}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}
    
    \PYG{c+c1}{\PYGZsh{} Step 4: Dimensionality reduction}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 4: Applying dimensionality reduction...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply PCA to features}
    \PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{features\PYGZus{}reduced} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explained variance by PCA: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{pca}\PYG{o}{.}\PYG{n}{explained\PYGZus{}variance\PYGZus{}ratio\PYGZus{}}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 5: Pattern discovery}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 5: Discovering patterns in data...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply clustering to find neural states}
    \PYG{n}{pattern\PYGZus{}results} \PYG{o}{=} \PYG{n}{discover\PYGZus{}neural\PYGZus{}patterns}\PYG{p}{(}
        \PYG{n}{features\PYGZus{}reduced}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clustering}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate state distributions across conditions}
    \PYG{n}{state\PYGZus{}by\PYGZus{}condition} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{cond} \PYG{o+ow}{in} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mask} \PYG{o}{=} \PYG{n}{labels} \PYG{o}{==} \PYG{n}{cond}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{mask}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{state\PYGZus{}counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{bincount}\PYG{p}{(}
                \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{,} 
                \PYG{n}{minlength}\PYG{o}{=}\PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            \PYG{p}{)}
            \PYG{n}{state\PYGZus{}by\PYGZus{}condition}\PYG{p}{[}\PYG{n}{cond}\PYG{p}{]} \PYG{o}{=} \PYG{n}{state\PYGZus{}counts} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{state\PYGZus{}counts}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 6: Classification/decoding}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 6: Decoding neural states...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Only use windows with a condition label}
    \PYG{n}{mask} \PYG{o}{=} \PYG{n}{labels} \PYG{o}{!=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{features\PYGZus{}reduced}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{]}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{labels}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Neural decoding}
    \PYG{n}{decoding\PYGZus{}results} \PYG{o}{=} \PYG{n}{neural\PYGZus{}decoding}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{classifier\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Decoding accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 7: Visualization}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step 7: Generating visualizations...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create plots}
    \PYG{n}{fig1} \PYG{o}{=} \PYG{n}{visualize\PYGZus{}neural\PYGZus{}patterns}\PYG{p}{(}
        \PYG{n}{pattern\PYGZus{}results}\PYG{p}{,} \PYG{n}{features\PYGZus{}reduced}\PYG{p}{,} 
        \PYG{n}{times}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}windows}\PYG{p}{)} \PYG{o}{*} \PYG{n}{step\PYGZus{}size} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
    
    \PYG{n}{fig2} \PYG{o}{=} \PYG{n}{plot\PYGZus{}decoding\PYGZus{}results}\PYG{p}{(}\PYG{n}{decoding\PYGZus{}results}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Time\PYGZhy{}frequency plot for a sample channel}
    \PYG{n}{ch} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} First channel}
    
    \PYG{n}{t}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{compute\PYGZus{}time\PYGZus{}frequency}\PYG{p}{(}
        \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{ch}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{10000}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stft}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{fig3}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx}\PYG{p}{)}\PYG{p}{,} \PYG{n}{shading}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gouraud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time\PYGZhy{}Frequency Analysis \PYGZhy{} Channel }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{ch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Power (dB)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 8: Compile results}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{raw\PYGZus{}data\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{raw\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{filtered\PYGZus{}data\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{filtered\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{features\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{features}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{features\PYGZus{}reduced\PYGZus{}shape}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{features\PYGZus{}reduced}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}events}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{events}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{unique\PYGZus{}conditions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pca\PYGZus{}explained\PYGZus{}variance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{pca}\PYG{o}{.}\PYG{n}{explained\PYGZus{}variance\PYGZus{}ratio\PYGZus{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pattern\PYGZus{}results}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n\PYGZus{}clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{pattern\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{state\PYGZus{}distribution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{n}{k}\PYG{p}{:} \PYG{n}{v}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{k}\PYG{p}{,} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{state\PYGZus{}by\PYGZus{}condition}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{decoding\PYGZus{}results}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classifier\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classifier\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{class\PYGZus{}performance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n}{k}\PYG{p}{:} \PYG{n}{v}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{f1\PYGZhy{}score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} 
                \PYG{k}{for} \PYG{n}{k}\PYG{p}{,} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{decoding\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification\PYGZus{}report}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)} 
                \PYG{k}{if} \PYG{n}{k} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{macro avg}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weighted avg}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{figures}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{patterns}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{fig1}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{decoding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{fig2}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time\PYGZus{}frequency}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{fig3}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural data pipeline completed successfully!}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\section{8.7 The Art of Programming for Neuroscience Data}
\label{\detokenize{part2/ch08_data_science_pipeline:the-art-of-programming-for-neuroscience-data}}

\subsection{8.7.1 Why Python for Neural Data Analysis}
\label{\detokenize{part2/ch08_data_science_pipeline:why-python-for-neural-data-analysis}}
\sphinxAtStartPar
\sphinxincludegraphics{{python_neuro_ecosystem}.svg}
\sphinxstyleemphasis{Figure 8.3: The Python ecosystem for neuroscience, showing the relationships between core libraries, data processing tools, visualization packages, machine learning frameworks, and specialized neuroscience libraries.}

\sphinxAtStartPar
Python has become the dominant programming language in neuroscience and data science for several compelling reasons:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Ecosystem Maturity}: Libraries like NumPy, SciPy, pandas, and matplotlib provide robust foundations for scientific computing.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Domain\sphinxhyphen{}Specific Tools}: Specialized packages like MNE\sphinxhyphen{}Python (for EEG/MEG), Neo (for electrophysiology), and CaImAn (for calcium imaging) make complex analyses accessible.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Integration Capabilities}: Python easily interfaces with other languages (C/C++, R) and platforms (MATLAB) commonly used in neuroscience.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Balance of Readability and Power}: Python’s clean syntax makes code readable while maintaining computational efficiency through vectorized operations and compiled extensions.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Community Support}: Active communities in both neuroscience and data science continuously contribute to tools and documentation.

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example illustrating Python\PYGZsq{}s readability and power for neural analysis}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}

\PYG{c+c1}{\PYGZsh{} Define preprocessing function with clear, readable code}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{preprocess\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{raw\PYGZus{}data}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Preprocess neural time series data.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        raw\PYGZus{}data: Raw neural signal (channels x time)}
\PYG{l+s+sd}{        sampling\PYGZus{}rate: Recording sampling rate in Hz}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Preprocessed data and frequency analysis results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1. Apply bandpass filter (1\PYGZhy{}100 Hz)}
    \PYG{n}{nyq} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}
    \PYG{n}{b}\PYG{p}{,} \PYG{n}{a} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{nyq}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{o}{/}\PYG{n}{nyq}\PYG{p}{]}\PYG{p}{,} \PYG{n}{btype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{filtered} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{raw\PYGZus{}data}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Remove line noise with notch filter}
    \PYG{n}{notch\PYGZus{}b}\PYG{p}{,} \PYG{n}{notch\PYGZus{}a} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{iirnotch}\PYG{p}{(}\PYG{l+m+mi}{60}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
    \PYG{n}{notched} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{notch\PYGZus{}b}\PYG{p}{,} \PYG{n}{notch\PYGZus{}a}\PYG{p}{,} \PYG{n}{filtered}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Compute power spectrum}
    \PYG{n}{freqs}\PYG{p}{,} \PYG{n}{psd} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{welch}\PYG{p}{(}\PYG{n}{notched}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{l+m+mi}{1024}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 4. Create results dataframe}
    \PYG{n}{results} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{theta\PYGZus{}power}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{psd}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{4}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha\PYGZus{}power}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{psd}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{8}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{beta\PYGZus{}power}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{psd}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{12}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{preprocessed\PYGZus{}data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{notched}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{frequencies}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{freqs}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{power\PYGZus{}spectrum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{psd}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{band\PYGZus{}powers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{results}
    \PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Clear, concise visualization of results}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}power\PYGZus{}spectrum}\PYG{p}{(}\PYG{n}{results}\PYG{p}{,} \PYG{n}{channel}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot power spectrum of neural data.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{frequencies}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{power\PYGZus{}spectrum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{channel}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Power Spectral Density (μV²/Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Power Spectrum \PYGZhy{} Channel }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{channel}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add shaded areas for frequency bands}
    \PYG{n}{bands} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Delta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Theta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Beta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gamma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n}{colors} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}E6F5FF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}CCEBFF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}99D6FF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}66C0FF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}33AAFF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{k}{for} \PYG{p}{(}\PYG{n}{band}\PYG{p}{,} \PYG{p}{(}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{color} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{bands}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{colors}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{n}{band}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gcf}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{8.7.2 From Code to Concept: Programming as Scientific Thinking}
\label{\detokenize{part2/ch08_data_science_pipeline:from-code-to-concept-programming-as-scientific-thinking}}
\sphinxAtStartPar
Effective data science in neuroscience is less about writing perfect code and more about translating scientific questions into computational approaches:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hypothesis\sphinxhyphen{}Driven Programming}: Start with the scientific question, then determine the appropriate analysis approach.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Iterative Development}: Begin with a minimal viable analysis that addresses the core question, then refine.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual Debugging}: Continuously visualize intermediate results to catch errors and build intuition.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pipeline Thinking}: Structure code as transformative steps in a data pipeline rather than monolithic scripts.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documenting Reasoning}: Comment not just what code does, but why certain parameters or approaches were chosen.

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example of hypothesis\PYGZhy{}driven programming for neural decoding}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{test\PYGZus{}neural\PYGZus{}decoding\PYGZus{}hypothesis}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{stimulus\PYGZus{}conditions}\PYG{p}{,} \PYG{n}{hypothesis}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Test specific hypothesis about neural coding using appropriate analysis.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        neural\PYGZus{}data: Matrix of neural activity (neurons x time)}
\PYG{l+s+sd}{        stimulus\PYGZus{}conditions: Experimental conditions at each timepoint}
\PYG{l+s+sd}{        hypothesis: Dict with hypothesis parameters}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        Dictionary of results relevant to the hypothesis}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Extract hypothesis parameters}
    \PYG{n}{feature\PYGZus{}type} \PYG{o}{=} \PYG{n}{hypothesis}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{feature\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{decoding\PYGZus{}window} \PYG{o}{=} \PYG{n}{hypothesis}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{decoding\PYGZus{}window}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{model\PYGZus{}type} \PYG{o}{=} \PYG{n}{hypothesis}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{model\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert hypothesis parameters to analysis approach}
    \PYG{k}{if} \PYG{n}{feature\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Use firing rate features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n}{extract\PYGZus{}rate\PYGZus{}features}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{window}\PYG{o}{=}\PYG{n}{decoding\PYGZus{}window}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{feature\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{temporal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Use temporal pattern features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n}{extract\PYGZus{}temporal\PYGZus{}features}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{window}\PYG{o}{=}\PYG{n}{decoding\PYGZus{}window}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{feature\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{synchrony}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Use synchrony\PYGZhy{}based features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n}{extract\PYGZus{}synchrony\PYGZus{}features}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{window}\PYG{o}{=}\PYG{n}{decoding\PYGZus{}window}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Select appropriate model based on hypothesis}
    \PYG{k}{if} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{accuracy}\PYG{p}{,} \PYG{n}{model} \PYG{o}{=} \PYG{n}{fit\PYGZus{}linear\PYGZus{}decoder}\PYG{p}{(}\PYG{n}{features}\PYG{p}{,} \PYG{n}{stimulus\PYGZus{}conditions}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nonlinear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{accuracy}\PYG{p}{,} \PYG{n}{model} \PYG{o}{=} \PYG{n}{fit\PYGZus{}nonlinear\PYGZus{}decoder}\PYG{p}{(}\PYG{n}{features}\PYG{p}{,} \PYG{n}{stimulus\PYGZus{}conditions}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Test against specific prediction in hypothesis}
    \PYG{n}{predicted\PYGZus{}accuracy} \PYG{o}{=} \PYG{n}{hypothesis}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{predicted\PYGZus{}accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{p\PYGZus{}value} \PYG{o}{=} \PYG{n}{statistical\PYGZus{}test}\PYG{p}{(}\PYG{n}{accuracy}\PYG{p}{,} \PYG{n}{predicted\PYGZus{}accuracy}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hypothesis\PYGZus{}parameters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{hypothesis}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{accuracy}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{p\PYGZus{}value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{p\PYGZus{}value}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{conclusion}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Supported}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{p\PYGZus{}value} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.05} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Not supported}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subsection{8.7.3 The Future of Neural Data Science: AI\sphinxhyphen{}Augmented Programming}
\label{\detokenize{part2/ch08_data_science_pipeline:the-future-of-neural-data-science-ai-augmented-programming}}
\sphinxAtStartPar
\sphinxincludegraphics{{ai_augmented_workflow}.svg}
\sphinxstyleemphasis{Figure 8.4: Evolution of neural data analysis workflows, contrasting traditional programming approaches with AI\sphinxhyphen{}augmented programming that enables neuroscientists to focus on scientific questions rather than implementation details.}

\sphinxAtStartPar
The landscape of neural data analysis is rapidly evolving with the integration of AI assistants:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{From Syntax to Intent}: Future programming will focus more on communicating analysis intent rather than syntax details.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Agent\sphinxhyphen{}Assisted Workflows}: AI agents will handle routine coding tasks, allowing neuroscientists to focus on experimental design and interpretation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Natural Language Data Exploration}: Interactive exploration of datasets through natural language queries.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Code Generation and Optimization}: AI generating efficient, optimized code based on high\sphinxhyphen{}level descriptions of analysis goals.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Democratized Analysis}: Advanced analysis techniques becoming accessible to researchers without extensive programming backgrounds.

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example of a future AI\PYGZhy{}augmented neural analysis workflow}
\PYG{c+c1}{\PYGZsh{} The comments represent natural language instructions to an AI assistant}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Load the calcium imaging dataset and preprocess it using standard parameters\PYGZdq{}}
\PYG{n}{dataset} \PYG{o}{=} \PYG{n}{load\PYGZus{}calcium\PYGZus{}imaging\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{experiment\PYGZus{}20230512.h5}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{preprocessed\PYGZus{}data} \PYG{o}{=} \PYG{n}{preprocess\PYGZus{}calcium\PYGZus{}data}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{raw\PYGZus{}traces}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Extract cell activity during the different experimental conditions\PYGZdq{}}
\PYG{n}{cell\PYGZus{}activity} \PYG{o}{=} \PYG{n}{extract\PYGZus{}condition\PYGZus{}specific\PYGZus{}activity}\PYG{p}{(}
    \PYG{n}{preprocessed\PYGZus{}data}\PYG{p}{,} 
    \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{experiment\PYGZus{}conditions}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Find cells that show significant tuning to the target stimulus\PYGZdq{}}
\PYG{c+c1}{\PYGZsh{} The AI would generate appropriate statistical testing code}
\PYG{n}{tuned\PYGZus{}cells} \PYG{o}{=} \PYG{n}{find\PYGZus{}significantly\PYGZus{}tuned\PYGZus{}cells}\PYG{p}{(}
    \PYG{n}{cell\PYGZus{}activity}\PYG{p}{,}
    \PYG{n}{condition}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{target\PYGZus{}stimulus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{n}{statistical\PYGZus{}test}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{permutation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.05}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Visualize the spatial distribution of tuned cells\PYGZdq{}}
\PYG{c+c1}{\PYGZsh{} The AI would generate appropriate visualization code}
\PYG{n}{spatial\PYGZus{}map} \PYG{o}{=} \PYG{n}{plot\PYGZus{}spatial\PYGZus{}tuning\PYGZus{}map}\PYG{p}{(}
    \PYG{n}{tuned\PYGZus{}cells}\PYG{p}{,}
    \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{cell\PYGZus{}coordinates}\PYG{p}{,}
    \PYG{n}{plot\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{heatmap}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Create a model that predicts stimulus identity from population activity\PYGZdq{}}
\PYG{c+c1}{\PYGZsh{} The AI would select an appropriate decoding approach based on data properties}
\PYG{n}{decoder\PYGZus{}model} \PYG{o}{=} \PYG{n}{create\PYGZus{}population\PYGZus{}decoder}\PYG{p}{(}
    \PYG{n}{cell\PYGZus{}activity}\PYG{p}{,}
    \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{stimulus\PYGZus{}conditions}\PYG{p}{,}
    \PYG{n}{model\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{optimal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} AI selects appropriate model}
    \PYG{n}{cross\PYGZus{}validation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{timeseries}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} AI selects appropriate validation approach}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZdq{}Summarize the key findings in a publication\PYGZhy{}ready figure\PYGZdq{}}
\PYG{c+c1}{\PYGZsh{} The AI would generate comprehensive figure code}
\PYG{n}{create\PYGZus{}summary\PYGZus{}figure}\PYG{p}{(}
    \PYG{n}{tuned\PYGZus{}cells}\PYG{o}{=}\PYG{n}{tuned\PYGZus{}cells}\PYG{p}{,}
    \PYG{n}{spatial\PYGZus{}map}\PYG{o}{=}\PYG{n}{spatial\PYGZus{}map}\PYG{p}{,}
    \PYG{n}{decoder\PYGZus{}performance}\PYG{o}{=}\PYG{n}{decoder\PYGZus{}model}\PYG{o}{.}\PYG{n}{performance}\PYG{p}{,}
    \PYG{n}{save\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{figures/main\PYGZus{}result.pdf}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This AI\sphinxhyphen{}augmented workflow illustrates how neuroscientists of the future will interact with data through higher\sphinxhyphen{}level conceptual instructions rather than detailed code implementation. The AI handles the translation from scientific intent to executable code, allowing researchers to focus on the scientific questions rather than programming details.


\subsection{8.7.4 Best Practices for the AI\sphinxhyphen{}Assisted Neuroscience Era}
\label{\detokenize{part2/ch08_data_science_pipeline:best-practices-for-the-ai-assisted-neuroscience-era}}
\sphinxAtStartPar
As we transition to AI\sphinxhyphen{}augmented neural data analysis, several best practices emerge:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Focus on Scientific Questions}: Clearly formulate scientific hypotheses and analysis goals rather than programming details.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Conceptual Understanding}: Maintain understanding of analysis principles, even when implementation details are handled by AI.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Critical Evaluation}: Carefully verify AI\sphinxhyphen{}generated analyses and visualizations for scientific validity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation and Reproducibility}: Ensure that analysis methods are thoroughly documented, including AI\sphinxhyphen{}generated components.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Continuous Learning}: Stay current with analytical approaches and methodologies to effectively guide AI tools.

\end{enumerate}

\sphinxAtStartPar
The future neuroscientist will be less a programmer and more an analytical strategist, guiding AI tools to efficiently transform data into insights.


\section{8.8 Take\sphinxhyphen{}aways}
\label{\detokenize{part2/ch08_data_science_pipeline:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Domain\sphinxhyphen{}Specific Adaptations}: Neural data requires specialized preprocessing and feature extraction techniques tailored to the specific data type (spikes, LFPs, EEG, etc.).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Critical Preprocessing}: Small changes in preprocessing parameters can dramatically affect results in neural data analysis, requiring careful validation and parameter selection.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Extraction Matters}: The choice of features is crucial for neural data analysis, with frequency domain features often being particularly informative.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality Reduction}: Neural datasets typically have high dimensionality, necessitating effective dimensionality reduction for visualization and modeling.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model Validation}: Cross\sphinxhyphen{}validation in neural data analysis should account for temporal dependencies and non\sphinxhyphen{}stationarity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Encoding vs. Decoding}: Both approaches provide complementary insights \sphinxhyphen{} encoding models predict neural responses to stimuli, while decoding models predict stimuli from neural activity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reproducibility Challenges}: Neural data analysis requires meticulous documentation of each processing step to ensure reproducibility.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Python Ecosystem}: Python’s rich ecosystem of libraries and tools makes it uniquely suited for neural data analysis.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AI\sphinxhyphen{}Augmented Analysis}: The future of neural data science involves AI assistants that handle routine coding tasks, allowing neuroscientists to focus on higher\sphinxhyphen{}level questions and interpretations.

\end{itemize}


\section{8.9 Further Reading \& Media}
\label{\detokenize{part2/ch08_data_science_pipeline:further-reading-media}}

\subsection{Neuroscience Data Analysis}
\label{\detokenize{part2/ch08_data_science_pipeline:neuroscience-data-analysis}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Kriegeskorte, N., \& Golan, T. (2019). “Neural network models and deep learning”. \sphinxstyleemphasis{Current Biology}, 29(7), R231\sphinxhyphen{}R236.

\item {} 
\sphinxAtStartPar
Paninski, L., \& Cunningham, J. P. (2018). “Neural data science: accelerating the experiment\sphinxhyphen{}analysis\sphinxhyphen{}theory cycle in large\sphinxhyphen{}scale neuroscience”. \sphinxstyleemphasis{Current Opinion in Neurobiology}, 50, 232\sphinxhyphen{}241.

\item {} 
\sphinxAtStartPar
Glaser, J. I., Benjamin, A. S., Farhoodi, R., \& Kording, K. P. (2019). “The roles of supervised machine learning in systems neuroscience”. \sphinxstyleemphasis{Progress in Neurobiology}, 175, 126\sphinxhyphen{}137.

\item {} 
\sphinxAtStartPar
Harris, K. D., Quiroga, R. Q., Freeman, J., \& Smith, S. L. (2016). “Improving data quality in neuronal population recordings”. \sphinxstyleemphasis{Nature Neuroscience}, 19(9), 1165\sphinxhyphen{}1174.

\item {} 
\sphinxAtStartPar
Vyas, S., Golub, M.D., Sussillo, D., \& Shenoy, K.V. (2020). “Computation Through Neural Population Dynamics”. \sphinxstyleemphasis{Annual Review of Neuroscience}, 43, 249\sphinxhyphen{}275.

\item {} 
\sphinxAtStartPar
Kobak, D., \& Berens, P. (2019). “The art of using t\sphinxhyphen{}SNE for single\sphinxhyphen{}cell transcriptomics”. \sphinxstyleemphasis{Nature Communications}, 10(1), 1\sphinxhyphen{}14.

\item {} 
\sphinxAtStartPar
Pachitariu, M., \& Sahani, M. (2012). “Learning visual motion in recurrent neural networks”. \sphinxstyleemphasis{Advances in Neural Information Processing Systems}, 25, 1322\sphinxhyphen{}1330.

\end{itemize}


\subsection{Python for Scientific Computing}
\label{\detokenize{part2/ch08_data_science_pipeline:python-for-scientific-computing}}\begin{itemize}
\item {} 
\sphinxAtStartPar
VanderPlas, J. (2016). \sphinxstyleemphasis{A Whirlwind Tour of Python}. O’Reilly Media.

\item {} 
\sphinxAtStartPar
McKinney, W. (2017). \sphinxstyleemphasis{Python for Data Analysis: Data Wrangling with Pandas, NumPy, and IPython}. O’Reilly Media.

\item {} 
\sphinxAtStartPar
Raschka, S., \& Mirjalili, V. (2019). \sphinxstyleemphasis{Python Machine Learning: Machine Learning and Deep Learning with Python, scikit\sphinxhyphen{}learn, and TensorFlow 2}. Packt Publishing.

\item {} 
\sphinxAtStartPar
Géron, A. (2019). \sphinxstyleemphasis{Hands\sphinxhyphen{}On Machine Learning with Scikit\sphinxhyphen{}Learn, Keras, and TensorFlow: Concepts, Tools, and Techniques to Build Intelligent Systems}. O’Reilly Media.

\end{itemize}


\subsection{AI\sphinxhyphen{}Augmented Programming}
\label{\detokenize{part2/ch08_data_science_pipeline:ai-augmented-programming}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Bubeck, S., Chandrasekaran, V., Eldan, R., Gehrke, J., Horvitz, E., Kamar, E., Lee, P., Lee, Y.T., Li, Y., Lundberg, S. and Nori, H. (2023). “Sparks of Artificial General Intelligence: Early experiments with GPT\sphinxhyphen{}4”. arXiv preprint arXiv:2303.12712.

\item {} 
\sphinxAtStartPar
Chen, M., Tworek, J., Jun, H., Yuan, Q., Pinto, H.P.D.O., Kaplan, J., Edwards, H., Burda, Y., Joseph, N., Brockman, G. and Ray, A. (2021). “Evaluating large language models trained on code”. arXiv preprint arXiv:2107.03374.

\item {} 
\sphinxAtStartPar
Shen, S., Amer, M., Bender, G., Ramachandran, P., \& Shlens, J. (2023). “Augmenting Developers with Large Language Models: The Impact of Code Suggestions on Productivity, Code Quality, and Well\sphinxhyphen{}being at Microsoft”. arXiv preprint arXiv:2309.11436.

\item {} 
\sphinxAtStartPar
Bricken, T., Elhage, N., Vance, N., Nanda, N., Edwards, B., Steinhardt, J., \& Bowman, S. R. (2023). “Towards understanding the behavior of neural algorithms”. arXiv preprint arXiv:2305.18465.

\item {} 
\sphinxAtStartPar
Shanahan, M. (2022). “Talking about large language models”. arXiv preprint arXiv:2212.03551.

\end{itemize}


\subsection{Future of Neuroscience and AI}
\label{\detokenize{part2/ch08_data_science_pipeline:future-of-neuroscience-and-ai}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Richards, B.A., Lillicrap, T.P., Beaudoin, P., Bengio, Y., Bogacz, R., Christensen, A., Clopath, C., Costa, R.P., de Berker, A., Ganguli, S. and Gillon, C.J. (2019). “A deep learning framework for neuroscience”. \sphinxstyleemphasis{Nature Neuroscience}, 22(11), 1761\sphinxhyphen{}1770.

\item {} 
\sphinxAtStartPar
Zador, A. M. (2019). “A critique of pure learning and what artificial neural networks can learn from animal brains”. \sphinxstyleemphasis{Nature Communications}, 10(1), 1\sphinxhyphen{}7.

\item {} 
\sphinxAtStartPar
Jonas, E., \& Kording, K. P. (2017). “Could a neuroscientist understand a microprocessor?”. \sphinxstyleemphasis{PLoS computational biology}, 13(1), e1005268.

\item {} 
\sphinxAtStartPar
Marblestone, A. H., Wayne, G., \& Kording, K. P. (2016). “Toward an integration of deep learning and neuroscience”. \sphinxstyleemphasis{Frontiers in computational neuroscience}, 10, 94.

\item {} 
\sphinxAtStartPar
Kording, K. P., Benjamin, A. S., Farhoodi, R., \& Glaser, J. I. (2020). “The roles of machine learning in biomedical science”. \sphinxstyleemphasis{Nature Machine Intelligence}, 2(4), 198\sphinxhyphen{}204.

\end{itemize}


\subsection{Recommended Tools and Libraries}
\label{\detokenize{part2/ch08_data_science_pipeline:recommended-tools-and-libraries}}

\subsubsection{Neuroscience Data Analysis}
\label{\detokenize{part2/ch08_data_science_pipeline:id1}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{MNE\sphinxhyphen{}Python}: Comprehensive toolkit for processing electrophysiological data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neo}: Python package for handling electrophysiology data in Python

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Elephant}: Analysis library for neurophysiology data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{CaImAn}: Calcium Imaging Analysis package

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{SpikeInterface}: Framework for spike sorting and electrophysiology analysis

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{NWB (Neurodata Without Borders)}: Standard format for neurophysiology data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{DeepLabCut}: Deep learning for markerless pose estimation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{CellProfiler}: Cell image analysis software

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BrainGlobe}: Tools for brain atlas visualization and anatomical analysis

\end{itemize}


\subsubsection{AI\sphinxhyphen{}Assisted Programming}
\label{\detokenize{part2/ch08_data_science_pipeline:ai-assisted-programming}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{GitHub Copilot}: AI pair programmer that offers code suggestions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Jupyter AI}: AI extensions for Jupyter notebooks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{LangChain}: Framework for developing applications powered by language models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Gradio}: Tool for quickly creating UIs for machine learning models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Streamlit}: App framework for machine learning and data science

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hugging Face Transformers}: State\sphinxhyphen{}of\sphinxhyphen{}the\sphinxhyphen{}art NLP models for code generation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AutoML}: Automated machine learning platforms for model selection and hyperparameter tuning

\end{itemize}

\sphinxstepscope


\part{Part III · Learning Machines}

\sphinxstepscope


\chapter{Chapter 9: Classical Machine\sphinxhyphen{}Learning Foundations}
\label{\detokenize{part3/ch09_ml_foundations:chapter-9-classical-machine-learning-foundations}}\label{\detokenize{part3/ch09_ml_foundations::doc}}

\section{9.0 Chapter Goals}
\label{\detokenize{part3/ch09_ml_foundations:chapter-goals}}
\sphinxAtStartPar
This chapter provides a foundation for understanding machine learning algorithms with connections to neuroscience. By the end of this chapter, you should be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Implement and analyze key machine learning algorithms from scratch

\item {} 
\sphinxAtStartPar
Distinguish between different learning paradigms and choose appropriate methods for different problems

\item {} 
\sphinxAtStartPar
Evaluate and interpret model performance with appropriate metrics

\item {} 
\sphinxAtStartPar
Recognize the biological inspirations and parallels in classical ML algorithms

\item {} 
\sphinxAtStartPar
Apply classical machine learning methods to neuroscience data

\end{itemize}


\section{9.1 Learning Paradigms}
\label{\detokenize{part3/ch09_ml_foundations:learning-paradigms}}
\sphinxAtStartPar
Machine learning approaches can be categorized into different paradigms based on the nature of the learning signal and goal.

\sphinxAtStartPar
\sphinxincludegraphics{{learning_paradigms}.svg}
\sphinxstyleemphasis{Figure 9.1: Comparison of supervised, unsupervised, and reinforcement learning paradigms with their neuroscience parallels.}


\subsection{Supervised Learning}
\label{\detokenize{part3/ch09_ml_foundations:supervised-learning}}
\sphinxAtStartPar
In supervised learning, the algorithm learns a mapping from inputs to outputs based on labeled examples. This parallels associative learning in biological systems, where organisms learn to associate stimuli with outcomes.

\sphinxAtStartPar
Formally, given a dataset \(\mathcal{D} = \{(x_i, y_i)\}_{i=1}^{n}\) of input\sphinxhyphen{}output pairs, supervised learning aims to find a function \(f: \mathcal{X} \rightarrow \mathcal{Y}\) that minimizes a loss function \(\mathcal{L}(f(x), y)\).

\sphinxAtStartPar
\sphinxstylestrong{Common applications:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Classification (discrete output spaces)

\item {} 
\sphinxAtStartPar
Regression (continuous output spaces)

\item {} 
\sphinxAtStartPar
Sequence prediction (structured output spaces)

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{,} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}

\PYG{c+c1}{\PYGZsh{} Example: Creating a synthetic dataset for supervised learning}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Classification example}
\PYG{n}{X\PYGZus{}class} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 100 samples, 2 features}
\PYG{n}{y\PYGZus{}class} \PYG{o}{=} \PYG{p}{(}\PYG{n}{X\PYGZus{}class}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{X\PYGZus{}class}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Simple decision boundary}

\PYG{c+c1}{\PYGZsh{} Regression example}
\PYG{n}{X\PYGZus{}reg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 100 samples, 1 feature}
\PYG{n}{y\PYGZus{}reg} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{X\PYGZus{}reg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Linear relationship with noise}

\PYG{c+c1}{\PYGZsh{} Visualize the datasets}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}class}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}class}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y\PYGZus{}class}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Classification Dataset}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}reg}\PYG{p}{,} \PYG{n}{y\PYGZus{}reg}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Target}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Regression Dataset}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Unsupervised Learning}
\label{\detokenize{part3/ch09_ml_foundations:unsupervised-learning}}
\sphinxAtStartPar
Unsupervised learning discovers patterns and structure in data without explicit output labels. This maps to the brain’s ability to extract regularities from sensory inputs and form internal representations.

\sphinxAtStartPar
Key objectives include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Density estimation: modeling the underlying data distribution \(p(x)\)

\item {} 
\sphinxAtStartPar
Clustering: grouping similar data points

\item {} 
\sphinxAtStartPar
Dimensionality reduction: finding compact representations that preserve important structure

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Simple K\PYGZhy{}means clustering from scratch}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{kmeans}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{max\PYGZus{}iters}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{tol}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implement K\PYGZhy{}means clustering from scratch.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        X: data matrix of shape (n\PYGZus{}samples, n\PYGZus{}features)}
\PYG{l+s+sd}{        k: number of clusters}
\PYG{l+s+sd}{        max\PYGZus{}iters: maximum number of iterations}
\PYG{l+s+sd}{        tol: convergence tolerance}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        centroids: cluster centers}
\PYG{l+s+sd}{        labels: cluster assignments for each data point}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Initialize centroids randomly from the data}
    \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{centroids} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{max\PYGZus{}iters}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Assign each point to the nearest centroid}
        \PYG{n}{distances} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{p}{(}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{centroids}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{labels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmin}\PYG{p}{(}\PYG{n}{distances}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update centroids}
        \PYG{n}{new\PYGZus{}centroids} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{X}\PYG{p}{[}\PYG{n}{labels} \PYG{o}{==} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{k}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check for convergence}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{new\PYGZus{}centroids} \PYG{o}{\PYGZhy{}} \PYG{n}{centroids}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{tol}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{break}
            
        \PYG{n}{centroids} \PYG{o}{=} \PYG{n}{new\PYGZus{}centroids}
    
    \PYG{k}{return} \PYG{n}{centroids}\PYG{p}{,} \PYG{n}{labels}

\PYG{c+c1}{\PYGZsh{} Generate a simple dataset with 3 clusters}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{300}
\PYG{n}{cluster\PYGZus{}centers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{]}
\PYG{n}{cluster\PYGZus{}stds} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{n}{X\PYGZus{}cluster} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{p}{[}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n}{center}\PYG{p}{,} \PYG{n}{std}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} 
    \PYG{k}{for} \PYG{n}{center}\PYG{p}{,} \PYG{n}{std} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{cluster\PYGZus{}centers}\PYG{p}{,} \PYG{n}{cluster\PYGZus{}stds}\PYG{p}{)}
\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Run our K\PYGZhy{}means implementation}
\PYG{n}{centroids}\PYG{p}{,} \PYG{n}{labels} \PYG{o}{=} \PYG{n}{kmeans}\PYG{p}{(}\PYG{n}{X\PYGZus{}cluster}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}cluster}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}cluster}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{labels}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{centroids}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{centroids}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{*}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Centroids}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{K\PYGZhy{}means Clustering Result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Reinforcement Learning}
\label{\detokenize{part3/ch09_ml_foundations:reinforcement-learning}}
\sphinxAtStartPar
Reinforcement learning involves an agent learning to maximize rewards through interactions with an environment. This paradigm closely resembles how animals learn from experience, particularly through dopamine\sphinxhyphen{}based reward systems in the basal ganglia.

\sphinxAtStartPar
Key components:
\begin{itemize}
\item {} 
\sphinxAtStartPar
State space \(\mathcal{S}\): possible situations

\item {} 
\sphinxAtStartPar
Action space \(\mathcal{A}\): possible decisions

\item {} 
\sphinxAtStartPar
Reward function \(r(s,a)\): feedback signal

\item {} 
\sphinxAtStartPar
Policy \(\pi(a|s)\): strategy for selecting actions

\item {} 
\sphinxAtStartPar
Value function \(V(s)\): expected future reward from state \(s\)

\end{itemize}

\sphinxAtStartPar
RL seeks to find a policy that maximizes expected cumulative reward:
\begin{equation*}
\begin{split}\pi^* = \arg\max_{\pi} \mathbb{E}\left[\sum_{t=0}^{\infty} \gamma^t r_t \right]\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\gamma\) is a discount factor that prioritizes immediate rewards.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Simple Q\PYGZhy{}learning for a grid world environment}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{q\PYGZus{}learning\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simple Q\PYGZhy{}learning demonstration in a grid world.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Define a simple 4x4 grid world}
    \PYG{c+c1}{\PYGZsh{} States: 0\PYGZhy{}15 (grid positions)}
    \PYG{c+c1}{\PYGZsh{} Actions: 0\PYGZhy{}3 (up, right, down, left)}
    \PYG{c+c1}{\PYGZsh{} Rewards: \PYGZhy{}1 for each step, +10 for goal, \PYGZhy{}10 for trap}
    
    \PYG{c+c1}{\PYGZsh{} Environment parameters}
    \PYG{n}{n\PYGZus{}states} \PYG{o}{=} \PYG{l+m+mi}{16}
    \PYG{n}{n\PYGZus{}actions} \PYG{o}{=} \PYG{l+m+mi}{4}
    \PYG{n}{goal\PYGZus{}state} \PYG{o}{=} \PYG{l+m+mi}{15}
    \PYG{n}{trap\PYGZus{}states} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create the Q\PYGZhy{}table}
    \PYG{n}{Q} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}states}\PYG{p}{,} \PYG{n}{n\PYGZus{}actions}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Learning parameters}
    \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Learning rate}
    \PYG{n}{gamma} \PYG{o}{=} \PYG{l+m+mf}{0.9}  \PYG{c+c1}{\PYGZsh{} Discount factor}
    \PYG{n}{epsilon} \PYG{o}{=} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Exploration rate}
    \PYG{n}{max\PYGZus{}episodes} \PYG{o}{=} \PYG{l+m+mi}{500}
    
    \PYG{c+c1}{\PYGZsh{} Define state transitions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}next\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Grid layout (4x4):}
        \PYG{c+c1}{\PYGZsh{} 0  1  2  3}
        \PYG{c+c1}{\PYGZsh{} 4  5  6  7}
        \PYG{c+c1}{\PYGZsh{} 8  9  10 11}
        \PYG{c+c1}{\PYGZsh{} 12 13 14 15}
        
        \PYG{n}{row}\PYG{p}{,} \PYG{n}{col} \PYG{o}{=} \PYG{n}{state} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{state} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{4}
        
        \PYG{k}{if} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Up}
            \PYG{n}{row} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{row} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Right}
            \PYG{n}{col} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{col} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Down}
            \PYG{n}{row} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{row} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{action} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Left}
            \PYG{n}{col} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{col} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{row} \PYG{o}{*} \PYG{l+m+mi}{4} \PYG{o}{+} \PYG{n}{col}
    
    \PYG{c+c1}{\PYGZsh{} Define rewards}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}reward}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{state} \PYG{o}{==} \PYG{n}{goal\PYGZus{}state}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{10}
        \PYG{k}{elif} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{trap\PYGZus{}states}\PYG{p}{:}
            \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{10}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{rewards\PYGZus{}per\PYGZus{}episode} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{episode} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{max\PYGZus{}episodes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{state} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Start at top\PYGZhy{}left}
        \PYG{n}{done} \PYG{o}{=} \PYG{k+kc}{False}
        \PYG{n}{total\PYGZus{}reward} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{while} \PYG{o+ow}{not} \PYG{n}{done}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Epsilon\PYGZhy{}greedy action selection}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{epsilon}\PYG{p}{:}
                \PYG{n}{action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{n}{n\PYGZus{}actions}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{state}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Take action and observe next state and reward}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{get\PYGZus{}next\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}
            \PYG{n}{reward} \PYG{o}{=} \PYG{n}{get\PYGZus{}reward}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{)}
            \PYG{n}{total\PYGZus{}reward} \PYG{o}{+}\PYG{o}{=} \PYG{n}{reward}
            
            \PYG{c+c1}{\PYGZsh{} Update Q\PYGZhy{}value using the Q\PYGZhy{}learning update rule}
            \PYG{n}{Q}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{alpha} \PYG{o}{*} \PYG{p}{(}\PYG{n}{reward} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{Q}\PYG{p}{[}\PYG{n}{next\PYGZus{}state}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{Q}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Move to next state}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
            
            \PYG{c+c1}{\PYGZsh{} Check if episode is done}
            \PYG{k}{if} \PYG{n}{state} \PYG{o}{==} \PYG{n}{goal\PYGZus{}state} \PYG{o+ow}{or} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{trap\PYGZus{}states}\PYG{p}{:}
                \PYG{n}{done} \PYG{o}{=} \PYG{k+kc}{True}
        
        \PYG{n}{rewards\PYGZus{}per\PYGZus{}episode}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{total\PYGZus{}reward}\PYG{p}{)}
        
    \PYG{c+c1}{\PYGZsh{} Plot learning progress}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{convolve}\PYG{p}{(}\PYG{n}{rewards\PYGZus{}per\PYGZus{}episode}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{valid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Average Reward (20\PYGZhy{}episode window)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Q\PYGZhy{}learning Progress}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the learned policy}
    \PYG{n}{policy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{Q}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert policy to arrows for visualization}
    \PYG{n}{arrows} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZca{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{v}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{policy\PYGZus{}grid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{n}{arrows}\PYG{p}{[}\PYG{n}{policy}\PYG{p}{[}\PYG{n}{r}\PYG{o}{*}\PYG{l+m+mi}{4} \PYG{o}{+} \PYG{n}{c}\PYG{p}{]}\PYG{p}{]} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark trap and goal states}
    \PYG{k}{for} \PYG{n}{trap} \PYG{o+ow}{in} \PYG{n}{trap\PYGZus{}states}\PYG{p}{:}
        \PYG{n}{r}\PYG{p}{,} \PYG{n}{c} \PYG{o}{=} \PYG{n}{trap} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{trap} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{4}
        \PYG{n}{policy\PYGZus{}grid}\PYG{p}{[}\PYG{n}{r}\PYG{p}{,} \PYG{n}{c}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{policy\PYGZus{}grid}\PYG{p}{[}\PYG{n}{goal\PYGZus{}state} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{goal\PYGZus{}state} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{4}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Learned Policy:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{policy\PYGZus{}grid}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{Q}

\PYG{c+c1}{\PYGZsh{} Run the Q\PYGZhy{}learning demo}
\PYG{n}{q\PYGZus{}table} \PYG{o}{=} \PYG{n}{q\PYGZus{}learning\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Transfer Learning}
\label{\detokenize{part3/ch09_ml_foundations:transfer-learning}}
\sphinxAtStartPar
Transfer learning leverages knowledge gained from one task to improve performance on a related task. This relates to how biological learning generalizes across contexts.

\sphinxAtStartPar
Key approaches include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Feature\sphinxhyphen{}based transfer: reusing representations

\item {} 
\sphinxAtStartPar
Instance\sphinxhyphen{}based transfer: using samples from the source domain

\item {} 
\sphinxAtStartPar
Parameter\sphinxhyphen{}based transfer: adapting model parameters

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Humans use prior knowledge to quickly adapt to new tasks, much like a pre\sphinxhyphen{}trained model fine\sphinxhyphen{}tuned on a new dataset.


\subsection{Online vs Batch Learning}
\label{\detokenize{part3/ch09_ml_foundations:online-vs-batch-learning}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Batch Learning}: Process the entire dataset at once. Similar to deliberate, reflective learning.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Online Learning}: Update the model with each new example. Similar to incremental, continuous learning in animals.

\end{itemize}

\sphinxAtStartPar
The trade\sphinxhyphen{}off involves computational efficiency versus adaptation to changing distributions.


\section{9.2 Core ML Algorithms}
\label{\detokenize{part3/ch09_ml_foundations:core-ml-algorithms}}

\subsection{Linear Models}
\label{\detokenize{part3/ch09_ml_foundations:linear-models}}
\sphinxAtStartPar
Linear models form the foundation of machine learning, relating to simple input\sphinxhyphen{}output mappings in neural circuits.


\subsubsection{Linear Regression}
\label{\detokenize{part3/ch09_ml_foundations:linear-regression}}
\sphinxAtStartPar
Linear regression models the relationship between inputs and a continuous output using a linear function:
\begin{equation*}
\begin{split}\hat{y} = w_0 + w_1 x_1 + w_2 x_2 + ... + w_d x_d = w_0 + \sum_{j=1}^{d} w_j x_j\end{split}
\end{equation*}
\sphinxAtStartPar
The model parameters are typically learned by minimizing the mean squared error:
\begin{equation*}
\begin{split}\min_{w} \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2\end{split}
\end{equation*}
\sphinxAtStartPar
This has a closed\sphinxhyphen{}form solution: \(w = (X^T X)^{-1} X^T y\), where \(X\) is the design matrix.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement linear regression from scratch}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LinearRegression}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fit the linear regression model.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Add bias term}
        \PYG{n}{X\PYGZus{}bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{X}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Closed\PYGZhy{}form solution}
        \PYG{n}{coeffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{inv}\PYG{p}{(}\PYG{n}{X\PYGZus{}bias}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{X\PYGZus{}bias}\PYG{p}{)} \PYG{o}{@} \PYG{n}{X\PYGZus{}bias}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{y}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{n}{coeffs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{coeffs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Make predictions.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{+} \PYG{n}{X} \PYG{o}{@} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}
    
\PYG{c+c1}{\PYGZsh{} Demonstrate linear regression}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{X}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{2} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} True parameters: w=3, b=2}

\PYG{c+c1}{\PYGZsh{} Split into train and test sets}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Fit our model}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{LinearRegression}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Make predictions}
\PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate error}
\PYG{n}{mse} \PYG{o}{=} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the regression line}
\PYG{n}{x\PYGZus{}line} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{X}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{y\PYGZus{}line} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{x\PYGZus{}line}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x\PYGZus{}line}\PYG{p}{,} \PYG{n}{y\PYGZus{}line}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Fitted line}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Linear Regression (w=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{model}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, b=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{model}\PYG{o}{.}\PYG{n}{bias}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, MSE=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mse}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Logistic Regression}
\label{\detokenize{part3/ch09_ml_foundations:logistic-regression}}
\sphinxAtStartPar
Logistic regression extends linear models to classification tasks by applying a sigmoid function to the linear output:
\begin{equation*}
\begin{split}P(y=1|x) = \sigma(w^T x + b) = \frac{1}{1 + e^{-(w^T x + b)}}\end{split}
\end{equation*}
\sphinxAtStartPar
The parameters are learned by maximizing the log\sphinxhyphen{}likelihood (or minimizing the negative log\sphinxhyphen{}likelihood):
\begin{equation*}
\begin{split}\min_{w} -\sum_{i=1}^{n} [y_i \log(\sigma(w^T x_i)) + (1-y_i) \log(1-\sigma(w^T x_i))]\end{split}
\end{equation*}
\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} The sigmoid activation function resembles the firing rate response of neurons to input current.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement logistic regression from scratch}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LogisticRegression}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{max\PYGZus{}iter}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iter} \PYG{o}{=} \PYG{n}{max\PYGZus{}iter}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{z}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Sigmoid activation function.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{z}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{l+m+mi}{500}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Clip to avoid overflow}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fit the logistic regression model using gradient descent.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Initialize parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Gradient descent}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iter}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Linear model}
            \PYG{n}{linear\PYGZus{}model} \PYG{o}{=} \PYG{n}{X} \PYG{o}{@} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{linear\PYGZus{}model}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute gradients}
            \PYG{n}{dw} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{db} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update parameters}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{dw}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{db}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}proba}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Predict probabilities.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{linear\PYGZus{}model} \PYG{o}{=} \PYG{n}{X} \PYG{o}{@} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{linear\PYGZus{}model}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Make binary predictions.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{predict\PYGZus{}proba}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{threshold}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Generate a simple classification dataset}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add some noise to make it more interesting}
\PYG{n}{noise\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{y}\PYG{p}{[}\PYG{n}{noise\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{[}\PYG{n}{noise\PYGZus{}indices}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Split data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Fit our model}
\PYG{n}{log\PYGZus{}reg} \PYG{o}{=} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}
\PYG{n}{log\PYGZus{}reg}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Make predictions}
\PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{log\PYGZus{}reg}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
\PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize decision boundary}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot data points}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a grid of points to visualize the decision boundary}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{X\PYGZus{}grid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
\PYG{n}{Z} \PYG{o}{=} \PYG{n}{log\PYGZus{}reg}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}grid}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot decision boundary}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contour}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{colors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidths}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Logistic Regression Decision Boundary (Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted class}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Support Vector Machines}
\label{\detokenize{part3/ch09_ml_foundations:support-vector-machines}}
\sphinxAtStartPar
Support Vector Machines (SVMs) find the hyperplane that maximizes the margin between classes, focusing on the boundary cases (support vectors).

\sphinxAtStartPar
For linearly separable data, the optimization problem is:
\begin{equation*}
\begin{split}\min_{w,b} \frac{1}{2} ||w||^2 \text{ subject to } y_i(w \cdot x_i + b) \geq 1 \text{ for all } i\end{split}
\end{equation*}
\sphinxAtStartPar
The kernel trick extends SVMs to non\sphinxhyphen{}linear boundaries by implicitly mapping data to higher\sphinxhyphen{}dimensional spaces.

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} The margin\sphinxhyphen{}maximizing property relates to the brain’s ability to generalize from limited examples and enhance robustness to noise.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using scikit\PYGZhy{}learn\PYGZsq{}s SVM implementation}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{svm}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{SVC}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{make\PYGZus{}moons}

\PYG{c+c1}{\PYGZsh{} Create a more complex dataset}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{make\PYGZus{}moons}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{noise}\PYG{o}{=}\PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Split data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create and train an SVM with radial basis function kernel}
\PYG{n}{svm} \PYG{o}{=} \PYG{n}{SVC}\PYG{p}{(}\PYG{n}{kernel}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rbf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{C}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{svm}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Make predictions}
\PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{svm}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
\PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize the decision boundary}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot training data}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a grid and compute SVM predictions}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{o}{+}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,}
                     \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{o}{+}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{Z} \PYG{o}{=} \PYG{n}{svm}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot decision boundary and margins}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contour}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{colors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidths}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Highlight support vectors}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{svm}\PYG{o}{.}\PYG{n}{support\PYGZus{}vectors\PYGZus{}}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{svm}\PYG{o}{.}\PYG{n}{support\PYGZus{}vectors\PYGZus{}}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} 
            \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{facecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Support Vectors}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SVM with RBF Kernel (Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Decision Trees and Random Forests}
\label{\detokenize{part3/ch09_ml_foundations:decision-trees-and-random-forests}}
\sphinxAtStartPar
Decision trees make predictions by recursive binary partitioning of the feature space.

\sphinxAtStartPar
Key concepts:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Decision nodes: Test feature values against thresholds

\item {} 
\sphinxAtStartPar
Leaf nodes: Contain predictions

\item {} 
\sphinxAtStartPar
Splitting criteria: Gini impurity, entropy, variance reduction

\end{itemize}

\sphinxAtStartPar
Random forests combine multiple trees to reduce overfitting and improve generalization:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Bootstrap aggregating (bagging) of training samples

\item {} 
\sphinxAtStartPar
Random feature subset selection at each split

\item {} 
\sphinxAtStartPar
Majority voting (classification) or averaging (regression)

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Hierarchical decision\sphinxhyphen{}making in the prefrontal cortex may implement tree\sphinxhyphen{}like structures.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement a simple decision tree for classification}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{DecisionTreeNode}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{feature\PYGZus{}idx}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{left}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{right}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feature\PYGZus{}idx} \PYG{o}{=} \PYG{n}{feature\PYGZus{}idx}  \PYG{c+c1}{\PYGZsh{} Index of feature to split on}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold} \PYG{o}{=} \PYG{n}{threshold}      \PYG{c+c1}{\PYGZsh{} Threshold for the split}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{left} \PYG{o}{=} \PYG{n}{left}                \PYG{c+c1}{\PYGZsh{} Left subtree (feature \PYGZlt{} threshold)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{right} \PYG{o}{=} \PYG{n}{right}              \PYG{c+c1}{\PYGZsh{} Right subtree (feature \PYGZgt{}= threshold)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value} \PYG{o}{=} \PYG{n}{value}              \PYG{c+c1}{\PYGZsh{} Prediction value if leaf node}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleDecisionTree}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{max\PYGZus{}depth}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{min\PYGZus{}samples\PYGZus{}split}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}depth} \PYG{o}{=} \PYG{n}{max\PYGZus{}depth}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{min\PYGZus{}samples\PYGZus{}split} \PYG{o}{=} \PYG{n}{min\PYGZus{}samples\PYGZus{}split}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{root} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Build decision tree.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{root} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}grow\PYGZus{}tree}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{depth}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}grow\PYGZus{}tree}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{depth}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Recursively grow the decision tree.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}
        \PYG{n}{n\PYGZus{}classes} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check stopping criteria}
        \PYG{k}{if} \PYG{p}{(}\PYG{n}{depth} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}depth} \PYG{o+ow}{or} 
            \PYG{n}{n\PYGZus{}samples} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{min\PYGZus{}samples\PYGZus{}split} \PYG{o+ow}{or} 
            \PYG{n}{n\PYGZus{}classes} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create leaf node with majority class}
            \PYG{n}{leaf\PYGZus{}value} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{bincount}\PYG{p}{(}\PYG{n}{y}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{DecisionTreeNode}\PYG{p}{(}\PYG{n}{value}\PYG{o}{=}\PYG{n}{leaf\PYGZus{}value}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Find best split}
        \PYG{n}{best\PYGZus{}feature}\PYG{p}{,} \PYG{n}{best\PYGZus{}threshold} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}best\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Split the data}
        \PYG{n}{left\PYGZus{}indices} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{best\PYGZus{}feature}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{best\PYGZus{}threshold}
        \PYG{n}{right\PYGZus{}indices} \PYG{o}{=} \PYG{o}{\PYGZti{}}\PYG{n}{left\PYGZus{}indices}
        
        \PYG{c+c1}{\PYGZsh{} Create child nodes}
        \PYG{n}{left\PYGZus{}tree} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}grow\PYGZus{}tree}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{left\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{left\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{depth} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{right\PYGZus{}tree} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}grow\PYGZus{}tree}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{right\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{right\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{depth} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{DecisionTreeNode}\PYG{p}{(}
            \PYG{n}{feature\PYGZus{}idx}\PYG{o}{=}\PYG{n}{best\PYGZus{}feature}\PYG{p}{,}
            \PYG{n}{threshold}\PYG{o}{=}\PYG{n}{best\PYGZus{}threshold}\PYG{p}{,}
            \PYG{n}{left}\PYG{o}{=}\PYG{n}{left\PYGZus{}tree}\PYG{p}{,}
            \PYG{n}{right}\PYG{o}{=}\PYG{n}{right\PYGZus{}tree}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}best\PYGZus{}split}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Find the best feature and threshold for splitting.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}
        \PYG{n}{best\PYGZus{}gini} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{best\PYGZus{}feature} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n}{best\PYGZus{}threshold} \PYG{o}{=} \PYG{k+kc}{None}
        
        \PYG{k}{for} \PYG{n}{feature\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get unique threshold values}
            \PYG{n}{thresholds} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{feature\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{k}{for} \PYG{n}{threshold} \PYG{o+ow}{in} \PYG{n}{thresholds}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Split data based on threshold}
                \PYG{n}{left\PYGZus{}indices} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{feature\PYGZus{}idx}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{threshold}
                \PYG{n}{right\PYGZus{}indices} \PYG{o}{=} \PYG{o}{\PYGZti{}}\PYG{n}{left\PYGZus{}indices}
                
                \PYG{c+c1}{\PYGZsh{} Skip if either side is empty}
                \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{left\PYGZus{}indices}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{o+ow}{or} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{right\PYGZus{}indices}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                    \PYG{k}{continue}
                
                \PYG{c+c1}{\PYGZsh{} Calculate Gini impurity}
                \PYG{n}{left\PYGZus{}gini} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}gini}\PYG{p}{(}\PYG{n}{y}\PYG{p}{[}\PYG{n}{left\PYGZus{}indices}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{right\PYGZus{}gini} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}gini}\PYG{p}{(}\PYG{n}{y}\PYG{p}{[}\PYG{n}{right\PYGZus{}indices}\PYG{p}{]}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Weighted average of Gini impurity}
                \PYG{n}{n\PYGZus{}left} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{left\PYGZus{}indices}\PYG{p}{)}
                \PYG{n}{n\PYGZus{}right} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{right\PYGZus{}indices}\PYG{p}{)}
                \PYG{n}{gini} \PYG{o}{=} \PYG{p}{(}\PYG{n}{n\PYGZus{}left} \PYG{o}{*} \PYG{n}{left\PYGZus{}gini} \PYG{o}{+} \PYG{n}{n\PYGZus{}right} \PYG{o}{*} \PYG{n}{right\PYGZus{}gini}\PYG{p}{)} \PYG{o}{/} \PYG{n}{n\PYGZus{}samples}
                
                \PYG{c+c1}{\PYGZsh{} Update best split if this is better}
                \PYG{k}{if} \PYG{n}{gini} \PYG{o}{\PYGZlt{}} \PYG{n}{best\PYGZus{}gini}\PYG{p}{:}
                    \PYG{n}{best\PYGZus{}gini} \PYG{o}{=} \PYG{n}{gini}
                    \PYG{n}{best\PYGZus{}feature} \PYG{o}{=} \PYG{n}{feature\PYGZus{}idx}
                    \PYG{n}{best\PYGZus{}threshold} \PYG{o}{=} \PYG{n}{threshold}
        
        \PYG{k}{return} \PYG{n}{best\PYGZus{}feature}\PYG{p}{,} \PYG{n}{best\PYGZus{}threshold}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}gini}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate Gini impurity.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{m} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{m} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Count occurrences of each class}
        \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{counts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{return\PYGZus{}counts}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{probabilities} \PYG{o}{=} \PYG{n}{counts} \PYG{o}{/} \PYG{n}{m}
        
        \PYG{c+c1}{\PYGZsh{} Calculate Gini impurity}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{probabilities}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Predict class labels for samples in X.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}predict\PYGZus{}sample}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{root}\PYG{p}{)} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{X}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}predict\PYGZus{}sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{node}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Predict class for a single sample.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} If leaf node, return the value}
        \PYG{k}{if} \PYG{n}{node}\PYG{o}{.}\PYG{n}{value} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{node}\PYG{o}{.}\PYG{n}{value}
        
        \PYG{c+c1}{\PYGZsh{} Otherwise, check the feature and go left or right}
        \PYG{k}{if} \PYG{n}{x}\PYG{p}{[}\PYG{n}{node}\PYG{o}{.}\PYG{n}{feature\PYGZus{}idx}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{node}\PYG{o}{.}\PYG{n}{threshold}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}predict\PYGZus{}sample}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{node}\PYG{o}{.}\PYG{n}{left}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}predict\PYGZus{}sample}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{node}\PYG{o}{.}\PYG{n}{right}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a more complex dataset}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{make\PYGZus{}classification}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{make\PYGZus{}classification}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{n\PYGZus{}features}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}redundant}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{n\PYGZus{}informative}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,}
                           \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters\PYGZus{}per\PYGZus{}class}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Split the data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Train our decision tree}
\PYG{n}{tree} \PYG{o}{=} \PYG{n}{SimpleDecisionTree}\PYG{p}{(}\PYG{n}{max\PYGZus{}depth}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Make predictions}
\PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{tree}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
\PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize the decision boundaries}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the data points}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a grid and compute decision tree predictions}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{o}{+}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,}
                     \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{o}{+}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{Z} \PYG{o}{=} \PYG{n}{tree}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot decision boundary}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{contour}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{colors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidths}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Decision Tree Boundaries (Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Clustering Algorithms}
\label{\detokenize{part3/ch09_ml_foundations:clustering-algorithms}}
\sphinxAtStartPar
Clustering algorithms group similar instances without labeled training data.


\subsubsection{K\sphinxhyphen{}means}
\label{\detokenize{part3/ch09_ml_foundations:k-means}}
\sphinxAtStartPar
K\sphinxhyphen{}means partitions data into k clusters by minimizing within\sphinxhyphen{}cluster variance:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Initialize k cluster centers

\item {} 
\sphinxAtStartPar
Assign each point to the nearest center

\item {} 
\sphinxAtStartPar
Update centers to be the mean of assigned points

\item {} 
\sphinxAtStartPar
Repeat until convergence

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Visual cortex forms categories from exposure to similar stimuli, akin to unsupervised clustering.


\subsubsection{Hierarchical Clustering}
\label{\detokenize{part3/ch09_ml_foundations:hierarchical-clustering}}
\sphinxAtStartPar
Hierarchical clustering builds a tree of nested clusters:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Agglomerative (bottom\sphinxhyphen{}up): Start with each point as a cluster and merge

\item {} 
\sphinxAtStartPar
Divisive (top\sphinxhyphen{}down): Start with one cluster and split

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement hierarchical clustering from scratch}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{hierarchical\PYGZus{}clustering}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Agglomerative hierarchical clustering.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Start with each sample in its own cluster}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{clusters} \PYG{o}{=} \PYG{p}{[}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Calculate pairwise distances between all points}
    \PYG{n}{distances} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{distances}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{distances}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{X}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Merge clusters until we reach the desired number}
    \PYG{k}{while} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{clusters}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{n\PYGZus{}clusters}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Find the two closest clusters}
        \PYG{n}{min\PYGZus{}dist} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{merge\PYGZus{}pair} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{clusters}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{clusters}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Calculate average linkage distance (mean of pairwise distances)}
                \PYG{n}{cluster\PYGZus{}dist} \PYG{o}{=} \PYG{l+m+mi}{0}
                \PYG{n}{count} \PYG{o}{=} \PYG{l+m+mi}{0}
                \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{clusters}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{:}
                    \PYG{k}{for} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n}{clusters}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{:}
                        \PYG{n}{cluster\PYGZus{}dist} \PYG{o}{+}\PYG{o}{=} \PYG{n}{distances}\PYG{p}{[}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{]}
                        \PYG{n}{count} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
                \PYG{n}{cluster\PYGZus{}dist} \PYG{o}{/}\PYG{o}{=} \PYG{n}{count}
                
                \PYG{k}{if} \PYG{n}{cluster\PYGZus{}dist} \PYG{o}{\PYGZlt{}} \PYG{n}{min\PYGZus{}dist}\PYG{p}{:}
                    \PYG{n}{min\PYGZus{}dist} \PYG{o}{=} \PYG{n}{cluster\PYGZus{}dist}
                    \PYG{n}{merge\PYGZus{}pair} \PYG{o}{=} \PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Merge the closest clusters}
        \PYG{n}{i}\PYG{p}{,} \PYG{n}{j} \PYG{o}{=} \PYG{n}{merge\PYGZus{}pair}
        \PYG{n}{clusters}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{n}{clusters}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{clusters}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create cluster labels for each sample}
    \PYG{n}{labels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{cluster\PYGZus{}idx}\PYG{p}{,} \PYG{n}{cluster} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{clusters}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{sample\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n}{cluster}\PYG{p}{:}
            \PYG{n}{labels}\PYG{p}{[}\PYG{n}{sample\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{cluster\PYGZus{}idx}
    
    \PYG{k}{return} \PYG{n}{labels}

\PYG{c+c1}{\PYGZsh{} Generate data with 3 clusters}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{150}
\PYG{n}{centers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{]}
\PYG{n}{stds} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{n}{X\PYGZus{}cluster} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{p}{[}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{stds}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} 
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Apply hierarchical clustering}
\PYG{n}{labels} \PYG{o}{=} \PYG{n}{hierarchical\PYGZus{}clustering}\PYG{p}{(}\PYG{n}{X\PYGZus{}cluster}\PYG{p}{,} \PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}cluster}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}cluster}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{labels}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hierarchical Clustering Result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{9.3 Model Evaluation}
\label{\detokenize{part3/ch09_ml_foundations:model-evaluation}}

\subsection{Cross\sphinxhyphen{}validation Techniques}
\label{\detokenize{part3/ch09_ml_foundations:cross-validation-techniques}}
\sphinxAtStartPar
Cross\sphinxhyphen{}validation estimates model performance on unseen data:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{K\sphinxhyphen{}fold CV}: Split data into k subsets, use k\sphinxhyphen{}1 for training and 1 for validation, rotate k times

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Leave\sphinxhyphen{}one\sphinxhyphen{}out CV}: Special case where k = n (number of samples)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stratified CV}: Maintains class distribution in each fold

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement k\PYGZhy{}fold cross\PYGZhy{}validation from scratch}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{k\PYGZus{}fold\PYGZus{}cross\PYGZus{}validation}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Perform k\PYGZhy{}fold cross\PYGZhy{}validation and return scores.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n}{fold\PYGZus{}size} \PYG{o}{=} \PYG{n}{n\PYGZus{}samples} \PYG{o}{/}\PYG{o}{/} \PYG{n}{k}
    
    \PYG{c+c1}{\PYGZsh{} Shuffle data indices}
    \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{permutation}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Store scores for each fold}
    \PYG{n}{scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{fold} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{k}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Select validation indices for this fold}
        \PYG{n}{val\PYGZus{}start} \PYG{o}{=} \PYG{n}{fold} \PYG{o}{*} \PYG{n}{fold\PYGZus{}size}
        \PYG{n}{val\PYGZus{}end} \PYG{o}{=} \PYG{p}{(}\PYG{n}{fold} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{fold\PYGZus{}size} \PYG{k}{if} \PYG{n}{fold} \PYG{o}{\PYGZlt{}} \PYG{n}{k} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{n}{n\PYGZus{}samples}
        \PYG{n}{val\PYGZus{}indices} \PYG{o}{=} \PYG{n}{indices}\PYG{p}{[}\PYG{n}{val\PYGZus{}start}\PYG{p}{:}\PYG{n}{val\PYGZus{}end}\PYG{p}{]}
        \PYG{n}{train\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{[}\PYG{p}{:}\PYG{n}{val\PYGZus{}start}\PYG{p}{]}\PYG{p}{,} \PYG{n}{indices}\PYG{p}{[}\PYG{n}{val\PYGZus{}end}\PYG{p}{:}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Split data}
        \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}val} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{n}{train\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{val\PYGZus{}indices}\PYG{p}{]}
        \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}val} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{n}{train\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{val\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Train the model}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate on validation fold}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}val}\PYG{p}{)}
        \PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{==} \PYG{n}{y\PYGZus{}val}\PYG{p}{)}
        \PYG{n}{scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{accuracy}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{scores}

\PYG{c+c1}{\PYGZsh{} Example: Using cross\PYGZhy{}validation on logistic regression}
\PYG{c+c1}{\PYGZsh{} Create a classification dataset}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create logistic regression model}
\PYG{n}{log\PYGZus{}reg} \PYG{o}{=} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{max\PYGZus{}iter}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Perform cross\PYGZhy{}validation}
\PYG{n}{cv\PYGZus{}scores} \PYG{o}{=} \PYG{n}{k\PYGZus{}fold\PYGZus{}cross\PYGZus{}validation}\PYG{p}{(}\PYG{n}{log\PYGZus{}reg}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cross\PYGZhy{}validation scores: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{cv\PYGZus{}scores}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mean accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{cv\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ± }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{cv\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Regularization Approaches}
\label{\detokenize{part3/ch09_ml_foundations:regularization-approaches}}
\sphinxAtStartPar
Regularization techniques prevent overfitting by adding constraints to model complexity:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L1 regularization (Lasso)}: Adds \(\lambda \sum |w_i|\) to loss, promotes sparsity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{L2 regularization (Ridge)}: Adds \(\lambda \sum w_i^2\) to loss, shrinks weights

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Elastic Net}: Combines L1 and L2 penalties

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Early stopping}: Halt training when validation performance degrades

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Synaptic scaling and homeostatic plasticity in the brain serve as biological “regularizers.”

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement ridge regression (L2 regularization)}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{RidgeRegression}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha} \PYG{o}{=} \PYG{n}{alpha}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fit ridge regression with L2 regularization.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Add bias term}
        \PYG{n}{X\PYGZus{}bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{,} \PYG{n}{X}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Closed\PYGZhy{}form solution with regularization}
        \PYG{c+c1}{\PYGZsh{} (X\PYGZca{}T X + αI)\PYGZca{}(\PYGZhy{}1) X\PYGZca{}T y}
        \PYG{n}{identity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n}{n\PYGZus{}features} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{identity}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Don\PYGZsq{}t regularize bias term}
        
        \PYG{n}{coeffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{inv}\PYG{p}{(}\PYG{n}{X\PYGZus{}bias}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{X\PYGZus{}bias} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha} \PYG{o}{*} \PYG{n}{identity}\PYG{p}{)} \PYG{o}{@} \PYG{n}{X\PYGZus{}bias}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{y}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{=} \PYG{n}{coeffs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{coeffs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Make predictions.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bias} \PYG{o}{+} \PYG{n}{X} \PYG{o}{@} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}

\PYG{c+c1}{\PYGZsh{} Generate data where regularization helps}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{30}
\PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} High\PYGZhy{}dimensional, prone to overfitting}

\PYG{c+c1}{\PYGZsh{} True model only uses the first 5 features}
\PYG{n}{true\PYGZus{}weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}
\PYG{n}{true\PYGZus{}weights}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}
\PYG{n}{true\PYGZus{}bias} \PYG{o}{=} \PYG{l+m+mf}{1.0}

\PYG{c+c1}{\PYGZsh{} Generate data}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}features}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{true\PYGZus{}bias} \PYG{o}{+} \PYG{n}{X} \PYG{o}{@} \PYG{n}{true\PYGZus{}weights} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Split data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compare regular linear regression vs. ridge regression}
\PYG{n}{models} \PYG{o}{=} \PYG{p}{\PYGZob{}}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Linear Regression}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{LinearRegression}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ridge (α=0.1)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{RidgeRegression}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ridge (α=1.0)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{RidgeRegression}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ridge (α=10.0)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{RidgeRegression}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{10.0}\PYG{p}{)}
\PYG{p}{\PYGZcb{}}

\PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}pred\PYGZus{}train} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}pred\PYGZus{}test} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    
    \PYG{n}{train\PYGZus{}mse} \PYG{o}{=} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{test\PYGZus{}mse} \PYG{o}{=} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred\PYGZus{}test}\PYG{p}{)}
    
    \PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{train\PYGZus{}mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{train\PYGZus{}mse}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{test\PYGZus{}mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{test\PYGZus{}mse}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{model}\PYG{o}{.}\PYG{n}{weights}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: Train MSE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{train\PYGZus{}mse}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Test MSE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}mse}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize weights}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{result} \PYG{o+ow}{in} \PYG{n}{results}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{result}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{n}{name}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Weight value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Weights Comparison}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{names} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{results}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{train\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{train\PYGZus{}mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{names}\PYG{p}{]}
\PYG{n}{test\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{test\PYGZus{}mse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{names}\PYG{p}{]}

\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{names}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{width} \PYG{o}{=} \PYG{l+m+mf}{0.35}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{width}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{train\PYGZus{}errors}\PYG{p}{,} \PYG{n}{width}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Train MSE}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{width}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{test\PYGZus{}errors}\PYG{p}{,} \PYG{n}{width}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test MSE}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{names}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean Squared Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training vs. Test Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Bias\sphinxhyphen{}Variance Trade\sphinxhyphen{}off}
\label{\detokenize{part3/ch09_ml_foundations:bias-variance-trade-off}}
\sphinxAtStartPar
The bias\sphinxhyphen{}variance decomposition helps understand model errors:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bias}: Error from incorrect assumptions in the model (underfitting)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Variance}: Error from sensitivity to small fluctuations in training data (overfitting)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Irreducible error}: Noise in the data

\end{itemize}

\sphinxAtStartPar
More complex models have higher variance but lower bias, leading to a trade\sphinxhyphen{}off.

\sphinxAtStartPar
\sphinxincludegraphics{{bias_variance_tradeoff}.svg}
\sphinxstyleemphasis{Figure 9.2: The bias\sphinxhyphen{}variance tradeoff illustrating how error changes with model complexity. Simple models can underfit (high bias), while complex models can overfit (high variance).}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Simulate bias\PYGZhy{}variance tradeoff}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}bias\PYGZus{}variance\PYGZus{}tradeoff}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate bias\PYGZhy{}variance tradeoff with polynomial regression.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate true function: f(x) = sin(x)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{30}
    
    \PYG{n}{x\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate noisy training data}
    \PYG{n}{x\PYGZus{}train} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}train} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Polynomial regression with different degrees}
    \PYG{n}{degrees} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{]}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{degree} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{degrees}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Fit polynomial}
        \PYG{n}{coeffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{polyfit}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{degree}\PYG{p}{)}
        \PYG{n}{poly} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{poly1d}\PYG{p}{(}\PYG{n}{coeffs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{poly}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{)}
        \PYG{n}{train\PYGZus{}mse} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{poly}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate test error over multiple datasets}
        \PYG{n}{n\PYGZus{}datasets} \PYG{o}{=} \PYG{l+m+mi}{100}
        \PYG{n}{test\PYGZus{}predictions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}datasets}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}datasets}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Generate new noisy dataset}
            \PYG{n}{y\PYGZus{}train\PYGZus{}new} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Fit model}
            \PYG{n}{coeffs\PYGZus{}new} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{polyfit}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train\PYGZus{}new}\PYG{p}{,} \PYG{n}{degree}\PYG{p}{)}
            \PYG{n}{poly\PYGZus{}new} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{poly1d}\PYG{p}{(}\PYG{n}{coeffs\PYGZus{}new}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Predict}
            \PYG{n}{test\PYGZus{}predictions}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{poly\PYGZus{}new}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate bias and variance}
        \PYG{n}{mean\PYGZus{}prediction} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{test\PYGZus{}predictions}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{mean\PYGZus{}prediction} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}true}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{variance} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{var}\PYG{p}{(}\PYG{n}{test\PYGZus{}predictions}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{,} \PYG{n}{y\PYGZus{}true}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True function}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot predictions from different datasets}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{n\PYGZus{}datasets}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Plot just 10 to avoid clutter}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x\PYGZus{}true}\PYG{p}{,} \PYG{n}{test\PYGZus{}predictions}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}
            
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Degree }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{degree}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Polynomial}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Bias=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{bias}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Var=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{variance}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Train MSE=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{train\PYGZus{}mse}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{simulate\PYGZus{}bias\PYGZus{}variance\PYGZus{}tradeoff}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Evaluation Metrics}
\label{\detokenize{part3/ch09_ml_foundations:evaluation-metrics}}
\sphinxAtStartPar
Choose metrics based on the task and what errors are most important:

\sphinxAtStartPar
\sphinxstylestrong{Classification metrics:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Accuracy: \(\frac{TP + TN}{TP + TN + FP + FN}\)

\item {} 
\sphinxAtStartPar
Precision: \(\frac{TP}{TP + FP}\) (focus on false positives)

\item {} 
\sphinxAtStartPar
Recall: \(\frac{TP}{TP + FN}\) (focus on false negatives)

\item {} 
\sphinxAtStartPar
F1 Score: \(2 \cdot \frac{precision \cdot recall}{precision + recall}\)

\item {} 
\sphinxAtStartPar
AUC\sphinxhyphen{}ROC: Area under Receiver Operating Characteristic curve

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Regression metrics:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
Mean Squared Error (MSE): \(\frac{1}{n}\sum(y_i - \hat{y}_i)^2\)

\item {} 
\sphinxAtStartPar
Root Mean Squared Error (RMSE): \(\sqrt{MSE}\)

\item {} 
\sphinxAtStartPar
Mean Absolute Error (MAE): \(\frac{1}{n}\sum|y_i - \hat{y}_i|\)

\item {} 
\sphinxAtStartPar
R² Score: \(1 - \frac{\sum(y_i - \hat{y}_i)^2}{\sum(y_i - \bar{y})^2}\)

\end{itemize}


\section{9.4 Feature Engineering}
\label{\detokenize{part3/ch09_ml_foundations:feature-engineering}}

\subsection{Feature Selection Methods}
\label{\detokenize{part3/ch09_ml_foundations:feature-selection-methods}}
\sphinxAtStartPar
Feature selection improves model performance and interpretability:

\sphinxAtStartPar
\sphinxincludegraphics{{feature_selection}.svg}
\sphinxstyleemphasis{Figure 9.4: Comparison of different feature selection approaches (filter, wrapper, and embedded methods) for identifying relevant features in high\sphinxhyphen{}dimensional data.}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Filter methods}: Select features based on their relationship with the target (correlation, mutual information)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Wrapper methods}: Use a model’s performance to evaluate feature subsets (recursive feature elimination)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Embedded methods}: Feature selection happens during model training (L1 regularization)

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Attention mechanisms in the brain filter relevant features from sensory input.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement mutual information feature selection}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{mutual\PYGZus{}information\PYGZus{}feature\PYGZus{}selection}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Select top k features based on mutual information.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{mi\PYGZus{}scores} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate mutual information for each feature}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}features}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Discretize the feature for MI calculation}
        \PYG{n}{x\PYGZus{}discrete} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} For classification tasks}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{10}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Heuristic for classification}
            \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}\PYG{p}{(}\PYG{n}{x\PYGZus{}discrete}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} For regression tasks}
            \PYG{c+c1}{\PYGZsh{} Discretize target for MI estimation}
            \PYG{n}{y\PYGZus{}discrete} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{digitize}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{y}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{y}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}\PYG{p}{(}\PYG{n}{x\PYGZus{}discrete}\PYG{p}{,} \PYG{n}{y\PYGZus{}discrete}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Select top k features}
    \PYG{n}{top\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{mi\PYGZus{}scores}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{k}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{top\PYGZus{}indices}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}

\PYG{c+c1}{\PYGZsh{} Generate synthetic data with informative and noise features}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}synthetic\PYGZus{}dataset}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{n\PYGZus{}informative}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}noise}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate data with informative and noise features.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate informative features}
    \PYG{n}{X\PYGZus{}informative} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}informative}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate target using only informative features}
    \PYG{n}{y} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{X\PYGZus{}informative}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{X\PYGZus{}informative}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYGZbs{}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{X\PYGZus{}informative}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{X\PYGZus{}informative}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)} \PYG{o}{+} \PYGZbs{}
        \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add noise features}
    \PYG{n}{X\PYGZus{}noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}noise}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine features}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{hstack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{X\PYGZus{}informative}\PYG{p}{,} \PYG{n}{X\PYGZus{}noise}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Shuffle feature order}
    \PYG{n}{feature\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{permutation}\PYG{p}{(}\PYG{n}{n\PYGZus{}informative} \PYG{o}{+} \PYG{n}{n\PYGZus{}noise}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{feature\PYGZus{}indices}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Keep track of which features were truly informative}
    \PYG{n}{true\PYGZus{}informative} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{feature\PYGZus{}indices}\PYG{p}{)} \PYG{k}{if} \PYG{n}{idx} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}informative}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{true\PYGZus{}informative}

\PYG{c+c1}{\PYGZsh{} Generate data}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{true\PYGZus{}informative} \PYG{o}{=} \PYG{n}{generate\PYGZus{}synthetic\PYGZus{}dataset}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Apply mutual information feature selection}
\PYG{n}{k} \PYG{o}{=} \PYG{l+m+mi}{5}
\PYG{n}{selected\PYGZus{}indices}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores} \PYG{o}{=} \PYG{n}{mutual\PYGZus{}information\PYGZus{}feature\PYGZus{}selection}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{n}{k}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compare with true informative features}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{True informative features: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{true\PYGZus{}informative}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Selected features: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{selected\PYGZus{}indices}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot mutual information scores}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{selected\PYGZus{}indices}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{selected\PYGZus{}indices}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Selected features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{true\PYGZus{}informative}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{true\PYGZus{}informative}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True informative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature Selection with Mutual Information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Dimensionality Reduction}
\label{\detokenize{part3/ch09_ml_foundations:dimensionality-reduction}}
\sphinxAtStartPar
Dimensionality reduction techniques create compact representations of data:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Principal Component Analysis (PCA)}: Linear projection to maximize variance

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{t\sphinxhyphen{}SNE}: Non\sphinxhyphen{}linear projection that preserves local structure

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Autoencoders}: Neural networks that compress data through a bottleneck

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological parallel:} Neural representations often use dimensionality reduction for efficient coding.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Implement PCA from scratch}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PCA}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components} \PYG{o}{=} \PYG{n}{n\PYGZus{}components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{components} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fit PCA on data X.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Standardize data}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{X} \PYG{o}{=} \PYG{n}{X} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean}
        
        \PYG{c+c1}{\PYGZsh{} Compute covariance matrix}
        \PYG{n}{cov\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cov}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{rowvar}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Eigenvalue decomposition}
        \PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eigh}\PYG{p}{(}\PYG{n}{cov\PYGZus{}matrix}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Sort eigenvectors by descending eigenvalues}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{eigenvalues}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{eigenvectors}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Select top n\PYGZus{}components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{components} \PYG{o}{=} \PYG{n}{eigenvectors}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n+nb+bp}{self}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{transform}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Transform data to lower\PYGZhy{}dimensional space.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{X} \PYG{o}{=} \PYG{n}{X} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{components}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fit and transform in one step.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Demonstrate PCA on a simple dataset}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}digits}

\PYG{c+c1}{\PYGZsh{} Load digits dataset}
\PYG{n}{digits} \PYG{o}{=} \PYG{n}{load\PYGZus{}digits}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{digits}\PYG{o}{.}\PYG{n}{data}\PYG{p}{,} \PYG{n}{digits}\PYG{o}{.}\PYG{n}{target}

\PYG{c+c1}{\PYGZsh{} Apply PCA}
\PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{X\PYGZus{}pca} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize first two principal components}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{digit} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{mask} \PYG{o}{=} \PYG{p}{(}\PYG{n}{y} \PYG{o}{==} \PYG{n}{digit}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}pca}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}pca}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{digit}\PYG{p}{)}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{First Principal Component}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Second Principal Component}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PCA of Digits Dataset}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Handling Categorical Variables}
\label{\detokenize{part3/ch09_ml_foundations:handling-categorical-variables}}
\sphinxAtStartPar
Categorical variables require special processing:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{One\sphinxhyphen{}hot encoding}: Create binary features for each category

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Label encoding}: Map categories to integers

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Target encoding}: Replace categories with target statistics

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Entity embeddings}: Learn low\sphinxhyphen{}dimensional representations

\end{itemize}


\subsection{Scaling and Normalization}
\label{\detokenize{part3/ch09_ml_foundations:scaling-and-normalization}}
\sphinxAtStartPar
Feature scaling ensures that all features contribute appropriately:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{StandardScaler}: \(x' = \frac{x - \mu}{\sigma}\) (zero mean, unit variance)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{MinMaxScaler}: \(x' = \frac{x - \min(x)}{\max(x) - \min(x)}\) (scales to {[}0,1{]})

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{RobustScaler}: Uses quantiles instead of mean/variance (robust to outliers)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Normalizer}: Scales samples to unit norm

\end{itemize}


\section{9.5 Neural Basis of ML}
\label{\detokenize{part3/ch09_ml_foundations:neural-basis-of-ml}}
\sphinxAtStartPar
\sphinxincludegraphics{{neuroscience_ml_parallels}.svg}
\sphinxstyleemphasis{Figure 9.3: Key parallels between machine learning concepts and their biological counterparts in neuroscience.}


\subsection{Biological Parallels to Supervised Learning}
\label{\detokenize{part3/ch09_ml_foundations:biological-parallels-to-supervised-learning}}
\sphinxAtStartPar
Supervised learning in the brain occurs through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error\sphinxhyphen{}driven learning}: Cerebellum uses climbing fiber signals as error feedback

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reward\sphinxhyphen{}based learning}: Dopamine encodes reward prediction errors

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Instructive signals}: Direct teaching signals in specific systems

\end{itemize}


\subsection{Neurobiological Clustering Mechanisms}
\label{\detokenize{part3/ch09_ml_foundations:neurobiological-clustering-mechanisms}}
\sphinxAtStartPar
The brain forms clusters and categories through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Competitive learning}: Lateral inhibition creates winner\sphinxhyphen{}take\sphinxhyphen{}all dynamics

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}organizing maps}: Topographic neural maps form based on input statistics

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hebbian assembly formation}: Correlated activity strengthens connections between neurons

\end{itemize}


\subsection{Reinforcement Learning in the Brain}
\label{\detokenize{part3/ch09_ml_foundations:reinforcement-learning-in-the-brain}}
\sphinxAtStartPar
The brain implements RL principles through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dopaminergic system}: Encodes reward prediction errors (δ in TD learning)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Basal ganglia circuits}: Implementation of actor\sphinxhyphen{}critic architecture

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prefrontal cortex}: Represents state\sphinxhyphen{}action values and policies

\end{itemize}


\subsection{Feature Learning in Sensory Systems}
\label{\detokenize{part3/ch09_ml_foundations:feature-learning-in-sensory-systems}}
\sphinxAtStartPar
Sensory systems extract features through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical processing}: Simple to complex feature extraction

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Experience\sphinxhyphen{}dependent plasticity}: Features adapt to environmental statistics

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sparse coding}: Neural populations encode stimuli efficiently

\end{itemize}


\section{9.6 Code Lab}
\label{\detokenize{part3/ch09_ml_foundations:code-lab}}
\sphinxAtStartPar
Let’s implement a complete machine learning pipeline with neuroscience applications:


\subsection{Example: Neural Decoding from Spike Train Data}
\label{\detokenize{part3/ch09_ml_foundations:example-neural-decoding-from-spike-train-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Neural decoding example: Predict stimulus from simulated spike trains}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}decoding\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate machine learning pipeline for neural decoding.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Step 1: Generate synthetic neural data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Parameters}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n}{n\PYGZus{}stimuli} \PYG{o}{=} \PYG{l+m+mi}{8}
    \PYG{n}{n\PYGZus{}trials\PYGZus{}per\PYGZus{}stimulus} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{n\PYGZus{}timepoints} \PYG{o}{=} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Generate tuning curves (each neuron has a preferred stimulus)}
    \PYG{n}{preferred\PYGZus{}stimuli} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    \PYG{n}{tuning\PYGZus{}width} \PYG{o}{=} \PYG{l+m+mf}{0.5}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{stim}\PYG{p}{,} \PYG{n}{preferred}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Von Mises tuning curve (circular Gaussian)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{stim} \PYG{o}{\PYGZhy{}} \PYG{n}{preferred}\PYG{p}{)} \PYG{o}{/} \PYG{n}{width}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate stimuli (angles)}
    \PYG{n}{stimuli} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{n\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{endpoint}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{stimulus\PYGZus{}labels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{repeat}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials\PYGZus{}per\PYGZus{}stimulus}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate spike trains}
    \PYG{n}{spike\PYGZus{}trains} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli} \PYG{o}{*} \PYG{n}{n\PYGZus{}trials\PYGZus{}per\PYGZus{}stimulus}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{stim\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{stimulus\PYGZus{}labels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{stim} \PYG{o}{=} \PYG{n}{stimuli}\PYG{p}{[}\PYG{n}{stim\PYGZus{}idx}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Firing rate based on tuning curve}
            \PYG{n}{rate} \PYG{o}{=} \PYG{n}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{stim}\PYG{p}{,} \PYG{n}{preferred\PYGZus{}stimuli}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{tuning\PYGZus{}width}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.2}
            \PYG{c+c1}{\PYGZsh{} Generate Poisson spike train}
            \PYG{n}{spike\PYGZus{}trains}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{poisson}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 2: Preprocess the data}
    
    \PYG{c+c1}{\PYGZsh{} Extract features: Average firing rates}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{spike\PYGZus{}trains}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Average over time}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{stimulus\PYGZus{}labels}
    
    \PYG{c+c1}{\PYGZsh{} Split data}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{stratify}\PYG{o}{=}\PYG{n}{y}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 3: Feature engineering}
    
    \PYG{c+c1}{\PYGZsh{} Standardize features}
    \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train\PYGZus{}scaled} \PYG{o}{=} \PYG{p}{(}\PYG{n}{X\PYGZus{}train} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test\PYGZus{}scaled} \PYG{o}{=} \PYG{p}{(}\PYG{n}{X\PYGZus{}test} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}10}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Dimensionality reduction}
    \PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train\PYGZus{}pca} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}scaled}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test\PYGZus{}pca} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}scaled}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 4: Model selection and training}
    
    \PYG{c+c1}{\PYGZsh{} Create different models}
    \PYG{n}{models} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Logistic Regression}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{max\PYGZus{}iter}\PYG{o}{=}\PYG{l+m+mi}{2000}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SVM (from sklearn)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{SVC}\PYG{p}{(}\PYG{n}{kernel}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rbf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{scale}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Decision Tree}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{SimpleDecisionTree}\PYG{p}{(}\PYG{n}{max\PYGZus{}depth}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Train the model}
        \PYG{k}{if} \PYG{n}{name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SVM (from sklearn)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}pca}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}pca}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Make predictions}
        \PYG{k}{if} \PYG{n}{name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SVM (from sklearn)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}pca}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}pca}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate accuracy}
        \PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
        \PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{accuracy}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 5: Visualization}
    
    \PYG{c+c1}{\PYGZsh{} Visualize feature importance}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot PCA representation}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{stim\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mask} \PYG{o}{=} \PYG{p}{(}\PYG{n}{y\PYGZus{}train} \PYG{o}{==} \PYG{n}{stim\PYGZus{}idx}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}pca}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}train\PYGZus{}pca}\PYG{p}{[}\PYG{n}{mask}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stim }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{stim\PYGZus{}idx}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PC1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PC2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PCA of Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot tuning curves}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{stim\PYGZus{}range} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Plot first 10 neurons}
        \PYG{n}{rates} \PYG{o}{=} \PYG{p}{[}\PYG{n}{tuning\PYGZus{}curve}\PYG{p}{(}\PYG{n}{s}\PYG{p}{,} \PYG{n}{preferred\PYGZus{}stimuli}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{tuning\PYGZus{}width}\PYG{p}{)} \PYG{k}{for} \PYG{n}{s} \PYG{o+ow}{in} \PYG{n}{stim\PYGZus{}range}\PYG{p}{]}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{stim\PYGZus{}range}\PYG{p}{,} \PYG{n}{rates}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stimulus angle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuronal Tuning Curves}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot model comparison}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{results}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{results}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Performance Comparison}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot confusion matrix for best model}
    \PYG{n}{best\PYGZus{}model} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{results}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{n}{results}\PYG{o}{.}\PYG{n}{get}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{best\PYGZus{}model} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SVM (from sklearn)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{models}\PYG{p}{[}\PYG{n}{best\PYGZus{}model}\PYG{p}{]}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}pca}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{models}\PYG{p}{[}\PYG{n}{best\PYGZus{}model}\PYG{p}{]}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}pca}\PYG{p}{)}
    
    \PYG{n}{confusion} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{confusion}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{y\PYGZus{}test} \PYG{o}{==} \PYG{n}{i}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{==} \PYG{n}{j}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{confusion}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Proportion}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted stimulus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True stimulus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Confusion Matrix (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{best\PYGZus{}model}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{models}\PYG{p}{,} \PYG{n}{results}

\PYG{c+c1}{\PYGZsh{} Run the neural decoding example}
\PYG{n}{models}\PYG{p}{,} \PYG{n}{results} \PYG{o}{=} \PYG{n}{neural\PYGZus{}decoding\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example: Feature Selection for Neuroscience Data}
\label{\detokenize{part3/ch09_ml_foundations:example-feature-selection-for-neuroscience-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Feature selection for neuroscience data}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{feature\PYGZus{}selection\PYGZus{}neuroscience}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate feature selection techniques on simulated neural data.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate simulated neural recording with multiple channels}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Parameters}
    \PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{n\PYGZus{}informative} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{500}
    
    \PYG{c+c1}{\PYGZsh{} Generate data}
    \PYG{c+c1}{\PYGZsh{} Only a subset of channels respond to the condition}
    \PYG{n}{informative\PYGZus{}channels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}informative}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel responses (0 = baseline, 1 = activation)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Baseline activity}
    
    \PYG{c+c1}{\PYGZsh{} Add signal to informative channels when y = 1}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{informative\PYGZus{}channels}\PYG{p}{:}
        \PYG{n}{X}\PYG{p}{[}\PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split data}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Feature selection methods}
    
    \PYG{c+c1}{\PYGZsh{} 1. Mutual Information}
    \PYG{n}{mi\PYGZus{}scores} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mutual\PYGZus{}info\PYGZus{}score}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Univariate t\PYGZhy{}tests}
    \PYG{n}{t\PYGZus{}scores} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
    \PYG{n}{p\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{t}\PYG{p}{,} \PYG{n}{p} \PYG{o}{=} \PYG{n}{stats}\PYG{o}{.}\PYG{n}{ttest\PYGZus{}ind}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{y\PYGZus{}train} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{y\PYGZus{}train} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{t\PYGZus{}scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{p\PYGZus{}values}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p}
    
    \PYG{c+c1}{\PYGZsh{} Select top features from each method}
    \PYG{n}{k} \PYG{o}{=} \PYG{n}{n\PYGZus{}informative}
    \PYG{n}{mi\PYGZus{}selected} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{mi\PYGZus{}scores}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{k}\PYG{p}{:}\PYG{p}{]}
    \PYG{n}{t\PYGZus{}selected} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{t\PYGZus{}scores}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{k}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate with logistic regression}
    \PYG{n}{methods} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{All Features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}train}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MI Selected}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{mi\PYGZus{}selected}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZhy{}test Selected}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t\PYGZus{}selected}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n}{test\PYGZus{}sets} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{All Features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}test}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MI Selected}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{mi\PYGZus{}selected}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZhy{}test Selected}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t\PYGZus{}selected}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{n}{accuracies} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{X\PYGZus{}train\PYGZus{}selected} \PYG{o+ow}{in} \PYG{n}{methods}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Train logistic regression}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{max\PYGZus{}iter}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}selected}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{test\PYGZus{}sets}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{accuracies}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracies}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualization}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot feature importance}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{informative\PYGZus{}channels}\PYG{p}{,} \PYG{n}{mi\PYGZus{}scores}\PYG{p}{[}\PYG{n}{informative\PYGZus{}channels}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{*}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True informative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Channel index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual information}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mutual Information Feature Importance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{,} \PYG{n}{t\PYGZus{}scores}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{informative\PYGZus{}channels}\PYG{p}{,} \PYG{n}{t\PYGZus{}scores}\PYG{p}{[}\PYG{n}{informative\PYGZus{}channels}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{*}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True informative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Channel index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|t\PYGZhy{}statistic|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZhy{}test Feature Importance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot channel activity for a few examples}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{label} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Plot first 3 informative channels}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{channel} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{informative\PYGZus{}channels}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{y} \PYG{o}{==} \PYG{n}{label}\PYG{p}{,} \PYG{n}{channel}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{y} \PYG{o}{==} \PYG{n}{label}\PYG{p}{,} \PYG{n}{channel}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{errorbar}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{n}{label}\PYG{o}{*}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{yerr}\PYG{o}{=}\PYG{n}{std}\PYG{p}{,} \PYG{n}{fmt}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
                         \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{label}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Channel }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{channel}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Channel index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activity in Informative Channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot accuracies}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{accuracies}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{accuracies}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Classification Accuracy with Feature Selection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{feature\PYGZus{}selection\PYGZus{}neuroscience}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{9.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part3/ch09_ml_foundations:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Machine learning algorithms can be interpreted through the lens of neuroscience, revealing interesting parallels and differences.

\item {} 
\sphinxAtStartPar
Classical ML approaches are often simpler and more interpretable than modern deep learning methods, making them valuable for scientific applications.

\item {} 
\sphinxAtStartPar
Feature engineering remains crucial for extracting meaningful information from neural data.

\item {} 
\sphinxAtStartPar
The bias\sphinxhyphen{}variance tradeoff guides model selection and regularization choices.

\item {} 
\sphinxAtStartPar
Neuroscience can benefit from ML for neural decoding and pattern discovery, while ML can be inspired by neural computation principles.

\item {} 
\sphinxAtStartPar
Understanding both domains enables the development of more effective and biologically plausible algorithms.

\end{itemize}


\section{9.8 Further Reading \& Media}
\label{\detokenize{part3/ch09_ml_foundations:further-reading-media}}

\subsection{Books}
\label{\detokenize{part3/ch09_ml_foundations:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Bishop, C. M. (2006). \sphinxstyleemphasis{Pattern Recognition and Machine Learning}. Springer.

\item {} 
\sphinxAtStartPar
Hastie, T., Tibshirani, R., \& Friedman, J. (2009). \sphinxstyleemphasis{The Elements of Statistical Learning}. Springer.

\item {} 
\sphinxAtStartPar
Murphy, K. P. (2012). \sphinxstyleemphasis{Machine Learning: A Probabilistic Perspective}. MIT Press.

\item {} 
\sphinxAtStartPar
Dayan, P., \& Abbott, L. F. (2001). \sphinxstyleemphasis{Theoretical Neuroscience: Computational and Mathematical Modeling of Neural Systems}. MIT Press.

\end{itemize}


\subsection{Articles}
\label{\detokenize{part3/ch09_ml_foundations:articles}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Glaser, J. I., Benjamin, A. S., Farhoodi, R., \& Kording, K. P. (2019). “The Roles of Supervised Machine Learning in Systems Neuroscience”. \sphinxstyleemphasis{Progress in Neurobiology}.

\item {} 
\sphinxAtStartPar
Kriegeskorte, N., \& Golan, T. (2019). “Neural Network Models and Deep Learning”. \sphinxstyleemphasis{Current Biology}.

\item {} 
\sphinxAtStartPar
Bzdok, D., Altman, N., \& Krzywinski, M. (2018). “Statistics versus Machine Learning”. \sphinxstyleemphasis{Nature Methods}.

\item {} 
\sphinxAtStartPar
Krakauer, J. W., Ghazanfar, A. A., Gomez\sphinxhyphen{}Marin, A., MacIver, M. A., \& Poeppel, D. (2017). “Neuroscience Needs Behavior: Correcting a Reductionist Bias”. \sphinxstyleemphasis{Neuron}.

\end{itemize}


\subsection{Online Resources}
\label{\detokenize{part3/ch09_ml_foundations:online-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Coursera: “Machine Learning” by Andrew Ng

\item {} 
\sphinxAtStartPar
\sphinxhref{http://Fast.ai}{Fast.ai}: “Practical Machine Learning for Coders”

\item {} 
\sphinxAtStartPar
Neuromatch Academy: Computational Neuroscience tutorials

\item {} 
\sphinxAtStartPar
3Blue1Brown: Neural Networks series

\item {} 
\sphinxAtStartPar
StatQuest with Josh Starmer: ML algorithm explanations on YouTube

\end{itemize}

\sphinxstepscope


\chapter{Chapter 10: Deep Learning: Training \& Optimisation}
\label{\detokenize{part3/ch10_deep_learning:chapter-10-deep-learning-training-optimisation}}\label{\detokenize{part3/ch10_deep_learning::doc}}
\begin{sphinxadmonition}{note}{Learning Objectives}

\sphinxAtStartPar
By the end of this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Master} deep neural network architectures and training techniques

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Understand} optimization algorithms and their underlying mathematical principles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implement} key deep learning components from scratch and with frameworks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Apply} best practices for model development and troubleshooting

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compare} biological and artificial optimization approaches

\end{itemize}
\end{sphinxadmonition}


\section{10.1 Neural Network Fundamentals}
\label{\detokenize{part3/ch10_deep_learning:neural-network-fundamentals}}
\sphinxAtStartPar
Deep learning has revolutionized AI by enabling models to learn hierarchical representations directly from data. At its core, deep learning is built on neural networks with multiple layers that progressively extract higher\sphinxhyphen{}level features.

\sphinxAtStartPar
\sphinxincludegraphics{{neural_network_architecture}.svg}
\sphinxstyleemphasis{Figure 10.1: A multilayer perceptron with two hidden layers, showing how neurons connect between layers and activate through non\sphinxhyphen{}linear functions.}


\subsection{10.1.1 Multilayer Perceptrons}
\label{\detokenize{part3/ch10_deep_learning:multilayer-perceptrons}}
\sphinxAtStartPar
Multilayer perceptrons (MLPs) are the foundational architecture of deep learning, consisting of an input layer, one or more hidden layers, and an output layer.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}

\PYG{c+c1}{\PYGZsh{} Define a simple MLP using PyTorch}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleMLP}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        A basic multilayer perceptron implementation.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Number of input features}
\PYG{l+s+sd}{            hidden\PYGZus{}sizes: List of hidden layer sizes}
\PYG{l+s+sd}{            output\PYGZus{}size: Number of output units}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleMLP}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a list to hold all layers}
        \PYG{n}{layers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Input layer to first hidden layer}
        \PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Hidden layers}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final layer}
        \PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine all layers into a sequential model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}\PYG{o}{*}\PYG{n}{layers}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Forward pass through the network.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create an example MLP}
\PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{hidden\PYGZus{}sizes} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{]}
\PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{2}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleMLP}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}sizes}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Display model architecture}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The power of MLPs comes from their ability to approximate any continuous function with sufficient neurons in the hidden layers (universal approximation theorem).


\subsection{10.1.2 Activation Functions}
\label{\detokenize{part3/ch10_deep_learning:activation-functions}}
\sphinxAtStartPar
Activation functions introduce non\sphinxhyphen{}linearity into neural networks, allowing them to learn complex patterns.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}activation\PYGZus{}functions}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot common activation functions used in deep learning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate input values}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate activation function outputs}
    \PYG{n}{sigmoid} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{tanh} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
    \PYG{n}{relu} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}
    \PYG{n}{leaky\PYGZus{}relu} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{x}\PYG{p}{)}
    \PYG{n}{elu} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{sigmoid}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sigmoid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{tanh}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tanh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{relu}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ReLU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{leaky\PYGZus{}relu}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Leaky ReLU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{elu}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ELU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Common Activation Functions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Common activation functions include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ReLU (Rectified Linear Unit)}: \(f(x) = \max(0, x)\)
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Fast computation, reduces vanishing gradient problem

\item {} 
\sphinxAtStartPar
Cons: “Dying ReLU” problem (neurons can get stuck)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Leaky ReLU}: \(f(x) = \max(\alpha x, x)\) where \(\alpha\) is a small constant
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Addresses dying ReLU problem

\item {} 
\sphinxAtStartPar
Cons: Performance improvement is often marginal

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sigmoid}: \(f(x) = \frac{1}{1 + e^{-x}}\)
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Outputs between 0 and 1, useful for binary classification

\item {} 
\sphinxAtStartPar
Cons: Vanishing gradient problem for extreme inputs

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Tanh (Hyperbolic Tangent)}: \(f(x) = \tanh(x) = \frac{e^x - e^{-x}}{e^x + e^{-x}}\)
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Zero\sphinxhyphen{}centered, useful in recurrent networks

\item {} 
\sphinxAtStartPar
Cons: Still suffers from vanishing gradient

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{GELU (Gaussian Error Linear Unit)}: \(f(x) = x \cdot \Phi(x)\) where \(\Phi\) is the CDF of the standard normal distribution
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Smooth, better performance in transformers

\item {} 
\sphinxAtStartPar
Cons: More computationally expensive

\end{itemize}

\end{itemize}

\sphinxAtStartPar
Recent architectures like transformers commonly use GELU, while CNNs often use ReLU or its variants.


\subsection{10.1.3 Backpropagation Algorithm}
\label{\detokenize{part3/ch10_deep_learning:backpropagation-algorithm}}
\sphinxAtStartPar
Backpropagation is the cornerstone algorithm for training neural networks, efficiently computing gradients through the chain rule.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{manual\PYGZus{}backpropagation\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate backpropagation with a simple 2\PYGZhy{}layer network.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simple network: Input \PYGZhy{}\PYGZgt{} Hidden (2 neurons) \PYGZhy{}\PYGZgt{} Output}
    \PYG{c+c1}{\PYGZsh{} Forward pass}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid\PYGZus{}derivative}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{x} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{x}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Network parameters}
    \PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{2}
    \PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Inputs and target}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mf}{0.7}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize weights and biases}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{W1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{b1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{W2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{b2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Forward pass}
    \PYG{n}{hidden\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{W1}\PYG{p}{)} \PYG{o}{+} \PYG{n}{b1}
    \PYG{n}{hidden\PYGZus{}output} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}input}\PYG{p}{)}
    \PYG{n}{final\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}output}\PYG{p}{,} \PYG{n}{W2}\PYG{p}{)} \PYG{o}{+} \PYG{n}{b2}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{final\PYGZus{}input}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate loss}
    \PYG{n}{loss} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}true}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Backpropagation}
    \PYG{c+c1}{\PYGZsh{} Output layer error}
    \PYG{n}{output\PYGZus{}error} \PYG{o}{=} \PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}true}
    \PYG{n}{output\PYGZus{}delta} \PYG{o}{=} \PYG{n}{output\PYGZus{}error} \PYG{o}{*} \PYG{n}{sigmoid\PYGZus{}derivative}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Hidden layer error}
    \PYG{n}{hidden\PYGZus{}error} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{output\PYGZus{}delta}\PYG{p}{,} \PYG{n}{W2}\PYG{o}{.}\PYG{n}{T}\PYG{p}{)}
    \PYG{n}{hidden\PYGZus{}delta} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}error} \PYG{o}{*} \PYG{n}{sigmoid\PYGZus{}derivative}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}output}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Update weights and biases}
    \PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mf}{0.1}
    \PYG{n}{W2} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}output}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{output\PYGZus{}delta}\PYG{p}{)}
    \PYG{n}{b2} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{output\PYGZus{}delta}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{W1} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}delta}\PYG{p}{)}
    \PYG{n}{b1} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}delta}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Initial prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{y\PYGZus{}pred}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Target}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{y\PYGZus{}true}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{loss}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output delta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{output\PYGZus{}delta}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden delta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{hidden\PYGZus{}delta}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
The backpropagation algorithm:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Forward Pass}: Compute outputs of all neurons from input to output

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error Calculation}: Compare network output with target to compute error

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Backward Pass}: Propagate error backward to assign “responsibility” to each parameter

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parameter Update}: Adjust weights and biases using calculated gradients

\end{enumerate}

\sphinxAtStartPar
While modern deep learning frameworks handle these calculations automatically through automatic differentiation, understanding backpropagation is crucial for developing intuition about neural network training.


\subsection{10.1.4 Vanishing/Exploding Gradients}
\label{\detokenize{part3/ch10_deep_learning:vanishing-exploding-gradients}}
\sphinxAtStartPar
As neural networks get deeper, the problem of vanishing or exploding gradients becomes more severe:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}gradient\PYGZus{}problems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize vanishing/exploding gradient problems in deep networks.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{depths} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{21}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Vanishing gradient with sigmoid}
    \PYG{n}{vanishing\PYGZus{}grads} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.25} \PYG{o}{*}\PYG{o}{*} \PYG{n}{d} \PYG{k}{for} \PYG{n}{d} \PYG{o+ow}{in} \PYG{n}{depths}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Exploding gradient with poor initialization}
    \PYG{n}{exploding\PYGZus{}grads} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{1.5} \PYG{o}{*}\PYG{o}{*} \PYG{n}{d} \PYG{k}{for} \PYG{n}{d} \PYG{o+ow}{in} \PYG{n}{depths}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{depths}\PYG{p}{,} \PYG{n}{vanishing\PYGZus{}grads}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Vanishing Gradient (sigmoid)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{depths}\PYG{p}{,} \PYG{n}{exploding\PYGZus{}grads}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Exploding Gradient (poor init)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{depths}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{depths}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stable Gradient (with techniques)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Network Depth (layers)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gradient Magnitude (log scale)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Vanishing and Exploding Gradients in Deep Networks}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Solutions to these gradient problems include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Careful weight initialization (e.g., He, Xavier/Glorot)

\item {} 
\sphinxAtStartPar
Batch normalization

\item {} 
\sphinxAtStartPar
Residual connections

\item {} 
\sphinxAtStartPar
Gradient clipping

\item {} 
\sphinxAtStartPar
Using activation functions that don’t saturate (e.g., ReLU)

\end{itemize}


\section{10.2 Optimization Techniques}
\label{\detokenize{part3/ch10_deep_learning:optimization-techniques}}
\sphinxAtStartPar
Training deep neural networks requires effective optimization algorithms. The choice of optimizer significantly impacts training speed and model performance.

\sphinxAtStartPar
\sphinxincludegraphics{{optimization_algorithms}.svg}
\sphinxstyleemphasis{Figure 10.2: Comparison of different optimization algorithms showing convergence paths in a loss landscape. Modern approaches like Adam and RMSprop often converge faster and more reliably than vanilla SGD.}


\subsection{10.2.1 Stochastic Gradient Descent}
\label{\detokenize{part3/ch10_deep_learning:stochastic-gradient-descent}}
\sphinxAtStartPar
Stochastic Gradient Descent (SGD) is the most fundamental optimization algorithm for neural networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sgd\PYGZus{}optimizer\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Implement basic SGD and variants.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate dummy data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{w\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{X} \PYG{o}{@} \PYG{n}{w\PYGZus{}true} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize parameters}
    \PYG{n}{w} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} SGD parameters}
    \PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mf}{0.01}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Shuffle data}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{permutation}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{X\PYGZus{}shuffled} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{]}
        \PYG{n}{y\PYGZus{}shuffled} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{]}
        
        \PYG{n}{epoch\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{c+c1}{\PYGZsh{} Process mini\PYGZhy{}batches}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{X\PYGZus{}batch} \PYG{o}{=} \PYG{n}{X\PYGZus{}shuffled}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            \PYG{n}{y\PYGZus{}batch} \PYG{o}{=} \PYG{n}{y\PYGZus{}shuffled}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{X\PYGZus{}batch} \PYG{o}{@} \PYG{n}{w}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}batch}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{epoch\PYGZus{}losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{loss}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward pass (compute gradient)}
            \PYG{n}{grad} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{X\PYGZus{}batch}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{p}{(}\PYG{n}{y\PYGZus{}pred} \PYG{o}{\PYGZhy{}} \PYG{n}{y\PYGZus{}batch}\PYG{p}{)} \PYG{o}{/} \PYG{n}{batch\PYGZus{}size}
            
            \PYG{c+c1}{\PYGZsh{} Update parameters}
            \PYG{n}{w} \PYG{o}{=} \PYG{n}{w} \PYG{o}{\PYGZhy{}} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{grad}
        
        \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{epoch\PYGZus{}losses}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{w}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true\PYGZus{}weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{w\PYGZus{}true}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final\PYGZus{}loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{losses}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss\PYGZus{}history}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{losses}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
SGD variants include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Batch Gradient Descent}: Uses the entire dataset per update

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mini\sphinxhyphen{}batch SGD}: Uses small batches (typically 32\sphinxhyphen{}256 samples)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Online SGD}: Updates using one sample at a time

\end{itemize}


\subsection{10.2.2 Momentum and Adaptive Methods}
\label{\detokenize{part3/ch10_deep_learning:momentum-and-adaptive-methods}}
\sphinxAtStartPar
Modern optimizers build upon SGD by introducing momentum or adaptive learning rates:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}optimizers}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare convergence speed of different optimizers.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    
    \PYG{c+c1}{\PYGZsh{} Define a simple problem}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss function}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define optimizers}
    \PYG{n}{optimizers} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SGD}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SGD+Momentum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{momentum}\PYG{o}{=}\PYG{l+m+mf}{0.9}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Adam}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RMSprop}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{RMSprop}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{AdamW}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{AdamW}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{weight\PYGZus{}decay}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Training loops}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{optimizer} \PYG{o+ow}{in} \PYG{n}{optimizers}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Reset model}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Train}
        \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
            \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{losses}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{loss\PYGZus{}history} \PYG{o+ow}{in} \PYG{n}{results}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{loss\PYGZus{}history}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{n}{name}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Optimizer Convergence Comparison}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yscale}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key optimization algorithms include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{SGD with Momentum}: Adds a fraction of the previous update to the current one, helping to escape local minima and accelerate convergence
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(v_t = \gamma v_{t-1} + \eta \nabla_\theta J(\theta)\)

\item {} 
\sphinxAtStartPar
\(\theta = \theta - v_t\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Nesterov Accelerated Gradient}: Computes gradient at the “looked\sphinxhyphen{}ahead” position for better convergence
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(v_t = \gamma v_{t-1} + \eta \nabla_\theta J(\theta - \gamma v_{t-1})\)

\item {} 
\sphinxAtStartPar
\(\theta = \theta - v_t\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AdaGrad}: Adapts learning rates per\sphinxhyphen{}parameter based on historical gradients
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(\theta_{t+1} = \theta_t - \frac{\eta}{\sqrt{G_t + \epsilon}} \odot g_t\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{RMSprop}: Modifies AdaGrad to better handle non\sphinxhyphen{}convex functions by using an exponentially weighted moving average
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(E[g^2]_t = \beta E[g^2]_{t-1} + (1-\beta) g_t^2\)

\item {} 
\sphinxAtStartPar
\(\theta_{t+1} = \theta_t - \frac{\eta}{\sqrt{E[g^2]_t + \epsilon}} g_t\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adam}: Combines momentum and RMSprop ideas for robust performance
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(m_t = \beta_1 m_{t-1} + (1-\beta_1) g_t\) (momentum)

\item {} 
\sphinxAtStartPar
\(v_t = \beta_2 v_{t-1} + (1-\beta_2) g_t^2\) (RMSprop)

\item {} 
\sphinxAtStartPar
\(\hat{m}_t = \frac{m_t}{1-\beta_1^t}\), \(\hat{v}_t = \frac{v_t}{1-\beta_2^t}\) (bias correction)

\item {} 
\sphinxAtStartPar
\(\theta_{t+1} = \theta_t - \frac{\eta}{\sqrt{\hat{v}_t} + \epsilon} \hat{m}_t\)

\end{itemize}

\end{itemize}

\sphinxAtStartPar
Adam is currently the most widely used optimizer due to its robustness across different architectures and datasets.


\subsection{10.2.3 Learning Rate Schedules}
\label{\detokenize{part3/ch10_deep_learning:learning-rate-schedules}}
\sphinxAtStartPar
Learning rate scheduling can significantly improve training outcomes:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learning\PYGZus{}rate\PYGZus{}schedules}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize common learning rate schedules.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{101}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Constant}
    \PYG{n}{constant\PYGZus{}lr} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Step decay}
    \PYG{n}{step\PYGZus{}lr} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*}\PYG{o}{*} \PYG{p}{(}\PYG{n}{e} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{)} \PYG{k}{for} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n}{epochs}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Exponential decay}
    \PYG{n}{exp\PYGZus{}lr} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.03} \PYG{o}{*} \PYG{n}{e}\PYG{p}{)} \PYG{k}{for} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n}{epochs}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Cosine annealing}
    \PYG{n}{cosine\PYGZus{}lr} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{e} \PYG{o}{/} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2} \PYG{k}{for} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n}{epochs}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Linear warmup + cosine decay}
    \PYG{n}{warmup} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{warmup\PYGZus{}cosine\PYGZus{}lr} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n}{epochs}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{e} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{warmup}\PYG{p}{:}
            \PYG{n}{lr} \PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{e} \PYG{o}{/} \PYG{n}{warmup}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{lr} \PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{p}{(}\PYG{n}{e} \PYG{o}{\PYGZhy{}} \PYG{n}{warmup}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{100} \PYG{o}{\PYGZhy{}} \PYG{n}{warmup}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}
        \PYG{n}{warmup\PYGZus{}cosine\PYGZus{}lr}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{lr}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{constant\PYGZus{}lr}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Constant}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{step\PYGZus{}lr}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Step Decay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{exp\PYGZus{}lr}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Exponential Decay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{cosine\PYGZus{}lr}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cosine Annealing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{warmup\PYGZus{}cosine\PYGZus{}lr}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Warmup + Cosine}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Rate Schedules}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yscale}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Popular learning rate schedules include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Step Decay}: Reduces learning rate by a factor after a set number of epochs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Exponential Decay}: Continuously decreases learning rate using an exponential function

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cosine Annealing}: Smoothly decreases learning rate following a cosine curve

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cyclic Learning Rates}: Cycles between lower and upper learning rate bounds

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{One\sphinxhyphen{}Cycle Policy}: Increases learning rate to a maximum, then decreases it

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Warmup + Decay}: Gradually increases learning rate during initial epochs, then decays

\end{itemize}


\subsection{10.2.4 Second\sphinxhyphen{}order Methods}
\label{\detokenize{part3/ch10_deep_learning:second-order-methods}}
\sphinxAtStartPar
While first\sphinxhyphen{}order methods like SGD use only gradient information, second\sphinxhyphen{}order methods incorporate curvature information:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{second\PYGZus{}order\PYGZus{}methods}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare first and second\PYGZhy{}order optimization methods.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate a 2D quadratic function with conditioning issues}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.01} \PYG{o}{*} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{y}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{grad\PYGZus{}f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.02} \PYG{o}{*} \PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{y}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{hessian\PYGZus{}f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Starting point}
    \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0} \PYG{o}{=} \PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{l+m+mf}{2.0}
    
    \PYG{c+c1}{\PYGZsh{} SGD trajectory}
    \PYG{n}{sgd\PYGZus{}path} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{]}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}
    \PYG{n}{lr} \PYG{o}{=} \PYG{l+m+mf}{0.1}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{g} \PYG{o}{=} \PYG{n}{grad\PYGZus{}f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{lr} \PYG{o}{*} \PYG{n}{g}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{y} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{lr} \PYG{o}{*} \PYG{n}{g}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{sgd\PYGZus{}path}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Newton\PYGZsq{}s method trajectory}
    \PYG{n}{newton\PYGZus{}path} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{]}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Usually converges in fewer steps}
        \PYG{n}{g} \PYG{o}{=} \PYG{n}{grad\PYGZus{}f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        \PYG{n}{H} \PYG{o}{=} \PYG{n}{hessian\PYGZus{}f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        \PYG{n}{H\PYGZus{}inv} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{inv}\PYG{p}{(}\PYG{n}{H}\PYG{p}{)}
        \PYG{n}{update} \PYG{o}{=} \PYG{n}{H\PYGZus{}inv} \PYG{o}{@} \PYG{n}{g}
        \PYG{n}{x} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{update}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{y} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{update}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{newton\PYGZus{}path}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{x\PYGZus{}range} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}range} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{x\PYGZus{}range}\PYG{p}{,} \PYG{n}{y\PYGZus{}range}\PYG{p}{)}
    \PYG{n}{Z} \PYG{o}{=} \PYG{n}{f}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Contour plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{contour}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot paths}
    \PYG{n}{sgd\PYGZus{}path} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{sgd\PYGZus{}path}\PYG{p}{)}
    \PYG{n}{newton\PYGZus{}path} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{newton\PYGZus{}path}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sgd\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sgd\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r.\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SGD}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{newton\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{newton\PYGZus{}path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b.\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Newton}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s Method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Comparison of First\PYGZhy{}Order vs. Second\PYGZhy{}Order Methods}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Second\sphinxhyphen{}order methods include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Newton’s Method}: Uses the Hessian matrix (second derivatives) for updates
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(\theta_{t+1} = \theta_t - H^{-1}(\theta_t) \nabla_\theta J(\theta_t)\)

\item {} 
\sphinxAtStartPar
Pros: Fast convergence near optimum

\item {} 
\sphinxAtStartPar
Cons: Expensive Hessian computation and inversion

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Quasi\sphinxhyphen{}Newton Methods} (e.g., BFGS, L\sphinxhyphen{}BFGS): Approximate the Hessian
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Faster than Newton’s method

\item {} 
\sphinxAtStartPar
Cons: Still too expensive for large neural networks

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Natural Gradient Descent}: Uses the Fisher information matrix
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Invariant to reparameterization

\item {} 
\sphinxAtStartPar
Cons: Computation and storage requirements

\end{itemize}

\end{itemize}

\sphinxAtStartPar
While second\sphinxhyphen{}order methods offer theoretical advantages, their computational requirements generally make them impractical for deep learning. However, approximations like K\sphinxhyphen{}FAC (Kronecker\sphinxhyphen{}Factored Approximate Curvature) are being explored to make second\sphinxhyphen{}order information more accessible.


\section{10.3 Regularization Strategies}
\label{\detokenize{part3/ch10_deep_learning:regularization-strategies}}
\sphinxAtStartPar
Regularization helps prevent overfitting by constraining the model’s capacity or adding noise to the training process.

\sphinxAtStartPar
\sphinxincludegraphics{{regularization_techniques}.svg}
\sphinxstyleemphasis{Figure 10.3: Common regularization methods in deep learning, including dropout, weight decay (L2), batch normalization, data augmentation, early stopping, and label smoothing.}


\subsection{10.3.1 Dropout and Batch Normalization}
\label{\detokenize{part3/ch10_deep_learning:dropout-and-batch-normalization}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{dropout\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Implement and visualize dropout.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    
    \PYG{c+c1}{\PYGZsh{} Define a model with dropout}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MLPWithDropout}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{dropout\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{784}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout\PYGZus{}rate}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout\PYGZus{}rate}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{x}
    
    \PYG{c+c1}{\PYGZsh{} Create a toy example for visualization}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{MLPWithDropout}\PYG{p}{(}\PYG{n}{dropout\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate random activations for demonstration}
    \PYG{n}{activations} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply dropout with different rates}
    \PYG{n}{dropout\PYGZus{}rates} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{]}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{rate} \PYG{o+ow}{in} \PYG{n}{dropout\PYGZus{}rates}\PYG{p}{:}
        \PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Set model to training mode}
        \PYG{n}{dropout}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Apply dropout}
        \PYG{n}{dropped\PYGZus{}activations} \PYG{o}{=} \PYG{n}{dropout}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{)}
        \PYG{n}{results}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{dropped\PYGZus{}activations}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{dropout\PYGZus{}rates}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{acts}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{results}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,} \PYG{n}{acts}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{50}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Show first 50 units}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dropout Rate: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rate}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Account for scaling during training}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{batch\PYGZus{}norm\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate batch normalization effect.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    
    \PYG{c+c1}{\PYGZsh{} Create random activations}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Poorly scaled/shifted activations}
    \PYG{n}{activations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{+} \PYG{l+m+mi}{5}
    
    \PYG{c+c1}{\PYGZsh{} Apply batch normalization}
    \PYG{n}{bn} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{BatchNorm1d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{)}
    \PYG{n}{normalized} \PYG{o}{=} \PYG{n}{bn}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{normalized} \PYG{o}{=} \PYG{n}{normalized}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot raw activation distribution}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Show first 5 features}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Before Batch Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot normalized activation distribution}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{normalized}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{After Batch Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Dropout} stochastically zeroes activations during training, forcing the network to learn redundant representations:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
During training: Each neuron is kept with probability \sphinxcode{\sphinxupquote{p}} (typically 0.5 to 0.8)

\item {} 
\sphinxAtStartPar
During inference: All neurons are used, but outputs are scaled by \sphinxcode{\sphinxupquote{p}}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Batch Normalization} normalizes activations within a mini\sphinxhyphen{}batch, making training more stable:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Normalize: \(\hat{x}_i = \frac{x_i - \mu_B}{\sqrt{\sigma_B^2 + \epsilon}}\)

\item {} 
\sphinxAtStartPar
Scale and shift: \(y_i = \gamma \hat{x}_i + \beta\)

\end{enumerate}

\sphinxAtStartPar
Benefits include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Reduced internal covariate shift

\item {} 
\sphinxAtStartPar
Improved gradient flow

\item {} 
\sphinxAtStartPar
Regularization effect

\item {} 
\sphinxAtStartPar
Reduced sensitivity to initialization

\end{itemize}


\subsection{10.3.2 Weight Decay and Early Stopping}
\label{\detokenize{part3/ch10_deep_learning:weight-decay-and-early-stopping}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{weight\PYGZus{}decay\PYGZus{}visualization}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the effect of weight decay on model complexity.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Ridge}
    
    \PYG{c+c1}{\PYGZsh{} Generate synthetic data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{6} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Fit with different regularization strengths}
    \PYG{n}{alphas} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{]}
    \PYG{n}{degrees} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} polynomial degree}
    
    \PYG{n}{X\PYGZus{}plot} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{alpha} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{alphas}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create polynomial features}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PolynomialFeatures}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{pipeline}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{make\PYGZus{}pipeline}
        
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{make\PYGZus{}pipeline}\PYG{p}{(}
            \PYG{n}{PolynomialFeatures}\PYG{p}{(}\PYG{n}{degrees}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{Ridge}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        \PYG{n}{y\PYGZus{}plot} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}plot}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{alphas}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{navy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Training data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{X\PYGZus{}plot}\PYG{p}{,} \PYG{n}{y\PYGZus{}plot}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{X\PYGZus{}plot}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{X\PYGZus{}plot}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{True function}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Weight Decay (L2): α = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{alpha}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}early\PYGZus{}stopping}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize early stopping based on validation performance.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simulate training and validation losses}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{101}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loss (continues to decrease)}
    \PYG{n}{train\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{epochs} \PYG{o}{+} \PYG{l+m+mf}{1.0}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.1}
    
    \PYG{c+c1}{\PYGZsh{} Validation loss (starts increasing after a while)}
    \PYG{n}{val\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{epochs} \PYG{o}{+} \PYG{l+m+mf}{1.0}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{+} \PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{epochs} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{40}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{60}
    
    \PYG{c+c1}{\PYGZsh{} Add noise}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{val\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.03}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Determine early stopping point}
    \PYG{n}{patience} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{best\PYGZus{}val\PYGZus{}loss} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{best\PYGZus{}epoch} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{n}{stop\PYGZus{}epoch} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{loss} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{val\PYGZus{}loss}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{loss} \PYG{o}{\PYGZlt{}} \PYG{n}{best\PYGZus{}val\PYGZus{}loss}\PYG{p}{:}
            \PYG{n}{best\PYGZus{}val\PYGZus{}loss} \PYG{o}{=} \PYG{n}{loss}
            \PYG{n}{best\PYGZus{}epoch} \PYG{o}{=} \PYG{n}{i}
        \PYG{k}{elif} \PYG{n}{i} \PYG{o}{\PYGZgt{}} \PYG{n}{best\PYGZus{}epoch} \PYG{o}{+} \PYG{n}{patience}\PYG{p}{:}
            \PYG{n}{stop\PYGZus{}epoch} \PYG{o}{=} \PYG{n}{i}
            \PYG{k}{break}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{train\PYGZus{}loss}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{,} \PYG{n}{val\PYGZus{}loss}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Validation Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark early stopping point}
    \PYG{k}{if} \PYG{n}{stop\PYGZus{}epoch} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{stop\PYGZus{}epoch}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Early Stopping (Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{stop\PYGZus{}epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark best validation point}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{best\PYGZus{}epoch}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{m}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Best Validation (Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{best\PYGZus{}epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epochs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Early Stopping Based on Validation Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstylestrong{Weight Decay} (L2 regularization) adds a penalty term to the loss function proportional to the squared weights:

\sphinxAtStartPar
\(L_{reg} = L_{original} + \lambda \sum_i w_i^2\)

\sphinxAtStartPar
This encourages the model to use smaller weights, reducing model complexity and preventing overfitting.

\sphinxAtStartPar
\sphinxstylestrong{Early Stopping} halts training when performance on a validation set stops improving:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Monitor validation performance at regular intervals

\item {} 
\sphinxAtStartPar
Save the model when it achieves the best validation performance

\item {} 
\sphinxAtStartPar
Stop training after a predefined number of epochs without improvement (patience)

\item {} 
\sphinxAtStartPar
Restore the best model from the saved checkpoint

\end{enumerate}

\sphinxAtStartPar
Early stopping effectively limits the model’s capacity by restricting the number of optimization steps.


\subsection{10.3.3 Data Augmentation}
\label{\detokenize{part3/ch10_deep_learning:data-augmentation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{data\PYGZus{}augmentation\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate common data augmentation techniques.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{PIL}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Image}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{transforms}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{transforms}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{transforms}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{TF}
        
        \PYG{c+c1}{\PYGZsh{} Create a sample image (a simple placeholder)}
        \PYG{n}{img} \PYG{o}{=} \PYG{n}{Image}\PYG{o}{.}\PYG{n}{new}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RGB}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{300}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{73}\PYG{p}{,} \PYG{l+m+mi}{109}\PYG{p}{,} \PYG{l+m+mi}{137}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Define augmentations}
        \PYG{n}{augmentations} \PYG{o}{=} \PYG{p}{[}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Horizontal Flip}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{TF}\PYG{o}{.}\PYG{n}{hflip}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Rotation (30°)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{TF}\PYG{o}{.}\PYG{n}{rotate}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Random Crop}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{TF}\PYG{o}{.}\PYG{n}{crop}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{150}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Color Jitter}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ColorJitter}\PYG{p}{(}\PYG{n}{brightness}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{contrast}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{saturation}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Random Erasing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{RandomErasing}\PYG{p}{(}\PYG{n}{p}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{scale}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{(}\PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ToTensor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Apply and visualize}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{axes} \PYG{o}{=} \PYG{n}{axes}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{aug\PYGZus{}fn}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{augmentations}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Random Erasing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Special case for random erasing which expects a tensor}
                \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{aug\PYGZus{}fn}\PYG{o}{.}\PYG{n}{permute}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{aug\PYGZus{}fn}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}
            \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{fig}
    
    \PYG{k}{except} \PYG{n+ne}{ImportError}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} If PIL or torchvision not available, return a text figure}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Data Augmentation Techniques:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Horizontal/Vertical Flips}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Random Rotations}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Random Crops}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Color Jitter (brightness, contrast, saturation)}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Random Erasing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Cutout/CutMix/MixUp}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
               \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Elastic Transformations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
               \PYG{n}{horizontalalignment}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
               \PYG{n}{verticalalignment}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
               \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Data augmentation artificially increases the size of the training set by applying transformations to the original data:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Image Augmentations}: Flips, rotations, crops, color adjustments, random erasing

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Advanced Techniques}: Mixup (blend images and labels), CutMix (patch replacement), AugMix (augmentation chains)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Text Augmentations}: Synonym replacement, word insertion/deletion, back\sphinxhyphen{}translation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Audio Augmentations}: Time stretching, pitch shifting, noise addition, spectrogram masking

\end{itemize}

\sphinxAtStartPar
Benefits include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Improved generalization

\item {} 
\sphinxAtStartPar
Robustness to variations

\item {} 
\sphinxAtStartPar
Reduced overfitting

\item {} 
\sphinxAtStartPar
Better class balance

\end{itemize}


\subsection{10.3.4 Label Smoothing}
\label{\detokenize{part3/ch10_deep_learning:label-smoothing}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{label\PYGZus{}smoothing\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate the effect of label smoothing on model confidence.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Calculate softmax probabilities}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{softmax}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{e\PYGZus{}x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{e\PYGZus{}x} \PYG{o}{/} \PYG{n}{e\PYGZus{}x}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss functions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{cross\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{probs}\PYG{p}{,} \PYG{n}{label}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Cross entropy with optional label smoothing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}classes} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{probs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create one\PYGZhy{}hot encoding}
        \PYG{n}{targets} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{probs}\PYG{p}{)}
        \PYG{n}{targets}\PYG{p}{[}\PYG{n}{label}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        
        \PYG{k}{if} \PYG{n}{epsilon} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Apply label smoothing}
            \PYG{n}{targets} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{epsilon}\PYG{p}{)} \PYG{o}{*} \PYG{n}{targets} \PYG{o}{+} \PYG{n}{epsilon} \PYG{o}{/} \PYG{n}{n\PYGZus{}classes}
        
        \PYG{c+c1}{\PYGZsh{} Compute loss}
        \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{targets} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{probs} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}9}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate some logits}
    \PYG{n}{logits\PYGZus{}correct} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Strongly predicting class 0 (correct)}
    \PYG{n}{logits\PYGZus{}wrong} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{]}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} Strongly predicting class 1 (wrong)}
    
    \PYG{n}{probs\PYGZus{}correct} \PYG{o}{=} \PYG{n}{softmax}\PYG{p}{(}\PYG{n}{logits\PYGZus{}correct}\PYG{p}{)}
    \PYG{n}{probs\PYGZus{}wrong} \PYG{o}{=} \PYG{n}{softmax}\PYG{p}{(}\PYG{n}{logits\PYGZus{}wrong}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Class 0 is the true label}
    \PYG{n}{true\PYGZus{}label} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{c+c1}{\PYGZsh{} Compare losses with and without label smoothing}
    \PYG{n}{smoothing\PYGZus{}values} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{]}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{epsilon} \PYG{o+ow}{in} \PYG{n}{smoothing\PYGZus{}values}\PYG{p}{:}
        \PYG{n}{loss\PYGZus{}correct} \PYG{o}{=} \PYG{n}{cross\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{probs\PYGZus{}correct}\PYG{p}{,} \PYG{n}{true\PYGZus{}label}\PYG{p}{,} \PYG{n}{epsilon}\PYG{p}{)}
        \PYG{n}{loss\PYGZus{}wrong} \PYG{o}{=} \PYG{n}{cross\PYGZus{}entropy}\PYG{p}{(}\PYG{n}{probs\PYGZus{}wrong}\PYG{p}{,} \PYG{n}{true\PYGZus{}label}\PYG{p}{,} \PYG{n}{epsilon}\PYG{p}{)}
        
        \PYG{n}{results}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{epsilon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{epsilon}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss\PYGZus{}correct}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{loss\PYGZus{}correct}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss\PYGZus{}wrong}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{loss\PYGZus{}wrong}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ratio}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{loss\PYGZus{}wrong} \PYG{o}{/} \PYG{n}{loss\PYGZus{}correct}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create comparison plot}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot probabilities}
    \PYG{n}{bar\PYGZus{}positions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{bar\PYGZus{}positions} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{probs\PYGZus{}correct}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correct Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{bar\PYGZus{}positions} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{probs\PYGZus{}wrong}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Incorrect Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{bar\PYGZus{}positions}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Probability}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Predictions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot loss comparisons}
    \PYG{n}{eps\PYGZus{}values} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{epsilon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{results}\PYG{p}{]}
    \PYG{n}{correct\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss\PYGZus{}correct}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{results}\PYG{p}{]}
    \PYG{n}{wrong\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss\PYGZus{}wrong}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{results}\PYG{p}{]}
    \PYG{n}{ratios} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ratio}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{results}\PYG{p}{]}
    
    \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{eps\PYGZus{}values}\PYG{p}{,} \PYG{n}{correct\PYGZus{}losses}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}o}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss (Correct)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{eps\PYGZus{}values}\PYG{p}{,} \PYG{n}{wrong\PYGZus{}losses}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}o}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss (Incorrect)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Label Smoothing (ε)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Effect of Label Smoothing on Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{upper left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{ax2} \PYG{o}{=} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{twinx}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{eps\PYGZus{}values}\PYG{p}{,} \PYG{n}{ratios}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}\PYGZhy{}s}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss Ratio (Wrong/Correct)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss Ratio}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelcolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{upper right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Label smoothing replaces one\sphinxhyphen{}hot encoded targets with “soft” targets:

\sphinxAtStartPar
\(y_i = \begin{cases} 
1 - \epsilon + \epsilon/K & \text{if } i = \text{true class} \\
\epsilon/K & \text{otherwise}
\end{cases}\)

\sphinxAtStartPar
where \(\epsilon\) is the smoothing parameter and \(K\) is the number of classes.

\sphinxAtStartPar
Benefits include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Prevents overconfidence

\item {} 
\sphinxAtStartPar
Improves generalization

\item {} 
\sphinxAtStartPar
Provides regularization

\item {} 
\sphinxAtStartPar
Aligns better with inherent data ambiguity

\end{itemize}


\section{10.4 Advanced Architectures}
\label{\detokenize{part3/ch10_deep_learning:advanced-architectures}}
\sphinxAtStartPar
Modern deep learning has evolved sophisticated architectures for different domains.

\sphinxAtStartPar
\sphinxincludegraphics{{advanced_architectures}.svg}
\sphinxstyleemphasis{Figure 10.4: Key architectural patterns in modern deep learning, including CNNs, ResNets, Inception modules, and Transformer blocks, each addressing specific model design challenges.}


\subsection{10.4.1 Convolutional Neural Networks}
\label{\detokenize{part3/ch10_deep_learning:convolutional-neural-networks}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}cnn\PYGZus{}architecture}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize a basic CNN architecture.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define architecture components}
    \PYG{n}{components} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conv 3×3}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{64 filters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conv 3×3}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{128 filters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MaxPool}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{2×2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.55}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.07}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Flatten}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{(8192,)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.67}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dense}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{512 units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{(512,)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.77}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.08}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dense}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{10 units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{(10,)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Draw boxes}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{comp} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{components}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{color} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{components}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{height} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{0.2} \PYG{o}{+} \PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Draw component box}
        \PYG{n}{rect} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}
            \PYG{p}{(}\PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.5} \PYG{o}{\PYGZhy{}} \PYG{n}{height}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} 
            \PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} 
            \PYG{n}{facecolor}\PYG{o}{=}\PYG{n}{color}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add labels}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{name}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} 
                \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mf}{0.5} \PYG{o}{\PYGZhy{}} \PYG{n}{height}\PYG{o}{/}\PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} 
                \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{top}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add connecting arrows}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{prev} \PYG{o}{=} \PYG{n}{components}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                        \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{n}{comp}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
                        \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{n}{prev}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n}{prev}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
                        \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}|\PYGZgt{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Label axes}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Convolutional Neural Network Architecture}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
            \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set limits}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
CNNs use specialized layers designed for processing grid\sphinxhyphen{}like data (e.g., images):
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Convolutional Layers}: Apply filters to detect local patterns
\begin{itemize}
\item {} 
\sphinxAtStartPar
Parameters: filter size, stride, padding, dilation

\item {} 
\sphinxAtStartPar
Properties: weight sharing, translation invariance

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pooling Layers}: Downsample feature maps
\begin{itemize}
\item {} 
\sphinxAtStartPar
Types: max pooling, average pooling, global pooling

\item {} 
\sphinxAtStartPar
Purpose: Reduce dimensions, introduce invariance

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Hierarchy}: Early layers detect edges and textures; later layers detect complex shapes and objects

\end{itemize}

\sphinxAtStartPar
Notable CNN architectures include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{LeNet\sphinxhyphen{}5}: First successful CNN architecture

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AlexNet}: Breakthrough in image classification (2012)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{VGG}: Standardized architecture with small filters

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Inception/GoogLeNet}: Parallel filter operations at different scales

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ResNet}: Introduced residual connections, enabling extremely deep networks

\end{itemize}


\subsection{10.4.2 Residual Networks}
\label{\detokenize{part3/ch10_deep_learning:residual-networks}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}residual\PYGZus{}block}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize a residual block from ResNet.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw main path}
    \PYG{c+c1}{\PYGZsh{} Input}
    \PYG{n}{rect\PYGZus{}input} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}input}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.85}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Conv 1}
    \PYG{n}{rect\PYGZus{}conv1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}conv1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conv 3×3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Batch Norm 1}
    \PYG{n}{rect\PYGZus{}bn1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightyellow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}bn1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.575}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BatchNorm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} ReLU 1}
    \PYG{n}{rect\PYGZus{}relu1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightpink}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}relu1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.525}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ReLU}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Conv 2}
    \PYG{n}{rect\PYGZus{}conv2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.35}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}conv2}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conv 3×3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Batch Norm 2}
    \PYG{n}{rect\PYGZus{}bn2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightyellow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}bn2}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.275}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BatchNorm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Addition}
    \PYG{n}{circle\PYGZus{}add} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle\PYGZus{}add}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{+}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Output}
    \PYG{n}{rect\PYGZus{}output} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}output}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.075}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} ReLU (final)}
    \PYG{n}{rect\PYGZus{}relu2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightpink}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect\PYGZus{}relu2}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.025}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ReLU}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw shortcut path}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.45}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shortcut Connection}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw arrows}
    \PYG{n}{arrow\PYGZus{}props} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{1.5}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.35}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{,} \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n}{arrow\PYGZus{}props}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Title}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ResNet Block}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set limits}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Residual Networks (ResNets) introduced skip connections to address the degradation problem in very deep networks:

\sphinxAtStartPar
\(\mathbf{y} = F(\mathbf{x}, \{W_i\}) + \mathbf{x}\)

\sphinxAtStartPar
where \(F\) represents the residual mapping and \(\mathbf{x}\) is the identity shortcut connection.

\sphinxAtStartPar
Benefits include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Easier optimization (shortcuts provide gradient highways)

\item {} 
\sphinxAtStartPar
Better gradient flow in very deep networks

\item {} 
\sphinxAtStartPar
Stabilized training

\item {} 
\sphinxAtStartPar
State\sphinxhyphen{}of\sphinxhyphen{}the\sphinxhyphen{}art performance on many tasks

\end{itemize}

\sphinxAtStartPar
Variants of residual connections include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pre\sphinxhyphen{}activation ResNet}: Improved ordering of batch normalization and activation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ResNeXt}: Grouped convolutions for increased width

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{DenseNet}: Dense connections between all layers in a block

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{EfficientNet}: Balanced network depth, width, and resolution scaling

\end{itemize}


\subsection{10.4.3 Normalization Techniques}
\label{\detokenize{part3/ch10_deep_learning:normalization-techniques}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}normalizations}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize differences between normalization techniques.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create toy feature maps (B, C, H, W)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{4}
    \PYG{n}{channels} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{n}{height} \PYG{o}{=} \PYG{l+m+mi}{4}
    \PYG{n}{width} \PYG{o}{=} \PYG{l+m+mi}{4}
    
    \PYG{c+c1}{\PYGZsh{} Create feature maps with different distributions per channel}
    \PYG{n}{features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 0: Normal distribution with mean 10, std 5}
    \PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 1: Normal distribution with mean 0, std 1}
    \PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 2: Normal distribution with mean \PYGZhy{}5, std 3}
    \PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{width}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply different normalizations (simplified implementations)}
    
    \PYG{c+c1}{\PYGZsh{} Batch Normalization (normalize across batch, per channel)}
    \PYG{n}{batch\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{batch\PYGZus{}norm}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Layer Normalization (normalize across channels, per sample)}
    \PYG{n}{layer\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{b} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{layer\PYGZus{}norm}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Instance Normalization (normalize across spatial dims, per sample and channel)}
    \PYG{n}{instance\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{b} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{instance\PYGZus{}norm}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Group Normalization (normalize across spatial dims and channel groups, per sample)}
    \PYG{n}{group\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} 1 group with 3 channels for this example}
    \PYG{n}{group\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{b} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{g} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{,} \PYG{n}{group\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{g}\PYG{p}{:}\PYG{n}{g}\PYG{o}{+}\PYG{n}{group\PYGZus{}size}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{std} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{g}\PYG{p}{:}\PYG{n}{g}\PYG{o}{+}\PYG{n}{group\PYGZus{}size}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{group\PYGZus{}norm}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{g}\PYG{p}{:}\PYG{n}{g}\PYG{o}{+}\PYG{n}{group\PYGZus{}size}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{features}\PYG{p}{[}\PYG{n}{b}\PYG{p}{,} \PYG{n}{g}\PYG{p}{:}\PYG{n}{g}\PYG{o}{+}\PYG{n}{group\PYGZus{}size}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{std} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create visualizations}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Helper function to visualize feature map distributions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{title}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{flat\PYGZus{}data\PYGZus{}by\PYGZus{}channel} \PYG{o}{=} \PYG{p}{[}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{)}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{c}\PYG{p}{,} \PYG{n}{channel\PYGZus{}data} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{flat\PYGZus{}data\PYGZus{}by\PYGZus{}channel}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{channel\PYGZus{}data}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Channel }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{n}{title}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot distributions}
    \PYG{n}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{features}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original Features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{batch\PYGZus{}norm}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Batch Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{layer\PYGZus{}norm}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Layer Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{instance\PYGZus{}norm}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Instance Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}distributions}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{group\PYGZus{}norm}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Group Normalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Diagram of normalization dimensions}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Normalization Dimensions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.75}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{BatchNorm: Normalize across (N, H, W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LayerNorm: Normalize across (C, H, W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{InstanceNorm: Normalize across (H, W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.45}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{GroupNorm: Normalize across (G, H, W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{N: Batch size, C: Channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H: Height, W: Width, G: Group}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Different normalization techniques stabilize training by normalizing activations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Batch Normalization}: Normalizes across the batch dimension
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Very effective, improves training speed

\item {} 
\sphinxAtStartPar
Cons: Batch size dependent, less effective with small batches

\item {} 
\sphinxAtStartPar
\(\hat{x}_i = \frac{x_i - \mu_B}{\sqrt{\sigma_B^2 + \epsilon}}\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Layer Normalization}: Normalizes across all features for each sample
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Batch size independent, good for recurrent networks

\item {} 
\sphinxAtStartPar
Cons: May not work well for CNNs

\item {} 
\sphinxAtStartPar
\(\hat{x}_i = \frac{x_i - \mu_L}{\sqrt{\sigma_L^2 + \epsilon}}\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Instance Normalization}: Normalizes across spatial dimensions for each channel and sample
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Effective for style transfer, independent of batch size

\item {} 
\sphinxAtStartPar
Cons: Loses statistical information about the dataset

\item {} 
\sphinxAtStartPar
\(\hat{x}_{ijk} = \frac{x_{ijk} - \mu_{ij}}{\sqrt{\sigma_{ij}^2 + \epsilon}}\)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Group Normalization}: Normalizes across groups of channels
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pros: Batch size independent, works well for smaller batches

\item {} 
\sphinxAtStartPar
Cons: Group size is a hyperparameter to tune

\item {} 
\sphinxAtStartPar
\(\hat{x}_{ijg} = \frac{x_{ijg} - \mu_{ig}}{\sqrt{\sigma_{ig}^2 + \epsilon}}\)

\end{itemize}

\end{itemize}

\sphinxAtStartPar
Choosing the right normalization technique depends on the architecture, task, and computational constraints.


\subsection{10.4.4 Activation Functions}
\label{\detokenize{part3/ch10_deep_learning:id1}}
\sphinxAtStartPar
Modern activation functions improve on traditional ones like sigmoid and tanh:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ReLU}: Most common, but suffers from dying neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Leaky ReLU}: Prevents dying neurons with a small slope for negative inputs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parametric ReLU (PReLU)}: Learns the slope parameter during training

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ELU (Exponential Linear Unit)}: Smooth negative values with an exponential curve

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{GELU (Gaussian Error Linear Unit)}: Used in transformers, approximates \(x \cdot \Phi(x)\)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Swish/SiLU}: Self\sphinxhyphen{}gated activation \(x \cdot \sigma(x)\), often outperforms ReLU

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mish}: Smooth alternative to Swish with better performance

\end{itemize}


\section{10.5 Biological Parallels in Deep Learning}
\label{\detokenize{part3/ch10_deep_learning:biological-parallels-in-deep-learning}}
\sphinxAtStartPar
Deep learning draws significant inspiration from neuroscience, though the connections are often overlooked in technical discussions. This section explores the parallels between neural networks and biological neural systems.

\sphinxAtStartPar
\sphinxincludegraphics{{bio_dl_parallels}.svg}
\sphinxstyleemphasis{Figure 10.5: Comparison of biological and artificial neurons, highlighting similarities and differences in structure and learning mechanisms.}


\subsection{10.5.1 Neural Architectures and Brain Organization}
\label{\detokenize{part3/ch10_deep_learning:neural-architectures-and-brain-organization}}
\sphinxAtStartPar
While artificial neural networks are highly simplified compared to biological neurons, several architectural principles are shared:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}: Both biological visual systems and CNNs process information in a hierarchical manner, with early layers detecting simple features and deeper layers representing more complex patterns.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Recurrent Connections}: Recurrent neural networks parallel the recurrent connectivity in cortical circuits, allowing for temporal processing and memory.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Attention Mechanisms}: Neural attention mechanisms are inspired by biological attention systems that selectively focus computational resources on relevant input features.

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{biological\PYGZus{}vs\PYGZus{}artificial\PYGZus{}neurons}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare biological and artificial neurons.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a simple diagram}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Biological neuron (simplified)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biological Neuron}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dendrites}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Soma}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Axon}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Synapses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw simplified neuron}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Dendrite}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.35}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Dendrite}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Dendrite}
    \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Soma}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Axon}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Synapse}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Synapse}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Synapse}
    
    \PYG{c+c1}{\PYGZsh{} Artificial neuron}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Artificial Neuron}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x₁}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{x₂}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{xₙ}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{w₁}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{w₂}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wₙ}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Bias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{∑}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{18}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{σ}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw artificial neuron}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Input 1}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Input 2}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Input n}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} ...}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Input n connection}
    \PYG{n}{circle1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Summation}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.55}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} To activation}
    \PYG{n}{circle2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Activation}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.75}\PYG{p}{,} \PYG{l+m+mf}{0.85}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Output}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}


\subsection{10.5.2 Learning Mechanisms}
\label{\detokenize{part3/ch10_deep_learning:learning-mechanisms}}
\sphinxAtStartPar
The brain employs various learning mechanisms that have counterparts in deep learning:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hebbian Learning vs. Backpropagation}: Hebbian learning (“neurons that fire together, wire together”) is a local learning rule, while backpropagation propagates errors globally. Recent research explores biologically plausible alternatives to backpropagation, such as target propagation and feedback alignment.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromodulation vs. Adaptive Learning Rates}: Neuromodulatory systems in the brain (dopamine, acetylcholine, etc.) regulate plasticity and learning, similar to how adaptive learning rate methods (Adam, RMSProp) modulate weight updates.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Homeostatic Plasticity vs. Regularization}: The brain employs homeostatic mechanisms to maintain stability, paralleling regularization techniques like weight decay and normalization in artificial networks.

\end{itemize}


\subsection{10.5.3 Credit Assignment Problem}
\label{\detokenize{part3/ch10_deep_learning:credit-assignment-problem}}
\sphinxAtStartPar
Both biological and artificial systems face the fundamental problem of credit assignment: determining which components contributed to an outcome.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{credit\PYGZus{}assignment\PYGZus{}comparison}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare credit assignment in biological and artificial systems.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Biological credit assignment}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biological Credit Assignment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple network diagram}
    \PYG{n}{pos} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{,}
           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Draw nodes}
    \PYG{k}{for} \PYG{n}{node}\PYG{p}{,} \PYG{n}{position} \PYG{o+ow}{in} \PYG{n}{pos}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{n}{position}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} 
                         \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{node} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{position}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{node}\PYG{p}{,} 
                 \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw edges}
    \PYG{n}{edges} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} 
             \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} 
             \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
             \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{edge} \PYG{o+ow}{in} \PYG{n}{edges}\PYG{p}{:}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight local feedback paths}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add text explanation}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Relies on local feedback signals and reward modulation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Artificial credit assignment}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Artificial Credit Assignment (Backpropagation)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Use the same network layout}
    \PYG{k}{for} \PYG{n}{node}\PYG{p}{,} \PYG{n}{position} \PYG{o+ow}{in} \PYG{n}{pos}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{n}{position}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} 
                         \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{node} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{position}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{node}\PYG{p}{,} 
                 \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw forward pass edges}
    \PYG{k}{for} \PYG{n}{edge} \PYG{o+ow}{in} \PYG{n}{edges}\PYG{p}{:}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw backward pass (gradient flow)}
    \PYG{n}{backward\PYGZus{}edges} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                      \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                      \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{G}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                      \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                      \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                      \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{D}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{edge} \PYG{o+ow}{in} \PYG{n}{backward\PYGZus{}edges}\PYG{p}{:}
        \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{p}{[}\PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pos}\PYG{p}{[}\PYG{n}{edge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add text explanation}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Propagates error backwards through entire network}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Backpropagation in artificial neural networks provides a mathematically precise solution to credit assignment but is not biologically plausible due to:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
The need for symmetric weight matrices

\item {} 
\sphinxAtStartPar
Requiring precise storage of forward pass activations

\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}local weight updates

\end{enumerate}

\sphinxAtStartPar
Neuroscience research explores alternatives like:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Three\sphinxhyphen{}factor Hebbian learning}: Combining pre/post\sphinxhyphen{}synaptic activity with a global modulation signal

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive coding}: Using prediction errors to drive learning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feedback alignment}: Using random feedback weights for credit assignment

\end{itemize}


\section{10.6 Modern Deep Learning Paradigms}
\label{\detokenize{part3/ch10_deep_learning:modern-deep-learning-paradigms}}
\sphinxAtStartPar
Deep learning has evolved rapidly in recent years, with several important new paradigms emerging.


\subsection{10.6.1 Self\sphinxhyphen{}Supervised Learning}
\label{\detokenize{part3/ch10_deep_learning:self-supervised-learning}}
\sphinxAtStartPar
Self\sphinxhyphen{}supervised learning has emerged as a powerful paradigm that leverages unlabeled data by creating “pseudo\sphinxhyphen{}labels” from the data itself.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{self\PYGZus{}supervised\PYGZus{}paradigms}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate different self\PYGZhy{}supervised learning approaches.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Masked Language Modeling}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Masked Language Modeling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The [MASK] jumped over the lazy dog.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{↓}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The fox jumped over the lazy dog.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                  \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Contrastive Learning}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Contrastive Learning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Draw an anchor image}
    \PYG{n}{rect1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect1}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.75}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw positive and negative examples}
    \PYG{n}{rect2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect2}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Positive}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{rect3} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightcoral}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect3}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.75}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Negative}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw attraction/repulsion arrows}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} 
                   \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} 
                   \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Autoregressive Prediction}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Autoregressive Prediction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The fox jumped over the}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{↓}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lazy dog.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                  \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Rotation/Colorization}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Image Restoration}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw a grayscale or corrupted image}
    \PYG{n}{rect4} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect4}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Corrupted Input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw arrow}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{→}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw restored image}
    \PYG{n}{rect5} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect5}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.75}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Restored Image}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key self\sphinxhyphen{}supervised paradigms include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Masked Language/Image Modeling}: Predicting masked tokens from surrounding context

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contrastive Learning}: Learning to distinguish between similar and dissimilar examples

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Autoregressive Prediction}: Predicting next elements in a sequence

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data Restoration}: Reconstructing corrupted or modified versions of the input

\end{itemize}

\sphinxAtStartPar
Self\sphinxhyphen{}supervised learning has enabled state\sphinxhyphen{}of\sphinxhyphen{}the\sphinxhyphen{}art results across domains with limited labeled data, and forms the foundation of modern foundation models.


\subsection{10.6.2 Foundation Models and Scaling Laws}
\label{\detokenize{part3/ch10_deep_learning:foundation-models-and-scaling-laws}}
\sphinxAtStartPar
Recent years have witnessed the emergence of foundation models: large\sphinxhyphen{}scale models pre\sphinxhyphen{}trained on vast amounts of data that can be adapted to various downstream tasks.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{scaling\PYGZus{}laws}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize scaling laws in deep learning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Log scales}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xscale}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}yscale}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute data points}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}params} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.3}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Performance improves with model size}
    \PYG{n}{y\PYGZus{}data} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.25}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} Performance improves with data}
    \PYG{n}{y\PYGZus{}compute} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Performance improves with compute}
    
    \PYG{c+c1}{\PYGZsh{} Plot scaling curves}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y\PYGZus{}params}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Size Scaling}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y\PYGZus{}data}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dataset Size Scaling}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y\PYGZus{}compute}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Compute Scaling}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add scaling regimes markers}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Small}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Medium}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{5000}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Large}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Labels}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Scale Factor (log)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss (log)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Scaling Laws in Deep Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Emergent abilities annotation}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Emergent}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Abilities}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{)}\PYG{p}{,}
               \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{which}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{both}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ls}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key insights from scaling research include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictable Scaling Laws}: Model performance improves following power laws with increases in model size, data, and compute.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Emergent Abilities}: Beyond certain scale thresholds, models demonstrate qualitatively new capabilities not present in smaller models.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Transfer Learning Efficiency}: Large pre\sphinxhyphen{}trained models can be efficiently fine\sphinxhyphen{}tuned for downstream tasks with relatively little task\sphinxhyphen{}specific data.

\end{itemize}

\sphinxAtStartPar
Foundation models have transformed deep learning research and applications, with models like:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Large Language Models}: GPT, LLaMA, Claude

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Vision\sphinxhyphen{}Language Models}: CLIP, DALL\sphinxhyphen{}E, Stable Diffusion

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal Models}: GPT\sphinxhyphen{}4, Gemini

\end{itemize}


\subsection{10.6.3 Loss Landscapes}
\label{\detokenize{part3/ch10_deep_learning:loss-landscapes}}
\sphinxAtStartPar
\sphinxincludegraphics{{dl_optimization_landscape}.svg}
\sphinxstyleemphasis{Figure 10.6: Visualization of neural network loss landscape showing the complex optimization surface with local minima, saddle points, and flat regions.}

\sphinxAtStartPar
Loss landscapes in deep networks are complex, high\sphinxhyphen{}dimensional surfaces with many local minima, saddle points, and flat regions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local Minima}: Points where the loss is lower than all nearby points

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Global Minimum}: The lowest possible loss value

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Saddle Points}: Points with zero gradient but not minima (common in high dimensions)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Flat Regions}: Areas with very small gradients that slow training

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sharp Minima}: Minima with high curvature, often associated with poor generalization

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Wide Minima}: Minima with low curvature, often associated with good generalization

\end{itemize}

\sphinxAtStartPar
Recent research suggests that most critical points in deep networks are saddle points rather than local minima, and that finding wide minima leads to better generalization.


\subsection{10.5.2 Generalization Theory}
\label{\detokenize{part3/ch10_deep_learning:generalization-theory}}
\sphinxAtStartPar
Generalization is the ability of a model to perform well on unseen data:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Empirical Risk Minimization}: Minimizing loss on training data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural Risk Minimization}: Balancing empirical risk and model complexity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Regularization}: Constraining model complexity to improve generalization

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{VC Dimension}: Theoretical measure of model capacity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Rademacher Complexity}: Measure of a model’s ability to fit random noise

\end{itemize}

\sphinxAtStartPar
Modern deep learning often violates classical generalization bounds because models can memorize random data yet still generalize well on real data. This paradox has led to new theories:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Flat Minima Hypothesis}: Models that find flat regions of the loss landscape generalize better

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implicit Regularization}: Optimization methods like SGD inherently bias toward simpler solutions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Tangent Kernel}: Connects neural network training to kernel methods in the infinite\sphinxhyphen{}width limit

\end{itemize}


\subsection{10.5.3 Double Descent Phenomenon}
\label{\detokenize{part3/ch10_deep_learning:double-descent-phenomenon}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{double\PYGZus{}descent\PYGZus{}curve}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the double descent phenomenon.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Model complexity (e.g., number of parameters)}
    \PYG{n}{complexity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Critical complexity where model can perfectly fit training data}
    \PYG{n}{critical\PYGZus{}complexity} \PYG{o}{=} \PYG{l+m+mi}{40}
    
    \PYG{c+c1}{\PYGZsh{} Classical U\PYGZhy{}shaped risk curve}
    \PYG{n}{classical\PYGZus{}risk} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n}{complexity} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.02} \PYG{o}{*} \PYG{n}{complexity}
    
    \PYG{c+c1}{\PYGZsh{} Double descent risk curve}
    \PYG{n}{interpolation\PYGZus{}peak} \PYG{o}{=} \PYG{l+m+mf}{5.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{p}{(}\PYG{n}{complexity} \PYG{o}{\PYGZhy{}} \PYG{n}{critical\PYGZus{}complexity}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{modern\PYGZus{}risk} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n}{complexity} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.01} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{complexity}\PYG{p}{)} \PYG{o}{+} \PYG{n}{interpolation\PYGZus{}peak}
    
    \PYG{c+c1}{\PYGZsh{} Training error (decreases monotonically)}
    \PYG{n}{train\PYGZus{}error} \PYG{o}{=} \PYG{l+m+mf}{2.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{n}{complexity} \PYG{o}{\PYGZhy{}} \PYG{n}{critical\PYGZus{}complexity}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{complexity}\PYG{p}{,} \PYG{n}{classical\PYGZus{}risk}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Classical Theory (U\PYGZhy{}shape)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{complexity}\PYG{p}{,} \PYG{n}{modern\PYGZus{}risk}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Modern Observation (Double Descent)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{complexity}\PYG{p}{,} \PYG{n}{train\PYGZus{}error}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Mark interpolation threshold}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{critical\PYGZus{}complexity}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{critical\PYGZus{}complexity} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Interpolation Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Annotate regions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Underfitting}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mf}{1.2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{)}\PYG{p}{,} 
                 \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Interpolation}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Regime}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{n}{critical\PYGZus{}complexity}\PYG{p}{,} \PYG{l+m+mf}{2.5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{n}{critical\PYGZus{}complexity} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mf}{3.5}\PYG{p}{)}\PYG{p}{,} 
                 \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Modern Generalization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{80}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{70}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{,} 
                 \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Complexity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Risk (Test Error)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Double Descent Phenomenon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
The double descent phenomenon challenges the classical bias\sphinxhyphen{}variance tradeoff:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Classical U\sphinxhyphen{}curve}: As model complexity increases, test error first decreases (reducing bias), then increases (increasing variance)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Double Descent}: After the interpolation threshold (where training error reaches zero), test error can \sphinxstyleemphasis{decrease again} with increasing model complexity

\end{enumerate}

\sphinxAtStartPar
This phenomenon helps explain why overparameterized deep networks (with more parameters than training examples) can still generalize well.


\subsection{10.5.4 Neural Tangent Kernel}
\label{\detokenize{part3/ch10_deep_learning:neural-tangent-kernel}}
\sphinxAtStartPar
The Neural Tangent Kernel (NTK) is a theoretical tool for understanding neural network training:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Connects neural networks to kernel methods

\item {} 
\sphinxAtStartPar
Shows that in the infinite\sphinxhyphen{}width limit, neural networks behave like linear models in a fixed feature space

\item {} 
\sphinxAtStartPar
Explains why wide networks train stably and generalize well

\item {} 
\sphinxAtStartPar
Predicts training dynamics of wide networks

\end{itemize}

\sphinxAtStartPar
While primarily theoretical, NTK insights inform network initialization and architecture design.


\section{10.6 Code Lab: Implementing a Neural Network from Scratch}
\label{\detokenize{part3/ch10_deep_learning:code-lab-implementing-a-neural-network-from-scratch}}
\sphinxAtStartPar
Let’s implement a simple neural network without using deep learning frameworks to understand the core concepts better:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}network\PYGZus{}from\PYGZus{}scratch}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Implement a simple neural network from scratch.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Define network architecture}
    \PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{2}
    \PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Generate synthetic data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} True function: XOR\PYGZhy{}like (non\PYGZhy{}linear)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{!=} \PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{X}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize weights and biases}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{init\PYGZus{}params}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
        \PYG{n}{W1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        \PYG{n}{b1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{W2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        \PYG{n}{b2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{W1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{b1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{W2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{b2}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Activation functions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid\PYGZus{}derivative}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{s} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{s} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{s}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Forward pass}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{W1}\PYG{p}{,} \PYG{n}{b1}\PYG{p}{,} \PYG{n}{W2}\PYG{p}{,} \PYG{n}{b2} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Hidden layer}
        \PYG{n}{Z1} \PYG{o}{=} \PYG{n}{X} \PYG{o}{@} \PYG{n}{W1} \PYG{o}{+} \PYG{n}{b1}
        \PYG{n}{A1} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{Z1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output layer}
        \PYG{n}{Z2} \PYG{o}{=} \PYG{n}{A1} \PYG{o}{@} \PYG{n}{W2} \PYG{o}{+} \PYG{n}{b2}
        \PYG{n}{A2} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{Z2}\PYG{p}{)}
        
        \PYG{n}{cache} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{Z1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{A1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{Z2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{A2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{X}\PYG{p}{\PYGZcb{}}
        \PYG{k}{return} \PYG{n}{A2}\PYG{p}{,} \PYG{n}{cache}
    
    \PYG{c+c1}{\PYGZsh{} Compute loss}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}loss}\PYG{p}{(}\PYG{n}{A2}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{m} \PYG{o}{=} \PYG{n}{y}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{loss} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{y} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{A2} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}8}\PYG{p}{)} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{A2} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}8}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{m}
        \PYG{k}{return} \PYG{n}{loss}
    
    \PYG{c+c1}{\PYGZsh{} Backward pass}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{backward}\PYG{p}{(}\PYG{n}{cache}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{m} \PYG{o}{=} \PYG{n}{y}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{W1}\PYG{p}{,} \PYG{n}{W2} \PYG{o}{=} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{A1}\PYG{p}{,} \PYG{n}{A2} \PYG{o}{=} \PYG{n}{cache}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cache}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{X} \PYG{o}{=} \PYG{n}{cache}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Output layer}
        \PYG{n}{dZ2} \PYG{o}{=} \PYG{n}{A2} \PYG{o}{\PYGZhy{}} \PYG{n}{y}
        \PYG{n}{dW2} \PYG{o}{=} \PYG{n}{A1}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{dZ2} \PYG{o}{/} \PYG{n}{m}
        \PYG{n}{db2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{dZ2}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} \PYG{o}{/} \PYG{n}{m}
        
        \PYG{c+c1}{\PYGZsh{} Hidden layer}
        \PYG{n}{dA1} \PYG{o}{=} \PYG{n}{dZ2} \PYG{o}{@} \PYG{n}{W2}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{dZ1} \PYG{o}{=} \PYG{n}{dA1} \PYG{o}{*} \PYG{n}{sigmoid\PYGZus{}derivative}\PYG{p}{(}\PYG{n}{cache}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{dW1} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{dZ1} \PYG{o}{/} \PYG{n}{m}
        \PYG{n}{db1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{dZ1}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} \PYG{o}{/} \PYG{n}{m}
        
        \PYG{n}{gradients} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dW1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{dW1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{db1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{db1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dW2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{dW2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{db2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{db2}\PYG{p}{\PYGZcb{}}
        \PYG{k}{return} \PYG{n}{gradients}
    
    \PYG{c+c1}{\PYGZsh{} Update parameters}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}params}\PYG{p}{(}\PYG{n}{params}\PYG{p}{,} \PYG{n}{gradients}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradients}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dW1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradients}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{db1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradients}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dW2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradients}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{db2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{k}{return} \PYG{n}{params}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{,} \PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Initialize parameters}
        \PYG{n}{params} \PYG{o}{=} \PYG{n}{init\PYGZus{}params}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Track loss}
        \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Training iterations}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{A2}\PYG{p}{,} \PYG{n}{cache} \PYG{o}{=} \PYG{n}{forward}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute loss}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{compute\PYGZus{}loss}\PYG{p}{(}\PYG{n}{A2}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
            \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{loss}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward pass}
            \PYG{n}{gradients} \PYG{o}{=} \PYG{n}{backward}\PYG{p}{(}\PYG{n}{cache}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update parameters}
            \PYG{n}{params} \PYG{o}{=} \PYG{n}{update\PYGZus{}params}\PYG{p}{(}\PYG{n}{params}\PYG{p}{,} \PYG{n}{gradients}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Print loss every 1000 epochs}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{1000} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{params}\PYG{p}{,} \PYG{n}{losses}
    
    \PYG{c+c1}{\PYGZsh{} Train the network}
    \PYG{n}{params}\PYG{p}{,} \PYG{n}{losses} \PYG{o}{=} \PYG{n}{train}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{5000}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the results}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}results}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Visualization of training progress}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Loss curve}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decision boundary}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a mesh grid}
        \PYG{n}{h} \PYG{o}{=} \PYG{l+m+mf}{0.01}
        \PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
        \PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
        \PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}\PYG{p}{,}
                             \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Make predictions on the mesh grid}
        \PYG{n}{Z}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{forward}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{params}\PYG{p}{)}
        \PYG{n}{Z} \PYG{o}{=} \PYG{n}{Z}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot decision boundary}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{Spectral}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot training examples}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{Spectral}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Decision Boundary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{plt}
    
    \PYG{k}{return} \PYG{n}{visualize\PYGZus{}results}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This implementation demonstrates the core components of neural networks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Forward Propagation}: Computing activations through the network

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Loss Calculation}: Measuring how far predictions are from targets

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Backward Propagation}: Computing gradients for each parameter

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parameter Updates}: Adjusting weights and biases using gradients

\end{enumerate}

\sphinxAtStartPar
While modern deep learning frameworks automate these steps, understanding the underlying mechanics is crucial for debugging, customization, and optimization.


\section{10.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part3/ch10_deep_learning:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Framework Abstraction}: Modern deep learning frameworks like PyTorch and TensorFlow abstract low\sphinxhyphen{}level details, allowing researchers to focus on architecture design and experimentation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Training Stability}: Achieving stable training requires careful attention to initialization, normalization, learning rates, and gradient flow.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Regularization Importance}: Regularization techniques critically impact model generalization, with techniques like dropout, batch normalization, and weight decay combining for best results.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Architectural Innovations}: Advances like residual connections enable training of extremely deep networks by mitigating gradient flow issues.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Optimization Challenges}: Deep learning optimization remains challenging due to non\sphinxhyphen{}convex loss landscapes, saddle points, and the need to escape poor local minima.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Empirical Focus}: Despite theoretical progress, deep learning remains heavily empirical, with practical techniques often preceding theoretical understanding.

\end{itemize}

\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Back}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 1 (Introduction)}: The backpropagation algorithm introduced in section 1.1.3 is explored in depth here, showing how it enables training of complex neural networks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 2 (Neuroscience Foundations)}: The biological learning mechanisms described in section 2.3 provide an interesting contrast to the optimization algorithms covered in this chapter.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 7 (Information Theory)}: The information bottleneck principle (section 7.6) provides theoretical insights into how deep networks compress information through layers.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 9 (ML Foundations)}: The basic learning algorithms from Chapter 9 are extended here to handle deep architectures and large\sphinxhyphen{}scale training.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 11 (Sequence Models)}: The optimization techniques learned here will be applied to the specialized architectures for sequential data.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 12 (Large Language Models)}: The scaling laws and foundation model concepts introduced in section 10.6.2 become critical for understanding LLM training and capabilities.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 14 (Future Directions)}: The biological parallels in deep learning (section 10.5) point to neuromorphic approaches that may shape future AI systems.

\end{itemize}
\end{sphinxadmonition}


\section{10.8 Further Reading \& Media}
\label{\detokenize{part3/ch10_deep_learning:further-reading-media}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Goodfellow, I., Bengio, Y., \& Courville, A. (2016). \sphinxstyleemphasis{Deep Learning}. MIT Press. \sphinxurl{http://www.deeplearningbook.org}

\item {} 
\sphinxAtStartPar
Smith, L. N. (2018). “A disciplined approach to neural network hyper\sphinxhyphen{}parameters: Part 1 \sphinxhyphen{} learning rate, batch size, momentum, and weight decay.” \sphinxstyleemphasis{arXiv preprint arXiv:1803.09820}.

\item {} 
\sphinxAtStartPar
Li, H., Xu, Z., Taylor, G., Studer, C., \& Goldstein, T. (2018). “Visualizing the Loss Landscape of Neural Nets.” \sphinxstyleemphasis{Advances in Neural Information Processing Systems}.

\item {} 
\sphinxAtStartPar
Loshchilov, I., \& Hutter, F. (2019). “Decoupled Weight Decay Regularization.” \sphinxstyleemphasis{International Conference on Learning Representations}.

\item {} 
\sphinxAtStartPar
Zhang, C., Bengio, S., Hardt, M., Recht, B., \& Vinyals, O. (2021). “Understanding deep learning (still) requires rethinking generalization.” \sphinxstyleemphasis{Communications of the ACM, 64}(3), 107\sphinxhyphen{}115.

\item {} 
\sphinxAtStartPar
He, K., Zhang, X., Ren, S., \& Sun, J. (2016). “Deep Residual Learning for Image Recognition.” \sphinxstyleemphasis{IEEE Conference on Computer Vision and Pattern Recognition}.

\item {} 
\sphinxAtStartPar
Jacot, A., Gabriel, F., \& Hongler, C. (2018). “Neural Tangent Kernel: Convergence and Generalization in Neural Networks.” \sphinxstyleemphasis{Advances in Neural Information Processing Systems}.

\item {} 
\sphinxAtStartPar
Ioffe, S., \& Szegedy, C. (2015). “Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift.” \sphinxstyleemphasis{International Conference on Machine Learning}.

\item {} 
\sphinxAtStartPar
3Blue1Brown YouTube Series: “Neural Networks” \sphinxurl{https://www.youtube.com/playlist?list=PLZHQObOWTQDNU6R1\_67000Dx\_ZCJB-3pi}

\end{itemize}

\sphinxstepscope


\chapter{Chapter 11: Sequence Models: RNN → Attention → Transformer}
\label{\detokenize{part3/ch11_sequence_models:chapter-11-sequence-models-rnn-attention-transformer}}\label{\detokenize{part3/ch11_sequence_models::doc}}
\begin{sphinxadmonition}{note}{Learning Objectives}

\sphinxAtStartPar
By the end of this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Understand} the evolution of sequence models from RNNs to Transformers

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Master} the architectures and training methods for recurrent networks, attention mechanisms, and transformer models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connect} sequence model operations to temporal processing in the brain

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implement} key sequence modeling architectures for various tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compare} different approaches to handling sequential data

\end{itemize}
\end{sphinxadmonition}


\section{11.1 Recurrent Neural Networks}
\label{\detokenize{part3/ch11_sequence_models:recurrent-neural-networks}}
\sphinxAtStartPar
Recurrent Neural Networks (RNNs) are specialized neural networks designed to process sequential data by maintaining an internal state (memory) that captures information about previous inputs. Unlike feedforward networks, RNNs have connections that loop back on themselves, allowing them to persist information across time steps.

\sphinxAtStartPar
\sphinxincludegraphics{{rnn_architecture}.svg}
\sphinxstyleemphasis{Figure 11.1: Recurrent Neural Network architectures, showing the basic RNN, LSTM, and GRU cells with their internal structures.}


\subsection{11.1.1 Vanilla RNNs}
\label{\detokenize{part3/ch11_sequence_models:vanilla-rnns}}
\sphinxAtStartPar
The simplest RNN architecture maintains a hidden state that is updated at each time step:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleRNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        A basic RNN implementation.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Size of input features at each time step}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Size of hidden state}
\PYG{l+s+sd}{            output\PYGZus{}size: Size of output at each time step}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleRNN}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Input to hidden weights}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{i2h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Hidden to output weights}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{h2o} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activation function}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Tanh}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{softmax} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LogSoftmax}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n+nb}{input}\PYG{p}{,} \PYG{n}{hidden}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Forward pass through the RNN for a single time step.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Combine input and hidden state}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{input}\PYG{p}{,} \PYG{n}{hidden}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate new hidden state}
        \PYG{n}{hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{i2h}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate output}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{h2o}\PYG{p}{(}\PYG{n}{hidden}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}\PYG{p}{,} \PYG{n}{hidden}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{init\PYGZus{}hidden}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Initialize the hidden state with zeros.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process\PYGZus{}sequence}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sequence}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Process a sequence of inputs and return all outputs and final hidden state.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize hidden state}
        \PYG{n}{hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{init\PYGZus{}hidden}\PYG{p}{(}\PYG{n}{sequence}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Storage for outputs at each time step}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Process each time step}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{sequence}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{output}\PYG{p}{,} \PYG{n}{hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{hidden}\PYG{p}{)}
            \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Stack outputs along time dimension}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{outputs}\PYG{p}{,} \PYG{n}{hidden}

\PYG{c+c1}{\PYGZsh{} Example usage on a toy sequence problem}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}rnn\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate a simple RNN on a toy sequence task.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create sample data: learning to recognize sequences ending with [1, 2, 3]}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}sample}\PYG{p}{(}\PYG{n}{length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Generate random sequence of 0\PYGZhy{}4}
        \PYG{n}{sequence} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{p}{(}\PYG{n}{length}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{long}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check if the last three elements are [1, 2, 3]}
        \PYG{n}{target} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{n}{sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}\PYG{p}{:}\PYG{p}{]} \PYG{o}{==} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{k}{else} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} One\PYGZhy{}hot encode the sequence}
        \PYG{n}{one\PYGZus{}hot\PYGZus{}sequence} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{one\PYGZus{}hot}\PYG{p}{(}\PYG{n}{sequence}\PYG{p}{,} \PYG{n}{num\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{one\PYGZus{}hot\PYGZus{}sequence}\PYG{p}{,} \PYG{n}{target}
    
    \PYG{c+c1}{\PYGZsh{} Generate training data}
    \PYG{n}{train\PYGZus{}data} \PYG{o}{=} \PYG{p}{[}\PYG{n}{generate\PYGZus{}sample}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Define model}
    \PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{5}  \PYG{c+c1}{\PYGZsh{} One\PYGZhy{}hot encoding of 5 possible values}
    \PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Binary classification}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleRNN}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss function and optimizer}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{NLLLoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{n\PYGZus{}epochs} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{accuracies} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train\PYGZus{}data}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get batch}
            \PYG{n}{batch} \PYG{o}{=} \PYG{n}{train\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            \PYG{n}{sequences} \PYG{o}{=} \PYG{p}{[}\PYG{n}{item}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{k}{for} \PYG{n}{item} \PYG{o+ow}{in} \PYG{n}{batch}\PYG{p}{]}
            \PYG{n}{targets} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{p}{[}\PYG{n}{item}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{k}{for} \PYG{n}{item} \PYG{o+ow}{in} \PYG{n}{batch}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Pad sequences to the same length}
            \PYG{n}{max\PYGZus{}len} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{seq}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)} \PYG{k}{for} \PYG{n}{seq} \PYG{o+ow}{in} \PYG{n}{sequences}\PYG{p}{)}
            \PYG{n}{padded\PYGZus{}sequences} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sequences}\PYG{p}{)}\PYG{p}{,} \PYG{n}{max\PYGZus{}len}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{seq} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{sequences}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{padded\PYGZus{}sequences}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{p}{:}\PYG{n}{seq}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{seq}
            
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{hidden} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{init\PYGZus{}hidden}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sequences}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{max\PYGZus{}len}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{output}\PYG{p}{,} \PYG{n}{hidden} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{padded\PYGZus{}sequences}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{hidden}\PYG{p}{)}
                \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} We only care about the output at the last time step}
            \PYG{n}{final\PYGZus{}output} \PYG{o}{=} \PYG{n}{outputs}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Calculate loss}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{final\PYGZus{}output}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
            \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward pass}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate accuracy}
            \PYG{n}{pred} \PYG{o}{=} \PYG{n}{final\PYGZus{}output}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{correct} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{==} \PYG{n}{targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record metrics}
        \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{epoch\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train\PYGZus{}data}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{accuracies}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{correct} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train\PYGZus{}data}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{losses}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracies}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training progress}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{accuracies}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
The RNN updates its hidden state at each time step according to:
\begin{equation*}
\begin{split}h_t = \tanh(W_{hh} h_{t-1} + W_{xh} x_t + b_h)\end{split}
\end{equation*}
\sphinxAtStartPar
Where:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(h_t\) is the hidden state at time \(t\)

\item {} 
\sphinxAtStartPar
\(x_t\) is the input at time \(t\)

\item {} 
\sphinxAtStartPar
\(W_{hh}\) is the hidden\sphinxhyphen{}to\sphinxhyphen{}hidden weights

\item {} 
\sphinxAtStartPar
\(W_{xh}\) is the input\sphinxhyphen{}to\sphinxhyphen{}hidden weights

\item {} 
\sphinxAtStartPar
\(b_h\) is the hidden bias

\end{itemize}

\sphinxAtStartPar
The output at each time step is typically computed as:
\begin{equation*}
\begin{split}y_t = W_{hy} h_t + b_y\end{split}
\end{equation*}
\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: RNNs resemble recurrent circuits in the brain where neural activity can persist and influence future processing. The prefrontal cortex maintains information over time through recurrent connections, similar to how RNNs maintain a hidden state.


\subsection{11.1.2 The Vanishing/Exploding Gradient Problem}
\label{\detokenize{part3/ch11_sequence_models:the-vanishing-exploding-gradient-problem}}
\sphinxAtStartPar
Standard RNNs struggle with long\sphinxhyphen{}term dependencies due to the vanishing or exploding gradient problem. When backpropagating through many time steps, gradients can either:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Vanish \sphinxhyphen{} becoming extremely small, making learning long\sphinxhyphen{}range dependencies impossible

\item {} 
\sphinxAtStartPar
Explode \sphinxhyphen{} becoming extremely large, causing unstable training

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}gradient\PYGZus{}problems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the vanishing gradient problem in RNNs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Number of time steps}
    \PYG{n}{T} \PYG{o}{=} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Different values for recurrent weights}
    \PYG{n}{recurrent\PYGZus{}weights} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{]}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{weight} \PYG{o+ow}{in} \PYG{n}{recurrent\PYGZus{}weights}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate gradient scaling factor at each time step}
        \PYG{c+c1}{\PYGZsh{} For simplicity, we model how the gradient scales based on the recurrent weight}
        \PYG{n}{gradient\PYGZus{}scale} \PYG{o}{=} \PYG{p}{[}\PYG{n}{weight} \PYG{o}{*}\PYG{o}{*} \PYG{n}{t} \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{T}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Plot on log scale}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{gradient\PYGZus{}scale}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Weight = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{weight}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Steps Backward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gradient Scale Factor (log scale)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Vanishing/Exploding Gradients in RNNs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
This problem occurs because during backpropagation through time, the gradient is multiplied by the recurrent weight matrix repeatedly, leading to exponential growth or decay.


\subsection{11.1.3 LSTMs and GRUs}
\label{\detokenize{part3/ch11_sequence_models:lstms-and-grus}}
\sphinxAtStartPar
To address the vanishing gradient problem, Long Short\sphinxhyphen{}Term Memory (LSTM) networks and Gated Recurrent Units (GRUs) were developed with gating mechanisms to control information flow.


\subsubsection{LSTM Architecture}
\label{\detokenize{part3/ch11_sequence_models:lstm-architecture}}
\sphinxAtStartPar
LSTMs introduce a cell state and three gates:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Forget Gate}: Controls what information to throw away from the cell state

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Input Gate}: Controls what new information to add to the cell state

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Output Gate}: Controls what information from the cell state to output

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CustomLSTM}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        A custom LSTM implementation to demonstrate the internal mechanisms.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Size of input features}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Size of hidden state and cell state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{CustomLSTM}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Forget gate: determine what to remove from cell state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Input gate: determine what to add to cell state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell state candidate: new values to add to cell state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}candidate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output gate: determine what to output from cell state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activation functions}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Tanh}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{hidden}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Forward pass through the LSTM cell for a single time step.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{h\PYGZus{}prev}\PYG{p}{,} \PYG{n}{c\PYGZus{}prev} \PYG{o}{=} \PYG{n}{hidden}
        
        \PYG{c+c1}{\PYGZsh{} Combine input and previous hidden state}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Forget gate: what to forget from cell state}
        \PYG{n}{f\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Input gate: what new information to add}
        \PYG{n}{i\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell candidate: potential new values for cell state}
        \PYG{n}{c\PYGZus{}tilde} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}candidate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell state update}
        \PYG{n}{c\PYGZus{}t} \PYG{o}{=} \PYG{n}{f\PYGZus{}t} \PYG{o}{*} \PYG{n}{c\PYGZus{}prev} \PYG{o}{+} \PYG{n}{i\PYGZus{}t} \PYG{o}{*} \PYG{n}{c\PYGZus{}tilde}
        
        \PYG{c+c1}{\PYGZsh{} Output gate: what to expose from cell state}
        \PYG{n}{o\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Hidden state update}
        \PYG{n}{h\PYGZus{}t} \PYG{o}{=} \PYG{n}{o\PYGZus{}t} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{c\PYGZus{}t}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{p}{(}\PYG{n}{h\PYGZus{}t}\PYG{p}{,} \PYG{n}{c\PYGZus{}t}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The LSTM updates are governed by these equations:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Forget gate: \(f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f)\)

\item {} 
\sphinxAtStartPar
Input gate: \(i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i)\)

\item {} 
\sphinxAtStartPar
Cell candidate: \(\tilde{C}_t = \tanh(W_C \cdot [h_{t-1}, x_t] + b_C)\)

\item {} 
\sphinxAtStartPar
Cell state update: \(C_t = f_t \odot C_{t-1} + i_t \odot \tilde{C}_t\)

\item {} 
\sphinxAtStartPar
Output gate: \(o_t = \sigma(W_o \cdot [h_{t-1}, x_t] + b_o)\)

\item {} 
\sphinxAtStartPar
Hidden state update: \(h_t = o_t \odot \tanh(C_t)\)

\end{enumerate}

\sphinxAtStartPar
Where \(\odot\) represents element\sphinxhyphen{}wise multiplication.


\subsubsection{GRU Architecture}
\label{\detokenize{part3/ch11_sequence_models:gru-architecture}}
\sphinxAtStartPar
Gated Recurrent Units (GRUs) are a simplified version of LSTMs with two gates:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reset Gate}: Controls how much of the previous hidden state to use

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Update Gate}: Controls how much of the new hidden state to use

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CustomGRU}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        A custom GRU implementation to demonstrate the internal mechanisms.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Size of input features}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Size of hidden state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{CustomGRU}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Reset gate: determine how much of previous hidden state to use}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update gate: determine how much to update the hidden state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Candidate hidden state}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}candidate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activation functions}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Tanh}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Forward pass through the GRU cell for a single time step.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Combine input and previous hidden state}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reset gate: how much of the previous hidden state to use}
        \PYG{n}{r\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update gate: how much to update the hidden state}
        \PYG{n}{z\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combined input for candidate hidden state}
        \PYG{n}{reset\PYGZus{}combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{r\PYGZus{}t} \PYG{o}{*} \PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Candidate hidden state}
        \PYG{n}{h\PYGZus{}tilde} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}candidate}\PYG{p}{(}\PYG{n}{reset\PYGZus{}combined}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Hidden state update}
        \PYG{n}{h\PYGZus{}t} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{z\PYGZus{}t}\PYG{p}{)} \PYG{o}{*} \PYG{n}{h\PYGZus{}prev} \PYG{o}{+} \PYG{n}{z\PYGZus{}t} \PYG{o}{*} \PYG{n}{h\PYGZus{}tilde}
        
        \PYG{k}{return} \PYG{n}{h\PYGZus{}t}
\end{sphinxVerbatim}

\sphinxAtStartPar
The GRU updates are governed by these equations:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Reset gate: \(r_t = \sigma(W_r \cdot [h_{t-1}, x_t] + b_r)\)

\item {} 
\sphinxAtStartPar
Update gate: \(z_t = \sigma(W_z \cdot [h_{t-1}, x_t] + b_z)\)

\item {} 
\sphinxAtStartPar
Candidate hidden: \(\tilde{h}_t = \tanh(W_h \cdot [r_t \odot h_{t-1}, x_t] + b_h)\)

\item {} 
\sphinxAtStartPar
Hidden state update: \(h_t = (1 - z_t) \odot h_{t-1} + z_t \odot \tilde{h}_t\)

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The gating mechanisms in LSTMs and GRUs resemble neuromodulatory systems in the brain that regulate information flow. For example, dopamine can modulate which information is maintained in working memory, similar to how LSTM gates control what information is stored in the cell state.


\subsection{11.1.4 Bidirectional RNNs}
\label{\detokenize{part3/ch11_sequence_models:bidirectional-rnns}}
\sphinxAtStartPar
In many sequence processing tasks, future context is just as important as past context. Bidirectional RNNs process the sequence in both directions:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BidirectionalRNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        A simple bidirectional RNN implementation.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Size of input features}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Size of hidden state}
\PYG{l+s+sd}{            output\PYGZus{}size: Size of output}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{BidirectionalRNN}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Forward RNN}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}rnn} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward RNN}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{backward\PYGZus{}rnn} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combined output layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process sequence in both directions.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input sequence tensor of shape (batch\PYGZus{}size, seq\PYGZus{}len, input\PYGZus{}size)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{forward\PYGZus{}out}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}rnn}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass (reverse the sequence)}
        \PYG{n}{reversed\PYGZus{}x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{flip}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Reverse along sequence dimension}
        \PYG{n}{backward\PYGZus{}out}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{backward\PYGZus{}rnn}\PYG{p}{(}\PYG{n}{reversed\PYGZus{}x}\PYG{p}{)}
        \PYG{n}{backward\PYGZus{}out} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{flip}\PYG{p}{(}\PYG{n}{backward\PYGZus{}out}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Flip back to match forward}
        
        \PYG{c+c1}{\PYGZsh{} Combine the two directions}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n}{forward\PYGZus{}out}\PYG{p}{,} \PYG{n}{backward\PYGZus{}out}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate output}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
\end{sphinxVerbatim}

\sphinxAtStartPar
Bidirectional RNNs are particularly useful for tasks like speech recognition, machine translation, and named entity recognition, where the entire sequence is available during inference.

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The brain often uses both predictive and retrospective processing when interpreting sequences. For example, in language processing, later words in a sentence can change the interpretation of earlier words.


\subsection{11.1.5 Applications in Neuroscience}
\label{\detokenize{part3/ch11_sequence_models:applications-in-neuroscience}}
\sphinxAtStartPar
RNNs have been used extensively to model neural circuits and brain functions:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}rnn\PYGZus{}on\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Example of using RNNs to model neural time series data.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This would typically involve:}
    \PYG{c+c1}{\PYGZsh{} 1. Loading neural recording data (e.g., spike trains or calcium imaging)}
    \PYG{c+c1}{\PYGZsh{} 2. Preprocessing into appropriate sequences}
    \PYG{c+c1}{\PYGZsh{} 3. Training an RNN to predict neural activity or behavior}
    
    \PYG{c+c1}{\PYGZsh{} Simulated neural data for demonstration}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n}{n\PYGZus{}timesteps} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{l+m+mi}{200}
    
    \PYG{c+c1}{\PYGZsh{} Simulated spike trains \PYGZhy{} binary activity patterns}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{neural\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{binomial}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}timesteps}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add some structure \PYGZhy{} make neurons 0\PYGZhy{}10 active at time 30\PYGZhy{}40 with higher probability}
    \PYG{n}{neural\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{:}\PYG{l+m+mi}{40}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{10}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{binomial}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to tensor}
    \PYG{n}{neural\PYGZus{}data\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define task: predict activity at t+1 from activity at t}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data\PYGZus{}tensor}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} All timepoints except the last}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data\PYGZus{}tensor}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}   \PYG{c+c1}{\PYGZsh{} All timepoints except the first}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{n}{train\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{n\PYGZus{}trials}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{n}{train\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{train\PYGZus{}size}\PYG{p}{:}\PYG{p}{]}
    \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{p}{:}\PYG{n}{train\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{train\PYGZus{}size}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Define an RNN model (we\PYGZsq{}ll use PyTorch\PYGZsq{}s built\PYGZhy{}in GRU)}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} For binary prediction}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simplified diagram of RNN modeling neural circuits}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw the neural data raster plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{binary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Example Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw the RNN prediction schema}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RNN Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RNN Modeling Neural Dynamics}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
In neuroscience, RNNs have been used to:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Model working memory in the prefrontal cortex

\item {} 
\sphinxAtStartPar
Simulate motor sequence learning in the basal ganglia

\item {} 
\sphinxAtStartPar
Capture dynamic responses in sensory cortices

\item {} 
\sphinxAtStartPar
Model decision\sphinxhyphen{}making processes in frontal areas

\end{enumerate}

\sphinxAtStartPar
The recurrent connectivity in these networks resembles the recurrent circuits found throughout the brain, making them natural models of neural dynamics.


\section{11.2 Attention Mechanisms}
\label{\detokenize{part3/ch11_sequence_models:attention-mechanisms}}
\sphinxAtStartPar
While RNNs excel at sequential processing, they struggle with long\sphinxhyphen{}range dependencies. Attention mechanisms address this limitation by allowing the model to focus on relevant parts of the input sequence when producing each output element, regardless of their distance.

\sphinxAtStartPar
\sphinxincludegraphics{{attention_mechanism}.svg}
\sphinxstyleemphasis{Figure 11.2: Attention mechanism architecture showing query, key, value operations and how attention weights are computed and applied.}


\subsection{11.2.1 The Intuition Behind Attention}
\label{\detokenize{part3/ch11_sequence_models:the-intuition-behind-attention}}
\sphinxAtStartPar
Attention mimics a cognitive process: when processing complex information, humans focus on relevant parts while ignoring irrelevant details. For example, when translating a long sentence, a human translator might focus on specific source words when generating each target word.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{attention\PYGZus{}intuition}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the intuition behind attention.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a simple sentence for visualization}
    \PYG{n}{source} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The small cat sleeps on the comfortable blue mat}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{target} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Le petit chat dort sur le tapis bleu confortable}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Split into words}
    \PYG{n}{source\PYGZus{}words} \PYG{o}{=} \PYG{n}{source}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{target\PYGZus{}words} \PYG{o}{=} \PYG{n}{target}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate attention weights (would normally be learned)}
    \PYG{c+c1}{\PYGZsh{} Each row corresponds to a target word, each column to a source word}
    \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{target\PYGZus{}words}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{source\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set attention based on word alignment (simplified for visualization)}
    \PYG{n}{alignments} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+m+mi}{0}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Le \PYGZhy{}\PYGZgt{} The}
        \PYG{l+m+mi}{1}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} petit \PYGZhy{}\PYGZgt{} small}
        \PYG{l+m+mi}{2}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} chat \PYGZhy{}\PYGZgt{} cat}
        \PYG{l+m+mi}{3}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} dort \PYGZhy{}\PYGZgt{} sleeps}
        \PYG{l+m+mi}{4}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} sur \PYGZhy{}\PYGZgt{} on}
        \PYG{l+m+mi}{5}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} le \PYGZhy{}\PYGZgt{} the}
        \PYG{l+m+mi}{6}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{]}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} tapis bleu \PYGZhy{}\PYGZgt{} blue mat}
        \PYG{l+m+mi}{7}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{6}\PYG{p}{]}        \PYG{c+c1}{\PYGZsh{} confortable \PYGZhy{}\PYGZgt{} comfortable}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Fill in attention weights}
    \PYG{k}{for} \PYG{n}{target\PYGZus{}idx}\PYG{p}{,} \PYG{n}{source\PYGZus{}idxs} \PYG{o+ow}{in} \PYG{n}{alignments}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{source\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n}{source\PYGZus{}idxs}\PYG{p}{:}
            \PYG{n}{attention\PYGZus{}weights}\PYG{p}{[}\PYG{n}{target\PYGZus{}idx}\PYG{p}{,} \PYG{n}{source\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{source\PYGZus{}idxs}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create visualization}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{YlOrRd}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add labels}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{source\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{source\PYGZus{}words}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{target\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target\PYGZus{}words}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Source (English)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Target (French)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Weights in Translation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add a colorbar}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}


\subsection{11.2.2 Self\sphinxhyphen{}Attention}
\label{\detokenize{part3/ch11_sequence_models:self-attention}}
\sphinxAtStartPar
Self\sphinxhyphen{}attention allows a sequence to attend to itself, capturing dependencies between elements regardless of their distance. The key innovation is computing attention weights using queries and keys derived from the same sequence.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SelfAttention}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Self\PYGZhy{}attention mechanism.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Dimensionality of input vectors}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SelfAttention}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections for query, key, and value}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scaling factor}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{p}{[}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply self\PYGZhy{}attention to input sequence.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor of shape [batch\PYGZus{}size, seq\PYGZus{}len, hidden\PYGZus{}size]}
\PYG{l+s+sd}{            mask: Optional mask tensor of shape [batch\PYGZus{}size, seq\PYGZus{}len, seq\PYGZus{}len]}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            attended: Output tensor after self\PYGZhy{}attention}
\PYG{l+s+sd}{            attention\PYGZus{}weights: Attention weight matrix}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections}
        \PYG{n}{q} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, hidden\PYGZus{}size]}
        \PYG{n}{k} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, hidden\PYGZus{}size]}
        \PYG{n}{v} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, hidden\PYGZus{}size]}
        
        \PYG{c+c1}{\PYGZsh{} Compute attention scores}
        \PYG{c+c1}{\PYGZsh{} q @ k.transpose(\PYGZhy{}2, \PYGZhy{}1) =\PYGZgt{} [batch\PYGZus{}size, seq\PYGZus{}len, seq\PYGZus{}len]}
        \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{q}\PYG{p}{,} \PYG{n}{k}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale}
        
        \PYG{c+c1}{\PYGZsh{} Apply mask if provided (useful for padding or causal attention)}
        \PYG{k}{if} \PYG{n}{mask} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{attention\PYGZus{}scores}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e10}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Softmax to get attention weights}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attention\PYGZus{}scores}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply attention weights to values}
        \PYG{n}{attended} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{,} \PYG{n}{v}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{attended}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights}
\end{sphinxVerbatim}

\sphinxAtStartPar
The self\sphinxhyphen{}attention operation is defined as:
\begin{equation*}
\begin{split}\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V\end{split}
\end{equation*}
\sphinxAtStartPar
Where:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(Q\) (queries), \(K\) (keys), and \(V\) (values) are linear projections of the input

\item {} 
\sphinxAtStartPar
\(d_k\) is the dimensionality of the key vectors

\item {} 
\sphinxAtStartPar
The scaling factor \(\frac{1}{\sqrt{d_k}}\) prevents the softmax from reaching regions with extremely small gradients

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Selective attention in the brain allows for focusing on relevant stimuli while suppressing irrelevant information. The thalamus and prefrontal cortex work together to control which information receives processing priority, similar to how attention weights prioritize certain parts of the input.


\subsection{11.2.3 Multi\sphinxhyphen{}Head Attention}
\label{\detokenize{part3/ch11_sequence_models:multi-head-attention}}
\sphinxAtStartPar
Multi\sphinxhyphen{}head attention runs several attention mechanisms in parallel, allowing the model to jointly attend to information from different representation subspaces.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MultiHeadAttention}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Multi\PYGZhy{}head attention mechanism.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Dimensionality of input vectors}
\PYG{l+s+sd}{            num\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{MultiHeadAttention}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{assert} \PYG{n}{hidden\PYGZus{}size} \PYG{o}{\PYGZpc{}} \PYG{n}{num\PYGZus{}heads} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{hidden\PYGZus{}size must be divisible by num\PYGZus{}heads}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads} \PYG{o}{=} \PYG{n}{num\PYGZus{}heads}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size} \PYG{o}{/}\PYG{o}{/} \PYG{n}{num\PYGZus{}heads}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections for query, key, and value}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output projection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}projection} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scaling factor}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{query}\PYG{p}{,} \PYG{n}{key}\PYG{p}{,} \PYG{n}{value}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply multi\PYGZhy{}head attention.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            query: Query tensor [batch\PYGZus{}size, query\PYGZus{}len, hidden\PYGZus{}size]}
\PYG{l+s+sd}{            key: Key tensor [batch\PYGZus{}size, key\PYGZus{}len, hidden\PYGZus{}size]}
\PYG{l+s+sd}{            value: Value tensor [batch\PYGZus{}size, key\PYGZus{}len, hidden\PYGZus{}size]}
\PYG{l+s+sd}{            mask: Optional mask tensor [batch\PYGZus{}size, query\PYGZus{}len, key\PYGZus{}len]}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            attended: Output tensor after multi\PYGZhy{}head attention}
\PYG{l+s+sd}{            attention\PYGZus{}weights: Attention weight tensor for each head}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{query}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections}
        \PYG{n}{Q} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{query}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, query\PYGZus{}len, hidden\PYGZus{}size]}
        \PYG{n}{K} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key}\PYG{p}{(}\PYG{n}{key}\PYG{p}{)}      \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, key\PYGZus{}len, hidden\PYGZus{}size]}
        \PYG{n}{V} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{(}\PYG{n}{value}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, key\PYGZus{}len, hidden\PYGZus{}size]}
        
        \PYG{c+c1}{\PYGZsh{} Reshape for multi\PYGZhy{}head attention}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, hidden\PYGZus{}size] \PYGZhy{}\PYGZgt{} [batch\PYGZus{}size, seq\PYGZus{}len, num\PYGZus{}heads, head\PYGZus{}dim]}
        \PYG{n}{Q} \PYG{o}{=} \PYG{n}{Q}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{n}{K} \PYG{o}{=} \PYG{n}{K}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{n}{V} \PYG{o}{=} \PYG{n}{V}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose to [batch\PYGZus{}size, num\PYGZus{}heads, seq\PYGZus{}len, head\PYGZus{}dim]}
        \PYG{n}{Q} \PYG{o}{=} \PYG{n}{Q}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{K} \PYG{o}{=} \PYG{n}{K}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{V} \PYG{o}{=} \PYG{n}{V}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute attention scores}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, num\PYGZus{}heads, query\PYGZus{}len, key\PYGZus{}len]}
        \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{Q}\PYG{p}{,} \PYG{n}{K}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale}
        
        \PYG{c+c1}{\PYGZsh{} Apply mask if provided}
        \PYG{k}{if} \PYG{n}{mask} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Expand mask for multiple heads}
            \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, query\PYGZus{}len, key\PYGZus{}len] \PYGZhy{}\PYGZgt{} [batch\PYGZus{}size, 1, query\PYGZus{}len, key\PYGZus{}len]}
            \PYG{n}{mask} \PYG{o}{=} \PYG{n}{mask}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{attention\PYGZus{}scores}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e10}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Softmax to get attention weights}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attention\PYGZus{}scores}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply attention weights to values}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, num\PYGZus{}heads, query\PYGZus{}len, head\PYGZus{}dim]}
        \PYG{n}{attended} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose and reshape back}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, num\PYGZus{}heads, query\PYGZus{}len, head\PYGZus{}dim] \PYGZhy{}\PYGZgt{} [batch\PYGZus{}size, query\PYGZus{}len, num\PYGZus{}heads, head\PYGZus{}dim]}
        \PYG{n}{attended} \PYG{o}{=} \PYG{n}{attended}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{contiguous}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, query\PYGZus{}len, hidden\PYGZus{}size]}
        \PYG{n}{attended} \PYG{o}{=} \PYG{n}{attended}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final linear projection}
        \PYG{n}{attended} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}projection}\PYG{p}{(}\PYG{n}{attended}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{attended}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights}
\end{sphinxVerbatim}

\sphinxAtStartPar
Multi\sphinxhyphen{}head attention expands on the basic attention mechanism with multiple attention “heads” operating in parallel, each looking at different aspects of the data:
\begin{equation*}
\begin{split}\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, ..., \text{head}_h)W^O\end{split}
\end{equation*}
\sphinxAtStartPar
Where:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Each \(\text{head}_i = \text{Attention}(QW_i^Q, KW_i^K, VW_i^V)\)

\item {} 
\sphinxAtStartPar
The \(W\) matrices are learned projection matrices

\item {} 
\sphinxAtStartPar
\(W^O\) is the output projection

\end{itemize}


\subsection{11.2.4 Self\sphinxhyphen{}Attention vs. Recurrence}
\label{\detokenize{part3/ch11_sequence_models:self-attention-vs-recurrence}}
\sphinxAtStartPar
Self\sphinxhyphen{}attention offers several advantages over recurrent networks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parallelization}: Unlike RNNs, which process sequences step\sphinxhyphen{}by\sphinxhyphen{}step, self\sphinxhyphen{}attention processes all sequence elements simultaneously.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Long\sphinxhyphen{}range dependencies}: Attention directly connects any two positions in the sequence, allowing for efficient modeling of long\sphinxhyphen{}range dependencies.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interpretability}: Attention weights can be visualized to understand which input elements the model focuses on when generating each output.

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}rnn\PYGZus{}attention\PYGZus{}complexity}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare computational complexity of RNNs vs. Attention\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{sequence\PYGZus{}lengths} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{1001}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Computational complexity}
    \PYG{n}{rnn\PYGZus{}sequential\PYGZus{}ops} \PYG{o}{=} \PYG{n}{sequence\PYGZus{}lengths}  \PYG{c+c1}{\PYGZsh{} O(n) time steps for sequential processing}
    \PYG{n}{attention\PYGZus{}parallel\PYGZus{}ops} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}lengths}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} O(1) parallel processing}
    \PYG{n}{attention\PYGZus{}memory\PYGZus{}cost} \PYG{o}{=} \PYG{n}{sequence\PYGZus{}lengths}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} O(n²) attention matrix}
    
    \PYG{c+c1}{\PYGZsh{} Plot comparison}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}lengths}\PYG{p}{,} \PYG{n}{rnn\PYGZus{}sequential\PYGZus{}ops}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RNN (Sequential Steps)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}lengths}\PYG{p}{,} \PYG{n}{attention\PYGZus{}parallel\PYGZus{}ops}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention (Parallel)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sequence Length}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sequential Operations}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Computational Complexity (Time)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}lengths}\PYG{p}{,} \PYG{n}{attention\PYGZus{}memory\PYGZus{}cost}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Matrix Size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sequence Length}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Memory Cost}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Memory Requirements}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}


\subsection{11.2.5 Scaled Dot\sphinxhyphen{}Product Attention}
\label{\detokenize{part3/ch11_sequence_models:scaled-dot-product-attention}}
\sphinxAtStartPar
The core attention mechanism in modern architectures is scaled dot\sphinxhyphen{}product attention:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{scaled\PYGZus{}dot\PYGZus{}product\PYGZus{}attention}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{key}\PYG{p}{,} \PYG{n}{value}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute scaled dot\PYGZhy{}product attention.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        query: Query tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}k]}
\PYG{l+s+sd}{        key: Key tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}k]}
\PYG{l+s+sd}{        value: Value tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}v]}
\PYG{l+s+sd}{        mask: Optional mask tensor [batch\PYGZus{}size, seq\PYGZus{}len, seq\PYGZus{}len]}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        output: Attended values}
\PYG{l+s+sd}{        attention: Attention weights}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Compute attention scores}
    \PYG{n}{d\PYGZus{}k} \PYG{o}{=} \PYG{n}{query}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{scores} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{key}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{d\PYGZus{}k}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply mask if provided}
    \PYG{k}{if} \PYG{n}{mask} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{scores} \PYG{o}{=} \PYG{n}{scores}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e10}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply softmax to get attention weights}
    \PYG{n}{attention} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{scores}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply attention weights to values}
    \PYG{n}{output} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{attention}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{output}\PYG{p}{,} \PYG{n}{attention}
\end{sphinxVerbatim}


\subsection{11.2.6 Attention Visualization}
\label{\detokenize{part3/ch11_sequence_models:attention-visualization}}
\sphinxAtStartPar
Visualizing attention weights can provide insight into how the model processes sequences:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}attention}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a visualization of attention patterns.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Sample sentence}
    \PYG{n}{sentence} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The quick brown fox jumps over the lazy dog}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{words} \PYG{o}{=} \PYG{n}{sentence}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create simulated attention matrices}
    \PYG{n}{num\PYGZus{}words} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Self\PYGZhy{}attention: diagonal dominant (attends to self and nearby words)}
    \PYG{n}{self\PYGZus{}attention} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{,} \PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{self\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{j}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize rows}
    \PYG{n}{self\PYGZus{}attention} \PYG{o}{=} \PYG{n}{self\PYGZus{}attention} \PYG{o}{/} \PYG{n}{self\PYGZus{}attention}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Subject\PYGZhy{}verb attention: highlights grammatical relationships}
    \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{,} \PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{subject\PYGZus{}idx} \PYG{o}{=} \PYG{l+m+mi}{3}  \PYG{c+c1}{\PYGZsh{} \PYGZsq{}fox\PYGZsq{}}
    \PYG{n}{verb\PYGZus{}idx} \PYG{o}{=} \PYG{l+m+mi}{4}     \PYG{c+c1}{\PYGZsh{} \PYGZsq{}jumps\PYGZsq{}}
    \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{subject\PYGZus{}idx}\PYG{p}{,} \PYG{n}{verb\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.7}
    \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{verb\PYGZus{}idx}\PYG{p}{,} \PYG{n}{subject\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.7}
    
    \PYG{c+c1}{\PYGZsh{} Fill in other relationships}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{subject\PYGZus{}idx} \PYG{o+ow}{and} \PYG{n}{j} \PYG{o}{!=} \PYG{n}{verb\PYGZus{}idx} \PYG{o+ow}{and} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{verb\PYGZus{}idx} \PYG{o+ow}{and} \PYG{n}{j} \PYG{o}{!=} \PYG{n}{subject\PYGZus{}idx}\PYG{p}{:}
                \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{/} \PYG{p}{(}\PYG{n}{num\PYGZus{}words} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot attention matrices}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot self\PYGZhy{}attention}
    \PYG{n}{im1} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{self\PYGZus{}attention}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{YlOrRd}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Self\PYGZhy{}Attention Pattern}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{setp}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{rotation\PYGZus{}mode}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{anchor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im1}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot subject\PYGZhy{}verb attention}
    \PYG{n}{im2} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{YlOrRd}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Subject\PYGZhy{}Verb Attention}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{setp}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{rotation\PYGZus{}mode}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{anchor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im2}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add annotations}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}words}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{self\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.2}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{self\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{white}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{self\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
                
            \PYG{k}{if} \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.2}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{white}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{subj\PYGZus{}verb\PYGZus{}attention}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}


\subsection{11.2.7 Neural Correlates of Attention}
\label{\detokenize{part3/ch11_sequence_models:neural-correlates-of-attention}}
\sphinxAtStartPar
The attention mechanisms in deep learning have interesting parallels with attention systems in the brain:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}attention\PYGZus{}parallels}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate parallels between artificial and neural attention.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple diagram}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Attention in the Brain}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw brain regions involved in attention}
    \PYG{n}{circle1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFC78E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PFC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{circle2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}8EADFC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Thalamus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{circle3} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.12}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}8EFCB8}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Visual Cortex}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add labels}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PFC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Thalamus}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Visual}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Cortex}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw connections}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add explanatory text}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The prefrontal cortex (PFC) directs attention via the thalamus,}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{selectively enhancing processing in sensory areas}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Machine attention mechanism}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Artificial Attention Mechanism}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw components}
    \PYG{n}{rect1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFC78E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{rect2} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}8EADFC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{rect3} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}8EFCB8}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add labels}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.275}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Query}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.575}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Weights}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.875}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw connections}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.35}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mf}{0.65}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.15}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add explanatory text}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural network attention uses queries to compute weights}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{that determine which values are most relevant}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
These parallels include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Selective Enhancement}: Both neural and artificial attention selectively enhance processing of relevant information.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Top\sphinxhyphen{}down Control}: The prefrontal cortex provides top\sphinxhyphen{}down control in the brain, similar to how queries direct attention in artificial systems.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Resource Allocation}: Both systems efficiently allocate limited processing resources to the most important inputs.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context Integration}: Both integrate contextual information to determine what’s relevant in the current situation.

\end{enumerate}


\section{11.3 Transformer Architecture}
\label{\detokenize{part3/ch11_sequence_models:transformer-architecture}}
\sphinxAtStartPar
The Transformer architecture, introduced in the landmark paper “Attention Is All You Need” (Vaswani et al., 2017), revolutionized sequence processing by eliminating recurrence entirely and relying solely on attention mechanisms.

\sphinxAtStartPar
\sphinxincludegraphics{{transformer_architecture}.svg}
\sphinxstyleemphasis{Figure 11.3: The Transformer architecture featuring an encoder\sphinxhyphen{}decoder structure with multi\sphinxhyphen{}head attention, positional encodings, and feed\sphinxhyphen{}forward networks.}


\subsection{11.3.1 Overall Architecture}
\label{\detokenize{part3/ch11_sequence_models:overall-architecture}}
\sphinxAtStartPar
The Transformer follows an encoder\sphinxhyphen{}decoder structure:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Transformer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{src\PYGZus{}vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} 
                 \PYG{n}{max\PYGZus{}seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Full Transformer architecture for sequence\PYGZhy{}to\PYGZhy{}sequence tasks.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            src\PYGZus{}vocab\PYGZus{}size: Size of source vocabulary}
\PYG{l+s+sd}{            tgt\PYGZus{}vocab\PYGZus{}size: Size of target vocabulary}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension (embedding size)}
\PYG{l+s+sd}{            n\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            n\PYGZus{}layers: Number of encoder/decoder layers}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension in feed\PYGZhy{}forward networks}
\PYG{l+s+sd}{            max\PYGZus{}seq\PYGZus{}len: Maximum sequence length for positional encodings}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{Transformer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Embeddings and positional encodings}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{src\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Embedding}\PYG{p}{(}\PYG{n}{src\PYGZus{}vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tgt\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Embedding}\PYG{p}{(}\PYG{n}{tgt\PYGZus{}vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{positional\PYGZus{}encoding} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{create\PYGZus{}positional\PYGZus{}encoding}\PYG{p}{(}\PYG{n}{max\PYGZus{}seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Encoder and decoder}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{TransformerEncoder}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{n}{TransformerDecoder}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final linear layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{final\PYGZus{}layer} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}vocab\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dropout}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{init\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}positional\PYGZus{}encoding}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{max\PYGZus{}seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create sinusoidal positional encodings.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Create a tensor for positions}
        \PYG{n}{positions} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}seq\PYGZus{}len}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a tensor for dimension indices}
        \PYG{n}{div\PYGZus{}term} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{math}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mf}{10000.0}\PYG{p}{)} \PYG{o}{/} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create positional encoding}
        \PYG{n}{pe} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{max\PYGZus{}seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n}{pe}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{positions} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Even dimensions}
        \PYG{n}{pe}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{positions} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Odd dimensions}
        
        \PYG{c+c1}{\PYGZsh{} Add batch dimension and register as buffer (not a parameter)}
        \PYG{n}{pe} \PYG{o}{=} \PYG{n}{pe}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{pe}\PYG{p}{,} \PYG{n}{requires\PYGZus{}grad}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{init\PYGZus{}parameters}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Initialize model parameters.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{xavier\PYGZus{}uniform\PYGZus{}}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{src}\PYG{p}{,} \PYG{n}{tgt}\PYG{p}{,} \PYG{n}{src\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the Transformer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            src: Source sequence [batch\PYGZus{}size, src\PYGZus{}len]}
\PYG{l+s+sd}{            tgt: Target sequence [batch\PYGZus{}size, tgt\PYGZus{}len]}
\PYG{l+s+sd}{            src\PYGZus{}mask: Mask for source self\PYGZhy{}attention}
\PYG{l+s+sd}{            tgt\PYGZus{}mask: Mask for target self\PYGZhy{}attention (usually causal)}
\PYG{l+s+sd}{            src\PYGZus{}padding\PYGZus{}mask: Mask for source padding}
\PYG{l+s+sd}{            tgt\PYGZus{}padding\PYGZus{}mask: Mask for target padding}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            output: Vocabulary distributions [batch\PYGZus{}size, tgt\PYGZus{}len, tgt\PYGZus{}vocab\PYGZus{}size]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get sequence lengths}
        \PYG{n}{src\PYGZus{}len} \PYG{o}{=} \PYG{n}{src}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{tgt\PYGZus{}len} \PYG{o}{=} \PYG{n}{tgt}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Embed and add positional encoding}
        \PYG{n}{src\PYGZus{}embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{src\PYGZus{}embedding}\PYG{p}{(}\PYG{n}{src}\PYG{p}{)} \PYG{o}{*} \PYG{n}{math}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n}{src\PYGZus{}embedded} \PYG{o}{=} \PYG{n}{src\PYGZus{}embedded} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{positional\PYGZus{}encoding}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{src\PYGZus{}len}\PYG{p}{]}
        \PYG{n}{src\PYGZus{}embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{src\PYGZus{}embedded}\PYG{p}{)}
        
        \PYG{n}{tgt\PYGZus{}embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tgt\PYGZus{}embedding}\PYG{p}{(}\PYG{n}{tgt}\PYG{p}{)} \PYG{o}{*} \PYG{n}{math}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n}{tgt\PYGZus{}embedded} \PYG{o}{=} \PYG{n}{tgt\PYGZus{}embedded} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{positional\PYGZus{}encoding}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{tgt\PYGZus{}len}\PYG{p}{]}
        \PYG{n}{tgt\PYGZus{}embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{tgt\PYGZus{}embedded}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Encoder pass}
        \PYG{n}{encoder\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{src\PYGZus{}embedded}\PYG{p}{,} \PYG{n}{src\PYGZus{}mask}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decoder pass}
        \PYG{n}{decoder\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder}\PYG{p}{(}\PYG{n}{tgt\PYGZus{}embedded}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}padding\PYGZus{}mask}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final projection to vocabulary}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{final\PYGZus{}layer}\PYG{p}{(}\PYG{n}{decoder\PYGZus{}output}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
\end{sphinxVerbatim}

\sphinxAtStartPar
The Transformer consists of two main components:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Encoder}: Processes the input sequence into a continuous representation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Decoder}: Generates the output sequence based on the encoder representation and previous outputs

\end{enumerate}


\subsection{11.3.2 Encoder}
\label{\detokenize{part3/ch11_sequence_models:encoder}}
\sphinxAtStartPar
The encoder consists of N identical layers, each with two sub\sphinxhyphen{}layers:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerEncoderLayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Single Transformer encoder layer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{            n\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension in feed\PYGZhy{}forward network}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{TransformerEncoderLayer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Multi\PYGZhy{}head self\PYGZhy{}attention}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{self\PYGZus{}attention} \PYG{o}{=} \PYG{n}{MultiHeadAttention}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward network}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Layer normalization}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dropout}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through encoder layer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            mask: Optional attention mask}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            x: Output tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Self\PYGZhy{}attention sub\PYGZhy{}layer with residual connection and layer normalization}
        \PYG{n}{attn\PYGZus{}output}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{self\PYGZus{}attention}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{attn\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward sub\PYGZhy{}layer with residual connection and layer normalization}
        \PYG{n}{ff\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{ff\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}

\sphinxAtStartPar
The complete encoder stacks multiple encoder layers:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerEncoder}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Full Transformer encoder with N layers.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{            n\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            n\PYGZus{}layers: Number of encoder layers}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension in feed\PYGZhy{}forward network}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{TransformerEncoder}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Stack of encoder layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}
            \PYG{p}{[}\PYG{n}{TransformerEncoderLayer}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{p}{)} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{]}
        \PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the encoder.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            mask: Self\PYGZhy{}attention mask}
\PYG{l+s+sd}{            padding\PYGZus{}mask: Mask for padding tokens}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            x: Encoded representation [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Apply padding mask to attention mask if provided}
        \PYG{k}{if} \PYG{n}{padding\PYGZus{}mask} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{mask} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{mask} \PYG{o}{=} \PYG{n}{padding\PYGZus{}mask}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{mask} \PYG{o}{=} \PYG{n}{mask} \PYG{o}{\PYGZam{}} \PYG{n}{padding\PYGZus{}mask}
        
        \PYG{c+c1}{\PYGZsh{} Pass through each encoder layer}
        \PYG{k}{for} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}


\subsection{11.3.3 Decoder}
\label{\detokenize{part3/ch11_sequence_models:decoder}}
\sphinxAtStartPar
The decoder is similar to the encoder but has an additional cross\sphinxhyphen{}attention layer:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerDecoderLayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Single Transformer decoder layer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{            n\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension in feed\PYGZhy{}forward network}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{TransformerDecoderLayer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Multi\PYGZhy{}head self\PYGZhy{}attention}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{self\PYGZus{}attention} \PYG{o}{=} \PYG{n}{MultiHeadAttention}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Multi\PYGZhy{}head cross\PYGZhy{}attention to encoder outputs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cross\PYGZus{}attention} \PYG{o}{=} \PYG{n}{MultiHeadAttention}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward network}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Layer normalization}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dropout}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through decoder layer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor [batch\PYGZus{}size, tgt\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            encoder\PYGZus{}output: Output from encoder [batch\PYGZus{}size, src\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            tgt\PYGZus{}mask: Mask for target self\PYGZhy{}attention (usually causal)}
\PYG{l+s+sd}{            tgt\PYGZus{}padding\PYGZus{}mask: Mask for target padding}
\PYG{l+s+sd}{            src\PYGZus{}padding\PYGZus{}mask: Mask for source padding}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            x: Output tensor [batch\PYGZus{}size, tgt\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Self\PYGZhy{}attention sub\PYGZhy{}layer with residual connection and layer normalization}
        \PYG{n}{attn\PYGZus{}output}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{self\PYGZus{}attention}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{attn\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cross\PYGZhy{}attention sub\PYGZhy{}layer with residual connection and layer normalization}
        \PYG{n}{cross\PYGZus{}attn\PYGZus{}output}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cross\PYGZus{}attention}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{cross\PYGZus{}attn\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward sub\PYGZhy{}layer with residual connection and layer normalization}
        \PYG{n}{ff\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm3}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{ff\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}

\sphinxAtStartPar
The complete decoder stacks multiple decoder layers:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerDecoder}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Full Transformer decoder with N layers.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{            n\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            n\PYGZus{}layers: Number of decoder layers}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension in feed\PYGZhy{}forward network}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{TransformerDecoder}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Stack of decoder layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}
            \PYG{p}{[}\PYG{n}{TransformerDecoderLayer}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{p}{)} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{]}
        \PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the decoder.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor [batch\PYGZus{}size, tgt\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            encoder\PYGZus{}output: Output from encoder [batch\PYGZus{}size, src\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            tgt\PYGZus{}mask: Mask for target self\PYGZhy{}attention (usually causal)}
\PYG{l+s+sd}{            tgt\PYGZus{}padding\PYGZus{}mask: Mask for target padding}
\PYG{l+s+sd}{            src\PYGZus{}padding\PYGZus{}mask: Mask for source padding}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            x: Decoded representation [batch\PYGZus{}size, tgt\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Pass through each decoder layer}
        \PYG{k}{for} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{encoder\PYGZus{}output}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}mask}\PYG{p}{,} \PYG{n}{tgt\PYGZus{}padding\PYGZus{}mask}\PYG{p}{,} \PYG{n}{src\PYGZus{}padding\PYGZus{}mask}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}


\subsection{11.3.4 Positional Encodings}
\label{\detokenize{part3/ch11_sequence_models:positional-encodings}}
\sphinxAtStartPar
Since the Transformer doesn’t use recurrence or convolution, it needs a way to incorporate sequence order. Positional encodings add positional information to the input embeddings:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}positional\PYGZus{}encodings}\PYG{p}{(}\PYG{n}{max\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create sinusoidal positional encodings.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Args:}
\PYG{l+s+sd}{        max\PYGZus{}len: Maximum sequence length}
\PYG{l+s+sd}{        d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{        pos\PYGZus{}encoding: Positional encoding tensor [1, max\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a tensor for positions}
    \PYG{n}{positions} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}len}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a tensor for dimension indices}
    \PYG{n}{div\PYGZus{}term} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{math}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mf}{10000.0}\PYG{p}{)} \PYG{o}{/} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create positional encoding}
    \PYG{n}{pos\PYGZus{}encoding} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{max\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
    \PYG{n}{pos\PYGZus{}encoding}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{positions} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Even dimensions}
    \PYG{n}{pos\PYGZus{}encoding}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{positions} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Odd dimensions}
    
    \PYG{c+c1}{\PYGZsh{} Add batch dimension}
    \PYG{n}{pos\PYGZus{}encoding} \PYG{o}{=} \PYG{n}{pos\PYGZus{}encoding}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{pos\PYGZus{}encoding}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}positional\PYGZus{}encodings}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize positional encodings.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create positional encodings}
    \PYG{n}{max\PYGZus{}len} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{d\PYGZus{}model} \PYG{o}{=} \PYG{l+m+mi}{128}
    \PYG{n}{pos\PYGZus{}encoding} \PYG{o}{=} \PYG{n}{create\PYGZus{}positional\PYGZus{}encodings}\PYG{p}{(}\PYG{n}{max\PYGZus{}len}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{o}{.}\PYG{n}{squeeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot as a heatmap}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{pos\PYGZus{}encoding}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Embedding Dimension}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Position in Sequence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sinusoidal Positional Encodings}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot a few dimensions across positions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{dim} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{63}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{65}\PYG{p}{,} \PYG{l+m+mi}{66}\PYG{p}{,} \PYG{l+m+mi}{127}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{pos\PYGZus{}encoding}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{dim}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dim }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dim}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Positional Encoding Values by Dimension}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
The positional encodings use sine and cosine functions of different frequencies:
\begin{equation*}
\begin{split}PE_{(pos, 2i)} = \sin\left(pos / 10000^{2i/d_{model}}\right)\end{split}
\end{equation*}\begin{equation*}
\begin{split}PE_{(pos, 2i+1)} = \cos\left(pos / 10000^{2i/d_{model}}\right)\end{split}
\end{equation*}
\sphinxAtStartPar
This approach allows the model to easily learn to attend to relative positions since \(PE_{pos+k}\) can be represented as a linear function of \(PE_{pos}\).


\subsection{11.3.5 Feed\sphinxhyphen{}Forward Networks}
\label{\detokenize{part3/ch11_sequence_models:feed-forward-networks}}
\sphinxAtStartPar
Each encoder and decoder layer contains a position\sphinxhyphen{}wise feed\sphinxhyphen{}forward network:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PositionwiseFeedForward}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Position\PYGZhy{}wise feed\PYGZhy{}forward network.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            d\PYGZus{}model: Model dimension}
\PYG{l+s+sd}{            d\PYGZus{}ff: Hidden dimension}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PositionwiseFeedForward}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply feed\PYGZhy{}forward network to input.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            output: Transformed tensor [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{output}
\end{sphinxVerbatim}

\sphinxAtStartPar
These networks apply two linear transformations with a ReLU activation in between:
\begin{equation*}
\begin{split}FFN(x) = \max(0, xW_1 + b_1)W_2 + b_2\end{split}
\end{equation*}
\sphinxAtStartPar
The feed\sphinxhyphen{}forward networks process each position independently, which is why they’re sometimes called “position\sphinxhyphen{}wise” feed\sphinxhyphen{}forward networks.


\subsection{11.3.6 Residual Connections and Layer Normalization}
\label{\detokenize{part3/ch11_sequence_models:residual-connections-and-layer-normalization}}
\sphinxAtStartPar
The Transformer uses residual connections around each sub\sphinxhyphen{}layer, followed by layer normalization:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AddNorm}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Residual connection followed by layer normalization.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            size: Feature dimension}
\PYG{l+s+sd}{            dropout: Dropout rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{AddNorm}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{sublayer\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply residual connection and layer normalization.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor}
\PYG{l+s+sd}{            sublayer\PYGZus{}output: Output from sublayer}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            normalized: Normalized output with residual connection}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Add residual connection and normalize}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{sublayer\PYGZus{}output}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Layer normalization normalizes the inputs across the feature dimension, stabilizing the network’s activations:
\begin{equation*}
\begin{split}LayerNorm(x) = \gamma \odot \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} + \beta\end{split}
\end{equation*}
\sphinxAtStartPar
Where:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(\mu\) and \(\sigma\) are the mean and standard deviation of the inputs

\item {} 
\sphinxAtStartPar
\(\gamma\) and \(\beta\) are learned parameters

\item {} 
\sphinxAtStartPar
\(\epsilon\) is a small constant for numerical stability

\end{itemize}


\subsection{11.3.7 Biological Parallels}
\label{\detokenize{part3/ch11_sequence_models:biological-parallels}}
\sphinxAtStartPar
The Transformer architecture has several interesting parallels with neural processing:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{transformer\PYGZus{}brain\PYGZus{}parallels}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate parallels between Transformers and brain processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a two\PYGZhy{}row comparison}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Parallel Processing in Transformers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw Transformer components}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x\PYGZus{}pos} \PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{+} \PYG{n}{i} \PYG{o}{*} \PYG{l+m+mf}{0.2}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x\PYGZus{}pos}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x\PYGZus{}pos} \PYG{o}{+} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{x\PYGZus{}pos} \PYG{o}{+} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Token }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add attention illustration}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{k}{if} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{j} \PYG{k}{else} \PYG{l+m+mf}{0.8}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1} \PYG{o}{+} \PYG{n}{i} \PYG{o}{*} \PYG{l+m+mf}{0.2} \PYG{o}{+} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mf}{0.1} \PYG{o}{+} \PYG{n}{j} \PYG{o}{*} \PYG{l+m+mf}{0.2} \PYG{o}{+} \PYG{l+m+mf}{0.05}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Second row for brain}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distributed Processing in Brain Networks}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw brain regions}
    \PYG{n}{regions} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFC78E}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw connections between regions}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{y1}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x2}\PYG{p}{,} \PYG{n}{y2}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{regions}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{j}\PYG{p}{:}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{y1}\PYG{p}{,} \PYG{n}{y2}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add explanatory text}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Both systems feature distributed parallel processing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{with selective connections between elements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
             \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key parallels include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parallel Processing}: The brain processes information in parallel across multiple regions, similar to how Transformers process all sequence positions simultaneously.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Selective Attention}: Neural attention processes selectively enhance specific information paths, similar to attention mechanisms in Transformers.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}: Both the brain and Transformers use hierarchical layers of processing, with higher levels building on lower\sphinxhyphen{}level representations.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distributed Representations}: Neural processing involves distributed representations across populations of neurons, similar to the distributed embeddings in Transformers.

\end{enumerate}

\sphinxAtStartPar
However, these are high\sphinxhyphen{}level analogies rather than direct functional equivalents.


\section{11.4 Neural Sequence Processing}
\label{\detokenize{part3/ch11_sequence_models:neural-sequence-processing}}
\sphinxAtStartPar
The brain is fundamentally a sequence processing system. From processing sensory streams to controlling motor behaviors, neural circuits specialize in handling temporally structured information. This section explores how biological sequence processing relates to artificial sequence models we’ve discussed.

\sphinxAtStartPar
\sphinxincludegraphics{{brain_sequence_processing}.svg}
\sphinxstyleemphasis{Figure 11.4: Comparison of sequence processing mechanisms in the brain and neural networks, highlighting temporal dynamics, working memory, and hierarchical processing.}


\subsection{11.4.1 Temporal Dynamics in Cortical Circuits}
\label{\detokenize{part3/ch11_sequence_models:temporal-dynamics-in-cortical-circuits}}
\sphinxAtStartPar
Cortical circuits exhibit rich temporal dynamics that enable sequence processing:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}cortical\PYGZus{}dynamics}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate temporal dynamics in a recurrent cortical circuit.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Parameters}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{n\PYGZus{}time} \PYG{o}{=} \PYG{l+m+mi}{200}
    \PYG{n}{tau} \PYG{o}{=} \PYG{l+m+mi}{10}       \PYG{c+c1}{\PYGZsh{} Time constant (ms)}
    \PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mi}{1}         \PYG{c+c1}{\PYGZsh{} Simulation time step (ms)}
    
    \PYG{c+c1}{\PYGZsh{} Create recurrent connection matrix (random but sparse)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{W} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.05}
    \PYG{n}{W}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.2}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Sparsity}
    
    \PYG{c+c1}{\PYGZsh{} Make the network stable by scaling connection weights}
    \PYG{n}{W} \PYG{o}{=} \PYG{l+m+mf}{0.95} \PYG{o}{*} \PYG{n}{W} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eigvals}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate network activity}
    \PYG{n}{activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initial impulse to subset of neurons}
    \PYG{n}{activity}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{20}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run simulation with Euler integration}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}time}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Update: dx/dt = \PYGZhy{}x/tau + W·x}
        \PYG{n}{activity}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{activity}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{activity}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{n}{tau} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{activity}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add some noise}
        \PYG{n}{activity}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.01}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the dynamics}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot full activity matrix}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{activity}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Temporal Dynamics in Recurrent Cortical Circuit}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot activity of selected neurons}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{activity}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{+} \PYG{n}{i}\PYG{o}{*}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron Activity (offset for visibility)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Temporal Evolution of Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Cortical circuits exhibit several key properties that support sequence processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Persistent Activity}: Recurrent connections enable activity to persist after stimulation ends, creating a form of working memory.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sequential Activation}: Asymmetric connectivity can lead to waves of sequential neural activation, creating temporal patterns.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Integration}: Neurons integrate inputs over time, with different time constants for different cell types.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Oscillatory Dynamics}: Neural populations often display rhythmic activity patterns (theta, gamma oscillations) that provide temporal organization.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Connection to AI Models}: These properties are analogous to the hidden state dynamics in RNNs. The time constant (τ) of biological neurons resembles the gating mechanisms in LSTMs that control information flow over time.


\subsection{11.4.2 Working Memory Mechanisms}
\label{\detokenize{part3/ch11_sequence_models:working-memory-mechanisms}}
\sphinxAtStartPar
The brain maintains and manipulates sequential information through working memory systems:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralWorkingMemoryModel}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}A model of prefrontal cortex working memory inspired by biological mechanisms.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{NeuralWorkingMemoryModel}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{n}{input\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}size} \PYG{o}{=} \PYG{n}{memory\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Input processing}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}layer} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Maintenance mechanism (recurrent connections)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{maintenance\PYGZus{}cell} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRUCell}\PYG{p}{(}\PYG{n}{memory\PYGZus{}size}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Gating mechanisms (inspired by PFC\PYGZhy{}basal ganglia loops)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}gate} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size} \PYG{o}{+} \PYG{n}{memory\PYGZus{}size}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}
        \PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{prev\PYGZus{}memory}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process a single timestep.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Current input [batch\PYGZus{}size, input\PYGZus{}size]}
\PYG{l+s+sd}{            prev\PYGZus{}memory: Previous memory state [batch\PYGZus{}size, memory\PYGZus{}size]}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            memory: Updated memory state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Determine update proportion using gate}
        \PYG{n}{combined} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{prev\PYGZus{}memory}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{update\PYGZus{}weight} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}gate}\PYG{p}{(}\PYG{n}{combined}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Process input}
        \PYG{n}{input\PYGZus{}repr} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Maintain previous memory through recurrent connections}
        \PYG{n}{maintained} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{maintenance\PYGZus{}cell}\PYG{p}{(}\PYG{n}{prev\PYGZus{}memory}\PYG{p}{,} \PYG{n}{prev\PYGZus{}memory}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Gated update of memory}
        \PYG{n}{memory} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{update\PYGZus{}weight}\PYG{p}{)} \PYG{o}{*} \PYG{n}{maintained} \PYG{o}{+} \PYG{n}{update\PYGZus{}weight} \PYG{o}{*} \PYG{n}{input\PYGZus{}repr}
        
        \PYG{k}{return} \PYG{n}{memory}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}wm\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate a delayed match\PYGZhy{}to\PYGZhy{}sample working memory task.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize memory}
        \PYG{n}{memory} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Storage for memory states over time}
        \PYG{n}{memory\PYGZus{}states} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Create sample input sequence (one item to remember, then distractors)}
        \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Target item at first position}
        \PYG{n}{target} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{inputs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{target}
        
        \PYG{c+c1}{\PYGZsh{} Distractors at other positions}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{inputs}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Probe at last position (50\PYGZpc{} match, 50\PYGZpc{} non\PYGZhy{}match)}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5}\PYG{p}{:}
            \PYG{n}{inputs}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{target}  \PYG{c+c1}{\PYGZsh{} Match}
            \PYG{n}{is\PYGZus{}match} \PYG{o}{=} \PYG{k+kc}{True}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{inputs}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Non\PYGZhy{}match}
            \PYG{n}{is\PYGZus{}match} \PYG{o}{=} \PYG{k+kc}{False}
        
        \PYG{c+c1}{\PYGZsh{} Process sequence}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{memory} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}\PYG{p}{,} \PYG{n}{memory}\PYG{p}{)}
            \PYG{n}{memory\PYGZus{}states}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{memory}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{clone}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Stack memory states over time}
        \PYG{n}{memory\PYGZus{}states} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{memory\PYGZus{}states}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{memory\PYGZus{}states}\PYG{p}{,} \PYG{n}{is\PYGZus{}match}
\end{sphinxVerbatim}

\sphinxAtStartPar
The prefrontal cortex (PFC) implements working memory through:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Persistent Neural Activity}: Sustained firing in PFC neurons maintains information over delays.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Selective Gating}: Basal ganglia circuits control what information enters working memory, similar to the gates in LSTMs.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dynamic Coding}: Working memory representations evolve over time while maintaining task\sphinxhyphen{}relevant information.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Capacity Limits}: Neural working memory has limited capacity, requiring filtering mechanisms.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Connection to AI Models}: These properties align with gated recurrent networks. The maintenance cell in LSTMs resembles persistent activity in prefrontal neurons, while the gates mirror the selective filtering functions of basal ganglia circuits.


\subsection{11.4.3 Predictive Processing}
\label{\detokenize{part3/ch11_sequence_models:predictive-processing}}
\sphinxAtStartPar
The brain actively predicts upcoming sensory inputs and actions:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}predictive\PYGZus{}coding}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate predictive coding in sensory processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Parameters}
    \PYG{n}{n\PYGZus{}timesteps} \PYG{o}{=} \PYG{l+m+mi}{100}
    
    \PYG{c+c1}{\PYGZsh{} Create a predictable pattern with occasional violations}
    \PYG{n}{pattern\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{base\PYGZus{}pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{pattern\PYGZus{}length}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Repeat the pattern with occasional violations}
    \PYG{n}{repeats} \PYG{o}{=} \PYG{n}{n\PYGZus{}timesteps} \PYG{o}{/}\PYG{o}{/} \PYG{n}{pattern\PYGZus{}length}
    \PYG{n}{stimulus} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tile}\PYG{p}{(}\PYG{n}{base\PYGZus{}pattern}\PYG{p}{,} \PYG{n}{repeats}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add violations (pattern breaks)}
    \PYG{n}{violation\PYGZus{}points} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{35}\PYG{p}{,} \PYG{l+m+mi}{75}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{vp} \PYG{o+ow}{in} \PYG{n}{violation\PYGZus{}points}\PYG{p}{:}
        \PYG{n}{stimulus}\PYG{p}{[}\PYG{n}{vp}\PYG{p}{:}\PYG{n}{vp}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{stimulus}\PYG{p}{[}\PYG{n}{vp}\PYG{p}{:}\PYG{n}{vp}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Invert the pattern}
    
    \PYG{c+c1}{\PYGZsh{} Simulate predictive network}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{)}
    \PYG{n}{prediction\PYGZus{}errors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simple prediction: next value is previous value (for illustration)}
    \PYG{n}{predictions}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{stimulus}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Calculate prediction errors}
    \PYG{n}{prediction\PYGZus{}errors} \PYG{o}{=} \PYG{n}{stimulus} \PYG{o}{\PYGZhy{}} \PYG{n}{predictions}
    
    \PYG{c+c1}{\PYGZsh{} Visualize}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot stimulus}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{stimulus}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{vp} \PYG{o+ow}{in} \PYG{n}{violation\PYGZus{}points}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{vp}\PYG{p}{,} \PYG{n}{vp}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sensory Input Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot predictions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{predictions}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{vp} \PYG{o+ow}{in} \PYG{n}{violation\PYGZus{}points}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{vp}\PYG{p}{,} \PYG{n}{vp}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Predictions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot prediction errors}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}errors}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{vp} \PYG{o+ow}{in} \PYG{n}{violation\PYGZus{}points}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvspan}\PYG{p}{(}\PYG{n}{vp}\PYG{p}{,} \PYG{n}{vp}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Errors}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Error Magnitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Predictive processing is a fundamental principle of neural computation:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive Coding}: The brain generates predictions about upcoming sensory inputs based on learned internal models.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error Signaling}: Prediction errors (differences between expectations and actual inputs) drive learning and updating of internal models.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Predictions}: Higher brain areas generate predictions for lower areas in a cascade of top\sphinxhyphen{}down influences.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Prediction}: The brain anticipates not just what will happen but when it will happen, encoding temporal expectations.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Connection to AI Models}: These mechanisms relate to sequence models like RNNs and transformers that learn to predict the next element in a sequence. Language models are fundamentally prediction systems, similar to the brain’s predictive processing architecture.


\subsection{11.4.4 Hierarchical Temporal Processing}
\label{\detokenize{part3/ch11_sequence_models:hierarchical-temporal-processing}}
\sphinxAtStartPar
The brain processes temporal information at multiple timescales in a hierarchical manner:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}hierarchical\PYGZus{}processing}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize hierarchical temporal processing in the brain and neural networks.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Brain hierarchy}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hierarchical Temporal Processing in the Brain}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw brain regions}
    \PYG{n}{regions} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Primary Sensory}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(ms timescale)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFCCCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Secondary Sensory}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(10s\PYGZhy{}100s ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFE5CC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Association Cortex}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(seconds)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFFFCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PFC/Hippocampus}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(minutes\PYGZhy{}hours)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}E5FFCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Default Mode Network}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(days\PYGZhy{}years)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{3.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}CCE5FF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{rect} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{o}{\PYGZhy{}}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} 
                             \PYG{n}{facecolor}\PYG{o}{=}\PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{l+m+mf}{0.35}\PYG{p}{,} \PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{9}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Draw connections}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{prev\PYGZus{}r} \PYG{o}{=} \PYG{n}{regions}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{prev\PYGZus{}r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{prev\PYGZus{}r}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.7}\PYG{p}{,} 
                     \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Neural network hierarchy}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hierarchical Processing in Neural Sequence Models}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw network layers}
    \PYG{n}{layers} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Layer}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(Character/Token)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFCCCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Lower Layers}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(Syntax, Local Patterns)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFE5CC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Middle Layers}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(Semantics, Phrases)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{2.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFFFCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Upper Layers}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(Context, Discourse)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}E5FFCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Layer}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(Predictions, Generation)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{3.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}CCE5FF}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{l} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{layers}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{rect} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{o}{\PYGZhy{}}\PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} 
                             \PYG{n}{facecolor}\PYG{o}{=}\PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{color}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{l+m+mf}{0.35}\PYG{p}{,} \PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{9}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Draw connections}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{prev\PYGZus{}l} \PYG{o}{=} \PYG{n}{layers}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{prev\PYGZus{}l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{prev\PYGZus{}l}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.7}\PYG{p}{,} 
                     \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{fc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
The brain’s temporal processing follows a hierarchical organization:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Integration Windows}: Different brain regions operate at different timescales:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Primary sensory areas: Millisecond timescale

\item {} 
\sphinxAtStartPar
Secondary areas: Tens to hundreds of milliseconds

\item {} 
\sphinxAtStartPar
Association areas: Seconds

\item {} 
\sphinxAtStartPar
Prefrontal cortex: Minutes to hours

\item {} 
\sphinxAtStartPar
Default mode network: Days to years

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Abstraction Hierarchy}: Higher brain areas extract increasingly abstract temporal patterns from the input.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Receptive Fields}: Similar to spatial receptive fields, neurons have temporal receptive fields spanning different durations.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Nested Oscillations}: Neural oscillations form a nested hierarchy (theta, alpha, beta, gamma) that helps organize temporal processing.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Connection to AI Models}: This hierarchy parallels how transformer models process sequences:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Lower layers capture local patterns and syntax

\item {} 
\sphinxAtStartPar
Middle layers process semantic relationships

\item {} 
\sphinxAtStartPar
Upper layers integrate broader context and discourse information

\end{itemize}

\sphinxAtStartPar
The attention span in different transformer layers resembles the temporal integration windows in the cortical hierarchy.


\subsection{11.4.5 Comparative Architecture Analysis}
\label{\detokenize{part3/ch11_sequence_models:comparative-architecture-analysis}}
\sphinxAtStartPar
We can directly compare sequence processing in neural networks and biological systems:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}neural\PYGZus{}and\PYGZus{}artificial\PYGZus{}sequence\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a table comparing biological and artificial sequence processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create figure and axis}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Data for the table}
    \PYG{n}{rows} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Biological Systems}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RNNs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Transformers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Processing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Architecture}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Recurrent circuits}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{with lateral connections}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sequential processing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{with recurrent state}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Parallel processing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{with attention}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Information}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Storage}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Persistent activity and}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{synaptic changes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden state vectors}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Self\PYGZhy{}attention patterns}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Temporal}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Range}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Multiple timescales across}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{brain hierarchy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Limited by vanishing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{gradients}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Full sequence}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{visibility}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Parallel}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Processing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Massively parallel}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Limited (sequential)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Highly parallel}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Modularity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Specialized regions}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{and pathways}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Specialized gates}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{(LSTM, GRU)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Multi\PYGZhy{}head attention}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{for different patterns}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Computational}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Cost}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Energy efficient}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Low computation}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{High latency}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{High computation}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Low latency}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Developmental}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Trajectory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Progressive specialization}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{through experience}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Fixed architecture}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{after training}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Fixed architecture}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{after training}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create table}
    \PYG{n}{table} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{table}\PYG{p}{(}
        \PYG{n}{cellText}\PYG{o}{=}\PYG{n}{rows}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{colLabels}\PYG{o}{=}\PYG{n}{rows}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{n}{cellLoc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Style the table}
    \PYG{n}{table}\PYG{o}{.}\PYG{n}{auto\PYGZus{}set\PYGZus{}font\PYGZus{}size}\PYG{p}{(}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{table}\PYG{o}{.}\PYG{n}{set\PYGZus{}fontsize}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{table}\PYG{o}{.}\PYG{n}{scale}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{1.8}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Color the header row}
    \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{cell} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{table}\PYG{o}{.}\PYG{n}{\PYGZus{}cells}\PYG{p}{[}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{j}\PYG{p}{)}\PYG{p}{]} \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rows}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{cell}\PYG{o}{.}\PYG{n}{set\PYGZus{}facecolor}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}4C72B0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{cell}\PYG{o}{.}\PYG{n}{set\PYGZus{}text\PYGZus{}props}\PYG{p}{(}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Alternate row colors for readability}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rows}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{rows}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{cell} \PYG{o}{=} \PYG{n}{table}\PYG{o}{.}\PYG{n}{\PYGZus{}cells}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{)}\PYG{p}{]}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{2} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{cell}\PYG{o}{.}\PYG{n}{set\PYGZus{}facecolor}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}F4F4F4}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparison of Sequence Processing in Biological and Artificial Systems}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
This comparison highlights how artificial sequence models have both converged with and diverged from biological sequence processing mechanisms.


\subsection{11.4.6 Future Directions}
\label{\detokenize{part3/ch11_sequence_models:future-directions}}
\sphinxAtStartPar
The future of neural sequence models may involve greater inspiration from neuroscience:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptive Timescales}: Models with dynamic time constants that adapt to input statistics, similar to sensory adaptation in the brain.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive Learning}: Self\sphinxhyphen{}supervised architectures that learn by predicting future inputs, mimicking the brain’s predictive processing.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory\sphinxhyphen{}Attention Integration}: Hybrid models combining the strengths of memory\sphinxhyphen{}based systems (like hippocampus) and attention\sphinxhyphen{}based systems (like working memory).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Temporal Abstraction}: Models that explicitly represent information at multiple timescales, similar to the cortical hierarchy.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Energy\sphinxhyphen{}Efficient Processing}: Sparse, event\sphinxhyphen{}driven computation inspired by the brain’s efficient processing mechanisms.

\end{enumerate}

\sphinxAtStartPar
The bidirectional inspiration between neuroscience and AI will continue to drive innovations in sequence modeling, with each field informing the other.


\section{11.5 Applications}
\label{\detokenize{part3/ch11_sequence_models:applications}}
\sphinxAtStartPar
Sequence models have transformed numerous fields by enabling machines to process and generate sequential data. This section explores key applications that bridge computational neuroscience and artificial intelligence.


\subsection{11.5.1 Natural Language Processing}
\label{\detokenize{part3/ch11_sequence_models:natural-language-processing}}
\sphinxAtStartPar
Language is perhaps the most prominent application of sequence models, with transformers revolutionizing the field:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}language\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate a simple language model application.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Sample text}
    \PYG{n}{text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The brain processes language through a hierarchical network. Areas like Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s and Wernicke}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s regions coordinate to understand and produce speech.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{words} \PYG{o}{=} \PYG{n}{text}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create vocabulary and word\PYGZhy{}to\PYGZhy{}index mapping}
    \PYG{n}{vocab} \PYG{o}{=} \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{word2idx} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{word}\PYG{p}{:} \PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{word} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{vocab}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
    \PYG{n}{idx2word} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{i}\PYG{p}{:} \PYG{n}{word} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{word} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{vocab}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Prepare input sequences and targets for next\PYGZhy{}word prediction}
    \PYG{n}{sequence\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{n}{input\PYGZus{}sequences} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{targets} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{input\PYGZus{}seq} \PYG{o}{=} \PYG{n}{words}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{]}
        \PYG{n}{target} \PYG{o}{=} \PYG{n}{words}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{]}
        
        \PYG{n}{input\PYGZus{}sequences}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{[}\PYG{n}{word2idx}\PYG{p}{[}\PYG{n}{word}\PYG{p}{]} \PYG{k}{for} \PYG{n}{word} \PYG{o+ow}{in} \PYG{n}{input\PYGZus{}seq}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{targets}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{word2idx}\PYG{p}{[}\PYG{n}{target}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to tensors}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{input\PYGZus{}sequences}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{targets}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define a simple RNN language model}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleLanguageModel}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleLanguageModel}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{embedding} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Embedding}\PYG{p}{(}\PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}\PYG{n}{embedding\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{vocab\PYGZus{}size}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} x shape: [batch\PYGZus{}size, sequence\PYGZus{}length]}
            \PYG{n}{embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{embedding}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, sequence\PYGZus{}length, embedding\PYGZus{}dim]}
            \PYG{n}{output}\PYG{p}{,} \PYG{n}{hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn}\PYG{p}{(}\PYG{n}{embedded}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} output: [batch\PYGZus{}size, sequence\PYGZus{}length, hidden\PYGZus{}dim]}
            
            \PYG{c+c1}{\PYGZsh{} We only care about the final time step for next word prediction}
            \PYG{n}{prediction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc}\PYG{p}{(}\PYG{n}{output}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, vocab\PYGZus{}size]}
            \PYG{k}{return} \PYG{n}{prediction}
    
    \PYG{c+c1}{\PYGZsh{} Example of model instantiation}
    \PYG{n}{vocab\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{vocab}\PYG{p}{)}
    \PYG{n}{embedding\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{16}
    \PYG{n}{hidden\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{32}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleLanguageModel}\PYG{p}{(}\PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize the language modeling process}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Draw the input sequence and target visualization}
    \PYG{n}{example\PYGZus{}idx} \PYG{o}{=} \PYG{l+m+mi}{5}  \PYG{c+c1}{\PYGZsh{} Choose an example to visualize}
    \PYG{n}{input\PYGZus{}seq} \PYG{o}{=} \PYG{p}{[}\PYG{n}{idx2word}\PYG{p}{[}\PYG{n}{idx}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]} \PYG{k}{for} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n}{X}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{p}{]}
    \PYG{n}{target\PYGZus{}word} \PYG{o}{=} \PYG{n}{idx2word}\PYG{p}{[}\PYG{n}{y}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create text explanation}
    \PYG{n}{explanation} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Input Sequence: }\PYG{l+s+se}{\PYGZbs{}\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{input\PYGZus{}seq}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Target Word: }\PYG{l+s+se}{\PYGZbs{}\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{target\PYGZus{}word}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Language models learn to predict the next word given a context.}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural networks for language processing parallel the brain}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s hierarchical language system:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Word embeddings → Semantic representations in temporal lobe}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Sequential processing → Left\PYGZhy{}hemisphere language pathways}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Prediction mechanisms → Predictive processing in auditory cortex}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Contextual integration → Working memory in prefrontal cortex}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{explanation}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} 
             \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightyellow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{boxstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{round,pad=1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key innovations in language models and their neuroscience connections include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Word Embeddings}: Neural representations that capture semantic relationships between words, analogous to distributed semantic representations in the temporal lobe.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contextual Processing}: Modern language models like BERT and GPT use context to disambiguate words, similar to the brain’s use of context in language comprehension.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Syntactic Structure}: Models implicitly learn syntactic dependencies, mirroring the brain’s left\sphinxhyphen{}hemisphere language pathways.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prediction and Surprisal}: Language models predict upcoming words, just as the brain’s auditory cortex generates predictions during speech processing.

\end{enumerate}


\subsection{11.5.2 Time Series Forecasting}
\label{\detokenize{part3/ch11_sequence_models:time-series-forecasting}}
\sphinxAtStartPar
Sequence models excel at forecasting future values in time series data:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}time\PYGZus{}series\PYGZus{}forecasting}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Show time series forecasting with sequence models.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate synthetic time series with multiple components}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}points} \PYG{o}{=} \PYG{l+m+mi}{200}
    
    \PYG{c+c1}{\PYGZsh{} Create time points}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Components}
    \PYG{n}{trend} \PYG{o}{=} \PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{time}
    \PYG{n}{seasonal} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{time} \PYG{o}{/} \PYG{l+m+mi}{50}\PYG{p}{)}
    \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine components}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{trend} \PYG{o}{+} \PYG{n}{seasonal} \PYG{o}{+} \PYG{n}{noise}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{n}{train\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}data} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{n}{train\PYGZus{}size}\PYG{p}{]}
    \PYG{n}{test\PYGZus{}data} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{train\PYGZus{}size}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Function to create windowed data}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}windows}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{window\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{X}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{y}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create windowed data}
    \PYG{n}{window\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train} \PYG{o}{=} \PYG{n}{create\PYGZus{}windows}\PYG{p}{(}\PYG{n}{train\PYGZus{}data}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Prepare for PyTorch}
    \PYG{n}{X\PYGZus{}train\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Add feature dimension}
    \PYG{n}{y\PYGZus{}train\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define a simple LSTM model for forecasting}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LSTMForecaster}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LSTMForecaster}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LSTM}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{linear} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} x shape: [batch\PYGZus{}size, sequence\PYGZus{}length, input\PYGZus{}dim]}
            \PYG{n}{lstm\PYGZus{}out}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} Take only the last time step}
            \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{linear}\PYG{p}{(}\PYG{n}{lstm\PYGZus{}out}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{y\PYGZus{}pred}
    
    \PYG{c+c1}{\PYGZsh{} Example forecasting}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forecast}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{p}{,} \PYG{n}{n\PYGZus{}future}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{predictions} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Last window from data}
        \PYG{n}{current\PYGZus{}window} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{window\PYGZus{}size}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}future}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Convert to tensor}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{current\PYGZus{}window}\PYG{p}{)}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{window\PYGZus{}size}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Get prediction}
            \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{next\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add prediction to the list}
            \PYG{n}{predictions}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{next\PYGZus{}pred}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update window}
            \PYG{n}{current\PYGZus{}window} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}window}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{next\PYGZus{}pred}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{predictions}
    
    \PYG{c+c1}{\PYGZsh{} Plot the data and forecasting concept}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot original data and forecasting window}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original Data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{train\PYGZus{}size}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Train/Test Split}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight an example window}
    \PYG{n}{window\PYGZus{}start} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{[}\PYG{n}{window\PYGZus{}start}\PYG{p}{:}\PYG{n}{window\PYGZus{}start}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{n}{data}\PYG{p}{[}\PYG{n}{window\PYGZus{}start}\PYG{p}{:}\PYG{n}{window\PYGZus{}start}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Window}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{[}\PYG{n}{window\PYGZus{}start}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{n}{data}\PYG{p}{[}\PYG{n}{window\PYGZus{}start}\PYG{o}{+}\PYG{n}{window\PYGZus{}size}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ro}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Target Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Series Forecasting with Sequence Models}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Illustrate prediction mechanisms}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{text} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time Series Forecasting and Neural Processing}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Both brains and neural networks process time series in similar ways:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Sliding window processing → Visual/auditory temporal integration}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Memory cells (LSTM/GRU) → Working memory in prefrontal cortex}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Multi\PYGZhy{}timescale analysis → Hierarchical processing in sensory pathways}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Prediction error learning → Predictive coding in sensory cortices}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Applications span climate prediction, financial forecasting, healthcare monitoring,}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{neural signal processing, and brain\PYGZhy{}computer interfaces.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} 
             \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{boxstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{round,pad=1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Time series forecasting applications include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Signal Prediction}: Forecasting EEG/MEG signals for brain\sphinxhyphen{}computer interfaces.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Clinical Monitoring}: Predicting patient vital signs in intensive care settings.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain State Transitions}: Modeling transitions between different brain states during cognition or sleep.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Movement Prediction}: Forecasting limb movements from neural activity for prosthetics.

\end{enumerate}

\sphinxAtStartPar
The biological parallel lies in how the brain itself constantly predicts future sensory inputs and outcomes based on current and past information.


\subsection{11.5.3 Neural Sequence Decoding}
\label{\detokenize{part3/ch11_sequence_models:neural-sequence-decoding}}
\sphinxAtStartPar
Sequence models can decode neural signals into meaningful outputs:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}sequence\PYGZus{}decoding}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate neural sequence decoding applications.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simulated neural sequence data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}time} \PYG{o}{=} \PYG{l+m+mi}{200}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{50}
    
    \PYG{c+c1}{\PYGZsh{} Create oscillatory patterns that represent different \PYGZdq{}states\PYGZdq{}}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{n\PYGZus{}time}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} State 1: High frequency oscillation}
    \PYG{n}{state1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{o}{*}\PYG{n}{time}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} State 2: Low frequency oscillation}
    \PYG{n}{state2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine states and add noise}
    \PYG{n}{neural\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{hstack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{state1}\PYG{p}{,} \PYG{n}{state2}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{neural\PYGZus{}data} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create \PYGZdq{}behavioral\PYGZdq{} output \PYGZhy{} we\PYGZsq{}ll decode two motor states}
    \PYG{c+c1}{\PYGZsh{} State A: first half of time}
    \PYG{c+c1}{\PYGZsh{} State B: second half of time}
    \PYG{n}{motor\PYGZus{}state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{)}
    \PYG{n}{motor\PYGZus{}state}\PYG{p}{[}\PYG{n}{n\PYGZus{}time}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Plot the data and decoding concept}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot neural data}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{n\PYGZus{}time}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simulated Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot motor state}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{motor\PYGZus{}state}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{n\PYGZus{}time}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Motor State}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Behavioral Output to Decode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Illustration of decoding approach}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{text} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural Sequence Decoding}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Converting neural activity patterns into meaningful outputs:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Brain\PYGZhy{}Computer Interfaces: Decode neural signals for device control}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Neurorehabilitation: Translate movement intentions to prosthetic control}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Speech Decoding: Convert neural activity to speech output}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Cognitive State Classification: Identify mental states from brain activity}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modern approaches use sequence models (RNNs/Transformers) to capture temporal}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dependencies in neural data. This parallels how different brain regions interpret}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{signals from other areas to coordinate complex behaviors.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} 
             \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{boxstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{round,pad=1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Neural sequence decoding applications include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Motor Decoding}: Translating neural activity from motor cortex into movement commands for prosthetic limbs or cursor control.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Speech Decoding}: Converting neural signals from language areas into synthesized speech or text.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive State Classification}: Identifying mental states, attention levels, or emotions from neural time series.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Prosthetics}: Creating closed\sphinxhyphen{}loop systems that both decode intentions and deliver stimulation.

\end{enumerate}

\sphinxAtStartPar
The bidirectional relationship between neuroscience and AI is particularly strong here: AI helps decode brain activity, while knowledge of neural coding informs better AI architectures.


\subsection{11.5.4 Generative Sequence Models}
\label{\detokenize{part3/ch11_sequence_models:generative-sequence-models}}
\sphinxAtStartPar
Sequence models can generate new data sequences with properties similar to their training data:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generative\PYGZus{}sequence\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate generative sequence models.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a visualization of generative models}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate example sequences for display}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Text generation}
    \PYG{n}{text\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The brain processes information through}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{text\PYGZus{}completion} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ complex networks of neurons that encode and transmit signals using both electrical and chemical mechanisms.}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Music generation (simplified as a waveform)}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{music\PYGZus{}sample} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{t}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{l+m+mi}{5}\PYG{o}{*}\PYG{n}{t}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{l+m+mi}{7}\PYG{o}{*}\PYG{n}{t}\PYG{p}{)}
    \PYG{n}{music\PYGZus{}sample} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Neural activity generation (simplified)}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{n\PYGZus{}time} \PYG{o}{=} \PYG{l+m+mi}{200}
    \PYG{n}{neural\PYGZus{}activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create some patterned activity}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{rate} \PYG{o}{=} \PYG{l+m+mf}{0.05} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{phase} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{neural\PYGZus{}activity}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{)} \PYG{o}{+} \PYG{n}{phase}\PYG{p}{)}
    
    \PYG{n}{neural\PYGZus{}activity} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}time}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create visualization}
    \PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 1. Text Generation}
    \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{311}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Text Generation:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prompt: }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{text\PYGZus{}prompt}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Completion: }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{text\PYGZus{}completion}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
             \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Music Generation}
    \PYG{n}{ax2} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{312}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{music\PYGZus{}sample}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Music Generation: Waveform Example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Amplitude}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Neural Activity Generation}
    \PYG{n}{ax3} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{313}\PYG{p}{)}
    \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural Activity Generation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
    \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neuron}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add explanatory text overlay}
    \PYG{n}{text} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Generative Sequence Models}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Applications bridging AI and neuroscience:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Text Generation: Creating coherent language (like GPT models)}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Music Synthesis: Composing music with temporal structure}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Neural Activity Simulation: Generating realistic neural recordings}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Movement Synthesis: Creating naturalistic motion sequences}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Biological Parallels:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Imagination in the brain involves generating sequences of neural activity}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• During planning, the hippocampus generates sequences of place cell activity}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Dreams are generated sequences of neural patterns during sleep}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Motor planning involves simulating sequences of movements before execution}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}
    
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} 
             \PYG{n}{bbox}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}FFFFCC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{boxstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{round,pad=1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{n}{rect}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Generative sequence model applications include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Simulation}: Generating realistic neural spike train data for hypothesis testing and model validation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}Inspired Content Creation}: Using neural sequence generation principles to create art, music, or narrative.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive Modeling}: Simulating thought processes by generating sequences of cognitive states.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Therapeutic Applications}: Generating personalized auditory or visual stimuli for neurological rehabilitation.

\end{enumerate}

\sphinxAtStartPar
The process of generating sequences in artificial models parallels how the brain generates sequences during imagination, planning, and dreaming.


\subsection{11.5.5 Application Design Principles}
\label{\detokenize{part3/ch11_sequence_models:application-design-principles}}
\sphinxAtStartPar
When designing sequence model applications that bridge neuroscience and AI, consider these principles:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Scale Matching}: Ensure your model’s temporal dynamics match the timescale of the neural process being modeled.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interpretability}: Design models that allow insight into their internal representations, particularly for neuroscience applications.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional Transfer}: Apply neuroscience insights to improve AI designs, and use AI to generate testable neuroscience hypotheses.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context Sensitivity}: Account for context effects in sequence processing, as both brains and effective AI models are highly context\sphinxhyphen{}sensitive.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal Integration}: Combine information across modalities, as the brain does not process sequences in isolated channels.

\end{enumerate}

\sphinxAtStartPar
These applications demonstrate how sequence models serve as a bridge between computational neuroscience and artificial intelligence, with each field informing and enhancing the other.


\section{11.6 Code Lab}
\label{\detokenize{part3/ch11_sequence_models:code-lab}}
\sphinxAtStartPar
This hands\sphinxhyphen{}on section provides practical exercises that will help you implement and experiment with sequence models. The exercises progress from basic recurrent networks to transformers, reinforcing the concepts covered in this chapter.


\subsection{11.6.1 Implementing an LSTM from Components}
\label{\detokenize{part3/ch11_sequence_models:implementing-an-lstm-from-components}}
\sphinxAtStartPar
In this exercise, we’ll build an LSTM cell from scratch to understand its internal mechanisms:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{MinMaxScaler}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LSTMCell}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Custom LSTM cell implementation from basic components.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize LSTM cell components.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            input\PYGZus{}size: Dimension of input features}
\PYG{l+s+sd}{            hidden\PYGZus{}size: Dimension of hidden state and cell state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LSTMCell}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Forget gate components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate\PYGZus{}x} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate\PYGZus{}h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Input gate components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate\PYGZus{}x} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate\PYGZus{}h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell candidate components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}x} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output gate components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate\PYGZus{}x} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate\PYGZus{}h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activation functions}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Tanh}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through LSTM cell.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor of shape [batch\PYGZus{}size, input\PYGZus{}size]}
\PYG{l+s+sd}{            state: Tuple (h, c) containing previous hidden state and cell state}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            h\PYGZus{}next: Next hidden state}
\PYG{l+s+sd}{            c\PYGZus{}next: Next cell state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{h\PYGZus{}prev}\PYG{p}{,} \PYG{n}{c\PYGZus{}prev} \PYG{o}{=} \PYG{n}{state}
        
        \PYG{c+c1}{\PYGZsh{} Forget gate: what to forget from cell state}
        \PYG{n}{f\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate\PYGZus{}x}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forget\PYGZus{}gate\PYGZus{}h}\PYG{p}{(}\PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Input gate: what new information to add}
        \PYG{n}{i\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate\PYGZus{}x}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}gate\PYGZus{}h}\PYG{p}{(}\PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell candidate: potential new values to add to cell state}
        \PYG{n}{c\PYGZus{}tilde} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}x}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cell\PYGZus{}h}\PYG{p}{(}\PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Cell state update}
        \PYG{n}{c\PYGZus{}next} \PYG{o}{=} \PYG{n}{f\PYGZus{}t} \PYG{o}{*} \PYG{n}{c\PYGZus{}prev} \PYG{o}{+} \PYG{n}{i\PYGZus{}t} \PYG{o}{*} \PYG{n}{c\PYGZus{}tilde}
        
        \PYG{c+c1}{\PYGZsh{} Output gate: what to output from cell state}
        \PYG{n}{o\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sigmoid}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate\PYGZus{}x}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}gate\PYGZus{}h}\PYG{p}{(}\PYG{n}{h\PYGZus{}prev}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Hidden state update}
        \PYG{n}{h\PYGZus{}next} \PYG{o}{=} \PYG{n}{o\PYGZus{}t} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{c\PYGZus{}next}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{h\PYGZus{}next}\PYG{p}{,} \PYG{n}{c\PYGZus{}next}
    
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LSTM}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    LSTM network using our custom cell.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LSTM}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm\PYGZus{}cell} \PYG{o}{=} \PYG{n}{LSTMCell}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{state}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process sequence through LSTM.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor of shape [batch\PYGZus{}size, seq\PYGZus{}len, input\PYGZus{}size]}
\PYG{l+s+sd}{            state: Initial state tuple (h\PYGZus{}0, c\PYGZus{}0) or None}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            outputs: Tensor of output predictions}
\PYG{l+s+sd}{            state: Final state tuple (h\PYGZus{}n, c\PYGZus{}n)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize hidden state and cell state if not provided}
        \PYG{k}{if} \PYG{n}{state} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{h\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
            \PYG{n}{c\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
            \PYG{n}{state} \PYG{o}{=} \PYG{p}{(}\PYG{n}{h\PYGZus{}t}\PYG{p}{,} \PYG{n}{c\PYGZus{}t}\PYG{p}{)}
        
        \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Process each time step}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{seq\PYGZus{}len}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x\PYGZus{}t} \PYG{o}{=} \PYG{n}{x}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}
            \PYG{n}{h\PYGZus{}t}\PYG{p}{,} \PYG{n}{c\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm\PYGZus{}cell}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{state}\PYG{p}{)}
            \PYG{n}{state} \PYG{o}{=} \PYG{p}{(}\PYG{n}{h\PYGZus{}t}\PYG{p}{,} \PYG{n}{c\PYGZus{}t}\PYG{p}{)}
            \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{h\PYGZus{}t}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Stack outputs along sequence dimension}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply output layer to each time step}
        \PYG{n}{predictions} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{state}

\PYG{c+c1}{\PYGZsh{} Exercise 1: Generate synthetic data and test the LSTM}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{exercise1\PYGZus{}test\PYGZus{}lstm}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a simple sequence dataset and train our custom LSTM.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate sine wave data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a noisy sine wave sequence}
    \PYG{n}{time\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{1000}
    \PYG{n}{series} \PYG{o}{=} \PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{series} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize data}
    \PYG{n}{scaler} \PYG{o}{=} \PYG{n}{MinMaxScaler}\PYG{p}{(}\PYG{n}{feature\PYGZus{}range}\PYG{o}{=}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{series} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{series}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create input/output sequences for prediction}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}sequences}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{seq\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{xs}\PYG{p}{,} \PYG{n}{ys} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{seq\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i} \PYG{o}{+} \PYG{n}{seq\PYGZus{}length}\PYG{p}{)}\PYG{p}{]}
            \PYG{n}{y} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{n}{seq\PYGZus{}length}\PYG{p}{]}
            \PYG{n}{xs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{ys}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{xs}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{ys}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create sequences with length 20}
    \PYG{n}{seq\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{create\PYGZus{}sequences}\PYG{p}{(}\PYG{n}{series}\PYG{p}{,} \PYG{n}{seq\PYGZus{}length}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reshape X for LSTM input [samples, time steps, features]}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split into train and test sets}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to PyTorch tensors}
    \PYG{n}{X\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize model}
    \PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}
    \PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    \PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{LSTM}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss and optimizer}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training parameters}
    \PYG{n}{num\PYGZus{}epochs} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    
    \PYG{c+c1}{\PYGZsh{} For storing metrics}
    \PYG{n}{train\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Mini\PYGZhy{}batch training}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get mini\PYGZhy{}batch}
            \PYG{n}{batch\PYGZus{}X} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            \PYG{n}{batch\PYGZus{}y} \PYG{o}{=} \PYG{n}{y\PYGZus{}train}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{outputs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{batch\PYGZus{}X}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{batch\PYGZus{}y}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward and optimize}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record training loss}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{train\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
            \PYG{n}{train\PYGZus{}loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{train\PYGZus{}outputs}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
            \PYG{n}{train\PYGZus{}losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{train\PYGZus{}loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Print progress}
        \PYG{k}{if} \PYG{p}{(}\PYG{n}{epoch} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch [}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{], Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{train\PYGZus{}loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Test the model}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Get predictions on test set}
        \PYG{n}{test\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}predictions} \PYG{o}{=} \PYG{n}{test\PYGZus{}outputs}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Mean squared error on test set}
        \PYG{n}{test\PYGZus{}mse} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{test\PYGZus{}outputs}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test MSE: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}mse}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize predictions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training loss}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{train\PYGZus{}losses}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MSE Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot predictions on a portion of test data}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{sample\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{sample\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Values}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{test\PYGZus{}predictions}\PYG{p}{[}\PYG{n}{sample\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predictions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LSTM Predictions vs. True Values}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sample Index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Call the exercise function}
\PYG{c+c1}{\PYGZsh{} exercise1\PYGZus{}test\PYGZus{}lstm()}
\end{sphinxVerbatim}

\sphinxAtStartPar
When implemented, this LSTM has several key differences from built\sphinxhyphen{}in PyTorch LSTMs:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
It creates distinct linear layers for each gate component rather than a single matrix multiplication.

\item {} 
\sphinxAtStartPar
It processes one time step at a time rather than using optimized batch operations.

\item {} 
\sphinxAtStartPar
It explicitly implements the gating mechanisms to provide better clarity on how LSTMs work.

\end{enumerate}

\sphinxAtStartPar
Try experimenting with the hyperparameters and extending it with features like:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Bidirectional processing

\item {} 
\sphinxAtStartPar
Multi\sphinxhyphen{}layer architecture

\item {} 
\sphinxAtStartPar
Different initialization schemes

\end{itemize}


\subsection{11.6.2 Building a Self\sphinxhyphen{}Attention Mechanism}
\label{\detokenize{part3/ch11_sequence_models:building-a-self-attention-mechanism}}
\sphinxAtStartPar
In this exercise, we’ll implement a self\sphinxhyphen{}attention mechanism and visualize attention patterns:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SelfAttention}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Self\PYGZhy{}attention module from scratch.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize self\PYGZhy{}attention module.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            embed\PYGZus{}dim: Dimension of input embeddings}
\PYG{l+s+sd}{            num\PYGZus{}heads: Number of attention heads}
\PYG{l+s+sd}{            dropout: Dropout probability}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SelfAttention}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{assert} \PYG{n}{embed\PYGZus{}dim} \PYG{o}{\PYGZpc{}} \PYG{n}{num\PYGZus{}heads} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Embedding dimension must be divisible by number of heads}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{embed\PYGZus{}dim} \PYG{o}{=} \PYG{n}{embed\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads} \PYG{o}{=} \PYG{n}{num\PYGZus{}heads}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim} \PYG{o}{=} \PYG{n}{embed\PYGZus{}dim} \PYG{o}{/}\PYG{o}{/} \PYG{n}{num\PYGZus{}heads}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dropout}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scaling factor}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaling} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim} \PYG{o}{*}\PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply self\PYGZhy{}attention to input.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            x: Input tensor of shape [batch\PYGZus{}size, seq\PYGZus{}len, embed\PYGZus{}dim]}
\PYG{l+s+sd}{            mask: Optional mask tensor of shape [batch\PYGZus{}size, seq\PYGZus{}len, seq\PYGZus{}len]}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            output: Attention output}
\PYG{l+s+sd}{            attention\PYGZus{}weights: Attention weights for visualization}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections}
        \PYG{n}{q} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query\PYGZus{}proj}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{k} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key\PYGZus{}proj}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{v} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value\PYGZus{}proj}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape for multi\PYGZhy{}head attention}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, embed\PYGZus{}dim] \PYGZhy{}\PYGZgt{} [batch\PYGZus{}size, seq\PYGZus{}len, num\PYGZus{}heads, head\PYGZus{}dim]}
        \PYG{n}{q} \PYG{o}{=} \PYG{n}{q}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{n}{k} \PYG{o}{=} \PYG{n}{k}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{n}{v} \PYG{o}{=} \PYG{n}{v}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose to [batch\PYGZus{}size, num\PYGZus{}heads, seq\PYGZus{}len, head\PYGZus{}dim]}
        \PYG{n}{q} \PYG{o}{=} \PYG{n}{q}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{k} \PYG{o}{=} \PYG{n}{k}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{v} \PYG{o}{=} \PYG{n}{v}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute attention scores}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, num\PYGZus{}heads, seq\PYGZus{}len, seq\PYGZus{}len]}
        \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{q}\PYG{p}{,} \PYG{n}{k}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaling}
        
        \PYG{c+c1}{\PYGZsh{} Apply mask if provided}
        \PYG{k}{if} \PYG{n}{mask} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{attention\PYGZus{}scores}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e9}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Softmax to get attention weights}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attention\PYGZus{}scores}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply attention to values}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, num\PYGZus{}heads, seq\PYGZus{}len, head\PYGZus{}dim]}
        \PYG{n}{context} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{,} \PYG{n}{v}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose back and reshape}
        \PYG{c+c1}{\PYGZsh{} [batch\PYGZus{}size, seq\PYGZus{}len, num\PYGZus{}heads, head\PYGZus{}dim] \PYGZhy{}\PYGZgt{} [batch\PYGZus{}size, seq\PYGZus{}len, embed\PYGZus{}dim]}
        \PYG{n}{context} \PYG{o}{=} \PYG{n}{context}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{contiguous}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final linear projection}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}proj}\PYG{p}{(}\PYG{n}{context}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{exercise2\PYGZus{}test\PYGZus{}attention}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Test and visualize the attention mechanism.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create toy sequence data}
    \PYG{n}{vocab\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1000}
    \PYG{n}{embed\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{64}
    \PYG{n}{seq\PYGZus{}len} \PYG{o}{=} \PYG{l+m+mi}{10}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Random token IDs}
    \PYG{n}{token\PYGZus{}ids} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Embedding layer}
    \PYG{n}{embedding} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Embedding}\PYG{p}{(}\PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{embed\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get embeddings}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{embedding}\PYG{p}{(}\PYG{n}{token\PYGZus{}ids}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create self\PYGZhy{}attention layer with 4 heads}
    \PYG{n}{attention} \PYG{o}{=} \PYG{n}{SelfAttention}\PYG{p}{(}\PYG{n}{embed\PYGZus{}dim}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply self\PYGZhy{}attention}
    \PYG{n}{output}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{attention}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create more interpretable example with actual words}
    \PYG{n}{words} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quick}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brown}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{fox}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{jumps}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{over}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{the}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lazy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dog}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{word2idx} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{word}\PYG{p}{:} \PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{word} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Create one\PYGZhy{}hot encodings for words}
    \PYG{n}{one\PYGZus{}hot} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{one\PYGZus{}hot}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}
    
    \PYG{c+c1}{\PYGZsh{} Create simple embeddings by adding position information}
    \PYG{n}{position\PYGZus{}factor} \PYG{o}{=} \PYG{l+m+mf}{0.1}
    \PYG{n}{simple\PYGZus{}embeddings} \PYG{o}{=} \PYG{n}{one\PYGZus{}hot}\PYG{o}{.}\PYG{n}{clone}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{simple\PYGZus{}embeddings}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{position\PYGZus{}factor} \PYG{o}{*} \PYG{n}{i}
    
    \PYG{c+c1}{\PYGZsh{} Expand dimensions for batch}
    \PYG{n}{simple\PYGZus{}embeddings} \PYG{o}{=} \PYG{n}{simple\PYGZus{}embeddings}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply attention to these embeddings}
    \PYG{n}{simple\PYGZus{}attention} \PYG{o}{=} \PYG{n}{SelfAttention}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{simple\PYGZus{}attn\PYGZus{}weights} \PYG{o}{=} \PYG{n}{simple\PYGZus{}attention}\PYG{p}{(}\PYG{n}{simple\PYGZus{}embeddings}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize attention patterns}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot attention weights for each head}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{axes} \PYG{o}{=} \PYG{n}{axes}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{h} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{n}{h}\PYG{p}{]}
        \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{h}\PYG{p}{]}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Head }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{h}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Attention}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Key Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Query Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize attention for the word example}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{simple\PYGZus{}attn\PYGZus{}weights}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Self\PYGZhy{}Attention Patterns for Sentence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{words}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{words}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add attention values}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{words}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{value} \PYG{o}{=} \PYG{n}{simple\PYGZus{}attn\PYGZus{}weights}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{value}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
                    \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{value} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Call the exercise function}
\PYG{c+c1}{\PYGZsh{} exercise2\PYGZus{}test\PYGZus{}attention()}
\end{sphinxVerbatim}

\sphinxAtStartPar
Experiment with the attention mechanism by:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Adding positional encodings to see how they affect attention patterns

\item {} 
\sphinxAtStartPar
Implementing causal attention (masking future tokens) for autoregressive models

\item {} 
\sphinxAtStartPar
Testing with different numbers of attention heads

\item {} 
\sphinxAtStartPar
Visualizing attention patterns on real sentences

\end{enumerate}


\subsection{11.6.3 Training a Small Transformer}
\label{\detokenize{part3/ch11_sequence_models:training-a-small-transformer}}
\sphinxAtStartPar
In this exercise, we’ll implement a small transformer model for sequence prediction:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PositionalEncoding}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Positional encoding for transformer models.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{max\PYGZus{}seq\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{5000}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PositionalEncoding}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{p}\PYG{o}{=}\PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create positional encodings}
        \PYG{n}{pe} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{max\PYGZus{}seq\PYGZus{}length}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n}{position} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}seq\PYGZus{}length}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{div\PYGZus{}term} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{math}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mf}{10000.0}\PYG{p}{)} \PYG{o}{/} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply sine to even positions and cosine to odd positions}
        \PYG{n}{pe}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{position} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}
        \PYG{n}{pe}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{position} \PYG{o}{*} \PYG{n}{div\PYGZus{}term}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add batch dimension and register as buffer (not a parameter)}
        \PYG{n}{pe} \PYG{o}{=} \PYG{n}{pe}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{register\PYGZus{}buffer}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pe}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{pe}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add positional encoding to input.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pe}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{x}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{]}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleTransformer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A simple transformer model for sequence prediction.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{nhead}\PYG{p}{,} \PYG{n}{num\PYGZus{}layers}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleTransformer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Input embedding}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Positional encoding}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{positional\PYGZus{}encoding} \PYG{o}{=} \PYG{n}{PositionalEncoding}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transformer encoder}
        \PYG{n}{encoder\PYGZus{}layers} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{TransformerEncoderLayer}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{nhead}\PYG{p}{,} \PYG{n}{dim\PYGZus{}feedforward}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{n}{dropout}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{transformer\PYGZus{}encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{TransformerEncoder}\PYG{p}{(}\PYG{n}{encoder\PYGZus{}layers}\PYG{p}{,} \PYG{n}{num\PYGZus{}layers}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{src}\PYG{p}{,} \PYG{n}{src\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the transformer.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Args:}
\PYG{l+s+sd}{            src: Input tensor [batch\PYGZus{}size, seq\PYGZus{}len, input\PYGZus{}dim]}
\PYG{l+s+sd}{            src\PYGZus{}mask: Optional mask for padding or attention directionality}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{            output: Predictions [batch\PYGZus{}size, seq\PYGZus{}len, output\PYGZus{}dim]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Embed input}
        \PYG{n}{embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}embedding}\PYG{p}{(}\PYG{n}{src}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add positional encoding}
        \PYG{n}{embedded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{positional\PYGZus{}encoding}\PYG{p}{(}\PYG{n}{embedded}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose for transformer input [seq\PYGZus{}len, batch\PYGZus{}size, d\PYGZus{}model]}
        \PYG{n}{embedded} \PYG{o}{=} \PYG{n}{embedded}\PYG{o}{.}\PYG{n}{permute}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply transformer encoder}
        \PYG{n}{transformer\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{transformer\PYGZus{}encoder}\PYG{p}{(}\PYG{n}{embedded}\PYG{p}{,} \PYG{n}{src\PYGZus{}mask}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transpose back to [batch\PYGZus{}size, seq\PYGZus{}len, d\PYGZus{}model]}
        \PYG{n}{transformer\PYGZus{}output} \PYG{o}{=} \PYG{n}{transformer\PYGZus{}output}\PYG{o}{.}\PYG{n}{permute}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply output layer}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}layer}\PYG{p}{(}\PYG{n}{transformer\PYGZus{}output}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{exercise3\PYGZus{}transformer\PYGZus{}for\PYGZus{}sine}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train a simple transformer for sine wave prediction.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{math}
    
    \PYG{c+c1}{\PYGZsh{} Generate sine wave data}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}sine\PYGZus{}data}\PYG{p}{(}\PYG{n}{num\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}step}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate sine wave data with multiple features.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{data} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{targets} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Random sine wave parameters}
            \PYG{n}{amplitude} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}
            \PYG{n}{frequency} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}
            \PYG{n}{phase} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{math}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Generate time points}
            \PYG{n}{time\PYGZus{}points} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len} \PYG{o}{+} \PYG{n}{prediction\PYGZus{}step}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Generate sine wave}
            \PYG{n}{sine\PYGZus{}wave} \PYG{o}{=} \PYG{n}{amplitude} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{frequency} \PYG{o}{*} \PYG{n}{time\PYGZus{}points} \PYG{o}{+} \PYG{n}{phase}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add noise}
            \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sine\PYGZus{}wave}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{noisy\PYGZus{}sine} \PYG{o}{=} \PYG{n}{sine\PYGZus{}wave} \PYG{o}{+} \PYG{n}{noise}
            
            \PYG{c+c1}{\PYGZsh{} Create features (current value and sin/cos of time)}
            \PYG{n}{features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{seq\PYGZus{}len}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{t} \PYG{o}{=} \PYG{n}{time\PYGZus{}points}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{noisy\PYGZus{}sine}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Current value}
                \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}      \PYG{c+c1}{\PYGZsh{} Time feature 1}
                \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}      \PYG{c+c1}{\PYGZsh{} Time feature 2}
            
            \PYG{c+c1}{\PYGZsh{} Target is future value}
            \PYG{n}{target} \PYG{o}{=} \PYG{n}{sine\PYGZus{}wave}\PYG{p}{[}\PYG{n}{prediction\PYGZus{}step}\PYG{p}{:}\PYG{n}{seq\PYGZus{}len}\PYG{o}{+}\PYG{n}{prediction\PYGZus{}step}\PYG{p}{]}
            
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
            \PYG{n}{targets}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{target}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{targets}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate data}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{generate\PYGZus{}sine\PYGZus{}data}\PYG{p}{(}\PYG{n}{num\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{o}{=}\PYG{l+m+mi}{40}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}step}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create 80/20 train\PYGZhy{}test split}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to PyTorch tensors}
    \PYG{n}{X\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Add feature dimension}
    \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create sequence mask (for causal attention)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}square\PYGZus{}subsequent\PYGZus{}mask}\PYG{p}{(}\PYG{n}{sz}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a mask for causal attention.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{mask} \PYG{o}{=} \PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{triu}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{sz}\PYG{p}{,} \PYG{n}{sz}\PYG{p}{)}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{mask} \PYG{o}{=} \PYG{n}{mask}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}inf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{masked\PYGZus{}fill}\PYG{p}{(}\PYG{n}{mask} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+m+mf}{0.0}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mask}
    
    \PYG{c+c1}{\PYGZsh{} Model parameters}
    \PYG{n}{input\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{3}  \PYG{c+c1}{\PYGZsh{} Current value + 2 time features}
    \PYG{n}{d\PYGZus{}model} \PYG{o}{=} \PYG{l+m+mi}{32}   \PYG{c+c1}{\PYGZsh{} Transformer hidden dimension}
    \PYG{n}{nhead} \PYG{o}{=} \PYG{l+m+mi}{4}      \PYG{c+c1}{\PYGZsh{} Number of attention heads}
    \PYG{n}{num\PYGZus{}layers} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{c+c1}{\PYGZsh{} Number of transformer layers}
    \PYG{n}{output\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{c+c1}{\PYGZsh{} Predicting a single value}
    
    \PYG{c+c1}{\PYGZsh{} Initialize model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleTransformer}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{nhead}\PYG{p}{,} \PYG{n}{num\PYGZus{}layers}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss and optimizer}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training parameters}
    \PYG{n}{num\PYGZus{}epochs} \PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    
    \PYG{c+c1}{\PYGZsh{} For storing metrics}
    \PYG{n}{train\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{total\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Create random permutation}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randperm}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Mini\PYGZhy{}batch training}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get mini\PYGZhy{}batch indices}
            \PYG{n}{batch\PYGZus{}indices} \PYG{o}{=} \PYG{n}{indices}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Get mini\PYGZhy{}batch data}
            \PYG{n}{batch\PYGZus{}X} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{batch\PYGZus{}indices}\PYG{p}{]}
            \PYG{n}{batch\PYGZus{}y} \PYG{o}{=} \PYG{n}{y\PYGZus{}train}\PYG{p}{[}\PYG{n}{batch\PYGZus{}indices}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{batch\PYGZus{}X}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{batch\PYGZus{}y}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward and optimize}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n}{total\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record average training loss}
        \PYG{n}{avg\PYGZus{}loss} \PYG{o}{=} \PYG{n}{total\PYGZus{}loss} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)} \PYG{o}{/} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{train\PYGZus{}losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{avg\PYGZus{}loss}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Print progress}
        \PYG{k}{if} \PYG{p}{(}\PYG{n}{epoch} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch [}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{], Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{avg\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Test the model}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Get predictions on test set}
        \PYG{n}{test\PYGZus{}outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{test\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test MSE: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training loss}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{train\PYGZus{}losses}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MSE Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot example predictions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Select a random example from test set}
    \PYG{n}{example\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{input\PYGZus{}seq} \PYG{o}{=} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Get actual values from input}
    \PYG{n}{true\PYGZus{}future} \PYG{o}{=} \PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{predicted\PYGZus{}future} \PYG{o}{=} \PYG{n}{test\PYGZus{}outputs}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Time points for x\PYGZhy{}axis}
    \PYG{n}{all\PYGZus{}steps} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{input\PYGZus{}seq}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{true\PYGZus{}future}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot input sequence}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{all\PYGZus{}steps}\PYG{p}{[}\PYG{p}{:}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{input\PYGZus{}seq}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{n}{input\PYGZus{}seq}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Sequence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot true future and predictions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{all\PYGZus{}steps}\PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{input\PYGZus{}seq}\PYG{p}{)}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{true\PYGZus{}future}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Future}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{all\PYGZus{}steps}\PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{input\PYGZus{}seq}\PYG{p}{)}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{predicted\PYGZus{}future}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Future}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Transformer Sequence Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Call the exercise function}
\PYG{c+c1}{\PYGZsh{} exercise3\PYGZus{}transformer\PYGZus{}for\PYGZus{}sine()}
\end{sphinxVerbatim}

\sphinxAtStartPar
Extend this exercise by:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Implementing a full encoder\sphinxhyphen{}decoder transformer for sequence\sphinxhyphen{}to\sphinxhyphen{}sequence tasks

\item {} 
\sphinxAtStartPar
Adding an autoregressive inference mode for generating sequences

\item {} 
\sphinxAtStartPar
Experimenting with different attention patterns (local attention, sparse attention)

\item {} 
\sphinxAtStartPar
Trying the transformer on different time series forecasting tasks

\end{enumerate}


\subsection{11.6.4 Neural Sequence Prediction}
\label{\detokenize{part3/ch11_sequence_models:neural-sequence-prediction}}
\sphinxAtStartPar
In this exercise, we’ll implement a model that predicts neural activity patterns, similar to what might be used in brain\sphinxhyphen{}computer interfaces:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{exercise4\PYGZus{}neural\PYGZus{}sequence\PYGZus{}prediction}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Predict neural activity patterns using sequence models.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate synthetic neural data with temporal patterns}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulation parameters}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{20}        \PYG{c+c1}{\PYGZsh{} Number of neurons}
    \PYG{n}{n\PYGZus{}timepoints} \PYG{o}{=} \PYG{l+m+mi}{500}    \PYG{c+c1}{\PYGZsh{} Number of timepoints}
    \PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{l+m+mi}{100}        \PYG{c+c1}{\PYGZsh{} Number of trials/examples}
    
    \PYG{c+c1}{\PYGZsh{} Create base oscillatory patterns (theta, alpha, beta, gamma ranges)}
    \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}
    \PYG{n}{patterns} \PYG{o}{=} \PYG{p}{[}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mf}{0.05} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Theta (\PYGZti{}5Hz)}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Alpha (\PYGZti{}10Hz)}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Beta (\PYGZti{}20Hz)}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mf}{0.4} \PYG{o}{*} \PYG{n}{time}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} Gamma (\PYGZti{}40Hz)}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Generate trials with mixed oscillations}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{trial} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Randomly assign neurons to different oscillatory patterns}
        \PYG{n}{neuron\PYGZus{}patterns} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{patterns}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate activity for each neuron}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Base pattern}
            \PYG{n}{base\PYGZus{}pattern} \PYG{o}{=} \PYG{n}{patterns}\PYG{p}{[}\PYG{n}{neuron\PYGZus{}patterns}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Add phase shift and amplitude variation}
            \PYG{n}{phase\PYGZus{}shift} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}
            \PYG{n}{amplitude} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Generate activity with noise}
            \PYG{n}{activity} \PYG{o}{=} \PYG{n}{amplitude} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{n}{time} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{0.05} \PYG{o}{+} \PYG{l+m+mf}{0.15} \PYG{o}{*} \PYG{n}{neuron\PYGZus{}patterns}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{patterns}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{n}{phase\PYGZus{}shift}\PYG{p}{)}
            \PYG{n}{activity} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Store in data array}
            \PYG{n}{data}\PYG{p}{[}\PYG{n}{trial}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{activity}
    
    \PYG{c+c1}{\PYGZsh{} Split the data into input and target sequences}
    \PYG{n}{sequence\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{50}  \PYG{c+c1}{\PYGZsh{} Input sequence length}
    \PYG{n}{prediction\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} Number of future timepoints to predict}
    
    \PYG{n}{X} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{y} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create input/output pairs}
    \PYG{k}{for} \PYG{n}{trial} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Multiple starting points per trial}
        \PYG{n}{max\PYGZus{}start} \PYG{o}{=} \PYG{n}{n\PYGZus{}timepoints} \PYG{o}{\PYGZhy{}} \PYG{n}{sequence\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction\PYGZus{}length}
        \PYG{n}{step} \PYG{o}{=} \PYG{n}{max\PYGZus{}start} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{5}  \PYG{c+c1}{\PYGZsh{} 5 sequences per trial}
        
        \PYG{k}{for} \PYG{n}{start} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{max\PYGZus{}start}\PYG{p}{,} \PYG{n}{step}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{end} \PYG{o}{=} \PYG{n}{start} \PYG{o}{+} \PYG{n}{sequence\PYGZus{}length}
            \PYG{c+c1}{\PYGZsh{} Input: sequence of length \PYGZsq{}sequence\PYGZus{}length\PYGZsq{}}
            \PYG{n}{X}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{trial}\PYG{p}{,} \PYG{n}{start}\PYG{p}{:}\PYG{n}{end}\PYG{p}{]}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} Target: next \PYGZsq{}prediction\PYGZus{}length\PYGZsq{} timepoints}
            \PYG{n}{y}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{trial}\PYG{p}{,} \PYG{n}{end}\PYG{p}{:}\PYG{n}{end}\PYG{o}{+}\PYG{n}{prediction\PYGZus{}length}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to numpy arrays}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split into train and test}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create PyTorch tensors}
    \PYG{n}{X\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}train} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define a model that combines LSTM and attention}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralSequencePredictor}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{p}{,} \PYG{n}{pred\PYGZus{}len}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{NeuralSequencePredictor}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}dim} \PYG{o}{=} \PYG{n}{input\PYGZus{}dim}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}dim} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}dim}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}dim} \PYG{o}{=} \PYG{n}{output\PYGZus{}dim}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{seq\PYGZus{}len} \PYG{o}{=} \PYG{n}{seq\PYGZus{}len}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pred\PYGZus{}len} \PYG{o}{=} \PYG{n}{pred\PYGZus{}len}
            
            \PYG{c+c1}{\PYGZsh{} LSTM layer}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LSTM}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Self\PYGZhy{}attention layer}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention} \PYG{o}{=} \PYG{n}{SelfAttention}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{n}{n\PYGZus{}heads}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Output projection}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim} \PYG{o}{*} \PYG{n}{pred\PYGZus{}len}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{            }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{            Forward pass through the model.}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{            Args:}
\PYG{l+s+sd}{                x: Input tensor [batch\PYGZus{}size, seq\PYGZus{}len, input\PYGZus{}dim]}
\PYG{l+s+sd}{                }
\PYG{l+s+sd}{            Returns:}
\PYG{l+s+sd}{                predictions: Output tensor [batch\PYGZus{}size, pred\PYGZus{}len, output\PYGZus{}dim]}
\PYG{l+s+sd}{            \PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Process through LSTM}
            \PYG{n}{lstm\PYGZus{}out}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Apply self\PYGZhy{}attention}
            \PYG{n}{attended}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention}\PYG{p}{(}\PYG{n}{lstm\PYGZus{}out}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Project to output}
            \PYG{c+c1}{\PYGZsh{} We only need the final state to start predicting the future}
            \PYG{n}{final\PYGZus{}state} \PYG{o}{=} \PYG{n}{attended}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Project to multiple future timesteps}
            \PYG{n}{projection} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection}\PYG{p}{(}\PYG{n}{final\PYGZus{}state}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Reshape to [batch\PYGZus{}size, pred\PYGZus{}len, output\PYGZus{}dim]}
            \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{projection}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pred\PYGZus{}len}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}dim}\PYG{p}{)}
            
            \PYG{k}{return} \PYG{n}{predictions}
    
    \PYG{c+c1}{\PYGZsh{} Initialize model}
    \PYG{n}{input\PYGZus{}dim} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons}  \PYG{c+c1}{\PYGZsh{} Number of input features (neurons)}
    \PYG{n}{hidden\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{64}        \PYG{c+c1}{\PYGZsh{} Hidden dimension}
    \PYG{n}{output\PYGZus{}dim} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons} \PYG{c+c1}{\PYGZsh{} Number of output features (predicting all neurons)}
    
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{NeuralSequencePredictor}\PYG{p}{(}
        \PYG{n}{input\PYGZus{}dim}\PYG{o}{=}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{hidden\PYGZus{}dim}\PYG{o}{=}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{n}{output\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{seq\PYGZus{}len}\PYG{o}{=}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{,}
        \PYG{n}{pred\PYGZus{}len}\PYG{o}{=}\PYG{n}{prediction\PYGZus{}length}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Loss and optimizer}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training parameters}
    \PYG{n}{num\PYGZus{}epochs} \PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{32}
    
    \PYG{c+c1}{\PYGZsh{} For storing training metrics}
    \PYG{n}{train\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Create random permutation}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randperm}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Mini\PYGZhy{}batch training}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get mini\PYGZhy{}batch indices}
            \PYG{n}{batch\PYGZus{}indices} \PYG{o}{=} \PYG{n}{indices}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{batch\PYGZus{}size}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Get mini\PYGZhy{}batch data}
            \PYG{n}{batch\PYGZus{}X} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{batch\PYGZus{}indices}\PYG{p}{]}
            \PYG{n}{batch\PYGZus{}y} \PYG{o}{=} \PYG{n}{y\PYGZus{}train}\PYG{p}{[}\PYG{n}{batch\PYGZus{}indices}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{batch\PYGZus{}X}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{predictions}\PYG{p}{,} \PYG{n}{batch\PYGZus{}y}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Backward and optimize}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{batch\PYGZus{}indices}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Average loss for the epoch}
        \PYG{n}{avg\PYGZus{}loss} \PYG{o}{=} \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
        \PYG{n}{train\PYGZus{}losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{avg\PYGZus{}loss}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Print progress}
        \PYG{k}{if} \PYG{p}{(}\PYG{n}{epoch} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch [}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{], Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{avg\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate on test set}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{test\PYGZus{}predictions} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{test\PYGZus{}predictions}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test MSE: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training loss}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{train\PYGZus{}losses}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MSE Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Select an example to visualize}
    \PYG{n}{example\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot input sequence for a single neuron}
    \PYG{n}{neuron\PYGZus{}idx} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} First neuron for visualization}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Sequence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length} \PYG{o}{+} \PYG{n}{prediction\PYGZus{}length}\PYG{p}{)}\PYG{p}{,} 
             \PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Future}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length} \PYG{o}{+} \PYG{n}{prediction\PYGZus{}length}\PYG{p}{)}\PYG{p}{,} 
             \PYG{n}{test\PYGZus{}predictions}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Future}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{neuron\PYGZus{}idx}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Activity Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot heatmap of all neurons}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine input and true/predicted future for visualization}
    \PYG{n}{full\PYGZus{}true} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{+} \PYG{n}{prediction\PYGZus{}length}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{full\PYGZus{}true}\PYG{p}{[}\PYG{p}{:}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{]} \PYG{o}{=} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{full\PYGZus{}true}\PYG{p}{[}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{full\PYGZus{}pred} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{+} \PYG{n}{prediction\PYGZus{}length}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{full\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{]} \PYG{o}{=} \PYG{n}{X\PYGZus{}test}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{full\PYGZus{}pred}\PYG{p}{[}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{test\PYGZus{}predictions}\PYG{p}{[}\PYG{n}{example\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate error}
    \PYG{n}{error} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{full\PYGZus{}true} \PYG{o}{\PYGZhy{}} \PYG{n}{full\PYGZus{}pred}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a figure with subplots for all three heatmaps}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot true activity}
    \PYG{n}{im0} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{full\PYGZus{}true}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im0}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot predicted activity}
    \PYG{n}{im1} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{full\PYGZus{}pred}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Neural Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im1}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot prediction error}
    \PYG{n}{im2} \PYG{o}{=} \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{error}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{aspect}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{YlOrRd}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{sequence\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im2}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}\PYG{p}{,} \PYG{n}{fig}

\PYG{c+c1}{\PYGZsh{} Call the exercise function}
\PYG{c+c1}{\PYGZsh{} exercise4\PYGZus{}neural\PYGZus{}sequence\PYGZus{}prediction()}
\end{sphinxVerbatim}

\sphinxAtStartPar
Try extending this neural prediction exercise by:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Using real neural data from open datasets (e.g., Allen Brain Observatory)

\item {} 
\sphinxAtStartPar
Implementing an encoder\sphinxhyphen{}decoder architecture for longer\sphinxhyphen{}term predictions

\item {} 
\sphinxAtStartPar
Adding biological constraints to the model architecture

\item {} 
\sphinxAtStartPar
Visualizing the learned attention patterns to see which neurons interact

\end{enumerate}


\subsection{11.6.5 Exercise Solutions}
\label{\detokenize{part3/ch11_sequence_models:exercise-solutions}}
\sphinxAtStartPar
These exercises provide hands\sphinxhyphen{}on experience with the sequence models described in this chapter. Run them individually to explore and modify the implementations as you learn.

\sphinxAtStartPar
To execute an exercise, uncomment the function call at the end of each code block and run the cell. The exercises progress in difficulty and build upon concepts introduced earlier in the chapter.

\sphinxAtStartPar
By understanding these implementations and experimenting with the code, you’ll gain deeper insights into how sequence models work and how they can be applied to neuroscience and AI tasks.


\section{11.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part3/ch11_sequence_models:take-aways}}
\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Back}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 3 (Spatial Navigation)}: Recurrent neural networks share conceptual similarities with hippocampal place cells’ temporal information processing for predictive navigation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 7 (Information Theory)}: Sequential information processing relies on principles of information flow and entropy across temporal dimensions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 9 (ML Foundations)}: Classical sequence models like HMMs and CRFs form the statistical foundation for modern sequence processing

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 10 (Deep Learning)}: Core neural network operations and backpropagation principles are extended to sequence domains via backpropagation through time

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 12 (Large Language Models)}: Transformer architectures from this chapter form the foundation for LLMs with scaled attention mechanisms

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 13 (Multimodal Models)}: Sequence processing techniques are extended to handle multiple modalities through cross\sphinxhyphen{}attention and embedding alignment

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 14 (Future Directions)}: Innovations in sequence modeling contribute to neuromorphic computing and brain\sphinxhyphen{}inspired AI architectures

\end{itemize}
\end{sphinxadmonition}

\sphinxAtStartPar
This chapter has covered the evolution of sequence models from recurrent networks to transformers, connecting these AI architectures to neural processing mechanisms in the brain. Here are the key insights:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Evolutionary Trajectory}: Sequence modeling has evolved from inherently sequential recurrent networks (RNNs, LSTMs, GRUs) toward parallelizable attention\sphinxhyphen{}based architectures (transformers). This mirrors how the brain combines both recurrent local circuits and distributed global processing.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological Inspiration}: Many features of modern sequence models have parallels in brain function:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Gating mechanisms in LSTMs parallel selective filtering in prefrontal\sphinxhyphen{}basal ganglia circuits

\item {} 
\sphinxAtStartPar
Attention mechanisms resemble selective attention in thalamo\sphinxhyphen{}cortical systems

\item {} 
\sphinxAtStartPar
Multi\sphinxhyphen{}timescale processing occurs in both transformer layers and the cortical hierarchy

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational Trade\sphinxhyphen{}offs}: Different architectures involve trade\sphinxhyphen{}offs between:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Computational efficiency vs. biological plausibility

\item {} 
\sphinxAtStartPar
Sequential processing vs. parallelism

\item {} 
\sphinxAtStartPar
Memory usage vs. contextual range

\item {} 
\sphinxAtStartPar
Inductive biases vs. flexibility

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Integration}: Both biological and artificial systems must solve the problem of integrating information across time. The brain uses recurrent connections with various time constants, while artificial systems use either recurrent connections (RNNs) or explicit attention to previous time points (transformers).

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional Inspiration}: The relationship between neuroscience and AI is increasingly bidirectional:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Neuroscience inspires new AI architectures (e.g., attention mechanisms)

\item {} 
\sphinxAtStartPar
AI models generate hypotheses about neural computation (e.g., predictive coding)

\item {} 
\sphinxAtStartPar
Both fields inform each other through shared mathematical frameworks

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Emergent Properties}: As sequence models scale up, they demonstrate emergent capabilities that weren’t explicitly programmed, similar to how neural systems show emergent cognitive abilities. This has led to foundation models that capture complex sequential dependencies across multiple domains.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Applications Bridging Fields}: Sequence models provide a shared framework for applications spanning neuroscience and AI, from neural decoding and brain\sphinxhyphen{}computer interfaces to natural language processing and time series forecasting.

\end{enumerate}

\sphinxAtStartPar
The rapid advancement of sequence models represents one of the most successful areas of cross\sphinxhyphen{}fertilization between neuroscience and artificial intelligence, with each field benefiting from insights gained in the other.


\section{11.8 Further Reading \& Media}
\label{\detokenize{part3/ch11_sequence_models:further-reading-media}}

\subsection{Key Papers}
\label{\detokenize{part3/ch11_sequence_models:key-papers}}

\subsubsection{Foundational Papers}
\label{\detokenize{part3/ch11_sequence_models:foundational-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hochreiter, S., \& Schmidhuber, J. (1997). \sphinxstylestrong{Long short\sphinxhyphen{}term memory}. \sphinxstyleemphasis{Neural Computation, 9(8)}, 1735\sphinxhyphen{}1780.

\item {} 
\sphinxAtStartPar
Vaswani, A., et al. (2017). \sphinxstylestrong{Attention is all you need}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems}, 5998\sphinxhyphen{}6008.

\item {} 
\sphinxAtStartPar
Sutskever, I., Vinyals, O., \& Le, Q. V. (2014). \sphinxstylestrong{Sequence to sequence learning with neural networks}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems}, 3104\sphinxhyphen{}3112.

\item {} 
\sphinxAtStartPar
Bahdanau, D., Cho, K., \& Bengio, Y. (2015). \sphinxstylestrong{Neural machine translation by jointly learning to align and translate}. \sphinxstyleemphasis{International Conference on Learning Representations}.

\end{itemize}


\subsubsection{Neuroscience Connections}
\label{\detokenize{part3/ch11_sequence_models:neuroscience-connections}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Wang, J., et al. (2018). \sphinxstylestrong{Prefrontal cortex as a meta\sphinxhyphen{}reinforcement learning system}. \sphinxstyleemphasis{Nature Neuroscience, 21(6)}, 860\sphinxhyphen{}868.

\item {} 
\sphinxAtStartPar
Friston, K. (2010). \sphinxstylestrong{The free\sphinxhyphen{}energy principle: A unified brain theory?} \sphinxstyleemphasis{Nature Reviews Neuroscience, 11(2)}, 127\sphinxhyphen{}138.

\item {} 
\sphinxAtStartPar
Kell, A. J., \& McDermott, J. H. (2019). \sphinxstylestrong{Deep neural network models of sensory systems: Windows onto the role of task constraints}. \sphinxstyleemphasis{Current Opinion in Neurobiology, 55}, 121\sphinxhyphen{}132.

\item {} 
\sphinxAtStartPar
Yamins, D. L., \& DiCarlo, J. J. (2016). \sphinxstylestrong{Using goal\sphinxhyphen{}driven deep learning models to understand sensory cortex}. \sphinxstyleemphasis{Nature Neuroscience, 19(3)}, 356\sphinxhyphen{}365.

\end{itemize}


\subsection{Books}
\label{\detokenize{part3/ch11_sequence_models:books}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Goodfellow, I., Bengio, Y., \& Courville, A. (2016). \sphinxstylestrong{Deep Learning}. MIT Press. \sphinxhref{https://www.deeplearningbook.org/}{Online version}

\item {} 
\sphinxAtStartPar
Sejnowski, T. J. (2018). \sphinxstylestrong{The Deep Learning Revolution}. MIT Press.

\item {} 
\sphinxAtStartPar
Williams, R. J., \& Zipser, D. (2006). \sphinxstylestrong{A learning algorithm for continually running fully recurrent neural networks}. \sphinxstyleemphasis{Neural Computation}.

\end{itemize}


\subsection{Online Resources}
\label{\detokenize{part3/ch11_sequence_models:online-resources}}

\subsubsection{Tutorials and Blog Posts}
\label{\detokenize{part3/ch11_sequence_models:tutorials-and-blog-posts}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Karpathy, A. (2015). \sphinxhref{http://karpathy.github.io/2015/05/21/rnn-effectiveness/}{\sphinxstylestrong{The Unreasonable Effectiveness of Recurrent Neural Networks}}

\item {} 
\sphinxAtStartPar
Olah, C. (2015). \sphinxhref{https://colah.github.io/posts/2015-08-Understanding-LSTMs/}{\sphinxstylestrong{Understanding LSTM Networks}}

\item {} 
\sphinxAtStartPar
Alammar, J. (2018). \sphinxhref{https://jalammar.github.io/illustrated-transformer/}{\sphinxstylestrong{The Illustrated Transformer}}

\item {} 
\sphinxAtStartPar
Lillicrap, T. P., \& Santoro, A. (2019). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S0959438818302009}{\sphinxstylestrong{Backpropagation through time and the brain}}

\end{itemize}


\subsubsection{Video Lectures}
\label{\detokenize{part3/ch11_sequence_models:video-lectures}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Lecture Series: \sphinxhref{https://www.youtube.com/playlist?list=PLoROMvodv4rOhcuXMZkNm7j3fVwBBY42z}{\sphinxstylestrong{Stanford CS224n: Natural Language Processing with Deep Learning}}

\item {} 
\sphinxAtStartPar
Lecture Series: \sphinxhref{https://www.youtube.com/playlist?list=PLqYmG7hTraZCDxZ44o4p3N5Anz3lLRVZF}{\sphinxstylestrong{DeepMind x UCL: Deep Learning Lectures}}

\end{itemize}


\subsubsection{Code Repositories}
\label{\detokenize{part3/ch11_sequence_models:code-repositories}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://pytorch.org/tutorials/intermediate/seq2seq\_translation\_tutorial.html}{\sphinxstylestrong{PyTorch Sequence Models Tutorial}}

\item {} 
\sphinxAtStartPar
\sphinxhref{http://nlp.seas.harvard.edu/2018/04/03/attention.html}{\sphinxstylestrong{The Annotated Transformer}} \sphinxhyphen{} Harvard NLP’s implementation of the transformer with detailed annotations

\item {} 
\sphinxAtStartPar
\sphinxhref{https://github.com/huggingface/transformers}{\sphinxstylestrong{Hugging Face Transformers}} \sphinxhyphen{} State\sphinxhyphen{}of\sphinxhyphen{}the\sphinxhyphen{}art transformer implementations

\item {} 
\sphinxAtStartPar
\sphinxhref{https://github.com/nasiridrishi/NeuroAI-Papers}{\sphinxstylestrong{NeuroAI Papers}} \sphinxhyphen{} Curated list of papers at the intersection of neuroscience and AI

\end{itemize}


\subsection{Research Communities and Conferences}
\label{\detokenize{part3/ch11_sequence_models:research-communities-and-conferences}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Conference on Neural Information Processing Systems (NeurIPS)

\item {} 
\sphinxAtStartPar
International Conference on Learning Representations (ICLR)

\item {} 
\sphinxAtStartPar
Organization for Computational Neurosciences (OCNS)

\item {} 
\sphinxAtStartPar
Cognitive Computational Neuroscience (CCN)

\end{itemize}

\sphinxAtStartPar
These resources span from introductory to advanced and cover both theoretical foundations and practical implementations of sequence models and their connections to neuroscience.

\sphinxstepscope


\part{Part IV · Frontier Models}

\sphinxstepscope


\chapter{Chapter 12: Large Language Models \& Fine\sphinxhyphen{}Tuning}
\label{\detokenize{part4/ch12_large_language_models:chapter-12-large-language-models-fine-tuning}}\label{\detokenize{part4/ch12_large_language_models::doc}}
\begin{sphinxadmonition}{note}{Learning Objectives}

\sphinxAtStartPar
By the end of this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Understand} large language model architectures and pretraining strategies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Master} fine\sphinxhyphen{}tuning techniques and parameter\sphinxhyphen{}efficient adaptation methods

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connect} computational language models to human language processing mechanisms

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implement} effective prompting strategies and model adaptations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Evaluate} LLM performance across multiple dimensions and tasks

\end{itemize}
\end{sphinxadmonition}


\section{12.1 Large Language Model Fundamentals}
\label{\detokenize{part4/ch12_large_language_models:large-language-model-fundamentals}}
\sphinxAtStartPar
Large Language Models (LLMs) represent a transformative development in artificial intelligence, capable of generating human\sphinxhyphen{}like text, translating languages, writing creative content, and answering questions in an informative way. This section explores the foundational elements that make these models possible.

\sphinxAtStartPar
\sphinxincludegraphics{{llm_architecture}.svg}
\sphinxstyleemphasis{Figure 12.1: Large Language Model architecture, showing the progression from input tokenization through transformer layers to next token prediction.}


\subsection{12.1.1 Transformer\sphinxhyphen{}Based Architectures}
\label{\detokenize{part4/ch12_large_language_models:transformer-based-architectures}}
\sphinxAtStartPar
Modern LLMs are built on the transformer architecture introduced by Vaswani et al. (2017), which we covered in Chapter 11. While the core architecture remains similar, LLMs incorporate several key modifications and scaling techniques:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{math}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LLMTransformerBlock}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}A single transformer block used in large language models.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d\PYGZus{}model} \PYG{o}{=} \PYG{n}{d\PYGZus{}model}
        
        \PYG{c+c1}{\PYGZsh{} Multi\PYGZhy{}head attention}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MultiheadAttention}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{n\PYGZus{}heads}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{n}{dropout}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward network}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{,} \PYG{n}{d\PYGZus{}ff}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GELU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} GELU activation is common in modern LLMs}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{d\PYGZus{}ff}\PYG{p}{,} \PYG{n}{d\PYGZus{}model}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Layer normalization \PYGZhy{} modern LLMs often use RMSNorm or pre\PYGZhy{}norm}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{d\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dropout}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{attention\PYGZus{}mask}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Apply pre\PYGZhy{}normalization (common in modern LLMs)}
        \PYG{n}{normalized\PYGZus{}x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Self\PYGZhy{}attention with residual connection}
        \PYG{c+c1}{\PYGZsh{} GPT models use causal masking (triangular)}
        \PYG{n}{attn\PYGZus{}output}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention}\PYG{p}{(}
            \PYG{n}{normalized\PYGZus{}x}\PYG{p}{,} \PYG{n}{normalized\PYGZus{}x}\PYG{p}{,} \PYG{n}{normalized\PYGZus{}x}\PYG{p}{,}
            \PYG{n}{attn\PYGZus{}mask}\PYG{o}{=}\PYG{n}{attention\PYGZus{}mask}\PYG{p}{,}
            \PYG{n}{need\PYGZus{}weights}\PYG{o}{=}\PYG{k+kc}{False}
        \PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{attn\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feed\PYGZhy{}forward with pre\PYGZhy{}normalization and residual connection}
        \PYG{n}{normalized\PYGZus{}x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{ff\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feed\PYGZus{}forward}\PYG{p}{(}\PYG{n}{normalized\PYGZus{}x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x} \PYG{o}{+} \PYG{n}{ff\PYGZus{}output}
        
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key architectural innovations in modern LLMs include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Scale}: While early transformer models had \textasciitilde{}100M parameters, modern LLMs range from billions to trillions of parameters.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Architectural Modifications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Pre\sphinxhyphen{}normalization vs. post\sphinxhyphen{}normalization

\item {} 
\sphinxAtStartPar
Activation functions (GELU instead of ReLU)

\item {} 
\sphinxAtStartPar
Attention mechanisms (grouped\sphinxhyphen{}query attention, sliding window attention)

\item {} 
\sphinxAtStartPar
Flash attention and other efficiency improvements

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Auto\sphinxhyphen{}regressive Training}: Most LLMs are trained to predict the next token in a sequence, creating an auto\sphinxhyphen{}regressive language model.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Vocabulary and Tokenization}: LLMs use subword tokenization methods like BPE (Byte\sphinxhyphen{}Pair Encoding) or WordPiece to handle large vocabularies efficiently.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The transformer’s attention mechanism resembles how the brain’s attentional systems selectively focus on relevant information, while the deep network of layers parallels the hierarchical processing in the brain’s language areas.


\subsection{12.1.2 Scaling Laws and Emergent Abilities}
\label{\detokenize{part4/ch12_large_language_models:scaling-laws-and-emergent-abilities}}
\sphinxAtStartPar
One of the most fascinating aspects of LLMs is how their capabilities grow with scale. Kaplan et al. (2020) discovered predictable scaling laws that show how model performance improves as a power\sphinxhyphen{}law function of model size, dataset size, and compute budget.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}scaling\PYGZus{}laws}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize LLM scaling laws relationship.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    
    \PYG{c+c1}{\PYGZsh{} Model sizes (parameters)}
    \PYG{n}{model\PYGZus{}sizes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logspace}\PYG{p}{(}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10\PYGZca{}6 to 10\PYGZca{}12}
    
    \PYG{c+c1}{\PYGZsh{} Loss decreases as a power law with model size}
    \PYG{n}{loss} \PYG{o}{=} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{p}{(}\PYG{n}{model\PYGZus{}sizes} \PYG{o}{*}\PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.076}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{loglog}\PYG{p}{(}\PYG{n}{model\PYGZus{}sizes}\PYG{p}{,} \PYG{n}{loss}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{which}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{both}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ls}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Size (Parameters)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Scaling Law: Loss vs. Model Size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Annotate key model sizes}
    \PYG{n}{models} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.5e9}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{175e9}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PaLM}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{540e9}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.8e12}  \PYG{c+c1}{\PYGZsh{} estimated}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{size} \PYG{o+ow}{in} \PYG{n}{models}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}val} \PYG{o}{=} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{p}{(}\PYG{n}{size} \PYG{o}{*}\PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.076}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{y\PYGZus{}val}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{80}\PYG{p}{,} \PYG{n}{zorder}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{y\PYGZus{}val}\PYG{p}{)}\PYG{p}{,} 
                    \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{,} \PYG{n}{textcoords}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{offset points}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                    \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Emergent abilities appear in LLMs as they scale, including:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{In\sphinxhyphen{}context Learning}: The ability to learn from examples provided in the prompt without parameter updates.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Instruction Following}: Understanding and executing natural language instructions without explicit programming.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chain\sphinxhyphen{}of\sphinxhyphen{}Thought Reasoning}: Breaking down complex problems into steps to arrive at answers, similar to human reasoning processes.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal Capabilities}: Recent models can process and generate content across modalities (text, code, images).

\end{enumerate}

\sphinxAtStartPar
These emergent abilities often appear at specific model size thresholds, with capabilities suddenly manifesting once models reach a certain scale.

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The brain’s language capabilities also emerge from the complex interactions of billions of neurons working together. No single neuron understands language, but the collective network produces sophisticated language processing.


\subsection{12.1.3 Pre\sphinxhyphen{}training Objectives}
\label{\detokenize{part4/ch12_large_language_models:pre-training-objectives}}
\sphinxAtStartPar
LLMs are initially trained with self\sphinxhyphen{}supervised objectives on massive text corpora:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Next Token Prediction (Causal Language Modeling)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The most common approach used in GPT\sphinxhyphen{}style models

\item {} 
\sphinxAtStartPar
Model predicts the next token given previous tokens

\item {} 
\sphinxAtStartPar
Training uses teacher forcing where ground truth previous tokens are provided

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Masked Language Modeling}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Used in BERT\sphinxhyphen{}style models

\item {} 
\sphinxAtStartPar
Random tokens are masked, and the model predicts the masked tokens

\item {} 
\sphinxAtStartPar
Allows bidirectional context but requires additional fine\sphinxhyphen{}tuning for generation

\end{itemize}

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{causal\PYGZus{}language\PYGZus{}modeling\PYGZus{}loss}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{input\PYGZus{}ids}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compute loss for causal language modeling (next token prediction).\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} For autoregressive models, labels are the input shifted right}
        \PYG{n}{labels} \PYG{o}{=} \PYG{n}{input\PYGZus{}ids}\PYG{o}{.}\PYG{n}{clone}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{labels} \PYG{o}{=} \PYG{n}{labels}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Remove first token}
        
        \PYG{c+c1}{\PYGZsh{} Adjust input to predict next token}
        \PYG{n}{input\PYGZus{}ids} \PYG{o}{=} \PYG{n}{input\PYGZus{}ids}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Remove last token}
    
    \PYG{c+c1}{\PYGZsh{} Forward pass to get logits}
    \PYG{n}{logits} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{input\PYGZus{}ids}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute loss (CrossEntropyLoss for token classification)}
    \PYG{n}{loss\PYGZus{}fn} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reshape for loss computation: (batch*seq\PYGZus{}len, vocab\PYGZus{}size)}
    \PYG{n}{logits\PYGZus{}view} \PYG{o}{=} \PYG{n}{logits}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{logits}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{labels\PYGZus{}view} \PYG{o}{=} \PYG{n}{labels}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{loss} \PYG{o}{=} \PYG{n}{loss\PYGZus{}fn}\PYG{p}{(}\PYG{n}{logits\PYGZus{}view}\PYG{p}{,} \PYG{n}{labels\PYGZus{}view}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{loss}
\end{sphinxVerbatim}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{2}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contrastive Learning}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Maps similar inputs closer in embedding space and dissimilar inputs farther apart

\item {} 
\sphinxAtStartPar
Used in some multimodal models like CLIP

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multi\sphinxhyphen{}task Pre\sphinxhyphen{}training}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Combines multiple objectives during pre\sphinxhyphen{}training

\item {} 
\sphinxAtStartPar
May include both generative and discriminative tasks

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The brain learns language through prediction as well, constantly anticipating upcoming words based on context—a process known as predictive processing. When predictions are wrong, the brain updates its internal model.


\subsection{12.1.4 Tokenization Strategies}
\label{\detokenize{part4/ch12_large_language_models:tokenization-strategies}}
\sphinxAtStartPar
Tokenization converts raw text into tokens that serve as the model’s input units. Modern LLMs use subword tokenization methods to balance vocabulary size and coverage:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{GPT2Tokenizer}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}tokenization}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Show how text is tokenized in modern LLMs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load a tokenizer (GPT\PYGZhy{}2 uses Byte\PYGZhy{}Pair Encoding)}
    \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{GPT2Tokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gpt2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Example text}
    \PYG{n}{text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The quick brown fox jumps over the lazy dog. It}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s a pangram!}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Tokenize}
    \PYG{n}{tokens} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{tokenize}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
    \PYG{n}{token\PYGZus{}ids} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print results}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Original text: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{text}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tokenized: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{tokens}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Token IDs: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{token\PYGZus{}ids}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Show uncommon word handling}
    \PYG{n}{uncommon\PYGZus{}text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transformers use self\PYGZhy{}attention for parallelization.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{uncommon\PYGZus{}tokens} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{tokenize}\PYG{p}{(}\PYG{n}{uncommon\PYGZus{}text}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Uncommon text: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{uncommon\PYGZus{}text}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tokenized: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{uncommon\PYGZus{}tokens}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Token merging example (simplified BPE algorithm demonstration)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simplified\PYGZus{}bpe}\PYG{p}{(}\PYG{n}{text}\PYG{p}{,} \PYG{n}{vocab}\PYG{p}{,} \PYG{n}{max\PYGZus{}merges}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Start with characters}
        \PYG{n}{tokens} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{max\PYGZus{}merges}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Find most frequent adjacent pair}
            \PYG{n}{pairs} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{tokens}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{pair} \PYG{o}{=} \PYG{n}{tokens}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+} \PYG{n}{tokens}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}
                \PYG{n}{pairs}\PYG{p}{[}\PYG{n}{pair}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pairs}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{pair}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
            
            \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{pairs}\PYG{p}{:}
                \PYG{k}{break}
                
            \PYG{c+c1}{\PYGZsh{} Get most frequent pair}
            \PYG{n}{best\PYGZus{}pair} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{pairs}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{n}{pairs}\PYG{o}{.}\PYG{n}{get}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Merge the pair in the sequence}
            \PYG{n}{new\PYGZus{}tokens} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            \PYG{n}{i} \PYG{o}{=} \PYG{l+m+mi}{0}
            \PYG{k}{while} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{tokens}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{tokens}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{o+ow}{and} \PYG{n}{tokens}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+} \PYG{n}{tokens}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{==} \PYG{n}{best\PYGZus{}pair}\PYG{p}{:}
                    \PYG{n}{new\PYGZus{}tokens}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{best\PYGZus{}pair}\PYG{p}{)}
                    \PYG{n}{i} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{2}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{new\PYGZus{}tokens}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{tokens}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
                    \PYG{n}{i} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
            
            \PYG{n}{tokens} \PYG{o}{=} \PYG{n}{new\PYGZus{}tokens}
            \PYG{c+c1}{\PYGZsh{} Add to vocabulary}
            \PYG{n}{vocab}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{best\PYGZus{}pair}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{tokens}
    
    \PYG{c+c1}{\PYGZsh{} Demonstrate simplified BPE}
    \PYG{n}{sample\PYGZus{}text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lowerlevel}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{vocab} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{sample\PYGZus{}text}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Start with character vocabulary}
    \PYG{n}{merged\PYGZus{}tokens} \PYG{o}{=} \PYG{n}{simplified\PYGZus{}bpe}\PYG{p}{(}\PYG{n}{sample\PYGZus{}text}\PYG{p}{,} \PYG{n}{vocab}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Simplified BPE example:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Original: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sample\PYGZus{}text}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tokenized: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{merged\PYGZus{}tokens}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Vocabulary: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{vocab}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{tokens}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{token\PYGZus{}ids}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{token\PYGZus{}ids}\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Common tokenization methods include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Byte\sphinxhyphen{}Pair Encoding (BPE)}: Iteratively merges the most frequent pairs of bytes or characters to form new tokens.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{WordPiece}: Similar to BPE but uses a likelihood\sphinxhyphen{}based approach for merging tokens.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{SentencePiece}: Uses BPE or unigram language modeling and performs tokenization without requiring pre\sphinxhyphen{}tokenization.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Tokenization Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Out\sphinxhyphen{}of\sphinxhyphen{}vocabulary words

\item {} 
\sphinxAtStartPar
Non\sphinxhyphen{}English languages and multilingual models

\item {} 
\sphinxAtStartPar
Code and specialized formats

\item {} 
\sphinxAtStartPar
Context window inefficiency

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Humans process language at multiple levels of granularity—phonemes, morphemes, words, and phrases—similar to how tokenizers break text into subword units that capture meaningful language components.


\section{12.2 Fine\sphinxhyphen{}tuning Methods}
\label{\detokenize{part4/ch12_large_language_models:fine-tuning-methods}}
\sphinxAtStartPar
While pre\sphinxhyphen{}trained LLMs possess impressive general capabilities, fine\sphinxhyphen{}tuning allows these models to specialize for specific tasks, domains, or requirements. This section explores various approaches to adapting LLMs, from traditional full fine\sphinxhyphen{}tuning to more efficient techniques.

\sphinxAtStartPar
\sphinxincludegraphics{{fine_tuning_methods}.svg}
\sphinxstyleemphasis{Figure 12.2: Comparison of LLM fine\sphinxhyphen{}tuning methods, from resource\sphinxhyphen{}intensive full fine\sphinxhyphen{}tuning to parameter\sphinxhyphen{}efficient techniques like LoRA and RLHF.}


\subsection{12.2.1 Full Fine\sphinxhyphen{}tuning}
\label{\detokenize{part4/ch12_large_language_models:full-fine-tuning}}
\sphinxAtStartPar
Full fine\sphinxhyphen{}tuning involves updating all parameters of a pre\sphinxhyphen{}trained model on a new dataset. This approach typically yields the best performance but requires substantial computational resources:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{GPT2LMHeadModel}\PYG{p}{,} \PYG{n}{GPT2Tokenizer}\PYG{p}{,} \PYG{n}{Trainer}\PYG{p}{,} \PYG{n}{TrainingArguments}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}dataset}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{full\PYGZus{}finetune\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate full fine\PYGZhy{}tuning of a small LLM.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load pre\PYGZhy{}trained model and tokenizer (using GPT\PYGZhy{}2 small for demonstration)}
    \PYG{n}{model\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gpt2}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} 124M parameters}
    \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{GPT2Tokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{GPT2LMHeadModel}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Special tokens}
    \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{pad\PYGZus{}token} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{eos\PYGZus{}token}
    
    \PYG{c+c1}{\PYGZsh{} Load dataset (for example, a subset of WikiText)}
    \PYG{n}{dataset} \PYG{o}{=} \PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wikitext}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wikitext\PYGZhy{}2\PYGZhy{}raw\PYGZhy{}v1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{split}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train[:1000]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Tokenize the dataset}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{tokenize\PYGZus{}function}\PYG{p}{(}\PYG{n}{examples}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{tokenizer}\PYG{p}{(}\PYG{n}{examples}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{max\PYGZus{}length}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{truncation}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{128}\PYG{p}{)}
    
    \PYG{n}{tokenized\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{map}\PYG{p}{(}\PYG{n}{tokenize\PYGZus{}function}\PYG{p}{,} \PYG{n}{batched}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training arguments}
    \PYG{n}{training\PYGZus{}args} \PYG{o}{=} \PYG{n}{TrainingArguments}\PYG{p}{(}
        \PYG{n}{output\PYGZus{}dir}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}train\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,}
        \PYG{n}{per\PYGZus{}device\PYGZus{}train\PYGZus{}batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,}
        \PYG{n}{warmup\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{500}\PYG{p}{,}
        \PYG{n}{weight\PYGZus{}decay}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
        \PYG{n}{logging\PYGZus{}dir}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./logs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{report\PYGZus{}to}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{none}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} Disable wandb, etc.}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Setup trainer}
    \PYG{n}{trainer} \PYG{o}{=} \PYG{n}{Trainer}\PYG{p}{(}
        \PYG{n}{model}\PYG{o}{=}\PYG{n}{model}\PYG{p}{,}
        \PYG{n}{args}\PYG{o}{=}\PYG{n}{training\PYGZus{}args}\PYG{p}{,}
        \PYG{n}{train\PYGZus{}dataset}\PYG{o}{=}\PYG{n}{tokenized\PYGZus{}dataset}\PYG{p}{,}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train (commented out for demonstration)}
    \PYG{c+c1}{\PYGZsh{} trainer.train()}
    
    \PYG{c+c1}{\PYGZsh{} Save fine\PYGZhy{}tuned model}
    \PYG{c+c1}{\PYGZsh{} trainer.save\PYGZus{}model(\PYGZdq{}./fine\PYGZhy{}tuned\PYGZhy{}gpt2\PYGZdq{})}
    
    \PYG{c+c1}{\PYGZsh{} Memory and compute requirements}
    \PYG{n}{model\PYGZus{}size\PYGZus{}mb} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{4} \PYG{o}{/} \PYG{l+m+mi}{1024} \PYG{o}{/} \PYG{l+m+mi}{1024}  \PYG{c+c1}{\PYGZsh{} 4 bytes per float32}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model size: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{model\PYGZus{}size\PYGZus{}mb}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ MB}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{All parameters updated during training: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{for}\PYG{+w}{ }\PYG{n}{p}\PYG{+w}{ }\PYG{o+ow}{in}\PYG{+w}{ }\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}name}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trainable\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)} \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key considerations for full fine\sphinxhyphen{}tuning:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Resource Requirements}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Memory: Must fit the entire model and optimizer states in memory

\item {} 
\sphinxAtStartPar
Compute: Updates all parameters, requiring substantial computation

\item {} 
\sphinxAtStartPar
Storage: The resulting model is as large as the original

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Catastrophic Forgetting}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Model may lose general capabilities when fine\sphinxhyphen{}tuned on a narrow domain

\item {} 
\sphinxAtStartPar
Mitigated through regularization techniques and careful hyperparameter selection

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Advantages}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Maximum performance potential

\item {} 
\sphinxAtStartPar
Full model adaptation

\item {} 
\sphinxAtStartPar
No architectural constraints

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Full fine\sphinxhyphen{}tuning resembles extensive retraining of neural circuits, where the brain forms specialized pathways for specific skills while potentially weakening other connections. However, the brain is generally better at avoiding catastrophic forgetting through complementary learning systems.


\subsection{12.2.2 Parameter\sphinxhyphen{}Efficient Fine\sphinxhyphen{}Tuning (PEFT)}
\label{\detokenize{part4/ch12_large_language_models:parameter-efficient-fine-tuning-peft}}
\sphinxAtStartPar
Parameter\sphinxhyphen{}efficient fine\sphinxhyphen{}tuning methods modify only a small subset of model parameters, dramatically reducing computational and storage requirements while maintaining performance:


\subsubsection{LoRA (Low\sphinxhyphen{}Rank Adaptation)}
\label{\detokenize{part4/ch12_large_language_models:lora-low-rank-adaptation}}
\sphinxAtStartPar
LoRA, introduced by Hu et al. (2021), inserts trainable low\sphinxhyphen{}rank matrices into the model’s weight matrices, allowing efficient adaptation with minimal parameter updates:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LoRALayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Implementation of Low\PYGZhy{}Rank Adaptation (LoRA) for a linear layer.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{in\PYGZus{}features}\PYG{p}{,} \PYG{n}{out\PYGZus{}features}\PYG{p}{,} \PYG{n}{rank}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rank} \PYG{o}{=} \PYG{n}{rank}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha} \PYG{o}{=} \PYG{n}{alpha}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaling} \PYG{o}{=} \PYG{n}{alpha} \PYG{o}{/} \PYG{n}{rank}
        
        \PYG{c+c1}{\PYGZsh{} Low\PYGZhy{}rank matrices}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}A} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{rank}\PYG{p}{,} \PYG{n}{in\PYGZus{}features}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}B} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{out\PYGZus{}features}\PYG{p}{,} \PYG{n}{rank}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize A with normal and B with zeros}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{normal\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}A}\PYG{p}{,} \PYG{n}{mean}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{std}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}B}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Low\PYGZhy{}rank update: B·A·x}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaling} \PYG{o}{*} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}B} \PYG{o}{@} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora\PYGZus{}A} \PYG{o}{@} \PYG{n}{x}\PYG{p}{)}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LoRALinear}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Linear layer with LoRA adaptation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{linear\PYGZus{}layer}\PYG{p}{,} \PYG{n}{rank}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{linear} \PYG{o}{=} \PYG{n}{linear\PYGZus{}layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora} \PYG{o}{=} \PYG{n}{LoRALayer}\PYG{p}{(}
            \PYG{n}{linear\PYGZus{}layer}\PYG{o}{.}\PYG{n}{in\PYGZus{}features}\PYG{p}{,} 
            \PYG{n}{linear\PYGZus{}layer}\PYG{o}{.}\PYG{n}{out\PYGZus{}features}\PYG{p}{,}
            \PYG{n}{rank}\PYG{o}{=}\PYG{n}{rank}\PYG{p}{,}
            \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Freeze the original layer}
        \PYG{k}{for} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{linear}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{param}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad} \PYG{o}{=} \PYG{k+kc}{False}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Combine original output with LoRA adaptation}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{linear}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lora}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}lora\PYGZus{}to\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{target\PYGZus{}modules}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{rank}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Apply LoRA to specific modules in a transformer model.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Count original trainable parameters}
    \PYG{n}{orig\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)} \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Find and replace target modules with LoRA versions}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{module} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}modules}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{target} \PYG{o+ow}{in} \PYG{n}{name} \PYG{k}{for} \PYG{n}{target} \PYG{o+ow}{in} \PYG{n}{target\PYGZus{}modules}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{module}\PYG{p}{,} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{parent\PYGZus{}name} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
                \PYG{n}{attr\PYGZus{}name} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
                \PYG{n}{parent} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{get\PYGZus{}submodule}\PYG{p}{(}\PYG{n}{parent\PYGZus{}name}\PYG{p}{)}
                \PYG{n+nb}{setattr}\PYG{p}{(}\PYG{n}{parent}\PYG{p}{,} \PYG{n}{attr\PYGZus{}name}\PYG{p}{,} \PYG{n}{LoRALinear}\PYG{p}{(}\PYG{n}{module}\PYG{p}{,} \PYG{n}{rank}\PYG{o}{=}\PYG{n}{rank}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Only LoRA parameters should be trainable}
    \PYG{k}{for} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{param}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad} \PYG{o}{=} \PYG{k+kc}{False}
    
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{module} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}modules}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{module}\PYG{p}{,} \PYG{n}{LoRALayer}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{module}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{param}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad} \PYG{o}{=} \PYG{k+kc}{True}
    
    \PYG{c+c1}{\PYGZsh{} Count new trainable parameters}
    \PYG{n}{lora\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)} \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Original trainable parameters: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{orig\PYGZus{}params}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LoRA trainable parameters: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{lora\PYGZus{}params}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Parameter reduction: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{lora\PYGZus{}params}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{orig\PYGZus{}params}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{l+m+mi}{100}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
LoRA provides several advantages:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Efficiency}: Typically reduces trainable parameters to <1\% of the original model.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Performance}: Achieves comparable performance to full fine\sphinxhyphen{}tuning in many tasks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Modularity}: Multiple LoRA adaptations can be created for different tasks and switched without changing the base model.

\end{enumerate}


\subsubsection{Adapter Layers}
\label{\detokenize{part4/ch12_large_language_models:adapter-layers}}
\sphinxAtStartPar
Adapters insert small trainable modules within the transformer architecture:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AdapterLayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Adapter module with bottleneck architecture.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{adapter\PYGZus{}size}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{adapter\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up\PYGZus{}proj} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{adapter\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{act} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GELU}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize weights}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{normal\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down\PYGZus{}proj}\PYG{o}{.}\PYG{n}{weight}\PYG{p}{,} \PYG{n}{std}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{normal\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up\PYGZus{}proj}\PYG{o}{.}\PYG{n}{weight}\PYG{p}{,} \PYG{n}{std}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down\PYGZus{}proj}\PYG{o}{.}\PYG{n}{bias}\PYG{p}{)}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{init}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up\PYGZus{}proj}\PYG{o}{.}\PYG{n}{bias}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{residual} \PYG{o}{=} \PYG{n}{x}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down\PYGZus{}proj}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{act}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up\PYGZus{}proj}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{residual} \PYG{o}{+} \PYG{n}{x}
\end{sphinxVerbatim}


\subsubsection{Other PEFT Techniques}
\label{\detokenize{part4/ch12_large_language_models:other-peft-techniques}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prefix Tuning}: Prepends trainable vectors to keys and values in attention layers.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prompt Tuning}: Adds trainable “soft prompt” tokens to the input.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BitFit}: Updates only bias terms throughout the network.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: PEFT approaches resemble how the brain can adapt to new tasks by modifying small subnetworks within larger neural circuits while preserving overall structure and general knowledge.


\subsection{12.2.3 Instruction Fine\sphinxhyphen{}tuning}
\label{\detokenize{part4/ch12_large_language_models:instruction-fine-tuning}}
\sphinxAtStartPar
Instruction fine\sphinxhyphen{}tuning adapts models to follow natural language instructions, enhancing their ability to understand and execute user requests:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{prepare\PYGZus{}instruction\PYGZus{}dataset}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Prepare a dataset for instruction fine\PYGZhy{}tuning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Example instruction\PYGZhy{}response pairs}
    \PYG{n}{instruction\PYGZus{}data} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Summarize the following text about climate change.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Global warming is the long\PYGZhy{}term heating of Earth}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s surface observed since the pre\PYGZhy{}industrial period due to human activities, primarily fossil fuel burning, which increases heat\PYGZhy{}trapping greenhouse gas levels in Earth}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s atmosphere. It is most commonly measured as the average increase in Earth}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s global surface temperature. Since the pre\PYGZhy{}industrial period, human activities are estimated to have increased Earth}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s global average temperature by about 1 degree Celsius (1.8 degrees Fahrenheit), a number that is currently increasing by 0.2 degrees Celsius (0.36 degrees Fahrenheit) per decade.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Climate change refers to the long\PYGZhy{}term warming of Earth caused by human activities, especially burning fossil fuels that release greenhouse gases. The planet has warmed about 1°C since pre\PYGZhy{}industrial times, with temperature currently rising 0.2°C per decade.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Translate this English text to French.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The quick brown fox jumps over the lazy dog.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Le rapide renard brun saute par\PYGZhy{}dessus le chien paresseux.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Write a short poem about mountains.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Majestic peaks reach toward the sky,}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Ancient stones that time defy.}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Snow\PYGZhy{}capped sentinels standing tall,}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Whispering winds, nature}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s call.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Format data for model training}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{format\PYGZus{}instruction}\PYG{p}{(}\PYG{n}{item}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{item}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Instruction:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{instruction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Input:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{input}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Response:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Instruction:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{instruction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Response:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{n}{formatted\PYGZus{}data} \PYG{o}{=} \PYG{p}{[}\PYG{n}{format\PYGZus{}instruction}\PYG{p}{(}\PYG{n}{item}\PYG{p}{)} \PYG{k}{for} \PYG{n}{item} \PYG{o+ow}{in} \PYG{n}{instruction\PYGZus{}data}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{raw\PYGZus{}data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{instruction\PYGZus{}data}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{formatted\PYGZus{}data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{formatted\PYGZus{}data}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{samples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{instruction\PYGZus{}data}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of instruction fine\sphinxhyphen{}tuning:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dataset Structure}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Instruction\sphinxhyphen{}output pairs (with optional input)

\item {} 
\sphinxAtStartPar
Diverse task coverage

\item {} 
\sphinxAtStartPar
Consistent formatting

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Training Approach}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Initially trained on human\sphinxhyphen{}written instruction\sphinxhyphen{}response pairs

\item {} 
\sphinxAtStartPar
May use a mix of real and synthetic data

\item {} 
\sphinxAtStartPar
Often combined with PEFT techniques for efficiency

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Performance Considerations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Quality and diversity of instructions matter

\item {} 
\sphinxAtStartPar
Template consistency affects generalization

\item {} 
\sphinxAtStartPar
Task coverage determines capabilities

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Instruction tuning resembles how humans learn to follow verbal instructions, a capability that develops through exposure to diverse command\sphinxhyphen{}response pairings.


\subsection{12.2.4 RLHF and Alignment}
\label{\detokenize{part4/ch12_large_language_models:rlhf-and-alignment}}
\sphinxAtStartPar
Reinforcement Learning from Human Feedback (RLHF) fine\sphinxhyphen{}tunes models to produce outputs that humans prefer, enhancing helpfulness, honesty, and harmlessness:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{rlhf\PYGZus{}process}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate the RLHF process components.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1. Start with an instruction\PYGZhy{}tuned model (SFT)}
    \PYG{n}{sft\PYGZus{}model} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction\PYGZus{}tuned\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 2. Train a reward model from human preferences}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}reward\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Example preference data}
        \PYG{n}{preference\PYGZus{}examples} \PYG{o}{=} \PYG{p}{[}
            \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{How can I improve my programming skills?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chosen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{To improve your programming skills, you should practice regularly, work on real projects, learn from code reviews, study different languages and paradigms, and collaborate with other developers. Consistent practice with increasingly challenging problems will help you grow.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rejected}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Just code more. You}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ll get better eventually.}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Train classifier to predict human preferences}
        \PYG{n}{reward\PYGZus{}model} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trained\PYGZus{}reward\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{reward\PYGZus{}model}
    
    \PYG{c+c1}{\PYGZsh{} 3. Fine\PYGZhy{}tune with reinforcement learning}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{rl\PYGZus{}fine\PYGZus{}tuning}\PYG{p}{(}\PYG{n}{sft\PYGZus{}model}\PYG{p}{,} \PYG{n}{reward\PYGZus{}model}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} PPO algorithm components}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}model\PYGZus{}outputs}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{,} \PYG{n}{model}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Generate multiple responses using the model}
            \PYG{k}{return} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Response 1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Response 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Response 3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}rewards}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{,} \PYG{n}{reward\PYGZus{}model}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Score responses using the reward model}
            \PYG{k}{return} \PYG{p}{[}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{]}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}policy}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{responses}\PYG{p}{,} \PYG{n}{rewards}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Update model to increase probability of high\PYGZhy{}reward responses}
            \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{updated\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} RL training loop (simplified)}
        \PYG{n}{rlhf\PYGZus{}model} \PYG{o}{=} \PYG{n}{sft\PYGZus{}model}
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{prompts} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Example prompt 1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Example prompt 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{k}{for} \PYG{n}{prompt} \PYG{o+ow}{in} \PYG{n}{prompts}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Generate responses from current policy}
                \PYG{n}{responses} \PYG{o}{=} \PYG{n}{get\PYGZus{}model\PYGZus{}outputs}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{,} \PYG{n}{rlhf\PYGZus{}model}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Compute rewards}
                \PYG{n}{rewards} \PYG{o}{=} \PYG{n}{compute\PYGZus{}rewards}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{,} \PYG{n}{reward\PYGZus{}model}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update policy to maximize rewards}
                \PYG{n}{rlhf\PYGZus{}model} \PYG{o}{=} \PYG{n}{update\PYGZus{}policy}\PYG{p}{(}\PYG{n}{rlhf\PYGZus{}model}\PYG{p}{,} \PYG{n}{responses}\PYG{p}{,} \PYG{n}{rewards}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{rlhf\PYGZus{}model}
    
    \PYG{c+c1}{\PYGZsh{} Execute RLHF pipeline}
    \PYG{n}{reward\PYGZus{}model} \PYG{o}{=} \PYG{n}{train\PYGZus{}reward\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{rlhf\PYGZus{}model} \PYG{o}{=} \PYG{n}{rl\PYGZus{}fine\PYGZus{}tuning}\PYG{p}{(}\PYG{n}{sft\PYGZus{}model}\PYG{p}{,} \PYG{n}{reward\PYGZus{}model}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{supervised\PYGZus{}fine\PYGZus{}tuned}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sft\PYGZus{}model}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reward\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{reward\PYGZus{}model}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rlhf\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rlhf\PYGZus{}model}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
The RLHF process involves:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Supervised Fine\sphinxhyphen{}Tuning (SFT)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Train the model on high\sphinxhyphen{}quality examples

\item {} 
\sphinxAtStartPar
Establishes base capabilities for following instructions

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reward Model Training}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Human evaluators rate or rank model outputs

\item {} 
\sphinxAtStartPar
Train a reward model to predict human preferences

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{RL Optimization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Fine\sphinxhyphen{}tune the SFT model using Proximal Policy Optimization (PPO)

\item {} 
\sphinxAtStartPar
Optimize for reward model scores while constraining divergence from original model (via KL penalty)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Reward hacking (optimizing for reward signals rather than true intent)

\item {} 
\sphinxAtStartPar
Alignment tax (trade\sphinxhyphen{}off between capability and alignment)

\item {} 
\sphinxAtStartPar
Distribution shifts

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: RLHF parallels how humans learn social norms and behavioral guidelines through feedback from others. The brain’s dopaminergic systems provide reinforcement signals, strengthening neural pathways that lead to positive outcomes and weakening those that lead to negative consequences.


\section{12.3 Prompting Techniques}
\label{\detokenize{part4/ch12_large_language_models:prompting-techniques}}
\sphinxAtStartPar
Prompting has emerged as a powerful way to control and direct LLM behavior without modifying model weights. Effective prompting techniques can dramatically improve model performance on specific tasks and enable capabilities that weren’t explicitly trained.

\sphinxAtStartPar
\sphinxincludegraphics{{prompting_techniques}.svg}
\sphinxstyleemphasis{Figure 12.3: Various prompting techniques for LLMs, from zero\sphinxhyphen{}shot to chain\sphinxhyphen{}of\sphinxhyphen{}thought prompting and system prompt design.}


\subsection{12.3.1 Zero\sphinxhyphen{}Shot and Few\sphinxhyphen{}Shot Learning}
\label{\detokenize{part4/ch12_large_language_models:zero-shot-and-few-shot-learning}}
\sphinxAtStartPar
One of the most remarkable capabilities of large language models is their ability to perform tasks with minimal or no examples:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}prompting\PYGZus{}techniques}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate zero\PYGZhy{}shot and few\PYGZhy{}shot prompting techniques.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Zero\PYGZhy{}shot prompting: no examples provided}
    \PYG{n}{zero\PYGZus{}shot\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Classify the following text into one of these categories: }
\PYG{l+s+s2}{    Business, Politics, Technology, Sports, Entertainment.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Text: Apple announced their new M3 chip, which they claim offers significant }
\PYG{l+s+s2}{    performance improvements over the previous generation.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Category:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Few\PYGZhy{}shot prompting: providing examples to establish a pattern}
    \PYG{n}{few\PYGZus{}shot\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Classify the text into one of these categories: }
\PYG{l+s+s2}{    Business, Politics, Technology, Sports, Entertainment.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Text: The Federal Reserve has decided to keep interest rates unchanged this quarter.}
\PYG{l+s+s2}{    Category: Business}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Text: The baseball team won their third consecutive championship last night.}
\PYG{l+s+s2}{    Category: Sports}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Text: The prime minister announced new climate initiatives yesterday.}
\PYG{l+s+s2}{    Category: Politics}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Text: Apple announced their new M3 chip, which they claim offers significant }
\PYG{l+s+s2}{    performance improvements over the previous generation.}
\PYG{l+s+s2}{    Category:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Format comparison for demonstration purposes}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{zero\PYGZus{}shot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{zero\PYGZus{}shot\PYGZus{}prompt}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{zero\PYGZus{}shot\PYGZus{}prompt}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{expected\PYGZus{}answer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Technology}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{few\PYGZus{}shot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{few\PYGZus{}shot\PYGZus{}prompt}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{few\PYGZus{}shot\PYGZus{}prompt}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{expected\PYGZus{}answer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples\PYGZus{}provided}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{3}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subsubsection{Zero\sphinxhyphen{}Shot Learning}
\label{\detokenize{part4/ch12_large_language_models:zero-shot-learning}}
\sphinxAtStartPar
Zero\sphinxhyphen{}shot prompting involves asking the model to perform a task without any demonstrations:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{When to Use}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Simple, common tasks that the model has likely encountered in training

\item {} 
\sphinxAtStartPar
When context length is limited

\item {} 
\sphinxAtStartPar
For initial exploration of model capabilities

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Limitations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Less predictable performance

\item {} 
\sphinxAtStartPar
Lower accuracy on complex or nuanced tasks

\item {} 
\sphinxAtStartPar
Sensitive to exact wording of the prompt

\end{itemize}

\end{enumerate}


\subsubsection{Few\sphinxhyphen{}Shot Learning}
\label{\detokenize{part4/ch12_large_language_models:few-shot-learning}}
\sphinxAtStartPar
Few\sphinxhyphen{}shot prompting provides examples of the desired input\sphinxhyphen{}output pattern:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{When to Use}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Complex tasks requiring specific formats or reasoning

\item {} 
\sphinxAtStartPar
When consistency in outputs is important

\item {} 
\sphinxAtStartPar
To guide the model toward specific approaches

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Best Practices}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Use diverse, representative examples

\item {} 
\sphinxAtStartPar
Match example format exactly to your desired output

\item {} 
\sphinxAtStartPar
Order examples from simple to complex

\item {} 
\sphinxAtStartPar
Include both positive and negative examples when appropriate

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Limitations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Consumes token context

\item {} 
\sphinxAtStartPar
May not generalize well beyond provided examples

\item {} 
\sphinxAtStartPar
Can suffer from recency bias (favoring later examples)

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Few\sphinxhyphen{}shot learning resembles how humans rapidly adapt to new tasks after seeing just a few examples, a capability believed to rely on the brain’s meta\sphinxhyphen{}learning mechanisms in the prefrontal cortex.


\subsection{12.3.2 Chain\sphinxhyphen{}of\sphinxhyphen{}Thought Prompting}
\label{\detokenize{part4/ch12_large_language_models:chain-of-thought-prompting}}
\sphinxAtStartPar
Chain\sphinxhyphen{}of\sphinxhyphen{}Thought (CoT) prompting, introduced by Wei et al. (2022), encourages models to break down complex problems into step\sphinxhyphen{}by\sphinxhyphen{}step reasoning:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}cot\PYGZus{}prompting}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate chain\PYGZhy{}of\PYGZhy{}thought prompting for complex reasoning.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Standard prompting (direct question)}
    \PYG{n}{standard\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Question: Roger has 5 tennis balls. He buys 2 more cans of tennis balls. }
\PYG{l+s+s2}{    Each can has 3 tennis balls. How many tennis balls does he have now?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Answer:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Chain\PYGZhy{}of\PYGZhy{}thought prompting (with reasoning steps)}
    \PYG{n}{cot\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Question: Roger has 5 tennis balls. He buys 2 more cans of tennis balls. }
\PYG{l+s+s2}{    Each can has 3 tennis balls. How many tennis balls does he have now?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think through this step by step:}
\PYG{l+s+s2}{    1. Initially, Roger has 5 tennis balls.}
\PYG{l+s+s2}{    2. He buys 2 cans of tennis balls.}
\PYG{l+s+s2}{    3. Each can has 3 tennis balls.}
\PYG{l+s+s2}{    4. So from the cans, he gets 2 * 3 = 6 tennis balls.}
\PYG{l+s+s2}{    5. In total, he has 5 + 6 = 11 tennis balls.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Answer: 11}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Question: Sarah has 3 boxes of books. Each box has 8 books. She gives away }
\PYG{l+s+s2}{    7 books to her friend. How many books does she have left?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think through this step by step:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Few\PYGZhy{}shot CoT (providing CoT examples)}
    \PYG{n}{few\PYGZus{}shot\PYGZus{}cot} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Question: Roger has 5 tennis balls. He buys 2 more cans of tennis balls. }
\PYG{l+s+s2}{    Each can has 3 tennis balls. How many tennis balls does he have now?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think through this step by step:}
\PYG{l+s+s2}{    1. Initially, Roger has 5 tennis balls.}
\PYG{l+s+s2}{    2. He buys 2 cans of tennis balls.}
\PYG{l+s+s2}{    3. Each can has 3 tennis balls.}
\PYG{l+s+s2}{    4. So from the cans, he gets 2 * 3 = 6 tennis balls.}
\PYG{l+s+s2}{    5. In total, he has 5 + 6 = 11 tennis balls.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Answer: 11}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Question: Sarah has 3 boxes of books. Each box has 8 books. She gives away }
\PYG{l+s+s2}{    7 books to her friend. How many books does she have left?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think through this step by step:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Zero\PYGZhy{}shot CoT with trigger phrase}
    \PYG{n}{zero\PYGZus{}shot\PYGZus{}cot} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Question: Sarah has 3 boxes of books. Each box has 8 books. She gives away }
\PYG{l+s+s2}{    7 books to her friend. How many books does she have left?}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think through this step by step:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{standard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{standard\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cot\PYGZus{}example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cot\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{few\PYGZus{}shot\PYGZus{}cot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{few\PYGZus{}shot\PYGZus{}cot}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{zero\PYGZus{}shot\PYGZus{}cot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{zero\PYGZus{}shot\PYGZus{}cot}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of Chain\sphinxhyphen{}of\sphinxhyphen{}Thought prompting:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implementation Approaches}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Few\sphinxhyphen{}shot CoT: Provide examples with reasoning steps

\item {} 
\sphinxAtStartPar
Zero\sphinxhyphen{}shot CoT: Use trigger phrases like “Let’s think step by step”

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}consistency: Generate multiple reasoning paths and take majority vote

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Effectiveness}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Dramatically improves performance on math, logic, and complex reasoning

\item {} 
\sphinxAtStartPar
Helps with tasks requiring multi\sphinxhyphen{}step reasoning or planning

\item {} 
\sphinxAtStartPar
Makes reasoning explicit and auditable

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Variations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Tree of Thoughts: Explore multiple reasoning branches

\item {} 
\sphinxAtStartPar
Program\sphinxhyphen{}of\sphinxhyphen{}Thoughts: Use code\sphinxhyphen{}like structured reasoning

\item {} 
\sphinxAtStartPar
Verification of Thoughts: Self\sphinxhyphen{}verify each step

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Chain\sphinxhyphen{}of\sphinxhyphen{}Thought resembles human explicit reasoning processes where complex problems are broken down into manageable steps, a process associated with the prefrontal cortex’s role in planning and problem\sphinxhyphen{}solving.


\subsection{12.3.3 Prompt Engineering Best Practices}
\label{\detokenize{part4/ch12_large_language_models:prompt-engineering-best-practices}}
\sphinxAtStartPar
Crafting effective prompts requires understanding how LLMs process and respond to text:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}prompt\PYGZus{}optimization}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Show how prompt structure affects model performance.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Basic prompt}
    \PYG{n}{basic\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    Extract the companies mentioned in this text: }
\PYG{l+s+s2}{    Apple announced a partnership with Microsoft to improve cloud integration.}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Improved structured prompt}
    \PYG{n}{structured\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    TASK: Extract all company names mentioned in the text below.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    FORMAT: Return a JSON array with the company names: [}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Company1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{, }\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Company2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{]}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    TEXT: Apple announced a partnership with Microsoft to improve cloud integration.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    COMPANIES:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Role\PYGZhy{}based prompt}
    \PYG{n}{role\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are an expert in named entity recognition specialized in identifying }
\PYG{l+s+s2}{    organization names. Extract all companies mentioned in the following text.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    TEXT: Apple announced a partnership with Microsoft to improve cloud integration.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    Return only the company names as a comma\PYGZhy{}separated list.}
\PYG{l+s+s2}{    COMPANIES:}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{basic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{basic\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{structured}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{structured\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{role\PYGZus{}based}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{role\PYGZus{}prompt}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Best practices for prompt engineering include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Clear Instructions}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Be specific about task requirements

\item {} 
\sphinxAtStartPar
Define format expectations explicitly

\item {} 
\sphinxAtStartPar
Use numbered lists for multi\sphinxhyphen{}part instructions

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context and Constraints}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Provide relevant context

\item {} 
\sphinxAtStartPar
Set boundaries and limitations

\item {} 
\sphinxAtStartPar
Specify word/character limits if needed

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Examples and Demonstrations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Include diverse examples (avoid biasing toward specific patterns)

\item {} 
\sphinxAtStartPar
Match example format to desired output

\item {} 
\sphinxAtStartPar
Start with simpler examples before complex ones

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural Elements}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Use delimiters to separate sections: “```”, “\#\#\#”, “TEXT:”, etc.

\item {} 
\sphinxAtStartPar
Label components explicitly: “INPUT:”, “OUTPUT:”, “REASONING:”

\item {} 
\sphinxAtStartPar
Utilize formatting like bullets, numbering, and indentation

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Iterative Refinement}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Test and revise prompts based on outputs

\item {} 
\sphinxAtStartPar
Identify and address weaknesses or biases

\item {} 
\sphinxAtStartPar
Build on successful patterns

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Prompt engineering resembles how humans craft instructions for others, requiring an understanding of shared context, clear communication, and adaptive refinement based on feedback.


\subsection{12.3.4 System Prompts and Persona Design}
\label{\detokenize{part4/ch12_large_language_models:system-prompts-and-persona-design}}
\sphinxAtStartPar
System prompts set the overall behavior and personality of the model, establishing its role and response style:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}system\PYGZus{}prompts}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Show different system prompts and their effects on model behavior.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Standard helpful assistant}
    \PYG{n}{standard\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are a helpful, harmless, and honest assistant. You answer questions }
\PYG{l+s+s2}{    accurately and concisely based on the best available information.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    User: What are the planets in our solar system?}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Expert persona}
    \PYG{n}{expert\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are an expert astronomer with a PhD in planetary science and 15 years }
\PYG{l+s+s2}{    of experience at NASA. You communicate complex astronomical concepts clearly }
\PYG{l+s+s2}{    while maintaining scientific accuracy. Include relevant data and cite your }
\PYG{l+s+s2}{    sources when appropriate.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    User: What are the planets in our solar system?}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Tailored for children}
    \PYG{n}{child\PYGZus{}friendly\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are a friendly science teacher for elementary school children. You explain }
\PYG{l+s+s2}{    scientific concepts in simple, engaging ways using analogies, fun facts, and }
\PYG{l+s+s2}{    age\PYGZhy{}appropriate language. Keep answers short, around 3\PYGZhy{}4 sentences, and add }
\PYG{l+s+s2}{    a touch of excitement to spark curiosity.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    User: What are the planets in our solar system?}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Constrained role}
    \PYG{n}{constrained\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are an assistant that only provides information about astronomy and space. }
\PYG{l+s+s2}{    If asked about any other topic, politely explain that you can only discuss }
\PYG{l+s+s2}{    astronomy\PYGZhy{}related questions. Never break character, regardless of how the user }
\PYG{l+s+s2}{    phrases their request.}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    User: What are the planets in our solar system?}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{standard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{standard\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{expert}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{expert\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{child\PYGZus{}friendly}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{child\PYGZus{}friendly\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{constrained}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{constrained\PYGZus{}prompt}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of system prompts and persona design:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Role Definition}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Establish expertise and background

\item {} 
\sphinxAtStartPar
Set tone, style, and format expectations

\item {} 
\sphinxAtStartPar
Define operational constraints

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Behavioral Guidelines}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Specify response length and depth

\item {} 
\sphinxAtStartPar
Set ethical boundaries

\item {} 
\sphinxAtStartPar
Configure helpfulness vs. conciseness balance

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Purpose\sphinxhyphen{}Specific Personae}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Technical expert (code, science, medical)

\item {} 
\sphinxAtStartPar
Educational assistant (simplified explanations)

\item {} 
\sphinxAtStartPar
Creative collaborator (brainstorming, writing)

\item {} 
\sphinxAtStartPar
Task\sphinxhyphen{}specific tools (data analysis, summarization)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Techniques for Testing and Refinement}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Red\sphinxhyphen{}teaming: Test persona boundaries with challenging queries

\item {} 
\sphinxAtStartPar
Comparative evaluation: Test same queries with different personae

\item {} 
\sphinxAtStartPar
Iterative enhancement: Refine based on observed behaviors

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: System prompts tap into similar mechanisms as social role\sphinxhyphen{}playing in humans, where people adjust their language, vocabulary, and behavior based on social context and professional roles, a capability supported by the brain’s theory of mind and social cognition networks.


\section{12.4 Neural Basis of Language}
\label{\detokenize{part4/ch12_large_language_models:neural-basis-of-language}}
\sphinxAtStartPar
Understanding how the human brain processes language can provide insights into both the capabilities and limitations of large language models. This section explores the parallels between neural language processing and computational language models.

\sphinxAtStartPar
\sphinxincludegraphics{{brain_language_areas}.svg}
\sphinxstyleemphasis{Figure 12.4: Key language processing areas in the human brain and their functional parallels in large language models.}


\subsection{12.4.1 Language Areas in the Brain}
\label{\detokenize{part4/ch12_large_language_models:language-areas-in-the-brain}}
\sphinxAtStartPar
The brain’s language network involves several specialized regions that work in concert to process and produce language:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{brain\PYGZus{}language\PYGZus{}network}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Describe the main brain regions involved in language processing.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{language\PYGZus{}areas} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s Area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{location}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Left inferior frontal gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{functions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Speech production}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Syntactic processing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grammatical operations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{damage\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s aphasia: slow, effortful speech with simplified grammar}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Feed\PYGZhy{}forward networks and output layers in language generation}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Wernicke}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s Area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{location}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Left superior temporal gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{functions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Language comprehension}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic processing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Word meaning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{damage\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Wernicke}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s aphasia: fluent but meaningless speech, poor comprehension}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Self\PYGZhy{}attention mechanisms and contextual representations}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Angular Gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{location}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Posterior part of the inferior parietal lobule}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{functions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic integration}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cross\PYGZhy{}modal associations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reading comprehension}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{damage\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Alexia, agraphia, anomia (naming difficulties)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cross\PYGZhy{}attention between different embedding spaces}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Arcuate Fasciculus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{location}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{White matter tract connecting Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s and Wernicke}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s areas}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{functions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Connects language comprehension and production}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Facilitates repetition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{damage\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conduction aphasia: difficulty repeating heard phrases}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information flow from encoder to decoder in seq2seq models}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temporal Lobe}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{location}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Middle and inferior temporal regions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{functions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic memory}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Word meaning storage}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Concept relations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{damage\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic dementia, naming deficits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}parallel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Embedding representations in the model}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{language\PYGZus{}areas}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key insights about brain language processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distributed Processing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Language processing involves multiple brain regions working in parallel

\item {} 
\sphinxAtStartPar
Different aspects of language (phonology, semantics, syntax) engage different neural circuits

\item {} 
\sphinxAtStartPar
Bilateral involvement with left\sphinxhyphen{}hemisphere dominance in most people

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Organization}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Primary auditory cortex processes basic speech sounds

\item {} 
\sphinxAtStartPar
Secondary areas recognize phonemes and word forms

\item {} 
\sphinxAtStartPar
Association areas integrate meaning and context

\item {} 
\sphinxAtStartPar
Frontal regions coordinate grammar and planning

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connection to LLMs}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
LLMs’ distributed representation system parallels the brain’s semantic networks

\item {} 
\sphinxAtStartPar
Layer\sphinxhyphen{}wise processing in deep networks resembles cortical hierarchies

\item {} 
\sphinxAtStartPar
Attention mechanisms parallel neural selective enhancement

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The specialized but interconnected language regions in the brain mirror how LLMs develop specialized components within their network structure during training.


\subsection{12.4.2 Predictive Processing in Language}
\label{\detokenize{part4/ch12_large_language_models:predictive-processing-in-language}}
\sphinxAtStartPar
The brain actively predicts upcoming linguistic elements rather than simply reacting to input:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}predictive\PYGZus{}processing}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate predictive processing in language comprehension.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples of sentences with varying predictability}
    \PYG{n}{high\PYGZus{}predictability} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The chef cooked the meal in the \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}.}\PYG{l+s+s2}{\PYGZdq{}} \PYG{c+c1}{\PYGZsh{} kitchen}
    \PYG{n}{medium\PYGZus{}predictability} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The student wrote notes with a \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}.}\PYG{l+s+s2}{\PYGZdq{}} \PYG{c+c1}{\PYGZsh{} pen/pencil}
    \PYG{n}{low\PYGZus{}predictability} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The person found a \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}.}\PYG{l+s+s2}{\PYGZdq{}} \PYG{c+c1}{\PYGZsh{} many possibilities}
    
    \PYG{c+c1}{\PYGZsh{} Simplified N400 response simulation}
    \PYG{c+c1}{\PYGZsh{} (N400 is an ERP component that indexes semantic predictability)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{n}{sentence\PYGZus{}completion\PYGZus{}predictability}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Higher predictability = lower N400 amplitude}
        \PYG{k}{if} \PYG{n}{sentence\PYGZus{}completion\PYGZus{}predictability} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mf}{0.2}  \PYG{c+c1}{\PYGZsh{} Small N400 (expected word)}
        \PYG{k}{elif} \PYG{n}{sentence\PYGZus{}completion\PYGZus{}predictability} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mf}{0.5}  \PYG{c+c1}{\PYGZsh{} Moderate N400}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mf}{0.9}  \PYG{c+c1}{\PYGZsh{} Large N400 (unexpected word)}
    
    \PYG{c+c1}{\PYGZsh{} Predictive processing illustration}
    \PYG{n}{example\PYGZus{}sentences} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{high\PYGZus{}predictability}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{completions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{kitchen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{oven}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{microwave}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n400\PYGZus{}amplitudes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{medium\PYGZus{}predictability}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{completions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pencil}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{typewriter}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rock}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n400\PYGZus{}amplitudes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{low\PYGZus{}predictability}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{completions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{book}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{car}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{friend}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{solution}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n400\PYGZus{}amplitudes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{simulate\PYGZus{}n400}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Parallel with LLM next\PYGZhy{}token prediction}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{llm\PYGZus{}next\PYGZus{}token\PYGZus{}prediction}\PYG{p}{(}\PYG{n}{sentence}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simplified example of how LLMs predict next tokens}
        \PYG{c+c1}{\PYGZsh{} In reality, they would output a probability distribution over the vocabulary}
        \PYG{k}{if} \PYG{n}{sentence} \PYG{o}{==} \PYG{n}{high\PYGZus{}predictability}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{kitchen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{oven}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{\PYGZcb{}}
        \PYG{k}{elif} \PYG{n}{sentence} \PYG{o}{==} \PYG{n}{medium\PYGZus{}predictability}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pencil}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{marker}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{book}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{car}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dog}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{key}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{\PYGZcb{}}
            \PYG{c+c1}{\PYGZsh{} More uniform distribution for low predictability}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{example\PYGZus{}sentences}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}predictions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{llm\PYGZus{}next\PYGZus{}token\PYGZus{}prediction}\PYG{p}{(}\PYG{n}{high\PYGZus{}predictability}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medium\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{llm\PYGZus{}next\PYGZus{}token\PYGZus{}prediction}\PYG{p}{(}\PYG{n}{medium\PYGZus{}predictability}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low\PYGZus{}pred}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{llm\PYGZus{}next\PYGZus{}token\PYGZus{}prediction}\PYG{p}{(}\PYG{n}{low\PYGZus{}predictability}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of predictive processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Evidence}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
N400 ERP component: Larger amplitude for unexpected words

\item {} 
\sphinxAtStartPar
Reduced neural activity for predictable language elements

\item {} 
\sphinxAtStartPar
Prediction error signals drive learning

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Prediction}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Higher\sphinxhyphen{}level predictions about meaning and intent

\item {} 
\sphinxAtStartPar
Mid\sphinxhyphen{}level predictions about syntax and structure

\item {} 
\sphinxAtStartPar
Low\sphinxhyphen{}level predictions about word forms and sounds

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connection to LLMs}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Next\sphinxhyphen{}token prediction objective aligns with brain’s prediction mechanisms

\item {} 
\sphinxAtStartPar
Surprisal (negative log probability) correlates with human processing difficulty

\item {} 
\sphinxAtStartPar
Attention patterns resemble predictive focus in human reading

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Both brains and LLMs generate expectations about upcoming linguistic content, with prediction errors driving learning and adaptation.


\subsection{12.4.3 Compositional Representations}
\label{\detokenize{part4/ch12_large_language_models:compositional-representations}}
\sphinxAtStartPar
Both the brain and LLMs must represent meaning by composing elements into structured wholes:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}compositionality}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Show compositional representations in language understanding.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples demonstrating compositional understanding}
    \PYG{n}{examples} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The black cat chased the small mouse.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{compositional\PYGZus{}elements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{entities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attributes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{small}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{agent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chase}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The small mouse was chased by the black cat.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{compositional\PYGZus{}elements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{entities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attributes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{small}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{agent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chase}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mouse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{note}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Same meaning as previous example despite different surface form}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The chef who had won the competition prepared the meal.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{compositional\PYGZus{}elements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{entities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chef}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{competition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{agent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chef}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{win}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{competition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                    \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{agent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chef}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prepare}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
                \PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nesting}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{First relation is embedded within subject noun phrase}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Demonstration of how LLMs process compositional structures}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{llm\PYGZus{}compositionality\PYGZus{}handling}\PYG{p}{(}\PYG{n}{sentence}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simplified representation of how LLMs process compositional structures.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In reality, this is handled by the distributed representations in the network}
        \PYG{c+c1}{\PYGZsh{} and attention patterns across tokens}
        \PYG{k}{if} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cat chased}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{sentence}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention\PYGZus{}pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Subject tokens attend to verb, verb attends to object}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Distributed activation pattern capturing agent\PYGZhy{}action\PYGZhy{}patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inference\PYGZus{}capability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Can answer }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{Who did the chasing?}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ correctly}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{k}{elif} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{was chased by}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{sentence}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention\PYGZus{}pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Object tokens attend to passive verb, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{by}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ attends to agent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Different surface pattern but similar final semantic representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inference\PYGZus{}capability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Can still answer }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{Who did the chasing?}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ correctly}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{k}{elif} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{who had won}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{sentence}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention\PYGZus{}pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Complex pattern with relative clause attended to by main subject}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical structure with embedded relation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inference\PYGZus{}capability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Can answer questions about both events}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
    
    \PYG{n}{llm\PYGZus{}handling} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{ex}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:} \PYG{n}{llm\PYGZus{}compositionality\PYGZus{}handling}\PYG{p}{(}\PYG{n}{ex}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{ex} \PYG{o+ow}{in} \PYG{n}{examples}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{examples}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}handling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{llm\PYGZus{}handling}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of compositional representation:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural Binding}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Brain combines concepts while preserving their relationships

\item {} 
\sphinxAtStartPar
Neural synchrony may help bind related elements

\item {} 
\sphinxAtStartPar
Working memory coordinates structural relationships

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Recursive Processing}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Brain processes nested structures (phrases within phrases)

\item {} 
\sphinxAtStartPar
Compositional hierarchy enables unlimited expressivity

\item {} 
\sphinxAtStartPar
Structure\sphinxhyphen{}sensitive operations follow grammatical rules

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connection to LLMs}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}attention creates context\sphinxhyphen{}sensitive representations of words

\item {} 
\sphinxAtStartPar
Multi\sphinxhyphen{}head attention captures different types of dependencies

\item {} 
\sphinxAtStartPar
LLMs learn compositional patterns implicitly through training

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Both brains and LLMs must solve the binding problem—representing which properties belong to which entities and how entities relate to each other in complex scenes.


\subsection{12.4.4 Semantic and Syntactic Processing}
\label{\detokenize{part4/ch12_large_language_models:semantic-and-syntactic-processing}}
\sphinxAtStartPar
The brain processes both the meaning (semantics) and structure (syntax) of language:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{semantic\PYGZus{}syntactic\PYGZus{}processing}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate semantic and syntactic processing in the brain and LLMs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples demonstrating semantics vs. syntax}
    \PYG{n}{examples} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The coffee drank the man.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic anomaly: inanimate objects cannot drink}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{N400 effect (semantic processing difficulty)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}regions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temporal lobe}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Angular gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Inferior frontal gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Syntactic violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The man drinking coffee the.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grammatical error: incorrect word order}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{P600 effect (syntactic processing difficulty)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}regions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Left anterior temporal lobe}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Basal ganglia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Garden path sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The horse raced past the barn fell.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Initially parsed as active verb (}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{raced}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{), must be reanalyzed as passive participle}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{P600 effect upon encountering }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{fell}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}regions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Left inferior frontal gyrus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anterior cingulate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} How LLMs handle semantic vs. syntactic anomalies}
    \PYG{n}{llm\PYGZus{}responses} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{semantic\PYGZus{}violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{perplexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High token\PYGZhy{}level perplexity on }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{drank}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{handling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May correct to }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{The man drank the coffee}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ or flag semantic issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Strong cross\PYGZhy{}attention between subject and verb tokens}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{syntactic\PYGZus{}violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{perplexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High perplexity on final }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{the}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{handling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May attempt to complete or restructure the sentence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Disrupted attention patterns reflecting grammatical expectations}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{garden\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{perplexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spike in perplexity at }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{fell}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{handling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May require sufficient context window to resolve correctly}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Complex attention pattern revision when encountering }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{fell}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Double dissociation in language disorders}
    \PYG{n}{clinical\PYGZus{}evidence} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{semantic\PYGZus{}disorders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{condition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic dementia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{symptoms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Loss of word meanings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Preserved grammar}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluent but empty speech}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}areas}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anterior temporal lobes}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{syntactic\PYGZus{}disorders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{condition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Agrammatic aphasia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{symptoms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Impaired grammar}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Preserved word meaning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Telegraphic speech}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZus{}areas}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Left inferior frontal gyrus (Broca}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s area)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{examples}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}responses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{llm\PYGZus{}responses}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clinical\PYGZus{}evidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{clinical\PYGZus{}evidence}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key insights about semantic and syntactic processing:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distinct Neural Substrates}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Semantic processing primarily engages temporal and parietal regions

\item {} 
\sphinxAtStartPar
Syntactic processing relies on frontal regions and basal ganglia

\item {} 
\sphinxAtStartPar
Double dissociation in language disorders supports this distinction

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Integration Mechanisms}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
White matter tracts connect semantic and syntactic processing areas

\item {} 
\sphinxAtStartPar
Working memory coordinates integration of meaning and structure

\item {} 
\sphinxAtStartPar
Context modulates the interplay between semantics and syntax

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Connection to LLMs}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Different attention heads specialize in semantic vs. syntactic relationships

\item {} 
\sphinxAtStartPar
Layer hierarchy processes increasingly abstract linguistic features

\item {} 
\sphinxAtStartPar
Token perplexity spikes for both semantic and syntactic violations

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The distinction between semantic and syntactic processing in the brain is reflected in the specialization of different components within LLMs, though LLMs integrate these aspects more diffusely across their network.


\section{12.5 Limitations and Challenges}
\label{\detokenize{part4/ch12_large_language_models:limitations-and-challenges}}
\sphinxAtStartPar
While LLMs have shown remarkable capabilities, they also face significant limitations and challenges. Understanding these constraints is essential for effective deployment and ongoing development of these models.


\subsection{12.5.1 Hallucinations and Factuality}
\label{\detokenize{part4/ch12_large_language_models:hallucinations-and-factuality}}
\sphinxAtStartPar
LLMs can generate plausible\sphinxhyphen{}sounding but factually incorrect content, a phenomenon known as hallucination:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}hallucinations}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate LLM hallucinations and factuality issues.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples of hallucinations}
    \PYG{n}{hallucination\PYGZus{}examples} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What is the capital of Wakanda?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The capital of Wakanda is Birnin Zana, also known as the Golden City. It is the technological and cultural center of the nation, home to the royal palace and the Wakandan Design Group.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Factual hallucination: Wakanda is a fictional country from Marvel comics, not a real nation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High confidence despite being fictional}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explain the Hendricks\PYGZhy{}Palmer theory of quantum gravity.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The Hendricks\PYGZhy{}Palmer theory of quantum gravity, proposed by physicists Sarah Hendricks and Robert Palmer in 2008, attempts to reconcile general relativity with quantum mechanics by introducing }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{quantum spacetime nodes}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ that form a discrete structure at the Planck scale. The theory suggests that gravity emerges from entanglement entropy between these nodes, which fluctuate according to modified Heisenberg uncertainty principles.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fabrication hallucination: This theory and these physicists do not exist}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Elaborately detailed despite being completely fictional}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What are the main points in the 2023 Supreme Court case Johnson v. Microsoft?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{In the 2023 Supreme Court case Johnson v. Microsoft, the Court ruled 6\PYGZhy{}3 that tech companies can be held liable for algorithmic discrimination even without proof of discriminatory intent. Key points included: 1) Establishing the }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{disparate outcome}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ test for algorithmic systems, 2) Extending Civil Rights Act protections to AI decision contexts, and 3) Creating a new standard for technological due process.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temporal hallucination: Describes a court case that didn}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{t happen as if it did}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Specific details about a non\PYGZhy{}existent case}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Strategies to mitigate hallucinations}
    \PYG{n}{mitigation\PYGZus{}strategies} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Retrieval\PYGZhy{}Augmented Generation (RAG)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ground model outputs in reliable external information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Retrieve relevant documents from curated sources and condition generation on this information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trade\PYGZus{}offs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Requires maintaining external knowledge base; retrieval quality affects output}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Self\PYGZhy{}Consistency Checking}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Have model verify its own outputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Generate multiple responses and cross\PYGZhy{}check, or explicitly ask model to verify factual claims}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trade\PYGZus{}offs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Can miss systematic errors; model may be confidently wrong}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Uncertainty Quantification}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Encourage model to express uncertainty about claims}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fine\PYGZhy{}tune model to calibrate confidence or use sampling techniques to estimate uncertainty}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trade\PYGZus{}offs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May reduce usefulness for some applications by being overly cautious}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Human Feedback and Oversight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Keep humans in the loop for fact\PYGZhy{}checking}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use RLHF to reward accurate responses, implement human review of critical outputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trade\PYGZus{}offs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Scales poorly; humans can also make errors or have biases}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{hallucination\PYGZus{}examples}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mitigation\PYGZus{}strategies}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key challenges with factuality include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Types of Hallucinations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Confabulation: Creating entirely fictitious information

\item {} 
\sphinxAtStartPar
Conflation: Mixing facts from different sources or contexts

\item {} 
\sphinxAtStartPar
Temporal confusion: Citing future events or outdated information

\item {} 
\sphinxAtStartPar
Over\sphinxhyphen{}precision: Providing specific details beyond what’s known

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Causes of Hallucinations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Training methodology: Optimizing for plausibility rather than accuracy

\item {} 
\sphinxAtStartPar
Parametric knowledge: Relying on weights instead of external sources

\item {} 
\sphinxAtStartPar
Distribution shift: Encountering queries outside training distribution

\item {} 
\sphinxAtStartPar
Prompt misinterpretation: Misunderstanding user intent

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Impact on Applications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Critical in domains requiring factual accuracy (medicine, law, education)

\item {} 
\sphinxAtStartPar
Deceptive content may propagate misinformation

\item {} 
\sphinxAtStartPar
Users may over\sphinxhyphen{}trust plausible\sphinxhyphen{}sounding but incorrect information

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: The human brain also produces confabulations, especially in certain neurological conditions like Korsakoff’s syndrome. However, healthy humans typically have better calibrated confidence and can distinguish between knowledge and speculation.


\subsection{12.5.2 Bias and Fairness}
\label{\detokenize{part4/ch12_large_language_models:bias-and-fairness}}
\sphinxAtStartPar
LLMs can reflect, amplify, or introduce various biases present in their training data:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{bias\PYGZus{}examples}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate biases in language models and mitigation approaches.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples of different types of bias}
    \PYG{n}{bias\PYGZus{}examples} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gender bias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{I need to hire a babysitter and a programmer.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biased\PYGZus{}completion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{She should be good with kids. He should know Python and JavaScript.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gender stereotyping of occupations}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cultural/Western bias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What does a traditional wedding look like?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biased\PYGZus{}completion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{A traditional wedding typically takes place in a church with the bride in a white dress...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Defaults to Western cultural norms without acknowledging diversity}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Representation bias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Show me a picture of a CEO.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biased\PYGZus{}completion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{I can}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{t generate images, but CEOs are typically portrayed as middle\PYGZhy{}aged white men in business attire...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reinforces underrepresentation patterns from training data}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Political bias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s the best approach to economic policy?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{biased\PYGZus{}completion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The most effective economic policy focuses on market solutions with minimal government intervention...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Presents one political perspective as objective fact}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Bias evaluation frameworks}
    \PYG{n}{evaluation\PYGZus{}methods} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Bias benchmark datasets}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BOLD}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{WinoBias}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{StereoSet}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CrowS\PYGZhy{}Pairs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stereotype associations, representation disparities, preference patterns}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Counterfactual testing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Change protected attributes in prompts and measure output differences}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Compare responses for }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{I am a Black person...}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ vs }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{I am a white person...}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Red\PYGZhy{}teaming}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Adversarial testing to find and exploit biases}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Expert teams probe model boundaries and failure modes}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Bias mitigation strategies}
    \PYG{n}{mitigation\PYGZus{}strategies} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Training data curation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Carefully select and balance training data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hard to scale, difficult to address all bias dimensions}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RLHF for fairness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use human feedback to reduce biased outputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Train reward models to penalize unfair responses}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{System prompts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Design prompts that encourage fairness and balance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Include explicit instructions to consider diverse perspectives}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Post\PYGZhy{}processing filters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Detect and mitigate biased outputs after generation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{limitation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May reduce model expressiveness or create new biases}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{bias\PYGZus{}examples}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{evaluation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluation\PYGZus{}methods}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mitigation\PYGZus{}strategies}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key challenges with bias include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sources of Bias}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Training data: Reflects historical and societal inequalities

\item {} 
\sphinxAtStartPar
Algorithm design: Architecture and objective functions may amplify certain patterns

\item {} 
\sphinxAtStartPar
Deployment context: How models are used affects fairness implications

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Types of Harm}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Representational harm: Reinforcing stereotypes or negative associations

\item {} 
\sphinxAtStartPar
Allocational harm: Causing unfair distribution of resources or opportunities

\item {} 
\sphinxAtStartPar
Quality\sphinxhyphen{}of\sphinxhyphen{}service disparities: Providing different quality outputs for different groups

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mitigation Complexities}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Value pluralism: Different communities have different fairness priorities

\item {} 
\sphinxAtStartPar
Contextual appropriateness: Some distinctions are appropriate in certain contexts

\item {} 
\sphinxAtStartPar
Trade\sphinxhyphen{}offs: Addressing one type of bias may worsen another

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Humans also exhibit cognitive biases, but social norms, education, and cultural evolution create mechanisms for recognizing and addressing these biases over time. LLMs lack this social feedback loop unless explicitly designed.


\subsection{12.5.3 Context Window Limitations}
\label{\detokenize{part4/ch12_large_language_models:context-window-limitations}}
\sphinxAtStartPar
The limited context window of LLMs constrains their ability to process and reason over long documents:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{context\PYGZus{}window\PYGZus{}limitations}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Illustrate context window limitations and strategies.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Context window sizes for common models}
    \PYG{n}{model\PYGZus{}context\PYGZus{}windows} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}3.5 (Jun 2023)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{4K tokens (\PYGZti{}3,000 words)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}4 (Mar 2023)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{8K tokens (\PYGZti{}6,000 words)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPT\PYGZhy{}4 Turbo (Dec 2023)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{128K tokens (\PYGZti{}96,000 words)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Claude 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{100K tokens (\PYGZti{}75,000 words)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LLaMA 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{4K tokens (\PYGZti{}3,000 words)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gemini Ultra}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{32K tokens (\PYGZti{}24,000 words)}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Challenges related to context windows}
    \PYG{n}{context\PYGZus{}challenges} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information retrieval}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Finding specific information in long documents}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Locating a particular clause in a lengthy legal contract}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cross\PYGZhy{}reference reasoning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Connecting information from different parts of a text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Identifying inconsistencies between sections of a research paper}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Document summarization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Creating concise overviews of lengthy documents}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Summarizing a 300\PYGZhy{}page book into 2 pages}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Sequential decision making}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Maintaining consistent reasoning across a long conversation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Multi\PYGZhy{}turn dialogue about a complex topic spanning hours}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Strategies for handling long contexts}
    \PYG{n}{context\PYGZus{}strategies} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Chunking and sliding windows}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Break documents into overlapping segments}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Process each chunk separately and combine results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{limitation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May lose cross\PYGZhy{}chunk connections and global context}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical summarization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Summarize sections, then summarize the summaries}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Create multiple levels of abstraction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{limitation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information loss at each summarization step}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Retrieval\PYGZhy{}based approaches}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Store document chunks in a vector database and retrieve relevant portions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use embeddings to find semantically relevant chunks for each query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{limitation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Retrieval quality depends on query formulation and embedding quality}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information distillation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Extract and retain only the most important information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use models to identify key facts and discard irrelevant details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{limitation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Requires determining importance, which depends on downstream tasks}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Architectural innovations addressing context length}
    \PYG{n}{architectural\PYGZus{}innovations} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{innovation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Sparse attention patterns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use structured sparsity to avoid quadratic scaling}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longformer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BigBird}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reformer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{innovation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recurrent memory mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Maintain compressed representations of previous context}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Transformer\PYGZhy{}XL}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Memorizing Transformers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Retentive Network}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{innovation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical encodings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Process text at multiple levels of granularity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hierarchical Transformers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Primer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model\PYGZus{}windows}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}context\PYGZus{}windows}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{challenges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{context\PYGZus{}challenges}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{context\PYGZus{}strategies}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{innovations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{architectural\PYGZus{}innovations}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key challenges with context windows include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational Constraints}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Attention mechanism scales quadratically with sequence length

\item {} 
\sphinxAtStartPar
Memory requirements increase with context size

\item {} 
\sphinxAtStartPar
Training difficulty increases with longer sequences

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive Limitations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Information retrieval challenges in long contexts

\item {} 
\sphinxAtStartPar
Maintaining coherence across distant parts of text

\item {} 
\sphinxAtStartPar
Balancing detail and high\sphinxhyphen{}level understanding

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Practical Implications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Limits use cases requiring whole\sphinxhyphen{}document understanding

\item {} 
\sphinxAtStartPar
Necessitates external memory and retrieval systems

\item {} 
\sphinxAtStartPar
Creates trade\sphinxhyphen{}offs between detail and breadth

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Humans also have limited working memory but compensate through hierarchical processing, external memory aids, and contextual retrieval. The brain organizes information across multiple timescales, from immediate to episodic memory.


\subsection{12.5.4 Reasoning Capabilities}
\label{\detokenize{part4/ch12_large_language_models:reasoning-capabilities}}
\sphinxAtStartPar
LLMs show both impressive and limited reasoning abilities:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reasoning\PYGZus{}capabilities}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Explore reasoning capabilities and limitations in LLMs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Examples of reasoning successes}
    \PYG{n}{reasoning\PYGZus{}successes} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Logical deduction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{If all A are B, and all B are C, then all A are C.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{performance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LLMs can follow simple syllogistic reasoning consistently.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Step\PYGZhy{}by\PYGZhy{}step math}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What is 17 × 24?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{performance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{With chain\PYGZhy{}of\PYGZhy{}thought prompting, can solve by breaking into steps.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Commonsense reasoning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{If I put a book on a shelf and leave the room, where is the book?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{performance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Understands object permanence and basic physical causality.}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Examples of reasoning failures}
    \PYG{n}{reasoning\PYGZus{}failures} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Complex logical puzzles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Knights and Knaves puzzles (determining who is telling truth)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Inconsistent tracking of logical constraints across many steps}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mathematical proofs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Prove the Pythagorean theorem}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May introduce errors or circular reasoning in multi\PYGZhy{}step proofs}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Compositional generalization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Applying known rules to novel combinations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Struggles to systematically apply rules to unfamiliar structures}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{task}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Planning with constraints}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Traveling salesman problem with complex constraints}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{issue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Difficulty tracking multiple interdependent constraints}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Strategies to improve reasoning}
    \PYG{n}{reasoning\PYGZus{}strategies} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Chain of thought prompting}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Encourage step\PYGZhy{}by\PYGZhy{}step reasoning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effectiveness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Significantly improves multi\PYGZhy{}step reasoning and math}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tree of thoughts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explore multiple reasoning paths and select best outcome}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effectiveness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Helps with problems requiring search or backtracking}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Self\PYGZhy{}critique and verification}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Have model evaluate and correct its own reasoning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effectiveness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Can catch some errors, but may miss systematic flaws}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tool use}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Augment model with external tools (calculators, code interpreters)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effectiveness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dramatically improves accuracy for formal reasoning}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{successes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{reasoning\PYGZus{}successes}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{failures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{reasoning\PYGZus{}failures}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{reasoning\PYGZus{}strategies}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key aspects of reasoning limitations include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Types of Reasoning Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Systematic reasoning: Applying rules consistently

\item {} 
\sphinxAtStartPar
Complex problem\sphinxhyphen{}solving: Planning, search, and constraint satisfaction

\item {} 
\sphinxAtStartPar
Abstraction and generalization: Applying known patterns to new domains

\item {} 
\sphinxAtStartPar
Self\sphinxhyphen{}monitoring: Detecting and correcting errors in reasoning

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Underlying Mechanisms}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Statistical pattern matching vs. rule\sphinxhyphen{}based reasoning

\item {} 
\sphinxAtStartPar
Emergent reasoning capabilities from pattern recognition

\item {} 
\sphinxAtStartPar
Limited by training objectives focused on prediction

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Need for external verification for critical applications

\item {} 
\sphinxAtStartPar
Potential for augmentation with symbolic systems

\item {} 
\sphinxAtStartPar
Importance of appropriate task delegation and human oversight

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Biological Parallel}: Human reasoning combines pattern recognition with explicit symbolic manipulation, especially for formal domains like mathematics and logic. The prefrontal cortex plays a key role in abstract reasoning, working with other brain regions to integrate information and monitor errors.


\section{12.6 Code Lab}
\label{\detokenize{part4/ch12_large_language_models:code-lab}}
\sphinxAtStartPar
In this code lab, we’ll apply the techniques covered in this chapter through hands\sphinxhyphen{}on exercises. We’ll implement parameter\sphinxhyphen{}efficient fine\sphinxhyphen{}tuning, explore prompting strategies, and evaluate model outputs.


\subsection{12.6.1 Fine\sphinxhyphen{}tuning a Small LLM with LoRA}
\label{\detokenize{part4/ch12_large_language_models:fine-tuning-a-small-llm-with-lora}}
\sphinxAtStartPar
First, let’s implement LoRA fine\sphinxhyphen{}tuning on a small language model for a specialized task. We’ll use a pretrained GPT\sphinxhyphen{}2 model and adapt it to a specific domain using the PEFT library.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{AutoModelForCausalLM}\PYG{p}{,} \PYG{n}{AutoTokenizer}\PYG{p}{,} \PYG{n}{TrainingArguments}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{peft}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}peft\PYGZus{}model}\PYG{p}{,} \PYG{n}{LoraConfig}\PYG{p}{,} \PYG{n}{TaskType}\PYG{p}{,} \PYG{n}{PeftConfig}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}dataset}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tqdm}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{tqdm}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{finetune\PYGZus{}with\PYGZus{}lora}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Fine\PYGZhy{}tune a small LLM using LoRA for parameter\PYGZhy{}efficient adaptation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1. Load base model and tokenizer}
    \PYG{n}{model\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gpt2}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} 124M parameter model for demonstration}
    \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{AutoTokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{pad\PYGZus{}token} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{eos\PYGZus{}token}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{AutoModelForCausalLM}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Define LoRA configuration}
    \PYG{n}{lora\PYGZus{}config} \PYG{o}{=} \PYG{n}{LoraConfig}\PYG{p}{(}
        \PYG{n}{r}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,}                     \PYG{c+c1}{\PYGZsh{} Rank dimension}
        \PYG{n}{lora\PYGZus{}alpha}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,}           \PYG{c+c1}{\PYGZsh{} Alpha parameter for LoRA scaling}
        \PYG{n}{target\PYGZus{}modules}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{c\PYGZus{}attn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{c\PYGZus{}proj}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Attention layers to adapt}
        \PYG{n}{lora\PYGZus{}dropout}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Dropout probability for LoRA layers}
        \PYG{n}{bias}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{none}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}             \PYG{c+c1}{\PYGZsh{} Don\PYGZsq{}t adapt bias terms}
        \PYG{n}{task\PYGZus{}type}\PYG{o}{=}\PYG{n}{TaskType}\PYG{o}{.}\PYG{n}{CAUSAL\PYGZus{}LM}  \PYG{c+c1}{\PYGZsh{} Task type (for PEFT library)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Create PEFT model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{get\PYGZus{}peft\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{lora\PYGZus{}config}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 4. Compare parameter counts}
    \PYG{n}{total\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{trainable\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)} \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{requires\PYGZus{}grad}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Total parameters: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}params}\PYG{l+s+si}{:}\PYG{l+s+s2}{,}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Trainable parameters: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{trainable\PYGZus{}params}\PYG{l+s+si}{:}\PYG{l+s+s2}{,}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Percentage of parameters trained: }\PYG{l+s+si}{\PYGZob{}}\PYG{l+m+mi}{100}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{trainable\PYGZus{}params}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{total\PYGZus{}params}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 5. Load and prepare dataset (scientific abstracts as an example)}
    \PYG{n}{dataset} \PYG{o}{=} \PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scientific\PYGZus{}papers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{arxiv}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{split}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train[:1000]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{preprocess\PYGZus{}function}\PYG{p}{(}\PYG{n}{examples}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Tokenize texts with appropriate input format.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{texts} \PYG{o}{=} \PYG{p}{[}\PYG{n}{abstract}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{1024}\PYG{p}{]} \PYG{k}{for} \PYG{n}{abstract} \PYG{o+ow}{in} \PYG{n}{examples}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{abstract}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Truncate to manageable size}
        \PYG{k}{return} \PYG{n}{tokenizer}\PYG{p}{(}\PYG{n}{texts}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{max\PYGZus{}length}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{truncation}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{512}\PYG{p}{)}
    
    \PYG{n}{tokenized\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{map}\PYG{p}{(}\PYG{n}{preprocess\PYGZus{}function}\PYG{p}{,} \PYG{n}{batched}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 6. Setup training arguments}
    \PYG{n}{training\PYGZus{}args} \PYG{o}{=} \PYG{n}{TrainingArguments}\PYG{p}{(}
        \PYG{n}{output\PYGZus{}dir}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./lora\PYGZhy{}scientific\PYGZhy{}gpt2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}train\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,}
        \PYG{n}{per\PYGZus{}device\PYGZus{}train\PYGZus{}batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
        \PYG{n}{gradient\PYGZus{}accumulation\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
        \PYG{n}{warmup\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
        \PYG{n}{weight\PYGZus{}decay}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
        \PYG{n}{logging\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
        \PYG{n}{save\PYGZus{}strategy}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{epoch}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{,}
        \PYG{n}{fp16}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Use mixed precision for efficiency}
        \PYG{n}{report\PYGZus{}to}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{none}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} Disable wandb, etc.}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 7. Initialize Trainer (import Trainer separately to avoid confusion with custom functions)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Trainer}
    
    \PYG{n}{trainer} \PYG{o}{=} \PYG{n}{Trainer}\PYG{p}{(}
        \PYG{n}{model}\PYG{o}{=}\PYG{n}{model}\PYG{p}{,}
        \PYG{n}{args}\PYG{o}{=}\PYG{n}{training\PYGZus{}args}\PYG{p}{,}
        \PYG{n}{train\PYGZus{}dataset}\PYG{o}{=}\PYG{n}{tokenized\PYGZus{}dataset}\PYG{p}{,}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 8. Train (commented out for demonstration)}
    \PYG{c+c1}{\PYGZsh{} trainer.train()}
    
    \PYG{c+c1}{\PYGZsh{} 9. Save adapter weights (only the LoRA parameters)}
    \PYG{c+c1}{\PYGZsh{} trainer.model.save\PYGZus{}pretrained(\PYGZdq{}./lora\PYGZhy{}scientific\PYGZhy{}gpt2\PYGZhy{}adapter\PYGZdq{})}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{model\PYGZus{}name}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{adapter\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LoRA}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{total\PYGZus{}params}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{total\PYGZus{}params}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{trainable\PYGZus{}params}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{trainable\PYGZus{}params}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{efficiency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{l+m+mi}{100}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{trainable\PYGZus{}params}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{total\PYGZus{}params}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
The above code implements LoRA fine\sphinxhyphen{}tuning, enabling us to adapt a pretrained model to scientific text with only about 0.1\% of the parameters being updated. This makes fine\sphinxhyphen{}tuning practical even on consumer hardware.


\subsection{12.6.2 Implementing Prompting Strategies}
\label{\detokenize{part4/ch12_large_language_models:implementing-prompting-strategies}}
\sphinxAtStartPar
Next, let’s explore various prompting techniques and compare their effectiveness on reasoning tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{AutoModelForCausalLM}\PYG{p}{,} \PYG{n}{AutoTokenizer}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}prompting\PYGZus{}strategies}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Compare different prompting strategies on a problem\PYGZhy{}solving task.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load model (using a small model for demonstration)}
    \PYG{n}{model\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gpt2\PYGZhy{}medium}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} 355M parameter model}
    \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{AutoTokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{AutoModelForCausalLM}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define prompting techniques to compare}
    \PYG{n}{prompting\PYGZus{}techniques} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Direct}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Question: A garden has roses and tulips. There are 12 flowers in total. }
\PYG{l+s+s2}{            If there are 4 more roses than tulips, how many roses are there?}
\PYG{l+s+s2}{            Answer:}
\PYG{l+s+s2}{        }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}\PYG{p}{,}
        
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Few\PYGZhy{}shot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Question: A classroom has boys and girls. There are 20 students in total.}
\PYG{l+s+s2}{            If there are 6 more girls than boys, how many boys are there?}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            To solve this problem, I}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ll use variables:}
\PYG{l+s+s2}{            Let b = number of boys}
\PYG{l+s+s2}{            Let g = number of girls}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            I know that:}
\PYG{l+s+s2}{            b + g = 20 (total students)}
\PYG{l+s+s2}{            g = b + 6 (6 more girls than boys)}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Substituting the second equation into the first:}
\PYG{l+s+s2}{            b + (b + 6) = 20}
\PYG{l+s+s2}{            2b + 6 = 20}
\PYG{l+s+s2}{            2b = 14}
\PYG{l+s+s2}{            b = 7}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Therefore, there are 7 boys in the classroom.}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Question: A garden has roses and tulips. There are 12 flowers in total. }
\PYG{l+s+s2}{            If there are 4 more roses than tulips, how many roses are there?}
\PYG{l+s+s2}{            Answer:}
\PYG{l+s+s2}{        }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}\PYG{p}{,}
        
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Zero\PYGZhy{}shot CoT}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Question: A garden has roses and tulips. There are 12 flowers in total. }
\PYG{l+s+s2}{            If there are 4 more roses than tulips, how many roses are there?}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Let}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s think step by step to solve this problem.}
\PYG{l+s+s2}{        }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}\PYG{p}{,}
        
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Self\PYGZhy{}Critique}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Question: A garden has roses and tulips. There are 12 flowers in total. }
\PYG{l+s+s2}{            If there are 4 more roses than tulips, how many roses are there?}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            I}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ll solve this and then double\PYGZhy{}check my work for errors.}
\PYG{l+s+s2}{        }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Function to generate completions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}completion}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{,} \PYG{n}{max\PYGZus{}tokens}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{,} \PYG{n}{return\PYGZus{}tensors}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{generate}\PYG{p}{(}
                \PYG{n}{inputs}\PYG{o}{.}\PYG{n}{input\PYGZus{}ids}\PYG{p}{,} 
                \PYG{n}{max\PYGZus{}new\PYGZus{}tokens}\PYG{o}{=}\PYG{n}{max\PYGZus{}tokens}\PYG{p}{,}
                \PYG{n}{temperature}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,}
                \PYG{n}{num\PYGZus{}return\PYGZus{}sequences}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}
                \PYG{n}{pad\PYGZus{}token\PYGZus{}id}\PYG{o}{=}\PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{eos\PYGZus{}token\PYGZus{}id}
            \PYG{p}{)}
        \PYG{n}{completion} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{skip\PYGZus{}special\PYGZus{}tokens}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{completion}
    
    \PYG{c+c1}{\PYGZsh{} Generate answers for each technique and assess them}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{technique}\PYG{p}{,} \PYG{n}{prompt} \PYG{o+ow}{in} \PYG{n}{prompting\PYGZus{}techniques}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} In practice, you\PYGZsq{}d generate actual completions from the model here}
        \PYG{n}{completion} \PYG{o}{=} \PYG{n}{generate\PYGZus{}completion}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simulated assessments (in real use, you would evaluate actual model outputs)}
        \PYG{c+c1}{\PYGZsh{} This would require a human evaluator or more sophisticated evaluation}
        \PYG{n}{simulate\PYGZus{}accuracy} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Direct}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.25}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Often struggles with word problems}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Few\PYGZhy{}shot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.70}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Benefits from examples}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Zero\PYGZhy{}shot CoT}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.65}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Reasoning steps help}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Self\PYGZhy{}Critique}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.60}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Some benefit from verification}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{results}\PYG{p}{[}\PYG{n}{technique}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{prompt}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{completion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{completion}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens\PYGZus{}used}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{prompt}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{simulate\PYGZus{}accuracy}\PYG{p}{[}\PYG{n}{technique}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Visualization (in a real notebook, this would generate a plot)}
    \PYG{n}{techniques} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{results}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{accuracies} \PYG{o}{=} \PYG{p}{[}\PYG{n}{results}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n}{techniques}\PYG{p}{]}
    \PYG{n}{token\PYGZus{}counts} \PYG{o}{=} \PYG{p}{[}\PYG{n}{results}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens\PYGZus{}used}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n}{techniques}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create plot data}
    \PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{techniques}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{width} \PYG{o}{=} \PYG{l+m+mf}{0.35}
    
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax2} \PYG{o}{=} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{twinx}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{bars1} \PYG{o}{=} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n}{width}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{accuracies}\PYG{p}{,} \PYG{n}{width}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{bars2} \PYG{o}{=} \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{width}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{token\PYGZus{}counts}\PYG{p}{,} \PYG{n}{width}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tokens Used}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prompting Technique}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tokens Used}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparing Prompting Techniques: Accuracy vs. Token Usage}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{n}{techniques}\PYG{p}{)}
    
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{upper left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{upper right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{results}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{best\PYGZus{}technique}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{results}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{token\PYGZus{}efficiency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{results}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tokens\PYGZus{}used}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{/} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
This exercise demonstrates how different prompting techniques can significantly impact model performance. While few\sphinxhyphen{}shot and chain\sphinxhyphen{}of\sphinxhyphen{}thought prompting use more tokens, they typically yield better results for reasoning tasks.


\subsection{12.6.3 Implementing a RAG System to Reduce Hallucinations}
\label{\detokenize{part4/ch12_large_language_models:implementing-a-rag-system-to-reduce-hallucinations}}
\sphinxAtStartPar
Now, let’s build a simple Retrieval\sphinxhyphen{}Augmented Generation (RAG) system to improve factual accuracy:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{AutoTokenizer}\PYG{p}{,} \PYG{n}{AutoModel}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{n+nn}{.}\PYG{n+nn}{pairwise}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{cosine\PYGZus{}similarity}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{implement\PYGZus{}simple\PYGZus{}rag}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Implement a basic RAG system to improve factual grounding.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 1. Create a small knowledge base (in practice, this would be much larger)}
    \PYG{n}{knowledge\PYGZus{}base} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The Eiffel Tower is located in Paris, France. It was completed in 1889 and stands 330 meters tall.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The Great Wall of China is approximately 21,196 kilometers long. Construction began in the 7th century BCE.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Jupiter is the largest planet in our solar system. It has 79 known moons, including the four large Galilean moons.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Machine learning is a subset of artificial intelligence that enables systems to learn from data rather than explicit programming.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{The human brain contains approximately 86 billion neurons connected by trillions of synapses.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Photosynthesis is the process by which plants convert light energy into chemical energy. It produces oxygen as a byproduct.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DNA (deoxyribonucleic acid) stores genetic information in the form of nucleotide sequences.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural networks are computing systems inspired by biological neural networks, forming the basis of many modern AI systems.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} 2. Define a function to create embeddings for text}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}embeddings}\PYG{p}{(}\PYG{n}{texts}\PYG{p}{,} \PYG{n}{model\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sentence\PYGZhy{}transformers/all\PYGZhy{}MiniLM\PYGZhy{}L6\PYGZhy{}v2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create embeddings for a list of texts using a pretrained model.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{AutoTokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{AutoModel}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
        
        \PYG{n}{embeddings} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{text} \PYG{o+ow}{in} \PYG{n}{texts}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Tokenize and prepare for the model}
            \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{p}{(}\PYG{n}{text}\PYG{p}{,} \PYG{n}{return\PYGZus{}tensors}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{truncation}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{512}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Generate embeddings}
            \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{inputs}\PYG{p}{)}
                
            \PYG{c+c1}{\PYGZsh{} Use mean pooling to get a single vector per text}
            \PYG{n}{embedding} \PYG{o}{=} \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{last\PYGZus{}hidden\PYGZus{}state}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{squeeze}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{embeddings}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{embedding}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{embeddings}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Create embeddings for the knowledge base}
    \PYG{n}{kb\PYGZus{}embeddings} \PYG{o}{=} \PYG{n}{create\PYGZus{}embeddings}\PYG{p}{(}\PYG{n}{knowledge\PYGZus{}base}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 4. Function to retrieve relevant information for a query}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{retrieve\PYGZus{}relevant\PYGZus{}info}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{top\PYGZus{}k}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Retrieve top\PYGZhy{}k relevant passages for a query.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Create embedding for the query}
        \PYG{n}{query\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{create\PYGZus{}embeddings}\PYG{p}{(}\PYG{p}{[}\PYG{n}{query}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Calculate similarity scores}
        \PYG{n}{similarities} \PYG{o}{=} \PYG{n}{cosine\PYGZus{}similarity}\PYG{p}{(}\PYG{p}{[}\PYG{n}{query\PYGZus{}embedding}\PYG{p}{]}\PYG{p}{,} \PYG{n}{kb\PYGZus{}embeddings}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Get indices of top\PYGZhy{}k most similar passages}
        \PYG{n}{top\PYGZus{}indices} \PYG{o}{=} \PYG{n}{similarities}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{top\PYGZus{}k}\PYG{p}{:}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Return the relevant passages and their similarity scores}
        \PYG{n}{retrieved\PYGZus{}info} \PYG{o}{=} \PYG{p}{[}\PYG{n}{knowledge\PYGZus{}base}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{top\PYGZus{}indices}\PYG{p}{]}
        \PYG{n}{retrieved\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{n}{similarities}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{top\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{retrieved\PYGZus{}info}\PYG{p}{,} \PYG{n}{retrieved\PYGZus{}scores}
    
    \PYG{c+c1}{\PYGZsh{} 5. Function to generate RAG\PYGZhy{}enhanced responses}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}rag\PYGZus{}response}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{model\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gpt2\PYGZhy{}medium}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a response using retrieval\PYGZhy{}augmented generation.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Retrieve relevant information}
        \PYG{n}{retrieved\PYGZus{}info}\PYG{p}{,} \PYG{n}{scores} \PYG{o}{=} \PYG{n}{retrieve\PYGZus{}relevant\PYGZus{}info}\PYG{p}{(}\PYG{n}{query}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a RAG prompt with the retrieved information}
        \PYG{n}{rag\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{        Based on the following information:}
\PYG{l+s+s2}{        }
\PYG{l+s+s2}{        }\PYG{l+s+si}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{retrieved\PYGZus{}info}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}
\PYG{l+s+s2}{        }
\PYG{l+s+s2}{        Please answer this question: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{query}\PYG{l+s+si}{\PYGZcb{}}
\PYG{l+s+s2}{        }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} In a real implementation, this would call the model to generate a response}
        \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}ll simulate it}
        \PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{AutoTokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{AutoModelForCausalLM}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
        
        \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{p}{(}\PYG{n}{rag\PYGZus{}prompt}\PYG{p}{,} \PYG{n}{return\PYGZus{}tensors}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{generate}\PYG{p}{(}
                \PYG{n}{inputs}\PYG{o}{.}\PYG{n}{input\PYGZus{}ids}\PYG{p}{,}
                \PYG{n}{max\PYGZus{}new\PYGZus{}tokens}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
                \PYG{n}{temperature}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,}
                \PYG{n}{num\PYGZus{}return\PYGZus{}sequences}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}
                \PYG{n}{pad\PYGZus{}token\PYGZus{}id}\PYG{o}{=}\PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{eos\PYGZus{}token\PYGZus{}id}
            \PYG{p}{)}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{tokenizer}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{skip\PYGZus{}special\PYGZus{}tokens}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{query}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{retrieved\PYGZus{}info}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{retrieved\PYGZus{}info}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{similarity\PYGZus{}scores}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{scores}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rag\PYGZus{}prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rag\PYGZus{}prompt}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{response}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} 6. Compare RAG vs. direct responses for queries}
    \PYG{n}{test\PYGZus{}queries} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{How tall is the Eiffel Tower?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What is neural network in AI?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{How many neurons are in the human brain?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What is the mechanism behind photosynthesis?}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} In practice, you would generate and compare actual responses here}
    \PYG{n}{comparison\PYGZus{}results} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{query} \PYG{o+ow}{in} \PYG{n}{test\PYGZus{}queries}\PYG{p}{:}
        \PYG{n}{rag\PYGZus{}result} \PYG{o}{=} \PYG{n}{generate\PYGZus{}rag\PYGZus{}response}\PYG{p}{(}\PYG{n}{query}\PYG{p}{)}
        \PYG{n}{comparison\PYGZus{}results}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{query}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{with\PYGZus{}rag}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rag\PYGZus{}result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{c+c1}{\PYGZsh{} Simulate direct response (without retrieval)}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{without\PYGZus{}rag}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Simulated direct response without knowledge retrieval}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{retrieved\PYGZus{}documents}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rag\PYGZus{}result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{retrieved\PYGZus{}info}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{knowledge\PYGZus{}base\PYGZus{}size}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{knowledge\PYGZus{}base}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{comparison\PYGZus{}results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{comparison\PYGZus{}results}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rag\PYGZus{}benefits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reduces hallucinations by grounding responses in factual information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Provides source material that can be cited}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improves answer specificity and detail}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Allows model to access information beyond training data}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
This RAG system demonstrates how to retrieve relevant information before generating responses, significantly reducing hallucinations and improving factual accuracy.


\subsection{12.6.4 Domain Adaptation Case Study: Personalizing a Scientific Assistant}
\label{\detokenize{part4/ch12_large_language_models:domain-adaptation-case-study-personalizing-a-scientific-assistant}}
\sphinxAtStartPar
Finally, let’s explore how to adapt an LLM to a specialized scientific domain, combining the techniques we’ve learned:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neuroscience\PYGZus{}domain\PYGZus{}adaptation}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Case study on adapting an LLM for specialized neuroscience applications.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 1. Define domain\PYGZhy{}specific knowledge and terminology}
    \PYG{n}{neuroscience\PYGZus{}terminology} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Domains}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{neuroanatomy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{neurophysiology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cognitive neuroscience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{computational neuroscience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Key Concepts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Action potential}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Synapse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neurotransmitter}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural circuit}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Plasticity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term potentiation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cortical column}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Receptive field}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Research Methods}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{fMRI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{EEG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Single\PYGZhy{}unit recording}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Optogenetics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Patch clamp}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Calcium imaging}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural decoding}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} 2. Create a domain\PYGZhy{}specific system prompt}
    \PYG{n}{neuroscience\PYGZus{}system\PYGZus{}prompt} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    You are NeuroBuddy, an expert neuroscience research assistant with the following capabilities:}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    1. You have specialized knowledge in neuroanatomy, neurophysiology, cognitive neuroscience,}
\PYG{l+s+s2}{       and computational neuroscience.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    2. You can interpret and explain neuroscience research methods including fMRI, EEG, }
\PYG{l+s+s2}{       single\PYGZhy{}unit recordings, optogenetics, and computational modeling approaches.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    3. You provide accurate, technically precise information about the brain and }
\PYG{l+s+s2}{       neural systems, using appropriate terminology and citing relevant research where possible.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    4. When asked for experimental design advice, you suggest appropriate methods, controls,}
\PYG{l+s+s2}{       and analyses based on the specific research question.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    5. You can translate between neuroscience concepts and machine learning/AI paradigms,}
\PYG{l+s+s2}{       highlighting similarities and differences.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    6. When uncertain, you express your limitations clearly rather than providing }
\PYG{l+s+s2}{       potentially incorrect information.}
\PYG{l+s+s2}{       }
\PYG{l+s+s2}{    Respond with comprehensive, scientifically accurate information while making complex}
\PYG{l+s+s2}{    concepts understandable. Use technical terminology where appropriate but explain}
\PYG{l+s+s2}{    specialized terms when they might be unfamiliar.}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 3. Design few\PYGZhy{}shot examples for domain grounding}
    \PYG{n}{few\PYGZus{}shot\PYGZus{}examples} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s the difference between place cells and grid cells?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Place cells and grid cells are two types of spatial encoding neurons with distinct properties:}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Place cells:}
\PYG{l+s+s2}{            \PYGZhy{} Found primarily in the hippocampus, especially CA1 and CA3 regions}
\PYG{l+s+s2}{            \PYGZhy{} Fire when an animal is in a specific location in the environment (}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{place field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{)}
\PYG{l+s+s2}{            \PYGZhy{} Each cell responds to a single location, forming a cognitive map}
\PYG{l+s+s2}{            \PYGZhy{} Properties change with environment (remapping)}
\PYG{l+s+s2}{            \PYGZhy{} Discovered by O}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{Keefe and Dostrovsky in 1971}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Grid cells:}
\PYG{l+s+s2}{            \PYGZhy{} Found in the medial entorhinal cortex (MEC)}
\PYG{l+s+s2}{            \PYGZhy{} Fire in multiple locations forming a hexagonal grid pattern}
\PYG{l+s+s2}{            \PYGZhy{} The same cell activates at regular spatial intervals}
\PYG{l+s+s2}{            \PYGZhy{} Patterns preserve across environments but may rescale}
\PYG{l+s+s2}{            \PYGZhy{} Discovered by the Moser lab in 2005}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            Together, these cell types form a comprehensive spatial navigation system, with grid cells providing a coordinate system and place cells representing specific locations. This discovery was recognized with the 2014 Nobel Prize in Physiology or Medicine.}
\PYG{l+s+s2}{            }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{How does optogenetics work?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{            Optogenetics is a technique that combines genetic and optical methods to control and monitor specific cells (typically neurons) with light. Here}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s how it works:}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            1. Genetic component:}
\PYG{l+s+s2}{               \PYGZhy{} Light\PYGZhy{}sensitive proteins (opsins) like Channelrhodopsin\PYGZhy{}2 (ChR2), Halorhodopsin (NpHR), or Archaerhodopsin (Arch) are introduced into target cells}
\PYG{l+s+s2}{               \PYGZhy{} This is typically done using viral vectors carrying genes for these opsins under cell\PYGZhy{}type specific promoters}
\PYG{l+s+s2}{               \PYGZhy{} ChR2 activates neurons when exposed to blue light, while NpHR and Arch inhibit neurons with yellow/green light}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            2. Light delivery:}
\PYG{l+s+s2}{               \PYGZhy{} Fiber optic cables or μLED devices are implanted to deliver light to specific brain regions}
\PYG{l+s+s2}{               \PYGZhy{} Light pulses can be precisely timed at millisecond precision}
\PYG{l+s+s2}{               \PYGZhy{} Different wavelengths can activate different opsins}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            3. Experimental applications:}
\PYG{l+s+s2}{               \PYGZhy{} Causal testing of neural circuits (does activating these neurons cause this behavior?)}
\PYG{l+s+s2}{               \PYGZhy{} Mapping connections between brain regions}
\PYG{l+s+s2}{               \PYGZhy{} Therapeutic research (potentially treating conditions by controlling specific circuits)}
\PYG{l+s+s2}{            }
\PYG{l+s+s2}{            This technique revolutionized neuroscience by allowing precise control of specific neuronal populations with temporal precision matching natural neural dynamics.}
\PYG{l+s+s2}{            }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} 4. Demonstrate domain\PYGZhy{}specific fine\PYGZhy{}tuning data creation}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}instruction\PYGZus{}tuning\PYGZus{}dataset}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create examples for instruction fine\PYGZhy{}tuning a neuroscience assistant.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{instruction\PYGZus{}data} \PYG{o}{=} \PYG{p}{[}
            \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explain the concept of predictive coding in the brain.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{                Predictive coding is a theoretical framework in neuroscience that proposes the brain continually generates predictions about incoming sensory information, comparing these predictions with actual input to compute prediction errors.}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                Key principles:}
\PYG{l+s+s2}{                1. Hierarchical processing: Higher levels in neural hierarchies generate predictions about representations in lower levels}
\PYG{l+s+s2}{                2. Bidirectional information flow: Top\PYGZhy{}down predictions and bottom\PYGZhy{}up prediction errors}
\PYG{l+s+s2}{                3. Precision weighting: The influence of prediction errors is modulated by their reliability}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                This model helps explain phenomena like perception, attention, and learning:}
\PYG{l+s+s2}{                \PYGZhy{} Perception emerges from prediction minimization}
\PYG{l+s+s2}{                \PYGZhy{} Attention is understood as precision optimization}
\PYG{l+s+s2}{                \PYGZhy{} Learning occurs by updating predictive models to minimize future prediction errors}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                Neuroanatomically, predictive coding may be implemented through:}
\PYG{l+s+s2}{                \PYGZhy{} Forward connections carrying prediction errors (typically superficial pyramidal cells)}
\PYG{l+s+s2}{                \PYGZhy{} Backward connections carrying predictions (typically deep pyramidal cells)}
\PYG{l+s+s2}{                \PYGZhy{} Local connections implementing precision\PYGZhy{}weighting (potentially involving inhibitory interneurons)}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                Influential papers include Karl Friston}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s work on the free energy principle and Rao \PYGZam{} Ballard}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s 1999 paper on predictive coding in the visual cortex.}
\PYG{l+s+s2}{                }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Compare and contrast LSTMs and biological recurrent neural circuits.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{                Comparing LSTMs (Long Short\PYGZhy{}Term Memory networks) and biological recurrent neural circuits:}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                Similarities:}
\PYG{l+s+s2}{                1. Recurrent connections allowing information persistence over time}
\PYG{l+s+s2}{                2. Selective memory maintenance and forgetting mechanisms}
\PYG{l+s+s2}{                3. Gating mechanisms that control information flow}
\PYG{l+s+s2}{                4. Ability to learn temporal patterns and sequences}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                Key differences:}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                | Feature | LSTMs | Biological Circuits |}
\PYG{l+s+s2}{                |\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}|\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}|\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}|}
\PYG{l+s+s2}{                | Learning mechanism | Backpropagation through time | Spike\PYGZhy{}timing dependent plasticity, neuromodulation |}
\PYG{l+s+s2}{                | Temporal dynamics | Discrete time steps | Continuous\PYGZhy{}time dynamics with varying timescales |}
\PYG{l+s+s2}{                | Memory mechanisms | Explicit cell state | Multiple mechanisms: synaptic, intrinsic, network |}
\PYG{l+s+s2}{                | Unit complexity | Complex LSTM cells with gates | Diverse neuron types with different properties |}
\PYG{l+s+s2}{                | Connectivity | Typically fully connected layers | Sparse, structured connectivity |}
\PYG{l+s+s2}{                | Computation | Floating\PYGZhy{}point operations | Spike\PYGZhy{}based computation with stochastic elements |}
\PYG{l+s+s2}{                | Energy efficiency | High computational cost | Remarkably energy efficient |}
\PYG{l+s+s2}{                }
\PYG{l+s+s2}{                While LSTMs were inspired by biological memory, they primarily serve as functional analogues rather than biologically realistic models. The hippocampal\PYGZhy{}cortical memory system, prefrontal working memory circuits, and thalamocortical loops represent biological systems with recurrent memory functions that operate on different principles than LSTMs.}
\PYG{l+s+s2}{                }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Format data for LoRA fine\PYGZhy{}tuning}
        \PYG{n}{formatted\PYGZus{}data} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{item} \PYG{o+ow}{in} \PYG{n}{instruction\PYGZus{}data}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{item}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{text} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Instruction:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{instruction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Input:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{input}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Response:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{text} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Instruction:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{instruction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZsh{}\PYGZsh{}\PYGZsh{} Response:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{output}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{n}{formatted\PYGZus{}data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{raw\PYGZus{}data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{instruction\PYGZus{}data}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{formatted\PYGZus{}data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{formatted\PYGZus{}data}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{count}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{instruction\PYGZus{}data}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} 5. Create final adaptation strategy combining all approaches}
    \PYG{n}{adaptation\PYGZus{}strategy} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Data Preparation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Collect domain\PYGZhy{}specific research papers, textbooks, and lecture notes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Extract key terminology, concepts, and relationship diagrams}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Create instruction\PYGZhy{}response pairs for common neuroscience questions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Include experimental design scenarios and questions crossing neuroscience and AI}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Technical Implementation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use LoRA fine\PYGZhy{}tuning on pretrained LLM with neuroscience instruction data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Create embedding database of neuroscience reference materials for RAG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Design system prompt establishing the assistant}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s neuroscience expertise}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Develop domain\PYGZhy{}specific few\PYGZhy{}shot examples for complex question types}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Evaluation Methods}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Technical accuracy assessment by neuroscience experts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Factual correctness comparison against textbook knowledge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Citation accuracy for referenced research}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Helpfulness evaluation for experimental design questions}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Sample domain adaptation outputs}
    \PYG{n}{sample\PYGZus{}queries} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{What}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s the difference between supervised and unsupervised learning in terms of neural mechanisms?}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Design an experiment to test the role of the hippocampus in spatial memory}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{How might predictive coding explain hallucinations in schizophrenia?}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{system\PYGZus{}prompt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{neuroscience\PYGZus{}system\PYGZus{}prompt}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{few\PYGZus{}shot\PYGZus{}examples}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{few\PYGZus{}shot\PYGZus{}examples}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sample\PYGZus{}instruction\PYGZus{}data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{create\PYGZus{}instruction\PYGZus{}tuning\PYGZus{}dataset}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{adaptation\PYGZus{}strategy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{adaptation\PYGZus{}strategy}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sample\PYGZus{}queries}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sample\PYGZus{}queries}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
This comprehensive case study demonstrates how to combine system prompts, few\sphinxhyphen{}shot examples, and domain\sphinxhyphen{}specific fine\sphinxhyphen{}tuning to create a specialized neuroscience assistant.


\subsection{12.6.5 Exploring Model Evaluation Metrics}
\label{\detokenize{part4/ch12_large_language_models:exploring-model-evaluation-metrics}}
\sphinxAtStartPar
Let’s examine how to evaluate LLM outputs for different applications:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}llm\PYGZus{}outputs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Demonstrate metrics and techniques for evaluating LLM outputs.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 1. Common evaluation metrics and approaches}
    \PYG{n}{evaluation\PYGZus{}metrics} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Automatic Metrics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BLEU}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Measures n\PYGZhy{}gram overlap with reference texts (common in translation)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ROUGE}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recall\PYGZhy{}oriented metrics for summarization evaluation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BERTScore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic similarity using contextualized embeddings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Perplexity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Measures how well a model predicts a sample (lower is better)}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Human Evaluation Dimensions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Correctness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Factual accuracy of the content}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Relevance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Appropriateness to the given query or instruction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Coherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Logical flow and consistency within the response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Helpfulness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Practical utility for the intended purpose}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Harmlessness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Freedom from unsafe, biased, or harmful content}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LLM\PYGZhy{}as\PYGZhy{}Judge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Using another LLM to evaluate model outputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Approaches}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pairwise comparisons between model outputs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rubric\PYGZhy{}based scoring against defined criteria}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error detection and factual verification}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Limitations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Judge models may share biases with evaluated models}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reliability varies across domains and criteria}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May favor certain response styles}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} 2. Example implementation of simple evaluation function}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}responses}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{,} \PYG{n}{reference}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{human}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Evaluate model responses using specified method.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{human}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simulated human evaluation scores (in practice, real human ratings)}
            \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{correctness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{coherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relevance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{helpfulness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
            
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{response} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Simulated scores from 1\PYGZhy{}5}
                \PYG{n}{results}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{n}{criterion}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)} \PYG{k}{for} \PYG{n}{criterion} \PYG{o+ow}{in} \PYG{n}{criteria}
                \PYG{p}{\PYGZcb{}}
                
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{evaluation\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{human}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{criteria}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{criteria}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{results}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{average\PYGZus{}scores}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                    \PYG{n}{criterion}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{[}\PYG{n}{results}\PYG{p}{[}\PYG{n}{r}\PYG{p}{]}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]} \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n}{results}\PYG{p}{]}\PYG{p}{)} 
                    \PYG{k}{for} \PYG{n}{criterion} \PYG{o+ow}{in} \PYG{n}{criteria}
                \PYG{p}{\PYGZcb{}}
            \PYG{p}{\PYGZcb{}}
            
        \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{automatic}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{and} \PYG{n}{reference} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simple simulation of automatic metrics}
            \PYG{c+c1}{\PYGZsh{} In practice, use libraries like nltk, evaluate, or torchmetrics}
            \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
            
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{response} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Dummy calculations \PYGZhy{} would use actual metrics in practice}
                \PYG{n}{word\PYGZus{}overlap} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{response}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{reference}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{reference}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
                
                \PYG{n}{results}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{word\PYGZus{}overlap}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{word\PYGZus{}overlap}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{response}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{reference}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{simulated\PYGZus{}bleu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{word\PYGZus{}overlap} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{1.2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{simulated\PYGZus{}bertscore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.7} \PYG{o}{+} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{word\PYGZus{}overlap}\PYG{p}{)}
                \PYG{p}{\PYGZcb{}}
                
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{evaluation\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{automatic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{metrics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{word\PYGZus{}overlap}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{simulated\PYGZus{}bleu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{simulated\PYGZus{}bertscore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{results}
            \PYG{p}{\PYGZcb{}}
            
        \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}judge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simulation of using another LLM to judge responses}
            \PYG{n}{judge\PYGZus{}rubric} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{correctness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Evaluate factual accuracy on a scale of 1\PYGZhy{}5}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{coherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Evaluate logical flow on a scale of 1\PYGZhy{}5}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{helpfulness}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Evaluate practical utility on a scale of 1\PYGZhy{}5}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
            
            \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{response} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{responses}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Simulated LLM judgment (in practice, would call an actual LLM)}
                \PYG{n}{results}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{response\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{n}{criterion}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)} \PYG{k}{for} \PYG{n}{criterion} \PYG{o+ow}{in} \PYG{n}{judge\PYGZus{}rubric}
                \PYG{p}{\PYGZcb{}}
                
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{evaluation\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}judge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rubric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{judge\PYGZus{}rubric}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{results}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{error}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Invalid evaluation method or missing reference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} 3. Sample responses to evaluate}
    \PYG{n}{sample\PYGZus{}query} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explain the concept of neural plasticity.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{n}{sample\PYGZus{}responses} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural plasticity refers to the brain}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s ability to change and reorganize itself by forming new neural connections. This property allows the brain to adapt to new experiences, learn, and recover from injuries.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural plasticity is how neurons can change. The brain can make new connections between neurons when you learn new things or after an injury. This happens throughout life but is strongest when you}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{re young.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    \PYG{n}{sample\PYGZus{}reference} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural plasticity, also known as neuroplasticity, is the ability of neural networks in the brain to change through growth and reorganization. These changes range from individual neuron modifications to large\PYGZhy{}scale network rewiring. The phenomenon occurs during normal development, learning, and as an adaptive mechanism following brain injury.}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} 4. Run evaluations (simulated)}
    \PYG{n}{evaluation\PYGZus{}results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{human}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluate\PYGZus{}responses}\PYG{p}{(}\PYG{n}{sample\PYGZus{}responses}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{human}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{automatic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluate\PYGZus{}responses}\PYG{p}{(}\PYG{n}{sample\PYGZus{}responses}\PYG{p}{,} \PYG{n}{reference}\PYG{o}{=}\PYG{n}{sample\PYGZus{}reference}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{automatic}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}judge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluate\PYGZus{}responses}\PYG{p}{(}\PYG{n}{sample\PYGZus{}responses}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{llm\PYGZus{}judge}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{metrics\PYGZus{}overview}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluation\PYGZus{}metrics}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sample\PYGZus{}query}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sample\PYGZus{}query}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sample\PYGZus{}responses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sample\PYGZus{}responses}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sample\PYGZus{}reference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sample\PYGZus{}reference}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{evaluation\PYGZus{}results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{evaluation\PYGZus{}results}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{best\PYGZus{}practices}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Use multiple evaluation methods for comprehensive assessment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Define clear evaluation criteria before assessment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Consider task\PYGZhy{}specific metrics for specialized applications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Combine automatic metrics with human or LLM\PYGZhy{}based evaluation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Benchmark against established models for comparative analysis}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Through these exercises, we’ve explored practical implementations of the key concepts covered in this chapter, from parameter\sphinxhyphen{}efficient fine\sphinxhyphen{}tuning with LoRA to advanced prompting techniques, RAG systems for factual grounding, domain adaptation, and comprehensive evaluation approaches.


\section{12.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part4/ch12_large_language_models:take-aways}}
\begin{sphinxadmonition}{note}{Knowledge Connections}

\sphinxAtStartPar
\sphinxstylestrong{Looking Back}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 7 (Information Theory Essentials)}: Information\sphinxhyphen{}theoretic principles like entropy and KL divergence underpin LLM training objectives and evaluation metrics, connecting statistical learning to language modeling.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 9 (Classical Machine\sphinxhyphen{}Learning Foundations)}: LLMs build upon supervised learning paradigms but extend them to self\sphinxhyphen{}supervised pretraining, where the model generates its own supervision signal.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 10 (Deep Learning)}: The optimization techniques covered in Chapter 10 are essential for training LLMs, with additional considerations for the extreme scale of parameters and compute.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 11 (Sequence Models)}: LLMs are direct descendants of transformer architectures from Chapter 11, scaling up the core architecture while introducing innovations to handle longer contexts.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Looking Forward}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 13 (Multimodal Models)}: LLMs serve as a foundation for multimodal architectures that integrate language understanding with other modalities like vision and audio.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Chapter 14 (Future Directions)}: The scaling laws and emergent abilities of LLMs shown in the scaling law figure point toward future research directions in AI capabilities and limitations.

\end{itemize}
\end{sphinxadmonition}

\sphinxAtStartPar
This chapter explored the fundamentals, fine\sphinxhyphen{}tuning approaches, and advanced applications of Large Language Models, bridging AI capabilities with neuroscience insights:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Architectural Foundations}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
LLMs build on transformer architectures with specialized attention mechanisms and tokenization strategies

\item {} 
\sphinxAtStartPar
Scale plays a crucial role in model capabilities, with emergent abilities appearing at specific thresholds

\item {} 
\sphinxAtStartPar
Training objectives shape model behavior, with next\sphinxhyphen{}token prediction aligning with brain predictive mechanisms

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Fine\sphinxhyphen{}tuning Methods}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Full fine\sphinxhyphen{}tuning provides maximum adaptation but requires substantial resources

\item {} 
\sphinxAtStartPar
Parameter\sphinxhyphen{}efficient methods like LoRA yield comparable results with minimal parameter updates

\item {} 
\sphinxAtStartPar
Instruction fine\sphinxhyphen{}tuning aligns models with human intent and task understanding

\item {} 
\sphinxAtStartPar
RLHF leverages human preferences to improve helpfulness, harmlessness, and honesty

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prompting Techniques}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Zero\sphinxhyphen{}shot and few\sphinxhyphen{}shot learning enable task adaptation without weight updates

\item {} 
\sphinxAtStartPar
Chain\sphinxhyphen{}of\sphinxhyphen{}thought prompting dramatically improves reasoning capabilities

\item {} 
\sphinxAtStartPar
System prompts establish model behavior patterns and specialized domains

\item {} 
\sphinxAtStartPar
Effective prompt engineering significantly enhances model outputs

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological Parallels}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
LLMs exhibit similarities to brain language networks at multiple levels

\item {} 
\sphinxAtStartPar
Predictive processing is central to both human and artificial language systems

\item {} 
\sphinxAtStartPar
Attention mechanisms parallel neural selective enhancement

\item {} 
\sphinxAtStartPar
Both systems must solve the binding problem for compositional representation

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Limitations and Challenges}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hallucinations require factual grounding and reliability safeguards

\item {} 
\sphinxAtStartPar
Bias mitigation demands ongoing development of fair representation

\item {} 
\sphinxAtStartPar
Context window limitations constrain document\sphinxhyphen{}level understanding

\item {} 
\sphinxAtStartPar
Reasoning capabilities show both impressive advances and significant gaps

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Implementation Insights}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Combining fine\sphinxhyphen{}tuning, prompting, and retrieval yields powerful applications

\item {} 
\sphinxAtStartPar
Domain adaptation creates specialized capabilities beyond general models

\item {} 
\sphinxAtStartPar
Comprehensive evaluation must consider multiple dimensions of performance

\item {} 
\sphinxAtStartPar
Trade\sphinxhyphen{}offs between efficiency, accuracy, and flexibility guide system design

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
The integration of neuroscience principles with LLM development creates a virtuous cycle, where brain\sphinxhyphen{}inspired mechanisms enhance AI capabilities while AI insights deepen our understanding of human language processing. This cross\sphinxhyphen{}disciplinary approach promises continued advances in both fields.


\section{12.8 Further Reading \& Media}
\label{\detokenize{part4/ch12_large_language_models:further-reading-media}}

\subsection{Foundational Papers}
\label{\detokenize{part4/ch12_large_language_models:foundational-papers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Brown, T., et al. (2020). \sphinxhref{https://papers.nips.cc/paper/2020/hash/1457c0d6bfcb4967418bfb8ac142f64a-Abstract.html}{Language Models are Few\sphinxhyphen{}Shot Learners}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems, 33}.

\item {} 
\sphinxAtStartPar
Vaswani, A., et al. (2017). \sphinxhref{https://papers.nips.cc/paper/2017/hash/3f5ee243547dee91fbd053c1c4a845aa-Abstract.html}{Attention Is All You Need}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems, 30}.

\item {} 
\sphinxAtStartPar
Kaplan, J., et al. (2020). \sphinxhref{https://arxiv.org/abs/2001.08361}{Scaling Laws for Neural Language Models}. \sphinxstyleemphasis{arXiv preprint arXiv:2001.08361}.

\end{itemize}


\subsection{Fine\sphinxhyphen{}tuning \& Adaptation}
\label{\detokenize{part4/ch12_large_language_models:fine-tuning-adaptation}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hu, E., et al. (2021). \sphinxhref{https://arxiv.org/abs/2106.09685}{LoRA: Low\sphinxhyphen{}Rank Adaptation of Large Language Models}. \sphinxstyleemphasis{International Conference on Learning Representations (ICLR)}.

\item {} 
\sphinxAtStartPar
Ouyang, L., et al. (2022). \sphinxhref{https://arxiv.org/abs/2203.02155}{Training Language Models to Follow Instructions with Human Feedback}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems, 35}.

\item {} 
\sphinxAtStartPar
Houlsby, N., et al. (2019). \sphinxhref{http://proceedings.mlr.press/v97/houlsby19a.html}{Parameter\sphinxhyphen{}Efficient Transfer Learning for NLP}. \sphinxstyleemphasis{International Conference on Machine Learning}.

\end{itemize}


\subsection{Prompting \& Reasoning}
\label{\detokenize{part4/ch12_large_language_models:prompting-reasoning}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Wei, J., et al. (2022). \sphinxhref{https://arxiv.org/abs/2201.11903}{Chain of Thought Prompting Elicits Reasoning in Large Language Models}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems, 35}.

\item {} 
\sphinxAtStartPar
Kojima, T., et al. (2022). \sphinxhref{https://arxiv.org/abs/2205.11916}{Large Language Models are Zero\sphinxhyphen{}Shot Reasoners}. \sphinxstyleemphasis{Advances in Neural Information Processing Systems, 35}.

\item {} 
\sphinxAtStartPar
Reynolds, L., \& McDonell, K. (2021). \sphinxhref{https://arxiv.org/abs/2102.07350}{Prompt Programming for Large Language Models: Beyond the Few\sphinxhyphen{}Shot Paradigm}. \sphinxstyleemphasis{CHI Conference on Human Factors in Computing Systems}.

\end{itemize}


\subsection{Neuroscience Connections}
\label{\detokenize{part4/ch12_large_language_models:neuroscience-connections}}\begin{itemize}
\item {} 
\sphinxAtStartPar
McClelland, J. L., et al. (2020). \sphinxhref{https://arxiv.org/abs/1912.05877}{Extending Machine Language Models toward Human\sphinxhyphen{}Level Language Understanding}. \sphinxstyleemphasis{arXiv preprint arXiv:1912.05877}.

\item {} 
\sphinxAtStartPar
Caucheteux, C., \& King, J. R. (2022). \sphinxhref{https://www.nature.com/articles/s42003-022-03036-1}{Brains and algorithms partially converge in natural language processing}. \sphinxstyleemphasis{Communications Biology, 5(1)}.

\item {} 
\sphinxAtStartPar
Schrimpf, M., et al. (2021). \sphinxhref{https://www.pnas.org/doi/10.1073/pnas.2105646118}{The neural architecture of language: Integrative modeling converges on predictive processing}. \sphinxstyleemphasis{Proceedings of the National Academy of Sciences, 118(45)}.

\end{itemize}


\subsection{Limitations \& Challenges}
\label{\detokenize{part4/ch12_large_language_models:limitations-challenges}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Bender, E. M., et al. (2021). \sphinxhref{https://dl.acm.org/doi/10.1145/3442188.3445922}{On the Dangers of Stochastic Parrots: Can Language Models Be Too Big?}. \sphinxstyleemphasis{FAccT ‘21: Proceedings of the 2021 ACM Conference on Fairness, Accountability, and Transparency}.

\item {} 
\sphinxAtStartPar
Bommasani, R., et al. (2021). \sphinxhref{https://arxiv.org/abs/2108.07258}{On the Opportunities and Risks of Foundation Models}. \sphinxstyleemphasis{arXiv preprint arXiv:2108.07258}.

\item {} 
\sphinxAtStartPar
Ji, Z., et al. (2023). \sphinxhref{https://arxiv.org/abs/2202.03629}{Survey of Hallucination in Natural Language Generation}. \sphinxstyleemphasis{ACM Computing Surveys}.

\end{itemize}


\subsection{Books \& Resources}
\label{\detokenize{part4/ch12_large_language_models:books-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Jurafsky, D., \& Martin, J. H. (2023). \sphinxstyleemphasis{\sphinxhref{https://web.stanford.edu/~jurafsky/slp3/}{Speech and Language Processing}}. 3rd Edition Draft.

\item {} 
\sphinxAtStartPar
LeCun, Y., Bengio, Y., \& Hinton, G. (2015). \sphinxhref{https://www.nature.com/articles/nature14539}{Deep learning}. \sphinxstyleemphasis{Nature, 521(7553)}, 436\sphinxhyphen{}444.

\item {} 
\sphinxAtStartPar
Cobbe, K., et al. (2021). \sphinxhref{https://arxiv.org/abs/2110.14168}{Training Verifiers to Solve Math Word Problems}. \sphinxstyleemphasis{arXiv preprint arXiv:2110.14168}.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 13: Multimodal \& Diffusion Models}
\label{\detokenize{part4/ch13_multimodal_models:chapter-13-multimodal-diffusion-models}}\label{\detokenize{part4/ch13_multimodal_models::doc}}

\section{13.0 Chapter Goals}
\label{\detokenize{part4/ch13_multimodal_models:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand multimodal learning architectures and their parallels to multisensory integration in the brain

\item {} 
\sphinxAtStartPar
Master diffusion model principles and their mathematical foundations

\item {} 
\sphinxAtStartPar
Connect multimodal integration in AI to multisensory processing in biological systems

\item {} 
\sphinxAtStartPar
Implement basic generative models with controlled generation capabilities

\end{itemize}


\section{13.1 Multimodal Learning Foundations}
\label{\detokenize{part4/ch13_multimodal_models:multimodal-learning-foundations}}
\sphinxAtStartPar
Multimodal learning involves training models to process and integrate information from multiple modalities (e.g., vision, language, audio). These models demonstrate remarkable capabilities in cross\sphinxhyphen{}modal understanding and generation that mirror the brain’s multisensory integration mechanisms.


\subsection{13.1.1 Cross\sphinxhyphen{}modal Representations}
\label{\detokenize{part4/ch13_multimodal_models:cross-modal-representations}}
\sphinxAtStartPar
Cross\sphinxhyphen{}modal representations allow information to be encoded in a way that captures relationships between different modalities. Consider how a visual concept like “apple” relates to textual descriptions (“round red fruit”), tactile sensations (smooth, firm), and taste (sweet\sphinxhyphen{}tart).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MultimodalEncoder}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{visual\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{2048}\PYG{p}{,} \PYG{n}{text\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{768}\PYG{p}{,} \PYG{n}{joint\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{512}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Visual encoder projection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{visual\PYGZus{}encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{visual\PYGZus{}dim}\PYG{p}{,} \PYG{n}{joint\PYGZus{}dim}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{joint\PYGZus{}dim}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{joint\PYGZus{}dim}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Text encoder projection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{text\PYGZus{}encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{text\PYGZus{}dim}\PYG{p}{,} \PYG{n}{joint\PYGZus{}dim}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{joint\PYGZus{}dim}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{joint\PYGZus{}dim}\PYG{p}{)}
        \PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{visual\PYGZus{}features}\PYG{p}{,} \PYG{n}{text\PYGZus{}features}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Project both modalities to same dimension}
        \PYG{n}{visual\PYGZus{}emb} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{visual\PYGZus{}encoder}\PYG{p}{(}\PYG{n}{visual\PYGZus{}features}\PYG{p}{)}
        \PYG{n}{text\PYGZus{}emb} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{text\PYGZus{}encoder}\PYG{p}{(}\PYG{n}{text\PYGZus{}features}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalize embeddings for cosine similarity}
        \PYG{n}{visual\PYGZus{}emb} \PYG{o}{=} \PYG{n}{visual\PYGZus{}emb} \PYG{o}{/} \PYG{n}{visual\PYGZus{}emb}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{keepdim}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{text\PYGZus{}emb} \PYG{o}{=} \PYG{n}{text\PYGZus{}emb} \PYG{o}{/} \PYG{n}{text\PYGZus{}emb}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{keepdim}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{visual\PYGZus{}emb}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}
\end{sphinxVerbatim}

\sphinxAtStartPar
This architecture resembles how the brain’s association areas integrate information from primary sensory regions, creating higher\sphinxhyphen{}order representations that combine features across modalities.


\subsection{13.1.2 Contrastive Learning (CLIP)}
\label{\detokenize{part4/ch13_multimodal_models:contrastive-learning-clip}}
\sphinxAtStartPar
Contrastive Language\sphinxhyphen{}Image Pretraining (CLIP) represents a breakthrough in multimodal learning. By training on image\sphinxhyphen{}text pairs from the internet, CLIP learns to align visual and linguistic representations.

\sphinxAtStartPar
The contrastive objective maximizes similarity between matching image\sphinxhyphen{}text pairs while minimizing similarity between non\sphinxhyphen{}matching pairs:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{contrastive\PYGZus{}loss}\PYG{p}{(}\PYG{n}{visual\PYGZus{}emb}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}\PYG{p}{,} \PYG{n}{temperature}\PYG{o}{=}\PYG{l+m+mf}{0.07}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute contrastive loss between visual and text embeddings}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Compute similarities between all possible image\PYGZhy{}text pairs}
    \PYG{n}{logits} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{visual\PYGZus{}emb}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}\PYG{o}{.}\PYG{n}{t}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{temperature}
    
    \PYG{c+c1}{\PYGZsh{} Labels: diagonal elements are the matching pairs (= True pairs)}
    \PYG{n}{labels} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{visual\PYGZus{}emb}\PYG{p}{)}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{visual\PYGZus{}emb}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute cross entropy loss in both directions}
    \PYG{n}{loss\PYGZus{}i} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{logits}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}
    \PYG{n}{loss\PYGZus{}t} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{logits}\PYG{o}{.}\PYG{n}{t}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Average both directions}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{loss\PYGZus{}i} \PYG{o}{+} \PYG{n}{loss\PYGZus{}t}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{2.0}
\end{sphinxVerbatim}

\sphinxAtStartPar
This resembles how the brain learns cross\sphinxhyphen{}modal associations through temporal coincidence \sphinxhyphen{} stimuli that frequently co\sphinxhyphen{}occur become associated in neural representations.


\subsection{13.1.3 Joint Embedding Spaces}
\label{\detokenize{part4/ch13_multimodal_models:joint-embedding-spaces}}
\sphinxAtStartPar
Joint embedding spaces map inputs from different modalities into a common representation space where semantic relationships are preserved. In this space, related concepts across modalities (e.g., an image of a dog and the word “dog”) are closer together than unrelated concepts.

\sphinxAtStartPar
\sphinxincludegraphics{{multimodal_learning}.svg}

\sphinxAtStartPar
This resembles how the brain’s multisensory neurons in regions like the superior temporal sulcus respond to both visual and auditory stimuli related to the same concept.


\subsection{13.1.4 Alignment and Grounding}
\label{\detokenize{part4/ch13_multimodal_models:alignment-and-grounding}}
\sphinxAtStartPar
Alignment ensures that representations from different modalities properly correspond to each other, while grounding connects these representations to real\sphinxhyphen{}world concepts. Recent models like CLIP demonstrate remarkable zero\sphinxhyphen{}shot capabilities by leveraging these principles.


\section{13.2 Diffusion Models}
\label{\detokenize{part4/ch13_multimodal_models:diffusion-models}}
\sphinxAtStartPar
Diffusion models have revolutionized generative AI by enabling high\sphinxhyphen{}quality image synthesis through a process inspired by thermodynamics.


\subsection{13.2.1 Forward and Reverse Diffusion Processes}
\label{\detokenize{part4/ch13_multimodal_models:forward-and-reverse-diffusion-processes}}
\sphinxAtStartPar
The diffusion process consists of two phases:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Forward diffusion}: Gradually adds Gaussian noise to an image until it becomes pure noise

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reverse diffusion}: Learns to gradually remove noise to recover the original image

\end{enumerate}

\sphinxAtStartPar
\sphinxincludegraphics{{diffusion_process}.svg}

\sphinxAtStartPar
The forward process is defined by:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward\PYGZus{}diffusion}\PYG{p}{(}\PYG{n}{x\PYGZus{}0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{noise\PYGZus{}scheduler}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply t steps of forward diffusion to an image x\PYGZus{}0}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} x\PYGZus{}0: Original image}
\PYG{l+s+sd}{    \PYGZhy{} t: Timestep (amount of noise to add)}
\PYG{l+s+sd}{    \PYGZhy{} noise\PYGZus{}scheduler: Controls noise schedule}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} Noised image x\PYGZus{}t}
\PYG{l+s+sd}{    \PYGZhy{} Noise added}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Get noise scaling for timestep t}
    \PYG{n}{alpha\PYGZus{}t} \PYG{o}{=} \PYG{n}{noise\PYGZus{}scheduler}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}
    \PYG{n}{sqrt\PYGZus{}alpha\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{alpha\PYGZus{}t}\PYG{p}{)}
    \PYG{n}{sqrt\PYGZus{}one\PYGZus{}minus\PYGZus{}alpha\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Sample noise}
    \PYG{n}{epsilon} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{x\PYGZus{}0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply noise according to diffusion equation}
    \PYG{n}{x\PYGZus{}t} \PYG{o}{=} \PYG{n}{sqrt\PYGZus{}alpha\PYGZus{}t} \PYG{o}{*} \PYG{n}{x\PYGZus{}0} \PYG{o}{+} \PYG{n}{sqrt\PYGZus{}one\PYGZus{}minus\PYGZus{}alpha\PYGZus{}t} \PYG{o}{*} \PYG{n}{epsilon}
    
    \PYG{k}{return} \PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{epsilon}
\end{sphinxVerbatim}


\subsection{13.2.2 Denoising Score Matching}
\label{\detokenize{part4/ch13_multimodal_models:denoising-score-matching}}
\sphinxAtStartPar
Diffusion models are trained to predict the noise added at each step, enabling the reversal of the diffusion process:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{diffusion\PYGZus{}training\PYGZus{}loss}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{x\PYGZus{}0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}scheduler}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute loss for training a diffusion model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{x\PYGZus{}0}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Sample random timesteps}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{noise\PYGZus{}scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,}\PYG{p}{)}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{x\PYGZus{}0}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply forward diffusion to get noisy images}
    \PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{noise\PYGZus{}added} \PYG{o}{=} \PYG{n}{forward\PYGZus{}diffusion}\PYG{p}{(}\PYG{n}{x\PYGZus{}0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{noise\PYGZus{}scheduler}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Predict the noise}
    \PYG{n}{noise\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simple MSE loss between actual and predicted noise}
    \PYG{k}{return} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{noise\PYGZus{}pred}\PYG{p}{,} \PYG{n}{noise\PYGZus{}added}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{13.2.3 Sampling Techniques}
\label{\detokenize{part4/ch13_multimodal_models:sampling-techniques}}
\sphinxAtStartPar
To generate new images, we start with random noise and iteratively denoise:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{noise\PYGZus{}scheduler}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{,} \PYG{n}{device}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Generate a new image by sampling from the diffusion model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Start from random noise}
    \PYG{n}{x\PYGZus{}T} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{shape}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device}\PYG{p}{)}
    \PYG{n}{x\PYGZus{}t} \PYG{o}{=} \PYG{n}{x\PYGZus{}T}
    
    \PYG{c+c1}{\PYGZsh{} Iteratively denoise}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{noise\PYGZus{}scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{t\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{full}\PYG{p}{(}\PYG{p}{(}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{)}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{long}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Predict noise}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{predicted\PYGZus{}noise} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{t\PYGZus{}tensor}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get alpha values for current timestep}
        \PYG{n}{alpha\PYGZus{}t} \PYG{o}{=} \PYG{n}{noise\PYGZus{}scheduler}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}
        \PYG{n}{alpha\PYGZus{}t\PYGZus{}prev} \PYG{o}{=} \PYG{n}{noise\PYGZus{}scheduler}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{[}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply formula for reverse process step}
        \PYG{c+c1}{\PYGZsh{} (Simplified version of the full algorithm)}
        \PYG{n}{coef1} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{alpha\PYGZus{}t}\PYG{p}{)}
        \PYG{n}{coef2} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t}\PYG{p}{)} \PYG{o}{/} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t}\PYG{p}{)}
        
        \PYG{n}{x\PYGZus{}t} \PYG{o}{=} \PYG{n}{coef1} \PYG{o}{*} \PYG{p}{(}\PYG{n}{x\PYGZus{}t} \PYG{o}{\PYGZhy{}} \PYG{n}{coef2} \PYG{o}{*} \PYG{n}{predicted\PYGZus{}noise}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add noise for t \PYGZgt{} 0}
        \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{sigma\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}
                \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t\PYGZus{}prev}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}t} \PYG{o}{/} \PYG{n}{alpha\PYGZus{}t\PYGZus{}prev}\PYG{p}{)}
            \PYG{p}{)}
            \PYG{n}{x\PYGZus{}t} \PYG{o}{+}\PYG{o}{=} \PYG{n}{sigma\PYGZus{}t} \PYG{o}{*} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{x\PYGZus{}t}
\end{sphinxVerbatim}


\subsection{13.2.4 Model Architectures (U\sphinxhyphen{}Nets)}
\label{\detokenize{part4/ch13_multimodal_models:model-architectures-u-nets}}
\sphinxAtStartPar
Diffusion models typically use U\sphinxhyphen{}Net architectures with time conditioning:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleUNet}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{channels}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{time\PYGZus{}emb\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Time embedding}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}embed} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{time\PYGZus{}emb\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{SiLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{time\PYGZus{}emb\PYGZus{}dim}\PYG{p}{,} \PYG{n}{time\PYGZus{}emb\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simplified U\PYGZhy{}Net structure}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Middle blocks with time conditioning}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}conv1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}time} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{time\PYGZus{}emb\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}conv2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Upsampling path}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Embed time}
        \PYG{n}{t\PYGZus{}emb} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}embed}\PYG{p}{(}\PYG{n}{t}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Downsample}
        \PYG{n}{x1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down2}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down3}\PYG{p}{(}\PYG{n}{x2}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Middle with time conditioning}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}conv1}\PYG{p}{(}\PYG{n}{x3}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{h} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}time}\PYG{p}{(}\PYG{n}{t\PYGZus{}emb}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{]}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mid\PYGZus{}conv2}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Upsample}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up1}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{functional}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up2}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up3}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{h}
\end{sphinxVerbatim}


\section{13.3 Text\sphinxhyphen{}to\sphinxhyphen{}Image Models}
\label{\detokenize{part4/ch13_multimodal_models:text-to-image-models}}
\sphinxAtStartPar
Text\sphinxhyphen{}to\sphinxhyphen{}image models combine diffusion models with text conditioning to generate images from text descriptions.


\subsection{13.3.1 Leading Models: DALL\sphinxhyphen{}E, Stable Diffusion, Midjourney}
\label{\detokenize{part4/ch13_multimodal_models:leading-models-dall-e-stable-diffusion-midjourney}}
\sphinxAtStartPar
Several breakthrough models have demonstrated impressive text\sphinxhyphen{}to\sphinxhyphen{}image capabilities:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{DALL\sphinxhyphen{}E 2/3}: OpenAI’s models use diffusion and CLIP\sphinxhyphen{}like conditioning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stable Diffusion}: Latent diffusion model that operates in a compressed latent space

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Midjourney}: Proprietary architecture with remarkable aesthetic quality

\end{itemize}


\subsection{13.3.2 Conditioning Mechanisms}
\label{\detokenize{part4/ch13_multimodal_models:conditioning-mechanisms}}
\sphinxAtStartPar
Text\sphinxhyphen{}to\sphinxhyphen{}image models incorporate text information through conditioning mechanisms:

\sphinxAtStartPar
\sphinxincludegraphics{{text_to_image}.svg}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{classifier\PYGZus{}free\PYGZus{}guidance}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}\PYG{p}{,} \PYG{n}{guidance\PYGZus{}scale}\PYG{o}{=}\PYG{l+m+mf}{7.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply classifier\PYGZhy{}free guidance for controlled generation}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Get unconditional prediction (empty text embedding)}
    \PYG{n}{null\PYGZus{}text\PYGZus{}emb} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{text\PYGZus{}emb}\PYG{p}{)}
    \PYG{n}{noise\PYGZus{}pred\PYGZus{}uncond} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{null\PYGZus{}text\PYGZus{}emb}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get conditional prediction (with text embedding)}
    \PYG{n}{noise\PYGZus{}pred\PYGZus{}text} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply guidance}
    \PYG{n}{noise\PYGZus{}pred} \PYG{o}{=} \PYG{n}{noise\PYGZus{}pred\PYGZus{}uncond} \PYG{o}{+} \PYG{n}{guidance\PYGZus{}scale} \PYG{o}{*} \PYG{p}{(}\PYG{n}{noise\PYGZus{}pred\PYGZus{}text} \PYG{o}{\PYGZhy{}} \PYG{n}{noise\PYGZus{}pred\PYGZus{}uncond}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{noise\PYGZus{}pred}
\end{sphinxVerbatim}


\subsection{13.3.3 Latent Spaces}
\label{\detokenize{part4/ch13_multimodal_models:latent-spaces}}
\sphinxAtStartPar
Stable Diffusion operates in a compressed latent space rather than pixel space, reducing computational requirements while maintaining generation quality:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LatentDiffusionModel}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{vae\PYGZus{}encoder} \PYG{o}{=} \PYG{n}{VAEEncoder}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{vae\PYGZus{}decoder} \PYG{o}{=} \PYG{n}{VAEDecoder}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{diffusion\PYGZus{}model} \PYG{o}{=} \PYG{n}{UNetWithTextCondition}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{text\PYGZus{}encoder} \PYG{o}{=} \PYG{n}{TextEncoder}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encode\PYGZus{}image}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{image}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{vae\PYGZus{}encoder}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decode\PYGZus{}latents}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{latents}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{vae\PYGZus{}decoder}\PYG{p}{(}\PYG{n}{latents}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encode\PYGZus{}text}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{text}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{text\PYGZus{}encoder}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{text}\PYG{p}{,} \PYG{n}{steps}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Encode text prompt}
        \PYG{n}{text\PYGZus{}embedding} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode\PYGZus{}text}\PYG{p}{(}\PYG{n}{text}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Start from random latent}
        \PYG{n}{latent} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reverse diffusion process}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Denoise one step with text conditioning}
            \PYG{n}{latent} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{diffusion\PYGZus{}step}\PYG{p}{(}\PYG{n}{latent}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{text\PYGZus{}embedding}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decode latent to image}
        \PYG{n}{image} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decode\PYGZus{}latents}\PYG{p}{(}\PYG{n}{latent}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{image}
\end{sphinxVerbatim}


\subsection{13.3.4 Text Encoders and Cross\sphinxhyphen{}Attention}
\label{\detokenize{part4/ch13_multimodal_models:text-encoders-and-cross-attention}}
\sphinxAtStartPar
Text\sphinxhyphen{}to\sphinxhyphen{}image models use transformers to encode text and cross\sphinxhyphen{}attention to incorporate text information into the diffusion process:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CrossAttentionBlock}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{,} \PYG{n}{text\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{768}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GroupNorm}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{k} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{text\PYGZus{}dim}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{text\PYGZus{}dim}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{proj\PYGZus{}out} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale} \PYG{o}{=} \PYG{n}{channels} \PYG{o}{*}\PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{text\PYGZus{}features}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        x: [B, C, H, W] \PYGZhy{} image features}
\PYG{l+s+sd}{        text\PYGZus{}features: [B, L, D] \PYGZhy{} text features}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{w} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}
        \PYG{n}{residual} \PYG{o}{=} \PYG{n}{x}
        
        \PYG{c+c1}{\PYGZsh{} Normalize input}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape for attention}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{batch}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [B, H*W, C]}
        
        \PYG{c+c1}{\PYGZsh{} Compute attention}
        \PYG{n}{q} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale}
        \PYG{n}{k} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{k}\PYG{p}{(}\PYG{n}{text\PYGZus{}features}\PYG{p}{)}
        \PYG{n}{v} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{(}\PYG{n}{text\PYGZus{}features}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Attention weights}
        \PYG{n}{attn} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{bmm}\PYG{p}{(}\PYG{n}{q}\PYG{p}{,} \PYG{n}{k}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [B, H*W, L]}
        \PYG{n}{attn} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attn}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply attention}
        \PYG{n}{out} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{bmm}\PYG{p}{(}\PYG{n}{attn}\PYG{p}{,} \PYG{n}{v}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [B, H*W, C]}
        \PYG{n}{out} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{proj\PYGZus{}out}\PYG{p}{(}\PYG{n}{out}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape back and add residual}
        \PYG{n}{out} \PYG{o}{=} \PYG{n}{out}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{batch}\PYG{p}{,} \PYG{n}{c}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{w}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{out} \PYG{o}{+} \PYG{n}{residual}
\end{sphinxVerbatim}


\section{13.4 Video and Audio Generation}
\label{\detokenize{part4/ch13_multimodal_models:video-and-audio-generation}}
\sphinxAtStartPar
Diffusion models have been extended to generate video and audio by handling temporal dimensions.


\subsection{13.4.1 Temporal Extensions of Diffusion Models}
\label{\detokenize{part4/ch13_multimodal_models:temporal-extensions-of-diffusion-models}}
\sphinxAtStartPar
Video diffusion models add time as an additional dimension:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{VideoUNet}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{channels}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{frames}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Spatio\PYGZhy{}temporal convolutions}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3d\PYGZus{}1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3d\PYGZus{}2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Additional layers...}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{text\PYGZus{}emb}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} x: [B, C, F, H, W] \PYGZhy{} batch, channels, frames, height, width}
        \PYG{c+c1}{\PYGZsh{} Process video with temporal context}
        \PYG{c+c1}{\PYGZsh{} ...}
\end{sphinxVerbatim}


\subsection{13.4.2 Audio Generation Approaches}
\label{\detokenize{part4/ch13_multimodal_models:audio-generation-approaches}}
\sphinxAtStartPar
Audio generation models leverage similar principles but with adaptations for 1D sequences:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AudioDiffusion}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{sample\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{16000}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} 1D convolutions for audio}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1d\PYGZus{}1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv1d}\PYG{p}{(}\PYG{n}{channels}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1d\PYGZus{}2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv1d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Additional layers...}
\end{sphinxVerbatim}


\subsection{13.4.3 Consistency Techniques}
\label{\detokenize{part4/ch13_multimodal_models:consistency-techniques}}
\sphinxAtStartPar
Generating coherent video requires consistency across frames, often addressed through specialized architectures and loss functions:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{consistency\PYGZus{}loss}\PYG{p}{(}\PYG{n}{frames\PYGZus{}pred}\PYG{p}{,} \PYG{n}{frames\PYGZus{}gt}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute both per\PYGZhy{}frame loss and temporal consistency loss}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Per\PYGZhy{}frame reconstruction loss}
    \PYG{n}{frame\PYGZus{}loss} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{frames\PYGZus{}pred}\PYG{p}{,} \PYG{n}{frames\PYGZus{}gt}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Temporal consistency: compare frame differences}
    \PYG{n}{frame\PYGZus{}diffs\PYGZus{}pred} \PYG{o}{=} \PYG{n}{frames\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{frames\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{frame\PYGZus{}diffs\PYGZus{}gt} \PYG{o}{=} \PYG{n}{frames\PYGZus{}gt}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{frames\PYGZus{}gt}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{n}{temporal\PYGZus{}loss} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{frame\PYGZus{}diffs\PYGZus{}pred}\PYG{p}{,} \PYG{n}{frame\PYGZus{}diffs\PYGZus{}gt}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{frame\PYGZus{}loss} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{temporal\PYGZus{}loss}
\end{sphinxVerbatim}


\section{13.5 Neural Multimodal Integration}
\label{\detokenize{part4/ch13_multimodal_models:neural-multimodal-integration}}
\sphinxAtStartPar
The brain’s multisensory integration systems provide inspiration for artificial multimodal models.


\subsection{13.5.1 Multisensory Areas in the Brain}
\label{\detokenize{part4/ch13_multimodal_models:multisensory-areas-in-the-brain}}
\sphinxAtStartPar
Several brain regions integrate information across sensory modalities:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Superior Temporal Sulcus (STS)}: Integrates visual and auditory information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Posterior Parietal Cortex}: Combines visual, proprioceptive, and tactile information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prefrontal Cortex}: Higher\sphinxhyphen{}level integration of multiple modalities

\end{itemize}

\sphinxAtStartPar
\sphinxincludegraphics{{neural_multimodal}.svg}


\subsection{13.5.2 Cross\sphinxhyphen{}modal Binding and Attention}
\label{\detokenize{part4/ch13_multimodal_models:cross-modal-binding-and-attention}}
\sphinxAtStartPar
The brain uses several mechanisms to bind information across modalities:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}cross\PYGZus{}modal\PYGZus{}binding}\PYG{p}{(}\PYG{n}{visual\PYGZus{}input}\PYG{p}{,} \PYG{n}{auditory\PYGZus{}input}\PYG{p}{,} \PYG{n}{semantic\PYGZus{}congruence}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate cross\PYGZhy{}modal binding with the McGurk effect}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} visual\PYGZus{}input: Visual speech cue (e.g., lip movements for \PYGZdq{}ga\PYGZdq{})}
\PYG{l+s+sd}{    \PYGZhy{} auditory\PYGZus{}input: Auditory speech cue (e.g., sound \PYGZdq{}ba\PYGZdq{})}
\PYG{l+s+sd}{    \PYGZhy{} semantic\PYGZus{}congruence: How congruent the stimuli are (0\PYGZhy{}1)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} Perceived output after cross\PYGZhy{}modal integration}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simple model of superior temporal sulcus integration}
    \PYG{n}{visual\PYGZus{}weight} \PYG{o}{=} \PYG{l+m+mf}{0.4}  \PYG{c+c1}{\PYGZsh{} Visual influence}
    \PYG{n}{auditory\PYGZus{}weight} \PYG{o}{=} \PYG{l+m+mf}{0.6}  \PYG{c+c1}{\PYGZsh{} Auditory influence}
    
    \PYG{c+c1}{\PYGZsh{} Modulate influence by congruence}
    \PYG{k}{if} \PYG{n}{semantic\PYGZus{}congruence} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.5}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Less binding when stimuli don\PYGZsq{}t match}
        \PYG{n}{visual\PYGZus{}weight} \PYG{o}{*}\PYG{o}{=} \PYG{n}{semantic\PYGZus{}congruence}
        \PYG{n}{auditory\PYGZus{}weight} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{visual\PYGZus{}weight}
    
    \PYG{c+c1}{\PYGZsh{} Weighted integration (simplified)}
    \PYG{n}{perceived\PYGZus{}output} \PYG{o}{=} \PYG{p}{(}
        \PYG{n}{visual\PYGZus{}weight} \PYG{o}{*} \PYG{n}{visual\PYGZus{}input} \PYG{o}{+} 
        \PYG{n}{auditory\PYGZus{}weight} \PYG{o}{*} \PYG{n}{auditory\PYGZus{}input}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For McGurk effect, return illusory perception}
    \PYG{k}{if} \PYG{l+m+mf}{0.3} \PYG{o}{\PYGZlt{}} \PYG{n}{semantic\PYGZus{}congruence} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.7}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create illusory perception (e.g., \PYGZdq{}da\PYGZdq{} from visual \PYGZdq{}ga\PYGZdq{} + auditory \PYGZdq{}ba\PYGZdq{})}
        \PYG{n}{perceived\PYGZus{}output} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{da}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} Simplified illustration}
    
    \PYG{k}{return} \PYG{n}{perceived\PYGZus{}output}
\end{sphinxVerbatim}


\subsection{13.5.3 Hierarchical Sensory Processing}
\label{\detokenize{part4/ch13_multimodal_models:hierarchical-sensory-processing}}
\sphinxAtStartPar
The brain processes sensory information hierarchically, with increasing complexity and multimodal integration at higher levels:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{hierarchical\PYGZus{}sensory\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{c+c1}{\PYGZsh{} Primary visual cortex (V1) \PYGZhy{} simple features}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} V2/V4 \PYGZhy{} more complex features}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Inferotemporal cortex \PYGZhy{} object recognition}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Flattening for higher levels}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Higher association areas \PYGZhy{} multimodal integration}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{256} \PYG{o}{*} \PYG{l+m+mi}{8} \PYG{o}{*} \PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{512}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Decision outputs}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{512}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{p}{)}
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}


\subsection{13.5.4 Crossmodal Illusions and Phenomena}
\label{\detokenize{part4/ch13_multimodal_models:crossmodal-illusions-and-phenomena}}
\sphinxAtStartPar
Studying crossmodal illusions provides insights into how the brain integrates information:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{McGurk Effect}: Visual lip movements change auditory perception

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Ventriloquist Effect}: Sound source is perceived as coming from a moving visual target

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Double Flash Illusion}: A single flash with two beeps is perceived as two flashes

\end{itemize}


\section{13.6 Code Lab: Simple Diffusion Model}
\label{\detokenize{part4/ch13_multimodal_models:code-lab-simple-diffusion-model}}
\sphinxAtStartPar
Let’s implement a simplified diffusion model for image generation:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tqdm}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{tqdm}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{DiffusionScheduler}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}timesteps}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{beta\PYGZus{}start}\PYG{o}{=}\PYG{l+m+mf}{0.0001}\PYG{p}{,} \PYG{n}{beta\PYGZus{}end}\PYG{o}{=}\PYG{l+m+mf}{0.02}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Diffusion scheduler that manages the noise schedule}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps} \PYG{o}{=} \PYG{n}{num\PYGZus{}timesteps}
        
        \PYG{c+c1}{\PYGZsh{} Linear schedule of variance over time}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{betas} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{beta\PYGZus{}start}\PYG{p}{,} \PYG{n}{beta\PYGZus{}end}\PYG{p}{,} \PYG{n}{num\PYGZus{}timesteps}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate alphas for convenience}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{betas}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cumprod}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod\PYGZus{}prev} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{pad}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate other required values}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sqrt\PYGZus{}alphas\PYGZus{}cumprod} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sqrt\PYGZus{}one\PYGZus{}minus\PYGZus{}alphas\PYGZus{}cumprod} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mf}{1.} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sqrt\PYGZus{}recip\PYGZus{}alphas} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{posterior\PYGZus{}variance} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{betas} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{1.} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod\PYGZus{}prev}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{)}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleUNet}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{image\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Time embedding}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}mlp} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{SiLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initial convolution}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}in} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{image\PYGZus{}channels}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Downsampling}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Middle}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{middle1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{middle2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Upsampling}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}out} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}channels}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{image\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        x: (B, C, H, W) input image}
\PYG{l+s+sd}{        t: (B,) diffusion timesteps}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Encode time}
        \PYG{n}{t\PYGZus{}emb} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}mlp}\PYG{p}{(}\PYG{n}{t}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} (B, hidden\PYGZus{}channels)}
        
        \PYG{c+c1}{\PYGZsh{} Initial processing}
        \PYG{n}{h} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}in}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{h1} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Downsample}
        \PYG{n}{h2} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down1}\PYG{p}{(}\PYG{n}{h1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h3} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{down2}\PYG{p}{(}\PYG{n}{h2}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Middle with time conditioning}
        \PYG{n}{h3} \PYG{o}{=} \PYG{n}{h3} \PYG{o}{+} \PYG{n}{t\PYGZus{}emb}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{h3} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{middle1}\PYG{p}{(}\PYG{n}{h3}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h3} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{middle2}\PYG{p}{(}\PYG{n}{h3}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Upsample with skip connections}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up1}\PYG{p}{(}\PYG{n}{h3}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{h}\PYG{p}{,} \PYG{n}{h2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Skip connection}
        
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{silu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{up2}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{h}\PYG{p}{,} \PYG{n}{h1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Skip connection}
        
        \PYG{c+c1}{\PYGZsh{} Output}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}out}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}diffusion\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{dataloader}\PYG{p}{,} \PYG{n}{scheduler}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cpu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Train a diffusion model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{lr}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{total\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{tqdm}\PYG{p}{(}\PYG{n}{dataloader}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
            \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Random timesteps}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,}\PYG{p}{)}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add noise according to timesteps}
            \PYG{n}{noise} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{x\PYGZus{}noisy} \PYG{o}{=} \PYG{p}{(}
                \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{sqrt\PYGZus{}alphas\PYGZus{}cumprod}\PYG{p}{[}\PYG{n}{t}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{]} \PYG{o}{*} \PYG{n}{x} \PYG{o}{+} 
                \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{sqrt\PYGZus{}one\PYGZus{}minus\PYGZus{}alphas\PYGZus{}cumprod}\PYG{p}{[}\PYG{n}{t}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{]} \PYG{o}{*} \PYG{n}{noise}
            \PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Predict noise}
            \PYG{n}{noise\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}noisy}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Loss (predict the noise that was added)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{mse\PYGZus{}loss}\PYG{p}{(}\PYG{n}{noise\PYGZus{}pred}\PYG{p}{,} \PYG{n}{noise}\PYG{p}{)}
            
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{n}{total\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}loss}\PYG{o}{/}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{dataloader}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample\PYGZus{}from\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{scheduler}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cpu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{steps}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Sample a new image from the trained diffusion model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Start from pure noise}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{shape}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device}\PYG{p}{)}
    \PYG{n}{steps} \PYG{o}{=} \PYG{n}{steps} \PYG{o+ow}{or} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps}
    \PYG{n}{step\PYGZus{}size} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps} \PYG{o}{/}\PYG{o}{/} \PYG{n}{steps}
    
    \PYG{c+c1}{\PYGZsh{} Progressively denoise}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{tqdm}\PYG{p}{(}\PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{num\PYGZus{}timesteps}\PYG{p}{,} \PYG{n}{step\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{full}\PYG{p}{(}\PYG{p}{(}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{)}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{long}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get model prediction (noise)}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{predicted\PYGZus{}noise} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get alpha values for timestep}
        \PYG{n}{alpha} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{alphas}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{n}{alpha\PYGZus{}hat} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{n}{beta} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{betas}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} If not the last step, add noise}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{noise} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}
            \PYG{n}{next\PYGZus{}i} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{step\PYGZus{}size}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{n}{alpha\PYGZus{}next} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{alphas\PYGZus{}cumprod}\PYG{p}{[}\PYG{n}{next\PYGZus{}i}\PYG{p}{]}
            \PYG{n}{variance} \PYG{o}{=} \PYG{n}{scheduler}\PYG{o}{.}\PYG{n}{posterior\PYGZus{}variance}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            \PYG{n}{img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{img} \PYG{o}{\PYGZhy{}} \PYG{n}{beta} \PYG{o}{*} \PYG{n}{predicted\PYGZus{}noise} \PYG{o}{/} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}hat}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{alpha}\PYG{p}{)}
            \PYG{n}{img} \PYG{o}{=} \PYG{n}{img} \PYG{o}{+} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{variance}\PYG{p}{)} \PYG{o}{*} \PYG{n}{noise}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Last step \PYGZhy{} clean prediction}
            \PYG{n}{img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{img} \PYG{o}{\PYGZhy{}} \PYG{n}{beta} \PYG{o}{*} \PYG{n}{predicted\PYGZus{}noise} \PYG{o}{/} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{alpha\PYGZus{}hat}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{alpha}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Clamp to valid image range}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{clamp}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{img} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Scale to [0, 1]}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{c+c1}{\PYGZsh{} scheduler = DiffusionScheduler()}
\PYG{c+c1}{\PYGZsh{} model = SimpleUNet().to(device)}
\PYG{c+c1}{\PYGZsh{} train\PYGZus{}diffusion\PYGZus{}model(model, mnist\PYGZus{}dataloader, scheduler, device=device)}
\PYG{c+c1}{\PYGZsh{} sample = sample\PYGZus{}from\PYGZus{}model(model, scheduler, (1, 1, 28, 28), device=device)}
\end{sphinxVerbatim}


\section{13.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part4/ch13_multimodal_models:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal models capture cross\sphinxhyphen{}domain relationships} in ways that mirror the brain’s multisensory integration capabilities. Both artificial and biological systems benefit from combining information across modalities.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Diffusion models provide high\sphinxhyphen{}quality generation} through a principled approach based on gradually adding and removing noise. This approach yields remarkable flexibility in generation tasks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Combining modalities enhances representation quality} by leveraging complementary information across domains, similar to how the brain integrates vision, hearing, and touch to create a unified perception of reality.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cross\sphinxhyphen{}modal binding mechanisms} in both artificial and biological systems enable the creation of coherent representations that span multiple sensory domains.

\end{itemize}


\section{13.8 Further Reading \& Media}
\label{\detokenize{part4/ch13_multimodal_models:further-reading-media}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Radford, A., et al. (2021). \sphinxhref{https://arxiv.org/abs/2103.00020}{Learning Transferable Visual Models From Natural Language Supervision}. This paper introduces CLIP, a groundbreaking approach to multimodal learning.

\item {} 
\sphinxAtStartPar
Ho, J., et al. (2020). \sphinxhref{https://arxiv.org/abs/2006.11239}{Denoising Diffusion Probabilistic Models}. The seminal paper that introduced the modern formulation of diffusion models.

\item {} 
\sphinxAtStartPar
Rombach, R., et al. (2022). \sphinxhref{https://arxiv.org/abs/2112.10752}{High\sphinxhyphen{}Resolution Image Synthesis with Latent Diffusion Models}. Introduces Stable Diffusion and the concept of latent diffusion.

\item {} 
\sphinxAtStartPar
Nichol, A., et al. (2021). \sphinxhref{https://arxiv.org/abs/2112.10741}{GLIDE: Towards Photorealistic Image Generation and Editing with Text\sphinxhyphen{}Guided Diffusion Models}. Early work on text\sphinxhyphen{}guided diffusion models.

\item {} 
\sphinxAtStartPar
Ramesh, A., et al. (2022). \sphinxhref{https://arxiv.org/abs/2204.06125}{Hierarchical Text\sphinxhyphen{}Conditional Image Generation with CLIP Latents}. The DALL\sphinxhyphen{}E 2 paper describing a powerful text\sphinxhyphen{}to\sphinxhyphen{}image system.

\item {} 
\sphinxAtStartPar
Stein, S., et al. (2023). \sphinxhref{https://www.nature.com/articles/s41593-023-01339-y}{Phenomenal Multimodal Integration in Superior Temporal Sulcus}. A neuroscience perspective on multimodal integration.

\end{itemize}

\sphinxstepscope


\part{Part V · Ethics \& Futures}

\sphinxstepscope


\chapter{Chapter 15: Ethical AI \sphinxhyphen{} Considerations for NeuroAI}
\label{\detokenize{part5/ch15_ethical_ai:chapter-15-ethical-ai-considerations-for-neuroai}}\label{\detokenize{part5/ch15_ethical_ai::doc}}
\sphinxAtStartPar
The integration of neuroscience and artificial intelligence raises unique ethical considerations that require careful attention. This chapter explores the ethical dimensions of NeuroAI, providing a framework for responsible development and application.


\section{15.0 Chapter Goals}
\label{\detokenize{part5/ch15_ethical_ai:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand key ethical considerations in neuroscience\sphinxhyphen{}inspired AI systems

\item {} 
\sphinxAtStartPar
Explore frameworks for privacy and data protection in neural applications

\item {} 
\sphinxAtStartPar
Examine bias, fairness, and transparency challenges specific to NeuroAI

\item {} 
\sphinxAtStartPar
Develop approaches for responsible innovation in this emerging field

\item {} 
\sphinxAtStartPar
Implement practical frameworks for ethical assessment and governance

\end{itemize}


\section{Ethical Frameworks for NeuroAI}
\label{\detokenize{part5/ch15_ethical_ai:ethical-frameworks-for-neuroai}}
\sphinxAtStartPar
NeuroAI research and applications exist at the intersection of multiple ethical domains, including:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Neuroscience ethics

\item {} 
\sphinxAtStartPar
AI ethics

\item {} 
\sphinxAtStartPar
Medical ethics

\item {} 
\sphinxAtStartPar
Data privacy

\item {} 
\sphinxAtStartPar
Research integrity

\end{itemize}

\sphinxAtStartPar
These domains contribute important perspectives on how NeuroAI systems should be designed, deployed, and governed.


\section{15.1 Privacy and Brain Data}
\label{\detokenize{part5/ch15_ethical_ai:privacy-and-brain-data}}
\sphinxAtStartPar
Brain data represents some of the most sensitive personal information possible:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Neural activity can reveal thoughts, emotions, and cognitive states

\item {} 
\sphinxAtStartPar
Brain imaging can potentially expose medical conditions

\item {} 
\sphinxAtStartPar
Longitudinal brain data may predict future neurological conditions

\end{itemize}

\sphinxAtStartPar
Principles for ethical brain data handling include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Informed consent}: Ensuring participants fully understand how their brain data will be used

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data minimization}: Collecting only essential data for the specific research purpose

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Purpose limitation}: Using data only for explicitly stated purposes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Secure storage}: Implementing robust protections for brain data repositories

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{De\sphinxhyphen{}identification}: Removing personally identifiable information when possible

\end{enumerate}


\subsection{15.1.1 Neural Privacy Frameworks}
\label{\detokenize{part5/ch15_ethical_ai:neural-privacy-frameworks}}
\sphinxAtStartPar
Implementing robust privacy safeguards is crucial for brain\sphinxhyphen{}computer interfaces (BCIs) and neural data systems. Here’s an example framework for neural data privacy protection:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralPrivacyFramework}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Framework for neural data privacy protection}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identifiable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}     \PYG{c+c1}{\PYGZsh{} Share personally identifiable neural data}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pseudonymized}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Share with personally identifying info removed}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{aggregate\PYGZus{}only}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Share only data aggregated across individuals}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model\PYGZus{}only}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} Share only models trained on data, not data itself}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{no\PYGZus{}sharing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}        \PYG{c+c1}{\PYGZsh{} No sharing of any kind}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{emotion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{thoughts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{personal\PYGZus{}memories}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medical\PYGZus{}treatment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{basic\PYGZus{}research}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{commercial\PYGZus{}development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{advertising}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{law\PYGZus{}enforcement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{check\PYGZus{}access\PYGZus{}permitted}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data\PYGZus{}type}\PYG{p}{,} \PYG{n}{purpose}\PYG{p}{,} \PYG{n}{sharing\PYGZus{}level}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Check if data access is permitted under the framework}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} data\PYGZus{}type: Type of neural data}
\PYG{l+s+sd}{        \PYGZhy{} purpose: Purpose of data use}
\PYG{l+s+sd}{        \PYGZhy{} sharing\PYGZus{}level: Level of data sharing}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} permitted: Whether access is permitted}
\PYG{l+s+sd}{        \PYGZhy{} reason: Reason for decision}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{data\PYGZus{}type} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown data type: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{if} \PYG{n}{purpose} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown purpose: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{purpose}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{if} \PYG{n}{sharing\PYGZus{}level} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown sharing level: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sharing\PYGZus{}level}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if data type can be shared at all}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types}\PYG{p}{[}\PYG{n}{data\PYGZus{}type}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ data cannot be shared due to sensitivity}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if purpose is authorized}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes}\PYG{p}{[}\PYG{n}{purpose}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Purpose }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{purpose}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ is not authorized}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if sharing level is consented to}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels}\PYG{p}{[}\PYG{n}{sharing\PYGZus{}level}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No consent for sharing level: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sharing\PYGZus{}level}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Special cases}
        \PYG{k}{if} \PYG{n}{data\PYGZus{}type} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{thoughts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{personal\PYGZus{}memories}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o+ow}{and} \PYG{n}{sharing\PYGZus{}level} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identifiable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pseudonymized}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Higher\PYGZhy{}level anonymization required for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Access permitted}
        \PYG{k}{return} \PYG{k+kc}{True}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Access permitted under framework}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}


\subsection{15.1.2 Differential Privacy for Neural Data}
\label{\detokenize{part5/ch15_ethical_ai:differential-privacy-for-neural-data}}
\sphinxAtStartPar
When sharing neural data, differential privacy provides mathematical guarantees of privacy protection by adding calibrated noise:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}differential\PYGZus{}privacy}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Apply differential privacy to neural data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}data: Raw neural data}
\PYG{l+s+sd}{    \PYGZhy{} epsilon: Privacy parameter (lower = more privacy)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} private\PYGZus{}data: Privacy\PYGZhy{}protected version of the data}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Differential privacy implementation}
    \PYG{c+c1}{\PYGZsh{} Add calibrated noise to guarantee privacy}
    \PYG{n}{sensitivity} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Maximum change one individual can have on output}
    \PYG{n}{scale} \PYG{o}{=} \PYG{n}{sensitivity} \PYG{o}{/} \PYG{n}{epsilon}
    
    \PYG{c+c1}{\PYGZsh{} Add Laplace noise to each value}
    \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{laplace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{scale}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
    \PYG{n}{private\PYGZus{}data} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data} \PYG{o}{+} \PYG{n}{noise}
    
    \PYG{k}{return} \PYG{n}{private\PYGZus{}data}
\end{sphinxVerbatim}


\section{15.2 Bias and Fairness}
\label{\detokenize{part5/ch15_ethical_ai:bias-and-fairness}}
\sphinxAtStartPar
NeuroAI systems can perpetuate or amplify biases in several ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Training data may underrepresent certain demographic groups

\item {} 
\sphinxAtStartPar
Neural diversity may not be adequately captured in models

\item {} 
\sphinxAtStartPar
Algorithms may perform differently across different populations

\item {} 
\sphinxAtStartPar
Interpretations of results may reflect researchers’ biases

\end{itemize}

\sphinxAtStartPar
Approaches to mitigate bias include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Diverse and representative training datasets

\item {} 
\sphinxAtStartPar
Regular bias audits throughout development

\item {} 
\sphinxAtStartPar
Inclusive research teams

\item {} 
\sphinxAtStartPar
Community engagement with affected populations

\end{itemize}


\subsection{15.2.1 Bias Assessment Framework}
\label{\detokenize{part5/ch15_ethical_ai:bias-assessment-framework}}
\sphinxAtStartPar
Bias assessment should be integrated throughout the development lifecycle:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{assess\PYGZus{}neural\PYGZus{}dataset\PYGZus{}bias}\PYG{p}{(}\PYG{n}{dataset}\PYG{p}{,} \PYG{n}{demographic\PYGZus{}fields}\PYG{p}{,} \PYG{n}{neural\PYGZus{}measures}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Assess potential bias in neural datasets}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} dataset: Dataset containing demographic information and neural measures}
\PYG{l+s+sd}{    \PYGZhy{} demographic\PYGZus{}fields: List of demographic variables to check for bias}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}measures: List of neural measures to analyze for bias}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} bias\PYGZus{}report: Dictionary containing bias assessment results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{bias\PYGZus{}report} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{performance\PYGZus{}disparities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Check for demographic representation bias}
    \PYG{k}{for} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{demographic\PYGZus{}fields}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
            \PYG{n}{distribution} \PYG{o}{=} \PYG{n}{dataset}\PYG{p}{[}\PYG{n}{field}\PYG{p}{]}\PYG{o}{.}\PYG{n}{value\PYGZus{}counts}\PYG{p}{(}\PYG{n}{normalize}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{n}{bias\PYGZus{}report}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{representation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{field}\PYG{p}{]} \PYG{o}{=} \PYG{n}{distribution}\PYG{o}{.}\PYG{n}{to\PYGZus{}dict}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Check for severe underrepresentation (less than 10\PYGZpc{})}
            \PYG{k}{for} \PYG{n}{category}\PYG{p}{,} \PYG{n}{percentage} \PYG{o+ow}{in} \PYG{n}{distribution}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{percentage} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.1}\PYG{p}{:}
                    \PYG{n}{bias\PYGZus{}report}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                        \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Underrepresentation of }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{category}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ in }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{field}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (only }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{percentage}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1\PYGZpc{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}
                    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Check for performance disparities across groups}
    \PYG{k}{for} \PYG{n}{measure} \PYG{o+ow}{in} \PYG{n}{neural\PYGZus{}measures}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{measure} \PYG{o+ow}{in} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
            \PYG{n}{disparities} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
            \PYG{k}{for} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{demographic\PYGZus{}fields}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
                    \PYG{n}{group\PYGZus{}means} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{groupby}\PYG{p}{(}\PYG{n}{field}\PYG{p}{)}\PYG{p}{[}\PYG{n}{measure}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{group\PYGZus{}stds} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{groupby}\PYG{p}{(}\PYG{n}{field}\PYG{p}{)}\PYG{p}{[}\PYG{n}{measure}\PYG{p}{]}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{p}{)}
                    
                    \PYG{c+c1}{\PYGZsh{} Calculate max disparity ratio}
                    \PYG{n}{max\PYGZus{}val} \PYG{o}{=} \PYG{n}{group\PYGZus{}means}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{min\PYGZus{}val} \PYG{o}{=} \PYG{n}{group\PYGZus{}means}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} 
                    \PYG{k}{if} \PYG{n}{min\PYGZus{}val} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
                        \PYG{n}{disparity\PYGZus{}ratio} \PYG{o}{=} \PYG{n}{max\PYGZus{}val} \PYG{o}{/} \PYG{n}{min\PYGZus{}val}
                    \PYG{k}{else}\PYG{p}{:}
                        \PYG{n}{disparity\PYGZus{}ratio} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inf}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    
                    \PYG{n}{disparities}\PYG{p}{[}\PYG{n}{field}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{means}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{group\PYGZus{}means}\PYG{o}{.}\PYG{n}{to\PYGZus{}dict}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
                        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stds}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{group\PYGZus{}stds}\PYG{o}{.}\PYG{n}{to\PYGZus{}dict}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
                        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disparity\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{disparity\PYGZus{}ratio}
                    \PYG{p}{\PYGZcb{}}
                    
                    \PYG{c+c1}{\PYGZsh{} Flag high disparities}
                    \PYG{k}{if} \PYG{n}{disparity\PYGZus{}ratio} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{1.5}\PYG{p}{:}
                        \PYG{n}{bias\PYGZus{}report}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                            \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High disparity in }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{measure}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ across }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{field}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ groups }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
                            \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{(ratio: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{disparity\PYGZus{}ratio}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}
                        \PYG{p}{)}
            
            \PYG{n}{bias\PYGZus{}report}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{performance\PYGZus{}disparities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{measure}\PYG{p}{]} \PYG{o}{=} \PYG{n}{disparities}
    
    \PYG{k}{return} \PYG{n}{bias\PYGZus{}report}
\end{sphinxVerbatim}


\section{15.3 Transparency and Explainability}
\label{\detokenize{part5/ch15_ethical_ai:transparency-and-explainability}}
\sphinxAtStartPar
The complexity of both neural and AI systems creates significant challenges for transparency:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Deep learning models often function as “black boxes”

\item {} 
\sphinxAtStartPar
Brain\sphinxhyphen{}inspired architectures add additional layers of complexity

\item {} 
\sphinxAtStartPar
Correlations between brain activity and model behavior may be difficult to interpret

\end{itemize}

\sphinxAtStartPar
Best practices include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Documentation of model architecture and training procedures

\item {} 
\sphinxAtStartPar
Explainable AI techniques that clarify decision processes

\item {} 
\sphinxAtStartPar
Clear communication of model limitations

\item {} 
\sphinxAtStartPar
Open science practices when possible

\end{itemize}


\subsection{15.3.1 Explainability Methods for NeuroAI}
\label{\detokenize{part5/ch15_ethical_ai:explainability-methods-for-neuroai}}
\sphinxAtStartPar
Specialized techniques can help interpret complex NeuroAI systems:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuroAIExplainer}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Explainability toolkit for NeuroAI models}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} model: Trained model to explain}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n}{model}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}saliency\PYGZus{}map}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{target\PYGZus{}class}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate a saliency map using gradient\PYGZhy{}based attribution}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}data: Input to explain (e.g., neural recording, image)}
\PYG{l+s+sd}{        \PYGZhy{} target\PYGZus{}class: Target class to explain (defaults to predicted class)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} saliency\PYGZus{}map: Attribution scores for each input feature}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would be implemented with actual gradient computation}
        \PYG{c+c1}{\PYGZsh{} For illustration, we\PYGZsq{}ll create a simple placeholder}
        
        \PYG{c+c1}{\PYGZsh{} Simulate gradient calculation (in practice, use autograd)}
        \PYG{n}{saliency\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{o}{*}\PYG{n}{input\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{n}{input\PYGZus{}data}
        
        \PYG{c+c1}{\PYGZsh{} Normalize for visualization}
        \PYG{n}{saliency\PYGZus{}map} \PYG{o}{=} \PYG{p}{(}\PYG{n}{saliency\PYGZus{}map} \PYG{o}{\PYGZhy{}} \PYG{n}{saliency\PYGZus{}map}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{saliency\PYGZus{}map}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{saliency\PYGZus{}map}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{saliency\PYGZus{}map}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}feature\PYGZus{}importance}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{feature\PYGZus{}names}\PYG{p}{,} \PYG{n}{attribution\PYGZus{}scores}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Plot feature importance based on attribution scores}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} feature\PYGZus{}names: Names of input features}
\PYG{l+s+sd}{        \PYGZhy{} attribution\PYGZus{}scores: Attribution scores for each feature}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Sort features by attribution score}
        \PYG{n}{sorted\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{attribution\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{sorted\PYGZus{}features} \PYG{o}{=} \PYG{p}{[}\PYG{n}{feature\PYGZus{}names}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{sorted\PYGZus{}indices}\PYG{p}{]}
        \PYG{n}{sorted\PYGZus{}scores} \PYG{o}{=} \PYG{n}{attribution\PYGZus{}scores}\PYG{p}{[}\PYG{n}{sorted\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Plot}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{barh}\PYG{p}{(}\PYG{n}{sorted\PYGZus{}features}\PYG{p}{,} \PYG{n}{sorted\PYGZus{}scores}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attribution Score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature Importance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}counterfactual}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{target\PYGZus{}outcome}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate a counterfactual example \PYGZhy{} closest possible input that}
\PYG{l+s+sd}{        would lead to the target outcome}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}data: Original input}
\PYG{l+s+sd}{        \PYGZhy{} target\PYGZus{}outcome: Desired output}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} counterfactual: Modified input that produces target outcome}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In practice, this would optimize the input to change the model prediction}
        \PYG{c+c1}{\PYGZsh{} For illustration, we create a synthetic example}
        
        \PYG{c+c1}{\PYGZsh{} Simple perturbation (in practice, use optimization)}
        \PYG{n}{counterfactual} \PYG{o}{=} \PYG{n}{input\PYGZus{}data}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{perturbation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{o}{*}\PYG{n}{input\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        \PYG{n}{counterfactual} \PYG{o}{+}\PYG{o}{=} \PYG{n}{perturbation}
        
        \PYG{k}{return} \PYG{n}{counterfactual}
\end{sphinxVerbatim}


\section{15.4 Dual\sphinxhyphen{}Use Concerns}
\label{\detokenize{part5/ch15_ethical_ai:dual-use-concerns}}
\sphinxAtStartPar
NeuroAI technologies have potential for both beneficial and harmful applications:


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Beneficial Applications
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Potential Misuse
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
Brain disorder diagnosis
&
\sphinxAtStartPar
Manipulation of cognition
\\
\sphinxhline
\sphinxAtStartPar
Cognitive enhancement for disability
&
\sphinxAtStartPar
Unauthorized surveillance
\\
\sphinxhline
\sphinxAtStartPar
Personalized learning tools
&
\sphinxAtStartPar
Deception detection without consent
\\
\sphinxhline
\sphinxAtStartPar
Neural rehabilitation
&
\sphinxAtStartPar
Military applications
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxAtStartPar
Researchers and developers should:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Conduct risk assessments during design phases

\item {} 
\sphinxAtStartPar
Develop safeguards against misuse

\item {} 
\sphinxAtStartPar
Engage with policymakers on appropriate regulations

\item {} 
\sphinxAtStartPar
Consider implementing technical limitations when warranted

\end{itemize}


\subsection{15.4.1 Dual\sphinxhyphen{}Use Risk Assessment}
\label{\detokenize{part5/ch15_ethical_ai:dual-use-risk-assessment}}
\sphinxAtStartPar
A formal risk assessment framework can help identify and mitigate potential harms:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{assess\PYGZus{}dual\PYGZus{}use\PYGZus{}risk}\PYG{p}{(}\PYG{n}{technology\PYGZus{}description}\PYG{p}{,} \PYG{n}{capabilities}\PYG{p}{,} \PYG{n}{stakeholders}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Assess dual\PYGZhy{}use risks of NeuroAI technologies}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} technology\PYGZus{}description: Description of the technology}
\PYG{l+s+sd}{    \PYGZhy{} capabilities: List of technology capabilities}
\PYG{l+s+sd}{    \PYGZhy{} stakeholders: List of affected stakeholder groups}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} risk\PYGZus{}assessment: Structured risk assessment}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{risk\PYGZus{}assessment} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{technology\PYGZus{}description}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identified\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}ratings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation\PYGZus{}strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Common dual\PYGZhy{}use risk categories for NeuroAI}
    \PYG{n}{risk\PYGZus{}categories} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{privacy\PYGZus{}violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of exposing private neural or cognitive data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{collects neural data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stores patterns of thought}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identifies individuals}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{manipulation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of manipulating thoughts, emotions, or behavior}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{influences decision\PYGZhy{}making}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{alters emotional state}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{modifies preferences}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{surveillance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of unauthorized monitoring of cognitive states}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{continuous monitoring}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{detects deception}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tracks attention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{discrimination}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of unfair treatment based on neural characteristics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{classifies neural patterns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{makes access decisions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{predicts capabilities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weaponization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of use in military or law enforcement applications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{enhances targeting}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{incapacitates subjects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{extracts information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Identify applicable risks based on technology capabilities}
    \PYG{k}{for} \PYG{n}{cap} \PYG{o+ow}{in} \PYG{n}{capabilities}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{risk\PYGZus{}type}\PYG{p}{,} \PYG{n}{risk\PYGZus{}info} \PYG{o+ow}{in} \PYG{n}{risk\PYGZus{}categories}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Check if capability matches risk indicators}
            \PYG{k}{if} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{indicator} \PYG{o+ow}{in} \PYG{n}{cap}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{indicator} \PYG{o+ow}{in} \PYG{n}{risk\PYGZus{}info}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{risk} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{risk\PYGZus{}type}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{risk\PYGZus{}info}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{related\PYGZus{}capability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cap}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
                \PYG{p}{\PYGZcb{}}
                
                \PYG{c+c1}{\PYGZsh{} Identify affected stakeholders}
                \PYG{k}{for} \PYG{n}{stakeholder} \PYG{o+ow}{in} \PYG{n}{stakeholders}\PYG{p}{:}
                    \PYG{k}{if} \PYG{n}{risk\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{privacy\PYGZus{}violation}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{or} \PYG{n}{risk\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{surveillance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
                        \PYG{c+c1}{\PYGZsh{} All stakeholders are affected by privacy/surveillance risks}
                        \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{stakeholder}\PYG{p}{)}
                    \PYG{k}{elif} \PYG{n}{risk\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{discrimination}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vulnerable}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{stakeholder}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                        \PYG{c+c1}{\PYGZsh{} Discrimination especially affects vulnerable stakeholders}
                        \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{stakeholder}\PYG{p}{)}
                    \PYG{k}{elif} \PYG{n}{risk\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{manipulation}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{user}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{stakeholder}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                        \PYG{c+c1}{\PYGZsh{} Manipulation especially affects direct users}
                        \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{stakeholder}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Only add risk if it affects stakeholders}
                \PYG{k}{if} \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
                    \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identified\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{risk}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Rate each identified risk (severity × likelihood)}
    \PYG{k}{for} \PYG{n}{risk} \PYG{o+ow}{in} \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identified\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} This is a simplified heuristic \PYGZhy{} in practice, this would use expert judgment}
        \PYG{n}{severity} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{affected\PYGZus{}stakeholders}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{stakeholders}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Heuristic for likelihood based on specificity of capability match}
        \PYG{n}{likelihood\PYGZus{}indicators} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{k}{for} \PYG{n}{indicator} \PYG{o+ow}{in} \PYG{n}{risk\PYGZus{}categories}\PYG{p}{[}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} 
                                 \PYG{k}{if} \PYG{n}{indicator} \PYG{o+ow}{in} \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{related\PYGZus{}capability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{likelihood} \PYG{o}{=} \PYG{n}{likelihood\PYGZus{}indicators} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{risk\PYGZus{}categories}\PYG{p}{[}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indicators}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate risk score (0\PYGZhy{}1 scale)}
        \PYG{n}{risk\PYGZus{}score} \PYG{o}{=} \PYG{n}{severity} \PYG{o}{*} \PYG{n}{likelihood}
        
        \PYG{c+c1}{\PYGZsh{} Add rating to assessment}
        \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}ratings}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{severity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{severity}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{likelihood}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{likelihood}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{risk\PYGZus{}score}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Generate mitigation strategies based on risk type and score}
        \PYG{k}{if} \PYG{n}{risk\PYGZus{}score} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.6}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} High risk}
            \PYG{k}{if} \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{privacy\PYGZus{}violation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
                \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation\PYGZus{}strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                    \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Implement differential privacy with epsilon \PYGZlt{} 0.1 for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{related\PYGZus{}capability}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{manipulation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
                \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation\PYGZus{}strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                    \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Add human oversight and approval for all }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{related\PYGZus{}capability}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ operations}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{discrimination}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
                \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mitigation\PYGZus{}strategies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                    \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Conduct regular bias audits on }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{related\PYGZus{}capability}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ and retrain if necessary}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add to recommendations for high\PYGZhy{}risk items}
            \PYG{n}{risk\PYGZus{}assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{HIGH RISK: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk\PYGZus{}score}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{) \PYGZhy{} }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{risk}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{description}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{risk\PYGZus{}assessment}
\end{sphinxVerbatim}


\section{15.5 Responsible Innovation}
\label{\detokenize{part5/ch15_ethical_ai:responsible-innovation}}
\sphinxAtStartPar
The path forward requires integrating ethical considerations throughout the research and development process:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Ethics by design}: Building ethical considerations into systems from the beginning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Inclusive development}: Ensuring diverse stakeholder participation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Ongoing assessment}: Regular evaluation of ethical implications as systems evolve

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Governance frameworks}: Developing appropriate oversight mechanisms

\end{enumerate}


\subsection{15.5.1 Responsible Innovation Guidelines}
\label{\detokenize{part5/ch15_ethical_ai:responsible-innovation-guidelines}}
\sphinxAtStartPar
Responsible innovation frameworks provide a structured approach to ethical technology development:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ResponsibleInnovationGuidelines}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Guidelines for responsible innovation in neuro\PYGZhy{}AI}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{transparency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear documentation of capabilities and limitations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Publication of technical specifications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Accessible explanation of function}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Disclosure of training data sources}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear indication of AI\PYGZhy{}generated content}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accountability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear lines of responsibility for system outcomes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Defined responsibility for errors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Auditing mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recourse for affected individuals}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Regular impact assessments}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inclusivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Development with diverse stakeholder input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Engagement with potentially affected communities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Diverse development team}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Consideration of varied cultural perspectives}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Testing across diverse populations}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{non\PYGZus{}maleficence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Prevention of harm from system operation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Safety testing protocols}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk assessment framework}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ongoing monitoring}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kill switch mechanisms}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Respect for human decision\PYGZhy{}making authority}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Informed consent processes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Opt\PYGZhy{}out mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Control over personal data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Avoidance of manipulative design}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}technology}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{tech\PYGZus{}description}\PYG{p}{,} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Evaluate a technology against responsible innovation principles}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} tech\PYGZus{}description: Description of the technology}
\PYG{l+s+sd}{        \PYGZhy{} principles\PYGZus{}assessment: Dictionary with ratings for each principle}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} evaluation: Detailed evaluation against principles}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{evaluation} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{tech\PYGZus{}description}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{total\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{principle}\PYG{p}{,} \PYG{n}{details} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{principle} \PYG{o+ow}{in} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{:}
                \PYG{n}{score} \PYG{o}{=} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]}
                \PYG{n}{total\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{score}
                
                \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{score}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strengths}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{principles\PYGZus{}assessment}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}strengths}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weaknesses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{principles\PYGZus{}assessment}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}weaknesses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
                \PYG{p}{\PYGZcb{}}
                
                \PYG{c+c1}{\PYGZsh{} Generate recommendations for low scores}
                \PYG{k}{if} \PYG{n}{score} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.7}\PYG{p}{:}
                    \PYG{k}{for} \PYG{n}{req} \PYG{o+ow}{in} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
                        \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                            \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improve }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ by addressing: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{req}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
                        \PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{note}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Not assessed}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Calculate overall adherence}
        \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{total\PYGZus{}score} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Overall assessment}
        \PYG{k}{if} \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mf}{0.8}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High adherence to responsible innovation principles}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{elif} \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mf}{0.6}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Moderate adherence with specific areas needing improvement}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Low adherence \PYGZhy{} significant revisions recommended}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{return} \PYG{n}{evaluation}
\end{sphinxVerbatim}


\subsection{15.5.2 Ethical Impact Assessment}
\label{\detokenize{part5/ch15_ethical_ai:ethical-impact-assessment}}
\sphinxAtStartPar
Structured impact assessments help anticipate and address potential ethical issues:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{ethical\PYGZus{}impact\PYGZus{}assessment}\PYG{p}{(}\PYG{n}{technology\PYGZus{}description}\PYG{p}{,} \PYG{n}{stakeholders}\PYG{p}{,} \PYG{n}{societal\PYGZus{}domains}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Conduct an ethical impact assessment for a neuro\PYGZhy{}AI technology}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} technology\PYGZus{}description: Description of the technology}
\PYG{l+s+sd}{    \PYGZhy{} stakeholders: List of stakeholder groups}
\PYG{l+s+sd}{    \PYGZhy{} societal\PYGZus{}domains: Domains to assess impact on}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} assessment: Impact assessment results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{assessment} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{technology\PYGZus{}description}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stakeholder\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{domain\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{benefit\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{uncertainty\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Assess impact on each stakeholder group}
    \PYG{k}{for} \PYG{n}{stakeholder} \PYG{o+ow}{in} \PYG{n}{stakeholders}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} This would involve stakeholder consultation in practice}
        \PYG{n}{impact} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{direct\PYGZus{}benefits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{direct\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indirect\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power\PYGZus{}dynamics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stakeholder\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{stakeholder}\PYG{p}{]} \PYG{o}{=} \PYG{n}{impact}
    
    \PYG{c+c1}{\PYGZsh{} Assess impact on each societal domain}
    \PYG{k}{for} \PYG{n}{domain} \PYG{o+ow}{in} \PYG{n}{societal\PYGZus{}domains}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} This would involve domain expert input in practice}
        \PYG{n}{impact} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{short\PYGZus{}term\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{long\PYGZus{}term\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{structural\PYGZus{}changes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{domain\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{domain}\PYG{p}{]} \PYG{o}{=} \PYG{n}{impact}
    
    \PYG{c+c1}{\PYGZsh{} Key factors would be identified through stakeholder engagement}
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Privacy implications of neural data collection}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for creating new social inequalities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of misuse for manipulation or control}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{benefit\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for new treatments for neurological conditions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improved human\PYGZhy{}computer interaction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enhanced understanding of neural processes}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{uncertainty\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term effects on neural plasticity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for emergent behaviors in advanced systems}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Future regulatory frameworks}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Generate recommendations based on assessment}
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Implement stringent data privacy protections}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Establish inclusive governance mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ensure accessible distribution of benefits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Develop monitoring frameworks for long\PYGZhy{}term effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Create clear boundaries for acceptable use cases}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{assessment}
\end{sphinxVerbatim}


\section{15.6 Case Studies in NeuroAI Ethics}
\label{\detokenize{part5/ch15_ethical_ai:case-studies-in-neuroai-ethics}}

\subsection{15.6.1 Brain\sphinxhyphen{}Computer Interfaces}
\label{\detokenize{part5/ch15_ethical_ai:brain-computer-interfaces}}
\sphinxAtStartPar
Brain\sphinxhyphen{}computer interfaces (BCIs) exemplify many ethical challenges in NeuroAI:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Agency and autonomy when machines interpret neural signals

\item {} 
\sphinxAtStartPar
Long\sphinxhyphen{}term safety of invasive interfaces

\item {} 
\sphinxAtStartPar
Equitable access to potentially life\sphinxhyphen{}changing technology

\item {} 
\sphinxAtStartPar
Privacy of neural data streams

\item {} 
\sphinxAtStartPar
Potential for unauthorized access or “brain hacking”

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{assess\PYGZus{}bci\PYGZus{}ethical\PYGZus{}considerations}\PYG{p}{(}\PYG{n}{bci\PYGZus{}type}\PYG{p}{,} \PYG{n}{target\PYGZus{}population}\PYG{p}{,} \PYG{n}{intended\PYGZus{}use}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Assess ethical considerations specific to brain\PYGZhy{}computer interfaces}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} bci\PYGZus{}type: Type of BCI (e.g., \PYGZdq{}invasive\PYGZdq{}, \PYGZdq{}non\PYGZhy{}invasive\PYGZdq{}, \PYGZdq{}bidirectional\PYGZdq{})}
\PYG{l+s+sd}{    \PYGZhy{} target\PYGZus{}population: Population the BCI is designed for}
\PYG{l+s+sd}{    \PYGZhy{} intended\PYGZus{}use: Purpose of the BCI}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} assessment: BCI\PYGZhy{}specific ethical assessment}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{assessment} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{primary\PYGZus{}concerns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{additional\PYGZus{}safeguards}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}considerations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{justice\PYGZus{}implications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Invasive BCIs have additional safety and reversibility concerns}
    \PYG{k}{if} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{invasive}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{bci\PYGZus{}type}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{primary\PYGZus{}concerns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term tissue response to implanted electrodes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of infection or rejection}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Difficulty of removal or replacement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Permanence of neural changes}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
        
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{additional\PYGZus{}safeguards}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Regular monitoring of neural tissue health}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear protocol for device removal if needed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term clinical follow\PYGZhy{}up}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Bidirectional BCIs (read and write) raise additional agency concerns}
    \PYG{k}{if} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bidirectional}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{bci\PYGZus{}type}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} \PYG{o+ow}{or} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stimulation}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{bci\PYGZus{}type}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{primary\PYGZus{}concerns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for manipulation of thoughts or behavior}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unclear boundaries between assisted and imposed actions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Difficulty distinguishing internally vs. externally generated thoughts}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
        
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{additional\PYGZus{}safeguards}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Real\PYGZhy{}time feedback about stimulation activity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{User\PYGZhy{}controlled lockout mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stimulation intensity limits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Independent ethical oversight}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Autonomy considerations depend on intended use}
    \PYG{k}{if} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{assistive}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{intended\PYGZus{}use}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} \PYG{o+ow}{or} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medical}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{intended\PYGZus{}use}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}considerations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}enhancement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May restore lost capabilities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Could enable new forms of expression}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May reduce dependence on caregivers}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for technical dependencies}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of device abandonment if not well\PYGZhy{}designed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unclear liability for device\PYGZhy{}assisted actions}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    \PYG{k}{elif} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{enhancement}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{intended\PYGZus{}use}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}considerations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}enhancement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May extend human capabilities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Could enable new forms of expression}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{May create societal pressure to enhance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of creating two\PYGZhy{}tiered society}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for exacerbating existing inequalities}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Justice implications focusing on access and fairness}
    \PYG{n}{vulnerable\PYGZus{}population} \PYG{o}{=} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{group} \PYG{o+ow}{in} \PYG{n}{target\PYGZus{}population}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} 
                               \PYG{k}{for} \PYG{n}{group} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disorder}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{impairment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{patient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{vulnerable\PYGZus{}population}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{justice\PYGZus{}implications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ensure device development prioritizes needs of target population}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Address affordability and insurance coverage}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Avoid exploitation of vulnerable groups in testing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Include target population in design process}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{justice\PYGZus{}implications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Consider social stratification risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Address workplace coercion concerns}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Develop frameworks for fair access}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{assessment}
\end{sphinxVerbatim}


\subsection{15.6.2 Predictive Models for Neurological Conditions}
\label{\detokenize{part5/ch15_ethical_ai:predictive-models-for-neurological-conditions}}
\sphinxAtStartPar
AI systems that predict neurological conditions raise important questions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
How to handle incidental findings

\item {} 
\sphinxAtStartPar
Right to know vs. right not to know about future conditions

\item {} 
\sphinxAtStartPar
Insurance discrimination concerns

\item {} 
\sphinxAtStartPar
Appropriate clinical pathways for AI\sphinxhyphen{}flagged risks

\item {} 
\sphinxAtStartPar
Statistical vs. clinical significance of predictions

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{develop\PYGZus{}neurological\PYGZus{}prediction\PYGZus{}guidelines}\PYG{p}{(}\PYG{n}{condition}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}horizon}\PYG{p}{,} \PYG{n}{accuracy\PYGZus{}metrics}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Develop ethical guidelines for neurological prediction models}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} condition: Neurological condition being predicted}
\PYG{l+s+sd}{    \PYGZhy{} prediction\PYGZus{}horizon: Timeframe of prediction (e.g., \PYGZdq{}1 year\PYGZdq{}, \PYGZdq{}5 years\PYGZdq{}, \PYGZdq{}lifetime\PYGZdq{})}
\PYG{l+s+sd}{    \PYGZhy{} accuracy\PYGZus{}metrics: Dictionary with model accuracy metrics (sensitivity, specificity, etc.)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} guidelines: Guidelines for ethical use of the predictive model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{guidelines} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disclosure\PYGZus{}protocol}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{required\PYGZus{}accuracy\PYGZus{}thresholds}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}protection\PYGZus{}requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clinical\PYGZus{}pathway\PYGZus{}recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Disclosure thresholds depend on prediction horizon and condition severity}
    \PYG{n}{long\PYGZus{}term} \PYG{o}{=} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{prediction\PYGZus{}horizon}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lifetime}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{decade}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{years}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{5\PYGZhy{}year}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{severe\PYGZus{}condition} \PYG{o}{=} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{condition}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dementia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{parkinson}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{huntington}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                                                                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{alzheimer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{fatal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{untreatable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{long\PYGZus{}term} \PYG{o+ow}{and} \PYG{n}{severe\PYGZus{}condition}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disclosure\PYGZus{}protocol}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Opt\PYGZhy{}in disclosure with genetic counseling model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pre\PYGZhy{}test counseling about implications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Explicit consent for receiving results}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Post\PYGZhy{}disclosure support resources}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Option to receive partial results}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{justification}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term predictions of severe conditions have significant }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
                           \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{psychological impact and limited actionability}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{disclosure\PYGZus{}protocol}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{approach}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Default disclosure with opt\PYGZhy{}out option}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear explanation of prediction meaning}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Context for understanding risk levels}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Available interventions information}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Option to decline receiving results}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{justification}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Near\PYGZhy{}term or non\PYGZhy{}severe predictions may be more actionable }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+}
                           \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{with fewer psychological risks}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Required accuracy thresholds based on consequence severity}
    \PYG{k}{if} \PYG{n}{severe\PYGZus{}condition}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{required\PYGZus{}accuracy\PYGZus{}thresholds}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.90}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} High sensitivity to avoid missing cases}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{specificity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.95}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Very high specificity to avoid false alarms}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ppv\PYGZus{}minimum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.80}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Positive predictive value minimum}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{validation\PYGZus{}requirement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{External validation in three independent cohorts}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{required\PYGZus{}accuracy\PYGZus{}thresholds}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.80}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{specificity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.85}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ppv\PYGZus{}minimum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.70}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{validation\PYGZus{}requirement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{External validation in at least one independent cohort}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Data protection requirements}
    \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}protection\PYGZus{}requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Genetic non\PYGZhy{}discrimination protections}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Prohibition on sharing with insurers/employers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Secure storage with access controls}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Privacy\PYGZhy{}preserving computation when possible}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time\PYGZhy{}limited data retention}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Clinical pathway recommendations}
    \PYG{k}{if} \PYG{n}{long\PYGZus{}term}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clinical\PYGZus{}pathway\PYGZus{}recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Regular monitoring rather than immediate intervention}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Lifestyle modification guidance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Research participation opportunities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Psychological support resources}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Family planning resources when relevant}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{guidelines}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clinical\PYGZus{}pathway\PYGZus{}recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear next steps for clinical confirmation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Standardized intervention protocols}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Defined specialist referral pathway}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Follow\PYGZhy{}up schedule with decreasing frequency if stable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear negative result communication protocol}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{guidelines}
\end{sphinxVerbatim}


\section{15.7 Brain\sphinxhyphen{}Like AI Consciousness Considerations}
\label{\detokenize{part5/ch15_ethical_ai:brain-like-ai-consciousness-considerations}}
\sphinxAtStartPar
As AI systems become more brain\sphinxhyphen{}like, new ethical questions about machine consciousness may arise:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}ai\PYGZus{}consciousness\PYGZus{}criteria}\PYG{p}{(}\PYG{n}{system\PYGZus{}properties}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Analyze an AI system against criteria for consciousness}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} system\PYGZus{}properties: Dictionary of properties and their values}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} evaluation: Assessment against consciousness criteria}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Proposed criteria for consciousness (philosophical framework)}
    \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{integration}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information integration across subsystems}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{φ (phi) from Integrated Information Theory}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.2}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reportability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ability to report on internal states}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Accuracy of self\PYGZhy{}monitoring}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.7}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.15}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{self\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Representation of self as distinct from environment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Internal model calibration score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.6}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.2}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{intentionality}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{States are about something (have content)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic coherence of internal states}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.15}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{adaptation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Flexible response to novel situations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Performance on out\PYGZhy{}of\PYGZhy{}distribution tasks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.4}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{temporality}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temporal integration of experience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Memory coherence score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{qualia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Subjective experience (hardest to measure)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Behavioral indicators of experience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate system against criteria}
    \PYG{n}{evaluation} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{total\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{n}{max\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{for} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{details} \PYG{o+ow}{in} \PYG{n}{criteria}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{criterion} \PYG{o+ow}{in} \PYG{n}{system\PYGZus{}properties}\PYG{p}{:}
            \PYG{n}{value} \PYG{o}{=} \PYG{n}{system\PYGZus{}properties}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Calculate score (0\PYGZhy{}1)}
            \PYG{n}{meets\PYGZus{}threshold} \PYG{o}{=} \PYG{n}{value} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{n}{score} \PYG{o}{=} \PYG{n}{value} \PYG{o}{*} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{value}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meets\PYGZus{}threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{meets\PYGZus{}threshold}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weighted\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{score}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}
            \PYG{p}{\PYGZcb{}}
            
            \PYG{n}{total\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{score}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{None}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meets\PYGZus{}threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weighted\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{max\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Overall assessment}
    \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{total\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{total\PYGZus{}score}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{max\PYGZus{}possible}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{max\PYGZus{}score}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{percentage}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{total\PYGZus{}score} \PYG{o}{/} \PYG{n}{max\PYGZus{}score} \PYG{o}{*} \PYG{l+m+mi}{100}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{This framework does not claim to definitively determine consciousness, }\PYG{l+s+s2}{\PYGZdq{}}
                  \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{but provides a structured approach to evaluating systems against proposed criteria.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{evaluation}
\end{sphinxVerbatim}


\section{15.8 Conclusion}
\label{\detokenize{part5/ch15_ethical_ai:conclusion}}
\sphinxAtStartPar
Ethical considerations in NeuroAI are not obstacles to innovation but essential components of responsible development. By integrating ethics throughout the research and development process, the field can advance in ways that respect human rights, promote wellbeing, and distribute benefits equitably.

\sphinxAtStartPar
As NeuroAI technologies continue to evolve, ongoing ethical dialogue among researchers, clinicians, policymakers, and the public will be crucial to ensuring these powerful tools serve humanity’s best interests.


\subsection{15.8.1 Key Ethical Principles for NeuroAI}
\label{\detokenize{part5/ch15_ethical_ai:key-ethical-principles-for-neuroai}}
\sphinxAtStartPar
To summarize the ethical principles for NeuroAI development:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural privacy} \sphinxhyphen{} Protect the most personal data possible

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Autonomy} \sphinxhyphen{} Preserve human agency and decision\sphinxhyphen{}making

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Transparency} \sphinxhyphen{} Make systems interpretable and explainable

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Justice} \sphinxhyphen{} Ensure fair access and prevent discrimination

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Non\sphinxhyphen{}maleficence} \sphinxhyphen{} Prevent harm and misuse

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Beneficence} \sphinxhyphen{} Prioritize applications with clear benefits

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Inclusivity} \sphinxhyphen{} Include diverse stakeholders throughout development

\end{enumerate}

\sphinxAtStartPar
Implementing these principles requires technical approaches (like differential privacy and explainable models) as well as governance frameworks and inclusive development processes. Only by addressing ethical considerations throughout the entire development lifecycle can we ensure that NeuroAI benefits humanity while respecting fundamental rights and values.

\sphinxstepscope


\chapter{Chapter 16: Where Next for Neuro\sphinxhyphen{}AI?}
\label{\detokenize{part5/ch16_future_directions:chapter-16-where-next-for-neuro-ai}}\label{\detokenize{part5/ch16_future_directions::doc}}

\section{16.0 Chapter Goals}
\label{\detokenize{part5/ch16_future_directions:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Explore frontier research directions at the intersection of neuroscience and AI

\item {} 
\sphinxAtStartPar
Understand neuromorphic computing approaches and their advantages

\item {} 
\sphinxAtStartPar
Consider ethical implications of brain\sphinxhyphen{}inspired AI systems

\item {} 
\sphinxAtStartPar
Envision future developments in the field of neuro\sphinxhyphen{}AI

\end{itemize}


\section{16.1 Neuromorphic Hardware}
\label{\detokenize{part5/ch16_future_directions:neuromorphic-hardware}}
\sphinxAtStartPar
Neuromorphic computing seeks to implement neural processing principles directly in hardware, offering potentially revolutionary advantages in energy efficiency and computational capability.

\sphinxAtStartPar
\sphinxincludegraphics{{neuromorphic_computing}.svg}


\subsection{16.1.1 Spiking Neural Networks}
\label{\detokenize{part5/ch16_future_directions:spiking-neural-networks}}
\sphinxAtStartPar
Traditional artificial neural networks use continuous activation values, but biological neurons communicate through discrete all\sphinxhyphen{}or\sphinxhyphen{}nothing action potentials (spikes). Spiking Neural Networks (SNNs) mimic this biological principle:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SpikingNeuron}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{tau\PYGZus{}m}\PYG{o}{=}\PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{n}{tau\PYGZus{}ref}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple Leaky Integrate\PYGZhy{}and\PYGZhy{}Fire neuron model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} threshold: Membrane potential threshold for spike generation}
\PYG{l+s+sd}{        \PYGZhy{} tau\PYGZus{}m: Membrane time constant (ms)}
\PYG{l+s+sd}{        \PYGZhy{} tau\PYGZus{}ref: Refractory period (ms)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold} \PYG{o}{=} \PYG{n}{threshold}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}ref} \PYG{o}{=} \PYG{n}{tau\PYGZus{}ref}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{l+m+mf}{0.0}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{inf}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Current time}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}current}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update neuron state and check for spike}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}current: Input current to the neuron}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} 1 if neuron spikes, 0 otherwise}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check if in refractory period}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}ref}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potential (leaky integration)}
        \PYG{n}{d\PYGZus{}v} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{+} \PYG{n}{input\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{+}\PYG{o}{=} \PYG{n}{d\PYGZus{}v} \PYG{o}{*} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check for spike}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{l+m+mf}{0.0}  \PYG{c+c1}{\PYGZsh{} Reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t}
            \PYG{k}{return} \PYG{l+m+mi}{1}
        
        \PYG{k}{return} \PYG{l+m+mi}{0}
\end{sphinxVerbatim}

\sphinxAtStartPar
Unlike rate\sphinxhyphen{}based ANNs, SNNs encode information in the precise timing of spikes and can be more energy\sphinxhyphen{}efficient by only computing when spikes occur.


\subsection{16.1.2 Resistive Computing and Memristors}
\label{\detokenize{part5/ch16_future_directions:resistive-computing-and-memristors}}
\sphinxAtStartPar
A key limitation in conventional computing is the energy cost of moving data between memory and processing units (the “von Neumann bottleneck”). In contrast, the brain co\sphinxhyphen{}locates memory and computation in synapses.

\sphinxAtStartPar
Memristors are resistive devices whose resistance changes based on the history of current flow through them. They can implement synaptic weights directly in hardware:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Memristor}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{r\PYGZus{}on}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{r\PYGZus{}off}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple memristor model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} r\PYGZus{}on: Low resistance state (ohms)}
\PYG{l+s+sd}{        \PYGZhy{} r\PYGZus{}off: High resistance state (ohms)}
\PYG{l+s+sd}{        \PYGZhy{} initial\PYGZus{}state: Initial state variable (0\PYGZhy{}1)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on} \PYG{o}{=} \PYG{n}{r\PYGZus{}on}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}off} \PYG{o}{=} \PYG{n}{r\PYGZus{}off}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n}{initial\PYGZus{}state}  \PYG{c+c1}{\PYGZsh{} Internal state variable (0\PYGZhy{}1)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}resistance}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate current resistance based on internal state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{*} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}off} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{voltage}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{,} \PYG{n}{learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update memristor state based on applied voltage}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} voltage: Applied voltage}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step}
\PYG{l+s+sd}{        \PYGZhy{} learn\PYGZus{}rate: Learning rate parameter}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Simplified nonlinear update rule}
        \PYG{k}{if} \PYG{n}{voltage} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Increase resistance (depression)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{+} \PYG{n}{learn\PYGZus{}rate} \PYG{o}{*} \PYG{n}{voltage} \PYG{o}{*} \PYG{n}{dt}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Decrease resistance (potentiation)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{+} \PYG{n}{learn\PYGZus{}rate} \PYG{o}{*} \PYG{n}{voltage} \PYG{o}{*} \PYG{n}{dt}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Memristor crossbar arrays can implement matrix multiplication operations directly in hardware with orders of magnitude less energy than digital implementations.


\subsection{16.1.3 Event\sphinxhyphen{}Based Sensors}
\label{\detokenize{part5/ch16_future_directions:event-based-sensors}}
\sphinxAtStartPar
Event\sphinxhyphen{}based sensors like Dynamic Vision Sensors (DVS) mimic the retina by only transmitting information when pixels detect changes in brightness:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}dvs\PYGZus{}output}\PYG{p}{(}\PYG{n}{video\PYGZus{}frames}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate output of a Dynamic Vision Sensor from video frames}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} video\PYGZus{}frames: Sequence of image frames (T, H, W)}
\PYG{l+s+sd}{    \PYGZhy{} threshold: Change threshold for generating events}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} events: List of (x, y, t, polarity) tuples}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{events} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{prev\PYGZus{}frame} \PYG{o}{=} \PYG{n}{video\PYGZus{}frames}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{t}\PYG{p}{,} \PYG{n}{frame} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{video\PYGZus{}frames}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate log intensity change}
        \PYG{n}{log\PYGZus{}diff} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{frame} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{prev\PYGZus{}frame} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate ON events (positive changes)}
        \PYG{n}{on\PYGZus{}events} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{log\PYGZus{}diff} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{on\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{on\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{events}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} x, y, time, polarity}
        
        \PYG{c+c1}{\PYGZsh{} Generate OFF events (negative changes)}
        \PYG{n}{off\PYGZus{}events} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{log\PYGZus{}diff} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{n}{threshold}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{off\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{off\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{events}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} x, y, time, polarity}
        
        \PYG{n}{prev\PYGZus{}frame} \PYG{o}{=} \PYG{n}{frame}
    
    \PYG{k}{return} \PYG{n}{events}
\end{sphinxVerbatim}

\sphinxAtStartPar
This event\sphinxhyphen{}based approach drastically reduces data transmission and power requirements, enabling high\sphinxhyphen{}speed vision processing with minimal energy.


\subsection{16.1.4 Brain\sphinxhyphen{}Inspired Chips}
\label{\detokenize{part5/ch16_future_directions:brain-inspired-chips}}
\sphinxAtStartPar
Several neuromorphic hardware platforms have demonstrated remarkable efficiency:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{IBM TrueNorth}: 1 million digital neurons with 256 million synapses, consuming only \textasciitilde{}70mW of power.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Intel Loihi}: Implements on\sphinxhyphen{}chip learning with \textasciitilde{}130,000 neurons and 130 million synapses per chip.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{SpiNNaker}: Massively parallel architecture designed specifically for neural simulations.

\end{enumerate}

\sphinxAtStartPar
These systems achieve energy efficiencies 100\sphinxhyphen{}1000× better than conventional architectures for certain tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}energy\PYGZus{}efficiency}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compare energy efficiency for image recognition task}
\PYG{l+s+sd}{    (based on published benchmarks)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{architectures} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPU (NVIDIA V100)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.76}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CPU (Intel Xeon)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{5.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.76}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{FPGA}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.75}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Loihi}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.74}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TrueNorth}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.0001}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.70}\PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Calculate energy efficiency (accuracy per joule)}
    \PYG{k}{for} \PYG{n}{arch}\PYG{p}{,} \PYG{n}{stats} \PYG{o+ow}{in} \PYG{n}{architectures}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{efficiency} \PYG{o}{=} \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{/} \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{arch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{efficiency}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ accuracy/joule}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{16.2 Continual Learning}
\label{\detokenize{part5/ch16_future_directions:continual-learning}}
\sphinxAtStartPar
One of the major challenges in current AI systems is the “catastrophic forgetting” problem: when trained on new tasks, neural networks often lose performance on previously learned tasks. The brain, in contrast, can learn continually throughout life.

\sphinxAtStartPar
\sphinxincludegraphics{{continual_learning}.svg}


\subsection{16.2.1 Catastrophic Forgetting Problem}
\label{\detokenize{part5/ch16_future_directions:catastrophic-forgetting-problem}}
\sphinxAtStartPar
When an artificial neural network is trained sequentially on different tasks, learning new tasks can overwrite weights critical for previous tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}catastrophic\PYGZus{}forgetting}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate catastrophic forgetting in a simple network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simplified experiment}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate two synthetic tasks}
    \PYG{n}{task\PYGZus{}A\PYGZus{}data} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{task\PYGZus{}A\PYGZus{}targets} \PYG{o}{=} \PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{task\PYGZus{}B\PYGZus{}data} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{task\PYGZus{}B\PYGZus{}targets} \PYG{o}{=} \PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{BCEWithLogitsLoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Initial training on task A}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pred\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}A} \PYG{o}{==} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}A}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{output\PYGZus{}B} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{pred\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output\PYGZus{}B} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}B} \PYG{o}{==} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}B}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Switch to training on task B}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pred\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}A} \PYG{o}{==} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}A}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{pred\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}B} \PYG{o}{==} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}B}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task A Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task B Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Switch to Task B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Steps}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Catastrophic Forgetting Demonstration}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}


\subsection{16.2.2 Biological Solutions to Stability\sphinxhyphen{}Plasticity}
\label{\detokenize{part5/ch16_future_directions:biological-solutions-to-stability-plasticity}}
\sphinxAtStartPar
The brain employs several mechanisms to balance stability (retaining old memories) and plasticity (forming new ones):
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Complementary Learning Systems Theory}: The hippocampus rapidly learns new experiences, while the neocortex gradually integrates knowledge through replay and consolidation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Synaptic Consolidation}: Synapses important for existing memories become less plastic and more stable over time.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromodulatory Systems}: Dopamine, acetylcholine, and other neuromodulators regulate learning rates based on novelty and importance.

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ComplementaryLearningSystems}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{fast\PYGZus{}learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{consolidation\PYGZus{}strength}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Fast\PYGZhy{}learning episodic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}  \PYG{c+c1}{\PYGZsh{} Slow\PYGZhy{}learning semantic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fast\PYGZus{}learn\PYGZus{}rate} \PYG{o}{=} \PYG{n}{fast\PYGZus{}learn\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate} \PYG{o}{=} \PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength} \PYG{o}{=} \PYG{n}{consolidation\PYGZus{}strength}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Learn a new experience\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} First, store in hippocampus (fast learning)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Then, slowly integrate into neocortex}
        \PYG{k}{if} \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Update existing knowledge}
            \PYG{n}{current} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{current}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{p}{)} \PYG{o}{+} 
                           \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{current}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength}
            \PYG{p}{\PYGZcb{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create new knowledge}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}
            \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{consolidate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{replay\PYGZus{}count}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Consolidate memories from hippocampus to neocortex\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Simulate memory replay during sleep}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{replay\PYGZus{}count}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Replay random experiences from hippocampus}
                \PYG{n}{replay\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{replay\PYGZus{}experience} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{[}\PYG{n}{replay\PYGZus{}idx}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Strengthen in neocortex}
                \PYG{n}{concept} \PYG{o}{=} \PYG{n}{replay\PYGZus{}experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
                \PYG{k}{if} \PYG{n}{concept} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{:}
                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{concept}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength}
\end{sphinxVerbatim}


\subsection{16.2.3 Replay and Consolidation Mechanisms}
\label{\detokenize{part5/ch16_future_directions:replay-and-consolidation-mechanisms}}
\sphinxAtStartPar
In both brains and artificial systems, replay of previous experiences helps consolidate memories:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ExperienceReplayBuffer}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Experience replay buffer for continual learning}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} capacity: Maximum number of experiences to store}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add an experience to the buffer\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{k+kc}{None}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position}\PYG{p}{]} \PYG{o}{=} \PYG{n}{experience}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Sample a batch of experiences randomly\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{k}{return} \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{indices}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{is\PYGZus{}empty}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Check if buffer is empty\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{0}
\end{sphinxVerbatim}


\subsection{16.2.4 Meta\sphinxhyphen{}Learning Approaches}
\label{\detokenize{part5/ch16_future_directions:meta-learning-approaches}}
\sphinxAtStartPar
Meta\sphinxhyphen{}learning, or “learning to learn,” aims to develop algorithms that improve their learning ability over time:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MetaContinualLearner}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{meta\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Meta\PYGZhy{}learning approach for continual learning}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} model: Base model to train}
\PYG{l+s+sd}{        \PYGZhy{} meta\PYGZus{}lr: Meta\PYGZhy{}learning rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n}{model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{meta\PYGZus{}lr}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Learn a specific task\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Create optimizer for this task if it doesn\PYGZsq{}t exist}
        \PYG{k}{if} \PYG{n}{task\PYGZus{}id} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{lr}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{optimizer} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}
        \PYG{n}{criterion} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Save initial weights}
        \PYG{n}{initial\PYGZus{}weights} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{name}\PYG{p}{:} \PYG{n}{param}\PYG{o}{.}\PYG{n}{clone}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} First, compute gradients on the current task}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Meta\PYGZhy{}update: consider performance on all previous tasks}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{meta\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{for} \PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{,} \PYG{n}{prev\PYGZus{}optimizer} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{prev\PYGZus{}task\PYGZus{}id} \PYG{o}{!=} \PYG{n}{task\PYGZus{}id}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Sample data from previous task (simplified)}
                \PYG{n}{prev\PYGZus{}data} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}task\PYGZus{}sample}\PYG{p}{(}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{)}
                \PYG{n}{prev\PYGZus{}targets} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}task\PYGZus{}targets}\PYG{p}{(}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Evaluate on previous task}
                \PYG{n}{prev\PYGZus{}outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{prev\PYGZus{}data}\PYG{p}{)}
                \PYG{n}{prev\PYGZus{}loss} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{]}\PYG{p}{(}\PYG{n}{prev\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{prev\PYGZus{}targets}\PYG{p}{)}
                \PYG{n}{meta\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{prev\PYGZus{}loss}
        
        \PYG{c+c1}{\PYGZsh{} Include current task loss}
        \PYG{n}{meta\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}
        
        \PYG{c+c1}{\PYGZsh{} Update model using meta\PYGZhy{}loss}
        \PYG{n}{meta\PYGZus{}loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}task\PYGZus{}sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Get a sample from a task (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real implementation, this would retrieve stored examples}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}task\PYGZus{}targets}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Get targets for a task sample (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real implementation, this would retrieve stored targets}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\end{sphinxVerbatim}


\section{16.3 AI for Neuroscience}
\label{\detokenize{part5/ch16_future_directions:ai-for-neuroscience}}
\sphinxAtStartPar
While neuroscience has heavily inspired AI, AI is now increasingly being used to advance neuroscience.


\subsection{16.3.1 Neural Data Analysis with Deep Learning}
\label{\detokenize{part5/ch16_future_directions:neural-data-analysis-with-deep-learning}}
\sphinxAtStartPar
Deep learning is transforming how we analyze complex neural data:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}neural\PYGZus{}recordings}\PYG{p}{(}\PYG{n}{spike\PYGZus{}data}\PYG{p}{,} \PYG{n}{behavior\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Use deep learning to analyze neural recording data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} spike\PYGZus{}data: Neural spike recordings [neurons, time]}
\PYG{l+s+sd}{    \PYGZhy{} behavior\PYGZus{}data: Behavioral measurements [time, features]}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} model: Trained neural decoder}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Prepare data}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{spike\PYGZus{}data}\PYG{o}{.}\PYG{n}{T}  \PYG{c+c1}{\PYGZsh{} [time, neurons]}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{behavior\PYGZus{}data}  \PYG{c+c1}{\PYGZsh{} [time, features]}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{n}{split\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create and train a neural decoder}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{y}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train the model}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} 
                    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average R² score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
These techniques have enabled breakthroughs in understanding neural dynamics and brain\sphinxhyphen{}behavior relationships.


\subsection{16.3.2 Brain Simulation Efforts}
\label{\detokenize{part5/ch16_future_directions:brain-simulation-efforts}}
\sphinxAtStartPar
Large\sphinxhyphen{}scale brain simulations aim to reproduce neural dynamics in silico:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BrainRegionSimulation}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{connectivity\PYGZus{}density}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simplified brain region simulation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}neurons: Number of neurons to simulate}
\PYG{l+s+sd}{        \PYGZhy{} connectivity\PYGZus{}density: Fraction of possible connections to create}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons}
        
        \PYG{c+c1}{\PYGZsh{} Initialize neurons (simplified LIF model)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.0}  \PYG{c+c1}{\PYGZsh{} resting potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{55.0}  \PYG{c+c1}{\PYGZsh{} spike threshold (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{75.0}  \PYG{c+c1}{\PYGZsh{} reset potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau} \PYG{o}{=} \PYG{l+m+mf}{20.0}  \PYG{c+c1}{\PYGZsh{} membrane time constant (ms)}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}  \PYG{c+c1}{\PYGZsh{} membrane potentials}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} time until end of refractory period}
        
        \PYG{c+c1}{\PYGZsh{} Generate random connectivity matrix}
        \PYG{n}{p} \PYG{o}{=} \PYG{n}{connectivity\PYGZus{}density}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}
            \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,} \PYG{n}{p}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{p}\PYG{p}{,} \PYG{n}{p}\PYG{p}{]}
        \PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Scale weights and ensure no self\PYGZhy{}connections}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{fill\PYGZus{}diagonal}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} 80\PYGZpc{} excitatory, 20\PYGZpc{} inhibitory}
        \PYG{n}{inh\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{[}\PYG{n}{inh\PYGZus{}neurons}\PYG{p}{]} \PYG{o}{*}\PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}
        
        \PYG{c+c1}{\PYGZsh{} Record spikes}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{p}{[}\PYG{p}{[}\PYG{p}{]} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{external\PYGZus{}input}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simulate one time step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} external\PYGZus{}input: External current to each neuron}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} spikes: Boolean array indicating which neurons spiked}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Default to no external input}
        \PYG{k}{if} \PYG{n}{external\PYGZus{}input} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potentials}
        \PYG{n}{non\PYGZus{}refractory} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Decay potential toward rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}\PYG{p}{)} \PYG{o}{+} 
                                        \PYG{n}{external\PYGZus{}input}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau}
        
        \PYG{c+c1}{\PYGZsh{} Check for spikes}
        \PYG{n}{spiked} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{spiked}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reset membrane potential and set refractory period for spiked neurons}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{spiked}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time}\PYG{p}{[}\PYG{n}{spiked}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{2.0}  \PYG{c+c1}{\PYGZsh{} 2ms refractory period}
        
        \PYG{c+c1}{\PYGZsh{} Decrement refractory time}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Add synaptic inputs from spiking neurons}
        \PYG{n}{synaptic\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{,} \PYG{n}{spiked}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{synaptic\PYGZus{}input}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{spiked}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{input\PYGZus{}fn}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run simulation for specified duration}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} duration: Simulation duration (ms)}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}fn: Function that returns external input at each time step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} spike\PYGZus{}times: List of spike times for each neuron}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{l+m+mf}{0.1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Assuming dt=0.1}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{step} \PYG{o}{*} \PYG{l+m+mf}{0.1}
            
            \PYG{c+c1}{\PYGZsh{} Get external input if provided}
            \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{k+kc}{None}
            \PYG{k}{if} \PYG{n}{input\PYGZus{}fn} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{n}{input\PYGZus{}fn}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
            
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{external\PYGZus{}input}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times}
\end{sphinxVerbatim}

\sphinxAtStartPar
Projects like the Blue Brain Project aim to create increasingly detailed simulations that can generate testable hypotheses about brain function.


\subsection{16.3.3 Connectome Reconstruction}
\label{\detokenize{part5/ch16_future_directions:connectome-reconstruction}}
\sphinxAtStartPar
Mapping the brain’s wiring diagram (connectome) is being accelerated by AI:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{segment\PYGZus{}neural\PYGZus{}images}\PYG{p}{(}\PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Segment neurons in electron microscopy images using deep learning}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} electron\PYGZus{}microscopy\PYGZus{}images: 3D stack of EM images}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} segmentation: 3D segmentation map}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a 3D U\PYGZhy{}Net model for segmentation}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{UNet3D}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 3 output channels: background, membrane, cell interior}
    
    \PYG{c+c1}{\PYGZsh{} Process image stack in 3D patches}
    \PYG{n}{patch\PYGZus{}size} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}
    \PYG{n}{segmentation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simplified inference (in practice, would need proper patch handling)}
    \PYG{k}{for} \PYG{n}{z} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Extract patch}
                \PYG{n}{z\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{z} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{y\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{y} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{x\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}
                
                \PYG{n}{patch} \PYG{o}{=} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{[}\PYG{n}{z}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Zero\PYGZhy{}pad if necessary}
                \PYG{k}{if} \PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape} \PYG{o}{!=} \PYG{n}{patch\PYGZus{}size}\PYG{p}{:}
                    \PYG{n}{padded} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{patch\PYGZus{}size}\PYG{p}{)}
                    \PYG{n}{padded}\PYG{p}{[}\PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{n}{patch}
                    \PYG{n}{patch} \PYG{o}{=} \PYG{n}{padded}
                
                \PYG{c+c1}{\PYGZsh{} Predict segmentation}
                \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{input\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{patch}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
                    \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{input\PYGZus{}tensor}\PYG{p}{)}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{squeeze}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update segmentation (handle overlap with averaging)}
                \PYG{n}{segmentation}\PYG{p}{[}\PYG{n}{z}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prediction}\PYG{p}{[}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{z}\PYG{p}{,} \PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{y}\PYG{p}{,} \PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Post\PYGZhy{}process to get instance segmentation (simplified)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{measure}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{label}
    \PYG{n}{instance\PYGZus{}seg} \PYG{o}{=} \PYG{n}{label}\PYG{p}{(}\PYG{n}{segmentation} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Assuming channel 2 is cell interior}
    
    \PYG{k}{return} \PYG{n}{instance\PYGZus{}seg}

\PYG{c+c1}{\PYGZsh{} Placeholder for 3D UNet}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{UNet3D}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{in\PYGZus{}channels}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Simplified placeholder for the model architecture}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{p}{,} \PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simplified forward pass}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x}
\end{sphinxVerbatim}


\subsection{16.3.4 Theory Development through Modeling}
\label{\detokenize{part5/ch16_future_directions:theory-development-through-modeling}}
\sphinxAtStartPar
Computational models help bridge the gap between neural mechanisms and cognitive function:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BayesianInferenceBrain}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{prior\PYGZus{}mean}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{prior\PYGZus{}var}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Model of Bayesian inference in the brain}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensory\PYGZus{}noise: Standard deviation of sensory noise}
\PYG{l+s+sd}{        \PYGZhy{} prior\PYGZus{}mean: Prior belief about the mean of the variable}
\PYG{l+s+sd}{        \PYGZhy{} prior\PYGZus{}var: Prior belief about the variance of the variable}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise} \PYG{o}{=} \PYG{n}{sensory\PYGZus{}noise}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prior\PYGZus{}mean} \PYG{o}{=} \PYG{n}{prior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prior\PYGZus{}var} \PYG{o}{=} \PYG{n}{prior\PYGZus{}var}
        
        \PYG{c+c1}{\PYGZsh{} Current belief}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{=} \PYG{n}{prior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var} \PYG{o}{=} \PYG{n}{prior\PYGZus{}var}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}belief}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{observation}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update beliefs using Bayes\PYGZsq{} rule}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} observation: New sensory observation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} posterior\PYGZus{}mean: Updated belief mean}
\PYG{l+s+sd}{        \PYGZhy{} posterior\PYGZus{}var: Updated belief variance}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Compute precision (inverse variance)}
        \PYG{n}{prior\PYGZus{}precision} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var}
        \PYG{n}{obs\PYGZus{}precision} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Bayesian update (for Gaussian variables)}
        \PYG{n}{posterior\PYGZus{}precision} \PYG{o}{=} \PYG{n}{prior\PYGZus{}precision} \PYG{o}{+} \PYG{n}{obs\PYGZus{}precision}
        \PYG{n}{posterior\PYGZus{}var} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n}{posterior\PYGZus{}precision}
        
        \PYG{n}{posterior\PYGZus{}mean} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}var} \PYG{o}{*} \PYG{p}{(}
            \PYG{n}{prior\PYGZus{}precision} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{+} 
            \PYG{n}{obs\PYGZus{}precision} \PYG{o}{*} \PYG{n}{observation}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update beliefs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}var}
        
        \PYG{k}{return} \PYG{n}{posterior\PYGZus{}mean}\PYG{p}{,} \PYG{n}{posterior\PYGZus{}var}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}observation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate predicted observations based on current belief}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}samples: Number of samples to generate}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} samples: Predicted observations}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Sample from current belief}
        \PYG{n}{samples} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var}\PYG{p}{)}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add sensory noise}
        \PYG{n}{samples} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{samples}
\end{sphinxVerbatim}


\section{16.4 Whole\sphinxhyphen{}Brain Integration}
\label{\detokenize{part5/ch16_future_directions:whole-brain-integration}}
\sphinxAtStartPar
Understanding how specialized neural systems interact to produce integrated cognition is a key challenge for both neuroscience and AI.

\sphinxAtStartPar
\sphinxincludegraphics{{whole_brain_integration}.svg}


\subsection{16.4.1 Combining Specialized Neural Systems}
\label{\detokenize{part5/ch16_future_directions:combining-specialized-neural-systems}}
\sphinxAtStartPar
The brain integrates information across specialized areas, a challenge for current AI systems:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{IntegratedCognitiveArchitecture}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Architecture combining specialized neural systems}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Specialized modules}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{visual\PYGZus{}system} \PYG{o}{=} \PYG{n}{ConvolutionalNetwork}\PYG{p}{(}\PYG{n}{input\PYGZus{}shape}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{224}\PYG{p}{,} \PYG{l+m+mi}{224}\PYG{p}{)}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{language\PYGZus{}system} \PYG{o}{=} \PYG{n}{TransformerNetwork}\PYG{p}{(}\PYG{n}{vocab\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{50000}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}system} \PYG{o}{=} \PYG{n}{EpisodicMemoryStore}\PYG{p}{(}\PYG{n}{embedding\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{motor\PYGZus{}system} \PYG{o}{=} \PYG{n}{MotorController}\PYG{p}{(}\PYG{n}{control\PYGZus{}dims}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Integration module (global workspace)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{workspace} \PYG{o}{=} \PYG{n}{GlobalWorkspace}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{512}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Attention control}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention} \PYG{o}{=} \PYG{n}{AttentionController}\PYG{p}{(}\PYG{n}{n\PYGZus{}sources}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{visual\PYGZus{}input}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{language\PYGZus{}input}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{memory\PYGZus{}query}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process inputs through the integrated architecture}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} outputs: Dictionary of outputs from various systems}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{module\PYGZus{}outputs} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Process inputs through specialized systems}
        \PYG{k}{if} \PYG{n}{visual\PYGZus{}input} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{module\PYGZus{}outputs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visual}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{visual\PYGZus{}system}\PYG{p}{(}\PYG{n}{visual\PYGZus{}input}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{language\PYGZus{}input} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{module\PYGZus{}outputs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{language}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{language\PYGZus{}system}\PYG{p}{(}\PYG{n}{language\PYGZus{}input}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{memory\PYGZus{}query} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{module\PYGZus{}outputs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{memory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}system}\PYG{o}{.}\PYG{n}{retrieve}\PYG{p}{(}\PYG{n}{memory\PYGZus{}query}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Determine attention allocation}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{module\PYGZus{}outputs}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Integrate in global workspace}
        \PYG{n}{integrated\PYGZus{}representation} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{workspace}\PYG{p}{(}\PYG{n}{module\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update memory with integrated representation}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}system}\PYG{o}{.}\PYG{n}{store}\PYG{p}{(}\PYG{n}{integrated\PYGZus{}representation}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate motor commands if requested}
        \PYG{n}{motor\PYGZus{}output} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{k}{if} \PYG{n}{motor\PYGZus{}command} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{motor\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{motor\PYGZus{}system}\PYG{p}{(}\PYG{n}{integrated\PYGZus{}representation}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{integrated}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{integrated\PYGZus{}representation}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{motor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{motor\PYGZus{}output}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{attention}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{attention\PYGZus{}weights}
        \PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Placeholder specialized module classes}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ConvolutionalNetwork}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}shape}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Simplified visual processing network}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerNetwork}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{vocab\PYGZus{}size}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Simplified language model}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{EpisodicMemoryStore}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{,} \PYG{n}{capacity}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{store}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{embedding}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{embedding}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{retrieve}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{query}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simplified memory retrieval}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MotorController}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{control\PYGZus{}dims}\PYG{p}{,} \PYG{n}{embedding\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Simplified motor controller}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{GlobalWorkspace}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Simplified global workspace}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{module\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{attention\PYGZus{}weights}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AttentionController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}sources}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simplified attention controller}
        \PYG{k}{pass}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}call\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{features}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Return random attention weights}
        \PYG{k}{return} \PYG{p}{[}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Placeholder}
\end{sphinxVerbatim}


\subsection{16.4.2 Global Workspace Theory}
\label{\detokenize{part5/ch16_future_directions:global-workspace-theory}}
\sphinxAtStartPar
Global Workspace Theory (GWT) proposes that specialized neural modules compete for access to a central “workspace” where information becomes consciously available:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}global\PYGZus{}workspace}\PYG{p}{(}\PYG{n}{input\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{specialized\PYGZus{}modules}\PYG{p}{,} \PYG{n}{workspace\PYGZus{}capacity}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate global workspace dynamics with competing modules}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} input\PYGZus{}stimuli: Dictionary of inputs to each module}
\PYG{l+s+sd}{    \PYGZhy{} specialized\PYGZus{}modules: Dictionary of processing modules}
\PYG{l+s+sd}{    \PYGZhy{} workspace\PYGZus{}capacity: Maximum number of modules that can access workspace}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} consciousness: Contents of global workspace}
\PYG{l+s+sd}{    \PYGZhy{} access\PYGZus{}history: Which modules accessed consciousness over time}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}timesteps} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{access\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{consciousness} \PYG{o}{=} \PYG{k+kc}{None}
    
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}timesteps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Process inputs in specialized modules}
        \PYG{n}{module\PYGZus{}outputs} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n}{module\PYGZus{}activations} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{module} \PYG{o+ow}{in} \PYG{n}{specialized\PYGZus{}modules}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{input\PYGZus{}stimuli}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Process input}
                \PYG{n}{output} \PYG{o}{=} \PYG{n}{module}\PYG{o}{.}\PYG{n}{process}\PYG{p}{(}\PYG{n}{input\PYGZus{}stimuli}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{module\PYGZus{}outputs}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{output}
                
                \PYG{c+c1}{\PYGZsh{} Calculate activation (salience or importance)}
                \PYG{n}{module\PYGZus{}activations}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{module}\PYG{o}{.}\PYG{n}{calculate\PYGZus{}activation}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Determine which modules access the workspace}
        \PYG{c+c1}{\PYGZsh{} Sort by activation and take top k (winner\PYGZhy{}take\PYGZhy{}all competition)}
        \PYG{n}{sorted\PYGZus{}modules} \PYG{o}{=} \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{module\PYGZus{}activations}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reverse}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{winners} \PYG{o}{=} \PYG{p}{[}\PYG{n}{name} \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n}{sorted\PYGZus{}modules}\PYG{p}{[}\PYG{p}{:}\PYG{n}{workspace\PYGZus{}capacity}\PYG{p}{]}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Update workspace contents (simplified)}
        \PYG{n}{consciousness} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{name}\PYG{p}{:} \PYG{n}{module\PYGZus{}outputs}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{winners}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Log which modules accessed consciousness}
        \PYG{n}{access\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{winners}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update module states based on workspace contents}
        \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{module} \PYG{o+ow}{in} \PYG{n}{specialized\PYGZus{}modules}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{module}\PYG{o}{.}\PYG{n}{update\PYGZus{}state}\PYG{p}{(}\PYG{n}{consciousness}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update inputs based on current state (e.g., attention shifts)}
        \PYG{c+c1}{\PYGZsh{} This would depend on the specific task being simulated}
    
    \PYG{k}{return} \PYG{n}{consciousness}\PYG{p}{,} \PYG{n}{access\PYGZus{}history}
\end{sphinxVerbatim}


\subsection{16.4.3 Attention and Conscious Processing}
\label{\detokenize{part5/ch16_future_directions:attention-and-conscious-processing}}
\sphinxAtStartPar
Attention mechanisms determine what information enters conscious awareness:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AttentionalBottleneck}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Model of attentional bottleneck in consciousness}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}channels: Number of input channels}
\PYG{l+s+sd}{        \PYGZhy{} capacity: Number of channels that can be attended simultaneously}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{n}{n\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{salience} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attended} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}salience}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute salience of each input channel}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} inputs: List of inputs to each channel}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real model, salience would depend on input features}
        \PYG{c+c1}{\PYGZsh{} Here we use a simplified random approach}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{salience} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{inp}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)} 
                                 \PYG{k}{for} \PYG{n}{inp} \PYG{o+ow}{in} \PYG{n}{inputs}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add noise}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{salience} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{select\PYGZus{}attended}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Select which channels are attended based on salience}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Select top k channels by salience}
        \PYG{n}{top\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{salience}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attended} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attended}\PYG{p}{[}\PYG{n}{top\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{k+kc}{True}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process inputs through the attentional bottleneck}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} inputs: List of inputs to each channel}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} conscious\PYGZus{}contents: Contents that reach consciousness}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)} \PYG{o}{!=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Expected }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ inputs, got }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute salience for each input channel}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{compute\PYGZus{}salience}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Select attended channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{select\PYGZus{}attended}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Only attended channels reach consciousness}
        \PYG{n}{conscious\PYGZus{}contents} \PYG{o}{=} \PYG{p}{[}\PYG{n}{inp} \PYG{k}{if} \PYG{n}{att} \PYG{k}{else} \PYG{k+kc}{None} \PYG{k}{for} \PYG{n}{inp}\PYG{p}{,} \PYG{n}{att} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attended}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{conscious\PYGZus{}contents}
\end{sphinxVerbatim}


\subsection{16.4.4 Metacognition and Introspection}
\label{\detokenize{part5/ch16_future_directions:metacognition-and-introspection}}
\sphinxAtStartPar
Metacognition—thinking about thinking—is a distinctive feature of human cognition:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MetacognitiveModel}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{base\PYGZus{}model}\PYG{p}{,} \PYG{n}{confidence\PYGZus{}threshold}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Model with metacognitive capabilities}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} base\PYGZus{}model: The underlying cognitive model}
\PYG{l+s+sd}{        \PYGZhy{} confidence\PYGZus{}threshold: Threshold for confidence\PYGZhy{}based decisions}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{base\PYGZus{}model} \PYG{o}{=} \PYG{n}{base\PYGZus{}model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold} \PYG{o}{=} \PYG{n}{confidence\PYGZus{}threshold}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{performance\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{allow\PYGZus{}defer}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Make a prediction with metacognitive monitoring}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}data: Input for the base model}
\PYG{l+s+sd}{        \PYGZhy{} allow\PYGZus{}defer: Whether to allow deferring the decision}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} prediction: Model\PYGZsq{}s prediction}
\PYG{l+s+sd}{        \PYGZhy{} confidence: Confidence in the prediction}
\PYG{l+s+sd}{        \PYGZhy{} deferred: Whether the decision was deferred}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get base model prediction}
        \PYG{n}{prediction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{base\PYGZus{}model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{input\PYGZus{}data}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Estimate confidence (in a real model, this would be based on model internals)}
        \PYG{n}{confidence} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{estimate\PYGZus{}confidence}\PYG{p}{(}\PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{prediction}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decision to defer based on confidence}
        \PYG{n}{deferred} \PYG{o}{=} \PYG{k+kc}{False}
        \PYG{k}{if} \PYG{n}{allow\PYGZus{}defer} \PYG{o+ow}{and} \PYG{n}{confidence} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold}\PYG{p}{:}
            \PYG{n}{deferred} \PYG{o}{=} \PYG{k+kc}{True}
        
        \PYG{c+c1}{\PYGZsh{} Record for metacognitive learning}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{confidence}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{prediction}\PYG{p}{,} \PYG{n}{confidence}\PYG{p}{,} \PYG{n}{deferred}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{estimate\PYGZus{}confidence}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{prediction}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Estimate confidence in a prediction}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}data: Input data}
\PYG{l+s+sd}{        \PYGZhy{} prediction: Model\PYGZsq{}s prediction}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} confidence: Estimated confidence (0\PYGZhy{}1)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real model, confidence would be computed from model internals}
        \PYG{c+c1}{\PYGZsh{} For simplicity, we use a placeholder}
        
        \PYG{c+c1}{\PYGZsh{} For example, in a classification model:}
        \PYG{c+c1}{\PYGZsh{} confidence = softmax\PYGZus{}outputs[predicted\PYGZus{}class]}
        
        \PYG{n}{confidence} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{beta}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Placeholder}
        
        \PYG{k}{return} \PYG{n}{confidence}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}metacognition}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{ground\PYGZus{}truth}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update metacognitive model based on actual performance}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} ground\PYGZus{}truth: True answer for the last prediction}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{last\PYGZus{}prediction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{base\PYGZus{}model}\PYG{o}{.}\PYG{n}{last\PYGZus{}prediction}
        \PYG{n}{last\PYGZus{}confidence} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}history}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Check if prediction was correct}
        \PYG{n}{correct} \PYG{o}{=} \PYG{p}{(}\PYG{n}{last\PYGZus{}prediction} \PYG{o}{==} \PYG{n}{ground\PYGZus{}truth}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record performance}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{performance\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{correct}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Adjust confidence threshold based on performance}
        \PYG{c+c1}{\PYGZsh{} Increase threshold if overconfident in wrong answers}
        \PYG{c+c1}{\PYGZsh{} Decrease threshold if underconfident in right answers}
        
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{correct} \PYG{o+ow}{and} \PYG{n}{last\PYGZus{}confidence} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.8}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Overconfident error}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.01}
        \PYG{k}{elif} \PYG{n}{correct} \PYG{o+ow}{and} \PYG{n}{last\PYGZus{}confidence} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.6}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Underconfident correct answer}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{l+m+mf}{0.01}
        
        \PYG{c+c1}{\PYGZsh{} Keep threshold in reasonable range}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb}{max}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}threshold}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.95}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calibration\PYGZus{}error}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Calculate calibration error of confidence estimates}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} error: Mean squared error between confidence and accuracy}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{performance\PYGZus{}history}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Convert boolean performance to 0/1}
        \PYG{n}{performance} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{performance\PYGZus{}history}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{float}\PYG{p}{)}
        \PYG{n}{confidence} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{confidence\PYGZus{}history}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate mean squared error}
        \PYG{n}{error} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{confidence} \PYG{o}{\PYGZhy{}} \PYG{n}{performance}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{error}
\end{sphinxVerbatim}


\section{16.5 Ethical Considerations}
\label{\detokenize{part5/ch16_future_directions:ethical-considerations}}
\sphinxAtStartPar
As brain\sphinxhyphen{}inspired AI systems advance, ethical considerations become increasingly important.

\sphinxAtStartPar
\sphinxincludegraphics{{neuroethics}.svg}


\subsection{16.5.1 Neural Privacy and Brain\sphinxhyphen{}Computer Interfaces}
\label{\detokenize{part5/ch16_future_directions:neural-privacy-and-brain-computer-interfaces}}
\sphinxAtStartPar
Brain\sphinxhyphen{}computer interfaces (BCIs) raise important privacy considerations:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralPrivacyFramework}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Framework for neural data privacy protection}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identifiable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}     \PYG{c+c1}{\PYGZsh{} Share personally identifiable neural data}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pseudonymized}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Share with personally identifying info removed}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{aggregate\PYGZus{}only}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Share only data aggregated across individuals}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{model\PYGZus{}only}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} Share only models trained on data, not data itself}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{no\PYGZus{}sharing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}        \PYG{c+c1}{\PYGZsh{} No sharing of any kind}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motor}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{emotion}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{thoughts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{personal\PYGZus{}memories}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sensitivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{medical\PYGZus{}treatment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{basic\PYGZus{}research}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{commercial\PYGZus{}development}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{advertising}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{law\PYGZus{}enforcement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{check\PYGZus{}access\PYGZus{}permitted}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data\PYGZus{}type}\PYG{p}{,} \PYG{n}{purpose}\PYG{p}{,} \PYG{n}{sharing\PYGZus{}level}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Check if data access is permitted under the framework}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} data\PYGZus{}type: Type of neural data}
\PYG{l+s+sd}{        \PYGZhy{} purpose: Purpose of data use}
\PYG{l+s+sd}{        \PYGZhy{} sharing\PYGZus{}level: Level of data sharing}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} permitted: Whether access is permitted}
\PYG{l+s+sd}{        \PYGZhy{} reason: Reason for decision}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{data\PYGZus{}type} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown data type: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{if} \PYG{n}{purpose} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown purpose: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{purpose}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{if} \PYG{n}{sharing\PYGZus{}level} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unknown sharing level: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sharing\PYGZus{}level}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if data type can be shared at all}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}types}\PYG{p}{[}\PYG{n}{data\PYGZus{}type}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sharing\PYGZus{}allowed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ data cannot be shared due to sensitivity}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if purpose is authorized}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{authorized\PYGZus{}purposes}\PYG{p}{[}\PYG{n}{purpose}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Purpose }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{purpose}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ is not authorized}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Check if sharing level is consented to}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consent\PYGZus{}levels}\PYG{p}{[}\PYG{n}{sharing\PYGZus{}level}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No consent for sharing level: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sharing\PYGZus{}level}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Special cases}
        \PYG{k}{if} \PYG{n}{data\PYGZus{}type} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{thoughts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{personal\PYGZus{}memories}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o+ow}{and} \PYG{n}{sharing\PYGZus{}level} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{identifiable}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pseudonymized}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Higher\PYGZhy{}level anonymization required for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Access permitted}
        \PYG{k}{return} \PYG{k+kc}{True}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Access permitted under framework}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{differential\PYGZus{}privacy\PYGZus{}transform}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply differential privacy to neural data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} neural\PYGZus{}data: Raw neural data}
\PYG{l+s+sd}{        \PYGZhy{} epsilon: Privacy parameter (lower = more privacy)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} private\PYGZus{}data: Privacy\PYGZhy{}protected version of the data}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Simplified implementation of differential privacy}
        \PYG{c+c1}{\PYGZsh{} Add calibrated noise to guarantee differential privacy}
        \PYG{n}{sensitivity} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Maximum change one person can have on output}
        \PYG{n}{scale} \PYG{o}{=} \PYG{n}{sensitivity} \PYG{o}{/} \PYG{n}{epsilon}
        
        \PYG{c+c1}{\PYGZsh{} Add Laplace noise to each value}
        \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{laplace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{scale}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
        \PYG{n}{private\PYGZus{}data} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data} \PYG{o}{+} \PYG{n}{noise}
        
        \PYG{k}{return} \PYG{n}{private\PYGZus{}data}
\end{sphinxVerbatim}


\subsection{16.5.2 Implications of Brain\sphinxhyphen{}like AI}
\label{\detokenize{part5/ch16_future_directions:implications-of-brain-like-ai}}
\sphinxAtStartPar
As AI systems become more brain\sphinxhyphen{}like, ethical questions about consciousness and rights may arise:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}ai\PYGZus{}consciousness\PYGZus{}criteria}\PYG{p}{(}\PYG{n}{system\PYGZus{}properties}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Analyze an AI system against criteria for consciousness}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} system\PYGZus{}properties: Dictionary of properties and their values}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} evaluation: Assessment against consciousness criteria}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Proposed criteria for consciousness (philosophical framework)}
    \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{integration}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Information integration across subsystems}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{φ (phi) from Integrated Information Theory}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.2}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reportability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ability to report on internal states}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Accuracy of self\PYGZhy{}monitoring}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.7}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.15}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{self\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Representation of self as distinct from environment}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Internal model calibration score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.6}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.2}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{intentionality}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{States are about something (have content)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Semantic coherence of internal states}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.15}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{adaptation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Flexible response to novel situations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Performance on out\PYGZhy{}of\PYGZhy{}distribution tasks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.4}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{temporality}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temporal integration of experience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Memory coherence score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{qualia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Subjective experience (hardest to measure)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurement}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Behavioral indicators of experience}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate system against criteria}
    \PYG{n}{evaluation} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{total\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{n}{max\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{for} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{details} \PYG{o+ow}{in} \PYG{n}{criteria}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{criterion} \PYG{o+ow}{in} \PYG{n}{system\PYGZus{}properties}\PYG{p}{:}
            \PYG{n}{value} \PYG{o}{=} \PYG{n}{system\PYGZus{}properties}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Calculate score (0\PYGZhy{}1)}
            \PYG{n}{meets\PYGZus{}threshold} \PYG{o}{=} \PYG{n}{value} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{n}{score} \PYG{o}{=} \PYG{n}{value} \PYG{o}{*} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{value}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meets\PYGZus{}threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{meets\PYGZus{}threshold}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weighted\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{score}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}
            \PYG{p}{\PYGZcb{}}
            
            \PYG{n}{total\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{score}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{n}{criterion}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{None}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meets\PYGZus{}threshold}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weighted\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{max\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weight}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Overall assessment}
    \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{total\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{total\PYGZus{}score}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{max\PYGZus{}possible}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{max\PYGZus{}score}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{percentage}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{total\PYGZus{}score} \PYG{o}{/} \PYG{n}{max\PYGZus{}score} \PYG{o}{*} \PYG{l+m+mi}{100}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{This framework does not claim to definitively determine consciousness, }\PYG{l+s+s2}{\PYGZdq{}}
                  \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{but provides a structured approach to evaluating systems against proposed criteria.}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{evaluation}
\end{sphinxVerbatim}


\subsection{16.5.3 Neuroethics Frameworks}
\label{\detokenize{part5/ch16_future_directions:neuroethics-frameworks}}
\sphinxAtStartPar
The field of neuroethics provides guidance for responsible development of neurotechnology:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ResponsibleInnovationGuidelines}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Guidelines for responsible innovation in neuro\PYGZhy{}AI}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{transparency}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear documentation of capabilities and limitations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Publication of technical specifications}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Accessible explanation of function}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Disclosure of training data sources}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear indication of AI\PYGZhy{}generated content}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accountability}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Clear lines of responsibility for system outcomes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Defined responsibility for errors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Auditing mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recourse for affected individuals}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Regular impact assessments}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inclusivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Development with diverse stakeholder input}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Engagement with potentially affected communities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Diverse development team}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Consideration of varied cultural perspectives}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Testing across diverse populations}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{non\PYGZus{}maleficence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Prevention of harm from system operation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Safety testing protocols}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk assessment framework}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ongoing monitoring}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kill switch mechanisms}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{autonomy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{description}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Respect for human decision\PYGZhy{}making authority}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Informed consent processes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Opt\PYGZhy{}out mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Control over personal data}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Avoidance of manipulative design}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}technology}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{tech\PYGZus{}description}\PYG{p}{,} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Evaluate a technology against responsible innovation principles}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} tech\PYGZus{}description: Description of the technology}
\PYG{l+s+sd}{        \PYGZhy{} principles\PYGZus{}assessment: Dictionary with ratings for each principle}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} evaluation: Detailed evaluation against principles}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{evaluation} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{tech\PYGZus{}description}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{n}{total\PYGZus{}score} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{principle}\PYG{p}{,} \PYG{n}{details} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{principle} \PYG{o+ow}{in} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{:}
                \PYG{n}{score} \PYG{o}{=} \PYG{n}{principles\PYGZus{}assessment}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]}
                \PYG{n}{total\PYGZus{}score} \PYG{o}{+}\PYG{o}{=} \PYG{n}{score}
                
                \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{score}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strengths}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{principles\PYGZus{}assessment}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}strengths}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{weaknesses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{principles\PYGZus{}assessment}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}weaknesses}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
                \PYG{p}{\PYGZcb{}}
                
                \PYG{c+c1}{\PYGZsh{} Generate recommendations for low scores}
                \PYG{k}{if} \PYG{n}{score} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.7}\PYG{p}{:}
                    \PYG{k}{for} \PYG{n}{req} \PYG{o+ow}{in} \PYG{n}{details}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{requirements}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
                        \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                            \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improve }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{principle}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ by addressing: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{req}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
                        \PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{principles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{principle}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{note}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Not assessed}\PYG{l+s+s2}{\PYGZdq{}}
                \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Calculate overall adherence}
        \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{total\PYGZus{}score} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{principles}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Overall assessment}
        \PYG{k}{if} \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mf}{0.8}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{High adherence to responsible innovation principles}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{elif} \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overall\PYGZus{}adherence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mf}{0.6}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Moderate adherence with specific areas needing improvement}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{evaluation}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Low adherence \PYGZhy{} significant revisions recommended}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{return} \PYG{n}{evaluation}
\end{sphinxVerbatim}


\subsection{16.5.4 Responsible Innovation}
\label{\detokenize{part5/ch16_future_directions:responsible-innovation}}
\sphinxAtStartPar
Responsible innovation involves anticipating impacts and engaging diverse stakeholders:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{ethical\PYGZus{}impact\PYGZus{}assessment}\PYG{p}{(}\PYG{n}{technology\PYGZus{}description}\PYG{p}{,} \PYG{n}{stakeholders}\PYG{p}{,} \PYG{n}{societal\PYGZus{}domains}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Conduct an ethical impact assessment for a neuro\PYGZhy{}AI technology}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} technology\PYGZus{}description: Description of the technology}
\PYG{l+s+sd}{    \PYGZhy{} stakeholders: List of stakeholder groups}
\PYG{l+s+sd}{    \PYGZhy{} societal\PYGZus{}domains: Domains to assess impact on}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} assessment: Impact assessment results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{assessment} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{technology}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{technology\PYGZus{}description}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stakeholder\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{domain\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{benefit\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{uncertainty\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Assess impact on each stakeholder group}
    \PYG{k}{for} \PYG{n}{stakeholder} \PYG{o+ow}{in} \PYG{n}{stakeholders}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} In a real assessment, this would involve engagement with stakeholders}
        \PYG{c+c1}{\PYGZsh{} For this example, we\PYGZsq{}ll simulate with placeholder values}
        \PYG{n}{impact} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{direct\PYGZus{}benefits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{direct\PYGZus{}risks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{indirect\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power\PYGZus{}dynamics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stakeholder\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{stakeholder}\PYG{p}{]} \PYG{o}{=} \PYG{n}{impact}
    
    \PYG{c+c1}{\PYGZsh{} Assess impact on each societal domain}
    \PYG{k}{for} \PYG{n}{domain} \PYG{o+ow}{in} \PYG{n}{societal\PYGZus{}domains}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} In a real assessment, this would involve domain expert input}
        \PYG{c+c1}{\PYGZsh{} For this example, we\PYGZsq{}ll simulate with placeholder values}
        \PYG{n}{impact} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{short\PYGZus{}term\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{long\PYGZus{}term\PYGZus{}effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{structural\PYGZus{}changes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
        \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{domain\PYGZus{}impacts}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{domain}\PYG{p}{]} \PYG{o}{=} \PYG{n}{impact}
    
    \PYG{c+c1}{\PYGZsh{} Identify key risk and benefit factors}
    \PYG{c+c1}{\PYGZsh{} In a real assessment, this would be based on stakeholder and expert input}
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{risk\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Privacy implications of neural data collection}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for creating new social inequalities}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Risk of misuse for manipulation or control}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{benefit\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for new treatments for neurological conditions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Improved human\PYGZhy{}computer interaction}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enhanced understanding of neural processes}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{uncertainty\PYGZus{}factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Long\PYGZhy{}term effects on neural plasticity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential for emergent behaviors in advanced systems}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Future regulatory frameworks}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Generate recommendations}
    \PYG{n}{assessment}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recommendations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Implement stringent data privacy protections}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Establish inclusive governance mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ensure accessible distribution of benefits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Develop monitoring frameworks for long\PYGZhy{}term effects}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Create clear boundaries for acceptable use cases}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{assessment}
\end{sphinxVerbatim}


\section{16.6 Code Lab: Simple Spiking Neural Network}
\label{\detokenize{part5/ch16_future_directions:code-lab-simple-spiking-neural-network}}
\sphinxAtStartPar
Let’s implement a simple spiking neural network that demonstrates the key principles of neuromorphic computing:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{animation}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{FuncAnimation}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SpikingNeuralNetwork}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}input}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}output}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple Spiking Neural Network with LIF neurons}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}input: Number of input neurons}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}hidden: Number of hidden neurons}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}output: Number of output neurons}
\PYG{l+s+sd}{        \PYGZhy{} dt: Simulation time step (ms)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}input} \PYG{o}{=} \PYG{n}{n\PYGZus{}input}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{n\PYGZus{}hidden}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output} \PYG{o}{=} \PYG{n}{n\PYGZus{}output}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt} \PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Initialize random weights}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}input\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}input}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}hidden\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Neuron parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.0}  \PYG{c+c1}{\PYGZsh{} resting potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{75.0}  \PYG{c+c1}{\PYGZsh{} reset potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{55.0}  \PYG{c+c1}{\PYGZsh{} threshold potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{10.0}  \PYG{c+c1}{\PYGZsh{} membrane time constant (ms)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period} \PYG{o}{=} \PYG{l+m+mf}{2.0}  \PYG{c+c1}{\PYGZsh{} refractory period (ms)}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Recording}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Current time}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Reset network state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run one simulation step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}spikes: Binary array of input spikes (0 or 1)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}spikes: Binary array of output spikes}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Update hidden layer}
        \PYG{c+c1}{\PYGZsh{} Calculate input current from input layer spikes}
        \PYG{n}{input\PYGZus{}current} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}input\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check which neurons are not in refractory period}
        \PYG{n}{active\PYGZus{}hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potentials for active neurons}
        \PYG{n}{dv\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{+} \PYG{n}{input\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{active\PYGZus{}hidden}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dv\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{active\PYGZus{}hidden}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check for spikes in hidden layer}
        \PYG{n}{hidden\PYGZus{}spikes} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reset membrane potential and set refractory period for spiked neurons}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period}
        
        \PYG{c+c1}{\PYGZsh{} Decrement refractory time}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update output layer (similar process)}
        \PYG{n}{output\PYGZus{}current} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}hidden\PYGZus{}output}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}
        \PYG{n}{active\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{n}{dv\PYGZus{}output} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{+} \PYG{n}{output\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{n}{active\PYGZus{}output}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dv\PYGZus{}output}\PYG{p}{[}\PYG{n}{active\PYGZus{}output}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{n}{output\PYGZus{}spikes} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period}
            
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record history}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output\PYGZus{}spikes}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}pattern}\PYG{p}{,} \PYG{n}{simulation\PYGZus{}time}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run simulation for specified time with given input pattern}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}pattern: Function that returns input spikes at each time step}
\PYG{l+s+sd}{        \PYGZhy{} simulation\PYGZus{}time: Total simulation time (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}history: History of output spikes}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{simulation\PYGZus{}time} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset\PYGZus{}state}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{output\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{step} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
            \PYG{n}{input\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{input\PYGZus{}pattern}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
            \PYG{n}{output\PYGZus{}spikes} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}
            \PYG{n}{output\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{output\PYGZus{}history}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot spike raster and membrane potentials\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No simulation data to plot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{k}{return}
        
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{n}{figsize}\PYG{p}{,} \PYG{n}{sharex}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert spike history to arrays}
        \PYG{n}{spikes\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n}{spikes\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Time array}
        \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spikes\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot hidden layer spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{n}{time}\PYG{p}{[}\PYG{n}{spikes\PYGZus{}hidden}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Layer Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot output layer spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{n}{time}\PYG{p}{[}\PYG{n}{spikes\PYGZus{}output}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Layer Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot membrane potentials}
        \PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot a few hidden neurons}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Membrane Potential (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Layer Membrane Potentials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot all output neurons}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Membrane Potential (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Layer Membrane Potentials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{fig}

\PYG{c+c1}{\PYGZsh{} Demo: pattern recognition with spiking neural network}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}snn\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Create a simple SNN with 5 input, 10 hidden, and 2 output neurons}
    \PYG{n}{snn} \PYG{o}{=} \PYG{n}{SpikingNeuralNetwork}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define input patterns (simplified)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{pattern\PYGZus{}1}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Pattern 1: neurons 0, 1, 2 active}
        \PYG{n}{period} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} ms}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{5} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{3} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{8} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{6} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{12} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{pattern\PYGZus{}2}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Pattern 2: neurons 2, 3, 4 active}
        \PYG{n}{period} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} ms}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{2} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{7} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{5} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{10} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{8} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{15} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run simulations with different input patterns}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running simulation for pattern 1...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{snn}\PYG{o}{.}\PYG{n}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}1}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}
    \PYG{n}{fig1} \PYG{o}{=} \PYG{n}{snn}\PYG{o}{.}\PYG{n}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{fig1}\PYG{o}{.}\PYG{n}{number}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pattern 1 Response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running simulation for pattern 2...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{snn}\PYG{o}{.}\PYG{n}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}2}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}
    \PYG{n}{fig2} \PYG{o}{=} \PYG{n}{snn}\PYG{o}{.}\PYG{n}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{fig2}\PYG{o}{.}\PYG{n}{number}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pattern 2 Response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{SNN demo completed}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}


\section{16.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part5/ch16_future_directions:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience and AI will continue to inform each other} in a virtuous cycle, with brain principles inspiring new AI architectures and AI helping to unravel neural mechanisms.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}inspired computing may lead to more efficient AI} through approaches like neuromorphic hardware, which can achieve orders of magnitude improvements in energy efficiency.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Continual learning remains a key challenge} where biological solutions like memory consolidation, synaptic stabilization, and neuromodulation offer valuable inspiration.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Whole\sphinxhyphen{}brain integration} approaches that combine specialized systems may be crucial for achieving more general artificial intelligence with human\sphinxhyphen{}like flexibility.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Ethical considerations should guide development} of neuro\sphinxhyphen{}AI technologies, with frameworks for neural privacy, responsible innovation, and potential consciousness in advanced systems.

\end{itemize}


\section{16.8 Further Reading \& Media}
\label{\detokenize{part5/ch16_future_directions:further-reading-media}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Davies, M., et al. (2018). \sphinxhref{https://ieeexplore.ieee.org/document/8259423}{Loihi: A Neuromorphic Manycore Processor with On\sphinxhyphen{}Chip Learning}. IEEE Micro, 38(1), 82\sphinxhyphen{}99. This paper describes Intel’s neuromorphic chip architecture and its advantages for brain\sphinxhyphen{}inspired computing.

\item {} 
\sphinxAtStartPar
Kirkpatrick, J., et al. (2017). \sphinxhref{https://www.pnas.org/content/114/13/3521}{Overcoming catastrophic forgetting in neural networks}. Proceedings of the National Academy of Sciences, 114(13), 3521\sphinxhyphen{}3526. Introduces Elastic Weight Consolidation, a technique inspired by synaptic consolidation.

\item {} 
\sphinxAtStartPar
Richards, B.A., et al. (2019). \sphinxhref{https://www.nature.com/articles/s41593-019-0520-2}{A deep learning framework for neuroscience}. Nature Neuroscience, 22(11), 1761\sphinxhyphen{}1770. Explores how deep learning can advance neuroscientific understanding.

\item {} 
\sphinxAtStartPar
Dehaene, S., Lau, H., \& Kouider, S. (2017). \sphinxhref{https://science.sciencemag.org/content/358/6362/486}{What is consciousness, and could machines have it?}. Science, 358(6362), 486\sphinxhyphen{}492. Discusses theories of consciousness and their implications for AI.

\item {} 
\sphinxAtStartPar
Ienca, M., \& Andorno, R. (2017). \sphinxhref{https://lsspjournal.biomedcentral.com/articles/10.1186/s40504-017-0050-1}{Towards new human rights in the age of neuroscience and neurotechnology}. Life Sciences, Society and Policy, 13(1), 5. Proposes a framework for “neurorights” in the context of advancing neurotechnology.

\item {} 
\sphinxAtStartPar
Hassabis, D., Kumaran, D., Summerfield, C., \& Botvinick, M. (2017). \sphinxhref{https://www.cell.com/neuron/fulltext/S0896-6273(17)30509-3}{Neuroscience\sphinxhyphen{}Inspired Artificial Intelligence}. Neuron, 95(2), 245\sphinxhyphen{}258. A comprehensive overview of the interdisciplinary connections between neuroscience and AI.

\end{itemize}

\sphinxstepscope


\part{Part VI · Advanced Applications}

\sphinxstepscope


\chapter{Brain\sphinxhyphen{}Computer Interfaces and Human\sphinxhyphen{}AI Interaction}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:brain-computer-interfaces-and-human-ai-interaction}}\label{\detokenize{part6/ch17_bci_human_ai_interfaces::doc}}

\section{Chapter Goals}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:chapter-goals}}
\sphinxAtStartPar
After completing this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the fundamental principles of brain\sphinxhyphen{}computer interfaces and their role in human\sphinxhyphen{}AI interaction

\item {} 
\sphinxAtStartPar
Explain the neurophysiological basis for various BCI approaches

\item {} 
\sphinxAtStartPar
Compare invasive, semi\sphinxhyphen{}invasive, and non\sphinxhyphen{}invasive BCI methodologies

\item {} 
\sphinxAtStartPar
Implement basic algorithms for neural signal processing and decoding

\item {} 
\sphinxAtStartPar
Describe how AI enhances BCI performance and capabilities

\item {} 
\sphinxAtStartPar
Design interactive systems that integrate BCIs with AI assistants

\item {} 
\sphinxAtStartPar
Evaluate ethical considerations and future directions in BCI development

\end{itemize}


\section{17.1 Introduction: Connecting Brains and Machines}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:introduction-connecting-brains-and-machines}}
\sphinxAtStartPar
Brain\sphinxhyphen{}Computer Interfaces represent one of the most direct applications of neuroscience to technology, creating communication pathways between neural activity and external devices. These systems measure brain activity, interpret neural signals, and translate them into commands that can control computers, prosthetics, or other devices.

\sphinxAtStartPar
In recent years, BCIs have evolved from relatively simple systems to sophisticated neural interfaces enhanced by artificial intelligence. This evolution has transformed BCIs from specialized medical tools to potentially mainstream technologies that could fundamentally alter human\sphinxhyphen{}computer interaction.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Conceptual overview of a BCI system}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BrainComputerInterface}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{acquisition\PYGZus{}method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{EEG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize a BCI system with the specified neural acquisition method}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        acquisition\PYGZus{}method : str}
\PYG{l+s+sd}{            Method used to record brain activity}
\PYG{l+s+sd}{            Options: \PYGZdq{}EEG\PYGZdq{}, \PYGZdq{}ECoG\PYGZdq{}, \PYGZdq{}LFP\PYGZdq{}, \PYGZdq{}fNIRS\PYGZdq{}, \PYGZdq{}MEG\PYGZdq{}, \PYGZdq{}Spikes\PYGZdq{}}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{acquisition\PYGZus{}method} \PYG{o}{=} \PYG{n}{acquisition\PYGZus{}method}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{preprocessing\PYGZus{}pipeline} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feature\PYGZus{}extraction} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}device} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback\PYGZus{}mechanism} \PYG{o}{=} \PYG{k+kc}{None}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add\PYGZus{}preprocessing\PYGZus{}step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{step}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add a preprocessing step to the pipeline\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{preprocessing\PYGZus{}pipeline}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{step}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{set\PYGZus{}feature\PYGZus{}extractor}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{extractor}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Set the feature extraction method\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feature\PYGZus{}extraction} \PYG{o}{=} \PYG{n}{extractor}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{set\PYGZus{}decoder}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{decoder}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Set the decoding algorithm\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{n}{decoder}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{set\PYGZus{}output\PYGZus{}device}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{device}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Set the output device controlled by the BCI\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}device} \PYG{o}{=} \PYG{n}{device}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{set\PYGZus{}feedback\PYGZus{}mechanism}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{feedback}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Set the feedback mechanism for the user\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback\PYGZus{}mechanism} \PYG{o}{=} \PYG{n}{feedback}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Process incoming neural data through the BCI pipeline\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Preprocessing}
        \PYG{n}{processed\PYGZus{}data} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data}
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{preprocessing\PYGZus{}pipeline}\PYG{p}{:}
            \PYG{n}{processed\PYGZus{}data} \PYG{o}{=} \PYG{n}{step}\PYG{p}{(}\PYG{n}{processed\PYGZus{}data}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Feature extraction}
        \PYG{n}{features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feature\PYGZus{}extraction}\PYG{p}{(}\PYG{n}{processed\PYGZus{}data}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decoding}
        \PYG{n}{commands} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Send to output device}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}device}\PYG{p}{(}\PYG{n}{commands}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Provide feedback to user}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback\PYGZus{}mechanism}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
\end{sphinxVerbatim}


\section{17.2 Neurophysiological Bases for BCIs}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:neurophysiological-bases-for-bcis}}

\subsection{17.2.1 Relevant Brain Systems for Interface}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:relevant-brain-systems-for-interface}}
\sphinxAtStartPar
Brain\sphinxhyphen{}computer interfaces target various neural systems, depending on the intended application:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Motor systems}: The primary and supplementary motor cortices generate signals related to movement planning and execution.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory systems}: Visual, auditory, and somatosensory cortices process incoming sensory information.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Linguistic systems}: Broca’s and Wernicke’s areas in the left hemisphere (for most people) process language.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Attention networks}: Fronto\sphinxhyphen{}parietal networks modulate attentional resources.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Emotional processing}: The limbic system, including the amygdala and anterior cingulate cortex, processes emotional content.

\end{itemize}


\subsection{17.2.2 Neural Signal Types}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:neural-signal-types}}
\sphinxAtStartPar
BCIs decode different types of neural signals:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Action potentials (spikes)}: Individual neuronal firing patterns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local Field Potentials (LFPs)}: Aggregate electrical activity from local neural populations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Electrocorticography (ECoG)}: Electrical activity recorded from the cortical surface

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Electroencephalography (EEG)}: Electrical activity recorded from the scalp

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Functional Near\sphinxhyphen{}Infrared Spectroscopy (fNIRS)}: Hemodynamic responses

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Magnetoencephalography (MEG)}: Magnetic fields generated by neural activity

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}neural\PYGZus{}signals}\PYG{p}{(}\PYG{n}{signal\PYGZus{}type}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate different types of neural signals}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    signal\PYGZus{}type : str}
\PYG{l+s+sd}{        Type of neural signal to simulate}
\PYG{l+s+sd}{        Options: \PYGZdq{}Spikes\PYGZdq{}, \PYGZdq{}LFP\PYGZdq{}, \PYGZdq{}ECoG\PYGZdq{}, \PYGZdq{}EEG\PYGZdq{}, \PYGZdq{}fNIRS\PYGZdq{}}
\PYG{l+s+sd}{    duration : float}
\PYG{l+s+sd}{        Duration of the signal in seconds}
\PYG{l+s+sd}{    sampling\PYGZus{}rate : int}
\PYG{l+s+sd}{        Sampling rate in Hz}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    times : numpy.ndarray}
\PYG{l+s+sd}{        Time points}
\PYG{l+s+sd}{    signal\PYGZus{}data : numpy.ndarray}
\PYG{l+s+sd}{        Simulated neural signal}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{times} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{times}\PYG{p}{)}
    \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{signal\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spikes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate Poisson spike train}
        \PYG{n}{firing\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} Hz}
        \PYG{n}{spike\PYGZus{}prob} \PYG{o}{=} \PYG{n}{firing\PYGZus{}rate} \PYG{o}{/} \PYG{n}{sampling\PYGZus{}rate}
        \PYG{n}{spikes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{spike\PYGZus{}prob}
        \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{spikes}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}
        
    \PYG{k}{elif} \PYG{n}{signal\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LFP}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate LFP with theta and gamma components}
        \PYG{n}{theta} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{6} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 6 Hz theta}
        \PYG{n}{gamma} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{40} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 40 Hz gamma}
        \PYG{n}{noise} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{theta} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{+} \PYG{n}{noise}
        
    \PYG{k}{elif} \PYG{n}{signal\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ECoG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate ECoG with multiple frequency components}
        \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz alpha}
        \PYG{n}{beta} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 20 Hz beta}
        \PYG{n}{gamma} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{50} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 50 Hz gamma}
        \PYG{n}{noise} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{alpha} \PYG{o}{+} \PYG{n}{beta} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{+} \PYG{n}{noise}
        
    \PYG{k}{elif} \PYG{n}{signal\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{EEG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate EEG with alpha oscillations}
        \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz alpha}
        \PYG{n}{noise} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{alpha} \PYG{o}{+} \PYG{n}{noise}
        
    \PYG{k}{elif} \PYG{n}{signal\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{fNIRS}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate hemodynamic response}
        \PYG{c+c1}{\PYGZsh{} Create a canonical hemodynamic response function (HRF)}
        \PYG{n}{hrf} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        \PYG{n}{stim\PYGZus{}onset} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Stimulus at 100ms}
        \PYG{n}{hrf\PYGZus{}model} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{times}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{500}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{l+m+mf}{0.05}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.4} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{times}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{500}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{/} \PYG{l+m+mf}{0.1}\PYG{p}{)}
        \PYG{n}{hrf}\PYG{p}{[}\PYG{n}{stim\PYGZus{}onset}\PYG{p}{:}\PYG{n}{stim\PYGZus{}onset}\PYG{o}{+}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{hrf\PYGZus{}model}\PYG{p}{)}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{hrf\PYGZus{}model}
        \PYG{n}{signal\PYGZus{}data} \PYG{o}{=} \PYG{n}{hrf} \PYG{o}{+} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{times}\PYG{p}{,} \PYG{n}{signal\PYGZus{}data}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}neural\PYGZus{}signals}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot examples of different neural signal types\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{signal\PYGZus{}types} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Spikes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LFP}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ECoG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{EEG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{fNIRS}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{signal\PYGZus{}types}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{sig\PYGZus{}type} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{signal\PYGZus{}types}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{times}\PYG{p}{,} \PYG{n}{data} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}neural\PYGZus{}signals}\PYG{p}{(}\PYG{n}{sig\PYGZus{}type}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{times}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sig\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ Signal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time (s)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{17.3 BCI Technologies and Approaches}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:bci-technologies-and-approaches}}

\subsection{17.3.1 Invasive BCIs}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:invasive-bcis}}
\sphinxAtStartPar
Invasive BCIs involve surgical implantation of recording devices directly into or onto the brain tissue. These systems provide high temporal and spatial resolution but carry surgical risks.

\sphinxAtStartPar
Key invasive BCI approaches include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Microelectrode Arrays}: Arrays of tiny electrodes that record from individual neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{ECoG Grids}: Flexible electrode arrays placed on the cortical surface

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stentrodes}: Electrodes delivered via blood vessels

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Clinical Applications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Motor restoration for paralysis

\item {} 
\sphinxAtStartPar
Communication for locked\sphinxhyphen{}in syndrome

\item {} 
\sphinxAtStartPar
Sensory restoration (e.g., visual or auditory prostheses)

\end{itemize}


\subsection{17.3.2 Non\sphinxhyphen{}invasive BCIs}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:non-invasive-bcis}}
\sphinxAtStartPar
Non\sphinxhyphen{}invasive BCIs record brain activity without requiring surgery. While safer, they typically have lower spatial resolution and signal\sphinxhyphen{}to\sphinxhyphen{}noise ratio.

\sphinxAtStartPar
Key non\sphinxhyphen{}invasive BCI approaches include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{EEG\sphinxhyphen{}based BCIs}: Record electrical activity from the scalp

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{fNIRS BCIs}: Measure blood oxygenation changes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{MEG\sphinxhyphen{}based BCIs}: Detect magnetic fields generated by neural activity

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Applications}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Assistive technology for disabilities

\item {} 
\sphinxAtStartPar
Neurorehabilitation

\item {} 
\sphinxAtStartPar
Cognitive enhancement

\item {} 
\sphinxAtStartPar
Gaming and entertainment

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{discriminant\PYGZus{}analysis}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearDiscriminantAnalysis}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{EEG\PYGZus{}BCI}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A basic EEG\PYGZhy{}based Brain\PYGZhy{}Computer Interface using motor imagery}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    This class implements a simple BCI that can classify imagined movements}
\PYG{l+s+sd}{    from EEG signals using common spatial patterns (CSP) and LDA}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{250}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the EEG\PYGZhy{}BCI system}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}channels : int}
\PYG{l+s+sd}{            Number of EEG channels}
\PYG{l+s+sd}{        sampling\PYGZus{}rate : int}
\PYG{l+s+sd}{            Sampling rate in Hz}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{n}{n\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate} \PYG{o}{=} \PYG{n}{sampling\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaler} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classifier} \PYG{o}{=} \PYG{n}{LinearDiscriminantAnalysis}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{csp\PYGZus{}filters} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components} \PYG{o}{=} \PYG{l+m+mi}{4}  \PYG{c+c1}{\PYGZsh{} Number of CSP components to use}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}apply\PYGZus{}bandpass\PYGZus{}filter}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{low\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{high\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply a bandpass filter to the EEG data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        data : numpy.ndarray}
\PYG{l+s+sd}{            EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{        low\PYGZus{}freq : float}
\PYG{l+s+sd}{            Lower cutoff frequency}
\PYG{l+s+sd}{        high\PYGZus{}freq : float}
\PYG{l+s+sd}{            Upper cutoff frequency}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        filtered\PYGZus{}data : numpy.ndarray}
\PYG{l+s+sd}{            Filtered EEG data}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{signal}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{butter}\PYG{p}{,} \PYG{n}{filtfilt}
        
        \PYG{n}{nyquist} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate}
        \PYG{n}{low} \PYG{o}{=} \PYG{n}{low\PYGZus{}freq} \PYG{o}{/} \PYG{n}{nyquist}
        \PYG{n}{high} \PYG{o}{=} \PYG{n}{high\PYGZus{}freq} \PYG{o}{/} \PYG{n}{nyquist}
        
        \PYG{n}{b}\PYG{p}{,} \PYG{n}{a} \PYG{o}{=} \PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{p}{[}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{]}\PYG{p}{,} \PYG{n}{btype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}
        \PYG{n}{filtered\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{trial} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{channel} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{filtered\PYGZus{}data}\PYG{p}{[}\PYG{n}{trial}\PYG{p}{,} \PYG{n}{channel}\PYG{p}{]} \PYG{o}{=} \PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{data}\PYG{p}{[}\PYG{n}{trial}\PYG{p}{,} \PYG{n}{channel}\PYG{p}{]}\PYG{p}{)}
                
        \PYG{k}{return} \PYG{n}{filtered\PYGZus{}data}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}compute\PYGZus{}csp\PYGZus{}filters}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute Common Spatial Pattern filters}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{        y\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training labels}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        W : numpy.ndarray}
\PYG{l+s+sd}{            CSP projection matrix}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Class covariance matrices}
        \PYG{n}{cov\PYGZus{}matrices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Assuming binary classification}
            \PYG{n}{class\PYGZus{}trials} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{y\PYGZus{}train} \PYG{o}{==} \PYG{n}{c}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Compute trial covariance matrices}
            \PYG{k}{for} \PYG{n}{trial} \PYG{o+ow}{in} \PYG{n}{class\PYGZus{}trials}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Normalize by trace to account for scale differences}
                \PYG{n}{trial\PYGZus{}cov} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cov}\PYG{p}{(}\PYG{n}{trial}\PYG{p}{)}
                \PYG{n}{trial\PYGZus{}cov} \PYG{o}{=} \PYG{n}{trial\PYGZus{}cov} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{trace}\PYG{p}{(}\PYG{n}{trial\PYGZus{}cov}\PYG{p}{)}
                \PYG{n}{cov\PYGZus{}matrices}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{trial\PYGZus{}cov}
                
            \PYG{n}{cov\PYGZus{}matrices}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{class\PYGZus{}trials}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Solve the generalized eigenvalue problem}
        \PYG{n}{evals}\PYG{p}{,} \PYG{n}{evecs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{inv}\PYG{p}{(}\PYG{n}{cov\PYGZus{}matrices}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{o}{@} \PYG{n}{cov\PYGZus{}matrices}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Sort by eigenvalues in descending order}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{evals}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{evals} \PYG{o}{=} \PYG{n}{evals}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
        \PYG{n}{evecs} \PYG{o}{=} \PYG{n}{evecs}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Select projection matrix W}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{csp\PYGZus{}filters} \PYG{o}{=} \PYG{n}{evecs}
        
        \PYG{k}{return} \PYG{n}{evecs}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}apply\PYGZus{}csp}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply CSP transformation to the data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        data : numpy.ndarray}
\PYG{l+s+sd}{            EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        features : numpy.ndarray}
\PYG{l+s+sd}{            CSP features}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Project data onto CSP filters}
            \PYG{n}{projected} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{csp\PYGZus{}filters}\PYG{o}{.}\PYG{n}{T} \PYG{o}{@} \PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Compute log\PYGZhy{}variance of selected components}
            \PYG{n}{selected\PYGZus{}components} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{[}
                \PYG{n}{projected}\PYG{p}{[}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{]}\PYG{p}{,} 
                \PYG{n}{projected}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{:}\PYG{p}{]}
            \PYG{p}{]}\PYG{p}{)}
            
            \PYG{n}{variances} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{var}\PYG{p}{(}\PYG{n}{selected\PYGZus{}components}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{variances}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{features}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the BCI system}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{        y\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training labels}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Apply bandpass filter}
        \PYG{n}{X\PYGZus{}filtered} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}apply\PYGZus{}bandpass\PYGZus{}filter}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute CSP filters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}compute\PYGZus{}csp\PYGZus{}filters}\PYG{p}{(}\PYG{n}{X\PYGZus{}filtered}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Extract features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}apply\PYGZus{}csp}\PYG{p}{(}\PYG{n}{X\PYGZus{}filtered}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scale features}
        \PYG{n}{scaled\PYGZus{}features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Train classifier}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classifier}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}features}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict classes for new data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}test : numpy.ndarray}
\PYG{l+s+sd}{            Test data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        y\PYGZus{}pred : numpy.ndarray}
\PYG{l+s+sd}{            Predicted labels}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Apply bandpass filter}
        \PYG{n}{X\PYGZus{}filtered} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}apply\PYGZus{}bandpass\PYGZus{}filter}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Extract features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}apply\PYGZus{}csp}\PYG{p}{(}\PYG{n}{X\PYGZus{}filtered}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scale features}
        \PYG{n}{scaled\PYGZus{}features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scaler}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{features}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Predict}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classifier}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}features}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{17.3.3 Neural Decoding Approaches}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:neural-decoding-approaches}}
\sphinxAtStartPar
Neural decoding is the process of translating brain activity patterns into meaningful control signals. Modern BCIs employ diverse decoding approaches:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Classification\sphinxhyphen{}based}: Identify discrete mental states or commands

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Regression\sphinxhyphen{}based}: Estimate continuous parameters (e.g., limb position)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Deep learning}: Extract hierarchical features from neural data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dynamical systems}: Model temporal evolution of neural states

\end{itemize}


\section{17.4 AI\sphinxhyphen{}Enhanced BCIs}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:ai-enhanced-bcis}}

\subsection{17.4.1 Machine Learning for Neural Decoding}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:machine-learning-for-neural-decoding}}
\sphinxAtStartPar
AI methods have dramatically improved BCI performance by enhancing neural decoding:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptive decoders}: ML systems that learn from user behavior

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Transfer learning}: Leverage knowledge across sessions and users

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}supervised learning}: Utilize unlabeled neural data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reinforcement learning}: Optimize decoding through trial and error

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{n+nn}{.}\PYG{n+nn}{models}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Sequential}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{n+nn}{.}\PYG{n+nn}{layers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Dense}\PYG{p}{,} \PYG{n}{Dropout}\PYG{p}{,} \PYG{n}{Conv2D}\PYG{p}{,} \PYG{n}{MaxPooling2D}\PYG{p}{,} \PYG{n}{Flatten}\PYG{p}{,} \PYG{n}{LSTM}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{n+nn}{.}\PYG{n+nn}{optimizers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Adam}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{DeepBCI}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Deep learning\PYGZhy{}based BCI decoder for EEG signals}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{time\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{250}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{model\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CNN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the deep BCI decoder}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}channels : int}
\PYG{l+s+sd}{            Number of EEG channels}
\PYG{l+s+sd}{        time\PYGZus{}steps : int}
\PYG{l+s+sd}{            Number of time steps in each trial}
\PYG{l+s+sd}{        n\PYGZus{}classes : int}
\PYG{l+s+sd}{            Number of output classes}
\PYG{l+s+sd}{        model\PYGZus{}type : str}
\PYG{l+s+sd}{            Type of deep learning model to use (\PYGZsq{}CNN\PYGZsq{}, \PYGZsq{}LSTM\PYGZsq{}, or \PYGZsq{}Hybrid\PYGZsq{})}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{n}{n\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps} \PYG{o}{=} \PYG{n}{time\PYGZus{}steps}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}classes} \PYG{o}{=} \PYG{n}{n\PYGZus{}classes}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model\PYGZus{}type} \PYG{o}{=} \PYG{n}{model\PYGZus{}type}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}build\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}build\PYGZus{}model}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Build the deep learning model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        model : tf.keras.Model}
\PYG{l+s+sd}{            The compiled deep learning model}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CNN}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
                \PYG{c+c1}{\PYGZsh{} Reshape input to add channel dimension: (channels, time\PYGZus{}steps) \PYGZhy{}\PYGZgt{} (channels, time\PYGZus{}steps, 1)}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Reshape}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} 
                                        \PYG{n}{input\PYGZus{}shape}\PYG{o}{=}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} First convolutional block}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Second convolutional block}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Flatten and dense layers}
                \PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dense}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}classes}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{softmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{p}{]}\PYG{p}{)}
            
        \PYG{k}{elif} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LSTM}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
                \PYG{c+c1}{\PYGZsh{} Reshape input: (channels, time\PYGZus{}steps) \PYGZhy{}\PYGZgt{} (time\PYGZus{}steps, channels)}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Permute}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{input\PYGZus{}shape}\PYG{o}{=}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} LSTM layers}
                \PYG{n}{LSTM}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{LSTM}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Output layer}
                \PYG{n}{Dense}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}classes}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{softmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{p}{]}\PYG{p}{)}
            
        \PYG{k}{elif} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hybrid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{model} \PYG{o}{=} \PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
                \PYG{c+c1}{\PYGZsh{} Reshape input to add channel dimension: (channels, time\PYGZus{}steps) \PYGZhy{}\PYGZgt{} (channels, time\PYGZus{}steps, 1)}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Reshape}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} 
                                        \PYG{n}{input\PYGZus{}shape}\PYG{o}{=}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{time\PYGZus{}steps}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Convolutional layers}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Reshape for LSTM: (channels/4, time\PYGZus{}steps/4, 64) \PYGZhy{}\PYGZgt{} (channels/4, time\PYGZus{}steps/4 * 64)}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Reshape}\PYG{p}{(}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{backend}\PYG{o}{.}\PYG{n}{int\PYGZus{}shape}\PYG{p}{(}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{*} 
                                        \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{backend}\PYG{o}{.}\PYG{n}{int\PYGZus{}shape}\PYG{p}{(}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} LSTM layer}
                \PYG{n}{LSTM}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
                
                \PYG{c+c1}{\PYGZsh{} Output layer}
                \PYG{n}{Dense}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}classes}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{softmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compile the model}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{compile}\PYG{p}{(}
            \PYG{n}{optimizer}\PYG{o}{=}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{loss}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{categorical\PYGZus{}crossentropy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
            \PYG{n}{metrics}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{model}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{validation\PYGZus{}data}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the deep BCI model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training data of shape (n\PYGZus{}trials, n\PYGZus{}channels, time\PYGZus{}steps)}
\PYG{l+s+sd}{        y\PYGZus{}train : numpy.ndarray}
\PYG{l+s+sd}{            Training labels (one\PYGZhy{}hot encoded)}
\PYG{l+s+sd}{        batch\PYGZus{}size : int}
\PYG{l+s+sd}{            Batch size for training}
\PYG{l+s+sd}{        epochs : int}
\PYG{l+s+sd}{            Number of training epochs}
\PYG{l+s+sd}{        validation\PYGZus{}data : tuple}
\PYG{l+s+sd}{            (X\PYGZus{}val, y\PYGZus{}val) for validation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        history : tf.keras.callbacks.History}
\PYG{l+s+sd}{            Training history}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}
            \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,}
            \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,}
            \PYG{n}{epochs}\PYG{o}{=}\PYG{n}{epochs}\PYG{p}{,}
            \PYG{n}{validation\PYGZus{}data}\PYG{o}{=}\PYG{n}{validation\PYGZus{}data}\PYG{p}{,}
            \PYG{n}{callbacks}\PYG{o}{=}\PYG{p}{[}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{callbacks}\PYG{o}{.}\PYG{n}{EarlyStopping}\PYG{p}{(}\PYG{n}{monitor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val\PYGZus{}loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{patience}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{restore\PYGZus{}best\PYGZus{}weights}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{callbacks}\PYG{o}{.}\PYG{n}{ReduceLROnPlateau}\PYG{p}{(}\PYG{n}{monitor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val\PYGZus{}loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{factor}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{patience}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
            \PYG{p}{]}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict classes for new data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X : numpy.ndarray}
\PYG{l+s+sd}{            EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, time\PYGZus{}steps)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        y\PYGZus{}pred : numpy.ndarray}
\PYG{l+s+sd}{            Predicted class probabilities}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}classes}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict class labels for new data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X : numpy.ndarray}
\PYG{l+s+sd}{            EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, time\PYGZus{}steps)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        y\PYGZus{}pred : numpy.ndarray}
\PYG{l+s+sd}{            Predicted class labels}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{probs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{probs}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{17.4.2 Adaptive and Learning Systems}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:adaptive-and-learning-systems}}
\sphinxAtStartPar
Modern BCIs employ co\sphinxhyphen{}adaptation, where both the user and the system learn to optimize performance:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error\sphinxhyphen{}related potentials}: Leverage error signals for adaptive decoding

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Online learning}: Continuous adaptation during use

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Active inference}: BCIs that model user intentions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hybrid BCI\sphinxhyphen{}AI systems}: Combine neural signals with contextual AI

\end{itemize}


\subsection{17.4.3 Neural Feedback and Closed\sphinxhyphen{}Loop Systems}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:neural-feedback-and-closed-loop-systems}}
\sphinxAtStartPar
Closed\sphinxhyphen{}loop BCIs provide real\sphinxhyphen{}time feedback to users, enabling neural adaptation:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neurofeedback}: Visual, auditory, or haptic feedback of neural states

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stimulation\sphinxhyphen{}based BCIs}: Systems that both record and stimulate

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Shared control}: Collaborative control between user and AI

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory augmentation}: Providing novel sensory inputs

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{time}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ClosedLoopBCI}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Closed\PYGZhy{}loop BCI system with neurofeedback}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{sampling\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{buffer\PYGZus{}duration}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the closed\PYGZhy{}loop BCI}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}channels : int}
\PYG{l+s+sd}{            Number of EEG channels}
\PYG{l+s+sd}{        sampling\PYGZus{}rate : int}
\PYG{l+s+sd}{            Sampling rate in Hz}
\PYG{l+s+sd}{        buffer\PYGZus{}duration : float}
\PYG{l+s+sd}{            Duration of the signal buffer in seconds}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{n}{n\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate} \PYG{o}{=} \PYG{n}{sampling\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{buffer\PYGZus{}duration} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Signal processing parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{band\PYGZus{}filters} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{beta}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{13}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gamma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Feedback parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}band} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}channels} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} e.g., O1 and O2 for alpha training}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{baseline\PYGZus{}power} \PYG{o}{=} \PYG{k+kc}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback\PYGZus{}scale} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}buffer}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{new\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update the signal buffer with new data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        new\PYGZus{}data : numpy.ndarray}
\PYG{l+s+sd}{            New EEG data of shape (n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{new\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{k}{if} \PYG{n}{n\PYGZus{}samples} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} If new data exceeds buffer size, just take the most recent samples}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{new\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size}\PYG{p}{:}\PYG{p}{]}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Shift buffer and add new data}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{hstack}\PYG{p}{(}\PYG{p}{[}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{new\PYGZus{}data}
            \PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}bandpass}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{band}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply bandpass filter to the signal buffer}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        band : str}
\PYG{l+s+sd}{            Frequency band (\PYGZsq{}theta\PYGZsq{}, \PYGZsq{}alpha\PYGZsq{}, \PYGZsq{}beta\PYGZsq{}, or \PYGZsq{}gamma\PYGZsq{})}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        filtered : numpy.ndarray}
\PYG{l+s+sd}{            Filtered signal}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{low\PYGZus{}freq}\PYG{p}{,} \PYG{n}{high\PYGZus{}freq} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{band\PYGZus{}filters}\PYG{p}{[}\PYG{n}{band}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Design filter}
        \PYG{n}{nyquist} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate}
        \PYG{n}{low} \PYG{o}{=} \PYG{n}{low\PYGZus{}freq} \PYG{o}{/} \PYG{n}{nyquist}
        \PYG{n}{high} \PYG{o}{=} \PYG{n}{high\PYGZus{}freq} \PYG{o}{/} \PYG{n}{nyquist}
        \PYG{n}{b}\PYG{p}{,} \PYG{n}{a} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{p}{[}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{]}\PYG{p}{,} \PYG{n}{btype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply filter to each channel}
        \PYG{n}{filtered} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{filtered}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{signal\PYGZus{}buffer}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            
        \PYG{k}{return} \PYG{n}{filtered}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}band\PYGZus{}power}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{band}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute power in a specific frequency band}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        band : str}
\PYG{l+s+sd}{            Frequency band (\PYGZsq{}theta\PYGZsq{}, \PYGZsq{}alpha\PYGZsq{}, \PYGZsq{}beta\PYGZsq{}, or \PYGZsq{}gamma\PYGZsq{})}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        powers : numpy.ndarray}
\PYG{l+s+sd}{            Band power for each channel}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{filtered} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{apply\PYGZus{}bandpass}\PYG{p}{(}\PYG{n}{band}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute power (variance of filtered signal)}
        \PYG{n}{powers} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{var}\PYG{p}{(}\PYG{n}{filtered}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{powers}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calibrate\PYGZus{}baseline}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{60.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Calibrate baseline band power over a period}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        duration : float}
\PYG{l+s+sd}{            Duration of calibration in seconds}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Starting baseline calibration for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{duration}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ seconds...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size}\PYG{p}{)}
        
        \PYG{n}{baseline\PYGZus{}powers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} This would normally get data from the EEG device}
            \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}ll simulate it}
            \PYG{n}{new\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{10}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}buffer}\PYG{p}{(}\PYG{n}{new\PYGZus{}data}\PYG{p}{)}
            
            \PYG{n}{powers} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{compute\PYGZus{}band\PYGZus{}power}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}band}\PYG{p}{)}
            \PYG{n}{baseline\PYGZus{}powers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{powers}\PYG{p}{)}
            
            \PYG{n}{time}\PYG{o}{.}\PYG{n}{sleep}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sampling\PYGZus{}rate}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{baseline\PYGZus{}power} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{baseline\PYGZus{}powers}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Baseline calibration complete!}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}feedback}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute feedback based on current brain activity}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        feedback : float}
\PYG{l+s+sd}{            Feedback value (positive values indicate above baseline)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get current band power}
        \PYG{n}{current\PYGZus{}power} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{compute\PYGZus{}band\PYGZus{}power}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}band}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute relative change from baseline for target channels}
        \PYG{n}{target\PYGZus{}channels\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}channels}\PYG{p}{)}
        \PYG{n}{relative\PYGZus{}power} \PYG{o}{=} \PYG{p}{(}\PYG{n}{current\PYGZus{}power}\PYG{p}{[}\PYG{n}{target\PYGZus{}channels\PYGZus{}idx}\PYG{p}{]} \PYG{o}{/} 
                          \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{baseline\PYGZus{}power}\PYG{p}{[}\PYG{n}{target\PYGZus{}channels\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
        
        \PYG{c+c1}{\PYGZsh{} Average across target channels}
        \PYG{n}{feedback} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{relative\PYGZus{}power}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback\PYGZus{}scale}
        
        \PYG{k}{return} \PYG{n}{feedback}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}neurofeedback\PYGZus{}session}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{300}\PYG{p}{,} \PYG{n}{feedback\PYGZus{}func}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run a neurofeedback session}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        duration : float}
\PYG{l+s+sd}{            Duration of the session in seconds}
\PYG{l+s+sd}{        feedback\PYGZus{}func : callable}
\PYG{l+s+sd}{            Function to call with feedback value to provide feedback}
\PYG{l+s+sd}{            If None, will print feedback value}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{baseline\PYGZus{}power} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Baseline not calibrated. Running calibration...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{calibrate\PYGZus{}baseline}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Starting neurofeedback session for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{duration}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ seconds...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Target band: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}band}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{n}{session\PYGZus{}start} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{feedback\PYGZus{}values} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{while} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{session\PYGZus{}start} \PYG{o}{\PYGZlt{}} \PYG{n}{duration}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} This would normally get data from the EEG device}
            \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}ll simulate it with random data}
            \PYG{n}{new\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer\PYGZus{}size} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{10}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}buffer}\PYG{p}{(}\PYG{n}{new\PYGZus{}data}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute feedback}
            \PYG{n}{feedback} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{compute\PYGZus{}feedback}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{feedback\PYGZus{}values}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{feedback}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Provide feedback}
            \PYG{k}{if} \PYG{n}{feedback\PYGZus{}func} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{feedback\PYGZus{}func}\PYG{p}{(}\PYG{n}{feedback}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Simple text\PYGZhy{}based feedback}
                \PYG{n}{bar\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{30}
                \PYG{n}{bar\PYGZus{}position} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{p}{(}\PYG{n}{feedback} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{bar\PYGZus{}length} \PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{)}
                \PYG{n}{bar} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{*}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{*} \PYG{n}{bar\PYGZus{}position} \PYG{o}{+} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{*} \PYG{p}{(}\PYG{n}{bar\PYGZus{}length} \PYG{o}{\PYGZhy{}} \PYG{n}{bar\PYGZus{}position}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}r}\PYG{l+s+s2}{Feedback: [}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{bar}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{] }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{feedback}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
            \PYG{n}{time}\PYG{o}{.}\PYG{n}{sleep}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{)}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Neurofeedback session complete!}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{feedback\PYGZus{}values}\PYG{p}{)}
\end{sphinxVerbatim}


\section{17.5 Human\sphinxhyphen{}AI Interaction via Neural Interfaces}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:human-ai-interaction-via-neural-interfaces}}

\subsection{17.5.1 BCI as a Communication Channel}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:bci-as-a-communication-channel}}
\sphinxAtStartPar
BCIs offer unique interaction modalities between humans and AI systems:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Direct intention transfer}: Communicate intentions without physical action

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mental command interfaces}: Control AI assistants through thought

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Emotional and cognitive state monitoring}: AI adaptation to user state

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Shared representations}: Neural\sphinxhyphen{}symbolic interfaces between humans and AI

\end{itemize}


\subsection{17.5.2 Neural Interfaces for AI Agents}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:neural-interfaces-for-ai-agents}}
\sphinxAtStartPar
Neural interfaces enable novel forms of human\sphinxhyphen{}AI collaboration:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BCI\sphinxhyphen{}integrated virtual assistants}: AI agents controlled via neural signals

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Embodied AI with neural interfaces}: Controlling robots through thought

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Collaborative problem\sphinxhyphen{}solving}: AI systems that augment human cognition

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural interfaces for skill acquisition}: AI\sphinxhyphen{}guided learning via BCI feedback

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{time}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{enum}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Enum}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CommandType}\PYG{p}{(}\PYG{n}{Enum}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{NAVIGATE} \PYG{o}{=} \PYG{l+m+mi}{0}
    \PYG{n}{SELECT} \PYG{o}{=} \PYG{l+m+mi}{1}
    \PYG{n}{CONFIRM} \PYG{o}{=} \PYG{l+m+mi}{2}
    \PYG{n}{CANCEL} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{n}{HELP} \PYG{o}{=} \PYG{l+m+mi}{4}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuroAIAssistant}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    An AI assistant that interfaces with users through a BCI}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{bci}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the NeuroAI Assistant}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        bci : BrainComputerInterface}
\PYG{l+s+sd}{            The BCI system to use for neural input}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bci} \PYG{o}{=} \PYG{n}{bci}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{command\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{context} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{available\PYGZus{}commands} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{NAVIGATE}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{up}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{down}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{left}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{SELECT}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{CONFIRM}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{yes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{CANCEL}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{no}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{HELP}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{help}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{main\PYGZus{}menu}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}transitions} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{main\PYGZus{}menu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{option3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{help}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{help\PYGZus{}menu}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{yes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature1\PYGZus{}action}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{no}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{main\PYGZus{}menu}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{c+c1}{\PYGZsh{} ... more state transitions}
        \PYG{p}{\PYGZcb{}}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decode\PYGZus{}neural\PYGZus{}command}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{neural\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Decode neural signals into commands}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        neural\PYGZus{}data : numpy.ndarray}
\PYG{l+s+sd}{            Neural data from the BCI}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        command\PYGZus{}type : CommandType}
\PYG{l+s+sd}{            Type of command}
\PYG{l+s+sd}{        command : str}
\PYG{l+s+sd}{            Specific command}
\PYG{l+s+sd}{        confidence : float}
\PYG{l+s+sd}{            Confidence in the decoded command (0\PYGZhy{}1)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bci} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simulate decoding if no BCI is connected}
            \PYG{n}{command\PYGZus{}type} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{CommandType}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{command} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{available\PYGZus{}commands}\PYG{p}{[}\PYG{n}{command\PYGZus{}type}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{confidence} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Use the BCI to decode the command}
            \PYG{n}{decoded} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bci}\PYG{o}{.}\PYG{n}{process\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
            \PYG{n}{command\PYGZus{}type} \PYG{o}{=} \PYG{n}{decoded}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{command\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{n}{command} \PYG{o}{=} \PYG{n}{decoded}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{command}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            \PYG{n}{confidence} \PYG{o}{=} \PYG{n}{decoded}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
            
        \PYG{k}{return} \PYG{n}{command\PYGZus{}type}\PYG{p}{,} \PYG{n}{command}\PYG{p}{,} \PYG{n}{confidence}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{execute\PYGZus{}command}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{command\PYGZus{}type}\PYG{p}{,} \PYG{n}{command}\PYG{p}{,} \PYG{n}{confidence}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Execute a decoded command}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        command\PYGZus{}type : CommandType}
\PYG{l+s+sd}{            Type of command}
\PYG{l+s+sd}{        command : str}
\PYG{l+s+sd}{            Specific command}
\PYG{l+s+sd}{        confidence : float}
\PYG{l+s+sd}{            Confidence in the decoded command}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        response : str}
\PYG{l+s+sd}{            Response to the command}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Log the command}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{command\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{timestamp}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{command\PYGZus{}type}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{command\PYGZus{}type}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{command}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{command}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{confidence}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{confidence}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{state}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Execute command based on current state}
        \PYG{k}{if} \PYG{n}{confidence} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.7}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Low confidence (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{confidence}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{). Please try again.}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{if} \PYG{n}{command\PYGZus{}type} \PYG{o}{==} \PYG{n}{CommandType}\PYG{o}{.}\PYG{n}{HELP}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}provide\PYGZus{}help}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{command} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}transitions}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}transitions}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{p}{]}\PYG{p}{[}\PYG{n}{command}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
            \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Executing }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{command}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{. Moved to }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{next\PYGZus{}state}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Command }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{command}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ not available in current state }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}provide\PYGZus{}help}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Provide help based on current state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{main\PYGZus{}menu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{You are in the main menu. Available options: option1, option2, option3}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{k}{elif} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{feature1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{You are in feature1. Confirm with }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{yes}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ or go back with }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{no}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} ... help for other states}
        
        \PYG{k}{return} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{You are in }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{. Please try a navigation command.}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}interactive\PYGZus{}session}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{300}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run an interactive session with the user}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        duration : float}
\PYG{l+s+sd}{            Duration of the session in seconds}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Starting NeuroAI Assistant session for }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{duration}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ seconds...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Current state: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{n}{session\PYGZus{}start} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{while} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{session\PYGZus{}start} \PYG{o}{\PYGZlt{}} \PYG{n}{duration}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} This would normally get data from the BCI}
            \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}ll simulate it}
            \PYG{n}{neural\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Example dimensions}
            
            \PYG{c+c1}{\PYGZsh{} Decode neural command}
            \PYG{n}{command\PYGZus{}type}\PYG{p}{,} \PYG{n}{command}\PYG{p}{,} \PYG{n}{confidence} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decode\PYGZus{}neural\PYGZus{}command}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} If confidence is high enough, execute the command}
            \PYG{k}{if} \PYG{n}{confidence} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5}\PYG{p}{:}
                \PYG{n}{response} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{execute\PYGZus{}command}\PYG{p}{(}\PYG{n}{command\PYGZus{}type}\PYG{p}{,} \PYG{n}{command}\PYG{p}{,} \PYG{n}{confidence}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Decoded: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{command\PYGZus{}type}\PYG{o}{.}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ \PYGZhy{} }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{command}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (conf: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{confidence}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Response: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{response}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Current state: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}state}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            
            \PYG{n}{time}\PYG{o}{.}\PYG{n}{sleep}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Wait between command attempts}
            
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{NeuroAI Assistant session complete!}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{command\PYGZus{}history}
\end{sphinxVerbatim}


\section{17.6 Practical Applications and Case Studies}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:practical-applications-and-case-studies}}

\subsection{17.6.1 Clinical Applications}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:clinical-applications}}
\sphinxAtStartPar
BCIs are transforming clinical care for various conditions:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Motor restoration}: BCIs that restore movement for paralysis

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Communication devices}: BCIs for locked\sphinxhyphen{}in syndrome and ALS

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive rehabilitation}: BCIs for stroke and traumatic brain injury

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mental health interventions}: BCIs for depression and anxiety disorders

\end{itemize}


\subsection{17.6.2 Non\sphinxhyphen{}medical Applications}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:non-medical-applications}}
\sphinxAtStartPar
BCIs have expanding applications beyond medicine:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroergonomics}: Optimizing human\sphinxhyphen{}machine interfaces

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromarketing}: Understanding consumer preferences

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Education}: Enhancing learning through neurofeedback

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Entertainment}: BCI\sphinxhyphen{}controlled games and experiences

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Workplace augmentation}: Cognitive monitoring and enhancement

\end{itemize}


\subsection{17.6.3 Emerging Use Cases}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:emerging-use-cases}}
\sphinxAtStartPar
Novel BCI applications continue to emerge:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Collective intelligence}: BCIs that enable brain\sphinxhyphen{}to\sphinxhyphen{}brain communication

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Extended reality}: Neural interfaces for VR/AR experiences

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural cryptography}: Using neural signals for authentication

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Autonomous vehicle control}: BCI\sphinxhyphen{}controlled transportation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Creative applications}: Neural interfaces for art and music

\end{itemize}


\section{17.7 Ethical and Societal Considerations}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:ethical-and-societal-considerations}}

\subsection{17.7.1 Privacy and Security}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:privacy-and-security}}
\sphinxAtStartPar
Neural interfaces raise unique privacy concerns:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural data protection}: Securing brain\sphinxhyphen{}derived information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neurocognitive security}: Preventing unauthorized neural access

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mental privacy}: Protecting thoughts and intentions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Informed consent}: Special considerations for neural data

\end{itemize}


\subsection{17.7.2 Agency and Identity}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:agency-and-identity}}
\sphinxAtStartPar
BCIs challenge traditional notions of agency and identity:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural authorship}: Who owns thoughts expressed through a BCI?

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}machine boundaries}: When does a BCI become part of identity?

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive liberty}: Right to control one’s own neural processes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Authenticity of BCI\sphinxhyphen{}mediated actions}: Questions of attribution

\end{itemize}


\subsection{17.7.3 Access and Equity}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:access-and-equity}}
\sphinxAtStartPar
Ensuring equitable BCI development requires consideration of:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Accessibility}: Making BCIs available to diverse populations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Affordability}: Economic barriers to neural technology

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Inclusivity in design}: Creating interfaces for different abilities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Global perspectives}: Cultural differences in neural technology acceptance

\end{itemize}


\section{17.8 Future Directions in BCI and Human\sphinxhyphen{}AI Interaction}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:future-directions-in-bci-and-human-ai-interaction}}

\subsection{17.8.1 Technological Horizons}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:technological-horizons}}
\sphinxAtStartPar
Several technological advances will shape future BCIs:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Minimally invasive interfaces}: Technologies like neural dust and stentrodes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Wireless and mobile BCIs}: Untethered neural interfaces

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional BCIs}: Systems that both record and stimulate

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multimodal integration}: Combining BCIs with other interfaces

\end{itemize}


\subsection{17.8.2 Integration with Emerging AI}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:integration-with-emerging-ai}}
\sphinxAtStartPar
BCIs will increasingly integrate with advanced AI:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural\sphinxhyphen{}symbolic integration}: Combining neural signals with symbolic reasoning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}inspired AI architectures}: AI systems designed to interface with brains

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Explainable neural interfaces}: Transparent BCI\sphinxhyphen{}AI interaction

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Personalized adaptive interfaces}: Systems tailored to individual brains

\end{itemize}


\subsection{17.8.3 Expanded Applications}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:expanded-applications}}
\sphinxAtStartPar
Future applications will extend BCIs to new domains:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Augmented cognition}: Enhanced mental capabilities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Shared experiences}: Direct neural communication

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}machine\sphinxhyphen{}brain loops}: Closed\sphinxhyphen{}loop human\sphinxhyphen{}AI ecosystems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural prosthetics}: Replacement of cognitive functions

\end{itemize}


\section{17.9 Practical Exercise: Building a Simple EEG Classifier}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:practical-exercise-building-a-simple-eeg-classifier}}
\sphinxAtStartPar
In this exercise, we’ll implement a simple EEG classifier using publicly available data. This example demonstrates how to process EEG signals and use machine learning to classify mental states.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{pipeline}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Pipeline}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{discriminant\PYGZus{}analysis}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearDiscriminantAnalysis}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{,} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{classification\PYGZus{}report}


\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}eeg\PYGZus{}data}\PYG{p}{(}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Load EEG data from file or generate simulated data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    file\PYGZus{}path : str or None}
\PYG{l+s+sd}{        Path to the EEG data file}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    X : numpy.ndarray}
\PYG{l+s+sd}{        EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{    y : numpy.ndarray}
\PYG{l+s+sd}{        Labels for each trial}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{file\PYGZus{}path} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Generate simulated data}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Using simulated EEG data...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{l+m+mi}{100}
        \PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{3}
        \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{500}
        
        \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Class 0: lower alpha power}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Generate base signal (pink noise)}
            \PYG{n}{base\PYGZus{}signal} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add alpha oscillations (8\PYGZhy{}13 Hz)}
            \PYG{n}{times} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{250}  \PYG{c+c1}{\PYGZsh{} Assuming 250 Hz sampling rate}
            \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz alpha}
            
            \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{c}\PYG{p}{]} \PYG{o}{=} \PYG{n}{base\PYGZus{}signal}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{+} \PYG{n}{alpha}
            
            \PYG{n}{y}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}
            
        \PYG{c+c1}{\PYGZsh{} Class 1: higher alpha power}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Generate base signal (pink noise)}
            \PYG{n}{base\PYGZus{}signal} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Add stronger alpha oscillations (8\PYGZhy{}13 Hz)}
            \PYG{n}{times} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{250}  \PYG{c+c1}{\PYGZsh{} Assuming 250 Hz sampling rate}
            \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{3.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{times}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz alpha}
            
            \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{c}\PYG{p}{]} \PYG{o}{=} \PYG{n}{base\PYGZus{}signal}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{+} \PYG{n}{alpha}
            
            \PYG{n}{y}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Load real data}
        \PYG{c+c1}{\PYGZsh{} This would load data from a specific dataset format}
        \PYG{c+c1}{\PYGZsh{} For example, using MNE\PYGZhy{}Python for standard EEG datasets}
        \PYG{k}{pass}
    
    \PYG{k}{return} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}


\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{extract\PYGZus{}features}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Extract features from EEG data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    X : numpy.ndarray}
\PYG{l+s+sd}{        EEG data of shape (n\PYGZus{}trials, n\PYGZus{}channels, n\PYGZus{}samples)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    features : numpy.ndarray}
\PYG{l+s+sd}{        Features of shape (n\PYGZus{}trials, n\PYGZus{}features)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{n\PYGZus{}bands} \PYG{o}{=} \PYG{l+m+mi}{4}  \PYG{c+c1}{\PYGZsh{} delta, theta, alpha, beta}
    
    \PYG{c+c1}{\PYGZsh{} Initialize feature matrix}
    \PYG{n}{features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels} \PYG{o}{*} \PYG{n}{n\PYGZus{}bands}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Frequency bands (in Hz)}
    \PYG{n}{bands} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} delta}
        \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} theta}
        \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{)}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} alpha}
        \PYG{p}{(}\PYG{l+m+mi}{13}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} beta}
    \PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Extract band power features}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{p}{(}\PYG{n}{low}\PYG{p}{,} \PYG{n}{high}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{bands}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Apply bandpass filter and compute power for each channel}
            \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}re just using a simple proxy for band power}
                \PYG{c+c1}{\PYGZsh{} In a real application, you\PYGZsq{}d use proper filtering}
                \PYG{c+c1}{\PYGZsh{} and power estimation methods}
                
                \PYG{c+c1}{\PYGZsh{} Simple FFT\PYGZhy{}based power estimation}
                \PYG{n}{fft\PYGZus{}vals} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{fft}\PYG{o}{.}\PYG{n}{rfft}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{c}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{freqs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{fft}\PYG{o}{.}\PYG{n}{rfftfreq}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{d}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{l+m+mi}{250}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Assuming 250 Hz}
                
                \PYG{c+c1}{\PYGZsh{} Find indices corresponding to the frequency band}
                \PYG{n}{idx\PYGZus{}band} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logical\PYGZus{}and}\PYG{p}{(}\PYG{n}{freqs} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{low}\PYG{p}{,} \PYG{n}{freqs} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{high}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Compute band power (mean of squared FFT coefficients)}
                \PYG{n}{power} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{fft\PYGZus{}vals}\PYG{p}{[}\PYG{n}{idx\PYGZus{}band}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Store in feature matrix}
                \PYG{n}{features}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j} \PYG{o}{*} \PYG{n}{n\PYGZus{}channels} \PYG{o}{+} \PYG{n}{c}\PYG{p}{]} \PYG{o}{=} \PYG{n}{power}
    
    \PYG{k}{return} \PYG{n}{features}


\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Main function to demonstrate EEG classification}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1. Load or generate EEG data}
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{load\PYGZus{}eeg\PYGZus{}data}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Data loaded: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ trials with }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ channels and }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ samples each}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Extract features}
    \PYG{n}{features} \PYG{o}{=} \PYG{n}{extract\PYGZus{}features}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Features extracted: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{features}\PYG{o}{.}\PYG{n}{shape}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Split data into training and testing sets}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{features}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 4. Create and train classifier}
    \PYG{n}{clf} \PYG{o}{=} \PYG{n}{Pipeline}\PYG{p}{(}\PYG{p}{[}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{scaler}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lda}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{LinearDiscriminantAnalysis}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 5. Evaluate using cross\PYGZhy{}validation}
    \PYG{n}{cv\PYGZus{}scores} \PYG{o}{=} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{(}\PYG{n}{clf}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{cv}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Cross\PYGZhy{}validation accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{cv\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ± }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{cv\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 6. Train on full training set and evaluate on test set}
    \PYG{n}{clf}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{clf}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 7. Report results}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Classification report:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{classification\PYGZus{}report}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 8. Plot confusion matrix}
    \PYG{n}{cm} \PYG{o}{=} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cm}\PYG{p}{,} \PYG{n}{interpolation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nearest}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{Blues}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Confusion Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{tick\PYGZus{}marks} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{tick\PYGZus{}marks}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class 0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n}{tick\PYGZus{}marks}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class 0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add text annotations to the confusion matrix}
    \PYG{n}{thresh} \PYG{o}{=} \PYG{n}{cm}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{n+nb}{format}\PYG{p}{(}\PYG{n}{cm}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                     \PYG{n}{horizontalalignment}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                     \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{white}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{cm}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{n}{thresh} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}


\PYG{k}{if} \PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}\PYGZus{}main\PYGZus{}\PYGZus{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{n}{main}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{17.10 Chapter Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:chapter-take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Brain\sphinxhyphen{}Computer Interfaces (BCIs) create direct communication pathways between neural activity and external devices

\item {} 
\sphinxAtStartPar
BCIs range from invasive electrode arrays to non\sphinxhyphen{}invasive techniques like EEG

\item {} 
\sphinxAtStartPar
AI enhances BCIs through improved neural decoding, adaptation, and user interaction

\item {} 
\sphinxAtStartPar
Neural interfaces enable novel forms of human\sphinxhyphen{}AI collaboration, from direct control to cognitive augmentation

\item {} 
\sphinxAtStartPar
BCIs have applications in clinical care, workplace augmentation, education, and entertainment

\item {} 
\sphinxAtStartPar
Ethical considerations include neural privacy, cognitive liberty, and equitable access

\item {} 
\sphinxAtStartPar
Future BCIs will feature minimally invasive technologies, bidirectional interfaces, and deeper AI integration

\end{itemize}


\section{17.11 Further Reading}
\label{\detokenize{part6/ch17_bci_human_ai_interfaces:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Wolpaw, J. R., \& Wolpaw, E. W. (Eds.). (2012). \sphinxstyleemphasis{Brain\sphinxhyphen{}computer interfaces: Principles and practice}. Oxford University Press.

\item {} 
\sphinxAtStartPar
Lebedev, M. A., \& Nicolelis, M. A. (2017). Brain\sphinxhyphen{}machine interfaces: From basic science to neuroprostheses and neurorehabilitation. \sphinxstyleemphasis{Physiological Reviews, 97}(2), 767\sphinxhyphen{}837.

\item {} 
\sphinxAtStartPar
Saha, S., et al. (2021). Progress in brain computer interface: Challenges and opportunities. \sphinxstyleemphasis{Frontiers in Systems Neuroscience, 15}, 578875.

\item {} 
\sphinxAtStartPar
Musk, E., \& Neuralink. (2019). An integrated brain\sphinxhyphen{}machine interface platform with thousands of channels. \sphinxstyleemphasis{Journal of Medical Internet Research, 21}(10), e16194.

\item {} 
\sphinxAtStartPar
Schalk, G. (2020). Brain\sphinxhyphen{}computer symbiosis. \sphinxstyleemphasis{Journal of Neural Engineering, 17}(2), 021001.

\item {} 
\sphinxAtStartPar
Lazarou, I., et al. (2018). EEG\sphinxhyphen{}based brain\sphinxhyphen{}computer interfaces for communication and rehabilitation of people with motor impairment: A novel approach of the 21st century. \sphinxstyleemphasis{Frontiers in Human Neuroscience, 12}, 14.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 18: Neuromorphic Computing}
\label{\detokenize{part6/ch18_neuromorphic_computing:chapter-18-neuromorphic-computing}}\label{\detokenize{part6/ch18_neuromorphic_computing::doc}}
\sphinxAtStartPar
This chapter delves into neuromorphic computing systems, hardware architectures inspired by the structure and function of biological neural systems. These approaches offer potentially revolutionary advantages in energy efficiency and computational capability for specific tasks.


\section{18.0 Chapter Goals}
\label{\detokenize{part6/ch18_neuromorphic_computing:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the principles and advantages of neuromorphic computing

\item {} 
\sphinxAtStartPar
Explore spiking neural networks as a brain\sphinxhyphen{}inspired computational paradigm

\item {} 
\sphinxAtStartPar
Learn how resistive computing elements can implement synaptic\sphinxhyphen{}like behavior

\item {} 
\sphinxAtStartPar
Examine event\sphinxhyphen{}based sensing and processing paradigms

\item {} 
\sphinxAtStartPar
Implement and simulate a simple spiking neural network

\end{itemize}


\section{18.1 Neuromorphic Computing Principles}
\label{\detokenize{part6/ch18_neuromorphic_computing:neuromorphic-computing-principles}}
\sphinxAtStartPar
Neuromorphic computing refers to hardware systems that implement neural processing principles directly in circuitry, rather than simulating them on conventional hardware. This approach can offer dramatic improvements in energy efficiency, especially for tasks like pattern recognition and sensory processing.

\sphinxAtStartPar
\sphinxincludegraphics{{neuromorphic_computing1}.svg}

\sphinxAtStartPar
Key characteristics of neuromorphic systems include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parallel processing}: Massive parallelism similar to the brain’s architecture

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Co\sphinxhyphen{}located processing and memory}: Avoiding the von Neumann bottleneck

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Event\sphinxhyphen{}driven computation}: Computing only when needed, rather than at fixed clock cycles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{In\sphinxhyphen{}memory computing}: Performing operations where data is stored

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sparse, asynchronous signaling}: Communication through discrete events rather than continuous values

\end{itemize}


\subsection{18.1.1 Spiking Neural Networks}
\label{\detokenize{part6/ch18_neuromorphic_computing:spiking-neural-networks}}
\sphinxAtStartPar
Traditional artificial neural networks use continuous activation values, but biological neurons communicate through discrete all\sphinxhyphen{}or\sphinxhyphen{}nothing action potentials (spikes). Spiking Neural Networks (SNNs) mimic this biological principle:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SpikingNeuron}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{tau\PYGZus{}m}\PYG{o}{=}\PYG{l+m+mf}{10.0}\PYG{p}{,} \PYG{n}{tau\PYGZus{}ref}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple Leaky Integrate\PYGZhy{}and\PYGZhy{}Fire neuron model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} threshold: Membrane potential threshold for spike generation}
\PYG{l+s+sd}{        \PYGZhy{} tau\PYGZus{}m: Membrane time constant (ms)}
\PYG{l+s+sd}{        \PYGZhy{} tau\PYGZus{}ref: Refractory period (ms)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold} \PYG{o}{=} \PYG{n}{threshold}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}ref} \PYG{o}{=} \PYG{n}{tau\PYGZus{}ref}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{l+m+mf}{0.0}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{inf}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Current time}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}current}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update neuron state and check for spike}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}current: Input current to the neuron}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} 1 if neuron spikes, 0 otherwise}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check if in refractory period}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}ref}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potential (leaky integration)}
        \PYG{n}{d\PYGZus{}v} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{+} \PYG{n}{input\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{+}\PYG{o}{=} \PYG{n}{d\PYGZus{}v} \PYG{o}{*} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check for spike}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{l+m+mf}{0.0}  \PYG{c+c1}{\PYGZsh{} Reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{last\PYGZus{}spike\PYGZus{}time} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t}
            \PYG{k}{return} \PYG{l+m+mi}{1}
        
        \PYG{k}{return} \PYG{l+m+mi}{0}
\end{sphinxVerbatim}

\sphinxAtStartPar
Unlike rate\sphinxhyphen{}based ANNs, SNNs encode information in the precise timing of spikes and can be more energy\sphinxhyphen{}efficient by only computing when spikes occur. Information can be encoded in several ways:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Rate coding}: Information represented by the frequency of spikes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal coding}: Information in the precise timing of spikes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Population coding}: Information distributed across multiple neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Rank\sphinxhyphen{}order coding}: Information in the order of neuron firing

\end{enumerate}


\subsection{18.1.2 Resistive Computing and Memristors}
\label{\detokenize{part6/ch18_neuromorphic_computing:resistive-computing-and-memristors}}
\sphinxAtStartPar
A key limitation in conventional computing is the energy cost of moving data between memory and processing units (the “von Neumann bottleneck”). In contrast, the brain co\sphinxhyphen{}locates memory and computation in synapses.

\sphinxAtStartPar
Memristors are resistive devices whose resistance changes based on the history of current flow through them. They can implement synaptic weights directly in hardware:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Memristor}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{r\PYGZus{}on}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{r\PYGZus{}off}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple memristor model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} r\PYGZus{}on: Low resistance state (ohms)}
\PYG{l+s+sd}{        \PYGZhy{} r\PYGZus{}off: High resistance state (ohms)}
\PYG{l+s+sd}{        \PYGZhy{} initial\PYGZus{}state: Initial state variable (0\PYGZhy{}1)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on} \PYG{o}{=} \PYG{n}{r\PYGZus{}on}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}off} \PYG{o}{=} \PYG{n}{r\PYGZus{}off}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n}{initial\PYGZus{}state}  \PYG{c+c1}{\PYGZsh{} Internal state variable (0\PYGZhy{}1)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}resistance}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate current resistance based on internal state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{*} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}off} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{r\PYGZus{}on}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{voltage}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{,} \PYG{n}{learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update memristor state based on applied voltage}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} voltage: Applied voltage}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step}
\PYG{l+s+sd}{        \PYGZhy{} learn\PYGZus{}rate: Learning rate parameter}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Simplified nonlinear update rule}
        \PYG{k}{if} \PYG{n}{voltage} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Increase resistance (depression)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{+} \PYG{n}{learn\PYGZus{}rate} \PYG{o}{*} \PYG{n}{voltage} \PYG{o}{*} \PYG{n}{dt}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Decrease resistance (potentiation)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state} \PYG{o}{+} \PYG{n}{learn\PYGZus{}rate} \PYG{o}{*} \PYG{n}{voltage} \PYG{o}{*} \PYG{n}{dt}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Memristor crossbar arrays can implement matrix multiplication operations directly in hardware with orders of magnitude less energy than digital implementations. This is especially valuable for neural network inference, where the same weights are used repeatedly.

\sphinxAtStartPar
Benefits of memristor\sphinxhyphen{}based computation include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Energy efficiency}: 10\sphinxhyphen{}100× lower energy per operation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Density}: Higher integration density than CMOS transistors

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Non\sphinxhyphen{}volatility}: Retaining state without power

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Analog computation}: Native implementation of multiply\sphinxhyphen{}accumulate operations

\end{itemize}


\subsection{18.1.3 Event\sphinxhyphen{}Based Sensors}
\label{\detokenize{part6/ch18_neuromorphic_computing:event-based-sensors}}
\sphinxAtStartPar
Event\sphinxhyphen{}based sensors like Dynamic Vision Sensors (DVS) mimic the retina by only transmitting information when pixels detect changes in brightness:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}dvs\PYGZus{}output}\PYG{p}{(}\PYG{n}{video\PYGZus{}frames}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate output of a Dynamic Vision Sensor from video frames}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} video\PYGZus{}frames: Sequence of image frames (T, H, W)}
\PYG{l+s+sd}{    \PYGZhy{} threshold: Change threshold for generating events}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} events: List of (x, y, t, polarity) tuples}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{events} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{prev\PYGZus{}frame} \PYG{o}{=} \PYG{n}{video\PYGZus{}frames}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{t}\PYG{p}{,} \PYG{n}{frame} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{video\PYGZus{}frames}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate log intensity change}
        \PYG{n}{log\PYGZus{}diff} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{frame} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{prev\PYGZus{}frame} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate ON events (positive changes)}
        \PYG{n}{on\PYGZus{}events} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{log\PYGZus{}diff} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{on\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{on\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{events}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} x, y, time, polarity}
        
        \PYG{c+c1}{\PYGZsh{} Generate OFF events (negative changes)}
        \PYG{n}{off\PYGZus{}events} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{log\PYGZus{}diff} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{n}{threshold}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{y}\PYG{p}{,} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{off\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{off\PYGZus{}events}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{events}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} x, y, time, polarity}
        
        \PYG{n}{prev\PYGZus{}frame} \PYG{o}{=} \PYG{n}{frame}
    
    \PYG{k}{return} \PYG{n}{events}
\end{sphinxVerbatim}

\sphinxAtStartPar
This event\sphinxhyphen{}based approach drastically reduces data transmission and power requirements, enabling high\sphinxhyphen{}speed vision processing with minimal energy. Event\sphinxhyphen{}based sensors have several advantages:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{High dynamic range}: >120dB vs. 60\sphinxhyphen{}70dB for conventional cameras

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{High temporal resolution}: Microsecond\sphinxhyphen{}level precision

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Low bandwidth}: 10\sphinxhyphen{}100× less data than conventional video

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Low latency}: Events transmitted immediately when detected

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Low power}: 1000× more efficient than conventional imaging

\end{itemize}


\subsection{18.1.4 Brain\sphinxhyphen{}Inspired Chips}
\label{\detokenize{part6/ch18_neuromorphic_computing:brain-inspired-chips}}
\sphinxAtStartPar
Several neuromorphic hardware platforms have demonstrated remarkable efficiency:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{IBM TrueNorth}: 1 million digital neurons with 256 million synapses, consuming only \textasciitilde{}70mW of power.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Intel Loihi}: Implements on\sphinxhyphen{}chip learning with \textasciitilde{}130,000 neurons and 130 million synapses per chip.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{SpiNNaker}: Massively parallel architecture with ARM processors designed specifically for neural simulations.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BrainScaleS}: Analog/mixed\sphinxhyphen{}signal system operating at accelerated time scales.

\end{enumerate}

\sphinxAtStartPar
These systems achieve energy efficiencies 100\sphinxhyphen{}1000× better than conventional architectures for certain tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}energy\PYGZus{}efficiency}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compare energy efficiency for image recognition task}
\PYG{l+s+sd}{    (based on published benchmarks)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{architectures} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPU (NVIDIA V100)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.76}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CPU (Intel Xeon)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{5.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.76}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{FPGA}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.75}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Loihi}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.74}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TrueNorth}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.0001}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.70}\PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Calculate energy efficiency (accuracy per joule)}
    \PYG{k}{for} \PYG{n}{arch}\PYG{p}{,} \PYG{n}{stats} \PYG{o+ow}{in} \PYG{n}{architectures}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{efficiency} \PYG{o}{=} \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{/} \PYG{n}{stats}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{joules\PYGZus{}per\PYGZus{}inference}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{arch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{efficiency}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ accuracy/joule}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{18.2 Applications of Neuromorphic Computing}
\label{\detokenize{part6/ch18_neuromorphic_computing:applications-of-neuromorphic-computing}}
\sphinxAtStartPar
Neuromorphic systems are particularly well\sphinxhyphen{}suited for specific applications:


\subsection{18.2.1 Edge Computing and IoT}
\label{\detokenize{part6/ch18_neuromorphic_computing:edge-computing-and-iot}}
\sphinxAtStartPar
Low\sphinxhyphen{}power neuromorphic chips are ideal for intelligent edge devices:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensor Processing}: Processing sensor data locally with minimal power

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Anomaly Detection}: Identifying unusual patterns without continuous transmission

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Keyword Spotting}: Recognizing specific audio triggers

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Smart Cameras}: Event\sphinxhyphen{}based vision for surveillance and monitoring

\end{itemize}


\subsection{18.2.2 Robotics and Autonomous Systems}
\label{\detokenize{part6/ch18_neuromorphic_computing:robotics-and-autonomous-systems}}
\sphinxAtStartPar
Neuromorphic computing enables efficient sensorimotor processing:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Real\sphinxhyphen{}time Control}: Low\sphinxhyphen{}latency sensory processing and actuation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Obstacle Avoidance}: Fast processing of visual information for navigation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Power Efficiency}: Extended operation time on limited power budgets

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptive Behavior}: On\sphinxhyphen{}chip learning for environmental adaptation

\end{itemize}


\subsection{18.2.3 Brain\sphinxhyphen{}Computer Interfaces}
\label{\detokenize{part6/ch18_neuromorphic_computing:brain-computer-interfaces}}
\sphinxAtStartPar
The low power and event\sphinxhyphen{}driven nature of neuromorphic systems makes them ideal for neural interfaces:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural Signal Processing}: Efficient processing of sparse neural signals

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Closed\sphinxhyphen{}loop Stimulation}: Real\sphinxhyphen{}time response to detected neural patterns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Portable Medical Devices}: Neurological monitoring with long battery life

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuroprosthetics}: Direct processing of neural signals for prosthetic control

\end{itemize}


\section{18.3 Simulation and Implementation}
\label{\detokenize{part6/ch18_neuromorphic_computing:simulation-and-implementation}}

\subsection{18.3.1 Software Frameworks for Neuromorphic Computing}
\label{\detokenize{part6/ch18_neuromorphic_computing:software-frameworks-for-neuromorphic-computing}}
\sphinxAtStartPar
Several frameworks support the development and simulation of spiking neural networks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brian2}: Python\sphinxhyphen{}based simulator for spiking neural networks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{NEST}: Simulator for large\sphinxhyphen{}scale networks of spiking neurons

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{PyNN}: API for simulator\sphinxhyphen{}independent specification of neural network models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Nengo}: Python library for building and simulating neural models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{BindsNET}: SNN framework built on PyTorch

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Norse}: Deep learning with spiking neural networks in PyTorch

\end{enumerate}


\subsection{18.3.2 Converting ANNs to SNNs}
\label{\detokenize{part6/ch18_neuromorphic_computing:converting-anns-to-snns}}
\sphinxAtStartPar
Converting traditional artificial neural networks to spiking neural networks allows leveraging existing deep learning methods:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{convert\PYGZus{}ann\PYGZus{}to\PYGZus{}snn}\PYG{p}{(}\PYG{n}{ann\PYGZus{}model}\PYG{p}{,} \PYG{n}{simulation\PYGZus{}time}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Convert a trained ANN to a rate\PYGZhy{}based SNN}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} ann\PYGZus{}model: Trained artificial neural network}
\PYG{l+s+sd}{    \PYGZhy{} simulation\PYGZus{}time: Simulation duration in ms}
\PYG{l+s+sd}{    \PYGZhy{} dt: Time step in ms}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} snn\PYGZus{}model: Equivalent spiking neural network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} In practice, this would involve:}
    \PYG{c+c1}{\PYGZsh{} 1. Extracting weights from ANN}
    \PYG{c+c1}{\PYGZsh{} 2. Creating appropriate SNN architecture}
    \PYG{c+c1}{\PYGZsh{} 3. Setting thresholds based on activation statistics}
    \PYG{c+c1}{\PYGZsh{} 4. Adjusting for rate\PYGZhy{}based operation}
    
    \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
    \PYG{n}{snn\PYGZus{}model} \PYG{o}{=} \PYG{n}{create\PYGZus{}empty\PYGZus{}snn\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} For each layer in the ANN}
    \PYG{k}{for} \PYG{n}{layer\PYGZus{}idx}\PYG{p}{,} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{ann\PYGZus{}model}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{hasattr}\PYG{p}{(}\PYG{n}{layer}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Copy weights}
            \PYG{n}{weights} \PYG{o}{=} \PYG{n}{layer}\PYG{o}{.}\PYG{n}{weight}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{set\PYGZus{}snn\PYGZus{}weights}\PYG{p}{(}\PYG{n}{snn\PYGZus{}model}\PYG{p}{,} \PYG{n}{layer\PYGZus{}idx}\PYG{p}{,} \PYG{n}{weights}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Set appropriate thresholds based on activation statistics}
            \PYG{n}{activation\PYGZus{}scale} \PYG{o}{=} \PYG{n}{estimate\PYGZus{}activation\PYGZus{}scale}\PYG{p}{(}\PYG{n}{ann\PYGZus{}model}\PYG{p}{,} \PYG{n}{layer\PYGZus{}idx}\PYG{p}{)}
            \PYG{n}{set\PYGZus{}snn\PYGZus{}thresholds}\PYG{p}{(}\PYG{n}{snn\PYGZus{}model}\PYG{p}{,} \PYG{n}{layer\PYGZus{}idx}\PYG{p}{,} \PYG{n}{activation\PYGZus{}scale}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{snn\PYGZus{}model}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key challenges in ANN\sphinxhyphen{}to\sphinxhyphen{}SNN conversion include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Activation function mapping}: Converting ReLU to spike rates

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Threshold calibration}: Setting appropriate firing thresholds

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal dynamics}: Handling the time dimension

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Training\sphinxhyphen{}aware conversion}: Optimizing ANNs specifically for SNN conversion

\end{itemize}


\section{18.4 Code Lab: Spiking Neural Network}
\label{\detokenize{part6/ch18_neuromorphic_computing:code-lab-spiking-neural-network}}
\sphinxAtStartPar
Let’s implement a simple spiking neural network that demonstrates the key principles of neuromorphic computing:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{animation}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{FuncAnimation}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SpikingNeuralNetwork}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}input}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}output}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple Spiking Neural Network with LIF neurons}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}input: Number of input neurons}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}hidden: Number of hidden neurons}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}output: Number of output neurons}
\PYG{l+s+sd}{        \PYGZhy{} dt: Simulation time step (ms)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}input} \PYG{o}{=} \PYG{n}{n\PYGZus{}input}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{n\PYGZus{}hidden}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output} \PYG{o}{=} \PYG{n}{n\PYGZus{}output}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt} \PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Initialize random weights}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}input\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}input}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}hidden\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Neuron parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.0}  \PYG{c+c1}{\PYGZsh{} resting potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{75.0}  \PYG{c+c1}{\PYGZsh{} reset potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{55.0}  \PYG{c+c1}{\PYGZsh{} threshold potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{10.0}  \PYG{c+c1}{\PYGZsh{} membrane time constant (ms)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period} \PYG{o}{=} \PYG{l+m+mf}{2.0}  \PYG{c+c1}{\PYGZsh{} refractory period (ms)}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Recording}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} Current time}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Reset network state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run one simulation step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}spikes: Binary array of input spikes (0 or 1)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}spikes: Binary array of output spikes}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Update hidden layer}
        \PYG{c+c1}{\PYGZsh{} Calculate input current from input layer spikes}
        \PYG{n}{input\PYGZus{}current} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}input\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check which neurons are not in refractory period}
        \PYG{n}{active\PYGZus{}hidden} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potentials for active neurons}
        \PYG{n}{dv\PYGZus{}hidden} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{+} \PYG{n}{input\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{active\PYGZus{}hidden}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dv\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{active\PYGZus{}hidden}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Check for spikes in hidden layer}
        \PYG{n}{hidden\PYGZus{}spikes} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reset membrane potential and set refractory period for spiked neurons}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period}
        
        \PYG{c+c1}{\PYGZsh{} Decrement refractory time}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}hidden}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update output layer (similar process)}
        \PYG{n}{output\PYGZus{}current} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{w\PYGZus{}hidden\PYGZus{}output}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}spikes}\PYG{p}{)}
        \PYG{n}{active\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{n}{dv\PYGZus{}output} \PYG{o}{=} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{+} \PYG{n}{output\PYGZus{}current}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau\PYGZus{}m}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{n}{active\PYGZus{}output}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dv\PYGZus{}output}\PYG{p}{[}\PYG{n}{active\PYGZus{}output}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        
        \PYG{n}{output\PYGZus{}spikes} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output}\PYG{p}{[}\PYG{n}{spike\PYGZus{}indices}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}period}
            
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record history}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}spikes}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}hidden}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}output}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output\PYGZus{}spikes}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}pattern}\PYG{p}{,} \PYG{n}{simulation\PYGZus{}time}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run simulation for specified time with given input pattern}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}pattern: Function that returns input spikes at each time step}
\PYG{l+s+sd}{        \PYGZhy{} simulation\PYGZus{}time: Total simulation time (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}history: History of output spikes}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{simulation\PYGZus{}time} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset\PYGZus{}state}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{output\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{step} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}
            \PYG{n}{input\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{input\PYGZus{}pattern}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
            \PYG{n}{output\PYGZus{}spikes} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{input\PYGZus{}spikes}\PYG{p}{)}
            \PYG{n}{output\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{output\PYGZus{}spikes}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{output\PYGZus{}history}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot spike raster and membrane potentials\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No simulation data to plot}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{k}{return}
        
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{n}{figsize}\PYG{p}{,} \PYG{n}{sharex}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert spike history to arrays}
        \PYG{n}{spikes\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n}{spikes\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Time array}
        \PYG{n}{time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spikes\PYGZus{}hidden}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dt}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot hidden layer spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{n}{time}\PYG{p}{[}\PYG{n}{spikes\PYGZus{}hidden}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Layer Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot output layer spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{n}{time}\PYG{p}{[}\PYG{n}{spikes\PYGZus{}output}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Layer Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot membrane potentials}
        \PYG{n}{v\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n}{v\PYGZus{}output} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}history\PYGZus{}output}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot a few hidden neurons}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{v\PYGZus{}hidden}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Membrane Potential (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hidden Layer Membrane Potentials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot all output neurons}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{time}\PYG{p}{,} \PYG{n}{v\PYGZus{}output}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Membrane Potential (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Output Layer Membrane Potentials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{fig}
\end{sphinxVerbatim}

\sphinxAtStartPar
Let’s demonstrate this SNN with a simple pattern recognition task:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}snn\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Create a simple SNN with 5 input, 10 hidden, and 2 output neurons}
    \PYG{n}{snn} \PYG{o}{=} \PYG{n}{SpikingNeuralNetwork}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define input patterns (simplified)}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{pattern\PYGZus{}1}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Pattern 1: neurons 0, 1, 2 active}
        \PYG{n}{period} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} ms}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{5} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{3} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{8} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{6} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{12} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{pattern\PYGZus{}2}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Pattern 2: neurons 2, 3, 4 active}
        \PYG{n}{period} \PYG{o}{=} \PYG{l+m+mi}{20}  \PYG{c+c1}{\PYGZsh{} ms}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{2} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{7} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{5} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{10} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{,}
                        \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{8} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{n}{period}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{15} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run simulations with different input patterns}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running simulation for pattern 1...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{snn}\PYG{o}{.}\PYG{n}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}1}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}
    \PYG{n}{fig1} \PYG{o}{=} \PYG{n}{snn}\PYG{o}{.}\PYG{n}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{fig1}\PYG{o}{.}\PYG{n}{number}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pattern 1 Response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running simulation for pattern 2...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{snn}\PYG{o}{.}\PYG{n}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{pattern\PYGZus{}2}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}
    \PYG{n}{fig2} \PYG{o}{=} \PYG{n}{snn}\PYG{o}{.}\PYG{n}{plot\PYGZus{}activity}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{fig2}\PYG{o}{.}\PYG{n}{number}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pattern 2 Response}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{SNN demo completed}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}


\section{18.5 Future Directions}
\label{\detokenize{part6/ch18_neuromorphic_computing:future-directions}}
\sphinxAtStartPar
Neuromorphic computing is evolving rapidly with several exciting research directions:


\subsection{18.5.1 Hardware Advances}
\label{\detokenize{part6/ch18_neuromorphic_computing:hardware-advances}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{3D Integration}: Increasing neuron and synapse density through vertical stacking

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Novel Materials}: Exploring phase\sphinxhyphen{}change memory, ferroelectric devices, and spintronic devices

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hybrid Systems}: Combining neuromorphic and conventional computing architectures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Nanoscale Devices}: Moving toward truly brain\sphinxhyphen{}like densities with nanoscale components

\end{itemize}


\subsection{18.5.2 Algorithms and Learning}
\label{\detokenize{part6/ch18_neuromorphic_computing:algorithms-and-learning}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local Learning Rules}: Developing biologically plausible learning algorithms that don’t require global backpropagation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Coding}: Moving beyond rate coding to leverage timing information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural Plasticity}: Algorithms that modify network topology, not just weights

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromodulatory Influences}: Incorporating attention, reward, and other modulatory effects

\end{itemize}


\subsection{18.5.3 System Integration}
\label{\detokenize{part6/ch18_neuromorphic_computing:system-integration}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensorimotor Loops}: Closing the loop between sensing and acting in neuromorphic systems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hybrid Learning}: Combining traditional deep learning with neuromorphic approaches

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Multi\sphinxhyphen{}chip Systems}: Scaling to brain\sphinxhyphen{}like numbers of neurons and synapses

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Standardized Interfaces}: Developing common interfaces for neuromorphic hardware

\end{itemize}


\section{18.6 Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch18_neuromorphic_computing:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromorphic computing mimics the brain’s architecture} to achieve dramatic improvements in energy efficiency for specific types of computation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Spiking neural networks} use discrete, event\sphinxhyphen{}based communication similar to biological neurons, enabling sparse computation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Resistive computing elements} like memristors can implement synaptic weights directly in hardware, overcoming the von Neumann bottleneck.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Event\sphinxhyphen{}based sensors} drastically reduce data bandwidth and power requirements by only transmitting information when changes occur.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromorphic hardware platforms} demonstrate 100\sphinxhyphen{}1000× improvements in energy efficiency for pattern recognition and sensory processing tasks.

\end{itemize}


\section{18.7 Further Reading}
\label{\detokenize{part6/ch18_neuromorphic_computing:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Davies, M., et al. (2018). \sphinxhref{https://ieeexplore.ieee.org/document/8259423}{Loihi: A Neuromorphic Manycore Processor with On\sphinxhyphen{}Chip Learning}. IEEE Micro, 38(1), 82\sphinxhyphen{}99.

\item {} 
\sphinxAtStartPar
Schuman, C. D., et al. (2017). \sphinxhref{https://arxiv.org/abs/1705.06963}{A Survey of Neuromorphic Computing and Neural Networks in Hardware}. arXiv preprint arXiv:1705.06963.

\item {} 
\sphinxAtStartPar
Diehl, P. U., et al. (2015). \sphinxhref{https://ieeexplore.ieee.org/document/7280696}{Fast\sphinxhyphen{}classifying, high\sphinxhyphen{}accuracy spiking deep networks through weight and threshold balancing}. IEEE International Joint Conference on Neural Networks.

\item {} 
\sphinxAtStartPar
Tavanaei, A., et al. (2019). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S0893608018303332}{Deep learning in spiking neural networks}. Neural Networks, 111, 47\sphinxhyphen{}63.

\item {} 
\sphinxAtStartPar
Pfeiffer, M., \& Pfeil, T. (2018). \sphinxhref{https://www.frontiersin.org/articles/10.3389/fnins.2018.00774/full}{Deep learning with spiking neurons: Opportunities and challenges}. Frontiers in Neuroscience, 12, 774.

\end{itemize}

\sphinxstepscope


\chapter{Cognitive Neuroscience and Deep Learning}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:cognitive-neuroscience-and-deep-learning}}\label{\detokenize{part6/ch19_cognitive_neuro_dl::doc}}

\section{Chapter Goals}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:chapter-goals}}
\sphinxAtStartPar
After completing this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the bidirectional relationship between cognitive neuroscience and deep learning

\item {} 
\sphinxAtStartPar
Identify key cognitive neuroscience principles that have inspired deep learning architectures

\item {} 
\sphinxAtStartPar
Apply cognitive constraints to improve deep learning model performance and interpretability

\item {} 
\sphinxAtStartPar
Analyze deep learning models as computational models of cognition

\item {} 
\sphinxAtStartPar
Explain how deep learning has contributed to our understanding of brain function

\item {} 
\sphinxAtStartPar
Implement methods for comparing neural and artificial network representations

\item {} 
\sphinxAtStartPar
Design experiments that bridge cognitive neuroscience and deep learning

\end{itemize}


\section{19.1 Introduction: The Convergence of Minds and Machines}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:introduction-the-convergence-of-minds-and-machines}}
\sphinxAtStartPar
Cognitive neuroscience and deep learning represent two powerful approaches to understanding intelligence—one through the study of biological brains, and the other through the development of artificial neural systems. While these fields developed largely independently, they have begun to converge in recent years, creating a rich interdisciplinary area that promises to advance both our understanding of natural intelligence and our ability to create artificial intelligence.

\sphinxAtStartPar
This chapter explores this bidirectional relationship: how cognitive neuroscience inspires deep learning architectures and strategies, and how deep learning models serve as computational models of cognition that generate testable predictions about brain function.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Conceptual overview of the relationship between cognitive neuroscience and deep learning}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib\PYGZus{}venn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{venn2}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}field\PYGZus{}relationship}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize the bidirectional relationship between cognitive neuroscience and deep learning}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a Venn diagram showing the overlap}
    \PYG{n}{v} \PYG{o}{=} \PYG{n}{venn2}\PYG{p}{(}\PYG{n}{subsets}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{set\PYGZus{}labels}\PYG{o}{=}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cognitive Neuroscience}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Deep Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Change colors and alpha}
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}color}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{01}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}color}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{11}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}color}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}alpha}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{01}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}alpha}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{v}\PYG{o}{.}\PYG{n}{get\PYGZus{}patch\PYGZus{}by\PYGZus{}id}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{11}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}alpha}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add bidirectional arrow to show mutual influence}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{xy}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xytext}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{,}
                 \PYG{n}{arrowprops}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{arrowstyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}\PYGZhy{}\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add examples of cross\PYGZhy{}disciplinary concepts in the overlap}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.55}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Shared Concepts:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Hierarchical processing}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.45}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Distributed representations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Attention mechanisms}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.35}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Predictive coding}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add examples specific to each field}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Neural circuits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Cognitive processes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Brain imaging}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Backpropagation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.65}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Gradient descent}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{• Layer architectures}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Set title}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{The Bidirectional Relationship Between Cognitive Neuroscience and Deep Learning}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
                 \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{19.2 Cognitive Science Principles in Deep Learning}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:cognitive-science-principles-in-deep-learning}}

\subsection{19.2.1 Attention and Working Memory}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:attention-and-working-memory}}
\sphinxAtStartPar
The human attention system allows us to selectively focus on relevant information while filtering out distractions. In deep learning, attention mechanisms have revolutionized performance across domains:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual attention}: Mechanisms that weight the importance of different regions in an image

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}attention}: Found in transformers, allows models to weigh the importance of different elements in a sequence

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cross\sphinxhyphen{}attention}: Allows models to relate elements from different modalities or sequences

\end{itemize}

\sphinxAtStartPar
Working memory—our ability to temporarily maintain and manipulate information—has also influenced deep learning through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory networks}: Architectures with explicit memory components

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Gating mechanisms}: Control the flow of information through the network

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Meta\sphinxhyphen{}learning}: Learning to rapidly adapt to new tasks by maintaining task\sphinxhyphen{}relevant information

\end{itemize}


\subsection{19.2.2 Hierarchical Processing and Compositionality}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:hierarchical-processing-and-compositionality}}
\sphinxAtStartPar
The brain processes information through hierarchical structures, from simple features to complex concepts. This principle has inspired deep learning architectures:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Convolutional neural networks}: Hierarchical visual processing from edges to objects

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical reinforcement learning}: Breaking complex tasks into manageable sub\sphinxhyphen{}goals

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compositional generalization}: Combining learned components in novel ways

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{n+nn}{.}\PYG{n+nn}{models}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Sequential}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{n+nn}{.}\PYG{n+nn}{layers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Dense}\PYG{p}{,} \PYG{n}{Conv2D}\PYG{p}{,} \PYG{n}{MaxPooling2D}\PYG{p}{,} \PYG{n}{Flatten}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}hierarchical\PYGZus{}cnn}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a CNN with hierarchical processing inspired by the visual cortex}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    model : tf.keras.Model}
\PYG{l+s+sd}{        A CNN with hierarchical processing}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
        \PYG{c+c1}{\PYGZsh{} Input layer (specify for clarity)}
        \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Input}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{224}\PYG{p}{,} \PYG{l+m+mi}{224}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Stage 1: Low\PYGZhy{}level feature extraction (analogous to V1)}
        \PYG{c+c1}{\PYGZsh{} Detect edges and simple contours}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{low\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Stage 2: Mid\PYGZhy{}level feature extraction (analogous to V2/V4)}
        \PYG{c+c1}{\PYGZsh{} Detect shapes and textures}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mid\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Stage 3: Higher\PYGZhy{}level feature extraction (analogous to posterior IT)}
        \PYG{c+c1}{\PYGZsh{} Detect parts of objects}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{high\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Stage 4: Object\PYGZhy{}level representation (analogous to anterior IT)}
        \PYG{c+c1}{\PYGZsh{} Detect whole objects}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{object\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Flatten and dense layers (analogous to prefrontal cortex)}
        \PYG{c+c1}{\PYGZsh{} Abstract categorization and decision making}
        \PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{512}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{abstract\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{softmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classification}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}activations}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{example\PYGZus{}image}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize activations at different stages of the hierarchical network}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    model : tf.keras.Model}
\PYG{l+s+sd}{        The hierarchical CNN model}
\PYG{l+s+sd}{    example\PYGZus{}image : numpy.ndarray}
\PYG{l+s+sd}{        An example image to visualize activations for}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This would extract activations from different layers of the network}
    \PYG{c+c1}{\PYGZsh{} In a real implementation, you would use a model to extract these}
    \PYG{c+c1}{\PYGZsh{} Here we\PYGZsq{}ll just sketch the concept}
    
    \PYG{n}{layer\PYGZus{}names} \PYG{o}{=} \PYG{p}{[}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{low\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mid\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{high\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{object\PYGZus{}level\PYGZus{}features}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{p}{]}
    
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{layer\PYGZus{}name} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} In real code, this would extract actual activations}
        \PYG{c+c1}{\PYGZsh{} feature\PYGZus{}map = get\PYGZus{}layer\PYGZus{}activation(model, layer\PYGZus{}name, example\PYGZus{}image)}
        
        \PYG{c+c1}{\PYGZsh{} For demonstration, we\PYGZsq{}ll create mock activations}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Low\PYGZhy{}level (edges)}
            \PYG{n}{feature\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{56}\PYG{p}{,} \PYG{l+m+mi}{56}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Simplified for visualization}
        \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Mid\PYGZhy{}level (textures)}
            \PYG{n}{feature\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} High\PYGZhy{}level (parts)}
            \PYG{n}{feature\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{14}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Object level}
            \PYG{n}{feature\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{)}
        
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{feature\PYGZus{}map}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer\PYGZus{}name}\PYG{o}{.}\PYG{n}{replace}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{19.2.3 Predictive Coding and Generative Models}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:predictive-coding-and-generative-models}}
\sphinxAtStartPar
A fundamental principle in cognitive neuroscience is that the brain continuously predicts future inputs, with perception arising from the integration of these predictions with sensory data. This has influenced deep learning through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generative models}: Systems that learn to generate likely inputs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}supervised learning}: Learning from prediction tasks without explicit labels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contrastive predictive coding}: Learning representations by predicting future states

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Variational autoencoders}: Learning latent representations that capture data distribution

\end{itemize}


\subsection{19.2.4 Embodied Cognition and Active Learning}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:embodied-cognition-and-active-learning}}
\sphinxAtStartPar
Cognitive science increasingly emphasizes that intelligence is embodied—developed through physical interaction with the environment. This has influenced AI through:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reinforcement learning}: Agents learn from interactions with environments

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Active learning}: Systems actively select what data to learn from

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Curriculum learning}: Gradually increasing task difficulty during training

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Curiosity\sphinxhyphen{}driven learning}: Using prediction errors to drive exploration

\end{itemize}


\section{19.3 Cognitive Constraints in Deep Learning}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:cognitive-constraints-in-deep-learning}}

\subsection{19.3.1 Inductive Biases from Cognitive Science}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:inductive-biases-from-cognitive-science}}
\sphinxAtStartPar
Human cognition demonstrates numerous inductive biases—prior assumptions that guide learning. Incorporating these biases into deep learning models can improve performance:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Object\sphinxhyphen{}centric representations}: Humans naturally parse scenes into discrete objects

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Causal reasoning}: Humans infer and reason about cause\sphinxhyphen{}and\sphinxhyphen{}effect relationships

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Compositional structure}: Humans represent concepts as combinations of simpler parts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Few\sphinxhyphen{}shot learning}: Humans can learn from very few examples

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ObjectCentricNetwork}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A network that incorporates an object\PYGZhy{}centric inductive bias}
\PYG{l+s+sd}{    inspired by human visual cognition}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}slots}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the object\PYGZhy{}centric network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}slots : int}
\PYG{l+s+sd}{            Number of object slots}
\PYG{l+s+sd}{        slot\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimension of each object slot}
\PYG{l+s+sd}{        hidden\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimension of hidden layers}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots} \PYG{o}{=} \PYG{n}{n\PYGZus{}slots}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}dim} \PYG{o}{=} \PYG{n}{slot\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Slot attention mechanism}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}attention} \PYG{o}{=} \PYG{n}{SlotAttention}\PYG{p}{(}
            \PYG{n}{dim}\PYG{o}{=}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,}
            \PYG{n}{n\PYGZus{}slots}\PYG{o}{=}\PYG{n}{n\PYGZus{}slots}\PYG{p}{,}
            \PYG{n}{slot\PYGZus{}dim}\PYG{o}{=}\PYG{n}{slot\PYGZus{}dim}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} CNN encoder to extract features from images}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64} \PYG{o}{*} \PYG{l+m+mi}{8} \PYG{o}{*} \PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Object\PYGZhy{}wise MLP for classification}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{object\PYGZus{}classifier} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 object classes}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Input images of shape (batch\PYGZus{}size, channels, height, width)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        object\PYGZus{}preds : torch.Tensor}
\PYG{l+s+sd}{            Object class predictions}
\PYG{l+s+sd}{        attention\PYGZus{}maps : torch.Tensor}
\PYG{l+s+sd}{            Attention maps for each object slot}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Extract image features}
        \PYG{n}{features} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply slot attention to segment into objects}
        \PYG{n}{slots}\PYG{p}{,} \PYG{n}{attention\PYGZus{}maps} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}attention}\PYG{p}{(}\PYG{n}{features}\PYG{p}{,} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Classify each object}
        \PYG{n}{object\PYGZus{}preds} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{object\PYGZus{}classifier}\PYG{p}{(}\PYG{n}{slots}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{object\PYGZus{}preds} \PYG{o}{=} \PYG{n}{object\PYGZus{}preds}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{object\PYGZus{}preds}\PYG{p}{,} \PYG{n}{attention\PYGZus{}maps}


\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SlotAttention}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simplified version of Slot Attention mechanism}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{dim}\PYG{p}{,} \PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim} \PYG{o}{=} \PYG{n}{dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots} \PYG{o}{=} \PYG{n}{n\PYGZus{}slots}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}dim} \PYG{o}{=} \PYG{n}{slot\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Initialize slot parameters}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slots} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Projection layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}q} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{,} \PYG{n}{dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}k} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{,} \PYG{n}{dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}v} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{,} \PYG{n}{dim}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gru} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{GRUCell}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} MLP for slot update}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mlp} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{,} \PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Layer norm}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm\PYGZus{}slots} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm\PYGZus{}inputs} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LayerNorm}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{image\PYGZus{}shape}\PYG{p}{,} \PYG{n}{num\PYGZus{}iterations}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Apply slot attention mechanism}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        inputs : torch.Tensor}
\PYG{l+s+sd}{            Input features of shape (batch\PYGZus{}size, dim)}
\PYG{l+s+sd}{        image\PYGZus{}shape : tuple}
\PYG{l+s+sd}{            Shape of the input images (batch\PYGZus{}size, channels, height, width)}
\PYG{l+s+sd}{        num\PYGZus{}iterations : int}
\PYG{l+s+sd}{            Number of attention iterations}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        slots : torch.Tensor}
\PYG{l+s+sd}{            Updated slot representations}
\PYG{l+s+sd}{        attention\PYGZus{}maps : torch.Tensor}
\PYG{l+s+sd}{            Attention maps for visualization}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{inputs}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Initialize slots}
        \PYG{n}{slots} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slots}\PYG{o}{.}\PYG{n}{expand}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalizations}
        \PYG{n}{inputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm\PYGZus{}inputs}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape inputs for attention visualization}
        \PYG{n}{h}\PYG{p}{,} \PYG{n}{w} \PYG{o}{=} \PYG{n}{image\PYGZus{}shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{image\PYGZus{}shape}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{4}  \PYG{c+c1}{\PYGZsh{} Downsampled due to CNN}
        
        \PYG{c+c1}{\PYGZsh{} Multiple rounds of attention}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{slots\PYGZus{}prev} \PYG{o}{=} \PYG{n}{slots}
            
            \PYG{c+c1}{\PYGZsh{} Normalize slots}
            \PYG{n}{slots} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{norm\PYGZus{}slots}\PYG{p}{(}\PYG{n}{slots}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Attention}
            \PYG{n}{q} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}q}\PYG{p}{(}\PYG{n}{slots}\PYG{p}{)}
            \PYG{n}{k} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}k}\PYG{p}{(}\PYG{n}{inputs}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{v} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{to\PYGZus{}v}\PYG{p}{(}\PYG{n}{inputs}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute attention scores}
            \PYG{n}{attn\PYGZus{}logits} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{q}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{*} \PYG{n}{k}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{attn} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attn\PYGZus{}logits}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Weight values by attention}
            \PYG{n}{updates} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{attn}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{v}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update slots}
            \PYG{n}{slots} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gru}\PYG{p}{(}
                \PYG{n}{updates}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{slots\PYGZus{}prev}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}
            \PYG{p}{)}
            \PYG{n}{slots} \PYG{o}{=} \PYG{n}{slots}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slot\PYGZus{}dim}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} MLP for additional processing}
            \PYG{n}{slots} \PYG{o}{=} \PYG{n}{slots} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mlp}\PYG{p}{(}\PYG{n}{slots}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reshape attention for visualization}
        \PYG{n}{attention\PYGZus{}maps} \PYG{o}{=} \PYG{n}{attn}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}slots}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{w}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{slots}\PYG{p}{,} \PYG{n}{attention\PYGZus{}maps}
\end{sphinxVerbatim}


\subsection{19.3.2 Neural Architecture Constraints}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:neural-architecture-constraints}}
\sphinxAtStartPar
Beyond specific cognitive principles, the broader architecture of the brain can inform deep learning:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational resource constraints}: Optimizing for energy efficiency

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Local learning rules}: Alternatives to global backpropagation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Modular architectures}: Specialized components with distinct functions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Recurrence and feedback connections}: Incorporating temporal dynamics and top\sphinxhyphen{}down processing

\end{itemize}


\subsection{19.3.3 Cognitively\sphinxhyphen{}Plausible Learning Mechanisms}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:cognitively-plausible-learning-mechanisms}}
\sphinxAtStartPar
Human learning differs from standard deep learning approaches in key ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hebbian learning}: Connections strengthen when neurons co\sphinxhyphen{}activate

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contrastive learning}: Learning from differences between positive and negative examples

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Curriculum learning}: Gradually increasing task difficulty

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Few\sphinxhyphen{}shot and continual learning}: Learning efficiently from limited data while avoiding catastrophic forgetting

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{HebbianNetwork}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simple implementation of a Hebbian learning network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{decay\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.0001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the Hebbian network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        input\PYGZus{}size : int}
\PYG{l+s+sd}{            Size of input features}
\PYG{l+s+sd}{        output\PYGZus{}size : int}
\PYG{l+s+sd}{            Size of output features}
\PYG{l+s+sd}{        learning\PYGZus{}rate : float}
\PYG{l+s+sd}{            Learning rate for weight updates}
\PYG{l+s+sd}{        decay\PYGZus{}rate : float}
\PYG{l+s+sd}{            Weight decay rate to prevent unbounded growth}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{output\PYGZus{}size}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decay\PYGZus{}rate} \PYG{o}{=} \PYG{n}{decay\PYGZus{}rate}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : numpy.ndarray}
\PYG{l+s+sd}{            Input data of shape (batch\PYGZus{}size, input\PYGZus{}size)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        y : numpy.ndarray}
\PYG{l+s+sd}{            Output activations of shape (batch\PYGZus{}size, output\PYGZus{}size)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{o}{.}\PYG{n}{T}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update weights using Hebbian learning rule:}
\PYG{l+s+sd}{        \PYGZdq{}Neurons that fire together, wire together\PYGZdq{}}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : numpy.ndarray}
\PYG{l+s+sd}{            Input data of shape (batch\PYGZus{}size, input\PYGZus{}size)}
\PYG{l+s+sd}{        y : numpy.ndarray}
\PYG{l+s+sd}{            Output activations of shape (batch\PYGZus{}size, output\PYGZus{}size)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Basic Hebbian update}
        \PYG{n}{delta\PYGZus{}w} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{y}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply weight decay to prevent unbounded growth}
        \PYG{n}{delta\PYGZus{}w} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decay\PYGZus{}rate} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}
        
        \PYG{c+c1}{\PYGZsh{} Update weights}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{+}\PYG{o}{=} \PYG{n}{delta\PYGZus{}w}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{num\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the network for a specified number of epochs}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : numpy.ndarray}
\PYG{l+s+sd}{            Input data of shape (batch\PYGZus{}size, input\PYGZus{}size)}
\PYG{l+s+sd}{        num\PYGZus{}epochs : int}
\PYG{l+s+sd}{            Number of training epochs}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update weights}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Optional: Apply normalization to stabilize learning}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{1e\PYGZhy{}8}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Print progress}
            \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: Average activation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}weights}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{reshape}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize the learned weights}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        reshape : tuple or None}
\PYG{l+s+sd}{            Reshape dimensions for visualizing weights as images}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{ax} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{axes}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{weight} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                
                \PYG{k}{if} \PYG{n}{reshape} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                    \PYG{n}{weight} \PYG{o}{=} \PYG{n}{weight}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{reshape}\PYG{p}{)}
                    
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{weight}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{19.4 Deep Learning Models as Theories of Cognition}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:deep-learning-models-as-theories-of-cognition}}

\subsection{19.4.1 Using Deep Learning to Test Cognitive Theories}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:using-deep-learning-to-test-cognitive-theories}}
\sphinxAtStartPar
Deep learning models can serve as computational implementations of cognitive theories:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Explicit formalizations}: Converting verbal theories into precise computations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parameter exploration}: Testing hypotheses by manipulating model parameters

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Counterfactual testing}: Exploring alternative mechanisms

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Developmental trajectories}: Studying how learning unfolds over time

\end{itemize}


\subsection{19.4.2 Case Studies in Cognitive Modeling}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:case-studies-in-cognitive-modeling}}
\sphinxAtStartPar
Deep learning has been used to model various cognitive domains:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visual perception}: CNNs as models of object recognition

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Language processing}: Transformers as models of language comprehension

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Decision making}: Reinforcement learning as models of value\sphinxhyphen{}based choice

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory}: Sequence models as models of episodic and working memory

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{VisualCognitiveModel}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    CNN\PYGZhy{}based model of visual object recognition designed to test}
\PYG{l+s+sd}{    cognitive theories about human visual processing}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{with\PYGZus{}recurrence}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{with\PYGZus{}feedback}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the visual cognitive model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        with\PYGZus{}recurrence : bool}
\PYG{l+s+sd}{            Whether to include recurrent connections}
\PYG{l+s+sd}{        with\PYGZus{}feedback : bool}
\PYG{l+s+sd}{            Whether to include feedback connections}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}recurrence} \PYG{o}{=} \PYG{n}{with\PYGZus{}recurrence}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}feedback} \PYG{o}{=} \PYG{n}{with\PYGZus{}feedback}
        
        \PYG{c+c1}{\PYGZsh{} Feedforward pathway (V1\PYGZhy{}like)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feedforward pathway (V2\PYGZhy{}like)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feedforward pathway (V4\PYGZhy{}like)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feedforward pathway (IT\PYGZhy{}like)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv4} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool4} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Recurrent connections}
        \PYG{k}{if} \PYG{n}{with\PYGZus{}recurrence}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Feedback connections}
        \PYG{k}{if} \PYG{n}{with\PYGZus{}feedback}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Readout layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{flatten} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{256} \PYG{o}{*} \PYG{l+m+mi}{4} \PYG{o}{*} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{512}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{512}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 object classes}
        
        \PYG{c+c1}{\PYGZsh{} Save activations for visualization}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{timesteps}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Input images}
\PYG{l+s+sd}{        timesteps : int}
\PYG{l+s+sd}{            Number of timesteps for recurrent processing}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        output : torch.Tensor}
\PYG{l+s+sd}{            Class predictions}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Initial feedforward pass}
        \PYG{n}{x1} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{p1} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool1}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{)}
        
        \PYG{n}{x2} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2}\PYG{p}{(}\PYG{n}{p1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{p2} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool2}\PYG{p}{(}\PYG{n}{x2}\PYG{p}{)}
        
        \PYG{n}{x3} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3}\PYG{p}{(}\PYG{n}{p2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{p3} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool3}\PYG{p}{(}\PYG{n}{x3}\PYG{p}{)}
        
        \PYG{n}{x4} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv4}\PYG{p}{(}\PYG{n}{p3}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{p4} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool4}\PYG{p}{(}\PYG{n}{x4}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Store initial activations}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p1}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p2}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p3}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer4}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p4}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Recurrent and feedback processing}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}recurrence} \PYG{o+ow}{or} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}feedback}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{timesteps} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Store activations for this timestep}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer1\PYGZus{}t}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p1}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer2\PYGZus{}t}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p2}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer3\PYGZus{}t}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p3}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Apply recurrent connections}
                \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}recurrence}\PYG{p}{:}
                    \PYG{n}{p1} \PYG{o}{=} \PYG{n}{p1} \PYG{o}{+} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent1}\PYG{p}{(}\PYG{n}{p1}\PYG{p}{)}\PYG{p}{)}
                    \PYG{n}{p2} \PYG{o}{=} \PYG{n}{p2} \PYG{o}{+} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent2}\PYG{p}{(}\PYG{n}{p2}\PYG{p}{)}\PYG{p}{)}
                    \PYG{n}{p3} \PYG{o}{=} \PYG{n}{p3} \PYG{o}{+} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recurrent3}\PYG{p}{(}\PYG{n}{p3}\PYG{p}{)}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Apply feedback connections}
                \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{with\PYGZus{}feedback}\PYG{p}{:}
                    \PYG{n}{feedback\PYGZus{}3to2} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback3}\PYG{p}{(}\PYG{n}{p3}\PYG{p}{)}
                    \PYG{n}{feedback\PYGZus{}2to1} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{feedback2}\PYG{p}{(}\PYG{n}{p2}\PYG{p}{)}
                    
                    \PYG{c+c1}{\PYGZsh{} Add feedback to earlier representations}
                    \PYG{n}{p2} \PYG{o}{=} \PYG{n}{p2} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{feedback\PYGZus{}3to2}
                    \PYG{n}{p1} \PYG{o}{=} \PYG{n}{p1} \PYG{o}{+} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{feedback\PYGZus{}2to1}
                    
                    \PYG{c+c1}{\PYGZsh{} Update forward pass with feedback influence}
                    \PYG{n}{x2} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv2}\PYG{p}{(}\PYG{n}{p1}\PYG{p}{)}\PYG{p}{)}
                    \PYG{n}{p2} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool2}\PYG{p}{(}\PYG{n}{x2}\PYG{p}{)}
                    
                    \PYG{n}{x3} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv3}\PYG{p}{(}\PYG{n}{p2}\PYG{p}{)}\PYG{p}{)}
                    \PYG{n}{p3} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool3}\PYG{p}{(}\PYG{n}{x3}\PYG{p}{)}
                    
                    \PYG{n}{x4} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv4}\PYG{p}{(}\PYG{n}{p3}\PYG{p}{)}\PYG{p}{)}
                    \PYG{n}{p4} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool4}\PYG{p}{(}\PYG{n}{x4}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Final classification}
        \PYG{n}{flat} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{n}{p4}\PYG{p}{)}
        \PYG{n}{fc1} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{flat}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{fc1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}temporal\PYGZus{}dynamics}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{image}\PYG{p}{,} \PYG{n}{target\PYGZus{}class}\PYG{p}{,} \PYG{n}{timesteps}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Analyze how representation evolves over time due to}
\PYG{l+s+sd}{        recurrent and feedback processing}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        image : torch.Tensor}
\PYG{l+s+sd}{            Input image}
\PYG{l+s+sd}{        target\PYGZus{}class : int}
\PYG{l+s+sd}{            Target class for the image}
\PYG{l+s+sd}{        timesteps : int}
\PYG{l+s+sd}{            Number of timesteps to analyze}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Ensure the model is in evaluation mode}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Forward pass with multiple timesteps}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{timesteps}\PYG{o}{=}\PYG{n}{timesteps}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get class probabilities}
        \PYG{n}{probs} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{target\PYGZus{}prob} \PYG{o}{=} \PYG{n}{probs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{target\PYGZus{}class}\PYG{p}{]}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Visualize how representations change over time}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{timesteps}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{l} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{layer\PYGZus{}name} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{l}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}t}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{layer}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{l}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}
                \PYG{k}{if} \PYG{n}{layer\PYGZus{}name} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Take first image in batch, first channel for visualization}
                    \PYG{n}{act} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{activations}\PYG{p}{[}\PYG{n}{layer\PYGZus{}name}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
                    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{t}\PYG{p}{,} \PYG{n}{l}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{act}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{t}\PYG{p}{,} \PYG{n}{l}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Layer }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{l}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Time }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
                    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{t}\PYG{p}{,} \PYG{n}{l}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot target class probability over time}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}\PYG{p}{,} \PYG{p}{[}\PYG{n}{probs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{target\PYGZus{}class}\PYG{p}{]}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Processing Timestep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Probability of Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{target\PYGZus{}class}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Temporal Dynamics of Recognition}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{probs}
\end{sphinxVerbatim}


\subsection{19.4.3 Comparing Model Behavior to Human Behavior}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:comparing-model-behavior-to-human-behavior}}
\sphinxAtStartPar
A key test of cognitive models is their ability to predict human behavior:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Psychophysical experiments}: Testing if models show similar perceptual biases

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error patterns}: Comparing model and human mistakes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reaction times}: Relating model processing to response latencies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Developmental trajectories}: Comparing learning curves

\end{itemize}


\section{19.5 Neural Representation Comparison Methods}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:neural-representation-comparison-methods}}

\subsection{19.5.1 Representational Similarity Analysis}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:representational-similarity-analysis}}
\sphinxAtStartPar
Representational Similarity Analysis (RSA) is a framework for comparing neural representations across species, methods, and models:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Constructing similarity matrices}: Computing pairwise similarities between activity patterns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computing representational similarity}: Correlating similarity matrices across systems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Significance testing}: Statistical approaches for assessing similarity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visualization techniques}: Visualizing representational spaces

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{stats}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{spearmanr}\PYG{p}{,} \PYG{n}{pearsonr}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{spatial}\PYG{n+nn}{.}\PYG{n+nn}{distance}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{pdist}\PYG{p}{,} \PYG{n}{squareform}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{RepresentationalSimilarityAnalysis}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of Representational Similarity Analysis (RSA)}
\PYG{l+s+sd}{    for comparing neural and model representations}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{distance\PYGZus{}metric}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize RSA}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        distance\PYGZus{}metric : str}
\PYG{l+s+sd}{            Distance metric for computing dissimilarity}
\PYG{l+s+sd}{            Options: \PYGZsq{}correlation\PYGZsq{}, \PYGZsq{}euclidean\PYGZsq{}, \PYGZsq{}cosine\PYGZsq{}}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{distance\PYGZus{}metric} \PYG{o}{=} \PYG{n}{distance\PYGZus{}metric}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}rdm}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{activations}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute Representational Dissimilarity Matrix (RDM)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        activations : numpy.ndarray}
\PYG{l+s+sd}{            Neural/model activations of shape (n\PYGZus{}samples, n\PYGZus{}features)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        rdm : numpy.ndarray}
\PYG{l+s+sd}{            Representational Dissimilarity Matrix of shape (n\PYGZus{}samples, n\PYGZus{}samples)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Compute pairwise distances}
        \PYG{n}{distances} \PYG{o}{=} \PYG{n}{pdist}\PYG{p}{(}\PYG{n}{activations}\PYG{p}{,} \PYG{n}{metric}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{distance\PYGZus{}metric}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert to square form}
        \PYG{n}{rdm} \PYG{o}{=} \PYG{n}{squareform}\PYG{p}{(}\PYG{n}{distances}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{rdm}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}rdms}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{rdm1}\PYG{p}{,} \PYG{n}{rdm2}\PYG{p}{,} \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spearman}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compare two RDMs to quantify representational similarity}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        rdm1 : numpy.ndarray}
\PYG{l+s+sd}{            First RDM of shape (n\PYGZus{}samples, n\PYGZus{}samples)}
\PYG{l+s+sd}{        rdm2 : numpy.ndarray}
\PYG{l+s+sd}{            Second RDM of shape (n\PYGZus{}samples, n\PYGZus{}samples)}
\PYG{l+s+sd}{        method : str}
\PYG{l+s+sd}{            Correlation method (\PYGZsq{}spearman\PYGZsq{} or \PYGZsq{}pearson\PYGZsq{})}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        correlation : float}
\PYG{l+s+sd}{            Correlation coefficient between the two RDMs}
\PYG{l+s+sd}{        p\PYGZus{}value : float}
\PYG{l+s+sd}{            p\PYGZhy{}value for the correlation}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Flatten the upper triangular part of the RDMs (excluding diagonal)}
        \PYG{n}{triu\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{(}\PYG{n}{rdm1}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{rdm1\PYGZus{}flat} \PYG{o}{=} \PYG{n}{rdm1}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
        \PYG{n}{rdm2\PYGZus{}flat} \PYG{o}{=} \PYG{n}{rdm2}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Compute correlation}
        \PYG{k}{if} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spearman}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{correlation}\PYG{p}{,} \PYG{n}{p\PYGZus{}value} \PYG{o}{=} \PYG{n}{spearmanr}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{,} \PYG{n}{rdm2\PYGZus{}flat}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{method} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pearson}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{correlation}\PYG{p}{,} \PYG{n}{p\PYGZus{}value} \PYG{o}{=} \PYG{n}{pearsonr}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{,} \PYG{n}{rdm2\PYGZus{}flat}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Method must be }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{spearman}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ or }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{pearson}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{correlation}\PYG{p}{,} \PYG{n}{p\PYGZus{}value}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}rdm}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{rdm}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Representational Dissimilarity Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize a Representational Dissimilarity Matrix}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        rdm : numpy.ndarray}
\PYG{l+s+sd}{            RDM of shape (n\PYGZus{}samples, n\PYGZus{}samples)}
\PYG{l+s+sd}{        labels : list or None}
\PYG{l+s+sd}{            Labels for the samples}
\PYG{l+s+sd}{        title : str}
\PYG{l+s+sd}{            Title for the plot}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{rdm}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dissimilarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{n}{title}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}comparison}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{rdm1}\PYG{p}{,} \PYG{n}{rdm2}\PYG{p}{,} \PYG{n}{labels1}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labels2}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brain}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RDM Comparison}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize a comparison between two RDMs}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        rdm1 : numpy.ndarray}
\PYG{l+s+sd}{            First RDM}
\PYG{l+s+sd}{        rdm2 : numpy.ndarray}
\PYG{l+s+sd}{            Second RDM}
\PYG{l+s+sd}{        labels1 : str}
\PYG{l+s+sd}{            Label for the first RDM}
\PYG{l+s+sd}{        labels2 : str}
\PYG{l+s+sd}{            Label for the second RDM}
\PYG{l+s+sd}{        title : str}
\PYG{l+s+sd}{            Title for the plot}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Flatten upper triangular part}
        \PYG{n}{triu\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{(}\PYG{n}{rdm1}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{rdm1\PYGZus{}flat} \PYG{o}{=} \PYG{n}{rdm1}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
        \PYG{n}{rdm2\PYGZus{}flat} \PYG{o}{=} \PYG{n}{rdm2}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Compute correlation}
        \PYG{n}{correlation}\PYG{p}{,} \PYG{n}{p\PYGZus{}value} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{compare\PYGZus{}rdms}\PYG{p}{(}\PYG{n}{rdm1}\PYG{p}{,} \PYG{n}{rdm2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create scatter plot}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{,} \PYG{n}{rdm2\PYGZus{}flat}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{labels1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Dissimilarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{labels2}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Dissimilarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{title}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Correlation: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{correlation}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ (p=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{p\PYGZus{}value}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3g}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add regression line}
        \PYG{n}{z} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{polyfit}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{,} \PYG{n}{rdm2\PYGZus{}flat}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{p} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{poly1d}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,} 
                \PYG{n}{p}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{rdm1\PYGZus{}flat}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} 
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{mds\PYGZus{}visualization}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{rdm}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MDS Visualization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize the representational space using Multi\PYGZhy{}Dimensional Scaling (MDS)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        rdm : numpy.ndarray}
\PYG{l+s+sd}{            RDM of shape (n\PYGZus{}samples, n\PYGZus{}samples)}
\PYG{l+s+sd}{        labels : list or None}
\PYG{l+s+sd}{            Labels for the samples}
\PYG{l+s+sd}{        title : str}
\PYG{l+s+sd}{            Title for the plot}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{manifold}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{MDS}
        
        \PYG{c+c1}{\PYGZsh{} Create MDS model}
        \PYG{n}{mds} \PYG{o}{=} \PYG{n}{MDS}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{dissimilarity}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precomputed}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Fit MDS model to RDM}
        \PYG{n}{points} \PYG{o}{=} \PYG{n}{mds}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{rdm}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot results}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{n}{label}\PYG{p}{,} \PYG{p}{(}\PYG{n}{points}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{points}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} 
                            \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{n}{title}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{points}
\end{sphinxVerbatim}


\subsection{19.5.2 Neural Encoding and Decoding Models}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:neural-encoding-and-decoding-models}}
\sphinxAtStartPar
Neural encoding and decoding create direct mappings between brain activity and model representations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Encoding models}: Predicting neural responses from model activations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Decoding models}: Predicting stimuli from neural responses

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cross\sphinxhyphen{}validated prediction}: Assessing generalization of encoding/decoding models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature importance analysis}: Identifying critical dimensions of the representation

\end{itemize}


\subsection{19.5.3 Canonical Correlation Analysis}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:canonical-correlation-analysis}}
\sphinxAtStartPar
Canonical Correlation Analysis (CCA) finds shared dimensions between neural and model representations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Canonical variates}: Identifying maximally correlated dimensions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Shared variance}: Quantifying overlap between representations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality analysis}: Determining the number of meaningful shared dimensions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stimulus associations}: Relating shared dimensions to stimulus properties

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{cross\PYGZus{}decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{CCA}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CanonicalCorrelationAnalyzer}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of Canonical Correlation Analysis (CCA)}
\PYG{l+s+sd}{    for comparing neural and model representations}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize CCA}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}components : int}
\PYG{l+s+sd}{            Number of canonical components to extract}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components} \PYG{o}{=} \PYG{n}{n\PYGZus{}components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cca} \PYG{o}{=} \PYG{n}{CCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations} \PYG{o}{=} \PYG{k+kc}{None}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{fit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Fit CCA on two sets of features}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X : numpy.ndarray}
\PYG{l+s+sd}{            First feature set (e.g., neural data) of shape (n\PYGZus{}samples, n\PYGZus{}features\PYGZus{}X)}
\PYG{l+s+sd}{        Y : numpy.ndarray}
\PYG{l+s+sd}{            Second feature set (e.g., model data) of shape (n\PYGZus{}samples, n\PYGZus{}features\PYGZus{}Y)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Fit CCA}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cca}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transform data to canonical space}
        \PYG{n}{X\PYGZus{}c}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cca}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute correlations between canonical variates}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} 
                                     \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{X\PYGZus{}c}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{transform}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Transform data to canonical space}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X : numpy.ndarray}
\PYG{l+s+sd}{            First feature set}
\PYG{l+s+sd}{        Y : numpy.ndarray}
\PYG{l+s+sd}{            Second feature set}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}c : numpy.ndarray}
\PYG{l+s+sd}{            First feature set in canonical space}
\PYG{l+s+sd}{        Y\PYGZus{}c : numpy.ndarray}
\PYG{l+s+sd}{            Second feature set in canonical space}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cca}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}correlations}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize canonical correlations}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        labels : list or None}
\PYG{l+s+sd}{            Labels for the components}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CCA must be fit before visualizing correlations}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Canonical Component}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Canonical Correlations}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{labels}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}canonical\PYGZus{}variates}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}c}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c}\PYG{p}{,} \PYG{n}{sample\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize the first two canonical variates}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X\PYGZus{}c : numpy.ndarray}
\PYG{l+s+sd}{            First feature set in canonical space}
\PYG{l+s+sd}{        Y\PYGZus{}c : numpy.ndarray}
\PYG{l+s+sd}{            Second feature set in canonical space}
\PYG{l+s+sd}{        sample\PYGZus{}labels : list or None}
\PYG{l+s+sd}{            Labels for the samples}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{X\PYGZus{}c}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{Y\PYGZus{}c}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Need at least 2 components for visualization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot first set of canonical variates}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{80}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{First Canonical Variate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Second Canonical Variate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Representation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot second set of canonical variates}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{Y\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{80}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{First Canonical Variate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Second Canonical Variate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Representation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{sample\PYGZus{}labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{sample\PYGZus{}labels}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{n}{label}\PYG{p}{,} \PYG{p}{(}\PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
                \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{annotate}\PYG{p}{(}\PYG{n}{label}\PYG{p}{,} \PYG{p}{(}\PYG{n}{Y\PYGZus{}c}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{correlation\PYGZus{}significance}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{,} \PYG{n}{n\PYGZus{}permutations}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Perform permutation test to assess significance of canonical correlations}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        X : numpy.ndarray}
\PYG{l+s+sd}{            First feature set}
\PYG{l+s+sd}{        Y : numpy.ndarray}
\PYG{l+s+sd}{            Second feature set}
\PYG{l+s+sd}{        n\PYGZus{}permutations : int}
\PYG{l+s+sd}{            Number of permutations for the test}
\PYG{l+s+sd}{        alpha : float}
\PYG{l+s+sd}{            Significance level}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        p\PYGZus{}values : numpy.ndarray}
\PYG{l+s+sd}{            p\PYGZhy{}values for each canonical correlation}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CCA must be fit before testing significance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize array to store permutation correlations}
        \PYG{n}{perm\PYGZus{}correlations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}permutations}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Original sample size}
        \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Perform permutation test}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}permutations}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Permute samples in Y}
            \PYG{n}{perm\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{permutation}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
            \PYG{n}{Y\PYGZus{}perm} \PYG{o}{=} \PYG{n}{Y}\PYG{p}{[}\PYG{n}{perm\PYGZus{}idx}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Fit CCA on permuted data}
            \PYG{n}{cca\PYGZus{}perm} \PYG{o}{=} \PYG{n}{CCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
            \PYG{n}{cca\PYGZus{}perm}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y\PYGZus{}perm}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Transform data to canonical space}
            \PYG{n}{X\PYGZus{}c\PYGZus{}perm}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c\PYGZus{}perm} \PYG{o}{=} \PYG{n}{cca\PYGZus{}perm}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y\PYGZus{}perm}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Compute correlations}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{perm\PYGZus{}correlations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{X\PYGZus{}c\PYGZus{}perm}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y\PYGZus{}c\PYGZus{}perm}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Compute p\PYGZhy{}values (proportion of permutation correlations \PYGZgt{}= observed)}
        \PYG{n}{p\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{p\PYGZus{}values}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{perm\PYGZus{}correlations}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Visualize results}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}components}\PYG{p}{,} \PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{perm\PYGZus{}correlations}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correlations}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Component }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{: p=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{p\PYGZus{}values}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correlation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{p\PYGZus{}values}
\end{sphinxVerbatim}


\section{19.6 The Impact of Deep Learning on Cognitive Neuroscience}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:the-impact-of-deep-learning-on-cognitive-neuroscience}}

\subsection{19.6.1 New Frameworks for Understanding Brain Function}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:new-frameworks-for-understanding-brain-function}}
\sphinxAtStartPar
Deep learning has provided cognitive neuroscience with new conceptual tools:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Normative theories}: Explaining neural mechanisms as optimizations for specific objectives

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Learning dynamics}: Understanding neural development through gradient\sphinxhyphen{}based learning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distributed representations}: Conceptualizing neural coding as distributed patterns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{End\sphinxhyphen{}to\sphinxhyphen{}end optimization}: Viewing brain regions as components in differentiable systems

\end{itemize}


\subsection{19.6.2 Tools for Neural Data Analysis}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:tools-for-neural-data-analysis}}
\sphinxAtStartPar
Beyond conceptual advances, deep learning has provided practical tools for neuroscience:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neural decoding}: Better extraction of information from brain recordings

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality reduction}: Discovering meaningful latent structures in neural data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generative modeling}: Creating detailed models of neural activity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Automated analysis}: Processing and classifying large neural datasets

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LatentDynamicsModel}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Neural latent dynamics model for analyzing neural population activity}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{nonlinearity}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tanh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the latent dynamics model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        n\PYGZus{}neurons : int}
\PYG{l+s+sd}{            Number of neurons in the population}
\PYG{l+s+sd}{        latent\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimensionality of the latent space}
\PYG{l+s+sd}{        nonlinearity : str}
\PYG{l+s+sd}{            Nonlinearity to use (\PYGZsq{}relu\PYGZsq{}, \PYGZsq{}tanh\PYGZsq{}, or \PYGZsq{}sigmoid\PYGZsq{})}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{latent\PYGZus{}dim} \PYG{o}{=} \PYG{n}{latent\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Encoder: neural activity \PYGZhy{}\PYGZgt{} latent variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim} \PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Mean and log\PYGZhy{}variance}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Latent dynamics model}
        \PYG{k}{if} \PYG{n}{nonlinearity} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics\PYGZus{}nonlinearity} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{nonlinearity} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tanh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics\PYGZus{}nonlinearity} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Tanh}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n}{nonlinearity} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sigmoid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics\PYGZus{}nonlinearity} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sigmoid}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Nonlinearity must be }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{relu}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{tanh}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, or }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{sigmoid}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics\PYGZus{}nonlinearity}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Decoder: latent variables \PYGZhy{}\PYGZgt{} neural activity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encode}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Encode neural activity to latent variables}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Neural activity of shape (batch\PYGZus{}size, n\PYGZus{}neurons)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        mean : torch.Tensor}
\PYG{l+s+sd}{            Mean of latent distribution}
\PYG{l+s+sd}{        logvar : torch.Tensor}
\PYG{l+s+sd}{            Log\PYGZhy{}variance of latent distribution}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{h} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{chunk}\PYG{p}{(}\PYG{n}{h}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reparameterize}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Reparameterization trick for sampling from latent distribution}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        mean : torch.Tensor}
\PYG{l+s+sd}{            Mean of latent distribution}
\PYG{l+s+sd}{        logvar : torch.Tensor}
\PYG{l+s+sd}{            Log\PYGZhy{}variance of latent distribution}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        z : torch.Tensor}
\PYG{l+s+sd}{            Sampled latent variables}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{std} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{logvar}\PYG{p}{)}
        \PYG{n}{eps} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{std}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mean} \PYG{o}{+} \PYG{n}{eps} \PYG{o}{*} \PYG{n}{std}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decode}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{z}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Decode latent variables to neural activity}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        z : torch.Tensor}
\PYG{l+s+sd}{            Latent variables of shape (batch\PYGZus{}size, latent\PYGZus{}dim)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x\PYGZus{}recon : torch.Tensor}
\PYG{l+s+sd}{            Reconstructed neural activity}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Neural activity of shape (batch\PYGZus{}size, n\PYGZus{}neurons)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x\PYGZus{}recon : torch.Tensor}
\PYG{l+s+sd}{            Reconstructed neural activity}
\PYG{l+s+sd}{        mean : torch.Tensor}
\PYG{l+s+sd}{            Mean of latent distribution}
\PYG{l+s+sd}{        logvar : torch.Tensor}
\PYG{l+s+sd}{            Log\PYGZhy{}variance of latent distribution}
\PYG{l+s+sd}{        z : torch.Tensor}
\PYG{l+s+sd}{            Sampled latent variables}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{z} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reparameterize}\PYG{p}{(}\PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}recon} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x\PYGZus{}recon}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{,} \PYG{n}{z}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}next\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict the next state in the latent space}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Current neural activity}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x\PYGZus{}next : torch.Tensor}
\PYG{l+s+sd}{            Predicted next neural activity}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{mean}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{z\PYGZus{}next} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dynamics}\PYG{p}{(}\PYG{n}{mean}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}next} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{z\PYGZus{}next}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x\PYGZus{}next}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{loss\PYGZus{}function}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x\PYGZus{}recon}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{,} \PYG{n}{beta}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute the VAE loss function}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x\PYGZus{}recon : torch.Tensor}
\PYG{l+s+sd}{            Reconstructed neural activity}
\PYG{l+s+sd}{        x : torch.Tensor}
\PYG{l+s+sd}{            Original neural activity}
\PYG{l+s+sd}{        mean : torch.Tensor}
\PYG{l+s+sd}{            Mean of latent distribution}
\PYG{l+s+sd}{        logvar : torch.Tensor}
\PYG{l+s+sd}{            Log\PYGZhy{}variance of latent distribution}
\PYG{l+s+sd}{        beta : float}
\PYG{l+s+sd}{            Weight of the KL divergence term}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        loss : torch.Tensor}
\PYG{l+s+sd}{            Total loss}
\PYG{l+s+sd}{        recon\PYGZus{}loss : torch.Tensor}
\PYG{l+s+sd}{            Reconstruction loss}
\PYG{l+s+sd}{        kl\PYGZus{}loss : torch.Tensor}
\PYG{l+s+sd}{            KL divergence loss}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Reconstruction loss (mean squared error)}
        \PYG{n}{recon\PYGZus{}loss} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{mse\PYGZus{}loss}\PYG{p}{(}\PYG{n}{x\PYGZus{}recon}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{reduction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} KL divergence loss}
        \PYG{n}{kl\PYGZus{}loss} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{logvar} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}\PYG{o}{.}\PYG{n}{pow}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{logvar}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Total loss}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{recon\PYGZus{}loss} \PYG{o}{+} \PYG{n}{beta} \PYG{o}{*} \PYG{n}{kl\PYGZus{}loss}
        
        \PYG{k}{return} \PYG{n}{loss}\PYG{p}{,} \PYG{n}{recon\PYGZus{}loss}\PYG{p}{,} \PYG{n}{kl\PYGZus{}loss}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}latent\PYGZus{}space}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Space Visualization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize the latent space}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        data : torch.Tensor}
\PYG{l+s+sd}{            Neural activity data}
\PYG{l+s+sd}{        labels : numpy.ndarray or None}
\PYG{l+s+sd}{            Labels for color\PYGZhy{}coding points}
\PYG{l+s+sd}{        title : str}
\PYG{l+s+sd}{            Plot title}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Switch to evaluation mode}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Encode data to get latent representations}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mean}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
            \PYG{n}{z} \PYG{o}{=} \PYG{n}{mean}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create scatter plot}
        \PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{z}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{3}\PYG{p}{:}
            \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
            \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{labels} \PYG{o}{==} \PYG{n}{label}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
                    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{z}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{label}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{z}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
                
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{)}
            
            \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{label} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{labels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{labels} \PYG{o}{==} \PYG{n}{label}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
                    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{z}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{label}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{z}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
                
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{n}{title}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{labels} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
            
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{z}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}trajectory}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data\PYGZus{}sequence}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neural Trajectory in Latent Space}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize a neural trajectory in the latent space}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        data\PYGZus{}sequence : torch.Tensor}
\PYG{l+s+sd}{            Sequence of neural activity patterns}
\PYG{l+s+sd}{        title : str}
\PYG{l+s+sd}{            Plot title}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Switch to evaluation mode}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Encode sequence to get latent representations}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{latent\PYGZus{}sequence} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{data\PYGZus{}sequence}\PYG{p}{:}
                \PYG{n}{mean}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{latent\PYGZus{}sequence}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mean}\PYG{o}{.}\PYG{n}{squeeze}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{latent\PYGZus{}sequence} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create 3D plot for trajectory}
        \PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{latent\PYGZus{}sequence}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{3}\PYG{p}{:}
            \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Plot trajectory}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} 
                   \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Highlight start and end points}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} 
                      \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Start}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} 
                      \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{End}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Plot trajectory}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
                   \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Highlight start and end points}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} 
                      \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Start}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{latent\PYGZus{}sequence}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} 
                      \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{End}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Latent Dim 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{n}{title}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{latent\PYGZus{}sequence}
\end{sphinxVerbatim}


\subsection{19.6.3 Generating New Hypotheses}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:generating-new-hypotheses}}
\sphinxAtStartPar
Deep learning models can suggest novel hypotheses about brain function:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Optimization principles}: What objectives drive neural organization?

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Architectural principles}: What network structures enable robust computation?

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Learning mechanisms}: How does the brain learn efficiently from experience?

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature representations}: What information is encoded in neural activity?

\end{itemize}


\section{19.7 Practical Exercise: Comparing Deep Networks and Brain Representations}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:practical-exercise-comparing-deep-networks-and-brain-representations}}
\sphinxAtStartPar
In this exercise, we’ll demonstrate how to compare representations between a deep neural network and fMRI brain activity patterns in response to the same visual stimuli.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{stats}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{spearmanr}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}fmri\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{n\PYGZus{}voxels}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{n\PYGZus{}roi}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate fMRI data for a visual experiment}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    n\PYGZus{}stimuli : int}
\PYG{l+s+sd}{        Number of stimuli (images)}
\PYG{l+s+sd}{    n\PYGZus{}voxels : int}
\PYG{l+s+sd}{        Total number of voxels}
\PYG{l+s+sd}{    n\PYGZus{}roi : int}
\PYG{l+s+sd}{        Number of brain regions (ROIs)}
\PYG{l+s+sd}{    noise\PYGZus{}level : float}
\PYG{l+s+sd}{        Level of noise to add}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    fmri\PYGZus{}data : numpy.ndarray}
\PYG{l+s+sd}{        fMRI response patterns of shape (n\PYGZus{}stimuli, n\PYGZus{}voxels)}
\PYG{l+s+sd}{    roi\PYGZus{}masks : list}
\PYG{l+s+sd}{        Binary masks for each ROI}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create random fMRI patterns}
    \PYG{n}{fmri\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{n\PYGZus{}voxels}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create ROI masks (which voxels belong to which brain region)}
    \PYG{n}{voxels\PYGZus{}per\PYGZus{}roi} \PYG{o}{=} \PYG{n}{n\PYGZus{}voxels} \PYG{o}{/}\PYG{o}{/} \PYG{n}{n\PYGZus{}roi}
    \PYG{n}{roi\PYGZus{}masks} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}roi}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create binary mask for this ROI}
        \PYG{n}{mask} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}voxels}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}
        \PYG{n}{start\PYGZus{}idx} \PYG{o}{=} \PYG{n}{r} \PYG{o}{*} \PYG{n}{voxels\PYGZus{}per\PYGZus{}roi}
        \PYG{n}{end\PYGZus{}idx} \PYG{o}{=} \PYG{p}{(}\PYG{n}{r} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{voxels\PYGZus{}per\PYGZus{}roi} \PYG{k}{if} \PYG{n}{r} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}roi} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{n}{n\PYGZus{}voxels}
        \PYG{n}{mask}\PYG{p}{[}\PYG{n}{start\PYGZus{}idx}\PYG{p}{:}\PYG{n}{end\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{k+kc}{True}
        \PYG{n}{roi\PYGZus{}masks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{mask}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate patterns for this ROI}
        \PYG{c+c1}{\PYGZsh{} We\PYGZsq{}ll make each ROI sensitive to different stimulus features}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create a pattern that depends on stimulus index in different ways for each ROI}
            \PYG{k}{if} \PYG{n}{r} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Early visual (e.g., V1) \PYGZhy{} sensitive to low\PYGZhy{}level features}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{5.0}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{3.0}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{r} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Mid\PYGZhy{}level visual (e.g., V4) \PYGZhy{} sensitive to shapes}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{8.0}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{2.0}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{r} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Higher visual (e.g., LOC) \PYGZhy{} sensitive to objects}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{10.0} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{2.5}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Object category (e.g., IT) \PYGZhy{} sensitive to categories}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{5.0}  \PYG{c+c1}{\PYGZsh{} 5 categories}
                
            \PYG{n}{fmri\PYGZus{}data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pattern}
    
    \PYG{c+c1}{\PYGZsh{} Add noise}
    \PYG{n}{fmri\PYGZus{}data} \PYG{o}{+}\PYG{o}{=} \PYG{n}{noise\PYGZus{}level} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{o}{*}\PYG{n}{fmri\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fmri\PYGZus{}data}\PYG{p}{,} \PYG{n}{roi\PYGZus{}masks}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}cnn\PYGZus{}activations}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{units\PYGZus{}per\PYGZus{}layer}\PYG{o}{=}\PYG{l+m+mi}{250}\PYG{p}{,} \PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate CNN activations for the same stimuli}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    n\PYGZus{}stimuli : int}
\PYG{l+s+sd}{        Number of stimuli (images)}
\PYG{l+s+sd}{    n\PYGZus{}layers : int}
\PYG{l+s+sd}{        Number of CNN layers}
\PYG{l+s+sd}{    units\PYGZus{}per\PYGZus{}layer : int}
\PYG{l+s+sd}{        Number of units per layer}
\PYG{l+s+sd}{    noise\PYGZus{}level : float}
\PYG{l+s+sd}{        Level of noise to add}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    cnn\PYGZus{}activations : dict}
\PYG{l+s+sd}{        Dictionary mapping layer names to activation patterns}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{cnn\PYGZus{}activations} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{l} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create activations for this layer}
        \PYG{n}{layer\PYGZus{}name} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{layer}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{l}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{n}{activations} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{units\PYGZus{}per\PYGZus{}layer}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create activations that depend on stimulus index in different ways for each layer}
            \PYG{k}{if} \PYG{n}{l} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Conv1 \PYGZhy{} sensitive to edges}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{5.0}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{3.0}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{l} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Conv2 \PYGZhy{} sensitive to textures}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{7.0}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{2.0}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{l} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Conv3 \PYGZhy{} sensitive to parts}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{i} \PYG{o}{/} \PYG{l+m+mf}{4.0} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Conv4 \PYGZhy{} sensitive to objects}
                \PYG{n}{pattern} \PYG{o}{=} \PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{5.0}  \PYG{c+c1}{\PYGZsh{} 5 categories}
                
            \PYG{n}{activations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pattern} \PYG{o}{+} \PYG{n}{noise\PYGZus{}level} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{units\PYGZus{}per\PYGZus{}layer}\PYG{p}{)}
        
        \PYG{n}{cnn\PYGZus{}activations}\PYG{p}{[}\PYG{n}{layer\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{activations}
    
    \PYG{k}{return} \PYG{n}{cnn\PYGZus{}activations}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}rdms}\PYG{p}{(}\PYG{n}{data\PYGZus{}dict}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute Representational Dissimilarity Matrices (RDMs) for different regions/layers}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    data\PYGZus{}dict : dict}
\PYG{l+s+sd}{        Dictionary mapping region/layer names to activation patterns}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    rdms : dict}
\PYG{l+s+sd}{        Dictionary mapping region/layer names to RDMs}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{rdms} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{data} \PYG{o+ow}{in} \PYG{n}{data\PYGZus{}dict}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Compute pairwise correlation distances}
        \PYG{n}{n\PYGZus{}stimuli} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{rdm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{,} \PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} 1 \PYGZhy{} correlation as a distance metric}
                \PYG{n}{corr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{data}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
                \PYG{n}{dist} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{corr}
                \PYG{n}{rdm}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dist}
                \PYG{n}{rdm}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dist}
        
        \PYG{n}{rdms}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{rdm}
    
    \PYG{k}{return} \PYG{n}{rdms}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compare\PYGZus{}representations}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdms}\PYG{p}{,} \PYG{n}{model\PYGZus{}rdms}\PYG{p}{,} \PYG{n}{roi\PYGZus{}names}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{layer\PYGZus{}names}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compare brain and model representations}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    brain\PYGZus{}rdms : dict}
\PYG{l+s+sd}{        Dictionary mapping ROI names to brain RDMs}
\PYG{l+s+sd}{    model\PYGZus{}rdms : dict}
\PYG{l+s+sd}{        Dictionary mapping layer names to model RDMs}
\PYG{l+s+sd}{    roi\PYGZus{}names : list or None}
\PYG{l+s+sd}{        Names of brain ROIs}
\PYG{l+s+sd}{    layer\PYGZus{}names : list or None}
\PYG{l+s+sd}{        Names of model layers}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    similarity\PYGZus{}matrix : numpy.ndarray}
\PYG{l+s+sd}{        Matrix of correlations between brain ROIs and model layers}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{roi\PYGZus{}names} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{roi\PYGZus{}names} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdms}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{layer\PYGZus{}names} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{layer\PYGZus{}names} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{model\PYGZus{}rdms}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{n\PYGZus{}rois} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}layers} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}
    
    \PYG{n}{similarity\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}rois}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{roi} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{brain\PYGZus{}rdm} \PYG{o}{=} \PYG{n}{brain\PYGZus{}rdms}\PYG{p}{[}\PYG{n}{roi}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Extract upper triangular part (excluding diagonal)}
        \PYG{n}{triu\PYGZus{}indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{triu\PYGZus{}indices\PYGZus{}from}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdm}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{brain\PYGZus{}rdm\PYGZus{}triu} \PYG{o}{=} \PYG{n}{brain\PYGZus{}rdm}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{model\PYGZus{}rdm} \PYG{o}{=} \PYG{n}{model\PYGZus{}rdms}\PYG{p}{[}\PYG{n}{layer}\PYG{p}{]}
            \PYG{n}{model\PYGZus{}rdm\PYGZus{}triu} \PYG{o}{=} \PYG{n}{model\PYGZus{}rdm}\PYG{p}{[}\PYG{n}{triu\PYGZus{}indices}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Compute Spearman correlation between RDMs}
            \PYG{n}{corr}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{spearmanr}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdm\PYGZus{}triu}\PYG{p}{,} \PYG{n}{model\PYGZus{}rdm\PYGZus{}triu}\PYG{p}{)}
            \PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{corr}
    
    \PYG{k}{return} \PYG{n}{similarity\PYGZus{}matrix}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Main function to run the analysis}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1. Simulate brain fMRI data}
    \PYG{n}{n\PYGZus{}stimuli} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Simulating fMRI data...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{fmri\PYGZus{}data}\PYG{p}{,} \PYG{n}{roi\PYGZus{}masks} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}fmri\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{o}{=}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Create brain ROI data dictionary}
    \PYG{n}{brain\PYGZus{}data} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{roi\PYGZus{}names} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{V4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LOC}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IT}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{,} \PYG{n}{roi\PYGZus{}masks}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{brain\PYGZus{}data}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{fmri\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{mask}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} 3. Simulate CNN activations}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Simulating CNN activations...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{cnn\PYGZus{}activations} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}cnn\PYGZus{}activations}\PYG{p}{(}\PYG{n}{n\PYGZus{}stimuli}\PYG{o}{=}\PYG{n}{n\PYGZus{}stimuli}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 4. Compute RDMs for brain ROIs and CNN layers}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Computing RDMs...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{brain\PYGZus{}rdms} \PYG{o}{=} \PYG{n}{compute\PYGZus{}rdms}\PYG{p}{(}\PYG{n}{brain\PYGZus{}data}\PYG{p}{)}
    \PYG{n}{model\PYGZus{}rdms} \PYG{o}{=} \PYG{n}{compute\PYGZus{}rdms}\PYG{p}{(}\PYG{n}{cnn\PYGZus{}activations}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 5. Compare representations}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Comparing representations...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{similarity\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{compare\PYGZus{}representations}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdms}\PYG{p}{,} \PYG{n}{model\PYGZus{}rdms}\PYG{p}{,} \PYG{n}{roi\PYGZus{}names}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 6. Visualize results}
    \PYG{n}{layer\PYGZus{}names} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{cnn\PYGZus{}activations}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Representational Similarity (Spearman ρ)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CNN Layers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brain ROIs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brain\PYGZhy{}CNN Representational Similarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{layer\PYGZus{}names}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{roi\PYGZus{}names}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add text annotations}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} 
                    \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{white}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.5} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 7. Visualize RDMs}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot brain RDMs}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{brain\PYGZus{}rdms}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Brain: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dissimilarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot model RDMs}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{layer\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{5}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{model\PYGZus{}rdms}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CNN: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dissimilarity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 8. Find the best matching layer for each ROI}
    \PYG{n}{best\PYGZus{}layers} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{roi} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{roi\PYGZus{}names}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{best\PYGZus{}layer\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{best\PYGZus{}layer} \PYG{o}{=} \PYG{n}{layer\PYGZus{}names}\PYG{p}{[}\PYG{n}{best\PYGZus{}layer\PYGZus{}idx}\PYG{p}{]}
        \PYG{n}{best\PYGZus{}corr} \PYG{o}{=} \PYG{n}{similarity\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{best\PYGZus{}layer\PYGZus{}idx}\PYG{p}{]}
        \PYG{n}{best\PYGZus{}layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{roi}\PYG{p}{,} \PYG{n}{best\PYGZus{}layer}\PYG{p}{,} \PYG{n}{best\PYGZus{}corr}\PYG{p}{)}\PYG{p}{)}
        
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Best matching CNN layer for each brain ROI:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{layer}\PYG{p}{,} \PYG{n}{corr} \PYG{o+ow}{in} \PYG{n}{best\PYGZus{}layers}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{roi}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (ρ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{corr}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}\PYGZus{}main\PYGZus{}\PYGZus{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{n}{main}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{19.8 Chapter Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:chapter-take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Cognitive neuroscience and deep learning have a bidirectional relationship, with each field informing the other

\item {} 
\sphinxAtStartPar
Key cognitive principles like attention, hierarchical processing, and predictive coding have inspired advances in deep learning architectures

\item {} 
\sphinxAtStartPar
Incorporating cognitive constraints and inductive biases can improve deep learning model performance and generalization

\item {} 
\sphinxAtStartPar
Deep learning models serve as computational theories of cognition, generating testable predictions about brain function

\item {} 
\sphinxAtStartPar
Methods like RSA, encoding models, and CCA enable direct comparisons between neural and artificial representations

\item {} 
\sphinxAtStartPar
Deep learning has provided new frameworks and tools for understanding and analyzing brain function

\item {} 
\sphinxAtStartPar
The convergence of these fields promises advances in both artificial intelligence and our understanding of human cognition

\end{itemize}


\section{19.9 Further Reading}
\label{\detokenize{part6/ch19_cognitive_neuro_dl:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Kriegeskorte, N., \& Douglas, P. K. (2018). Cognitive computational neuroscience. \sphinxstyleemphasis{Nature Neuroscience, 21}(9), 1148\sphinxhyphen{}1160.

\item {} 
\sphinxAtStartPar
Richards, B. A., et al. (2019). A deep learning framework for neuroscience. \sphinxstyleemphasis{Nature Neuroscience, 22}(11), 1761\sphinxhyphen{}1770.

\item {} 
\sphinxAtStartPar
Yamins, D. L., \& DiCarlo, J. J. (2016). Using goal\sphinxhyphen{}driven deep learning models to understand sensory cortex. \sphinxstyleemphasis{Nature Neuroscience, 19}(3), 356\sphinxhyphen{}365.

\item {} 
\sphinxAtStartPar
Saxe, A., Nelli, S., \& Summerfield, C. (2021). If deep learning is the answer, what is the question? \sphinxstyleemphasis{Nature Reviews Neuroscience, 22}(1), 55\sphinxhyphen{}67.

\item {} 
\sphinxAtStartPar
Kietzmann, T. C., McClure, P., \& Kriegeskorte, N. (2019). Deep neural networks in computational neuroscience. \sphinxstyleemphasis{Oxford Research Encyclopedia of Neuroscience}.

\item {} 
\sphinxAtStartPar
Naselaris, T., et al. (2021). Cognitive computational neuroscience: A normative theory of brain function. \sphinxstyleemphasis{Nature Neuroscience, 24}(2), 291\sphinxhyphen{}306.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 20: Case Studies in NeuroAI}
\label{\detokenize{part6/ch20_case_studies:chapter-20-case-studies-in-neuroai}}\label{\detokenize{part6/ch20_case_studies::doc}}

\section{Chapter Goals}
\label{\detokenize{part6/ch20_case_studies:chapter-goals}}
\sphinxAtStartPar
After completing this chapter, you will be able to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Analyze real\sphinxhyphen{}world applications where neuroscience has successfully informed AI development

\item {} 
\sphinxAtStartPar
Evaluate the practical benefits of incorporating neuroscience principles into AI systems

\item {} 
\sphinxAtStartPar
Identify common patterns and successful strategies across different NeuroAI projects

\item {} 
\sphinxAtStartPar
Apply lessons from case studies to your own research or development projects

\item {} 
\sphinxAtStartPar
Understand the specific challenges and solutions in translating neuroscience insights to AI implementations

\item {} 
\sphinxAtStartPar
Recognize key success factors for interdisciplinary collaboration between neuroscience and AI

\end{itemize}

\begin{sphinxadmonition}{note}{Note:}
\sphinxAtStartPar
This chapter features interactive examples to help you explore key concepts. Click the “launch binder” button at the top of the page or access the {\hyperref[\detokenize{part6/ch20_interactive::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{interactive notebook}}}} to experiment with:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Interactive PredNet visualization

\item {} 
\sphinxAtStartPar
Prioritized Experience Replay simulation

\item {} 
\sphinxAtStartPar
Vision Transformer attention mechanism

\item {} 
\sphinxAtStartPar
Interactive glossary with neural\sphinxhyphen{}AI connections

\end{itemize}

\sphinxAtStartPar
For an enhanced learning experience, we’ve also integrated {\hyperref[\detokenize{part6/jupyter_ai_demo::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{Jupyter AI assistance}}}} to help you generate code, get explanations, and create visualizations based on the case studies.
\end{sphinxadmonition}


\section{20.1 Introduction: From Theory to Practice}
\label{\detokenize{part6/ch20_case_studies:introduction-from-theory-to-practice}}
\sphinxAtStartPar
Throughout this handbook, we’ve explored the theoretical foundations of both neuroscience and artificial intelligence, examining how these fields inform and enrich each other. This chapter shifts our focus to real\sphinxhyphen{}world implementations, presenting detailed case studies that demonstrate how neuroscience principles have been successfully translated into practical AI systems.

\sphinxAtStartPar
These case studies represent the cutting edge of NeuroAI—where theory meets application, where biological insights drive technological innovation, and where interdisciplinary collaboration yields solutions that neither field could achieve alone. By examining these concrete examples, we gain valuable insights into the practical challenges and benefits of neuroscience\sphinxhyphen{}inspired AI approaches.


\section{20.2 Case Study: Deep Predictive Coding Networks}
\label{\detokenize{part6/ch20_case_studies:case-study-deep-predictive-coding-networks}}

\subsection{20.2.1 Background and Motivation}
\label{\detokenize{part6/ch20_case_studies:background-and-motivation}}
\sphinxAtStartPar
Predictive coding is a neuroscience theory proposing that the brain constantly generates predictions about incoming sensory information and updates its internal models based on prediction errors. This first case study examines how predictive coding has been implemented in deep learning architectures to improve robustness and efficiency.


\subsection{20.2.2 Implementation: PredNet Architecture}
\label{\detokenize{part6/ch20_case_studies:implementation-prednet-architecture}}
\sphinxAtStartPar
The PredNet architecture, developed by William Lotter, Gabriel Kreiman, and David Cox, implements hierarchical predictive coding in a deep learning framework:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{layers}\PYG{p}{,} \PYG{n}{Model}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PredNetBlock}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of a single layer of the PredNet architecture}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}channels}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize PredNet block}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        num\PYGZus{}channels : int}
\PYG{l+s+sd}{            Number of feature channels in this layer}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PredNetBlock}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}channels} \PYG{o}{=} \PYG{n}{num\PYGZus{}channels}
        
        \PYG{c+c1}{\PYGZsh{} Convolutional layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}pred} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{n}{num\PYGZus{}channels}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}error\PYGZus{}pos} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{n}{num\PYGZus{}channels}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}error\PYGZus{}neg} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{n}{num\PYGZus{}channels}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}representation} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{n}{num\PYGZus{}channels}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Pooling and upsampling}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the PredNet block}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        inputs : tuple}
\PYG{l+s+sd}{            (current\PYGZus{}input, representation\PYGZus{}from\PYGZus{}higher\PYGZus{}layer)}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        outputs : tuple}
\PYG{l+s+sd}{            (error, updated\PYGZus{}representation, pooled\PYGZus{}representation)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{current\PYGZus{}input}\PYG{p}{,} \PYG{n}{higher\PYGZus{}representation} \PYG{o}{=} \PYG{n}{inputs}
        
        \PYG{c+c1}{\PYGZsh{} Generate prediction from higher layer representation}
        \PYG{k}{if} \PYG{n}{higher\PYGZus{}representation} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{prediction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}pred}\PYG{p}{(}\PYG{n}{higher\PYGZus{}representation}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} For the top layer, prediction is zeros}
            \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{current\PYGZus{}input}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute prediction error}
        \PYG{n}{error} \PYG{o}{=} \PYG{n}{current\PYGZus{}input} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction}
        
        \PYG{c+c1}{\PYGZsh{} Split error into positive and negative components}
        \PYG{n}{pos\PYGZus{}error} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}
        \PYG{n}{neg\PYGZus{}error} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{error}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Process error}
        \PYG{n}{error\PYGZus{}processed\PYGZus{}pos} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}error\PYGZus{}pos}\PYG{p}{(}\PYG{n}{pos\PYGZus{}error}\PYG{p}{)}
        \PYG{n}{error\PYGZus{}processed\PYGZus{}neg} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}error\PYGZus{}neg}\PYG{p}{(}\PYG{n}{neg\PYGZus{}error}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine processed errors}
        \PYG{n}{combined\PYGZus{}error} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{concat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{error\PYGZus{}processed\PYGZus{}pos}\PYG{p}{,} \PYG{n}{error\PYGZus{}processed\PYGZus{}neg}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update representation based on combined error}
        \PYG{n}{representation} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{conv\PYGZus{}representation}\PYG{p}{(}\PYG{n}{combined\PYGZus{}error}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Pool representation for the next higher layer}
        \PYG{n}{pooled\PYGZus{}representation} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool}\PYG{p}{(}\PYG{n}{representation}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{error}\PYG{p}{,} \PYG{n}{representation}\PYG{p}{,} \PYG{n}{pooled\PYGZus{}representation}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PredNet}\PYG{p}{(}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of the PredNet architecture for predictive coding}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{stack\PYGZus{}sizes}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize PredNet model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        stack\PYGZus{}sizes : tuple of int}
\PYG{l+s+sd}{            Number of channels in each layer of the network,}
\PYG{l+s+sd}{            from input to highest layer}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PredNet}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stack\PYGZus{}sizes} \PYG{o}{=} \PYG{n}{stack\PYGZus{}sizes}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{stack\PYGZus{}sizes}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create PredNet blocks for each layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{blocks} \PYG{o}{=} \PYG{p}{[}\PYG{n}{PredNetBlock}\PYG{p}{(}\PYG{n}{stack\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Upsampling layers for top\PYGZhy{}down connections}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{upsample\PYGZus{}layers} \PYG{o}{=} \PYG{p}{[}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{UpSampling2D}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{]}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the PredNet}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        inputs : tf.Tensor}
\PYG{l+s+sd}{            Input image or sequence}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        outputs : dict}
\PYG{l+s+sd}{            Dictionary containing predictions, errors, and representations}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize lists to store layer\PYGZhy{}wise outputs}
        \PYG{n}{errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{representations} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Bottom\PYGZhy{}up pass}
        \PYG{n}{current\PYGZus{}input} \PYG{o}{=} \PYG{n}{inputs}
        \PYG{n}{higher\PYGZus{}representations} \PYG{o}{=} \PYG{p}{[}\PYG{k+kc}{None}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Process through current layer}
            \PYG{n}{error}\PYG{p}{,} \PYG{n}{representation}\PYG{p}{,} \PYG{n}{pooled} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{blocks}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{(}\PYG{p}{[}\PYG{n}{current\PYGZus{}input}\PYG{p}{,} \PYG{n}{higher\PYGZus{}representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Store results}
            \PYG{n}{errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}
            \PYG{n}{representations}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{representation}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Set input for next layer}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{current\PYGZus{}input} \PYG{o}{=} \PYG{n}{pooled}
        
        \PYG{c+c1}{\PYGZsh{} Top\PYGZhy{}down pass to update higher representations}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Upsample representation from higher layer}
            \PYG{n}{higher\PYGZus{}rep} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{upsample\PYGZus{}layers}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{(}\PYG{n}{representations}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{higher\PYGZus{}representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{higher\PYGZus{}rep}
        
        \PYG{c+c1}{\PYGZsh{} Return all outputs}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{errors}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{errors}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{representations}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{representations}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{return} \PYG{n}{outputs}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{build\PYGZus{}prednet\PYGZus{}model}\PYG{p}{(}\PYG{n}{input\PYGZus{}shape}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Build a PredNet model for sequence prediction}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    input\PYGZus{}shape : tuple}
\PYG{l+s+sd}{        Shape of input images (height, width, channels)}
\PYG{l+s+sd}{    sequence\PYGZus{}length : int}
\PYG{l+s+sd}{        Number of frames in input sequences}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    model : tf.keras.Model}
\PYG{l+s+sd}{        Complete PredNet model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create input layer for sequence}
    \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Input}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{p}{(}\PYG{n}{sequence\PYGZus{}length}\PYG{p}{,}\PYG{p}{)} \PYG{o}{+} \PYG{n}{input\PYGZus{}shape}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Time\PYGZhy{}distributed PredNet to process sequences}
    \PYG{n}{prednet} \PYG{o}{=} \PYG{n}{PredNet}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{td\PYGZus{}prednet} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{TimeDistributed}\PYG{p}{(}\PYG{n}{prednet}\PYG{p}{)}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Combine outputs across time steps}
    \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Use previous frame\PYGZsq{}s representation to predict next frame}
        \PYG{n}{prev\PYGZus{}representation} \PYG{o}{=} \PYG{n}{td\PYGZus{}prednet}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{representations}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Top layer representation}
        \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{same}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sigmoid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{prev\PYGZus{}representation}\PYG{p}{)}
        \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{prediction}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Stack predictions along time dimension}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Lambda}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{Model}\PYG{p}{(}\PYG{n}{inputs}\PYG{o}{=}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{outputs}\PYG{o}{=}\PYG{n}{predictions}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}


\subsection{20.2.3 Results and Evaluation}
\label{\detokenize{part6/ch20_case_studies:results-and-evaluation}}
\sphinxAtStartPar
The PredNet architecture was evaluated on several computer vision tasks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Video prediction}: PredNet demonstrated superior performance in predicting future frames in natural video sequences, particularly in handling object motion and occlusion.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sample efficiency}: Compared to standard CNNs, PredNet required significantly fewer training examples to achieve comparable performance on object recognition tasks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Error representation}: The explicit representation of prediction errors allowed the model to highlight unexpected or novel events in sequences.

\end{enumerate}


\subsection{20.2.4 Neuroscience Connection}
\label{\detokenize{part6/ch20_case_studies:neuroscience-connection}}
\sphinxAtStartPar
This implementation connects to neuroscience in several ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical processing}: The layer\sphinxhyphen{}wise organization mirrors the hierarchical structure of the visual cortex.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prediction errors}: The explicit computation of prediction errors corresponds to theories about error\sphinxhyphen{}signaling neurons in the brain.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bidirectional processing}: The combination of bottom\sphinxhyphen{}up and top\sphinxhyphen{}down signals aligns with bidirectional information flow in the visual system.

\end{itemize}


\subsection{20.2.5 Limitations and Future Directions}
\label{\detokenize{part6/ch20_case_studies:limitations-and-future-directions}}
\sphinxAtStartPar
While successful, the PredNet implementation faced several challenges:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational efficiency}: The bidirectional processing increases computational demands compared to standard feed\sphinxhyphen{}forward networks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hyperparameter sensitivity}: Performance is sensitive to the balance between bottom\sphinxhyphen{}up and top\sphinxhyphen{}down signals.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Future work}: Ongoing research is exploring adaptive weighting of prediction errors and integration with reinforcement learning frameworks.

\end{enumerate}


\section{20.3 Case Study: Hippocampal Replay for Reinforcement Learning}
\label{\detokenize{part6/ch20_case_studies:case-study-hippocampal-replay-for-reinforcement-learning}}

\subsection{20.3.1 Background and Motivation}
\label{\detokenize{part6/ch20_case_studies:id1}}
\sphinxAtStartPar
The hippocampus plays a crucial role in memory consolidation, with “replay” events during sleep and rest periods helping to transfer experiences to long\sphinxhyphen{}term memory. This case study examines how hippocampal replay mechanisms have been incorporated into reinforcement learning systems to improve learning efficiency and generalization.


\subsection{20.3.2 Implementation: Prioritized Experience Replay}
\label{\detokenize{part6/ch20_case_studies:implementation-prioritized-experience-replay}}
\sphinxAtStartPar
Deep Q\sphinxhyphen{}Networks with Prioritized Experience Replay, developed by researchers at DeepMind, implement a biologically\sphinxhyphen{}inspired memory system:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{random}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{layers}\PYG{p}{,} \PYG{n}{Model}\PYG{p}{,} \PYG{n}{optimizers}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{collections}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{deque}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SumTree}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A sum tree data structure for efficient sampling based on priorities}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the sum tree}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        capacity : int}
\PYG{l+s+sd}{            Maximum number of experiences to store}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{capacity} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{capacity}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{object}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}entries} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{write\PYGZus{}index} \PYG{o}{=} \PYG{l+m+mi}{0}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}propagate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{,} \PYG{n}{change}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update the sum tree by propagating a value change up the tree}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{parent} \PYG{o}{=} \PYG{p}{(}\PYG{n}{idx} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{parent}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{change}
        
        \PYG{k}{if} \PYG{n}{parent} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}propagate}\PYG{p}{(}\PYG{n}{parent}\PYG{p}{,} \PYG{n}{change}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}retrieve}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{,} \PYG{n}{s}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Find the index of the leaf node where s falls within its priority range}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{left} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{idx} \PYG{o}{+} \PYG{l+m+mi}{1}
        \PYG{n}{right} \PYG{o}{=} \PYG{n}{left} \PYG{o}{+} \PYG{l+m+mi}{1}
        
        \PYG{k}{if} \PYG{n}{left} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{idx}
        
        \PYG{k}{if} \PYG{n}{s} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{left}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}retrieve}\PYG{p}{(}\PYG{n}{left}\PYG{p}{,} \PYG{n}{s}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}retrieve}\PYG{p}{(}\PYG{n}{right}\PYG{p}{,} \PYG{n}{s} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{left}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{total}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Return the total priority sum}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{p}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Add a new experience with priority p}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{write\PYGZus{}index} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{write\PYGZus{}index}\PYG{p}{]} \PYG{o}{=} \PYG{n}{data}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{idx}\PYG{p}{,} \PYG{n}{p}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{write\PYGZus{}index} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{write\PYGZus{}index} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}
        
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}entries} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}entries} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{,} \PYG{n}{p}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update the priority of an existing experience}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{change} \PYG{o}{=} \PYG{n}{p} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{p}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}propagate}\PYG{p}{(}\PYG{n}{idx}\PYG{p}{,} \PYG{n}{change}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{s}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Get an experience using priority\PYGZhy{}based sampling}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}retrieve}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{s}\PYG{p}{)}
        \PYG{n}{data\PYGZus{}idx} \PYG{o}{=} \PYG{n}{idx} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{+} \PYG{l+m+mi}{1}
        
        \PYG{k}{return} \PYG{n}{idx}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data}\PYG{p}{[}\PYG{n}{data\PYGZus{}idx}\PYG{p}{]}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PrioritizedReplayBuffer}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Prioritized experience replay buffer for efficient and effective learning}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{beta}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{n}{beta\PYGZus{}increment}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the prioritized replay buffer}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        capacity : int}
\PYG{l+s+sd}{            Maximum number of experiences to store}
\PYG{l+s+sd}{        alpha : float}
\PYG{l+s+sd}{            Controls how much prioritization is used (0 = no prioritization, 1 = full prioritization)}
\PYG{l+s+sd}{        beta : float}
\PYG{l+s+sd}{            Controls importance sampling weights (0 = no correction, 1 = full correction)}
\PYG{l+s+sd}{        beta\PYGZus{}increment : float}
\PYG{l+s+sd}{            Amount to increase beta over time}
\PYG{l+s+sd}{        epsilon : float}
\PYG{l+s+sd}{            Small value added to priorities to ensure non\PYGZhy{}zero probabilities}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree} \PYG{o}{=} \PYG{n}{SumTree}\PYG{p}{(}\PYG{n}{capacity}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha} \PYG{o}{=} \PYG{n}{alpha}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta} \PYG{o}{=} \PYG{n}{beta}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}increment} \PYG{o}{=} \PYG{n}{beta\PYGZus{}increment}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{epsilon} \PYG{o}{=} \PYG{n}{epsilon}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}priority} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Add an experience to the buffer with maximum priority}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{priority} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}priority} \PYG{o}{*}\PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{priority}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Sample a batch of experiences based on their priorities}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{batch} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{indices} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
        \PYG{n}{priorities} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate the priority segment}
        \PYG{n}{total\PYGZus{}priority} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{total}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{segment} \PYG{o}{=} \PYG{n}{total\PYGZus{}priority} \PYG{o}{/} \PYG{n}{batch\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Increase beta each time we sample}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}increment}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Sample a value from the segment}
            \PYG{n}{a} \PYG{o}{=} \PYG{n}{segment} \PYG{o}{*} \PYG{n}{i}
            \PYG{n}{b} \PYG{o}{=} \PYG{n}{segment} \PYG{o}{*} \PYG{p}{(}\PYG{n}{i} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{s} \PYG{o}{=} \PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Retrieve the experience}
            \PYG{n}{idx}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{,} \PYG{n}{experience} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{s}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Store the experience and its index}
            \PYG{n}{batch}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
            \PYG{n}{indices}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{idx}\PYG{p}{)}
            \PYG{n}{priorities}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{priority}
        
        \PYG{c+c1}{\PYGZsh{} Calculate importance sampling weights}
        \PYG{n}{sampling\PYGZus{}probabilities} \PYG{o}{=} \PYG{n}{priorities} \PYG{o}{/} \PYG{n}{total\PYGZus{}priority}
        \PYG{n}{weights} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{*} \PYG{n}{sampling\PYGZus{}probabilities}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta}\PYG{p}{)}
        \PYG{n}{weights} \PYG{o}{/}\PYG{o}{=} \PYG{n}{weights}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Normalize weights}
        
        \PYG{k}{return} \PYG{n}{batch}\PYG{p}{,} \PYG{n}{indices}\PYG{p}{,} \PYG{n}{weights}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}priorities}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{indices}\PYG{p}{,} \PYG{n}{priorities}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update the priorities of sampled experiences}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{idx}\PYG{p}{,} \PYG{n}{priority} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{priorities}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Add a small value to ensure non\PYGZhy{}zero probabilities}
            \PYG{n}{priority} \PYG{o}{=} \PYG{p}{(}\PYG{n}{priority} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{epsilon}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}priority} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}priority}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{idx}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{)}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{DQNWithPER}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Deep Q\PYGZhy{}Network with Prioritized Experience Replay}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{,} 
                 \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} 
                 \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{,}
                 \PYG{n}{per\PYGZus{}alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,}
                 \PYG{n}{per\PYGZus{}beta}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{,}
                 \PYG{n}{per\PYGZus{}beta\PYGZus{}increment}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,}
                 \PYG{n}{replay\PYGZus{}capacity}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{,}
                 \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{64}\PYG{p}{,}
                 \PYG{n}{target\PYGZus{}update\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the DQN with PER agent}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state\PYGZus{}dim : tuple}
\PYG{l+s+sd}{            Dimensions of the state space}
\PYG{l+s+sd}{        action\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimension of the action space}
\PYG{l+s+sd}{        learning\PYGZus{}rate : float}
\PYG{l+s+sd}{            Learning rate for the optimizer}
\PYG{l+s+sd}{        gamma : float}
\PYG{l+s+sd}{            Discount factor for future rewards}
\PYG{l+s+sd}{        per\PYGZus{}alpha : float}
\PYG{l+s+sd}{            Controls how much prioritization is used}
\PYG{l+s+sd}{        per\PYGZus{}beta : float}
\PYG{l+s+sd}{            Controls importance sampling weights}
\PYG{l+s+sd}{        per\PYGZus{}beta\PYGZus{}increment : float}
\PYG{l+s+sd}{            Amount to increase beta over time}
\PYG{l+s+sd}{        replay\PYGZus{}capacity : int}
\PYG{l+s+sd}{            Capacity of the replay buffer}
\PYG{l+s+sd}{        batch\PYGZus{}size : int}
\PYG{l+s+sd}{            Size of batches for training}
\PYG{l+s+sd}{        target\PYGZus{}update\PYGZus{}freq : int}
\PYG{l+s+sd}{            Frequency of target network updates}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}dim} \PYG{o}{=} \PYG{n}{state\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim} \PYG{o}{=} \PYG{n}{action\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{=} \PYG{n}{gamma}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{batch\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}update\PYGZus{}freq} \PYG{o}{=} \PYG{n}{target\PYGZus{}update\PYGZus{}freq}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step\PYGZus{}counter} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Create replay buffer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{PrioritizedReplayBuffer}\PYG{p}{(}
            \PYG{n}{capacity}\PYG{o}{=}\PYG{n}{replay\PYGZus{}capacity}\PYG{p}{,}
            \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{per\PYGZus{}alpha}\PYG{p}{,}
            \PYG{n}{beta}\PYG{o}{=}\PYG{n}{per\PYGZus{}beta}\PYG{p}{,}
            \PYG{n}{beta\PYGZus{}increment}\PYG{o}{=}\PYG{n}{per\PYGZus{}beta\PYGZus{}increment}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create Q networks}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}build\PYGZus{}q\PYGZus{}network}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}q\PYGZus{}network} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}build\PYGZus{}q\PYGZus{}network}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Use Mean Squared Error for loss}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optimizers}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize target network weights to match Q\PYGZhy{}network}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}update\PYGZus{}target\PYGZus{}network}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}build\PYGZus{}q\PYGZus{}network}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Build the Q\PYGZhy{}network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        model : tf.keras.Model}
\PYG{l+s+sd}{            The Q\PYGZhy{}network model}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Input}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,} \PYG{n}{strides}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{strides}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{strides}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{512}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{n}{model} \PYG{o}{=} \PYG{n}{Model}\PYG{p}{(}\PYG{n}{inputs}\PYG{o}{=}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{outputs}\PYG{o}{=}\PYG{n}{outputs}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{model}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}update\PYGZus{}target\PYGZus{}network}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update target network weights}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}q\PYGZus{}network}\PYG{o}{.}\PYG{n}{set\PYGZus{}weights}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network}\PYG{o}{.}\PYG{n}{get\PYGZus{}weights}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{select\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Select an action using epsilon\PYGZhy{}greedy policy}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state : np.ndarray}
\PYG{l+s+sd}{            Current state}
\PYG{l+s+sd}{        epsilon : float}
\PYG{l+s+sd}{            Exploration rate}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        action : int}
\PYG{l+s+sd}{            Selected action}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{epsilon}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Explore: select a random action}
            \PYG{k}{return} \PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Exploit: select the best action according to the Q\PYGZhy{}network}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{expand\PYGZus{}dims}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{n}{q\PYGZus{}values} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{q\PYGZus{}values}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{store\PYGZus{}experience}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Store an experience in the replay buffer}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state : np.ndarray}
\PYG{l+s+sd}{            Current state}
\PYG{l+s+sd}{        action : int}
\PYG{l+s+sd}{            Selected action}
\PYG{l+s+sd}{        reward : float}
\PYG{l+s+sd}{            Received reward}
\PYG{l+s+sd}{        next\PYGZus{}state : np.ndarray}
\PYG{l+s+sd}{            Next state}
\PYG{l+s+sd}{        done : bool}
\PYG{l+s+sd}{            Whether the episode is done}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{experience} \PYG{o}{=} \PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the Q\PYGZhy{}network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        loss : float}
\PYG{l+s+sd}{            Training loss}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Check if we have enough experiences}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{n\PYGZus{}entries} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{batch\PYGZus{}size}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Sample a batch from the replay buffer}
        \PYG{n}{batch}\PYG{p}{,} \PYG{n}{indices}\PYG{p}{,} \PYG{n}{weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Unzip the batch}
        \PYG{n}{states}\PYG{p}{,} \PYG{n}{actions}\PYG{p}{,} \PYG{n}{rewards}\PYG{p}{,} \PYG{n}{next\PYGZus{}states}\PYG{p}{,} \PYG{n}{dones} \PYG{o}{=} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{o}{*}\PYG{n}{batch}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert to numpy arrays}
        \PYG{n}{states} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{states}\PYG{p}{)}
        \PYG{n}{next\PYGZus{}states} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{next\PYGZus{}states}\PYG{p}{)}
        \PYG{n}{actions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{actions}\PYG{p}{)}
        \PYG{n}{rewards} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rewards}\PYG{p}{)}
        \PYG{n}{dones} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{dones}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
        \PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{weights}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate target Q\PYGZhy{}values}
        \PYG{n}{target\PYGZus{}q\PYGZus{}values} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}q\PYGZus{}network}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{next\PYGZus{}states}\PYG{p}{)}
        \PYG{n}{max\PYGZus{}target\PYGZus{}q\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{target\PYGZus{}q\PYGZus{}values}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{targets} \PYG{o}{=} \PYG{n}{rewards} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{dones}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{*} \PYG{n}{max\PYGZus{}target\PYGZus{}q\PYGZus{}values}
        
        \PYG{c+c1}{\PYGZsh{} Train the Q\PYGZhy{}network}
        \PYG{k}{with} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{GradientTape}\PYG{p}{(}\PYG{p}{)} \PYG{k}{as} \PYG{n}{tape}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get the Q\PYGZhy{}values for the selected actions}
            \PYG{n}{q\PYGZus{}values} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network}\PYG{p}{(}\PYG{n}{states}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{n}{one\PYGZus{}hot\PYGZus{}actions} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{one\PYGZus{}hot}\PYG{p}{(}\PYG{n}{actions}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim}\PYG{p}{)}
            \PYG{n}{selected\PYGZus{}q\PYGZus{}values} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}sum}\PYG{p}{(}\PYG{n}{q\PYGZus{}values} \PYG{o}{*} \PYG{n}{one\PYGZus{}hot\PYGZus{}actions}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate TD errors for priority update}
            \PYG{n}{td\PYGZus{}errors} \PYG{o}{=} \PYG{n}{targets} \PYG{o}{\PYGZhy{}} \PYG{n}{selected\PYGZus{}q\PYGZus{}values}
            
            \PYG{c+c1}{\PYGZsh{} Calculate weighted loss}
            \PYG{n}{losses} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{td\PYGZus{}errors}\PYG{p}{)} \PYG{o}{*} \PYG{n}{weights}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}mean}\PYG{p}{(}\PYG{n}{losses}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get gradients and apply them}
        \PYG{n}{grads} \PYG{o}{=} \PYG{n}{tape}\PYG{o}{.}\PYG{n}{gradient}\PYG{p}{(}\PYG{n}{loss}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network}\PYG{o}{.}\PYG{n}{trainable\PYGZus{}variables}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{apply\PYGZus{}gradients}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{grads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}network}\PYG{o}{.}\PYG{n}{trainable\PYGZus{}variables}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update priorities in the replay buffer}
        \PYG{n}{priorities} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{td\PYGZus{}errors}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{update\PYGZus{}priorities}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{priorities}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update target network periodically}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step\PYGZus{}counter} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step\PYGZus{}counter} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{target\PYGZus{}update\PYGZus{}freq} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}update\PYGZus{}target\PYGZus{}network}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{20.3.3 Results and Evaluation}
\label{\detokenize{part6/ch20_case_studies:id2}}
\sphinxAtStartPar
PER demonstrated significant improvements over standard experience replay in reinforcement learning tasks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Faster learning}: Systems with PER converged to optimal policies in 50\% fewer training steps on Atari games.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Better performance}: Final performance was improved by approximately 20\% across a range of reinforcement learning benchmarks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Improved exploration}: The prioritization of surprising experiences led to more effective exploration of the state space.

\end{enumerate}


\subsection{20.3.4 Neuroscience Connection}
\label{\detokenize{part6/ch20_case_studies:id3}}
\sphinxAtStartPar
The implementation connects to hippocampal replay in several ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory prioritization}: Just as the hippocampus preferentially replays behaviorally relevant experiences, PER revisits experiences with high learning value.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Surprise\sphinxhyphen{}based learning}: The prioritization based on TD error parallels the brain’s tendency to strengthen memories associated with unexpected outcomes.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interleaved learning}: Both biological replay and PER address the stability\sphinxhyphen{}plasticity dilemma by interleaving experiences.

\end{itemize}


\subsection{20.3.5 Limitations and Future Directions}
\label{\detokenize{part6/ch20_case_studies:id4}}
\sphinxAtStartPar
Key challenges and future directions include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Efficient implementation}: The tree\sphinxhyphen{}based sampling structure introduces additional computational overhead.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parameter sensitivity}: Performance depends on appropriate settings for alpha and beta parameters.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Future work}: Ongoing research is exploring integrating episodic memory structures and context\sphinxhyphen{}dependent replay strategies.

\end{enumerate}


\section{20.4 Case Study: Attention Mechanisms in Vision Transformers}
\label{\detokenize{part6/ch20_case_studies:case-study-attention-mechanisms-in-vision-transformers}}

\subsection{20.4.1 Background and Motivation}
\label{\detokenize{part6/ch20_case_studies:id5}}
\sphinxAtStartPar
Visual attention in humans allows for selective processing of relevant information while filtering out distractions. This case study examines how principles from visual neuroscience informed the development of Vision Transformers (ViT), which revolutionized computer vision by applying attention mechanisms to visual data.


\subsection{20.4.2 Implementation: Vision Transformer}
\label{\detokenize{part6/ch20_case_studies:implementation-vision-transformer}}
\sphinxAtStartPar
The Vision Transformer, developed by researchers at Google, applies the transformer architecture to image classification:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{layers}\PYG{p}{,} \PYG{n}{Model}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PatchExtractor}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Extract patches from images}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PatchExtractor}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size} \PYG{o}{=} \PYG{n}{patch\PYGZus{}size}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{images}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{images}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{patches} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{image}\PYG{o}{.}\PYG{n}{extract\PYGZus{}patches}\PYG{p}{(}
            \PYG{n}{images}\PYG{o}{=}\PYG{n}{images}\PYG{p}{,}
            \PYG{n}{sizes}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{strides}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{rates}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{VALID}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
        \PYG{n}{patch\PYGZus{}dims} \PYG{o}{=} \PYG{n}{patches}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{patches} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{,} \PYG{p}{[}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{patch\PYGZus{}dims}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{patches}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PositionalEmbedding}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Add positional embeddings to patch embeddings}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}patches}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PositionalEmbedding}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Embedding}\PYG{p}{(}
            \PYG{n}{input\PYGZus{}dim}\PYG{o}{=}\PYG{n}{num\PYGZus{}patches} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} +1 for the class token}
            \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{n}{projection\PYGZus{}dim}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{patch\PYGZus{}embeddings}\PYG{p}{,} \PYG{n}{class\PYGZus{}token}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{patch\PYGZus{}embeddings}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{c+c1}{\PYGZsh{} Add class token to patch embeddings}
        \PYG{n}{cls\PYGZus{}tokens} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{repeat}\PYG{p}{(}
            \PYG{n}{tf}\PYG{o}{.}\PYG{n}{expand\PYGZus{}dims}\PYG{p}{(}\PYG{n}{class\PYGZus{}token}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}
        \PYG{p}{)}
        \PYG{n}{embeddings} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{concat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{cls\PYGZus{}tokens}\PYG{p}{,} \PYG{n}{patch\PYGZus{}embeddings}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add positional embeddings}
        \PYG{n}{positions} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{range}\PYG{p}{(}\PYG{n}{start}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{limit}\PYG{o}{=}\PYG{n}{embeddings}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{delta}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{position\PYGZus{}embeddings} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position\PYGZus{}embedding}\PYG{p}{(}\PYG{n}{positions}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{embeddings} \PYG{o}{+} \PYG{n}{position\PYGZus{}embeddings}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MultiHeadSelfAttention}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Multi\PYGZhy{}head self\PYGZhy{}attention mechanism}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{MultiHeadSelfAttention}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads} \PYG{o}{=} \PYG{n}{num\PYGZus{}heads}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection\PYGZus{}dim} \PYG{o}{=} \PYG{n}{projection\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim} \PYG{o}{=} \PYG{n}{projection\PYGZus{}dim} \PYG{o}{/}\PYG{o}{/} \PYG{n}{num\PYGZus{}heads}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim} \PYG{o}{*}\PYG{o}{*} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{combine\PYGZus{}heads} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{split\PYGZus{}heads}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}
            \PYG{n}{x}\PYG{p}{,} \PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{p}{)}
        \PYG{k}{return} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{perm}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Linear projections}
        \PYG{n}{query} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{key} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{key}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{value} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Split heads}
        \PYG{n}{query} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{split\PYGZus{}heads}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{key} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{split\PYGZus{}heads}\PYG{p}{(}\PYG{n}{key}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{value} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{split\PYGZus{}heads}\PYG{p}{(}\PYG{n}{value}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Scaled dot\PYGZhy{}product attention}
        \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{key}\PYG{p}{,} \PYG{n}{transpose\PYGZus{}b}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{scale}
        \PYG{n}{attention\PYGZus{}weights} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{softmax}\PYG{p}{(}\PYG{n}{attention\PYGZus{}scores}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply attention to values}
        \PYG{n}{context} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n}{attention\PYGZus{}weights}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}
        \PYG{n}{context} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{context}\PYG{p}{,} \PYG{n}{perm}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{context} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{context}\PYG{p}{,} \PYG{p}{[}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine heads}
        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{combine\PYGZus{}heads}\PYG{p}{(}\PYG{n}{context}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{output}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TransformerBlock}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Transformer block with self\PYGZhy{}attention and MLP}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{,} \PYG{n}{mlp\PYGZus{}dim}\PYG{p}{,} \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{TransformerBlock}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention} \PYG{o}{=} \PYG{n}{MultiHeadSelfAttention}\PYG{p}{(}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mlp} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{mlp\PYGZus{}dim}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{n}{tf}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{gelu}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        \PYG{p}{]}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm1} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{LayerNormalization}\PYG{p}{(}\PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm2} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{LayerNormalization}\PYG{p}{(}\PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout1} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout2} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{n}{dropout}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Normalize and apply attention}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm1}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{attention\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{attention\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout1}\PYG{p}{(}\PYG{n}{attention\PYGZus{}output}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{n}{training}\PYG{p}{)}
        \PYG{n}{out1} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{p}{[}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{attention\PYGZus{}output}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalize and apply MLP}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm2}\PYG{p}{(}\PYG{n}{out1}\PYG{p}{)}
        \PYG{n}{mlp\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mlp}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{mlp\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout2}\PYG{p}{(}\PYG{n}{mlp\PYGZus{}output}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{n}{training}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{p}{[}\PYG{n}{out1}\PYG{p}{,} \PYG{n}{mlp\PYGZus{}output}\PYG{p}{]}\PYG{p}{)}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{VisionTransformer}\PYG{p}{(}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Vision Transformer (ViT) model for image classification}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}
        \PYG{n+nb+bp}{self}\PYG{p}{,}
        \PYG{n}{image\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{224}\PYG{p}{,}
        \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
        \PYG{n}{projection\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{768}\PYG{p}{,}
        \PYG{n}{mlp\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{3072}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,}
        \PYG{n}{dropout}\PYG{o}{=}\PYG{l+m+mf}{0.1}
    \PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{VisionTransformer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate number of patches}
        \PYG{n}{num\PYGZus{}patches} \PYG{o}{=} \PYG{p}{(}\PYG{n}{image\PYGZus{}size} \PYG{o}{/}\PYG{o}{/} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}size} \PYG{o}{=} \PYG{n}{patch\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Patch extraction and projection}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}extractor} \PYG{o}{=} \PYG{n}{PatchExtractor}\PYG{p}{(}\PYG{n}{patch\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Class token}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{class\PYGZus{}token} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{Variable}\PYG{p}{(}
            \PYG{n}{initial\PYGZus{}value}\PYG{o}{=}\PYG{n}{tf}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{trainable}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
            \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{class\PYGZus{}token}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Positional embedding}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position\PYGZus{}embedding} \PYG{o}{=} \PYG{n}{PositionalEmbedding}\PYG{p}{(}
            \PYG{n}{num\PYGZus{}patches}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Transformer blocks}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{transformer\PYGZus{}blocks} \PYG{o}{=} \PYG{p}{[}
            \PYG{n}{TransformerBlock}\PYG{p}{(}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,} \PYG{n}{projection\PYGZus{}dim}\PYG{p}{,} \PYG{n}{mlp\PYGZus{}dim}\PYG{p}{,} \PYG{n}{dropout}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}layers}\PYG{p}{)}
        \PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Layer normalization and classifier}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{LayerNormalization}\PYG{p}{(}\PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classifier} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{num\PYGZus{}classes}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Extract patches from images}
        \PYG{n}{patches} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{patch\PYGZus{}extractor}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Project patches to embedding dimension}
        \PYG{n}{patch\PYGZus{}embeddings} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{projection}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add positional embeddings}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position\PYGZus{}embedding}\PYG{p}{(}\PYG{n}{patch\PYGZus{}embeddings}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{class\PYGZus{}token}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply transformer blocks}
        \PYG{k}{for} \PYG{n}{transformer\PYGZus{}block} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{transformer\PYGZus{}blocks}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{transformer\PYGZus{}block}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{n}{training}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Layer normalization}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer\PYGZus{}norm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get class token output}
        \PYG{n}{class\PYGZus{}token\PYGZus{}output} \PYG{o}{=} \PYG{n}{x}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Classification}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classifier}\PYG{p}{(}\PYG{n}{class\PYGZus{}token\PYGZus{}output}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{build\PYGZus{}vit\PYGZus{}model}\PYG{p}{(}
    \PYG{n}{image\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{224}\PYG{p}{,}
    \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,}
    \PYG{n}{num\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
    \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
    \PYG{n}{projection\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{768}\PYG{p}{,}
    \PYG{n}{mlp\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{3072}\PYG{p}{,}
    \PYG{n}{num\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{1000}
\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Build a Vision Transformer model}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    image\PYGZus{}size : int}
\PYG{l+s+sd}{        Size of input images (assuming square images)}
\PYG{l+s+sd}{    patch\PYGZus{}size : int}
\PYG{l+s+sd}{        Size of image patches}
\PYG{l+s+sd}{    num\PYGZus{}layers : int}
\PYG{l+s+sd}{        Number of transformer blocks}
\PYG{l+s+sd}{    num\PYGZus{}heads : int}
\PYG{l+s+sd}{        Number of attention heads}
\PYG{l+s+sd}{    projection\PYGZus{}dim : int}
\PYG{l+s+sd}{        Dimension of patch embeddings}
\PYG{l+s+sd}{    mlp\PYGZus{}dim : int}
\PYG{l+s+sd}{        Hidden dimension in the MLP}
\PYG{l+s+sd}{    num\PYGZus{}classes : int}
\PYG{l+s+sd}{        Number of output classes}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    model : tf.keras.Model}
\PYG{l+s+sd}{        Vision Transformer model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Input}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{p}{(}\PYG{n}{image\PYGZus{}size}\PYG{p}{,} \PYG{n}{image\PYGZus{}size}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{vit} \PYG{o}{=} \PYG{n}{VisionTransformer}\PYG{p}{(}
        \PYG{n}{image\PYGZus{}size}\PYG{o}{=}\PYG{n}{image\PYGZus{}size}\PYG{p}{,}
        \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}layers}\PYG{o}{=}\PYG{n}{num\PYGZus{}layers}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}heads}\PYG{o}{=}\PYG{n}{num\PYGZus{}heads}\PYG{p}{,}
        \PYG{n}{projection\PYGZus{}dim}\PYG{o}{=}\PYG{n}{projection\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{mlp\PYGZus{}dim}\PYG{o}{=}\PYG{n}{mlp\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{num\PYGZus{}classes}\PYG{o}{=}\PYG{n}{num\PYGZus{}classes}
    \PYG{p}{)}
    
    \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{vit}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{Model}\PYG{p}{(}\PYG{n}{inputs}\PYG{o}{=}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{outputs}\PYG{o}{=}\PYG{n}{outputs}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{20.4.3 Results and Evaluation}
\label{\detokenize{part6/ch20_case_studies:id6}}
\sphinxAtStartPar
Vision Transformers have demonstrated impressive performance on computer vision tasks:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Competitive accuracy}: When trained on sufficient data, ViT outperformed CNNs on image classification benchmarks like ImageNet.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data efficiency}: With pre\sphinxhyphen{}training on large datasets, ViTs showed better transfer learning efficiency than CNNs.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interpretability}: The attention maps provide visual explanations of which image regions contribute to decisions.

\end{enumerate}


\subsection{20.4.4 Neuroscience Connection}
\label{\detokenize{part6/ch20_case_studies:id7}}
\sphinxAtStartPar
The ViT architecture connects to visual neuroscience in several ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Parallel processing}: Like the visual system, ViT processes multiple parts of the visual field in parallel.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical integration}: The transformer layers build increasingly abstract representations similar to the visual cortex.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Attention allocation}: The self\sphinxhyphen{}attention mechanism parallels how humans selectively attend to parts of a scene.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context integration}: ViT’s ability to relate distant parts of an image mirrors how the visual system integrates across the visual field.

\end{itemize}


\subsection{20.4.5 Limitations and Future Directions}
\label{\detokenize{part6/ch20_case_studies:id8}}
\sphinxAtStartPar
Key challenges and future directions include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational efficiency}: ViTs typically require more computation than CNNs for similar performance at small scales.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Data requirements}: ViTs need more data to achieve good results without pre\sphinxhyphen{}training.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Future work}: Ongoing research is exploring hybrid architectures combining CNNs and transformers, and biologically\sphinxhyphen{}inspired attention constraints.

\end{enumerate}


\section{20.5 Case Study: Neural Data Analysis with Latent Variable Models}
\label{\detokenize{part6/ch20_case_studies:case-study-neural-data-analysis-with-latent-variable-models}}

\subsection{20.5.1 Background and Motivation}
\label{\detokenize{part6/ch20_case_studies:id9}}
\sphinxAtStartPar
Analyzing high\sphinxhyphen{}dimensional neural data requires methods that can identify underlying patterns and structures. This case study examines how latent variable models influenced by neuroscience principles have been used to extract meaningful representations from neural recordings.


\subsection{20.5.2 Implementation: Latent Factor Analysis via Dynamical Systems (LFADS)}
\label{\detokenize{part6/ch20_case_studies:implementation-latent-factor-analysis-via-dynamical-systems-lfads}}
\sphinxAtStartPar
LFADS, developed by researchers at Stanford and Google, uses recurrent neural networks to model neural population dynamics:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{n+nn}{.}\PYG{n+nn}{keras}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{layers}\PYG{p}{,} \PYG{n}{Model}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Encoder}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Bidirectional RNN encoder for LFADS}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{Encoder}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Forward and backward RNNs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}rnn} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}
            \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{return\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
            \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{encoder\PYGZus{}forward\PYGZus{}rnn}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{backward\PYGZus{}rnn} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}
            \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{return\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{go\PYGZus{}backwards}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
            \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{encoder\PYGZus{}backward\PYGZus{}rnn}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{forward\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{forward\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}rnn}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass}
        \PYG{n}{backward\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{backward\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{backward\PYGZus{}rnn}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{backward\PYGZus{}outputs} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reverse}\PYG{p}{(}\PYG{n}{backward\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine states}
        \PYG{n}{encoder\PYGZus{}state} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{concat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{forward\PYGZus{}state}\PYG{p}{,} \PYG{n}{backward\PYGZus{}state}\PYG{p}{]}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{encoder\PYGZus{}state}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LatentDistribution}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Variational distribution for latent variables}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LatentDistribution}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{latent\PYGZus{}dim} \PYG{o}{=} \PYG{n}{latent\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Dense layers for mean and logvar}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean\PYGZus{}layer} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mean\PYGZus{}layer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logvar\PYGZus{}layer} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{logvar\PYGZus{}layer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Compute mean and logvar}
        \PYG{n}{mean} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mean\PYGZus{}layer}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{logvar} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logvar\PYGZus{}layer}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} If training, sample from the distribution}
        \PYG{k}{if} \PYG{n}{training}\PYG{p}{:}
            \PYG{n}{epsilon} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{mean}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{sample} \PYG{o}{=} \PYG{n}{mean} \PYG{o}{+} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{logvar}\PYG{p}{)} \PYG{o}{*} \PYG{n}{epsilon}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{sample} \PYG{o}{=} \PYG{n}{mean}
        
        \PYG{k}{return} \PYG{n}{sample}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Controller}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Controller RNN for generating inputs to the generator}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{Controller}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Controller RNN}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}
            \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{return\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
            \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{controller\PYGZus{}rnn}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dense layer for controller outputs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dense} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{controller\PYGZus{}output}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create dummy input tensor}
        \PYG{n}{batch\PYGZus{}size} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{initial\PYGZus{}state}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{dummy\PYGZus{}input} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{[}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize RNN state}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{initial\PYGZus{}state}
        
        \PYG{c+c1}{\PYGZsh{} Run RNN and get outputs}
        \PYG{n}{outputs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn}\PYG{p}{(}\PYG{n}{dummy\PYGZus{}input}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{o}{=}\PYG{n}{state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply dense layer to outputs}
        \PYG{n}{controller\PYGZus{}outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dense}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{controller\PYGZus{}outputs}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Generator}\PYG{p}{(}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Layer}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Generator RNN for modeling neural dynamics}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{factors\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{Generator}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{factors\PYGZus{}dim} \PYG{o}{=} \PYG{n}{factors\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}dim} \PYG{o}{=} \PYG{n}{output\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Generator RNN}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{GRU}\PYG{p}{(}
            \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{return\PYGZus{}sequences}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{return\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
            \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{generator\PYGZus{}rnn}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Dense layers for outputs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{factors\PYGZus{}layer} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{factors\PYGZus{}dim}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{factors\PYGZus{}layer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rates\PYGZus{}layer} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{output\PYGZus{}dim}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{n}{tf}\PYG{o}{.}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{softplus}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rates\PYGZus{}layer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{n}{controller\PYGZus{}outputs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Run RNN with controller outputs as inputs}
        \PYG{n}{outputs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnn}\PYG{p}{(}\PYG{n}{controller\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{initial\PYGZus{}state}\PYG{o}{=}\PYG{n}{initial\PYGZus{}state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate factors (latent neural dynamics)}
        \PYG{n}{factors} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{factors\PYGZus{}layer}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate rates (expected neural firing rates)}
        \PYG{n}{rates} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rates\PYGZus{}layer}\PYG{p}{(}\PYG{n}{factors}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{rates}\PYG{p}{,} \PYG{n}{factors}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LFADS}\PYG{p}{(}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Latent Factor Analysis via Dynamical Systems (LFADS) model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}
        \PYG{n+nb+bp}{self}\PYG{p}{,}
        \PYG{n}{encoder\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
        \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
        \PYG{n}{controller\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
        \PYG{n}{generator\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
        \PYG{n}{factors\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
        \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}
    \PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LFADS}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Model components}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{Encoder}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{n}{encoder\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{latent\PYGZus{}distribution} \PYG{o}{=} \PYG{n}{LatentDistribution}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{controller} \PYG{o}{=} \PYG{n}{Controller}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{n}{controller\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{generator\PYGZus{}initial\PYGZus{}dense} \PYG{o}{=} \PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{n}{generator\PYGZus{}dim}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tanh}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{build}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}shape}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Build the generator once we know the output dimension}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{generator} \PYG{o}{=} \PYG{n}{Generator}\PYG{p}{(}
            \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{generator\PYGZus{}initial\PYGZus{}dense}\PYG{o}{.}\PYG{n}{units}\PYG{p}{,}
            \PYG{n}{factors\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
            \PYG{n}{output\PYGZus{}dim}\PYG{o}{=}\PYG{n}{input\PYGZus{}shape}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{p}{)}
        
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{LFADS}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n}{build}\PYG{p}{(}\PYG{n}{input\PYGZus{}shape}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{call}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Get sequence length}
        \PYG{n}{sequence\PYGZus{}length} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Encode input}
        \PYG{n}{encoder\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Sample from latent distribution}
        \PYG{n}{latent\PYGZus{}sample}\PYG{p}{,} \PYG{n}{mean}\PYG{p}{,} \PYG{n}{logvar} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{latent\PYGZus{}distribution}\PYG{p}{(}\PYG{n}{encoder\PYGZus{}state}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{n}{training}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate controller outputs}
        \PYG{n}{controller\PYGZus{}outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{controller}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sample}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate initial state for generator}
        \PYG{n}{generator\PYGZus{}initial\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{generator\PYGZus{}initial\PYGZus{}dense}\PYG{p}{(}\PYG{n}{latent\PYGZus{}sample}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate neural rates and factors}
        \PYG{n}{rates}\PYG{p}{,} \PYG{n}{factors} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{generator}\PYG{p}{(}\PYG{n}{generator\PYGZus{}initial\PYGZus{}state}\PYG{p}{,} \PYG{n}{controller\PYGZus{}outputs}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create model outputs dictionary}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rates}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rates}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{factors}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{factors}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latent\PYGZus{}mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mean}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latent\PYGZus{}logvar}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{logvar}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{return} \PYG{n}{outputs}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}loss}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute LFADS loss function}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        x : tf.Tensor}
\PYG{l+s+sd}{            Input spike data}
\PYG{l+s+sd}{        training : bool}
\PYG{l+s+sd}{            Whether model is in training mode}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        total\PYGZus{}loss : tf.Tensor}
\PYG{l+s+sd}{            Combined loss}
\PYG{l+s+sd}{        reconstruction\PYGZus{}loss : tf.Tensor}
\PYG{l+s+sd}{            Poisson reconstruction loss}
\PYG{l+s+sd}{        kl\PYGZus{}loss : tf.Tensor}
\PYG{l+s+sd}{            KL divergence loss}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get model outputs}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{training}\PYG{o}{=}\PYG{n}{training}\PYG{p}{)}
        \PYG{n}{rates} \PYG{o}{=} \PYG{n}{outputs}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rates}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{latent\PYGZus{}mean} \PYG{o}{=} \PYG{n}{outputs}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latent\PYGZus{}mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{latent\PYGZus{}logvar} \PYG{o}{=} \PYG{n}{outputs}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latent\PYGZus{}logvar}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Compute Poisson reconstruction loss}
        \PYG{c+c1}{\PYGZsh{} log p(x|z) = sum\PYGZus{}t sum\PYGZus{}i (x\PYGZus{}i,t * log(r\PYGZus{}i,t) \PYGZhy{} r\PYGZus{}i,t \PYGZhy{} log(x\PYGZus{}i,t!))}
        \PYG{c+c1}{\PYGZsh{} We drop the factorial term as it\PYGZsq{}s constant with respect to the parameters}
        \PYG{n}{reconstruction\PYGZus{}loss} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}sum}\PYG{p}{(}
            \PYG{n}{rates} \PYG{o}{\PYGZhy{}} \PYG{n}{x} \PYG{o}{*} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{math}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{rates} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}8}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{axis}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}
        \PYG{p}{)}
        \PYG{n}{reconstruction\PYGZus{}loss} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}mean}\PYG{p}{(}\PYG{n}{reconstruction\PYGZus{}loss}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute KL divergence loss}
        \PYG{c+c1}{\PYGZsh{} KL(q(z|x) || p(z)) = 0.5 * sum\PYGZus{}j (1 + log(sigma\PYGZus{}j\PYGZca{}2) \PYGZhy{} mu\PYGZus{}j\PYGZca{}2 \PYGZhy{} sigma\PYGZus{}j\PYGZca{}2)}
        \PYG{n}{kl\PYGZus{}loss} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}sum}\PYG{p}{(}
            \PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{latent\PYGZus{}logvar} \PYG{o}{\PYGZhy{}} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{latent\PYGZus{}mean}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{latent\PYGZus{}logvar}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}
        \PYG{p}{)}
        \PYG{n}{kl\PYGZus{}loss} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{reduce\PYGZus{}mean}\PYG{p}{(}\PYG{n}{kl\PYGZus{}loss}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine losses}
        \PYG{c+c1}{\PYGZsh{} Optionally add weight for KL term (beta\PYGZhy{}VAE style)}
        \PYG{n}{kl\PYGZus{}weight} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        \PYG{n}{total\PYGZus{}loss} \PYG{o}{=} \PYG{n}{reconstruction\PYGZus{}loss} \PYG{o}{+} \PYG{n}{kl\PYGZus{}weight} \PYG{o}{*} \PYG{n}{kl\PYGZus{}loss}
        
        \PYG{k}{return} \PYG{n}{total\PYGZus{}loss}\PYG{p}{,} \PYG{n}{reconstruction\PYGZus{}loss}\PYG{p}{,} \PYG{n}{kl\PYGZus{}loss}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{build\PYGZus{}lfads\PYGZus{}model}\PYG{p}{(}
    \PYG{n}{input\PYGZus{}shape}\PYG{p}{,}
    \PYG{n}{encoder\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
    \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,}
    \PYG{n}{controller\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
    \PYG{n}{generator\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,}
    \PYG{n}{factors\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{50}
\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Build an LFADS model}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    input\PYGZus{}shape : tuple}
\PYG{l+s+sd}{        Shape of input data (sequence\PYGZus{}length, num\PYGZus{}neurons)}
\PYG{l+s+sd}{    encoder\PYGZus{}dim : int}
\PYG{l+s+sd}{        Hidden dimension of encoder RNN}
\PYG{l+s+sd}{    latent\PYGZus{}dim : int}
\PYG{l+s+sd}{        Dimension of latent variables}
\PYG{l+s+sd}{    controller\PYGZus{}dim : int}
\PYG{l+s+sd}{        Hidden dimension of controller RNN}
\PYG{l+s+sd}{    generator\PYGZus{}dim : int}
\PYG{l+s+sd}{        Hidden dimension of generator RNN}
\PYG{l+s+sd}{    factors\PYGZus{}dim : int}
\PYG{l+s+sd}{        Dimension of latent factors}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    model : LFADS}
\PYG{l+s+sd}{        LFADS model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create LFADS model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{LFADS}\PYG{p}{(}
        \PYG{n}{encoder\PYGZus{}dim}\PYG{o}{=}\PYG{n}{encoder\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{controller\PYGZus{}dim}\PYG{o}{=}\PYG{n}{controller\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{generator\PYGZus{}dim}\PYG{o}{=}\PYG{n}{generator\PYGZus{}dim}\PYG{p}{,}
        \PYG{n}{factors\PYGZus{}dim}\PYG{o}{=}\PYG{n}{factors\PYGZus{}dim}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Build the model with sample input}
    \PYG{n}{sample\PYGZus{}input} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{p}{)} \PYG{o}{+} \PYG{n}{input\PYGZus{}shape}\PYG{p}{)}
    \PYG{n}{model}\PYG{p}{(}\PYG{n}{sample\PYGZus{}input}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}


\subsection{20.5.3 Results and Evaluation}
\label{\detokenize{part6/ch20_case_studies:id10}}
\sphinxAtStartPar
LFADS has demonstrated several benefits in analyzing neural data:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Improved decoding}: Using LFADS\sphinxhyphen{}inferred latent factors improved neural decoding accuracy by 40\% compared to raw neural data.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Single\sphinxhyphen{}trial analysis}: By inferring the underlying dynamics from noisy spike trains, LFADS enables meaningful analysis of individual trials rather than requiring trial averaging.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Identification of dynamics}: LFADS successfully recovered the underlying dynamical structure in both simulated and real neural populations.

\end{enumerate}


\subsection{20.5.4 Neuroscience Connection}
\label{\detokenize{part6/ch20_case_studies:id11}}
\sphinxAtStartPar
The LFADS model connects to neuroscience theories in several ways:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Low\sphinxhyphen{}dimensional dynamics}: LFADS is built on the neuroscience insight that high\sphinxhyphen{}dimensional neural activity often reflects low\sphinxhyphen{}dimensional latent dynamics.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal constraints}: The recurrent generator mirrors the continuous\sphinxhyphen{}time dynamics of neural circuits.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Initial condition encoding}: The model’s focus on initial state mirrors theories about how neural trajectories are initialized based on sensory inputs.

\end{itemize}


\subsection{20.5.5 Limitations and Future Directions}
\label{\detokenize{part6/ch20_case_studies:id12}}
\sphinxAtStartPar
Key challenges and future directions include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Model complexity}: The full LFADS model is computationally intensive to train.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interpretability}: The biological meaning of extracted latent factors requires careful interpretation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Future work}: Ongoing research is exploring extensions to multi\sphinxhyphen{}area recordings and incorporating more detailed biophysical constraints.

\end{enumerate}


\section{20.6 Lessons from Successful NeuroAI Integration}
\label{\detokenize{part6/ch20_case_studies:lessons-from-successful-neuroai-integration}}
\sphinxAtStartPar
Across these case studies, several patterns emerge that highlight successful strategies for integrating neuroscience and AI:


\subsection{20.6.1 Common Patterns of Success}
\label{\detokenize{part6/ch20_case_studies:common-patterns-of-success}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Focus on computational principles}: Successful NeuroAI implementations focus on computational principles rather than precise biological details.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Iterative refinement}: The most successful projects involved multiple iterations between neuroscience insights and AI implementations.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cross\sphinxhyphen{}disciplinary teams}: Projects typically involved researchers with expertise in both neuroscience and AI working closely together.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Translation flexibility}: Successful implementations allowed for flexible translation of neuroscience principles to match the constraints of deep learning architectures.

\end{enumerate}


\subsection{20.6.2 Practical Implementation Strategies}
\label{\detokenize{part6/ch20_case_studies:practical-implementation-strategies}}
\sphinxAtStartPar
Based on these case studies, several practical strategies emerge:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neuroai\PYGZus{}implementation\PYGZus{}framework}\PYG{p}{(}\PYG{n}{neuroscience\PYGZus{}principle}\PYG{p}{,} \PYG{n}{existing\PYGZus{}ai\PYGZus{}system}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A framework for implementing neuroscience principles in AI systems}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    neuroscience\PYGZus{}principle : dict}
\PYG{l+s+sd}{        Description of the neuroscience principle to implement}
\PYG{l+s+sd}{    existing\PYGZus{}ai\PYGZus{}system : object}
\PYG{l+s+sd}{        The AI system to enhance}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    enhanced\PYGZus{}system : object}
\PYG{l+s+sd}{        The enhanced AI system}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Step 1: Extract the computational essence of the neuroscience principle}
    \PYG{n}{computational\PYGZus{}essence} \PYG{o}{=} \PYG{n}{extract\PYGZus{}computational\PYGZus{}essence}\PYG{p}{(}\PYG{n}{neuroscience\PYGZus{}principle}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 2: Analyze compatibility with existing AI system}
    \PYG{n}{compatibility\PYGZus{}analysis} \PYG{o}{=} \PYG{n}{analyze\PYGZus{}compatibility}\PYG{p}{(}\PYG{n}{computational\PYGZus{}essence}\PYG{p}{,} \PYG{n}{existing\PYGZus{}ai\PYGZus{}system}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 3: Implement a minimal version to test the principle}
    \PYG{n}{prototype} \PYG{o}{=} \PYG{n}{implement\PYGZus{}minimal\PYGZus{}version}\PYG{p}{(}\PYG{n}{computational\PYGZus{}essence}\PYG{p}{,} \PYG{n}{existing\PYGZus{}ai\PYGZus{}system}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 4: Evaluate and iterate}
    \PYG{n}{evaluation\PYGZus{}results} \PYG{o}{=} \PYG{n}{evaluate\PYGZus{}prototype}\PYG{p}{(}\PYG{n}{prototype}\PYG{p}{)}
    \PYG{n}{enhanced\PYGZus{}system} \PYG{o}{=} \PYG{n}{iterative\PYGZus{}refinement}\PYG{p}{(}\PYG{n}{prototype}\PYG{p}{,} \PYG{n}{evaluation\PYGZus{}results}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step 5: Scale up implementation}
    \PYG{n}{enhanced\PYGZus{}system} \PYG{o}{=} \PYG{n}{scale\PYGZus{}implementation}\PYG{p}{(}\PYG{n}{enhanced\PYGZus{}system}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{enhanced\PYGZus{}system}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{extract\PYGZus{}computational\PYGZus{}essence}\PYG{p}{(}\PYG{n}{neuroscience\PYGZus{}principle}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Extract the core computational principle from neuroscience findings}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Focus on functional aspects, not biological implementation}
    \PYG{c+c1}{\PYGZsh{} Identify the information processing role}
    \PYG{c+c1}{\PYGZsh{} Abstract away biological details}
    \PYG{c+c1}{\PYGZsh{} Identify the computational advantage}
    \PYG{k}{pass}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}compatibility}\PYG{p}{(}\PYG{n}{computational\PYGZus{}essence}\PYG{p}{,} \PYG{n}{existing\PYGZus{}ai\PYGZus{}system}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Analyze how compatible the principle is with existing AI}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Identify integration points}
    \PYG{c+c1}{\PYGZsh{} Assess computational overhead}
    \PYG{c+c1}{\PYGZsh{} Determine architectural modifications needed}
    \PYG{c+c1}{\PYGZsh{} Evaluate training implications}
    \PYG{k}{pass}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{implement\PYGZus{}minimal\PYGZus{}version}\PYG{p}{(}\PYG{n}{computational\PYGZus{}essence}\PYG{p}{,} \PYG{n}{existing\PYGZus{}ai\PYGZus{}system}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implement a minimal version to test the principle}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Focus on core functionality}
    \PYG{c+c1}{\PYGZsh{} Implement the simplest version that could work}
    \PYG{c+c1}{\PYGZsh{} Ensure measurable outcomes}
    \PYG{c+c1}{\PYGZsh{} Document assumptions and simplifications}
    \PYG{k}{pass}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}prototype}\PYG{p}{(}\PYG{n}{prototype}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Evaluate the prototype against baselines}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Compare to baseline}
    \PYG{c+c1}{\PYGZsh{} Test on simplified tasks}
    \PYG{c+c1}{\PYGZsh{} Analyze failure modes}
    \PYG{c+c1}{\PYGZsh{} Identity promising directions}
    \PYG{k}{pass}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{iterative\PYGZus{}refinement}\PYG{p}{(}\PYG{n}{prototype}\PYG{p}{,} \PYG{n}{evaluation\PYGZus{}results}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Refine implementation based on evaluation}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Address failure modes}
    \PYG{c+c1}{\PYGZsh{} Optimize computational efficiency}
    \PYG{c+c1}{\PYGZsh{} Reduce complexity where possible}
    \PYG{c+c1}{\PYGZsh{} Enhance successful components}
    \PYG{k}{pass}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{scale\PYGZus{}implementation}\PYG{p}{(}\PYG{n}{enhanced\PYGZus{}system}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Scale up implementation for real\PYGZhy{}world use}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Optimize for computational efficiency}
    \PYG{c+c1}{\PYGZsh{} Address edge cases}
    \PYG{c+c1}{\PYGZsh{} Add necessary complexity for general use}
    \PYG{c+c1}{\PYGZsh{} Document implementation details}
    \PYG{k}{pass}
\end{sphinxVerbatim}


\subsection{20.6.3 Interdisciplinary Collaboration Best Practices}
\label{\detokenize{part6/ch20_case_studies:interdisciplinary-collaboration-best-practices}}
\sphinxAtStartPar
The case studies highlight the importance of effective collaboration between neuroscientists and AI researchers:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Establish shared vocabulary}: Develop a common language that bridges neuroscience and AI concepts.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Focus on translatable insights}: Prioritize neuroscience findings with clear computational implications.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prototype and iterate}: Build small\sphinxhyphen{}scale prototypes to test neuroscience concepts before large\sphinxhyphen{}scale implementation.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mutual education}: Invest time in cross\sphinxhyphen{}disciplinary education to ensure deep understanding of both fields.

\end{enumerate}


\section{20.7 Practical Exercise: Implementing a Neuroscience\sphinxhyphen{}Inspired AI Component}
\label{\detokenize{part6/ch20_case_studies:practical-exercise-implementing-a-neuroscience-inspired-ai-component}}
\sphinxAtStartPar
This exercise guides you through implementing a simplified hippocampal\sphinxhyphen{}inspired memory system for reinforcement learning:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{collections}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{deque}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{random}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{EpisodicMemoryBuffer}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A simple episodic memory buffer inspired by hippocampal function}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{similarity\PYGZus{}threshold}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the episodic memory buffer}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        capacity : int}
\PYG{l+s+sd}{            Maximum number of episodes to store}
\PYG{l+s+sd}{        similarity\PYGZus{}threshold : float}
\PYG{l+s+sd}{            Threshold for determining similar experiences}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer} \PYG{o}{=} \PYG{n}{deque}\PYG{p}{(}\PYG{n}{maxlen}\PYG{o}{=}\PYG{n}{capacity}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{similarity\PYGZus{}threshold} \PYG{o}{=} \PYG{n}{similarity\PYGZus{}threshold}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add\PYGZus{}experience}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Add an experience to the buffer}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state : np.ndarray}
\PYG{l+s+sd}{            Current state}
\PYG{l+s+sd}{        action : int}
\PYG{l+s+sd}{            Action taken}
\PYG{l+s+sd}{        reward : float}
\PYG{l+s+sd}{            Reward received}
\PYG{l+s+sd}{        next\PYGZus{}state : np.ndarray}
\PYG{l+s+sd}{            Next state}
\PYG{l+s+sd}{        done : bool}
\PYG{l+s+sd}{            Whether the episode is done}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{experience} \PYG{o}{=} \PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{find\PYGZus{}similar\PYGZus{}experiences}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{query\PYGZus{}state}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Find experiences with similar states}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        query\PYGZus{}state : np.ndarray}
\PYG{l+s+sd}{            State to compare against}
\PYG{l+s+sd}{        k : int}
\PYG{l+s+sd}{            Number of similar experiences to retrieve}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        similar\PYGZus{}experiences : list}
\PYG{l+s+sd}{            List of similar experiences}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{similarities} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{experience} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{:}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{experience}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Compute cosine similarity}
            \PYG{n}{similarity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{query\PYGZus{}state}\PYG{p}{,} \PYG{n}{state}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{query\PYGZus{}state}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}8}\PYG{p}{)}
            \PYG{n}{similarities}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{similarity}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Sort by similarity}
        \PYG{n}{similarities}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}\PYG{n}{reverse}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Filter by threshold and get top k}
        \PYG{n}{similar\PYGZus{}experiences} \PYG{o}{=} \PYG{p}{[}\PYG{n}{exp} \PYG{k}{for} \PYG{n}{sim}\PYG{p}{,} \PYG{n}{exp} \PYG{o+ow}{in} \PYG{n}{similarities} \PYG{k}{if} \PYG{n}{sim} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{similarity\PYGZus{}threshold}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{n}{k}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{similar\PYGZus{}experiences}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample\PYGZus{}batch}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{include\PYGZus{}similar}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{query\PYGZus{}state}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Sample a batch of experiences}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        batch\PYGZus{}size : int}
\PYG{l+s+sd}{            Size of the batch to sample}
\PYG{l+s+sd}{        include\PYGZus{}similar : bool}
\PYG{l+s+sd}{            Whether to include similar experiences}
\PYG{l+s+sd}{        query\PYGZus{}state : np.ndarray or None}
\PYG{l+s+sd}{            State to find similar experiences for}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        batch : list}
\PYG{l+s+sd}{            Sampled batch of experiences}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Regular random sampling}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{batch\PYGZus{}size}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Regular random batch}
        \PYG{n}{random\PYGZus{}batch} \PYG{o}{=} \PYG{n}{random}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{5} \PYG{k}{if} \PYG{n}{include\PYGZus{}similar} \PYG{k}{else} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{include\PYGZus{}similar} \PYG{o+ow}{and} \PYG{n}{query\PYGZus{}state} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Find similar experiences}
            \PYG{n}{similar\PYGZus{}experiences} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{find\PYGZus{}similar\PYGZus{}experiences}\PYG{p}{(}\PYG{n}{query\PYGZus{}state}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Combine random and similar experiences}
            \PYG{n}{combined\PYGZus{}batch} \PYG{o}{=} \PYG{n}{random\PYGZus{}batch} \PYG{o}{+} \PYG{n}{similar\PYGZus{}experiences}
            
            \PYG{k}{return} \PYG{n}{combined\PYGZus{}batch}
        
        \PYG{k}{return} \PYG{n}{random\PYGZus{}batch}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{EpisodicReinforcementLearningAgent}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A reinforcement learning agent with episodic memory}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Initialize the agent}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimension of the state space}
\PYG{l+s+sd}{        action\PYGZus{}dim : int}
\PYG{l+s+sd}{            Dimension of the action space}
\PYG{l+s+sd}{        learning\PYGZus{}rate : float}
\PYG{l+s+sd}{            Learning rate for the model}
\PYG{l+s+sd}{        gamma : float}
\PYG{l+s+sd}{            Discount factor}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}dim} \PYG{o}{=} \PYG{n}{state\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim} \PYG{o}{=} \PYG{n}{action\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{=} \PYG{n}{gamma}
        
        \PYG{c+c1}{\PYGZsh{} Create episodic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{episodic\PYGZus{}memory} \PYG{o}{=} \PYG{n}{EpisodicMemoryBuffer}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simple Q\PYGZhy{}table for this example}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{select\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Select an action using epsilon\PYGZhy{}greedy policy with episodic memory}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        state : np.ndarray}
\PYG{l+s+sd}{            Current state}
\PYG{l+s+sd}{        epsilon : float}
\PYG{l+s+sd}{            Exploration rate}
\PYG{l+s+sd}{            }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{        action : int}
\PYG{l+s+sd}{            Selected action}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{epsilon}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Random exploration}
            \PYG{k}{return} \PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Check episodic memory for similar states}
            \PYG{n}{similar\PYGZus{}experiences} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{episodic\PYGZus{}memory}\PYG{o}{.}\PYG{n}{find\PYGZus{}similar\PYGZus{}experiences}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
            
            \PYG{k}{if} \PYG{n}{similar\PYGZus{}experiences} \PYG{o+ow}{and} \PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.3}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} 30\PYGZpc{} chance to use episodic memory}
                \PYG{c+c1}{\PYGZsh{} Use action from a similar experience with high reward}
                \PYG{n}{similar\PYGZus{}experiences}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}\PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{reverse}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Sort by reward}
                \PYG{k}{return} \PYG{n}{similar\PYGZus{}experiences}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Return action from highest\PYGZhy{}reward experience}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Use Q\PYGZhy{}table}
                \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{discretize\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{discretize\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Discretize continuous state (simplification for this example)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This is a placeholder; in a real implementation, }
        \PYG{c+c1}{\PYGZsh{} you would properly discretize the state space}
        \PYG{k}{return} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{10}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}dim}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{store\PYGZus{}experience}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Store experience in episodic memory}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{episodic\PYGZus{}memory}\PYG{o}{.}\PYG{n}{add\PYGZus{}experience}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update Q\PYGZhy{}table based on experience}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Discretize states for Q\PYGZhy{}table}
        \PYG{n}{state\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{discretize\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
        \PYG{n}{next\PYGZus{}state\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{discretize\PYGZus{}state}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Q\PYGZhy{}learning update}
        \PYG{n}{best\PYGZus{}next\PYGZus{}action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{next\PYGZus{}state\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{td\PYGZus{}target} \PYG{o}{=} \PYG{n}{reward} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{done}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{gamma} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{next\PYGZus{}state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{best\PYGZus{}next\PYGZus{}action}\PYG{p}{]}
        \PYG{n}{td\PYGZus{}error} \PYG{o}{=} \PYG{n}{td\PYGZus{}target} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state\PYGZus{}idx}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{td\PYGZus{}error}
        
        \PYG{c+c1}{\PYGZsh{} Store experience in episodic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{store\PYGZus{}experience}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}from\PYGZus{}episodic\PYGZus{}memory}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train using experiences from episodic memory}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Sample batch from episodic memory}
        \PYG{n}{batch} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{episodic\PYGZus{}memory}\PYG{o}{.}\PYG{n}{sample\PYGZus{}batch}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Learn from each experience}
        \PYG{k}{for} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done} \PYG{o+ow}{in} \PYG{n}{batch}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learn}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}episodic\PYGZus{}memory\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Run a simple example of episodic memory in reinforcement learning}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create environment (simplified for this example)}
    \PYG{n}{state\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{action\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{4}
    
    \PYG{c+c1}{\PYGZsh{} Create agent}
    \PYG{n}{agent} \PYG{o}{=} \PYG{n}{EpisodicReinforcementLearningAgent}\PYG{p}{(}\PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run episodes}
    \PYG{n}{num\PYGZus{}episodes} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{max\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{200}
    
    \PYG{k}{for} \PYG{n}{episode} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{num\PYGZus{}episodes}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Reset environment}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10\PYGZhy{}dimensional state}
        \PYG{n}{total\PYGZus{}reward} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{max\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Select action}
            \PYG{n}{action} \PYG{o}{=} \PYG{n}{agent}\PYG{o}{.}\PYG{n}{select\PYGZus{}action}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Take action (simplified environment dynamics)}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{state} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Get reward (simplified)}
            \PYG{n}{reward} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)} \PYG{k}{else} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}
            \PYG{n}{done} \PYG{o}{=} \PYG{n}{step} \PYG{o}{==} \PYG{n}{max\PYGZus{}steps} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{o+ow}{or} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mf}{9.0}
            
            \PYG{c+c1}{\PYGZsh{} Learn from experience}
            \PYG{n}{agent}\PYG{o}{.}\PYG{n}{learn}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update state and total reward}
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
            \PYG{n}{total\PYGZus{}reward} \PYG{o}{+}\PYG{o}{=} \PYG{n}{reward}
            
            \PYG{k}{if} \PYG{n}{done}\PYG{p}{:}
                \PYG{k}{break}
        
        \PYG{c+c1}{\PYGZsh{} Train from episodic memory}
        \PYG{n}{agent}\PYG{o}{.}\PYG{n}{train\PYGZus{}from\PYGZus{}episodic\PYGZus{}memory}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Print progress}
        \PYG{k}{if} \PYG{n}{episode} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Episode }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{episode}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Total Reward: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}reward}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}\PYGZus{}main\PYGZus{}\PYGZus{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{n}{run\PYGZus{}episodic\PYGZus{}memory\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{20.8 Chapter Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch20_case_studies:chapter-take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Successful NeuroAI implementations focus on computational principles rather than precise biological details

\item {} 
\sphinxAtStartPar
The most effective implementations involve iterative refinement between neuroscience insights and AI implementations

\item {} 
\sphinxAtStartPar
Key areas where neuroscience has informed AI include attention mechanisms, memory systems, predictive processing, and neural data analysis

\item {} 
\sphinxAtStartPar
Effective cross\sphinxhyphen{}disciplinary collaboration requires establishing shared vocabulary and mutual education

\item {} 
\sphinxAtStartPar
Implementing neuroscience principles in AI often requires creative adaptations to match the constraints of current deep learning frameworks

\item {} 
\sphinxAtStartPar
The most successful projects demonstrate measurable improvements in performance, generalization, or sample efficiency

\end{itemize}


\section{20.9 Interactive Materials and Exercises}
\label{\detokenize{part6/ch20_case_studies:interactive-materials-and-exercises}}
\sphinxAtStartPar
To deepen your understanding of the case studies presented in this chapter, we’ve created several interactive examples and exercises. These materials allow you to explore key concepts through hands\sphinxhyphen{}on experimentation.

\begin{sphinxadmonition}{tip}{Tip:}
\sphinxAtStartPar
Access the {\hyperref[\detokenize{part6/ch20_interactive::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{interactive notebook}}}} to experiment with:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{PredNet Visualization}: Adjust parameters to see how predictive coding works in practice

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prioritized Experience Replay}: Compare standard and prioritized replay in reinforcement learning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Vision Transformer Attention}: Visualize attention mechanisms on different image patches

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interactive Glossary}: Explore definitions with popup explanations of neural\sphinxhyphen{}AI connections

\end{enumerate}
\end{sphinxadmonition}

\sphinxAtStartPar
The interactive examples include sliders to adjust parameters, visualizations that update in real\sphinxhyphen{}time, and explanatory annotations to help you connect theoretical concepts with their practical implementations.


\subsection{AI\sphinxhyphen{}Assisted Learning}
\label{\detokenize{part6/ch20_case_studies:ai-assisted-learning}}
\sphinxAtStartPar
We’ve also integrated Jupyter AI to enhance your learning experience. With Jupyter AI, you can:

\begin{sphinxadmonition}{tip}{Tip:}
\sphinxAtStartPar
Explore the {\hyperref[\detokenize{part6/jupyter_ai_demo::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{AI\sphinxhyphen{}Assisted Learning notebook}}}} to:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generate Code}: Get implementation help for neuroscience\sphinxhyphen{}inspired AI models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Receive Explanations}: Ask for clarification on complex concepts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Debug Implementations}: Fix and improve your code

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Create Visualizations}: Generate custom visualizations for neural data

\end{enumerate}
\end{sphinxadmonition}

\sphinxAtStartPar
This integration of AI assistance allows for a more dynamic, personalized learning experience that adapts to your specific interests and questions about the case studies.


\subsection{Presentation Materials}
\label{\detokenize{part6/ch20_case_studies:presentation-materials}}
\sphinxAtStartPar
For educators and presenters, we’ve created a guide to developing slide presentations from the handbook content:

\begin{sphinxadmonition}{tip}{Tip:}
\sphinxAtStartPar
Check out our {\hyperref[\detokenize{part6/rise_slides_demo::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{RISE presentation guide}}}} to learn how to:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Create Interactive Slides}: Transform notebook content into polished presentations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Execute Live Code}: Run code demonstrations during presentations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Add Interactive Elements}: Include widgets and visualizations in slides

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Customize Styling}: Adjust themes and transitions for your audience

\end{enumerate}
\end{sphinxadmonition}

\sphinxAtStartPar
RISE (Reveal.js \sphinxhyphen{} Jupyter/IPython Slideshow Extension) allows you to create engaging presentations directly from Jupyter notebooks, perfect for teaching the concepts covered in this chapter.


\section{20.10 Further Reading}
\label{\detokenize{part6/ch20_case_studies:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Hassabis, D., Kumaran, D., Summerfield, C., \& Botvinick, M. (2017). Neuroscience\sphinxhyphen{}inspired artificial intelligence. \sphinxstyleemphasis{Neuron, 95}(2), 245\sphinxhyphen{}258.

\item {} 
\sphinxAtStartPar
Kriegeskorte, N., \& Douglas, P. K. (2018). Cognitive computational neuroscience. \sphinxstyleemphasis{Nature Neuroscience, 21}(9), 1148\sphinxhyphen{}1160.

\item {} 
\sphinxAtStartPar
Zador, A. M. (2019). A critique of pure learning and what artificial neural networks can learn from animal brains. \sphinxstyleemphasis{Nature Communications, 10}(1), 1\sphinxhyphen{}7.

\item {} 
\sphinxAtStartPar
Richards, B. A., et al. (2019). A deep learning framework for neuroscience. \sphinxstyleemphasis{Nature Neuroscience, 22}(11), 1761\sphinxhyphen{}1770.

\item {} 
\sphinxAtStartPar
Marblestone, A. H., Wayne, G., \& Kording, K. P. (2016). Toward an integration of deep learning and neuroscience. \sphinxstyleemphasis{Frontiers in Computational Neuroscience, 10}, 94.

\item {} 
\sphinxAtStartPar
Botvinick, M., et al. (2020). Deep reinforcement learning and its neuroscientific implications. \sphinxstyleemphasis{Neuron, 107}(4), 603\sphinxhyphen{}616.

\end{itemize}

\sphinxstepscope


\section{Interactive Examples for Case Studies in NeuroAI}
\label{\detokenize{part6/ch20_interactive:interactive-examples-for-case-studies-in-neuroai}}\label{\detokenize{part6/ch20_interactive::doc}}
\sphinxAtStartPar
This notebook provides interactive examples to complement Chapter 20: Case Studies in NeuroAI. You can run these examples directly in the book or launch a Binder session to experiment with the code.


\subsection{Interactive Example 1: PredNet Visualization}
\label{\detokenize{part6/ch20_interactive:interactive-example-1-prednet-visualization}}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_thebe-init}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Install dependencies if needed}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{sys}
\PYG{o}{!}\PYG{o}{\PYGZob{}}sys.executable\PYG{o}{\PYGZcb{}}\PYG{+w}{ }\PYGZhy{}m\PYG{+w}{ }pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }matplotlib\PYG{+w}{ }numpy\PYG{+w}{ }ipywidgets\PYG{+w}{ }plotly
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{widgets}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{interact}\PYG{p}{,} \PYG{n}{fixed}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{display}\PYG{p}{,} \PYG{n}{clear\PYGZus{}output}

\PYG{c+c1}{\PYGZsh{} Simplified PredNet simulation function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}prednet}\PYG{p}{(}\PYG{n}{input\PYGZus{}noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}strength}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{timesteps}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Initialize arrays}
    \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}
    \PYG{n}{errors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}
    \PYG{n}{representation} \PYG{o}{=} \PYG{l+m+mf}{0.0}
    
    \PYG{c+c1}{\PYGZsh{} Simulate a simple oscillating input with noise}
    \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{timesteps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Input signal (sine wave + noise)}
        \PYG{n}{inputs}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{input\PYGZus{}noise}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate prediction from representation}
        \PYG{n}{predictions}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prediction\PYGZus{}strength} \PYG{o}{*} \PYG{n}{representation}
        
        \PYG{c+c1}{\PYGZsh{} Compute prediction error}
        \PYG{n}{errors}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{=} \PYG{n}{inputs}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{predictions}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Update representation based on error}
        \PYG{n}{representation} \PYG{o}{+}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{errors}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{errors}

\PYG{c+c1}{\PYGZsh{} Plotting function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}prednet\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{errors}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{predictions}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{errors}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Interactive widget}
\PYG{n+nd}{@widgets}\PYG{o}{.}\PYG{n}{interact}\PYG{p}{(}
    \PYG{n}{input\PYGZus{}noise}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Noise:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{prediction\PYGZus{}strength}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pred. Strength:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Rate:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{p}{)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{interactive\PYGZus{}prednet}\PYG{p}{(}\PYG{n}{input\PYGZus{}noise}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}strength}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{errors} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}prednet}\PYG{p}{(}\PYG{n}{input\PYGZus{}noise}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}strength}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}prednet\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{errors}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
interactive(children=(FloatSlider(value=0.1, description=\PYGZsq{}Input Noise:\PYGZsq{}, max=0.5, step=0.05), FloatSlider(valu…
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Interactive Example 2: Prioritized Experience Replay}
\label{\detokenize{part6/ch20_interactive:interactive-example-2-prioritized-experience-replay}}
\sphinxAtStartPar
This interactive example demonstrates how prioritized experience replay can improve learning efficiency in reinforcement learning.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{widgets}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{interact}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{clear\PYGZus{}output}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{graph\PYGZus{}objects}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{go}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{subplots}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{make\PYGZus{}subplots}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{random}

\PYG{c+c1}{\PYGZsh{} Simple environment}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleGridworld}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size} \PYG{o}{=} \PYG{n}{size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}state}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} 0: up, 1: right, 2: down, 3: left}
        \PYG{n}{moves} \PYG{o}{=} \PYG{p}{[}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{]}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos}
        \PYG{n}{dx}\PYG{p}{,} \PYG{n}{dy} \PYG{o}{=} \PYG{n}{moves}\PYG{p}{[}\PYG{n}{action}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Move agent}
        \PYG{n}{new\PYGZus{}x} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{x} \PYG{o}{+} \PYG{n}{dx}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{new\PYGZus{}y} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{size}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{n}{dy}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{n}{new\PYGZus{}x}\PYG{p}{,} \PYG{n}{new\PYGZus{}y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate reward}
        \PYG{n}{done} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{agent\PYGZus{}pos} \PYG{o}{==} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal\PYGZus{}pos}
        \PYG{n}{reward} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{k}{if} \PYG{n}{done} \PYG{k}{else} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.01}
        
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}state}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done}

\PYG{c+c1}{\PYGZsh{} Simple replay buffer}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ReplayBuffer}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{random}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Prioritized replay buffer}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PrioritizedReplayBuffer}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha} \PYG{o}{=} \PYG{n}{alpha}  \PYG{c+c1}{\PYGZsh{} Priority exponent}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{,} \PYG{n}{priority}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{priority} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{priority} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Default priority}
            
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
            
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{priority}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{[}\PYG{p}{]}
            
        \PYG{c+c1}{\PYGZsh{} Calculate sampling probabilities}
        \PYG{n}{priorities} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha}
        \PYG{n}{probs} \PYG{o}{=} \PYG{n}{priorities} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{priorities}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Sample based on priorities}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{p}\PYG{o}{=}\PYG{n}{probs}\PYG{p}{)}
        \PYG{n}{samples} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{k}{for} \PYG{n}{idx} \PYG{o+ow}{in} \PYG{n}{indices}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{samples}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}priorities}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{indices}\PYG{p}{,} \PYG{n}{priorities}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{idx}\PYG{p}{,} \PYG{n}{priority} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{priorities}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{idx} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities}\PYG{p}{)}\PYG{p}{:}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{priorities}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{priority}

\PYG{c+c1}{\PYGZsh{} Simple Q\PYGZhy{}learning agent}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{QLearningAgent}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{,} \PYG{n}{prioritized}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{state\PYGZus{}dim} \PYG{o}{=} \PYG{n}{state\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim} \PYG{o}{=} \PYG{n}{action\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prioritized} \PYG{o}{=} \PYG{n}{prioritized}
        
        \PYG{k}{if} \PYG{n}{prioritized}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{PrioritizedReplayBuffer}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer} \PYG{o}{=} \PYG{n}{ReplayBuffer}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{select\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{epsilon}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}dim}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate TD error}
        \PYG{n}{q\PYGZus{}value} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]}
        \PYG{n}{next\PYGZus{}q\PYGZus{}value} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{next\PYGZus{}state}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{done} \PYG{k}{else} \PYG{l+m+mi}{0}
        \PYG{n}{td\PYGZus{}target} \PYG{o}{=} \PYG{n}{reward} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{*} \PYG{n}{next\PYGZus{}q\PYGZus{}value}
        \PYG{n}{td\PYGZus{}error} \PYG{o}{=} \PYG{n}{td\PYGZus{}target} \PYG{o}{\PYGZhy{}} \PYG{n}{q\PYGZus{}value}
        
        \PYG{c+c1}{\PYGZsh{} Store experience with priority}
        \PYG{n}{experience} \PYG{o}{=} \PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prioritized}\PYG{p}{:}
            \PYG{n}{priority} \PYG{o}{=} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{td\PYGZus{}error}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.01}  \PYG{c+c1}{\PYGZsh{} Small constant for stability}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update Q\PYGZhy{}value directly}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{td\PYGZus{}error}
        
        \PYG{k}{return} \PYG{n}{td\PYGZus{}error}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{replay}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Learn from experiences in replay buffer}
        \PYG{n}{experiences} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
        
        \PYG{n}{td\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done} \PYG{o+ow}{in} \PYG{n}{experiences}\PYG{p}{:}
            \PYG{n}{q\PYGZus{}value} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]}
            \PYG{n}{next\PYGZus{}q\PYGZus{}value} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{next\PYGZus{}state}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{done} \PYG{k}{else} \PYG{l+m+mi}{0}
            \PYG{n}{td\PYGZus{}target} \PYG{o}{=} \PYG{n}{reward} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{*} \PYG{n}{next\PYGZus{}q\PYGZus{}value}
            \PYG{n}{td\PYGZus{}error} \PYG{o}{=} \PYG{n}{td\PYGZus{}target} \PYG{o}{\PYGZhy{}} \PYG{n}{q\PYGZus{}value}
            
            \PYG{c+c1}{\PYGZsh{} Update Q\PYGZhy{}value}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q\PYGZus{}table}\PYG{p}{[}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{td\PYGZus{}error}
            \PYG{n}{td\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{td\PYGZus{}error}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} If using prioritized replay, update priorities}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prioritized} \PYG{o+ow}{and} \PYG{n}{experiences}\PYG{p}{:}
            \PYG{n}{indices} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{experiences}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{update\PYGZus{}priorities}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{td\PYGZus{}errors}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Function to run experiment}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}experiment}\PYG{p}{(}\PYG{n}{prioritized}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{episodes}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{epsilon}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{l+m+mf}{0.99}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{env} \PYG{o}{=} \PYG{n}{SimpleGridworld}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
    \PYG{n}{state\PYGZus{}dim} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size} \PYG{o}{*} \PYG{n}{env}\PYG{o}{.}\PYG{n}{size}
    \PYG{n}{action\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{4}
    
    \PYG{n}{agent} \PYG{o}{=} \PYG{n}{QLearningAgent}\PYG{p}{(}\PYG{n}{state\PYGZus{}dim}\PYG{p}{,} \PYG{n}{action\PYGZus{}dim}\PYG{p}{,} \PYG{n}{prioritized}\PYG{p}{,} \PYG{n}{alpha}\PYG{p}{)}
    
    \PYG{n}{rewards\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{steps\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{td\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{episode} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{episodes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{total\PYGZus{}reward} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{steps} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{episode\PYGZus{}td\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{while} \PYG{k+kc}{True}\PYG{p}{:}
            \PYG{n}{action} \PYG{o}{=} \PYG{n}{agent}\PYG{o}{.}\PYG{n}{select\PYGZus{}action}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{epsilon}\PYG{p}{)}
            \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{action}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Learn from this experience}
            \PYG{n}{td\PYGZus{}error} \PYG{o}{=} \PYG{n}{agent}\PYG{o}{.}\PYG{n}{learn}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{,} \PYG{n}{gamma}\PYG{p}{)}
            \PYG{n}{episode\PYGZus{}td\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{td\PYGZus{}error}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Learn from replay buffer}
            \PYG{k}{if} \PYG{n}{steps} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Replay every 5 steps}
                \PYG{n}{agent}\PYG{o}{.}\PYG{n}{replay}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{learning\PYGZus{}rate}\PYG{p}{,} \PYG{n}{gamma}\PYG{o}{=}\PYG{n}{gamma}\PYG{p}{)}
            
            \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
            \PYG{n}{total\PYGZus{}reward} \PYG{o}{+}\PYG{o}{=} \PYG{n}{reward}
            \PYG{n}{steps} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
            
            \PYG{k}{if} \PYG{n}{done} \PYG{o+ow}{or} \PYG{n}{steps} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Max 100 steps per episode}
                \PYG{k}{break}
        
        \PYG{n}{rewards\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{total\PYGZus{}reward}\PYG{p}{)}
        \PYG{n}{steps\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
        \PYG{n}{td\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{episode\PYGZus{}td\PYGZus{}errors}\PYG{p}{)} \PYG{k}{if} \PYG{n}{episode\PYGZus{}td\PYGZus{}errors} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{rewards\PYGZus{}history}\PYG{p}{,} \PYG{n}{steps\PYGZus{}history}\PYG{p}{,} \PYG{n}{td\PYGZus{}errors}

\PYG{c+c1}{\PYGZsh{} Plotting function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}experiment\PYGZus{}results}\PYG{p}{(}\PYG{n}{standard\PYGZus{}results}\PYG{p}{,} \PYG{n}{prioritized\PYGZus{}results}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{std\PYGZus{}rewards}\PYG{p}{,} \PYG{n}{std\PYGZus{}steps}\PYG{p}{,} \PYG{n}{std\PYGZus{}errors} \PYG{o}{=} \PYG{n}{standard\PYGZus{}results}
    \PYG{n}{pri\PYGZus{}rewards}\PYG{p}{,} \PYG{n}{pri\PYGZus{}steps}\PYG{p}{,} \PYG{n}{pri\PYGZus{}errors} \PYG{o}{=} \PYG{n}{prioritized\PYGZus{}results}
    
    \PYG{c+c1}{\PYGZsh{} Create subplots}
    \PYG{n}{fig} \PYG{o}{=} \PYG{n}{make\PYGZus{}subplots}\PYG{p}{(}\PYG{n}{rows}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{cols}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} 
                        \PYG{n}{subplot\PYGZus{}titles}\PYG{o}{=}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Total Reward per Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
                                        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Steps per Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean TD Error per Episode}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add traces}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{std\PYGZus{}rewards}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Standard Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{pri\PYGZus{}rewards}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prioritized Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{std\PYGZus{}steps}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Standard Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{pri\PYGZus{}steps}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prioritized Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{std\PYGZus{}errors}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Standard Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}trace}\PYG{p}{(}
        \PYG{n}{go}\PYG{o}{.}\PYG{n}{Scatter}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{pri\PYGZus{}errors}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lines}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prioritized Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Update layout}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{update\PYGZus{}layout}\PYG{p}{(}\PYG{n}{height}\PYG{o}{=}\PYG{l+m+mi}{800}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mi}{800}\PYG{p}{,} \PYG{n}{title\PYGZus{}text}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Standard vs Prioritized Experience Replay}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Update y\PYGZhy{}axis titles}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{update\PYGZus{}yaxes}\PYG{p}{(}\PYG{n}{title\PYGZus{}text}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reward}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{update\PYGZus{}yaxes}\PYG{p}{(}\PYG{n}{title\PYGZus{}text}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Steps}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{update\PYGZus{}yaxes}\PYG{p}{(}\PYG{n}{title\PYGZus{}text}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TD Error}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Update x\PYGZhy{}axis titles}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{update\PYGZus{}xaxes}\PYG{p}{(}\PYG{n}{title\PYGZus{}text}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Episode}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{row}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{col}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Interactive experiment runner}
\PYG{n+nd}{@widgets}\PYG{o}{.}\PYG{n}{interact}\PYG{p}{(}
    \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Alpha:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{episodes}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{IntSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Episodes:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Rate:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{p}{)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{interactive\PYGZus{}replay\PYGZus{}experiment}\PYG{p}{(}\PYG{n}{alpha}\PYG{p}{,} \PYG{n}{episodes}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running experiment with Standard Replay...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{standard\PYGZus{}results} \PYG{o}{=} \PYG{n}{run\PYGZus{}experiment}\PYG{p}{(}\PYG{n}{prioritized}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{episodes}\PYG{o}{=}\PYG{n}{episodes}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running experiment with Prioritized Replay...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{prioritized\PYGZus{}results} \PYG{o}{=} \PYG{n}{run\PYGZus{}experiment}\PYG{p}{(}\PYG{n}{prioritized}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{n}{alpha}\PYG{p}{,} \PYG{n}{episodes}\PYG{o}{=}\PYG{n}{episodes}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{n}{learning\PYGZus{}rate}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Plotting results...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plot\PYGZus{}experiment\PYGZus{}results}\PYG{p}{(}\PYG{n}{standard\PYGZus{}results}\PYG{p}{,} \PYG{n}{prioritized\PYGZus{}results}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
interactive(children=(FloatSlider(value=0.6, description=\PYGZsq{}Alpha:\PYGZsq{}, max=1.0, min=0.1), IntSlider(value=50, desc…
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Interactive Example 3: Vision Transformer Attention Visualization}
\label{\detokenize{part6/ch20_interactive:interactive-example-3-vision-transformer-attention-visualization}}
\sphinxAtStartPar
This interactive example shows how attention works in Vision Transformers.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{widgets}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{interact}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{display}\PYG{p}{,} \PYG{n}{HTML}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{random}

\PYG{c+c1}{\PYGZsh{} Simulate attention patterns for Vision Transformer}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}sample\PYGZus{}image}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{seed}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a sample binary image with a pattern\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{seed} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{n}{seed}\PYG{p}{)}
        
    \PYG{c+c1}{\PYGZsh{} Create a blank image}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{size}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add a random shape (square, circle, or line)}
    \PYG{n}{shape\PYGZus{}type} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{square}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{circle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{line}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{shape\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{square}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Add a square}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{w}\PYG{p}{,} \PYG{n}{h} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{img}\PYG{p}{[}\PYG{n}{x}\PYG{p}{:}\PYG{n}{x}\PYG{o}{+}\PYG{n}{w}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:}\PYG{n}{y}\PYG{o}{+}\PYG{n}{h}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{k}{elif} \PYG{n}{shape\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{circle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Add a circle}
        \PYG{n}{center\PYGZus{}x}\PYG{p}{,} \PYG{n}{center\PYGZus{}y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{radius} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{size}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{n}{center\PYGZus{}x}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{p}{(}\PYG{n}{j} \PYG{o}{\PYGZhy{}} \PYG{n}{center\PYGZus{}y}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{\PYGZlt{}} \PYG{n}{radius}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{:}
                    \PYG{n}{img}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{k}{else}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} line}
        \PYG{c+c1}{\PYGZsh{} Add a line}
        \PYG{n}{start\PYGZus{}x}\PYG{p}{,} \PYG{n}{start\PYGZus{}y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{end\PYGZus{}x}\PYG{p}{,} \PYG{n}{end\PYGZus{}y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simple line drawing algorithm}
        \PYG{n}{length} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{end\PYGZus{}x} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}x}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{end\PYGZus{}y} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}y}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{length}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{start\PYGZus{}x} \PYG{o}{+} \PYG{p}{(}\PYG{n}{end\PYGZus{}x} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}x}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i} \PYG{o}{/} \PYG{n}{length}\PYG{p}{)}
            \PYG{n}{y} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{start\PYGZus{}y} \PYG{o}{+} \PYG{p}{(}\PYG{n}{end\PYGZus{}y} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}y}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i} \PYG{o}{/} \PYG{n}{length}\PYG{p}{)}
            \PYG{k}{if} \PYG{l+m+mi}{0} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{x} \PYG{o}{\PYGZlt{}} \PYG{n}{size} \PYG{o+ow}{and} \PYG{l+m+mi}{0} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{y} \PYG{o}{\PYGZlt{}} \PYG{n}{size}\PYG{p}{:}
                \PYG{n}{img}\PYG{p}{[}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{k}{return} \PYG{n}{img}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{split\PYGZus{}image\PYGZus{}into\PYGZus{}patches}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Split an image into patches\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{h}\PYG{p}{,} \PYG{n}{w} \PYG{o}{=} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{patches} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{patch\PYGZus{}positions} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{h} \PYG{o+ow}{and} \PYG{n}{j} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{w}\PYG{p}{:}
                \PYG{n}{patch} \PYG{o}{=} \PYG{n}{image}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{j}\PYG{p}{:}\PYG{n}{j}\PYG{o}{+}\PYG{n}{patch\PYGZus{}size}\PYG{p}{]}
                \PYG{n}{patches}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{patch}\PYG{p}{)}
                \PYG{n}{patch\PYGZus{}positions}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{patches}\PYG{p}{,} \PYG{n}{patch\PYGZus{}positions}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}attention\PYGZus{}map}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{,} \PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{,} \PYG{n}{attention\PYGZus{}strength}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{noise}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a simulated attention map for a specific patch\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{num\PYGZus{}patches} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{)}
    \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{num\PYGZus{}patches}\PYG{p}{)} \PYG{o}{*} \PYG{n}{noise}
    
    \PYG{c+c1}{\PYGZsh{} Increase attention for patches that have similar content}
    \PYG{n}{focus\PYGZus{}patch} \PYG{o}{=} \PYG{n}{patches}\PYG{p}{[}\PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{patch} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{similarity} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{patch} \PYG{o}{\PYGZhy{}} \PYG{n}{focus\PYGZus{}patch}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{attention\PYGZus{}scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{similarity} \PYG{o}{*} \PYG{n}{attention\PYGZus{}strength}
    
    \PYG{c+c1}{\PYGZsh{} Normalize}
    \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{attention\PYGZus{}scores} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{attention\PYGZus{}scores}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{attention\PYGZus{}scores}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}attention}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{patches}\PYG{p}{,} \PYG{n}{patch\PYGZus{}positions}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{,} \PYG{n}{attention\PYGZus{}scores}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize the image and attention map\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot the original image with patch grid}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{h}\PYG{p}{,} \PYG{n}{w} \PYG{o}{=} \PYG{n}{image}\PYG{o}{.}\PYG{n}{shape}
    
    \PYG{c+c1}{\PYGZsh{} Draw patch grid}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight the focus patch}
    \PYG{n}{focus\PYGZus{}i}\PYG{p}{,} \PYG{n}{focus\PYGZus{}j} \PYG{o}{=} \PYG{n}{patch\PYGZus{}positions}\PYG{p}{[}\PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{]}
    \PYG{n}{rect} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{focus\PYGZus{}j}\PYG{p}{,} \PYG{n}{focus\PYGZus{}i}\PYG{p}{)}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,} 
                         \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Original Image (Focus on Patch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot the attention map}
    \PYG{n}{attention\PYGZus{}map} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{idx}\PYG{p}{,} \PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{patch\PYGZus{}positions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{attention\PYGZus{}map}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{j}\PYG{p}{:}\PYG{n}{j}\PYG{o}{+}\PYG{n}{patch\PYGZus{}size}\PYG{p}{]} \PYG{o}{=} \PYG{n}{attention\PYGZus{}scores}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
    
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{attention\PYGZus{}map}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Attention Map}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Interactive visualization}
\PYG{n+nd}{@widgets}\PYG{o}{.}\PYG{n}{interact}\PYG{p}{(}
    \PYG{n}{seed}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{IntSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Image Seed:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{focus\PYGZus{}patch}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{IntSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Focus Patch:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{attention\PYGZus{}strength}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Strength:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{noise}\PYG{o}{=}\PYG{n}{widgets}\PYG{o}{.}\PYG{n}{FloatSlider}\PYG{p}{(}\PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{n+nb}{max}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noise Level:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{p}{)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{interactive\PYGZus{}attention\PYGZus{}visualization}\PYG{p}{(}\PYG{n}{seed}\PYG{p}{,} \PYG{n}{focus\PYGZus{}patch}\PYG{p}{,} \PYG{n}{attention\PYGZus{}strength}\PYG{p}{,} \PYG{n}{noise}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Create a sample image}
    \PYG{n}{image\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{16}
    \PYG{n}{patch\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{4}
    \PYG{n}{image} \PYG{o}{=} \PYG{n}{create\PYGZus{}sample\PYGZus{}image}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{n}{image\PYGZus{}size}\PYG{p}{,} \PYG{n}{seed}\PYG{o}{=}\PYG{n}{seed}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split into patches}
    \PYG{n}{patches}\PYG{p}{,} \PYG{n}{patch\PYGZus{}positions} \PYG{o}{=} \PYG{n}{split\PYGZus{}image\PYGZus{}into\PYGZus{}patches}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{n}{patch\PYGZus{}size}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Ensure focus\PYGZus{}patch is valid}
    \PYG{n}{num\PYGZus{}patches} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{)}
    \PYG{n}{focus\PYGZus{}patch\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{focus\PYGZus{}patch}\PYG{p}{,} \PYG{n}{num\PYGZus{}patches}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate attention map}
    \PYG{n}{attention\PYGZus{}scores} \PYG{o}{=} \PYG{n}{generate\PYGZus{}attention\PYGZus{}map}\PYG{p}{(}\PYG{n}{patches}\PYG{p}{,} \PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{,} \PYG{n}{attention\PYGZus{}strength}\PYG{p}{,} \PYG{n}{noise}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Visualize}
    \PYG{n}{visualize\PYGZus{}attention}\PYG{p}{(}\PYG{n}{image}\PYG{p}{,} \PYG{n}{patches}\PYG{p}{,} \PYG{n}{patch\PYGZus{}positions}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{focus\PYGZus{}patch\PYGZus{}idx}\PYG{p}{,} \PYG{n}{attention\PYGZus{}scores}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
interactive(children=(IntSlider(value=1, description=\PYGZsq{}Image Seed:\PYGZsq{}, max=10, min=1), IntSlider(value=0, descrip…
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Interactive Example 4: Glossary \sphinxhyphen{} Interactive Neural Mechanisms}
\label{\detokenize{part6/ch20_interactive:interactive-example-4-glossary-interactive-neural-mechanisms}}
\sphinxAtStartPar
Below is an interactive glossary of key terms from Chapter 20, with popups explaining neural mechanisms and their AI implementations.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{HTML}\PYG{p}{,} \PYG{n}{display}

\PYG{c+c1}{\PYGZsh{} Create interactive glossary with popups}
\PYG{n}{glossary\PYGZus{}html} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{\PYGZlt{}style\PYGZgt{}}
\PYG{l+s+s2}{.glossary\PYGZhy{}term }\PYG{l+s+s2}{\PYGZob{}}
\PYG{l+s+s2}{    color: \PYGZsh{}0366d6;}
\PYG{l+s+s2}{    cursor: pointer;}
\PYG{l+s+s2}{    font\PYGZhy{}weight: bold;}
\PYG{l+s+s2}{    text\PYGZhy{}decoration: underline;}
\PYG{l+s+s2}{    position: relative;}
\PYG{l+s+s2}{    display: inline\PYGZhy{}block;}
\PYG{l+s+s2}{\PYGZcb{}}

\PYG{l+s+s2}{.glossary\PYGZhy{}term .term\PYGZhy{}definition }\PYG{l+s+s2}{\PYGZob{}}
\PYG{l+s+s2}{    visibility: hidden;}
\PYG{l+s+s2}{    width: 350px;}
\PYG{l+s+s2}{    background\PYGZhy{}color: \PYGZsh{}f8f9fa;}
\PYG{l+s+s2}{    color: \PYGZsh{}333;}
\PYG{l+s+s2}{    text\PYGZhy{}align: left;}
\PYG{l+s+s2}{    border\PYGZhy{}radius: 6px;}
\PYG{l+s+s2}{    padding: 10px;}
\PYG{l+s+s2}{    position: absolute;}
\PYG{l+s+s2}{    z\PYGZhy{}index: 1;}
\PYG{l+s+s2}{    bottom: 125}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{;}
\PYG{l+s+s2}{    left: 50}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{;}
\PYG{l+s+s2}{    margin\PYGZhy{}left: \PYGZhy{}175px;}
\PYG{l+s+s2}{    box\PYGZhy{}shadow: 0px 0px 15px rgba(0,0,0,0.2);}
\PYG{l+s+s2}{    transition: opacity 0.3s;}
\PYG{l+s+s2}{    opacity: 0;}
\PYG{l+s+s2}{    font\PYGZhy{}weight: normal;}
\PYG{l+s+s2}{    text\PYGZhy{}decoration: none;}
\PYG{l+s+s2}{    font\PYGZhy{}size: 0.9em;}
\PYG{l+s+s2}{    border: 1px solid \PYGZsh{}ddd;}
\PYG{l+s+s2}{\PYGZcb{}}

\PYG{l+s+s2}{.glossary\PYGZhy{}term:hover .term\PYGZhy{}definition }\PYG{l+s+s2}{\PYGZob{}}
\PYG{l+s+s2}{    visibility: visible;}
\PYG{l+s+s2}{    opacity: 1;}
\PYG{l+s+s2}{\PYGZcb{}}
\PYG{l+s+s2}{\PYGZlt{}/style\PYGZgt{}}

\PYG{l+s+s2}{\PYGZlt{}h3\PYGZgt{}Interactive Glossary for Case Studies in NeuroAI\PYGZlt{}/h3\PYGZgt{}}

\PYG{l+s+s2}{\PYGZlt{}div style=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{background\PYGZhy{}color: \PYGZsh{}f5f5f5; padding: 15px; border\PYGZhy{}radius: 5px; margin\PYGZhy{}top: 20px;}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}p\PYGZgt{}Hover over each term to see its definition and neural\PYGZhy{}AI connections.\PYGZlt{}/p\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Predictive Coding}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}Predictive Coding\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Mechanism:\PYGZlt{}/em\PYGZgt{} The brain continually generates predictions about incoming sensory information and learns from prediction errors.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}AI Implementation:\PYGZlt{}/em\PYGZgt{} PredNet architecture implements hierarchical predictive processing with explicit representation of prediction errors between layers.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapter 20.2}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}PredNet}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}PredNet\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Description:\PYGZlt{}/em\PYGZgt{} A deep learning architecture implementing hierarchical predictive coding, with explicit computation of prediction errors at each layer.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Parallel:\PYGZlt{}/em\PYGZgt{} Mirrors the predictive processing in visual cortex, with both bottom\PYGZhy{}up and top\PYGZhy{}down information flow.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Advantages:\PYGZlt{}/em\PYGZgt{} Superior performance in video prediction and sample\PYGZhy{}efficient learning.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapter 20.2.2}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Prioritized Experience Replay (PER)}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}Prioritized Experience Replay (PER)\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Mechanism:\PYGZlt{}/em\PYGZgt{} The hippocampus selectively consolidates behaviorally relevant experiences during sleep and rest.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}AI Implementation:\PYGZlt{}/em\PYGZgt{} In reinforcement learning, experiences with high TD error (surprising outcomes) are sampled more frequently during training.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Benefits:\PYGZlt{}/em\PYGZgt{} 50}\PYG{l+s+si}{\PYGZpc{} f}\PYG{l+s+s2}{aster convergence and 20}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{ better final performance in many RL tasks.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapter 20.3}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Vision Transformer (ViT)}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}Vision Transformer (ViT)\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Mechanism:\PYGZlt{}/em\PYGZgt{} Visual attention in humans allows selective processing of relevant information while filtering distractions.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}AI Implementation:\PYGZlt{}/em\PYGZgt{} Divides images into patches, processes them with self\PYGZhy{}attention mechanisms to capture relationships between distant image regions.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Key Innovation:\PYGZlt{}/em\PYGZgt{} Demonstrates that attention\PYGZhy{}based models can outperform CNNs on image classification tasks when pre\PYGZhy{}trained on sufficient data.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapter 20.4}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Latent Factor Analysis via Dynamical Systems (LFADS)}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}Latent Factor Analysis via Dynamical Systems (LFADS)\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Principle:\PYGZlt{}/em\PYGZgt{} High\PYGZhy{}dimensional neural activity often reflects low\PYGZhy{}dimensional latent dynamics.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}AI Technique:\PYGZlt{}/em\PYGZgt{} Uses variational auto\PYGZhy{}encoders with recurrent neural networks to model underlying dynamics in neural population recordings.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Applications:\PYGZlt{}/em\PYGZgt{} Single\PYGZhy{}trial neural decoding, extracting dynamics from noisy spike recordings, improved BMI control.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapter 20.5}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{    }
\PYG{l+s+s2}{    \PYGZlt{}div class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glossary\PYGZhy{}term}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Attention Mechanism}
\PYG{l+s+s2}{        \PYGZlt{}span class=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{term\PYGZhy{}definition}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}strong\PYGZgt{}Attention Mechanism\PYGZlt{}/strong\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Neural Basis:\PYGZlt{}/em\PYGZgt{} The brain}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s ability to selectively focus on important stimuli while ignoring distractions.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}AI Implementation:\PYGZlt{}/em\PYGZgt{} Computational technique that allows models to weight the importance of different input elements.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Example:\PYGZlt{}/em\PYGZgt{} Self\PYGZhy{}attention in Vision Transformers allows each image patch to attend to all other patches.\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}em\PYGZgt{}Chapter Reference:\PYGZlt{}/em\PYGZgt{} Chapters 11 and 20.4}
\PYG{l+s+s2}{        \PYGZlt{}/span\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}br\PYGZgt{}\PYGZlt{}br\PYGZgt{}}
\PYG{l+s+s2}{\PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}

\PYG{n}{display}\PYG{p}{(}\PYG{n}{HTML}\PYG{p}{(}\PYG{n}{glossary\PYGZus{}html}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZlt{}IPython.core.display.HTML object\PYGZgt{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Connect to Binder}
\label{\detokenize{part6/ch20_interactive:connect-to-binder}}
\sphinxAtStartPar
You can run this notebook interactively on Binder without any local installation.

\sphinxAtStartPar
\sphinxhref{https://mybinder.org/v2/gh/yourusername/NeuroAI-Handbook/main?filepath=book/part6/ch20\_interactive.ipynb}{\sphinxincludegraphics{{/Volumes/data_bolt/_github/NeuroAI-Handbook/book/_build/.doctrees/images/fbe1d2f89215b7589b3f89aa2112c2614f97d3b5/badge_logo}.svg}}


\subsection{Summary}
\label{\detokenize{part6/ch20_interactive:summary}}
\sphinxAtStartPar
These interactive examples demonstrate key concepts from Chapter 20: Case Studies in NeuroAI:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{PredNet Visualization}: Explore how predictive coding works by adjusting parameters and seeing how prediction errors change.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Prioritized Experience Replay}: Compare standard and prioritized replay methods in reinforcement learning.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Vision Transformer Attention}: Visualize how attention mechanisms in ViT focus on different parts of an image.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Interactive Glossary}: Hover over key terms to see detailed explanations and neural\sphinxhyphen{}AI connections.

\end{enumerate}

\sphinxAtStartPar
These examples help bridge theoretical concepts with practical implementations, making the case studies more concrete and accessible.

\sphinxstepscope


\section{Jupyter AI Integration for NeuroAI}
\label{\detokenize{part6/jupyter_ai_demo:jupyter-ai-integration-for-neuroai}}\label{\detokenize{part6/jupyter_ai_demo::doc}}
\sphinxAtStartPar
This notebook demonstrates how to use Jupyter AI to enhance the learning experience when studying neuroscience and AI concepts. Jupyter AI integrates generative AI capabilities directly into Jupyter notebooks, allowing you to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Generate code examples based on neuroscience concepts

\item {} 
\sphinxAtStartPar
Get explanations of complex neural network architectures

\item {} 
\sphinxAtStartPar
Debug and improve code implementations

\item {} 
\sphinxAtStartPar
Generate visualizations for neural data

\item {} 
\sphinxAtStartPar
Summarize research papers and concepts

\end{itemize}


\subsection{Setup Instructions}
\label{\detokenize{part6/jupyter_ai_demo:setup-instructions}}
\sphinxAtStartPar
To use Jupyter AI, you’ll need to install the required packages:

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_thebe-init}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Install Jupyter AI and dependencies}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }jupyter\PYGZhy{}ai\PYG{+w}{ }jupyter\PYGZhy{}ai\PYGZhy{}magics\PYG{+w}{ }openai
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
After installation, you need to enable the extension. In JupyterLab, this happens automatically. In a classic notebook, you may need to run:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Enable Jupyter AI magics}
\PYG{o}{\PYGZpc{}}\PYG{k}{load\PYGZus{}ext} jupyter\PYGZus{}ai\PYGZus{}magics
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\subsection{Configuring Jupyter AI}
\label{\detokenize{part6/jupyter_ai_demo:configuring-jupyter-ai}}
\sphinxAtStartPar
Jupyter AI can be configured to use different AI models:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
OpenAI models (requires API key)

\item {} 
\sphinxAtStartPar
Anthropic Claude models (requires API key)

\item {} 
\sphinxAtStartPar
Open source models via Hugging Face or local installation

\end{enumerate}

\sphinxAtStartPar
To configure an API key, you can use environment variables or the Jupyter configuration system. For this demo, we’ll use a placeholder approach:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example configuration (for demonstration only)}
\PYG{c+c1}{\PYGZsh{} In a real setup, you would set these via environment variables}
\PYG{c+c1}{\PYGZsh{} import os}
\PYG{c+c1}{\PYGZsh{} os.environ[\PYGZdq{}OPENAI\PYGZus{}API\PYGZus{}KEY\PYGZdq{}] = \PYGZdq{}your\PYGZhy{}api\PYGZhy{}key\PYGZdq{}}
\PYG{c+c1}{\PYGZsh{} os.environ[\PYGZdq{}ANTHROPIC\PYGZus{}API\PYGZus{}KEY\PYGZdq{}] = \PYGZdq{}your\PYGZhy{}api\PYGZhy{}key\PYGZdq{}}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Note: For actual use, you}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ll need to configure your API keys}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{See: https://jupyter\PYGZhy{}ai.readthedocs.io/en/latest/users/index.html}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Note: For actual use, you\PYGZsq{}ll need to configure your API keys
See: https://jupyter\PYGZhy{}ai.readthedocs.io/en/latest/users/index.html
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Using Jupyter AI with NeuroAI}
\label{\detokenize{part6/jupyter_ai_demo:using-jupyter-ai-with-neuroai}}
\sphinxAtStartPar
Jupyter AI can be used in several ways:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Using cell magics with \sphinxcode{\sphinxupquote{\%\%ai}}

\item {} 
\sphinxAtStartPar
Using line magics with \sphinxcode{\sphinxupquote{\%ai}}

\item {} 
\sphinxAtStartPar
Using the chat interface in JupyterLab

\end{enumerate}

\sphinxAtStartPar
Let’s see some examples of how to use these features for NeuroAI tasks.


\subsubsection{Example 1: Generating Code for Neuroscience Models}
\label{\detokenize{part6/jupyter_ai_demo:example-1-generating-code-for-neuroscience-models}}
\sphinxAtStartPar
We can use Jupyter AI to generate code for implementing neuroscience\sphinxhyphen{}inspired models:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}\PYGZpc{}}\PYG{k}{ai} gpt\PYGZhy{}4
Write a PyTorch implementation of a predictive coding network for visual inputs, based on the PredNet architecture described in Chapter 20. Include comments explaining the biological inspiration for each component.
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\sphinxAtStartPar
Cannot determine model provider from model ID \sphinxcode{\sphinxupquote{gpt\sphinxhyphen{}4}}.

\sphinxAtStartPar
To see a list of models you can use, run \sphinxcode{\sphinxupquote{\%ai list}}

\sphinxAtStartPar
If you were trying to run a command, run \sphinxcode{\sphinxupquote{\%ai help}} to see a list of commands.

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Note: In a live Jupyter AI environment, the code above would produce a complete PyTorch implementation of PredNet. Since we don’t have API keys configured here, we’ll show an example of what the output might look like:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PredNetLayer}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    A single layer of the PredNet architecture}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Biological inspiration:}
\PYG{l+s+sd}{    \PYGZhy{} Representation units: Similar to neural populations in visual cortex that encode features}
\PYG{l+s+sd}{    \PYGZhy{} Prediction units: Analogous to top\PYGZhy{}down feedback connections in visual hierarchy}
\PYG{l+s+sd}{    \PYGZhy{} Error units: Mimics error\PYGZhy{}signaling neurons that respond to unexpected stimuli}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PredNetLayer}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}channels} \PYG{o}{=} \PYG{n}{input\PYGZus{}channels}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{representation\PYGZus{}channels} \PYG{o}{=} \PYG{n}{representation\PYGZus{}channels}
        
        \PYG{c+c1}{\PYGZsh{} Error computation units (biological: error\PYGZhy{}signaling neurons)}
        \PYG{c+c1}{\PYGZsh{} Separate units for positive and negative errors mimics ON/OFF pathways}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{error\PYGZus{}conv\PYGZus{}pos} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} 
                                        \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{error\PYGZus{}conv\PYGZus{}neg} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} 
                                        \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Prediction units (biological: feedback connections)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}conv} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} \PYG{n}{input\PYGZus{}channels}\PYG{p}{,} 
                                         \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Representation update network (biological: integration in pyramidal neurons)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{representation\PYGZus{}update} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv2d}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} 
                                             \PYG{n}{representation\PYGZus{}channels}\PYG{p}{,}
                                             \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Pooling for feeding to next layer (biological: hierarchical processing)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MaxPool2d}\PYG{p}{(}\PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
        
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{representation\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{top\PYGZus{}down\PYGZus{}tensor}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Generate predictions from current representation}
        \PYG{n}{predictions} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}conv}\PYG{p}{(}\PYG{n}{representation\PYGZus{}tensor}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate prediction errors (biological: error\PYGZhy{}signaling neurons)}
        \PYG{n}{error} \PYG{o}{=} \PYG{n}{input\PYGZus{}tensor} \PYG{o}{\PYGZhy{}} \PYG{n}{predictions}
        \PYG{n}{error\PYGZus{}pos} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Positive errors (ON pathway)}
        \PYG{n}{error\PYGZus{}neg} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{error}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Negative errors (OFF pathway)}
        
        \PYG{c+c1}{\PYGZsh{} Process errors through convolutional layers}
        \PYG{n}{error\PYGZus{}pos\PYGZus{}processed} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{error\PYGZus{}conv\PYGZus{}pos}\PYG{p}{(}\PYG{n}{error\PYGZus{}pos}\PYG{p}{)}
        \PYG{n}{error\PYGZus{}neg\PYGZus{}processed} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{error\PYGZus{}conv\PYGZus{}neg}\PYG{p}{(}\PYG{n}{error\PYGZus{}neg}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine error signals (biological: integration of error signals)}
        \PYG{n}{combined\PYGZus{}error} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{p}{[}\PYG{n}{error\PYGZus{}pos\PYGZus{}processed}\PYG{p}{,} \PYG{n}{error\PYGZus{}neg\PYGZus{}processed}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update representation (biological: synaptic update based on errors)}
        \PYG{n}{representation\PYGZus{}update} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{representation\PYGZus{}update}\PYG{p}{(}\PYG{n}{combined\PYGZus{}error}\PYG{p}{)}
        \PYG{n}{updated\PYGZus{}representation} \PYG{o}{=} \PYG{n}{representation\PYGZus{}tensor} \PYG{o}{+} \PYG{n}{representation\PYGZus{}update}
        
        \PYG{c+c1}{\PYGZsh{} If we have top\PYGZhy{}down input, integrate it (biological: top\PYGZhy{}down modulation)}
        \PYG{k}{if} \PYG{n}{top\PYGZus{}down\PYGZus{}tensor} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{updated\PYGZus{}representation} \PYG{o}{=} \PYG{n}{updated\PYGZus{}representation} \PYG{o}{+} \PYG{n}{top\PYGZus{}down\PYGZus{}tensor}
        
        \PYG{c+c1}{\PYGZsh{} Pool for next layer (biological: increased receptive field sizes in hierarchy)}
        \PYG{n}{pooled\PYGZus{}representation} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pool}\PYG{p}{(}\PYG{n}{updated\PYGZus{}representation}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{error}\PYG{p}{,} \PYG{n}{updated\PYGZus{}representation}\PYG{p}{,} \PYG{n}{pooled\PYGZus{}representation}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PredNet}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Complete PredNet architecture with multiple layers}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Biological inspiration:}
\PYG{l+s+sd}{    \PYGZhy{} Hierarchical structure: Mimics the visual cortical hierarchy (V1, V2, V4, IT)}
\PYG{l+s+sd}{    \PYGZhy{} Bidirectional processing: Combines bottom\PYGZhy{}up and top\PYGZhy{}down information flow}
\PYG{l+s+sd}{    \PYGZhy{} Prediction error emphasis: Focuses learning on surprising/unexpected information}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{layer\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{PredNet}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{layer\PYGZus{}channels}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create PredNet layers}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{in\PYGZus{}channels} \PYG{o}{=} \PYG{n}{input\PYGZus{}channels}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{layer\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{PredNetLayer}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{in\PYGZus{}channels} \PYG{o}{=} \PYG{n}{out\PYGZus{}channels}
        
        \PYG{c+c1}{\PYGZsh{} Upsampling for top\PYGZhy{}down connections (biological: feedback projections)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{upsample} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{upsample}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{ConvTranspose2d}\PYG{p}{(}
                \PYG{n}{layer\PYGZus{}channels}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{layer\PYGZus{}channels}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{stride}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}
            \PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}sequence}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{seq\PYGZus{}length}\PYG{p}{,} \PYG{n}{channels}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{width} \PYG{o}{=} \PYG{n}{input\PYGZus{}sequence}\PYG{o}{.}\PYG{n}{shape}
        
        \PYG{c+c1}{\PYGZsh{} Initialize representations for each layer}
        \PYG{n}{representations} \PYG{o}{=} \PYG{p}{[}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{layer}\PYG{o}{.}\PYG{n}{representation\PYGZus{}channels}\PYG{p}{,} 
                                     \PYG{n}{height} \PYG{o}{/}\PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{o}{*}\PYG{n}{i}\PYG{p}{)}\PYG{p}{,} \PYG{n}{width} \PYG{o}{/}\PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{o}{*}\PYG{n}{i}\PYG{p}{)}\PYG{p}{,}
                                     \PYG{n}{device}\PYG{o}{=}\PYG{n}{input\PYGZus{}sequence}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
                         \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Initialize errors for each layer}
        \PYG{n}{errors} \PYG{o}{=} \PYG{p}{[}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{layer}\PYG{o}{.}\PYG{n}{input\PYGZus{}channels}\PYG{p}{,}
                            \PYG{n}{height} \PYG{o}{/}\PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{o}{*}\PYG{n}{i}\PYG{p}{)}\PYG{p}{,} \PYG{n}{width} \PYG{o}{/}\PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{o}{*}\PYG{n}{i}\PYG{p}{)}\PYG{p}{,}
                            \PYG{n}{device}\PYG{o}{=}\PYG{n}{input\PYGZus{}sequence}\PYG{o}{.}\PYG{n}{device}\PYG{p}{)}
                 \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{)}\PYG{p}{]}
        
        \PYG{n}{all\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Store errors for all time steps}
        
        \PYG{c+c1}{\PYGZsh{} Process sequence}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{seq\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{current\PYGZus{}input} \PYG{o}{=} \PYG{n}{input\PYGZus{}sequence}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]}
            \PYG{n}{frame\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Bottom\PYGZhy{}up pass (biological: feedforward processing)}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layers}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Set input for each layer}
                \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                    \PYG{n}{layer\PYGZus{}input} \PYG{o}{=} \PYG{n}{current\PYGZus{}input}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Input from errors of previous layer (biological: error propagation)}
                    \PYG{n}{layer\PYGZus{}input} \PYG{o}{=} \PYG{n}{errors}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Process through layer}
                \PYG{n}{error}\PYG{p}{,} \PYG{n}{updated\PYGZus{}rep}\PYG{p}{,} \PYG{n}{pooled\PYGZus{}rep} \PYG{o}{=} \PYG{n}{layer}\PYG{p}{(}\PYG{n}{layer\PYGZus{}input}\PYG{p}{,} \PYG{n}{representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Store results}
                \PYG{n}{errors}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{error}
                \PYG{n}{representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{updated\PYGZus{}rep}
                \PYG{n}{frame\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{error}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Set input for next layer}
                \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{:}
                    \PYG{n}{next\PYGZus{}layer\PYGZus{}input} \PYG{o}{=} \PYG{n}{pooled\PYGZus{}rep}
            
            \PYG{c+c1}{\PYGZsh{} Top\PYGZhy{}down pass (biological: feedback processing)}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{num\PYGZus{}layers} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Get top\PYGZhy{}down signal}
                \PYG{n}{top\PYGZus{}down} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{upsample}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{(}\PYG{n}{representations}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update representation with top\PYGZhy{}down input}
                \PYG{n}{representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{representations}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+} \PYG{n}{top\PYGZus{}down}
                
            \PYG{n}{all\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{frame\PYGZus{}errors}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{errors}\PYG{p}{,} \PYG{n}{representations}\PYG{p}{,} \PYG{n}{all\PYGZus{}errors}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}prednet\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a PredNet model for video prediction\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Input: RGB images}
    \PYG{n}{input\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{c+c1}{\PYGZsh{} Layer channels increase with depth (analogous to increasing feature complexity)}
    \PYG{n}{layer\PYGZus{}channels} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{256}\PYG{p}{]}
    
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{PredNet}\PYG{p}{(}\PYG{n}{input\PYGZus{}channels}\PYG{p}{,} \PYG{n}{layer\PYGZus{}channels}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{model}

\PYG{c+c1}{\PYGZsh{} Create model}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{create\PYGZus{}prednet\PYGZus{}model}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PredNet model created with }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{for}\PYG{+w}{ }\PYG{n}{p}\PYG{+w}{ }\PYG{o+ow}{in}\PYG{+w}{ }\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{g+gt}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+ne}{ModuleNotFoundError}\PYG{g+gWhitespace}{                       }Traceback (most recent call last)
\PYG{n}{Cell} \PYG{n}{In}\PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{,} \PYG{n}{line} \PYG{l+m+mi}{1}
\PYG{n+ne}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZgt{} }\PYG{l+m+mi}{1} \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{2} \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{3} \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{n+nn}{.}\PYG{n+nn}{functional}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{F}

\PYG{n+ne}{ModuleNotFoundError}: No module named \PYGZsq{}torch\PYGZsq{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{Example 2: Getting Explanations of Complex Concepts}
\label{\detokenize{part6/jupyter_ai_demo:example-2-getting-explanations-of-complex-concepts}}
\sphinxAtStartPar
Jupyter AI is useful for getting on\sphinxhyphen{}demand explanations of complex neuroscience or AI concepts:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}\PYGZpc{}}\PYG{k}{ai} anthropic/claude\PYGZhy{}3\PYGZhy{}sonnet
Explain the connection between hippocampal replay during sleep and Prioritized Experience Replay in reinforcement learning. Include key similarities and differences.
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Example output (what Jupyter AI would generate with proper configuration):

\sphinxAtStartPar
\sphinxstylestrong{Hippocampal Replay vs. Prioritized Experience Replay}

\sphinxAtStartPar
\sphinxstylestrong{Similarities:}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Selective Memory Processing}: Both mechanisms selectively revisit past experiences rather than processing all memories equally.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Learning Efficiency}: Both enhance learning efficiency by focusing computational resources on high\sphinxhyphen{}value experiences.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Information Consolidation}: Both help stabilize and integrate new knowledge with existing memories.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pattern Reactivation}: Both involve reactivating patterns of activity associated with previous experiences.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Stability\sphinxhyphen{}Plasticity Balance}: Both help address the stability\sphinxhyphen{}plasticity dilemma by allowing new learning without catastrophic forgetting.

\end{enumerate}

\sphinxAtStartPar
\sphinxstylestrong{Differences:}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Priority Mechanism}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal replay often prioritizes experiences based on emotional salience, novelty, reward prediction errors, and goal relevance.

\item {} 
\sphinxAtStartPar
PER explicitly uses TD errors (prediction errors) as the priority metric.

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Temporal Structure}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal replay occurs primarily during sleep and rest periods, with specific patterns during different sleep stages.

\item {} 
\sphinxAtStartPar
PER operates continuously during the learning process, interleaved with new experiences.

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Speed and Compression}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal replay often occurs at compressed timescales (5\sphinxhyphen{}20x faster than real experiences).

\item {} 
\sphinxAtStartPar
PER doesn’t explicitly model temporal compression.

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sequence Structure}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal replay often maintains sequential structure, replaying experiences in forward or reverse order.

\item {} 
\sphinxAtStartPar
PER samples individual transitions without preserving sequences.

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological Implementation}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Hippocampal replay involves coordinated oscillations (sharp\sphinxhyphen{}wave ripples) and specific neurochemical environments.

\item {} 
\sphinxAtStartPar
PER is an algorithmic approximation that captures the functional role but not the biological implementation details.

\end{itemize}

\end{enumerate}


\subsubsection{Example 3: Debugging and Improving Code}
\label{\detokenize{part6/jupyter_ai_demo:example-3-debugging-and-improving-code}}
\sphinxAtStartPar
Jupyter AI can help debug and improve code implementations:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example code with a bug}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}hodgkin\PYGZus{}huxley}\PYG{p}{(}\PYG{n}{I\PYGZus{}ext}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{T}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate the Hodgkin\PYGZhy{}Huxley model of action potential generation\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Constants}
    \PYG{n}{E\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{55.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{E\PYGZus{}K} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{77.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{E\PYGZus{}L} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{65.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{g\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{120.0}  \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{g\PYGZus{}K} \PYG{o}{=} \PYG{l+m+mf}{36.0}    \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{g\PYGZus{}L} \PYG{o}{=} \PYG{l+m+mf}{0.3}     \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{C\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{1.0}     \PYG{c+c1}{\PYGZsh{} uF/cm\PYGZca{}2}
    
    \PYG{c+c1}{\PYGZsh{} Simulation parameters}
    \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{T} \PYG{o}{/} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{T}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} State variables}
    \PYG{n}{V} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{m} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{h} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{n} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize}
    \PYG{n}{V}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{65.0}  \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{m}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.05}
    \PYG{n}{h}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.6}
    \PYG{n}{n}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.32}
    
    \PYG{c+c1}{\PYGZsh{} Helper functions for gating variables}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{4.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{18.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.07} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{20.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{35.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.01} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.125} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{80.0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Bug: division by zero in alpha\PYGZus{}m when V = \PYGZhy{}40.0}
    \PYG{c+c1}{\PYGZsh{} Bug: division by zero in alpha\PYGZus{}n when V = \PYGZhy{}55.0}
    
    \PYG{c+c1}{\PYGZsh{} Simulation loop}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate gating variables}
        \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate conductances and currents}
        \PYG{n}{g\PYGZus{}Na\PYGZus{}t} \PYG{o}{=} \PYG{n}{g\PYGZus{}Na} \PYG{o}{*} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{n}{g\PYGZus{}K\PYGZus{}t} \PYG{o}{=} \PYG{n}{g\PYGZus{}K} \PYG{o}{*} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{4}
        
        \PYG{n}{I\PYGZus{}Na} \PYG{o}{=} \PYG{n}{g\PYGZus{}Na\PYGZus{}t} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}Na}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}K} \PYG{o}{=} \PYG{n}{g\PYGZus{}K\PYGZus{}t} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}K}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}L} \PYG{o}{=} \PYG{n}{g\PYGZus{}L} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}L}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potential}
        \PYG{n}{dV} \PYG{o}{=} \PYG{p}{(}\PYG{n}{I\PYGZus{}ext} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}Na} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}K} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}L}\PYG{p}{)} \PYG{o}{/} \PYG{n}{C\PYGZus{}m}
        \PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{n}{dV}
        
    \PYG{k}{return} \PYG{n}{t}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{n}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Code with potential bugs defined}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}\PYGZpc{}}\PYG{k}{ai} gpt\PYGZhy{}4
There\PYGZsq{}s a bug in my Hodgkin\PYGZhy{}Huxley model implementation. The code can cause division by zero errors in the alpha\PYGZus{}m and alpha\PYGZus{}n functions. Can you fix these issues and explain the neurobiological meaning of these functions?
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Example output (what Jupyter AI would generate with proper configuration):

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}hodgkin\PYGZus{}huxley}\PYG{p}{(}\PYG{n}{I\PYGZus{}ext}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{T}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate the Hodgkin\PYGZhy{}Huxley model of action potential generation\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Constants}
    \PYG{n}{E\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{55.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{E\PYGZus{}K} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{77.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{E\PYGZus{}L} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{65.0}   \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{g\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{120.0}  \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{g\PYGZus{}K} \PYG{o}{=} \PYG{l+m+mf}{36.0}    \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{g\PYGZus{}L} \PYG{o}{=} \PYG{l+m+mf}{0.3}     \PYG{c+c1}{\PYGZsh{} mS/cm\PYGZca{}2}
    \PYG{n}{C\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{1.0}     \PYG{c+c1}{\PYGZsh{} uF/cm\PYGZca{}2}
    
    \PYG{c+c1}{\PYGZsh{} Simulation parameters}
    \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{T} \PYG{o}{/} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{T}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} State variables}
    \PYG{n}{V} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{m} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{h} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{n} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize}
    \PYG{n}{V}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{65.0}  \PYG{c+c1}{\PYGZsh{} mV}
    \PYG{n}{m}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.05}
    \PYG{n}{h}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.6}
    \PYG{n}{n}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.32}
    
    \PYG{c+c1}{\PYGZsh{} Helper functions for gating variables with fixed division by zero issues}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Using L\PYGZsq{}Hôpital\PYGZsq{}s rule for the case when V is close to \PYGZhy{}40}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Limit value when V = \PYGZhy{}40}
        \PYG{k}{return} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{4.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{18.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.07} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{20.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{35.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Using L\PYGZsq{}Hôpital\PYGZsq{}s rule for the case when V is close to \PYGZhy{}55}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Limit value when V = \PYGZhy{}55}
        \PYG{k}{return} \PYG{l+m+mf}{0.01} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.125} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{80.0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulation loop}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate gating variables}
        \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate conductances and currents}
        \PYG{n}{g\PYGZus{}Na\PYGZus{}t} \PYG{o}{=} \PYG{n}{g\PYGZus{}Na} \PYG{o}{*} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        \PYG{n}{g\PYGZus{}K\PYGZus{}t} \PYG{o}{=} \PYG{n}{g\PYGZus{}K} \PYG{o}{*} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{4}
        
        \PYG{n}{I\PYGZus{}Na} \PYG{o}{=} \PYG{n}{g\PYGZus{}Na\PYGZus{}t} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}Na}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}K} \PYG{o}{=} \PYG{n}{g\PYGZus{}K\PYGZus{}t} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}K}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}L} \PYG{o}{=} \PYG{n}{g\PYGZus{}L} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{E\PYGZus{}L}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potential}
        \PYG{n}{dV} \PYG{o}{=} \PYG{p}{(}\PYG{n}{I\PYGZus{}ext} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}Na} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}K} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}L}\PYG{p}{)} \PYG{o}{/} \PYG{n}{C\PYGZus{}m}
        \PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{dt} \PYG{o}{*} \PYG{n}{dV}
        
    \PYG{k}{return} \PYG{n}{t}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{n}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fixed code defined}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
\sphinxstylestrong{Neurobiological Meaning of Alpha and Beta Functions}

\sphinxAtStartPar
In the Hodgkin\sphinxhyphen{}Huxley model, the alpha (α) and beta (β) functions represent voltage\sphinxhyphen{}dependent rate constants that control the opening and closing of ion channels:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Alpha Functions (α\_m, α\_h, α\_n)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Represent the rate at which the corresponding gates transition from closed to open states

\item {} 
\sphinxAtStartPar
Neurobiologically, they model the voltage\sphinxhyphen{}dependent probability of conformational changes in ion channel proteins that lead to channel opening

\item {} 
\sphinxAtStartPar
For example, α\_m increases with depolarization, representing faster sodium channel activation as voltage increases

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Beta Functions (β\_m, β\_h, β\_n)}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Represent the rate at which the gates transition from open to closed states

\item {} 
\sphinxAtStartPar
Neurobiologically, they model the rate at which ion channels return to their resting conformation

\item {} 
\sphinxAtStartPar
For example, β\_h increases with depolarization, representing faster sodium channel inactivation

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Specific Gating Variables}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{m}: Controls sodium channel activation (opens quickly with depolarization)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{h}: Controls sodium channel inactivation (closes slowly with sustained depolarization)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{n}: Controls potassium channel activation (opens slowly with depolarization)

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
The fixes I implemented use L’Hôpital’s rule to handle the special cases where the denominator becomes zero, which happens at specific voltage values (\sphinxhyphen{}40 mV for α\_m and \sphinxhyphen{}55 mV for α\_n). These special cases are important physiologically as they represent critical voltages where channel opening rates undergo significant changes.


\subsubsection{Example 4: Generating and Improving Visualizations}
\label{\detokenize{part6/jupyter_ai_demo:example-4-generating-and-improving-visualizations}}
\sphinxAtStartPar
Jupyter AI can help create and enhance visualizations of neural data:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}\PYGZpc{}}\PYG{k}{ai} anthropic/claude\PYGZhy{}3\PYGZhy{}opus
Generate code to visualize the attention maps in a Vision Transformer model, similar to what we discussed in Chapter 20. The visualization should show both the image and the corresponding attention patterns between patches. Include interactivity to explore different attention heads.
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Example output (what Jupyter AI would generate with proper configuration):

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{colors}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearSegmentedColormap}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{widgets}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{ipywidgets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{interact}\PYG{p}{,} \PYG{n}{fixed}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{PIL}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Image}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{requests}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{io}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BytesIO}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{ViTModel}\PYG{p}{,} \PYG{n}{ViTImageProcessor}

\PYG{c+c1}{\PYGZsh{} Function to load an image from URL or file path}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}image}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Load image from URL or file path\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{image\PYGZus{}path}\PYG{o}{.}\PYG{n}{startswith}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{http}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}
        \PYG{n}{img} \PYG{o}{=} \PYG{n}{Image}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{n}{BytesIO}\PYG{p}{(}\PYG{n}{response}\PYG{o}{.}\PYG{n}{content}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{img} \PYG{o}{=} \PYG{n}{Image}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{img}

\PYG{c+c1}{\PYGZsh{} Function to extract attention maps from ViT model}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}attention\PYGZus{}maps}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{processor}\PYG{p}{,} \PYG{n}{image}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Extract attention maps from Vision Transformer\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Preprocess image}
    \PYG{n}{inputs} \PYG{o}{=} \PYG{n}{processor}\PYG{p}{(}\PYG{n}{images}\PYG{o}{=}\PYG{n}{image}\PYG{p}{,} \PYG{n}{return\PYGZus{}tensors}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Forward pass with output\PYGZus{}attentions=True}
    \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{inputs}\PYG{p}{,} \PYG{n}{output\PYGZus{}attentions}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get attention maps [layers, heads, tokens, tokens]}
    \PYG{n}{attention\PYGZus{}maps} \PYG{o}{=} \PYG{n}{outputs}\PYG{o}{.}\PYG{n}{attentions}
    
    \PYG{k}{return} \PYG{n}{attention\PYGZus{}maps}\PYG{p}{,} \PYG{n}{inputs}\PYG{o}{.}\PYG{n}{pixel\PYGZus{}values}

\PYG{c+c1}{\PYGZsh{} Function to visualize attention maps}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}attention}\PYG{p}{(}\PYG{n}{attention\PYGZus{}maps}\PYG{p}{,} \PYG{n}{image}\PYG{p}{,} \PYG{n}{layer}\PYG{p}{,} \PYG{n}{head}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Visualize attention maps for a specific layer and attention head\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Get the specified attention map}
    \PYG{n}{attention} \PYG{o}{=} \PYG{n}{attention\PYGZus{}maps}\PYG{p}{[}\PYG{n}{layer}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{head}\PYG{p}{]}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} The first token is the [CLS] token, so we exclude it for visualization}
    \PYG{n}{attention} \PYG{o}{=} \PYG{n}{attention}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Reshape attention to match image patches}
    \PYG{n}{num\PYGZus{}patches} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{attention}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{attention\PYGZus{}map} \PYG{o}{=} \PYG{n}{attention}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{num\PYGZus{}patches}\PYG{p}{,} \PYG{n}{num\PYGZus{}patches}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a figure with subplots}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot original image}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{image}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Original Image}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create grid to show patches}
    \PYG{n}{h}\PYG{p}{,} \PYG{n}{w} \PYG{o}{=} \PYG{n}{image}\PYG{o}{.}\PYG{n}{size}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{image}\PYG{o}{.}\PYG{n}{size}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Highlight the focus patch (CLS token attends to this patch)}
    \PYG{n}{focus\PYGZus{}i}\PYG{p}{,} \PYG{n}{focus\PYGZus{}j} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}  \PYG{c+c1}{\PYGZsh{} By default, use the top\PYGZhy{}left patch}
    \PYG{n}{rect} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{focus\PYGZus{}j}\PYG{p}{,} \PYG{n}{focus\PYGZus{}i}\PYG{p}{)}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{,}
                         \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{rect}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot attention map}
    \PYG{c+c1}{\PYGZsh{} Create a custom colormap with better contrast}
    \PYG{n}{cmap} \PYG{o}{=} \PYG{n}{LinearSegmentedColormap}\PYG{o}{.}\PYG{n}{from\PYGZus{}list}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{attention\PYGZus{}cmap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}0000ff}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}00ffff}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}ffff00}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}ff0000}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{attention\PYGZus{}map}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Attention Map (Layer }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Head }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{head}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Attention Strength}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add grid to match patches}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{num\PYGZus{}patches}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{minor}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{num\PYGZus{}patches}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{minor}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{which}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{minor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fig}

\PYG{c+c1}{\PYGZsh{} Interactive visualization function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{interactive\PYGZus{}attention\PYGZus{}visualization}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create interactive widgets to explore ViT attention maps\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load model and processor}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Loading Vision Transformer model...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{ViTModel}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{google/vit\PYGZhy{}base\PYGZhy{}patch16\PYGZhy{}224}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{processor} \PYG{o}{=} \PYG{n}{ViTImageProcessor}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{google/vit\PYGZhy{}base\PYGZhy{}patch16\PYGZhy{}224}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Load image}
    \PYG{n}{image} \PYG{o}{=} \PYG{n}{load\PYGZus{}image}\PYG{p}{(}\PYG{n}{image\PYGZus{}path}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get attention maps}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Extracting attention maps...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{attention\PYGZus{}maps}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{get\PYGZus{}attention\PYGZus{}maps}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{processor}\PYG{p}{,} \PYG{n}{image}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Number of layers and heads}
    \PYG{n}{num\PYGZus{}layers} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{attention\PYGZus{}maps}\PYG{p}{)}
    \PYG{n}{num\PYGZus{}heads} \PYG{o}{=} \PYG{n}{attention\PYGZus{}maps}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model has }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}layers}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ layers with }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}heads}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ attention heads each}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create interactive widgets}
    \PYG{n}{layer\PYGZus{}slider} \PYG{o}{=} \PYG{n}{widgets}\PYG{o}{.}\PYG{n}{IntSlider}\PYG{p}{(}
        \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
        \PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
        \PYG{n+nb}{max}\PYG{o}{=}\PYG{n}{num\PYGZus{}layers}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,}
        \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}
        \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Layer:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{n}{continuous\PYGZus{}update}\PYG{o}{=}\PYG{k+kc}{False}
    \PYG{p}{)}
    
    \PYG{n}{head\PYGZus{}slider} \PYG{o}{=} \PYG{n}{widgets}\PYG{o}{.}\PYG{n}{IntSlider}\PYG{p}{(}
        \PYG{n}{value}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
        \PYG{n+nb}{min}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
        \PYG{n+nb}{max}\PYG{o}{=}\PYG{n}{num\PYGZus{}heads}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,}
        \PYG{n}{step}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}
        \PYG{n}{description}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Head:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{n}{continuous\PYGZus{}update}\PYG{o}{=}\PYG{k+kc}{False}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create interactive visualization}
    \PYG{n}{interact}\PYG{p}{(}
        \PYG{k}{lambda} \PYG{n}{layer}\PYG{p}{,} \PYG{n}{head}\PYG{p}{:} \PYG{n}{visualize\PYGZus{}attention}\PYG{p}{(}\PYG{n}{attention\PYGZus{}maps}\PYG{p}{,} \PYG{n}{image}\PYG{p}{,} \PYG{n}{layer}\PYG{p}{,} \PYG{n}{head}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{layer}\PYG{o}{=}\PYG{n}{layer\PYGZus{}slider}\PYG{p}{,}
        \PYG{n}{head}\PYG{o}{=}\PYG{n}{head\PYGZus{}slider}
    \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example usage \PYGZhy{} enable this to run the interactive visualization}
\PYG{c+c1}{\PYGZsh{} interactive\PYGZus{}attention\PYGZus{}visualization(\PYGZsq{}https://storage.googleapis.com/sfr\PYGZhy{}vision\PYGZhy{}language\PYGZhy{}research/BLIP/demo/bobcat.jpg\PYGZsq{})}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Vision Transformer attention visualization code defined}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\subsection{Adding Jupyter AI to the Handbook}
\label{\detokenize{part6/jupyter_ai_demo:adding-jupyter-ai-to-the-handbook}}
\sphinxAtStartPar
To fully integrate Jupyter AI into the NeuroAI Handbook, we should follow these steps:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Installation Instructions}: Add clear instructions for users to install and configure Jupyter AI

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Configuration Guide}: Provide guidance on setting up API keys for different models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Usage Examples}: Add examples for common NeuroAI tasks (like those shown above)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Integration with Exercises}: Enhance the existing exercises with AI\sphinxhyphen{}assisted options

\end{enumerate}

\sphinxAtStartPar
Let’s create a mini\sphinxhyphen{}guide for users:


\subsection{Using Jupyter AI with the NeuroAI Handbook}
\label{\detokenize{part6/jupyter_ai_demo:using-jupyter-ai-with-the-neuroai-handbook}}
\sphinxAtStartPar
Jupyter AI can significantly enhance your learning experience by providing:
\begin{itemize}
\item {} 
\sphinxAtStartPar
On\sphinxhyphen{}demand explanations of complex neuroscience concepts

\item {} 
\sphinxAtStartPar
Code generation for implementing models discussed in the handbook

\item {} 
\sphinxAtStartPar
Help with debugging and improving your implementations

\item {} 
\sphinxAtStartPar
Support for visualizing neural data and model architectures

\end{itemize}


\subsubsection{Quick Start Guide}
\label{\detokenize{part6/jupyter_ai_demo:quick-start-guide}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Install the required packages:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
pip\PYG{+w}{ }install\PYG{+w}{ }jupyter\PYGZhy{}ai\PYG{+w}{ }jupyter\PYGZhy{}ai\PYGZhy{}magics\PYG{+w}{ }openai
\end{sphinxVerbatim}

\item {} 
\sphinxAtStartPar
Configure your API keys (we recommend using environment variables):

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} For OpenAI models}
\PYG{n+nb}{export}\PYG{+w}{ }\PYG{n+nv}{OPENAI\PYGZus{}API\PYGZus{}KEY}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}your\PYGZhy{}api\PYGZhy{}key\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} For Anthropic models}
\PYG{n+nb}{export}\PYG{+w}{ }\PYG{n+nv}{ANTHROPIC\PYGZus{}API\PYGZus{}KEY}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}your\PYGZhy{}api\PYGZhy{}key\PYGZdq{}}
\end{sphinxVerbatim}

\item {} 
\sphinxAtStartPar
Load the extension in your notebook:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{n}{load\PYGZus{}ext} \PYG{n}{jupyter\PYGZus{}ai\PYGZus{}magics}
\end{sphinxVerbatim}

\item {} 
\sphinxAtStartPar
Use the \sphinxcode{\sphinxupquote{\%\%ai}} magic to interact with AI models:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{o}{\PYGZpc{}}\PYG{n}{ai} \PYG{n}{gpt}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{4}
\PYG{n}{Explain} \PYG{n}{how} \PYG{n}{the} \PYG{n}{PredNet} \PYG{n}{architecture} \PYG{n}{mimics} \PYG{n}{predictive} \PYG{n}{coding} \PYG{o+ow}{in} \PYG{n}{the} \PYG{n}{visual} \PYG{n}{cortex}\PYG{o}{.}
\end{sphinxVerbatim}

\end{enumerate}


\subsubsection{Recommended Use Cases}
\label{\detokenize{part6/jupyter_ai_demo:recommended-use-cases}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Code Assistance}: Get help implementing algorithms from the handbook

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Concept Clarification}: Ask for detailed explanations of key concepts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Exploration}: Ask “what if” questions about model variations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Visualization}: Generate code for visualizing model architectures or neural data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Debugging}: Get help diagnosing and fixing issues in your implementations

\end{enumerate}


\subsubsection{Available Models}
\label{\detokenize{part6/jupyter_ai_demo:available-models}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{OpenAI}: gpt\sphinxhyphen{}3.5\sphinxhyphen{}turbo, gpt\sphinxhyphen{}4

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Anthropic}: anthropic/claude\sphinxhyphen{}3\sphinxhyphen{}sonnet, anthropic/claude\sphinxhyphen{}3\sphinxhyphen{}opus

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Open Source}: Various models via Hugging Face

\end{itemize}

\sphinxAtStartPar
For more detailed information, see the \sphinxhref{https://jupyter-ai.readthedocs.io/}{Jupyter AI documentation}.


\subsection{Conclusion}
\label{\detokenize{part6/jupyter_ai_demo:conclusion}}
\sphinxAtStartPar
Jupyter AI provides powerful AI\sphinxhyphen{}assisted features that can significantly enhance the interactive learning experience of the NeuroAI Handbook. By integrating these capabilities, readers can:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Get personalized explanations of complex neuroscience and AI concepts

\item {} 
\sphinxAtStartPar
Generate and debug code for implementing models discussed in the handbook

\item {} 
\sphinxAtStartPar
Create visualizations to better understand neural data and model architectures

\item {} 
\sphinxAtStartPar
Explore variations and extensions of the models presented in the case studies

\end{enumerate}

\sphinxAtStartPar
This integration supports a more dynamic, inquiry\sphinxhyphen{}based learning approach that can adapt to each reader’s specific interests and questions.

\sphinxstepscope


\section{Creating Presentations with RISE}
\label{\detokenize{part6/rise_slides_demo:creating-presentations-with-rise}}\label{\detokenize{part6/rise_slides_demo::doc}}

\subsection{A Guide for the NeuroAI Handbook}
\label{\detokenize{part6/rise_slides_demo:a-guide-for-the-neuroai-handbook}}
\sphinxAtStartPar
This notebook demonstrates how to create interactive slide presentations from Jupyter notebooks using RISE (Reveal.js \sphinxhyphen{} Jupyter/IPython Slideshow Extension).


\subsection{What is RISE?}
\label{\detokenize{part6/rise_slides_demo:what-is-rise}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{R}eveal.js \sphinxstylestrong{I}Python \sphinxstylestrong{S}lideshow \sphinxstylestrong{E}xtension

\item {} 
\sphinxAtStartPar
Transforms Jupyter notebooks into interactive Reveal.js\sphinxhyphen{}based presentations

\item {} 
\sphinxAtStartPar
Allows for seamless transitions between slides while preserving code execution capability

\item {} 
\sphinxAtStartPar
Perfect for teaching or presenting research findings with live code demonstrations

\end{itemize}


\subsection{Installing RISE}
\label{\detokenize{part6/rise_slides_demo:installing-rise}}
\sphinxAtStartPar
RISE can be installed using pip:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
pip\PYG{+w}{ }install\PYG{+w}{ }rise
\end{sphinxVerbatim}

\sphinxAtStartPar
After installation, you may need to enable the extension:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
jupyter\PYGZhy{}nbextension\PYG{+w}{ }install\PYG{+w}{ }rise\PYG{+w}{ }\PYGZhy{}\PYGZhy{}py\PYG{+w}{ }\PYGZhy{}\PYGZhy{}sys\PYGZhy{}prefix
jupyter\PYGZhy{}nbextension\PYG{+w}{ }\PYG{n+nb}{enable}\PYG{+w}{ }rise\PYG{+w}{ }\PYGZhy{}\PYGZhy{}py\PYG{+w}{ }\PYGZhy{}\PYGZhy{}sys\PYGZhy{}prefix
\end{sphinxVerbatim}


\subsection{Creating Slides with RISE}
\label{\detokenize{part6/rise_slides_demo:creating-slides-with-rise}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Create a regular Jupyter notebook with your content

\item {} 
\sphinxAtStartPar
Use the Cell Toolbar menu: View → Cell Toolbar → Slideshow

\item {} 
\sphinxAtStartPar
Set the slide type for each cell:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Slide}: Start a new slide

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sub\sphinxhyphen{}slide}: Start a new sub\sphinxhyphen{}slide (vertical navigation)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Fragment}: Content appears incrementally on the current slide

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Skip}: Cell is not included in the slideshow

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Notes}: Speaker notes (not displayed in the presentation)

\end{itemize}

\end{enumerate}


\subsubsection{Using Cell Metadata}
\label{\detokenize{part6/rise_slides_demo:using-cell-metadata}}
\sphinxAtStartPar
You can also set slide properties directly in cell metadata:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{p}{\PYGZob{}}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}slideshow\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}slide\PYGZus{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}slide\PYGZdq{}}
\PYG{+w}{  }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Options for \sphinxcode{\sphinxupquote{slide\_type}}: \sphinxcode{\sphinxupquote{"slide"}}, \sphinxcode{\sphinxupquote{"subslide"}}, \sphinxcode{\sphinxupquote{"fragment"}}, \sphinxcode{\sphinxupquote{"skip"}}, \sphinxcode{\sphinxupquote{"notes"}}


\subsection{Example: Chapter 20 Case Studies in NeuroAI}
\label{\detokenize{part6/rise_slides_demo:example-chapter-20-case-studies-in-neuroai}}
\sphinxAtStartPar
Let’s demonstrate how we can create slides for Chapter 20 of the NeuroAI Handbook.


\section{Chapter 20: Case Studies in NeuroAI}
\label{\detokenize{part6/rise_slides_demo:chapter-20-case-studies-in-neuroai}}
\sphinxAtStartPar
This presentation covers key case studies where neuroscience has informed AI development.


\subsection{Case Study 1: Predictive Coding Networks}
\label{\detokenize{part6/rise_slides_demo:case-study-1-predictive-coding-networks}}

\subsubsection{Brain ↔ AI Connection}
\label{\detokenize{part6/rise_slides_demo:brain-ai-connection}}
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Principle}: The brain constantly generates predictions about incoming sensory information and updates its internal models based on prediction errors.

\sphinxAtStartPar
\sphinxstylestrong{AI Implementation}: PredNet architecture with explicit representation of prediction errors between layers.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Simple visualization of predictive coding}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Generate data}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{n}{signal} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{prediction} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
\PYG{n}{error} \PYG{o}{=} \PYG{n}{signal} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{signal}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Input Signal with Noise}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{prediction}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brain}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+s1}{s Prediction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{error}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error (What the Brain Uses for Learning)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{6a00a3f880ac29482fc0fc9c945e8df2cd3aa91be68ec9b44da48eb5f9f600e9}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Case Study 2: Prioritized Experience Replay}
\label{\detokenize{part6/rise_slides_demo:case-study-2-prioritized-experience-replay}}

\subsubsection{Brain ↔ AI Connection}
\label{\detokenize{part6/rise_slides_demo:id1}}
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Principle}: The hippocampus preferentially replays behaviorally relevant experiences during sleep and rest.

\sphinxAtStartPar
\sphinxstylestrong{AI Implementation}: Reinforcement learning with prioritized replay based on TD\sphinxhyphen{}error magnitude.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Visualize prioritized experience replay}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{patches}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{patches}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{colors}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearSegmentedColormap}

\PYG{c+c1}{\PYGZsh{} Create a grid environment}
\PYG{n}{grid\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{5}
\PYG{n}{grid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{,} \PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set start and goal positions}
\PYG{n}{start\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
\PYG{n}{goal\PYGZus{}pos} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create TD errors (higher near goal and obstacles)}
\PYG{n}{td\PYGZus{}errors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{,} \PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.2}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} Goal has high TD error}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.9}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.9}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.8}  \PYG{c+c1}{\PYGZsh{} Obstacle area}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.7}
\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.7}

\PYG{c+c1}{\PYGZsh{} Plot the environment and replay probabilities}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create custom colormap}
\PYG{n}{cmap} \PYG{o}{=} \PYG{n}{LinearSegmentedColormap}\PYG{o}{.}\PYG{n}{from\PYGZus{}list}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{replay\PYGZus{}cmap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}f5f5f5}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}ffcc00}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}ff6600}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}cc0000}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot TD errors as colors}
\PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{td\PYGZus{}errors}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add grid lines}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{i} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Mark start and goal}
\PYG{n}{start\PYGZus{}rect} \PYG{o}{=} \PYG{n}{patches}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{start\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{start\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                              \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{goal\PYGZus{}rect} \PYG{o}{=} \PYG{n}{patches}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{n}{goal\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{goal\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} 
                              \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{edgecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{facecolor}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{start\PYGZus{}rect}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{goal\PYGZus{}rect}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add labels}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{text} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{td\PYGZus{}errors}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s1}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add colorbar}
\PYG{n}{cbar} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{cbar}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Replay Priority (TD Error)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set title and labels}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prioritized Experience Replay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{grid\PYGZus{}size}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{90d0a534b5d9d694c6896b67683dbb9f075c61f37d31339b6d2aef72dd2c5ebc}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Case Study 3: Vision Transformer}
\label{\detokenize{part6/rise_slides_demo:case-study-3-vision-transformer}}

\subsubsection{Brain ↔ AI Connection}
\label{\detokenize{part6/rise_slides_demo:id2}}
\sphinxAtStartPar
\sphinxstylestrong{Neuroscience Principle}: Visual attention in humans allows selective processing of relevant information.

\sphinxAtStartPar
\sphinxstylestrong{AI Implementation}: Vision Transformer with self\sphinxhyphen{}attention mechanisms between image patches.

\sphinxAtStartPar
Key innovations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Division of images into patches

\item {} 
\sphinxAtStartPar
Parallel processing of all patches

\item {} 
\sphinxAtStartPar
Attention\sphinxhyphen{}based relationships between patches

\end{itemize}

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxstyleemphasis{Vision Transformer architecture showing image patches, positional embeddings, and self\sphinxhyphen{}attention layers}


\subsection{Practical Activity: Design Your Own NeuroAI Model}
\label{\detokenize{part6/rise_slides_demo:practical-activity-design-your-own-neuroai-model}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Choose a brain mechanism you find interesting

\item {} 
\sphinxAtStartPar
Identify its key computational principles

\item {} 
\sphinxAtStartPar
Sketch an AI architecture inspired by this mechanism

\item {} 
\sphinxAtStartPar
Consider how you would evaluate its performance

\end{enumerate}


\subsection{Key Takeaways}
\label{\detokenize{part6/rise_slides_demo:key-takeaways}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Successful NeuroAI implementations focus on \sphinxstylestrong{computational principles} rather than precise biological details

\item {} 
\sphinxAtStartPar
The most effective implementations involve \sphinxstylestrong{iterative refinement} between neuroscience insights and AI implementations

\item {} 
\sphinxAtStartPar
Key areas where neuroscience has informed AI include \sphinxstylestrong{attention mechanisms}, \sphinxstylestrong{memory systems}, \sphinxstylestrong{predictive processing}, and \sphinxstylestrong{neural data analysis}

\item {} 
\sphinxAtStartPar
Implementing neuroscience principles in AI often requires \sphinxstylestrong{creative adaptations} to match the constraints of current deep learning frameworks

\end{enumerate}


\subsection{Additional Resources}
\label{\detokenize{part6/rise_slides_demo:additional-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Interactive notebooks: \sphinxhref{https://github.com/NeuroAI-Handbook}{github.com/NeuroAI\sphinxhyphen{}Handbook}

\item {} 
\sphinxAtStartPar
Code implementations: Available in Chapter 20

\item {} 
\sphinxAtStartPar
Further reading: See references at end of Chapter 20

\end{itemize}


\section{Advantages of RISE for NeuroAI Presentations}
\label{\detokenize{part6/rise_slides_demo:advantages-of-rise-for-neuroai-presentations}}
\sphinxAtStartPar
Let’s return to discussing the benefits of RISE for creating presentations from the NeuroAI Handbook content.


\subsection{Advantages of RISE vs. Google Slides}
\label{\detokenize{part6/rise_slides_demo:advantages-of-rise-vs-google-slides}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Feature
&\sphinxstyletheadfamily 
\sphinxAtStartPar
RISE
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Google Slides
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
Code execution
&
\sphinxAtStartPar
✅ Live code execution
&
\sphinxAtStartPar
❌ Static code snippets only
\\
\sphinxhline
\sphinxAtStartPar
Integration with content
&
\sphinxAtStartPar
✅ Direct from notebook
&
\sphinxAtStartPar
❌ Requires copy/paste
\\
\sphinxhline
\sphinxAtStartPar
Interactive visualizations
&
\sphinxAtStartPar
✅ Fully interactive
&
\sphinxAtStartPar
❌ Static images only
\\
\sphinxhline
\sphinxAtStartPar
Mathematical expressions
&
\sphinxAtStartPar
✅ Native LaTeX support
&
\sphinxAtStartPar
⚠️ Limited equation editor
\\
\sphinxhline
\sphinxAtStartPar
Version control
&
\sphinxAtStartPar
✅ Git\sphinxhyphen{}friendly format
&
\sphinxAtStartPar
❌ Separate from codebase
\\
\sphinxhline
\sphinxAtStartPar
Consistency with handbook
&
\sphinxAtStartPar
✅ Same styling possible
&
\sphinxAtStartPar
⚠️ Requires manual styling
\\
\sphinxhline
\sphinxAtStartPar
Real\sphinxhyphen{}time collaboration
&
\sphinxAtStartPar
❌ Limited
&
\sphinxAtStartPar
✅ Excellent
\\
\sphinxhline
\sphinxAtStartPar
Export options
&
\sphinxAtStartPar
⚠️ HTML, PDF
&
\sphinxAtStartPar
✅ Many formats
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\subsection{When to Use RISE}
\label{\detokenize{part6/rise_slides_demo:when-to-use-rise}}
\sphinxAtStartPar
RISE is ideal for NeuroAI Handbook presentations when:
\begin{itemize}
\item {} 
\sphinxAtStartPar
You want to demonstrate live code execution

\item {} 
\sphinxAtStartPar
You need interactive visualizations

\item {} 
\sphinxAtStartPar
You’re presenting complex mathematical concepts

\item {} 
\sphinxAtStartPar
You want to maintain consistency with the handbook content

\item {} 
\sphinxAtStartPar
Your audience is technically oriented

\item {} 
\sphinxAtStartPar
You need to make frequent updates to content

\end{itemize}


\subsection{When to Use Google Slides}
\label{\detokenize{part6/rise_slides_demo:when-to-use-google-slides}}
\sphinxAtStartPar
Google Slides may be preferable when:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Multiple authors need to collaborate simultaneously

\item {} 
\sphinxAtStartPar
You need sophisticated animations and transitions

\item {} 
\sphinxAtStartPar
Your audience includes non\sphinxhyphen{}technical stakeholders

\item {} 
\sphinxAtStartPar
You need to incorporate rich media like videos

\item {} 
\sphinxAtStartPar
You require compatibility with PowerPoint

\item {} 
\sphinxAtStartPar
You need advanced presentation features like speaker notes and timed transitions

\end{itemize}


\subsection{Best Practices for Creating Slides with RISE}
\label{\detokenize{part6/rise_slides_demo:best-practices-for-creating-slides-with-rise}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Start with a template}: Create a template notebook with your desired styling

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Keep content concise}: Use bullet points and visuals rather than long paragraphs

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Add interactivity}: Include widgets for demonstrations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Use fragments}: Reveal content progressively to maintain focus

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Include practical examples}: Demonstrate concepts with executable code

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Test your presentations}: Ensure all code cells execute properly

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Export as HTML}: Share presentations as standalone HTML files

\end{enumerate}


\subsection{Adding RISE Configuration}
\label{\detokenize{part6/rise_slides_demo:adding-rise-configuration}}
\sphinxAtStartPar
You can customize RISE behavior by adding configuration to your notebook metadata:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{p}{\PYGZob{}}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}rise\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}theme\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}sky\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}transition\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}fade\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}start\PYGZus{}slideshow\PYGZus{}at\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}selected\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}auto\PYGZus{}select\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}code\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}autolaunch\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{k+kc}{false}
\PYG{+w}{  }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subsubsection{Available Themes}
\label{\detokenize{part6/rise_slides_demo:available-themes}}
\sphinxAtStartPar
RISE uses Reveal.js themes:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{black}: Black background, white text (default)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{white}: White background, dark text

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{league}: Dark gray background

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{sky}: Blue background

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{beige}: Beige background

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{simple}: White background, black text

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{serif}: Cappuccino background, gray text

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{night}: Black background, thick white text

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{moon}: Dark blue background

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{solarized}: Cream\sphinxhyphen{}colored background

\end{itemize}


\subsection{Integration with JupyterBook}
\label{\detokenize{part6/rise_slides_demo:integration-with-jupyterbook}}
\sphinxAtStartPar
To integrate RISE slides with the NeuroAI Handbook:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Create slide notebooks for each chapter

\item {} 
\sphinxAtStartPar
Add links in the chapter content to the slide versions

\item {} 
\sphinxAtStartPar
Include a presentations section in the table of contents

\item {} 
\sphinxAtStartPar
Configure JupyterBook to properly handle RISE notebooks

\end{enumerate}


\subsection{Conclusion}
\label{\detokenize{part6/rise_slides_demo:conclusion}}
\sphinxAtStartPar
RISE provides an excellent way to create interactive presentations directly from Jupyter notebooks, making it ideal for teaching and presenting NeuroAI concepts.

\sphinxAtStartPar
By integrating RISE with the NeuroAI Handbook, you can:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Maintain consistency between content and presentations

\item {} 
\sphinxAtStartPar
Demonstrate concepts with live code execution

\item {} 
\sphinxAtStartPar
Create engaging, interactive learning experiences

\item {} 
\sphinxAtStartPar
Easily update presentations when the handbook content changes

\end{itemize}


\subsection{References}
\label{\detokenize{part6/rise_slides_demo:references}}\begin{itemize}
\item {} 
\sphinxAtStartPar
RISE Documentation: \sphinxurl{https://rise.readthedocs.io/}

\item {} 
\sphinxAtStartPar
Reveal.js: \sphinxurl{https://revealjs.com/}

\item {} 
\sphinxAtStartPar
Jupyter Book: \sphinxurl{https://jupyterbook.org/}

\end{itemize}

\sphinxstepscope


\chapter{Chapter 21: AI for Neuroscience Discovery}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:chapter-21-ai-for-neuroscience-discovery}}\label{\detokenize{part6/ch21_ai_for_neuro_discovery::doc}}
\sphinxAtStartPar
This chapter examines how artificial intelligence is accelerating neuroscience research and enabling new discoveries about brain function and organization. While neuroscience has heavily inspired AI, AI is now increasingly being used to advance neuroscience in a virtuous cycle of innovation.


\section{21.0 Chapter Goals}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand how AI approaches are transforming neural data analysis

\item {} 
\sphinxAtStartPar
Explore computational brain simulations enabled by machine learning

\item {} 
\sphinxAtStartPar
Learn how AI assists in connectome reconstruction and cellular morphology analysis

\item {} 
\sphinxAtStartPar
Discover how machine learning helps develop theories of brain function

\item {} 
\sphinxAtStartPar
Implement neural data analysis tools using deep learning techniques

\end{itemize}


\section{21.1 Neural Data Analysis with Deep Learning}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:neural-data-analysis-with-deep-learning}}
\sphinxAtStartPar
The exponential growth in neural recording technologies has created a data analysis challenge that AI is uniquely positioned to address. Deep learning approaches can extract patterns and insights from complex, high\sphinxhyphen{}dimensional neural data that would be difficult or impossible to identify with traditional methods.


\subsection{21.1.1 Decoding Neural Activity}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:decoding-neural-activity}}
\sphinxAtStartPar
Deep learning models can decode neural activity to predict behavior, perception, or cognitive states:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}neural\PYGZus{}recordings}\PYG{p}{(}\PYG{n}{spike\PYGZus{}data}\PYG{p}{,} \PYG{n}{behavior\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Use deep learning to analyze neural recording data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} spike\PYGZus{}data: Neural spike recordings [neurons, time]}
\PYG{l+s+sd}{    \PYGZhy{} behavior\PYGZus{}data: Behavioral measurements [time, features]}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} model: Trained neural decoder}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Prepare data}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{spike\PYGZus{}data}\PYG{o}{.}\PYG{n}{T}  \PYG{c+c1}{\PYGZsh{} [time, neurons]}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{behavior\PYGZus{}data}  \PYG{c+c1}{\PYGZsh{} [time, features]}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{n}{split\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create and train a neural decoder}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{X}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{y}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train the model}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} 
                    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average R² score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
These decoding models can reveal how neural populations represent information and how these representations evolve over time. Applications include:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Movement Decoding}: Predicting limb trajectories from motor cortex activity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory Reconstruction}: Reconstructing visual or auditory stimuli from brain activity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cognitive State Classification}: Identifying decision\sphinxhyphen{}making processes, attention states, or memory formation

\end{itemize}


\subsection{21.1.2 Dimensionality Reduction for Neural Data}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:dimensionality-reduction-for-neural-data}}
\sphinxAtStartPar
Neural data is often high\sphinxhyphen{}dimensional, with recordings from hundreds or thousands of neurons. Deep learning approaches can identify lower\sphinxhyphen{}dimensional representations that capture the essential dynamics:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}dimensionality\PYGZus{}reduction}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Reduce dimensionality of neural data using a variational autoencoder}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}data: Neural activity data [samples, neurons]}
\PYG{l+s+sd}{    \PYGZhy{} latent\PYGZus{}dim: Dimension of latent space}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} encoder: Model that maps from neural activity to latent space}
\PYG{l+s+sd}{    \PYGZhy{} decoder: Model that maps from latent space to neural activity}
\PYG{l+s+sd}{    \PYGZhy{} latent\PYGZus{}representations: Neural data in latent space}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{functional} \PYG{k}{as} \PYG{n}{F}
    
    \PYG{c+c1}{\PYGZsh{} Normalize data}
    \PYG{n}{data\PYGZus{}mean} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{data\PYGZus{}std} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{keepdims}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}6}
    \PYG{n}{normalized\PYGZus{}data} \PYG{o}{=} \PYG{p}{(}\PYG{n}{neural\PYGZus{}data} \PYG{o}{\PYGZhy{}} \PYG{n}{data\PYGZus{}mean}\PYG{p}{)} \PYG{o}{/} \PYG{n}{data\PYGZus{}std}
    
    \PYG{c+c1}{\PYGZsh{} Convert to torch tensor}
    \PYG{n}{data\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{normalized\PYGZus{}data}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define VAE architecture}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{VAE}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{VAE}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Encoder}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc\PYGZus{}mu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc\PYGZus{}logvar} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Decoder}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{latent\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc4} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc5} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encode}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc\PYGZus{}mu}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc\PYGZus{}logvar}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reparameterize}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{std} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{logvar}\PYG{p}{)}
            \PYG{n}{eps} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn\PYGZus{}like}\PYG{p}{(}\PYG{n}{std}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{mu} \PYG{o}{+} \PYG{n}{eps} \PYG{o}{*} \PYG{n}{std}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decode}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{z}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc3}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{h} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc4}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc5}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{z} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{reparameterize}\PYG{p}{(}\PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar}
    
    \PYG{c+c1}{\PYGZsh{} Initialize model}
    \PYG{n}{input\PYGZus{}dim} \PYG{o}{=} \PYG{n}{neural\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{vae} \PYG{o}{=} \PYG{n}{VAE}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{latent\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train VAE}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{vae}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} VAE loss function}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{loss\PYGZus{}function}\PYG{p}{(}\PYG{n}{recon\PYGZus{}x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{BCE} \PYG{o}{=} \PYG{n}{F}\PYG{o}{.}\PYG{n}{mse\PYGZus{}loss}\PYG{p}{(}\PYG{n}{recon\PYGZus{}x}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{reduction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{KLD} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{logvar} \PYG{o}{\PYGZhy{}} \PYG{n}{mu}\PYG{o}{.}\PYG{n}{pow}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{logvar}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{BCE} \PYG{o}{+} \PYG{n}{KLD}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{recon\PYGZus{}batch}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar} \PYG{o}{=} \PYG{n}{vae}\PYG{p}{(}\PYG{n}{data\PYGZus{}tensor}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{loss\PYGZus{}function}\PYG{p}{(}\PYG{n}{recon\PYGZus{}batch}\PYG{p}{,} \PYG{n}{data\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{logvar}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data\PYGZus{}tensor}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Extract latent representations}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{mu}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{vae}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{data\PYGZus{}tensor}\PYG{p}{)}
        \PYG{n}{latent\PYGZus{}representations} \PYG{o}{=} \PYG{n}{mu}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create encoder and decoder functions}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{encoder}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{data\PYGZus{}norm} \PYG{o}{=} \PYG{p}{(}\PYG{n}{data} \PYG{o}{\PYGZhy{}} \PYG{n}{data\PYGZus{}mean}\PYG{p}{)} \PYG{o}{/} \PYG{n}{data\PYGZus{}std}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{mu}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{vae}\PYG{o}{.}\PYG{n}{encode}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{data\PYGZus{}norm}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mu}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{decoder}\PYG{p}{(}\PYG{n}{latent}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{recon} \PYG{o}{=} \PYG{n}{vae}\PYG{o}{.}\PYG{n}{decode}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{latent}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{recon\PYGZus{}unnorm} \PYG{o}{=} \PYG{n}{recon}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{n}{data\PYGZus{}std} \PYG{o}{+} \PYG{n}{data\PYGZus{}mean}
        \PYG{k}{return} \PYG{n}{recon\PYGZus{}unnorm}
    
    \PYG{k}{return} \PYG{n}{encoder}\PYG{p}{,} \PYG{n}{decoder}\PYG{p}{,} \PYG{n}{latent\PYGZus{}representations}
\end{sphinxVerbatim}

\sphinxAtStartPar
Dimensionality reduction techniques like variational autoencoders (VAEs) can:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Identify low\sphinxhyphen{}dimensional neural manifolds that represent behavioral states

\item {} 
\sphinxAtStartPar
Reveal population\sphinxhyphen{}level dynamics not visible at the single\sphinxhyphen{}neuron level

\item {} 
\sphinxAtStartPar
Enable visualization of high\sphinxhyphen{}dimensional neural trajectories

\item {} 
\sphinxAtStartPar
Discover shared structure across different brain regions or subjects

\end{itemize}


\subsection{21.1.3 Time Series Analysis for Neural Dynamics}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:time-series-analysis-for-neural-dynamics}}
\sphinxAtStartPar
Deep learning models are particularly effective for analyzing the temporal dynamics of neural activity:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}neural\PYGZus{}dynamics}\PYG{p}{(}\PYG{n}{neural\PYGZus{}time\PYGZus{}series}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Analyze neural dynamics using a recurrent neural network}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}time\PYGZus{}series: Neural activity over time [time, neurons]}
\PYG{l+s+sd}{    \PYGZhy{} sequence\PYGZus{}length: Length of sequences for prediction}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} model: Trained RNN model for neural dynamics prediction}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Prepare sequence data}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}sequences}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{seq\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{seq\PYGZus{}length}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{X}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{:}\PYG{n}{i}\PYG{o}{+}\PYG{n}{seq\PYGZus{}length}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{y}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{n}{seq\PYGZus{}length}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
    
    \PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{create\PYGZus{}sequences}\PYG{p}{(}\PYG{n}{neural\PYGZus{}time\PYGZus{}series}\PYG{p}{,} \PYG{n}{sequence\PYGZus{}length}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{n}{split\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{p}{:}\PYG{n}{split\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{split\PYGZus{}idx}\PYG{p}{:}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Define RNN model}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralRNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{NeuralRNN}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{LSTM}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{batch\PYGZus{}first}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{lstm\PYGZus{}out}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lstm}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc}\PYG{p}{(}\PYG{n}{lstm\PYGZus{}out}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Model parameters}
    \PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{n}{neural\PYGZus{}time\PYGZus{}series}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Number of neurons}
    \PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{64}
    \PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{n}{input\PYGZus{}size}
    
    \PYG{c+c1}{\PYGZsh{} Initialize model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{NeuralRNN}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train model}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to torch tensors}
    \PYG{n}{X\PYGZus{}train\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}train\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}test\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}test\PYGZus{}t} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}t}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred}\PYG{p}{,} \PYG{n}{y\PYGZus{}train\PYGZus{}t}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass and optimize}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Evaluate on test set}
            \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{test\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}t}\PYG{p}{)}
                \PYG{n}{test\PYGZus{}loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{test\PYGZus{}pred}\PYG{p}{,} \PYG{n}{y\PYGZus{}test\PYGZus{}t}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Train Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Test Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate prediction performance}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}t}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{corrcoef}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} 
                     \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Average R² score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
RNN\sphinxhyphen{}based models can:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Predict future neural activity based on past patterns

\item {} 
\sphinxAtStartPar
Identify recurrent dynamics and attractor states

\item {} 
\sphinxAtStartPar
Characterize how external inputs perturb ongoing neural dynamics

\item {} 
\sphinxAtStartPar
Model the temporal evolution of neural representations

\end{itemize}


\section{21.2 Brain Simulation Efforts}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:brain-simulation-efforts}}
\sphinxAtStartPar
AI is enabling increasingly detailed and realistic simulations of brain activity, from single neurons to large\sphinxhyphen{}scale networks.


\subsection{21.2.1 Large\sphinxhyphen{}Scale Neural Circuit Simulations}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:large-scale-neural-circuit-simulations}}
\sphinxAtStartPar
AI\sphinxhyphen{}assisted models can simulate the activity of large populations of neurons:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BrainRegionSimulation}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{connectivity\PYGZus{}density}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simplified brain region simulation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}neurons: Number of neurons to simulate}
\PYG{l+s+sd}{        \PYGZhy{} connectivity\PYGZus{}density: Fraction of possible connections to create}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons}
        
        \PYG{c+c1}{\PYGZsh{} Initialize neurons (simplified LIF model)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.0}  \PYG{c+c1}{\PYGZsh{} resting potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{55.0}  \PYG{c+c1}{\PYGZsh{} spike threshold (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{75.0}  \PYG{c+c1}{\PYGZsh{} reset potential (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau} \PYG{o}{=} \PYG{l+m+mf}{20.0}  \PYG{c+c1}{\PYGZsh{} membrane time constant (ms)}
        
        \PYG{c+c1}{\PYGZsh{} State variables}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}  \PYG{c+c1}{\PYGZsh{} membrane potentials}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} time until end of refractory period}
        
        \PYG{c+c1}{\PYGZsh{} Generate random connectivity matrix}
        \PYG{n}{p} \PYG{o}{=} \PYG{n}{connectivity\PYGZus{}density}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}
            \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,} \PYG{n}{p}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{p}\PYG{p}{,} \PYG{n}{p}\PYG{p}{]}
        \PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Scale weights and ensure no self\PYGZhy{}connections}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{np}\PYG{o}{.}\PYG{n}{fill\PYGZus{}diagonal}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} 80\PYGZpc{} excitatory, 20\PYGZpc{} inhibitory}
        \PYG{n}{inh\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{[}\PYG{n}{inh\PYGZus{}neurons}\PYG{p}{]} \PYG{o}{*}\PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}
        
        \PYG{c+c1}{\PYGZsh{} Record spikes}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{p}{[}\PYG{p}{[}\PYG{p}{]} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{step}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{external\PYGZus{}input}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simulate one time step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} external\PYGZus{}input: External current to each neuron}
\PYG{l+s+sd}{        \PYGZhy{} dt: Time step (ms)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} spikes: Boolean array indicating which neurons spiked}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Default to no external input}
        \PYG{k}{if} \PYG{n}{external\PYGZus{}input} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update membrane potentials}
        \PYG{n}{non\PYGZus{}refractory} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{c+c1}{\PYGZsh{} Decay potential toward rest}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dt} \PYG{o}{*} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}rest}\PYG{p}{)} \PYG{o}{+} 
                                        \PYG{n}{external\PYGZus{}input}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tau}
        
        \PYG{c+c1}{\PYGZsh{} Check for spikes}
        \PYG{n}{spiked} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}threshold}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Record spikes}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{spiked}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{current\PYGZus{}time}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Reset membrane potential and set refractory period for spiked neurons}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{spiked}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v\PYGZus{}reset}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time}\PYG{p}{[}\PYG{n}{spiked}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{2.0}  \PYG{c+c1}{\PYGZsh{} 2ms refractory period}
        
        \PYG{c+c1}{\PYGZsh{} Decrement refractory time}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{refractory\PYGZus{}time} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{dt}
        
        \PYG{c+c1}{\PYGZsh{} Add synaptic inputs from spiking neurons}
        \PYG{n}{synaptic\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{,} \PYG{n}{spiked}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{v}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{synaptic\PYGZus{}input}\PYG{p}{[}\PYG{n}{non\PYGZus{}refractory}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{spiked}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{n}{input\PYGZus{}fn}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run simulation for specified duration}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} duration: Simulation duration (ms)}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}fn: Function that returns external input at each time step}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} spike\PYGZus{}times: List of spike times for each neuron}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{steps} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{duration} \PYG{o}{/} \PYG{l+m+mf}{0.1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Assuming dt=0.1}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{step} \PYG{o}{*} \PYG{l+m+mf}{0.1}
            
            \PYG{c+c1}{\PYGZsh{} Get external input if provided}
            \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{k+kc}{None}
            \PYG{k}{if} \PYG{n}{input\PYGZus{}fn} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{external\PYGZus{}input} \PYG{o}{=} \PYG{n}{input\PYGZus{}fn}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
            
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{external\PYGZus{}input}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}raster}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}subset}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{time\PYGZus{}range}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Plot spike raster for simulated neurons}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} neuron\PYGZus{}subset: List of neuron indices to plot (default: first 100)}
\PYG{l+s+sd}{        \PYGZhy{} time\PYGZus{}range: Time range to plot as [start, end] (default: all)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
        
        \PYG{c+c1}{\PYGZsh{} Default to plotting first 100 neurons}
        \PYG{k}{if} \PYG{n}{neuron\PYGZus{}subset} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{neuron\PYGZus{}subset} \PYG{o}{=} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create figure}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot spikes for each neuron}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{neuron\PYGZus{}subset}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{spikes} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{neuron\PYGZus{}idx}\PYG{p}{]}
            \PYG{k}{if} \PYG{n}{time\PYGZus{}range}\PYG{p}{:}
                \PYG{n}{spikes} \PYG{o}{=} \PYG{p}{[}\PYG{n}{t} \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n}{spikes} \PYG{k}{if} \PYG{n}{time\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{t} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{time\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron index}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster Plot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{time\PYGZus{}range}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlim}\PYG{p}{(}\PYG{n}{time\PYGZus{}range}\PYG{p}{)}
            
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Large\sphinxhyphen{}scale simulations enable:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Testing hypotheses about neural circuit function

\item {} 
\sphinxAtStartPar
Exploring emergent dynamics in complex networks

\item {} 
\sphinxAtStartPar
Investigating how network structure shapes activity patterns

\item {} 
\sphinxAtStartPar
Simulating the effects of interventions like stimulation or pharmacology

\end{itemize}


\subsection{21.2.2 Brain Region Models}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:brain-region-models}}
\sphinxAtStartPar
AI is helping develop increasingly detailed models of specific brain regions:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}cortical\PYGZus{}column\PYGZus{}model}\PYG{p}{(}\PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a simplified model of a cortical column}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}layers: Number of cortical layers}
\PYG{l+s+sd}{    \PYGZhy{} neurons\PYGZus{}per\PYGZus{}layer: Neurons per layer}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} model: Cortical column simulation model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{n\PYGZus{}layers} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{BrainRegionSimulation}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{connectivity\PYGZus{}density}\PYG{o}{=}\PYG{l+m+mf}{0.15}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Modify connectivity to reflect cortical architecture}
    \PYG{c+c1}{\PYGZsh{} Reset weights}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Layer\PYGZhy{}specific connection probabilities}
    \PYG{n}{connection\PYGZus{}probs} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{c+c1}{\PYGZsh{} (pre\PYGZus{}layer, post\PYGZus{}layer): probability}
        \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.15}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 1 → Layer 1}
        \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.2}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 1 → Layer 2/3}
        \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.2}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 2/3 → Layer 2/3}
        \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.15}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 2/3 → Layer 4}
        \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 2/3 → Layer 5}
        \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 4 → Layer 2/3}
        \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.15}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 4 → Layer 4}
        \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.2}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 4 → Layer 5}
        \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.15}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 5 → Layer 5}
        \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.2}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 5 → Layer 6}
        \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 5 → Layer 2/3 (feedback)}
        \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Layer 6 → Layer 4}
        \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Layer 6 → Layer 6}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Create connections based on probabilities}
    \PYG{k}{for} \PYG{p}{(}\PYG{n}{pre\PYGZus{}layer}\PYG{p}{,} \PYG{n}{post\PYGZus{}layer}\PYG{p}{)}\PYG{p}{,} \PYG{n}{prob} \PYG{o+ow}{in} \PYG{n}{connection\PYGZus{}probs}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{pre\PYGZus{}start} \PYG{o}{=} \PYG{n}{pre\PYGZus{}layer} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        \PYG{n}{pre\PYGZus{}end} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pre\PYGZus{}layer} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        \PYG{n}{post\PYGZus{}start} \PYG{o}{=} \PYG{n}{post\PYGZus{}layer} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        \PYG{n}{post\PYGZus{}end} \PYG{o}{=} \PYG{p}{(}\PYG{n}{post\PYGZus{}layer} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        
        \PYG{c+c1}{\PYGZsh{} Random connectivity based on probability}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{post\PYGZus{}start}\PYG{p}{,} \PYG{n}{post\PYGZus{}end}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{pre\PYGZus{}start}\PYG{p}{,} \PYG{n}{pre\PYGZus{}end}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{random}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{prob}\PYG{p}{:}
                    \PYG{c+c1}{\PYGZsh{} Excitatory or inhibitory based on pre\PYGZhy{}synaptic neuron}
                    \PYG{n}{is\PYGZus{}inhibitory} \PYG{o}{=} \PYG{p}{(}\PYG{n}{j} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{5} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} \PYGZti{}20\PYGZpc{} inhibitory neurons}
                    \PYG{n}{weight} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)} \PYG{k}{if} \PYG{n}{is\PYGZus{}inhibitory} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.05}\PYG{p}{)}
                    \PYG{n}{model}\PYG{o}{.}\PYG{n}{weights}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{weight}
    
    \PYG{c+c1}{\PYGZsh{} Create thalamic input function}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{thalamic\PYGZus{}input}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{target\PYGZus{}layer}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate periodic thalamic input to layer 4\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{input\PYGZus{}vec} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Target mainly layer 4 (index 2)}
        \PYG{n}{target\PYGZus{}start} \PYG{o}{=} \PYG{n}{target\PYGZus{}layer} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        \PYG{n}{target\PYGZus{}end} \PYG{o}{=} \PYG{p}{(}\PYG{n}{target\PYGZus{}layer} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{neurons\PYGZus{}per\PYGZus{}layer}
        
        \PYG{c+c1}{\PYGZsh{} Periodic input (every 100ms)}
        \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{100} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{5}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Random subset of neurons in target layer}
            \PYG{n}{target\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}
                \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{target\PYGZus{}start}\PYG{p}{,} \PYG{n}{target\PYGZus{}end}\PYG{p}{)}\PYG{p}{,} 
                \PYG{n}{size}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{neurons\PYGZus{}per\PYGZus{}layer} \PYG{o}{*} \PYG{l+m+mf}{0.2}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}
            \PYG{p}{)}
            \PYG{n}{input\PYGZus{}vec}\PYG{p}{[}\PYG{n}{target\PYGZus{}neurons}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{target\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{input\PYGZus{}vec}
    
    \PYG{c+c1}{\PYGZsh{} Store the input function with the model}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{thalamic\PYGZus{}input} \PYG{o}{=} \PYG{n}{thalamic\PYGZus{}input}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
Brain region models enable:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structure\sphinxhyphen{}Function Analysis}: Relating anatomical organization to functional properties

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Inter\sphinxhyphen{}Region Integration}: Understanding how different brain areas interact

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hierarchical Processing}: Modeling information flow through layered structures

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational Comparisons}: Relating brain regions to artificial neural network architectures

\end{itemize}


\section{21.3 Connectome Reconstruction}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:connectome-reconstruction}}
\sphinxAtStartPar
AI techniques are dramatically accelerating efforts to map the brain’s wiring diagram (connectome) at multiple scales.


\subsection{21.3.1 Electron Microscopy Analysis}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:electron-microscopy-analysis}}
\sphinxAtStartPar
Electron microscopy (EM) allows imaging of neural tissue at nanometer resolution, capturing synaptic connections. AI is essential for analyzing the enormous datasets this produces:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{segment\PYGZus{}neural\PYGZus{}images}\PYG{p}{(}\PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Segment neurons in electron microscopy images using deep learning}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} electron\PYGZus{}microscopy\PYGZus{}images: 3D stack of EM images}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} segmentation: 3D segmentation map}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Create a 3D U\PYGZhy{}Net model for segmentation}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{UNet3D}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{in\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{UNet3D}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} Simplified placeholder for the model architecture}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{p}{,} \PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Conv3d}\PYG{p}{(}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{padding}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Simplified forward pass}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{encoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{decoder}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{x}
    
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{UNet3D}\PYG{p}{(}\PYG{n}{in\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{out\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 3 output channels: background, membrane, cell interior}
    
    \PYG{c+c1}{\PYGZsh{} Process image stack in 3D patches}
    \PYG{n}{patch\PYGZus{}size} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{,} \PYG{l+m+mi}{64}\PYG{p}{)}
    \PYG{n}{segmentation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simplified inference (in practice, would need proper patch handling)}
    \PYG{k}{for} \PYG{n}{z} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Extract patch}
                \PYG{n}{z\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{z} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{y\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{y} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{x\PYGZus{}end} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{patch\PYGZus{}size}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}
                
                \PYG{n}{patch} \PYG{o}{=} \PYG{n}{electron\PYGZus{}microscopy\PYGZus{}images}\PYG{p}{[}\PYG{n}{z}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Zero\PYGZhy{}pad if necessary}
                \PYG{k}{if} \PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape} \PYG{o}{!=} \PYG{n}{patch\PYGZus{}size}\PYG{p}{:}
                    \PYG{n}{padded} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{patch\PYGZus{}size}\PYG{p}{)}
                    \PYG{n}{padded}\PYG{p}{[}\PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{:}\PYG{n}{patch}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{n}{patch}
                    \PYG{n}{patch} \PYG{o}{=} \PYG{n}{padded}
                
                \PYG{c+c1}{\PYGZsh{} Predict segmentation}
                \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{input\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{patch}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
                    \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{input\PYGZus{}tensor}\PYG{p}{)}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{dim}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{squeeze}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update segmentation (handle overlap with averaging)}
                \PYG{n}{segmentation}\PYG{p}{[}\PYG{n}{z}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{p}{,} \PYG{n}{y}\PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prediction}\PYG{p}{[}\PYG{p}{:}\PYG{n}{z\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{z}\PYG{p}{,} \PYG{p}{:}\PYG{n}{y\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{y}\PYG{p}{,} \PYG{p}{:}\PYG{n}{x\PYGZus{}end}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Post\PYGZhy{}process to get instance segmentation (simplified)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{measure}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{label}
    \PYG{n}{instance\PYGZus{}seg} \PYG{o}{=} \PYG{n}{label}\PYG{p}{(}\PYG{n}{segmentation} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Assuming channel 2 is cell interior}
    
    \PYG{k}{return} \PYG{n}{instance\PYGZus{}seg}
\end{sphinxVerbatim}

\sphinxAtStartPar
AI\sphinxhyphen{}powered connectome reconstruction enables:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Automated segmentation of neurons in EM volumes

\item {} 
\sphinxAtStartPar
Tracing of neurites through complex tissue samples

\item {} 
\sphinxAtStartPar
Identification of synaptic connections

\item {} 
\sphinxAtStartPar
Statistical analysis of connectivity patterns

\end{itemize}


\subsection{21.3.2 Macro\sphinxhyphen{}Scale Connectomics}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:macro-scale-connectomics}}
\sphinxAtStartPar
AI also helps analyze macro\sphinxhyphen{}scale connectivity using techniques like diffusion MRI:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{analyze\PYGZus{}structural\PYGZus{}connectivity}\PYG{p}{(}\PYG{n}{dti\PYGZus{}data}\PYG{p}{,} \PYG{n}{parcellation}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Analyze structural connectivity from diffusion MRI data}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} dti\PYGZus{}data: Diffusion tensor imaging data}
\PYG{l+s+sd}{    \PYGZhy{} parcellation: Brain region parcellation}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} connectivity\PYGZus{}matrix: Structural connectivity matrix}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{dipy}\PYG{n+nn}{.}\PYG{n+nn}{tracking}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{utils}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{dipy}\PYG{n+nn}{.}\PYG{n+nn}{tracking}\PYG{n+nn}{.}\PYG{n+nn}{streamline}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Streamlines}
    
    \PYG{c+c1}{\PYGZsh{} Placeholder for actual tractography implementation}
    \PYG{c+c1}{\PYGZsh{} In practice, this would use proper DTI processing tools}
    
    \PYG{c+c1}{\PYGZsh{} Simulate streamlines}
    \PYG{n}{n\PYGZus{}streamlines} \PYG{o}{=} \PYG{l+m+mi}{10000}
    \PYG{n}{n\PYGZus{}regions} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{parcellation}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} Excluding background}
    
    \PYG{c+c1}{\PYGZsh{} Create random streamlines for demonstration}
    \PYG{n}{streamlines} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}streamlines}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Random streamline with 100 points}
        \PYG{n}{streamline} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{dti\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
        \PYG{n}{streamlines}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{streamline}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to DIPY Streamlines object}
    \PYG{n}{streamlines} \PYG{o}{=} \PYG{n}{Streamlines}\PYG{p}{(}\PYG{n}{streamlines}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute connectivity matrix (region x region)}
    \PYG{n}{M}\PYG{p}{,} \PYG{n}{grouping} \PYG{o}{=} \PYG{n}{utils}\PYG{o}{.}\PYG{n}{connectivity\PYGZus{}matrix}\PYG{p}{(}
        \PYG{n}{streamlines}\PYG{p}{,} \PYG{n}{parcellation}\PYG{p}{,} 
        \PYG{n}{return\PYGZus{}mapping}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
        \PYG{n}{mapping\PYGZus{}as\PYGZus{}streamlines}\PYG{o}{=}\PYG{k+kc}{True}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize by region size}
    \PYG{n}{region\PYGZus{}sizes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{bincount}\PYG{p}{(}\PYG{n}{parcellation}\PYG{o}{.}\PYG{n}{flat}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Exclude background}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}regions}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{region\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{region\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{M}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{M}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{region\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{*} \PYG{n}{region\PYGZus{}sizes}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{M}
\end{sphinxVerbatim}

\sphinxAtStartPar
Macro\sphinxhyphen{}scale connectome analysis reveals:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain network topology}: The large\sphinxhyphen{}scale organization of brain networks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural connectivity patterns}: How different brain regions connect to each other

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Individual differences}: How connectivity varies across subjects or clinical populations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structure\sphinxhyphen{}function relationships}: How structural connectivity constrains functional dynamics

\end{itemize}


\section{21.4 Theory Development through Modeling}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:theory-development-through-modeling}}
\sphinxAtStartPar
Beyond data analysis, AI helps develop computational theories of brain function by building models that explain neural data.


\subsection{21.4.1 Computational Models of Cognition}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:computational-models-of-cognition}}
\sphinxAtStartPar
Bayesian and probabilistic models can capture how the brain performs inference under uncertainty:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{BayesianInferenceBrain}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}noise}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{prior\PYGZus{}mean}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{prior\PYGZus{}var}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Model of Bayesian inference in the brain}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensory\PYGZus{}noise: Standard deviation of sensory noise}
\PYG{l+s+sd}{        \PYGZhy{} prior\PYGZus{}mean: Prior belief about the mean of the variable}
\PYG{l+s+sd}{        \PYGZhy{} prior\PYGZus{}var: Prior belief about the variance of the variable}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise} \PYG{o}{=} \PYG{n}{sensory\PYGZus{}noise}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prior\PYGZus{}mean} \PYG{o}{=} \PYG{n}{prior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prior\PYGZus{}var} \PYG{o}{=} \PYG{n}{prior\PYGZus{}var}
        
        \PYG{c+c1}{\PYGZsh{} Current belief}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{=} \PYG{n}{prior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var} \PYG{o}{=} \PYG{n}{prior\PYGZus{}var}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}belief}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{observation}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update beliefs using Bayes\PYGZsq{} rule}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} observation: New sensory observation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} posterior\PYGZus{}mean: Updated belief mean}
\PYG{l+s+sd}{        \PYGZhy{} posterior\PYGZus{}var: Updated belief variance}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Compute precision (inverse variance)}
        \PYG{n}{prior\PYGZus{}precision} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var}
        \PYG{n}{obs\PYGZus{}precision} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Bayesian update (for Gaussian variables)}
        \PYG{n}{posterior\PYGZus{}precision} \PYG{o}{=} \PYG{n}{prior\PYGZus{}precision} \PYG{o}{+} \PYG{n}{obs\PYGZus{}precision}
        \PYG{n}{posterior\PYGZus{}var} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n}{posterior\PYGZus{}precision}
        
        \PYG{n}{posterior\PYGZus{}mean} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}var} \PYG{o}{*} \PYG{p}{(}
            \PYG{n}{prior\PYGZus{}precision} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{+} 
            \PYG{n}{obs\PYGZus{}precision} \PYG{o}{*} \PYG{n}{observation}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update beliefs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}mean}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var} \PYG{o}{=} \PYG{n}{posterior\PYGZus{}var}
        
        \PYG{k}{return} \PYG{n}{posterior\PYGZus{}mean}\PYG{p}{,} \PYG{n}{posterior\PYGZus{}var}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}observation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate predicted observations based on current belief}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}samples: Number of samples to generate}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} samples: Predicted observations}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
        
        \PYG{c+c1}{\PYGZsh{} Sample from current belief}
        \PYG{n}{samples} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}mean}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{belief\PYGZus{}var}\PYG{p}{)}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add sensory noise}
        \PYG{n}{samples} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensory\PYGZus{}noise}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{samples}
\end{sphinxVerbatim}


\subsection{21.4.2 Neural Circuit Mechanisms}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:neural-circuit-mechanisms}}
\sphinxAtStartPar
AI helps identify circuit mechanisms that explain observed neural activity patterns:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{infer\PYGZus{}circuit\PYGZus{}mechanisms}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{p}{,} \PYG{n}{behaviors}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Infer underlying circuit mechanisms from neural recordings}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}activity: Neural activity recordings [neurons, time]}
\PYG{l+s+sd}{    \PYGZhy{} behaviors: Behavioral measurements [time, behaviors]}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} circuit\PYGZus{}model: Inferred circuit model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{neural\PYGZus{}activity}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{n\PYGZus{}behaviors} \PYG{o}{=} \PYG{n}{behaviors}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Define a circuit model}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CircuitModel}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}latent}\PYG{p}{,} \PYG{n}{n\PYGZus{}behaviors}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{CircuitModel}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{n\PYGZus{}neurons}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}latent} \PYG{o}{=} \PYG{n}{n\PYGZus{}latent}
            
            \PYG{c+c1}{\PYGZsh{} Recurrent weights}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}rec} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Input weights}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}in} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}behaviors}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Readout weights}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}out} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}behaviors}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Latent dynamics}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}latent} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}latent}\PYG{p}{,} \PYG{n}{n\PYGZus{}latent}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}latent\PYGZus{}to\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}latent}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}neurons\PYGZus{}to\PYGZus{}latent} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}latent}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Biases}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b\PYGZus{}latent} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}latent}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{r\PYGZus{}t}\PYG{p}{,} \PYG{n}{z\PYGZus{}t}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{            }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Single timestep update\PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{c+c1}{\PYGZsh{} Update latent state}
            \PYG{n}{z\PYGZus{}next} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}
                \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}latent}\PYG{p}{,} \PYG{n}{z\PYGZus{}t}\PYG{p}{)} \PYG{o}{+} 
                \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}neurons\PYGZus{}to\PYGZus{}latent}\PYG{p}{,} \PYG{n}{r\PYGZus{}t}\PYG{p}{)} \PYG{o}{+} 
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b\PYGZus{}latent}
            \PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update neural activity}
            \PYG{n}{r\PYGZus{}next} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}
                \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}rec}\PYG{p}{,} \PYG{n}{r\PYGZus{}t}\PYG{p}{)} \PYG{o}{+} 
                \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}in}\PYG{p}{,} \PYG{n}{x\PYGZus{}t}\PYG{p}{)} \PYG{o}{+} 
                \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}latent\PYGZus{}to\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{z\PYGZus{}t}\PYG{p}{)} \PYG{o}{+} 
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b\PYGZus{}neurons}
            \PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Generate output}
            \PYG{n}{y\PYGZus{}next} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{matmul}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}out}\PYG{p}{,} \PYG{n}{r\PYGZus{}next}\PYG{p}{)}
            
            \PYG{k}{return} \PYG{n}{r\PYGZus{}next}\PYG{p}{,} \PYG{n}{z\PYGZus{}next}\PYG{p}{,} \PYG{n}{y\PYGZus{}next}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{,} \PYG{n}{initial\PYGZus{}r}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{initial\PYGZus{}z}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{            }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Run simulation for multiple timesteps\PYGZdq{}\PYGZdq{}\PYGZdq{}}
            \PYG{k}{if} \PYG{n}{initial\PYGZus{}r} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{initial\PYGZus{}r} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{initial\PYGZus{}z} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{initial\PYGZus{}z} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}latent}\PYG{p}{)}
            
            \PYG{n}{r\PYGZus{}t} \PYG{o}{=} \PYG{n}{initial\PYGZus{}r}
            \PYG{n}{z\PYGZus{}t} \PYG{o}{=} \PYG{n}{initial\PYGZus{}z}
            
            \PYG{c+c1}{\PYGZsh{} Store activity}
            \PYG{n}{r\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r\PYGZus{}t}\PYG{p}{]}
            \PYG{n}{z\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{n}{z\PYGZus{}t}\PYG{p}{]}
            \PYG{n}{y\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Run simulation}
            \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{steps}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{x\PYGZus{}t} \PYG{o}{=} \PYG{n}{inputs}\PYG{p}{[}\PYG{n}{t}\PYG{p}{]} \PYG{k}{if} \PYG{n}{t} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)} \PYG{k}{else} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{r\PYGZus{}t}\PYG{p}{,} \PYG{n}{z\PYGZus{}t}\PYG{p}{,} \PYG{n}{y\PYGZus{}t} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{x\PYGZus{}t}\PYG{p}{,} \PYG{n}{r\PYGZus{}t}\PYG{p}{,} \PYG{n}{z\PYGZus{}t}\PYG{p}{)}
                
                \PYG{n}{r\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{r\PYGZus{}t}\PYG{p}{)}
                \PYG{n}{z\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{z\PYGZus{}t}\PYG{p}{)}
                \PYG{n}{y\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{y\PYGZus{}t}\PYG{p}{)}
            
            \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{r\PYGZus{}history}\PYG{p}{)}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{z\PYGZus{}history}\PYG{p}{)}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{n}{y\PYGZus{}history}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Prepare data}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{behaviors}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{Y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{n}{neural\PYGZus{}activity}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [time, neurons]}
    
    \PYG{c+c1}{\PYGZsh{} Create model}
    \PYG{n}{n\PYGZus{}latent} \PYG{o}{=} \PYG{l+m+mi}{10}  \PYG{c+c1}{\PYGZsh{} Number of latent variables}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{CircuitModel}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}latent}\PYG{p}{,} \PYG{n}{n\PYGZus{}behaviors}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define loss function and optimizer}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train model}
    \PYG{n}{n\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Reset initial state}
        \PYG{n}{r0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        \PYG{n}{z0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}latent}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{r\PYGZus{}pred}\PYG{p}{,} \PYG{n}{z\PYGZus{}pred}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{run\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{p}{,} \PYG{n}{r0}\PYG{p}{,} \PYG{n}{z0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Computer loss (compare predicted to actual neural activity)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{r\PYGZus{}pred}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{[}\PYG{p}{:}\PYG{n}{n\PYGZus{}steps}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass and optimize}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}


\section{21.5 Neuromorphic Applications}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:neuromorphic-applications}}
\sphinxAtStartPar
AI\sphinxhyphen{}derived insights about the brain can be applied to develop new neuromorphic computing architectures.


\subsection{21.5.1 Brain\sphinxhyphen{}Inspired Learning Rules}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:brain-inspired-learning-rules}}
\sphinxAtStartPar
Learning algorithms inspired by neuroscience can be more efficient than backpropagation:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}with\PYGZus{}local\PYGZus{}learning\PYGZus{}rule}\PYG{p}{(}\PYG{n}{network}\PYG{p}{,} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Train a neural network using a local Hebbian\PYGZhy{}like learning rule}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} network: Neural network to train}
\PYG{l+s+sd}{    \PYGZhy{} inputs: Training inputs}
\PYG{l+s+sd}{    \PYGZhy{} targets: Training targets}
\PYG{l+s+sd}{    \PYGZhy{} epochs: Number of training epochs}
\PYG{l+s+sd}{    \PYGZhy{} learning\PYGZus{}rate: Learning rate}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} network: Trained network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    
    \PYG{c+c1}{\PYGZsh{} Simple 2\PYGZhy{}layer network}
    \PYG{n}{W1} \PYG{o}{=} \PYG{n}{network}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Input → Hidden weights}
    \PYG{n}{W2} \PYG{o}{=} \PYG{n}{network}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Hidden → Output weights}
    
    \PYG{c+c1}{\PYGZsh{} Activation function}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Derivative of sigmoid}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{dsigmoid}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{y} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{total\PYGZus{}error} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Forward pass}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{inputs}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            \PYG{n}{target} \PYG{o}{=} \PYG{n}{targets}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Hidden layer}
            \PYG{n}{hidden\PYGZus{}in} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{W1}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}
            \PYG{n}{hidden\PYGZus{}out} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}in}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Output layer}
            \PYG{n}{output\PYGZus{}in} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{W2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}out}\PYG{p}{)}
            \PYG{n}{output} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{output\PYGZus{}in}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate error}
            \PYG{n}{error} \PYG{o}{=} \PYG{n}{target} \PYG{o}{\PYGZhy{}} \PYG{n}{output}
            \PYG{n}{total\PYGZus{}error} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{error}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Local learning rule (simplified)}
            \PYG{c+c1}{\PYGZsh{} Output layer: Error\PYGZhy{}modulated Hebbian}
            \PYG{n}{dW2} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{error} \PYG{o}{*} \PYG{n}{dsigmoid}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}out}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Hidden layer: Simplified error projection}
            \PYG{n}{hidden\PYGZus{}error} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{W2}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{error} \PYG{o}{*} \PYG{n}{dsigmoid}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{dW1} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}error} \PYG{o}{*} \PYG{n}{dsigmoid}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}out}\PYG{p}{)}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update weights}
            \PYG{n}{W1} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dW1}
            \PYG{n}{W2} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dW2}
        
        \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Error: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}error}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{network}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{W1}
    \PYG{n}{network}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{W2}
    
    \PYG{k}{return} \PYG{n}{network}
\end{sphinxVerbatim}

\sphinxAtStartPar
Local learning rules have several advantages:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological plausibility}: They better match how the brain learns

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Energy efficiency}: They require less information to be transmitted

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hardware compatibility}: They’re easier to implement in neuromorphic systems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Continual learning}: They can adapt to new data without catastrophic forgetting

\end{itemize}


\section{21.6 Code Lab: Neural Data Analysis}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:code-lab-neural-data-analysis}}
\sphinxAtStartPar
Let’s implement a complete pipeline for neural data analysis:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{neural\PYGZus{}data\PYGZus{}analysis\PYGZus{}pipeline}\PYG{p}{(}\PYG{n}{neural\PYGZus{}data\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    End\PYGZhy{}to\PYGZhy{}end pipeline for neural data analysis}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} neural\PYGZus{}data\PYGZus{}file: Path to neural recording data file}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} results: Analysis results and visualizations}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{manifold}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{TSNE}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
    
    \PYG{c+c1}{\PYGZsh{} Load data (simulated for this example)}
    \PYG{c+c1}{\PYGZsh{} In practice, would load from file}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{n\PYGZus{}timepoints} \PYG{o}{=} \PYG{l+m+mi}{1000}
    \PYG{n}{n\PYGZus{}trials} \PYG{o}{=} \PYG{l+m+mi}{50}
    \PYG{n}{n\PYGZus{}conditions} \PYG{o}{=} \PYG{l+m+mi}{5}
    
    \PYG{c+c1}{\PYGZsh{} Create simulated data}
    \PYG{c+c1}{\PYGZsh{} Shape: [trials, neurons, time]}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
    
    \PYG{c+c1}{\PYGZsh{} Add condition\PYGZhy{}specific patterns}
    \PYG{n}{conditions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{n\PYGZus{}conditions}\PYG{p}{,} \PYG{n}{n\PYGZus{}trials}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{condition} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create condition\PYGZhy{}specific neural pattern}
        \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
        \PYG{n}{active\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{n}{pattern}\PYG{p}{[}\PYG{n}{active\PYGZus{}neurons}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{2}
        
        \PYG{c+c1}{\PYGZsh{} Add pattern to neural activity with temporal dynamics}
        \PYG{k}{for} \PYG{n}{t} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{l+m+mi}{200} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{t} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{700}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Active during middle of trial}
                \PYG{n}{scale} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{200}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{500} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{3}  \PYG{c+c1}{\PYGZsh{} Modulation}
                \PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{t}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{pattern} \PYG{o}{*} \PYG{n}{scale}
    
    \PYG{c+c1}{\PYGZsh{} Add trial\PYGZhy{}to\PYGZhy{}trial variability}
    \PYG{n}{data} \PYG{o}{+}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.2}
    
    \PYG{c+c1}{\PYGZsh{} Create behavior data (e.g., reaction times)}
    \PYG{n}{behavior} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{condition} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Condition affects reaction time}
        \PYG{n}{behavior}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{n}{condition} \PYG{o}{*} \PYG{l+m+mf}{0.1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Data loaded: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (trials, neurons, time)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 1. Basic neural analysis}
    
    \PYG{c+c1}{\PYGZsh{} Calculate trial\PYGZhy{}averaged firing rates}
    \PYG{n}{condition\PYGZus{}avg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{condition\PYGZus{}idx} \PYG{o}{=} \PYG{n}{conditions} \PYG{o}{==} \PYG{n}{c}
        \PYG{n}{condition\PYGZus{}avg}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{condition\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot average firing rates for selected neurons}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{selected\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{selected\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{condition\PYGZus{}avg}\PYG{p}{[}\PYG{n}{c}\PYG{p}{,} \PYG{n}{neuron\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Condition }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{neuron\PYGZus{}idx}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Trial\PYGZhy{}averaged firing rates}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{4}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time (ms)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{firing\PYGZus{}rates.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 2. Dimensionality reduction}
    
    \PYG{c+c1}{\PYGZsh{} Reshape data for PCA [trials*time, neurons]}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run PCA}
    \PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}pca} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reshape back to [trials, time, components]}
    \PYG{n}{X\PYGZus{}pca} \PYG{o}{=} \PYG{n}{X\PYGZus{}pca}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{n\PYGZus{}trials}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot top 3 PCs for different conditions}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{condition\PYGZus{}idx} \PYG{o}{=} \PYG{n}{conditions} \PYG{o}{==} \PYG{n}{c}
        \PYG{n}{X\PYGZus{}c} \PYG{o}{=} \PYG{n}{X\PYGZus{}pca}\PYG{p}{[}\PYG{n}{condition\PYGZus{}idx}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Average across trials}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{c}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{pc} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{X\PYGZus{}c}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{pc}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PC}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{pc}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Condition }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ \PYGZhy{} Top 3 PCs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PC Value}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{c} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{c} \PYG{o}{==} \PYG{l+m+mi}{4}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Time (ms)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pca\PYGZus{}analysis.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 3. Neural decoding}
    
    \PYG{c+c1}{\PYGZsh{} Prepare data for decoding (use middle timepoint activity)}
    \PYG{n}{middle\PYGZus{}idx} \PYG{o}{=} \PYG{n}{n\PYGZus{}timepoints} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    \PYG{n}{X\PYGZus{}decode} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{middle\PYGZus{}idx}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} [trials, neurons]}
    \PYG{n}{y\PYGZus{}decode} \PYG{o}{=} \PYG{n}{conditions}
    
    \PYG{c+c1}{\PYGZsh{} Split into train/test}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{X\PYGZus{}decode}\PYG{p}{,} \PYG{n}{y\PYGZus{}decode}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simple decoder (multinomial logistic regression)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LogisticRegression}
    \PYG{n}{decoder} \PYG{o}{=} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{multi\PYGZus{}class}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{multinomial}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{solver}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lbfgs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{decoder}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Evaluate}
    \PYG{n}{train\PYGZus{}score} \PYG{o}{=} \PYG{n}{decoder}\PYG{o}{.}\PYG{n}{score}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    \PYG{n}{test\PYGZus{}score} \PYG{o}{=} \PYG{n}{decoder}\PYG{o}{.}\PYG{n}{score}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Decoding accuracy \PYGZhy{} Train: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{train\PYGZus{}score}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Test: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}score}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Identify most informative neurons}
    \PYG{n}{coef} \PYG{o}{=} \PYG{n}{decoder}\PYG{o}{.}\PYG{n}{coef\PYGZus{}}  \PYG{c+c1}{\PYGZsh{} [classes, features]}
    \PYG{n}{importance} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{coef}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Sum across classes}
    \PYG{n}{top\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{n}{importance}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{10}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Top 10 neurons}
    
    \PYG{c+c1}{\PYGZsh{} 4. Dynamic neural trajectory visualization}
    
    \PYG{c+c1}{\PYGZsh{} Use t\PYGZhy{}SNE to visualize neural dynamics}
    \PYG{c+c1}{\PYGZsh{} Get trial\PYGZhy{}averaged activity for each condition}
    \PYG{n}{X\PYGZus{}tsne} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{labels} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{X\PYGZus{}tsne}\PYG{p}{[}\PYG{n}{c} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{:}\PYG{p}{(}\PYG{n}{c}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{]} \PYG{o}{=} \PYG{n}{condition\PYGZus{}avg}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}  \PYG{c+c1}{\PYGZsh{} [time, neurons]}
        \PYG{n}{labels}\PYG{p}{[}\PYG{n}{c} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{:}\PYG{p}{(}\PYG{n}{c}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{n\PYGZus{}timepoints}\PYG{p}{]} \PYG{o}{=} \PYG{n}{c}
    
    \PYG{c+c1}{\PYGZsh{} Run t\PYGZhy{}SNE}
    \PYG{n}{tsne} \PYG{o}{=} \PYG{n}{TSNE}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}embedded} \PYG{o}{=} \PYG{n}{tsne}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}tsne}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot trajectories}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{colors} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{purple}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}conditions}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n}{labels} \PYG{o}{==} \PYG{n}{c}
        \PYG{n}{traj} \PYG{o}{=} \PYG{n}{X\PYGZus{}embedded}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{traj}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{traj}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} 
                 \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Condition }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Mark start and end points}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{traj}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{traj}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{traj}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{traj}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{s}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural Trajectories in t\PYGZhy{}SNE Space}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{neural\PYGZus{}trajectories.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} 5. Behavior prediction}
    
    \PYG{c+c1}{\PYGZsh{} Try to predict behavior from neural activity}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Ridge}
    
    \PYG{c+c1}{\PYGZsh{} Use average firing rates in the middle 200ms}
    \PYG{n}{mid\PYGZus{}start}\PYG{p}{,} \PYG{n}{mid\PYGZus{}end} \PYG{o}{=} \PYG{n}{n\PYGZus{}timepoints}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{n\PYGZus{}timepoints}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{l+m+mi}{100}
    \PYG{n}{X\PYGZus{}behavior} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{mid\PYGZus{}start}\PYG{p}{:}\PYG{n}{mid\PYGZus{}end}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [trials, neurons]}
    
    \PYG{c+c1}{\PYGZsh{} Split data}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}
        \PYG{n}{X\PYGZus{}behavior}\PYG{p}{,} \PYG{n}{behavior}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train ridge regression}
    \PYG{n}{regressor} \PYG{o}{=} \PYG{n}{Ridge}\PYG{p}{(}\PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{)}
    \PYG{n}{regressor}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Predict and evaluate}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{regressor}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{r2\PYGZus{}score}
    \PYG{n}{r2} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Behavior prediction R² score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot predictions vs actual}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Actual Behavior}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Predicted Behavior}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Neural Prediction of Behavior (R² = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{behavior\PYGZus{}prediction.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Return results}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n\PYGZus{}neurons}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n\PYGZus{}trials}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}trials}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n\PYGZus{}conditions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}conditions}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{decoding\PYGZus{}accuracy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{test\PYGZus{}score}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{behavior\PYGZus{}prediction\PYGZus{}r2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{r2}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{top\PYGZus{}neurons}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{top\PYGZus{}neurons}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pca\PYGZus{}explained\PYGZus{}variance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{explained\PYGZus{}variance\PYGZus{}ratio\PYGZus{}}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}


\section{21.7 Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AI techniques are transforming neural data analysis}, enabling the extraction of meaningful patterns from complex recordings of brain activity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Deep learning models make powerful decoders} that can predict behavior, perception, and cognitive states from neural activity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality reduction reveals low\sphinxhyphen{}dimensional neural manifolds} that capture the essential dynamics of neural population activity.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational simulations advance our understanding} of how neural circuits process information and generate behavior.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{AI\sphinxhyphen{}powered connectome reconstruction} is mapping the brain’s wiring diagram at multiple scales, from synapses to large\sphinxhyphen{}scale networks.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neuromorphic computing applies brain\sphinxhyphen{}inspired principles} to create more efficient and adaptive AI systems.

\end{itemize}


\section{21.8 Further Reading}
\label{\detokenize{part6/ch21_ai_for_neuro_discovery:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Richards, B.A., et al. (2019). \sphinxhref{https://www.nature.com/articles/s41593-019-0520-2}{A deep learning framework for neuroscience}. Nature Neuroscience, 22(11), 1761\sphinxhyphen{}1770.

\item {} 
\sphinxAtStartPar
Glaser, J.I., et al. (2020). \sphinxhref{https://eneuro.org/content/7/4/ENEURO.0506-19.2020}{Machine learning for neural decoding}. eNeuro, 7(4).

\item {} 
\sphinxAtStartPar
Pandarinath, C., et al. (2018). \sphinxhref{https://www.nature.com/articles/s41592-018-0109-9}{Inferring single\sphinxhyphen{}trial neural population dynamics using sequential auto\sphinxhyphen{}encoders}. Nature Methods, 15(10), 805\sphinxhyphen{}815.

\item {} 
\sphinxAtStartPar
Helmstaedter, M., et al. (2013). \sphinxhref{https://www.nature.com/articles/nature12346}{Connectomic reconstruction of the inner plexiform layer in the mouse retina}. Nature, 500(7461), 168\sphinxhyphen{}174.

\item {} 
\sphinxAtStartPar
Berman, G.J., et al. (2016). \sphinxhref{https://www.pnas.org/content/113/42/11943}{Predictability and hierarchy in Drosophila behavior}. PNAS, 113(42), 11943\sphinxhyphen{}11948.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 22: Embodied AI and Robotics}
\label{\detokenize{part6/ch22_embodied_ai_robotics:chapter-22-embodied-ai-and-robotics}}\label{\detokenize{part6/ch22_embodied_ai_robotics::doc}}

\section{22.0 Chapter Goals}
\label{\detokenize{part6/ch22_embodied_ai_robotics:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand how neuroscience principles inform embodied AI and robotics

\item {} 
\sphinxAtStartPar
Explore brain\sphinxhyphen{}inspired approaches to sensorimotor learning and control

\item {} 
\sphinxAtStartPar
Learn about predictive coding and internal models for robot control

\item {} 
\sphinxAtStartPar
Implement a basic neuro\sphinxhyphen{}inspired robot controller

\end{itemize}


\section{22.1 From Disembodied Algorithms to Grounded Intelligence}
\label{\detokenize{part6/ch22_embodied_ai_robotics:from-disembodied-algorithms-to-grounded-intelligence}}
\sphinxAtStartPar
Most AI systems today exist as disembodied algorithms, processing data without direct interaction with the physical world. In contrast, human and animal intelligence developed through embodied interaction with the environment. Robotics and embodied AI aim to bridge this gap by developing systems that learn through physical interaction.


\subsection{22.1.1 The Embodiment Hypothesis}
\label{\detokenize{part6/ch22_embodied_ai_robotics:the-embodiment-hypothesis}}
\sphinxAtStartPar
The embodiment hypothesis posits that intelligence requires a body \sphinxhyphen{} that cognition is shaped by the sensorimotor experiences that come from having a physical form interacting with the world:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{EmbodiedAgent}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensors}\PYG{p}{,} \PYG{n}{actuators}\PYG{p}{,} \PYG{n}{environment}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Basic embodied agent with sensors and actuators}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensors: Dictionary of sensor types and their properties}
\PYG{l+s+sd}{        \PYGZhy{} actuators: Dictionary of actuator types and their properties}
\PYG{l+s+sd}{        \PYGZhy{} environment: Environment the agent operates in}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensors} \PYG{o}{=} \PYG{n}{sensors}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{actuators} \PYG{o}{=} \PYG{n}{actuators}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{environment} \PYG{o}{=} \PYG{n}{environment}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{internal\PYGZus{}state} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sense}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Gather sensory information from environment\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{current\PYGZus{}sensory\PYGZus{}data} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{k}{for} \PYG{n}{sensor\PYGZus{}name}\PYG{p}{,} \PYG{n}{sensor} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensors}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Get raw sensory data from environment}
            \PYG{n}{raw\PYGZus{}data} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{environment}\PYG{o}{.}\PYG{n}{get\PYGZus{}sensor\PYGZus{}data}\PYG{p}{(}\PYG{n}{sensor}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Apply sensor\PYGZhy{}specific processing}
            \PYG{n}{processed\PYGZus{}data} \PYG{o}{=} \PYG{n}{sensor}\PYG{o}{.}\PYG{n}{process}\PYG{p}{(}\PYG{n}{raw\PYGZus{}data}\PYG{p}{)}
            \PYG{n}{current\PYGZus{}sensory\PYGZus{}data}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{processed\PYGZus{}data}
        
        \PYG{c+c1}{\PYGZsh{} Store in history}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}sensory\PYGZus{}data}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{current\PYGZus{}sensory\PYGZus{}data}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{act}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action\PYGZus{}commands}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Execute actions in the environment\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{k}{for} \PYG{n}{actuator\PYGZus{}name}\PYG{p}{,} \PYG{n}{command} \PYG{o+ow}{in} \PYG{n}{action\PYGZus{}commands}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{actuator\PYGZus{}name} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{actuators}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Execute command with the specified actuator}
                \PYG{n}{result} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{actuators}\PYG{p}{[}\PYG{n}{actuator\PYGZus{}name}\PYG{p}{]}\PYG{o}{.}\PYG{n}{execute}\PYG{p}{(}\PYG{n}{command}\PYG{p}{)}
                \PYG{n}{results}\PYG{p}{[}\PYG{n}{actuator\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{result}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{results}\PYG{p}{[}\PYG{n}{actuator\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error: Actuator not found}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Store in history}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{action\PYGZus{}commands}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{results}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}from\PYGZus{}interaction}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Learn from sensorimotor interaction history\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Not enough data for learning}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Analyze how actions led to sensory changes}
        \PYG{n}{lessons} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}history}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{+} \PYG{l+m+mi}{1} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Observe what sensory changes resulted from action}
                \PYG{n}{action} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}history}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{n}{state\PYGZus{}before} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{n}{state\PYGZus{}after} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sensor\PYGZus{}history}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Learn relationships between actions and sensory changes}
                \PYG{k}{for} \PYG{n}{actuator\PYGZus{}name}\PYG{p}{,} \PYG{n}{command} \PYG{o+ow}{in} \PYG{n}{action}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                    \PYG{k}{for} \PYG{n}{sensor\PYGZus{}name} \PYG{o+ow}{in} \PYG{n}{state\PYGZus{}before}\PYG{p}{:}
                        \PYG{c+c1}{\PYGZsh{} Calculate sensory difference}
                        \PYG{k}{if} \PYG{n}{sensor\PYGZus{}name} \PYG{o+ow}{in} \PYG{n}{state\PYGZus{}after}\PYG{p}{:}
                            \PYG{n}{diff} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{calculate\PYGZus{}difference}\PYG{p}{(}
                                \PYG{n}{state\PYGZus{}before}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}name}\PYG{p}{]}\PYG{p}{,}
                                \PYG{n}{state\PYGZus{}after}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}name}\PYG{p}{]}
                            \PYG{p}{)}
                            
                            \PYG{n}{lesson} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{(}\PYG{n}{actuator\PYGZus{}name}\PYG{p}{,} \PYG{n}{command}\PYG{p}{)}\PYG{p}{,}
                                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sensor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{sensor\PYGZus{}name}\PYG{p}{,}
                                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{effect}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{diff}
                            \PYG{p}{\PYGZcb{}}
                            \PYG{n}{lessons}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{lesson}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update internal models based on observed action\PYGZhy{}effect pairs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{update\PYGZus{}internal\PYGZus{}models}\PYG{p}{(}\PYG{n}{lessons}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{lessons}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}difference}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{before}\PYG{p}{,} \PYG{n}{after}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate difference between sensory states (simplified)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would be specialized based on sensor type}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{before}\PYG{p}{,} \PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{after}\PYG{p}{,} \PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{after} \PYG{o}{\PYGZhy{}} \PYG{n}{before}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Complex sensor type, difference calculation omitted}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}internal\PYGZus{}models}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{lessons}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Update internal models based on learning (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{lesson} \PYG{o+ow}{in} \PYG{n}{lessons}\PYG{p}{:}
            \PYG{n}{action\PYGZus{}key} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{lesson}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{lesson}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{n}{sensor\PYGZus{}key} \PYG{o}{=} \PYG{n}{lesson}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sensor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            \PYG{n}{effect} \PYG{o}{=} \PYG{n}{lesson}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{effect}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Simple aggregate model of effects}
            \PYG{n}{model\PYGZus{}key} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{action\PYGZus{}key}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sensor\PYGZus{}key}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
            \PYG{k}{if} \PYG{n}{model\PYGZus{}key} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{internal\PYGZus{}state}\PYG{p}{:}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{internal\PYGZus{}state}\PYG{p}{[}\PYG{n}{model\PYGZus{}key}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{internal\PYGZus{}state}\PYG{p}{[}\PYG{n}{model\PYGZus{}key}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{effect}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Key principles from the embodiment hypothesis include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensorimotor coupling}: Intelligence emerges from the dynamic interaction between sensing and action

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Environmental scaffolding}: The environment provides structure that simplifies learning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Body schema}: Internal models of the body’s capabilities shape cognitive development

\end{enumerate}


\subsection{22.1.2 Brain\sphinxhyphen{}Inspired Control Architectures}
\label{\detokenize{part6/ch22_embodied_ai_robotics:brain-inspired-control-architectures}}
\sphinxAtStartPar
Traditional robot control uses hierarchical architectures with clear separations between perception, planning, and action. Brain\sphinxhyphen{}inspired approaches favor more integrated architectures:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Reactive\sphinxhyphen{}Deliberative Hybrid}: Combines fast reactive behaviors with slower deliberative planning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Subsumption Architecture}: Layered behaviors where higher levels subsume lower levels

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Distributed Control}: Multiple specialized controllers coordinating without central executive

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SubsumptionController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Implementation of Brooks\PYGZsq{} subsumption architecture}
\PYG{l+s+sd}{        with layered behaviors}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{behaviors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Ordered from lowest to highest priority}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add\PYGZus{}behavior}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{behavior}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add a behavior at specified priority level\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{behaviors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{behavior}\PYG{p}{,} \PYG{n}{priority}\PYG{p}{)}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Sort behaviors by priority (highest value = highest priority)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{behaviors}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}\PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate action by evaluating behaviors in priority order}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensory\PYGZus{}input: Current sensory information}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} action: Selected action command}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Start with no action selected}
        \PYG{n}{selected\PYGZus{}action} \PYG{o}{=} \PYG{k+kc}{None}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate behaviors from lowest to highest priority}
        \PYG{k}{for} \PYG{n}{behavior}\PYG{p}{,} \PYG{n}{priority} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{behaviors}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Check if behavior is applicable}
            \PYG{k}{if} \PYG{n}{behavior}\PYG{o}{.}\PYG{n}{is\PYGZus{}applicable}\PYG{p}{(}\PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Get action from this behavior}
                \PYG{n}{action} \PYG{o}{=} \PYG{n}{behavior}\PYG{o}{.}\PYG{n}{compute\PYGZus{}action}\PYG{p}{(}\PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Higher priority behaviors override (subsume) lower ones}
                \PYG{k}{if} \PYG{n}{action} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                    \PYG{n}{selected\PYGZus{}action} \PYG{o}{=} \PYG{n}{action}
        
        \PYG{k}{return} \PYG{n}{selected\PYGZus{}action}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Behavior}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Base class for robot behaviors}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} name: Name of this behavior}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name} \PYG{o}{=} \PYG{n}{name}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{is\PYGZus{}applicable}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Check if this behavior applies to current situation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensory\PYGZus{}input: Current sensory information}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} applicable: Whether behavior is applicable}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Must be implemented by subclasses}
        \PYG{k}{raise} \PYG{n+ne}{NotImplementedError}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute action based on sensory input}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensory\PYGZus{}input: Current sensory information}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} action: Action command}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Must be implemented by subclasses}
        \PYG{k}{raise} \PYG{n+ne}{NotImplementedError}

\PYG{c+c1}{\PYGZsh{} Example behaviors}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ObstacleAvoidance}\PYG{p}{(}\PYG{n}{Behavior}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{safety\PYGZus{}distance}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Obstacle Avoidance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{safety\PYGZus{}distance} \PYG{o}{=} \PYG{n}{safety\PYGZus{}distance}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{is\PYGZus{}applicable}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Check if any obstacle is within safety distance}
        \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proximity}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{sensory\PYGZus{}input}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proximity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{safety\PYGZus{}distance}
        \PYG{k}{return} \PYG{k+kc}{False}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Find direction with most clearance}
        \PYG{n}{proximity\PYGZus{}sensors} \PYG{o}{=} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proximity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{safest\PYGZus{}direction} \PYG{o}{=} \PYG{n}{proximity\PYGZus{}sensors}\PYG{o}{.}\PYG{n}{index}\PYG{p}{(}\PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{proximity\PYGZus{}sensors}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{turn\PYGZus{}amount} \PYG{o}{=} \PYG{p}{(}\PYG{n}{safest\PYGZus{}direction} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{proximity\PYGZus{}sensors}\PYG{p}{)}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} \PYGZhy{}1 to 1}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear\PYGZus{}velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Slow down near obstacles}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{angular\PYGZus{}velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{turn\PYGZus{}amount}  \PYG{c+c1}{\PYGZsh{} Turn away from obstacle}
        \PYG{p}{\PYGZcb{}}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{GoalSeeking}\PYG{p}{(}\PYG{n}{Behavior}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{goal\PYGZus{}position}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Goal Seeking}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal\PYGZus{}position} \PYG{o}{=} \PYG{n}{goal\PYGZus{}position}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{is\PYGZus{}applicable}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Always applicable if we have position data}
        \PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{sensory\PYGZus{}input}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate vector to goal}
        \PYG{n}{current\PYGZus{}pos} \PYG{o}{=} \PYG{n}{sensory\PYGZus{}input}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{goal\PYGZus{}vector} \PYG{o}{=} \PYG{p}{[}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal\PYGZus{}position}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{current\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal\PYGZus{}position}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{current\PYGZus{}pos}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Calculate heading to goal}
        \PYG{n}{current\PYGZus{}heading} \PYG{o}{=} \PYG{n}{sensory\PYGZus{}input}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{heading}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{goal\PYGZus{}heading} \PYG{o}{=} \PYG{n}{math}\PYG{o}{.}\PYG{n}{atan2}\PYG{p}{(}\PYG{n}{goal\PYGZus{}vector}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{goal\PYGZus{}vector}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{heading\PYGZus{}error} \PYG{o}{=} \PYG{n}{goal\PYGZus{}heading} \PYG{o}{\PYGZhy{}} \PYG{n}{current\PYGZus{}heading}
        
        \PYG{c+c1}{\PYGZsh{} Normalize to \PYGZhy{}pi to pi}
        \PYG{n}{heading\PYGZus{}error} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{heading\PYGZus{}error} \PYG{o}{+} \PYG{n}{math}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{math}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{math}\PYG{o}{.}\PYG{n}{pi}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{linear\PYGZus{}velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Move forward}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{angular\PYGZus{}velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{heading\PYGZus{}error} \PYG{o}{*} \PYG{l+m+mf}{0.5}  \PYG{c+c1}{\PYGZsh{} Turn toward goal}
        \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\section{22.2 Neuroscience\sphinxhyphen{}Inspired Sensorimotor Control}
\label{\detokenize{part6/ch22_embodied_ai_robotics:neuroscience-inspired-sensorimotor-control}}
\sphinxAtStartPar
The brain’s motor control systems offer valuable inspiration for robotic control.


\subsection{22.2.1 Motor Primitives and Synergies}
\label{\detokenize{part6/ch22_embodied_ai_robotics:motor-primitives-and-synergies}}
\sphinxAtStartPar
Rather than controlling individual motor units separately, the brain organizes movement around motor primitives \sphinxhyphen{} coordinated patterns of muscle activation that can be combined to produce complex behaviors:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MotorPrimitiveController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}primitives}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}actuators}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Controller based on motor primitives/synergies}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}primitives: Number of motor primitives}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}actuators: Number of actuators/motors to control}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize random primitive patterns}
        \PYG{c+c1}{\PYGZsh{} In real applications, these would be learned or designed}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}primitives}\PYG{p}{,} \PYG{n}{n\PYGZus{}actuators}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalize primitives}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}primitives}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives} \PYG{o}{=} \PYG{n}{n\PYGZus{}primitives}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}actuators} \PYG{o}{=} \PYG{n}{n\PYGZus{}actuators}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}movement}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{primitive\PYGZus{}weights}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate actuator commands by combining primitives}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} primitive\PYGZus{}weights: Weights for each primitive}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} actuator\PYGZus{}commands: Commands for each actuator}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{primitive\PYGZus{}weights}\PYG{p}{)} \PYG{o}{!=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Expected }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ weights, got }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{primitive\PYGZus{}weights}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine primitives using weights}
        \PYG{n}{actuator\PYGZus{}commands} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}actuators}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{weight} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{primitive\PYGZus{}weights}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{actuator\PYGZus{}commands} \PYG{o}{+}\PYG{o}{=} \PYG{n}{weight} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{actuator\PYGZus{}commands}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}new\PYGZus{}primitive}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sample\PYGZus{}movements}\PYG{p}{,} \PYG{n}{n\PYGZus{}iterations}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Learn a new motor primitive from example movements}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sample\PYGZus{}movements: Array of sample actuator commands}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}iterations: Number of learning iterations}
\PYG{l+s+sd}{        \PYGZhy{} learning\PYGZus{}rate: Learning rate for updates}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} new\PYGZus{}primitive: The newly learned primitive}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize new primitive randomly}
        \PYG{n}{new\PYGZus{}primitive} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}actuators}\PYG{p}{)}
        \PYG{n}{new\PYGZus{}primitive} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{new\PYGZus{}primitive}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Learn through dimensionality reduction (simplified)}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{movement} \PYG{o+ow}{in} \PYG{n}{sample\PYGZus{}movements}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Project movement onto current primitive}
                \PYG{n}{projection} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{movement}\PYG{p}{,} \PYG{n}{new\PYGZus{}primitive}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Reconstruction error}
                \PYG{n}{error} \PYG{o}{=} \PYG{n}{movement} \PYG{o}{\PYGZhy{}} \PYG{n}{projection} \PYG{o}{*} \PYG{n}{new\PYGZus{}primitive}
                
                \PYG{c+c1}{\PYGZsh{} Update primitive to reduce error}
                \PYG{n}{gradient} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{error}\PYG{p}{,} \PYG{n}{movement}\PYG{p}{)}
                \PYG{n}{new\PYGZus{}primitive} \PYG{o}{+}\PYG{o}{=} \PYG{n}{gradient}
                
                \PYG{c+c1}{\PYGZsh{} Normalize}
                \PYG{n}{new\PYGZus{}primitive} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{new\PYGZus{}primitive}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add to primitive set}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{,} \PYG{n}{new\PYGZus{}primitive}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
        
        \PYG{k}{return} \PYG{n}{new\PYGZus{}primitive}
\end{sphinxVerbatim}

\sphinxAtStartPar
This approach offers several advantages:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dimensionality reduction}: Control complexity is reduced from many actuators to fewer primitives

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generalization}: New movements can be generated by recombining existing primitives

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Robustness}: Primitive\sphinxhyphen{}based control is less sensitive to individual actuator failures

\end{enumerate}


\subsection{22.2.2 Predictive Coding and Forward Models}
\label{\detokenize{part6/ch22_embodied_ai_robotics:predictive-coding-and-forward-models}}
\sphinxAtStartPar
The brain uses predictive coding to anticipate the sensory consequences of actions. Similar predictive mechanisms can vastly improve robot control:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{PredictiveController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Controller implementing predictive coding principles}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}inputs: Dimension of input (sensory) space}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}outputs: Dimension of output (motor) space}
\PYG{l+s+sd}{        \PYGZhy{} learning\PYGZus{}rate: Learning rate for model updates}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initialize forward model (predicts sensory consequences of actions)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}outputs}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize inverse model (maps desired sensory states to actions)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}inverse} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}inputs}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}sensory\PYGZus{}outcome}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict sensory outcome of an action}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} action: Motor command}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} predicted\PYGZus{}sensation: Predicted sensory feedback}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{current\PYGZus{}sensation}\PYG{p}{,} \PYG{n}{target\PYGZus{}sensation}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate action to achieve target sensory state}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} current\PYGZus{}sensation: Current sensory state}
\PYG{l+s+sd}{        \PYGZhy{} target\PYGZus{}sensation: Desired sensory state}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} action: Motor command}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Calculate sensory prediction error}
        \PYG{n}{error} \PYG{o}{=} \PYG{n}{target\PYGZus{}sensation} \PYG{o}{\PYGZhy{}} \PYG{n}{current\PYGZus{}sensation}
        
        \PYG{c+c1}{\PYGZsh{} Use inverse model to generate action}
        \PYG{n}{action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}inverse}\PYG{p}{,} \PYG{n}{error}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{action}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}models}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{predicted\PYGZus{}sensation}\PYG{p}{,} \PYG{n}{actual\PYGZus{}sensation}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update forward and inverse models based on prediction error}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} action: Motor command that was executed}
\PYG{l+s+sd}{        \PYGZhy{} predicted\PYGZus{}sensation: Sensation that was predicted}
\PYG{l+s+sd}{        \PYGZhy{} actual\PYGZus{}sensation: Sensation that was actually experienced}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} prediction\PYGZus{}error: Magnitude of prediction error}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Calculate prediction error}
        \PYG{n}{prediction\PYGZus{}error} \PYG{o}{=} \PYG{n}{actual\PYGZus{}sensation} \PYG{o}{\PYGZhy{}} \PYG{n}{predicted\PYGZus{}sensation}
        \PYG{n}{error\PYGZus{}magnitude} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{error\PYGZus{}magnitude}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update forward model}
        \PYG{n}{update} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{,} \PYG{n}{action}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{+}\PYG{o}{=} \PYG{n}{update}
        
        \PYG{c+c1}{\PYGZsh{} Update inverse model}
        \PYG{n}{update} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{action}\PYG{p}{,} \PYG{n}{prediction\PYGZus{}error}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}inverse} \PYG{o}{+}\PYG{o}{=} \PYG{n}{update}
        
        \PYG{k}{return} \PYG{n}{error\PYGZus{}magnitude}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learning\PYGZus{}curve}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot learning curve of prediction errors\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predictive Model Learning Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
Forward models enable critical capabilities:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sensory cancellation}: Distinguishing external stimuli from self\sphinxhyphen{}generated sensations

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Closed\sphinxhyphen{}loop control}: Compensating for discrepancies between predicted and actual outcomes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Mental simulation}: Planning actions by simulating their outcomes before execution

\end{enumerate}


\subsection{22.2.3 Cerebellar\sphinxhyphen{}Inspired Adaptive Control}
\label{\detokenize{part6/ch22_embodied_ai_robotics:cerebellar-inspired-adaptive-control}}
\sphinxAtStartPar
The cerebellum is critical for motor learning and coordination. Cerebellar\sphinxhyphen{}inspired control models can enable robots to adapt to changing dynamics:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CerebellarAdaptiveController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}inputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}granule\PYGZus{}cells}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Cerebellar\PYGZhy{}inspired adaptive controller}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}inputs: Number of mossy fiber inputs (sensory state variables)}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}outputs: Number of outputs (motor commands)}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}granule\PYGZus{}cells: Number of granule cells for sparse expansion}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}inputs} \PYG{o}{=} \PYG{n}{n\PYGZus{}inputs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}outputs} \PYG{o}{=} \PYG{n}{n\PYGZus{}outputs}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}granule\PYGZus{}cells} \PYG{o}{=} \PYG{n}{n\PYGZus{}granule\PYGZus{}cells}
        
        \PYG{c+c1}{\PYGZsh{} Connectivity from mossy fibers to granule cells (random projection)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}mossy\PYGZus{}granule} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}granule\PYGZus{}cells}\PYG{p}{,} \PYG{n}{n\PYGZus{}inputs}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Weights from granule cells to Purkinje cells (learnable)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}granule\PYGZus{}purkinje} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{n\PYGZus{}granule\PYGZus{}cells}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Learning rate for parallel fiber\PYGZhy{}Purkinje cell synapses}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mf}{0.01}
        
        \PYG{c+c1}{\PYGZsh{} History of corrections}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correction\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{granule\PYGZus{}cell\PYGZus{}activity}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{mossy\PYGZus{}input}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Calculate granule cell activity from mossy fiber input}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} mossy\PYGZus{}input: Input from mossy fibers (sensory state)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} granule\PYGZus{}activity: Activity of granule cells}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Perform sparse expansion}
        \PYG{n}{raw\PYGZus{}activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}mossy\PYGZus{}granule}\PYG{p}{,} \PYG{n}{mossy\PYGZus{}input}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} ReLU activation}
        \PYG{n}{activity} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{maximum}\PYG{p}{(}\PYG{n}{raw\PYGZus{}activity}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalization and sparsification (approximate k\PYGZhy{}winners\PYGZhy{}take\PYGZhy{}all)}
        \PYG{n}{k} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}granule\PYGZus{}cells} \PYG{o}{*} \PYG{l+m+mf}{0.05}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 5\PYGZpc{} activity}
        \PYG{n}{threshold} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}\PYG{n}{activity}\PYG{p}{)}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{k}\PYG{p}{]} \PYG{k}{if} \PYG{n}{k} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mi}{0}
        \PYG{n}{activity}\PYG{p}{[}\PYG{n}{activity} \PYG{o}{\PYGZlt{}} \PYG{n}{threshold}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{return} \PYG{n}{activity}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}correction}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute corrective signal for feedforward control}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} state: Current sensory state}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} correction: Corrective motor command}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Expand input through granule cells}
        \PYG{n}{granule\PYGZus{}activity} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{granule\PYGZus{}cell\PYGZus{}activity}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute cerebellar correction}
        \PYG{n}{correction} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}granule\PYGZus{}purkinje}\PYG{p}{,} \PYG{n}{granule\PYGZus{}activity}\PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correction\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{correction}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{correction}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}from\PYGZus{}error}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{state}\PYG{p}{,} \PYG{n}{error}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Learn from motor error (climbing fiber input)}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} state: Sensory state during error}
\PYG{l+s+sd}{        \PYGZhy{} error: Motor error/climbing fiber signal}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get granule cell activity for this state}
        \PYG{n}{granule\PYGZus{}activity} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{granule\PYGZus{}cell\PYGZus{}activity}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update weights according to correlation of granule activity with error}
        \PYG{c+c1}{\PYGZsh{} This follows the cerebellum\PYGZsq{}s supervised learning rule}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}outputs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{delta\PYGZus{}w} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{error}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{*} \PYG{n}{granule\PYGZus{}activity}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}granule\PYGZus{}purkinje}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{delta\PYGZus{}w}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}learning}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot correction magnitude over time\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{correction\PYGZus{}history}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Trial}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Correction Magnitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cerebellar Adaptation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{plt}
\end{sphinxVerbatim}

\sphinxAtStartPar
The cerebellum’s architecture enables specific computational features:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Sparse coding}: Granule cells expand the input space while maintaining sparse activity

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Supervised learning}: Climbing fiber error signals guide synaptic weight updates

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Timing mechanisms}: Precise timing of movements through internal timing circuitry

\end{enumerate}


\section{22.3 Affordances and Action\sphinxhyphen{}Centered Perception}
\label{\detokenize{part6/ch22_embodied_ai_robotics:affordances-and-action-centered-perception}}
\sphinxAtStartPar
The concept of affordances, introduced by psychologist J.J. Gibson, refers to the action possibilities that objects or environments offer. This ecological approach to perception has influenced embodied AI:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AffordanceDetector}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        System to detect action affordances in visual scenes}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{affordance\PYGZus{}types} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{graspable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{convexity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.7}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pushable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flat\PYGZus{}side}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{liftable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight\PYGZus{}est}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sittable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{horizontal\PYGZus{}surface}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Tracks learned affordance\PYGZhy{}action associations}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{detect\PYGZus{}affordances}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{objects}\PYG{p}{,} \PYG{n}{robot\PYGZus{}capabilities}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Detect affordances of objects based on their properties}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} objects: List of objects with properties}
\PYG{l+s+sd}{        \PYGZhy{} robot\PYGZus{}capabilities: Dict of robot capabilities and limitations}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} affordances: Dict mapping objects to their affordances}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{affordances} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{k}{for} \PYG{n}{obj} \PYG{o+ow}{in} \PYG{n}{objects}\PYG{p}{:}
            \PYG{n}{obj\PYGZus{}affordances} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            
            \PYG{k}{for} \PYG{n}{affordance\PYGZus{}name}\PYG{p}{,} \PYG{n}{requirements} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{affordance\PYGZus{}types}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Check if object meets requirements for this affordance}
                \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{True}
                
                \PYG{k}{for} \PYG{n}{req\PYGZus{}name}\PYG{p}{,} \PYG{n}{req\PYGZus{}value} \PYG{o+ow}{in} \PYG{n}{requirements}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                    \PYG{k}{if} \PYG{n}{req\PYGZus{}name} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{obj}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                        \PYG{k}{break}
                    
                    \PYG{k}{if} \PYG{n}{req\PYGZus{}name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{min\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{and} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{req\PYGZus{}value}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                        \PYG{k}{break}
                    \PYG{k}{elif} \PYG{n}{req\PYGZus{}name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}size}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{and} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{n}{req\PYGZus{}value}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                        \PYG{k}{break}
                    \PYG{k}{elif} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{req\PYGZus{}value}\PYG{p}{,} \PYG{n+nb}{bool}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{obj}\PYG{p}{[}\PYG{n}{req\PYGZus{}name}\PYG{p}{]} \PYG{o}{!=} \PYG{n}{req\PYGZus{}value}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                        \PYG{k}{break}
                
                \PYG{c+c1}{\PYGZsh{} Check if robot can execute the affordance}
                \PYG{k}{if} \PYG{n}{qualifies}\PYG{p}{:}
                    \PYG{k}{if} \PYG{n}{affordance\PYGZus{}name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{liftable}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{and} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight\PYGZus{}est}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{robot\PYGZus{}capabilities}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}lift}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                    
                    \PYG{k}{if} \PYG{n}{affordance\PYGZus{}name} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{graspable}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{and} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{robot\PYGZus{}capabilities}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{max\PYGZus{}grasp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
                        \PYG{n}{qualifies} \PYG{o}{=} \PYG{k+kc}{False}
                
                \PYG{k}{if} \PYG{n}{qualifies}\PYG{p}{:}
                    \PYG{n}{obj\PYGZus{}affordances}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{affordance\PYGZus{}name}\PYG{p}{)}
            
            \PYG{n}{affordances}\PYG{p}{[}\PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{n}{obj\PYGZus{}affordances}
        
        \PYG{k}{return} \PYG{n}{affordances}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{affordance\PYGZus{}to\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{,} \PYG{n}{affordance}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Convert an affordance to specific action parameters}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} obj: Object with the affordance}
\PYG{l+s+sd}{        \PYGZhy{} affordance: Affordance type}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} action: Action parameters}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{affordance} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{graspable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Determine grasp parameters based on object properties}
            \PYG{n}{width} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{obj}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.08}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Max gripper width}
            \PYG{n}{height} \PYG{o}{=} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{height}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Grasp in the middle}
            
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grasp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{approach\PYGZus{}vector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Approach from above}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gripper\PYGZus{}width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{width}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grasp\PYGZus{}height}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{height}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{elif} \PYG{n}{affordance} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pushable}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Determine pushing parameters}
            \PYG{n}{push\PYGZus{}dir} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Default push direction}
            \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{preferred\PYGZus{}push\PYGZus{}dir}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{obj}\PYG{p}{:}
                \PYG{n}{push\PYGZus{}dir} \PYG{o}{=} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{preferred\PYGZus{}push\PYGZus{}dir}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
                
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{push}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{push\PYGZus{}direction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{push\PYGZus{}dir}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{push\PYGZus{}distance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}
            \PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Other affordances would have their own action mappings}
        
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}from\PYGZus{}experience}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{,} \PYG{n}{affordance}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{success}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update affordance models from action experience}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} obj: Object that was acted upon}
\PYG{l+s+sd}{        \PYGZhy{} affordance: Affordance that was utilized}
\PYG{l+s+sd}{        \PYGZhy{} action: Action that was performed}
\PYG{l+s+sd}{        \PYGZhy{} success: Whether the action was successful}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{obj\PYGZus{}id} \PYG{o}{=} \PYG{n}{obj}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Initialize history for this object if needed}
        \PYG{k}{if} \PYG{n}{obj\PYGZus{}id} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{[}\PYG{n}{obj\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Initialize history for this affordance if needed}
        \PYG{k}{if} \PYG{n}{affordance} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{[}\PYG{n}{obj\PYGZus{}id}\PYG{p}{]}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{[}\PYG{n}{obj\PYGZus{}id}\PYG{p}{]}\PYG{p}{[}\PYG{n}{affordance}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Record success/failure}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{[}\PYG{n}{obj\PYGZus{}id}\PYG{p}{]}\PYG{p}{[}\PYG{n}{affordance}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{action}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{success}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{success}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{object\PYGZus{}state}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update affordance requirements based on experience}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}success\PYGZus{}history}\PYG{p}{[}\PYG{n}{obj\PYGZus{}id}\PYG{p}{]}\PYG{p}{[}\PYG{n}{affordance}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{5}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}refine\PYGZus{}affordance\PYGZus{}model}\PYG{p}{(}\PYG{n}{affordance}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}refine\PYGZus{}affordance\PYGZus{}model}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{affordance}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Refine affordance model based on action history (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would analyze success/failure patterns to refine affordance detection}
        \PYG{c+c1}{\PYGZsh{} For example, adjusting size thresholds, weight limits, etc.}
        \PYG{k}{pass}
\end{sphinxVerbatim}

\sphinxAtStartPar
Affordance\sphinxhyphen{}based approaches offer several benefits:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Bridging perception and action}: Direct mapping from perceptual features to action possibilities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Efficiency}: Focus on action\sphinxhyphen{}relevant properties rather than full scene understanding

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Transfer learning}: Affordances can generalize across objects with similar action\sphinxhyphen{}relevant properties

\end{enumerate}


\section{22.4 Human\sphinxhyphen{}Robot Collaboration and Social Robotics}
\label{\detokenize{part6/ch22_embodied_ai_robotics:human-robot-collaboration-and-social-robotics}}
\sphinxAtStartPar
Robots increasingly need to collaborate with humans, requiring social capabilities inspired by neuroscience research on social cognition.


\subsection{22.4.1 Shared Control and Collaborative Tasks}
\label{\detokenize{part6/ch22_embodied_ai_robotics:shared-control-and-collaborative-tasks}}
\sphinxAtStartPar
Effective human\sphinxhyphen{}robot collaboration requires shared understanding of tasks and goals:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{CollaborativeRobot}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Robot system designed for human collaboration}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Task models \PYGZhy{} structured representations of collaborative tasks}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}models} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Joint attention system}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention\PYGZus{}system} \PYG{o}{=} \PYG{n}{JointAttentionSystem}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Intent prediction model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{intent\PYGZus{}predictor} \PYG{o}{=} \PYG{n}{IntentPredictor}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Adaptive action system}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}planner} \PYG{o}{=} \PYG{n}{AdaptiveActionPlanner}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Communication module}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{communicator} \PYG{o}{=} \PYG{n}{FeedbackCommunicator}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{observe\PYGZus{}human}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{human\PYGZus{}state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process observations of human collaborator}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} human\PYGZus{}state: Dict with human pose, gaze, actions, etc.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} processed\PYGZus{}state: Processed human state information}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Track human attention}
        \PYG{n}{attended\PYGZus{}location} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{attention\PYGZus{}system}\PYG{o}{.}\PYG{n}{infer\PYGZus{}attention}\PYG{p}{(}
            \PYG{n}{human\PYGZus{}state}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{head\PYGZus{}pose}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{human\PYGZus{}state}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gaze\PYGZus{}direction}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Predict human intent}
        \PYG{n}{intent} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{intent\PYGZus{}predictor}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}
            \PYG{n}{human\PYGZus{}state}\PYG{p}{,}
            \PYG{n}{history}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{intent\PYGZus{}predictor}\PYG{o}{.}\PYG{n}{history}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update internal state}
        \PYG{n}{processed\PYGZus{}state} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{attention}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{attended\PYGZus{}location}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{intent}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{intent}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{human\PYGZus{}state}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pose}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{human\PYGZus{}state}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pose}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{return} \PYG{n}{processed\PYGZus{}state}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}complementary\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{human\PYGZus{}state}\PYG{p}{,} \PYG{n}{task\PYGZus{}context}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate action that complements human\PYGZsq{}s activity}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} human\PYGZus{}state: Processed human state}
\PYG{l+s+sd}{        \PYGZhy{} task\PYGZus{}context: Current task context}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} action: Action parameters}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Select active task model}
        \PYG{n}{task\PYGZus{}model} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}models}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{task\PYGZus{}context}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{task\PYGZus{}id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{task\PYGZus{}model}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{idle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} Determine role allocation}
        \PYG{n}{human\PYGZus{}subtask} \PYG{o}{=} \PYG{n}{human\PYGZus{}state}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{intent}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{subtask}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Find complementary subtask}
        \PYG{n}{robot\PYGZus{}subtask} \PYG{o}{=} \PYG{n}{task\PYGZus{}model}\PYG{o}{.}\PYG{n}{get\PYGZus{}complementary\PYGZus{}subtask}\PYG{p}{(}\PYG{n}{human\PYGZus{}subtask}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plan action for this subtask}
        \PYG{n}{action} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}planner}\PYG{o}{.}\PYG{n}{plan}\PYG{p}{(}
            \PYG{n}{robot\PYGZus{}subtask}\PYG{p}{,}
            \PYG{n}{human\PYGZus{}state}\PYG{p}{,}
            \PYG{n}{task\PYGZus{}context}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate appropriate feedback}
        \PYG{n}{feedback} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{communicator}\PYG{o}{.}\PYG{n}{generate\PYGZus{}feedback}\PYG{p}{(}
            \PYG{n}{action}\PYG{p}{,}
            \PYG{n}{human\PYGZus{}state}\PYG{p}{,}
            \PYG{n}{task\PYGZus{}context}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine action and feedback}
        \PYG{n}{action}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{feedback}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{feedback}
        
        \PYG{k}{return} \PYG{n}{action}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}from\PYGZus{}demonstration}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{demonstration\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Learn new task model from human demonstration}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} demonstration\PYGZus{}data: Recorded human demonstration}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} task\PYGZus{}id: ID of the learned task}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Extract task structure}
        \PYG{n}{task\PYGZus{}id} \PYG{o}{=} \PYG{n}{demonstration\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{task\PYGZus{}id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{n}{task\PYGZus{}steps} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{step} \PYG{o+ow}{in} \PYG{n}{demonstration\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{steps}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Analyze step components}
            \PYG{n}{step\PYGZus{}model} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{objects}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{step}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{objects}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{actions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{step}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{actions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{preconditions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}infer\PYGZus{}preconditions}\PYG{p}{(}\PYG{n}{step}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{effects}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}infer\PYGZus{}effects}\PYG{p}{(}\PYG{n}{step}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{constraints}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}infer\PYGZus{}constraints}\PYG{p}{(}\PYG{n}{step}\PYG{p}{)}
            \PYG{p}{\PYGZcb{}}
            \PYG{n}{task\PYGZus{}steps}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{step\PYGZus{}model}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create new task model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}models}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{TaskModel}\PYG{p}{(}
            \PYG{n}{task\PYGZus{}id}\PYG{o}{=}\PYG{n}{task\PYGZus{}id}\PYG{p}{,}
            \PYG{n}{steps}\PYG{o}{=}\PYG{n}{task\PYGZus{}steps}\PYG{p}{,}
            \PYG{n}{objects}\PYG{o}{=}\PYG{n}{demonstration\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{objects}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{goal}\PYG{o}{=}\PYG{n}{demonstration\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{goal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{task\PYGZus{}id}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}infer\PYGZus{}preconditions}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{step\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Infer preconditions from step data (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would analyze state before the step}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{placeholder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{preconditions}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}infer\PYGZus{}effects}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{step\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Infer effects from step data (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would analyze state changes after the step}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{placeholder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{effects}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}infer\PYGZus{}constraints}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{step\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Infer constraints from step data (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would identify constraints on execution}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{placeholder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{constraints}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} Placeholder supporting classes}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{JointAttentionSystem}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{infer\PYGZus{}attention}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{head\PYGZus{}pose}\PYG{p}{,} \PYG{n}{gaze\PYGZus{}direction}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Infer where human is attending based on head pose and gaze\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{gaze\PYGZus{}direction}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{None}
        
        \PYG{c+c1}{\PYGZsh{} Simple projection of gaze ray}
        \PYG{n}{attention\PYGZus{}point} \PYG{o}{=} \PYG{p}{[}
            \PYG{n}{head\PYGZus{}pose}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{gaze\PYGZus{}direction}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{,}
            \PYG{n}{head\PYGZus{}pose}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{gaze\PYGZus{}direction}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{,}
            \PYG{n}{head\PYGZus{}pose}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{+} \PYG{n}{gaze\PYGZus{}direction}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{2}
        \PYG{p}{]}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{attention\PYGZus{}point}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{attention\PYGZus{}point}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{IntentPredictor}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{human\PYGZus{}state}\PYG{p}{,} \PYG{n}{history}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Predict human intent from state and history\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{subtask}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{unknown}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{confidence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{\PYGZcb{}}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{AdaptiveActionPlanner}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plan}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{subtask}\PYG{p}{,} \PYG{n}{human\PYGZus{}state}\PYG{p}{,} \PYG{n}{task\PYGZus{}context}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plan action for a subtask considering human state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{subtask}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{parameters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZcb{}}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{FeedbackCommunicator}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}feedback}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{action}\PYG{p}{,} \PYG{n}{human\PYGZus{}state}\PYG{p}{,} \PYG{n}{task\PYGZus{}context}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate appropriate feedback for current action\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visual\PYGZus{}cue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{message}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Robot is helping}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TaskModel}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{,} \PYG{n}{objects}\PYG{p}{,} \PYG{n}{goal}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}id} \PYG{o}{=} \PYG{n}{task\PYGZus{}id}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{steps} \PYG{o}{=} \PYG{n}{steps}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{objects} \PYG{o}{=} \PYG{n}{objects}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{goal} \PYG{o}{=} \PYG{n}{goal}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}complementary\PYGZus{}subtask}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{human\PYGZus{}subtask}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Find complementary subtask to what human is doing\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Placeholder implementation}
        \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{support\PYGZus{}human}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
Social cues and signals play a critical role in collaboration:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Joint attention}: The ability to share attention on the same object or location

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Action prediction}: Anticipating the partner’s next move to coordinate effectively

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Adaptive behavior}: Adjusting plans and actions based on the partner’s state

\end{enumerate}


\subsection{22.4.2 Learning from Demonstration}
\label{\detokenize{part6/ch22_embodied_ai_robotics:learning-from-demonstration}}
\sphinxAtStartPar
Robots can learn by observing human demonstrations, leveraging neural mechanisms for imitation learning:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{mixture}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{GaussianMixture}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{LearningFromDemonstration}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        System for learning actions from human demonstrations}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}models} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{context\PYGZus{}classifier} \PYG{o}{=} \PYG{k+kc}{None}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{process\PYGZus{}demonstrations}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{demonstrations}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Process multiple demonstrations of the same task}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} demonstrations: List of demonstration trajectories}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} model\PYGZus{}id: ID of the learned action model}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Extract context features for all demonstrations}
        \PYG{n}{contexts} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}extract\PYGZus{}context}\PYG{p}{(}\PYG{n}{demo}\PYG{p}{)} \PYG{k}{for} \PYG{n}{demo} \PYG{o+ow}{in} \PYG{n}{demonstrations}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Extract trajectories for all demonstrations}
        \PYG{n}{trajectories} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}extract\PYGZus{}trajectory}\PYG{p}{(}\PYG{n}{demo}\PYG{p}{)} \PYG{k}{for} \PYG{n}{demo} \PYG{o+ow}{in} \PYG{n}{demonstrations}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Train context classifier}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}train\PYGZus{}context\PYGZus{}classifier}\PYG{p}{(}\PYG{n}{contexts}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Learn action model from trajectories}
        \PYG{n}{model\PYGZus{}id} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action\PYGZus{}model\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}models}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{c+c1}{\PYGZsh{} Use probabilistic model to represent demonstrated actions}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}models}\PYG{p}{[}\PYG{n}{model\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}train\PYGZus{}action\PYGZus{}model}\PYG{p}{(}\PYG{n}{trajectories}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{model\PYGZus{}id}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}action}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{context}\PYG{p}{,} \PYG{n}{start\PYGZus{}state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate action trajectory for given context}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} context: Current context features}
\PYG{l+s+sd}{        \PYGZhy{} start\PYGZus{}state: Starting state for action generation}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} trajectory: Generated action trajectory}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Classify context to find most relevant action model}
        \PYG{n}{model\PYGZus{}id} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}classify\PYGZus{}context}\PYG{p}{(}\PYG{n}{context}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{model\PYGZus{}id} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}models}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{None}
        
        \PYG{c+c1}{\PYGZsh{} Use action model to generate trajectory}
        \PYG{n}{model} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{action\PYGZus{}models}\PYG{p}{[}\PYG{n}{model\PYGZus{}id}\PYG{p}{]}
        \PYG{n}{trajectory} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}generate\PYGZus{}from\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{start\PYGZus{}state}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{trajectory}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}extract\PYGZus{}context}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{demonstration}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Extract context features from demonstration (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would extract relevant context features}
        \PYG{c+c1}{\PYGZsh{} such as object positions, relationships, etc.}
        \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{context}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{demonstration}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{demonstration}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{context}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}extract\PYGZus{}trajectory}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{demonstration}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Extract normalized trajectory from demonstration\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Get raw trajectory points}
        \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trajectory}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{demonstration}\PYG{p}{:}
            \PYG{n}{traj} \PYG{o}{=} \PYG{n}{demonstration}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trajectory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Normalize time}
            \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{point}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{point} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{traj}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{t} \PYG{o}{=} \PYG{p}{(}\PYG{n}{t} \PYG{o}{\PYGZhy{}} \PYG{n}{t}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{t}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{t}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Extract state variables}
            \PYG{n}{positions} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{point}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{point} \PYG{o+ow}{in} \PYG{n}{traj}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{velocities} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{point}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{point} \PYG{o+ow}{in} \PYG{n}{traj}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Combine into state\PYGZhy{}time pairs}
            \PYG{n}{trajectory} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{positions}\PYG{p}{,} \PYG{n}{velocities}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{trajectory}
        
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}train\PYGZus{}context\PYGZus{}classifier}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{contexts}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train classifier to map contexts to action models (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would train a classifier to map context features}
        \PYG{c+c1}{\PYGZsh{} to appropriate action models}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{context\PYGZus{}classifier} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{placeholder}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{classifier}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}train\PYGZus{}action\PYGZus{}model}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{trajectories}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train probabilistic model from demonstrated trajectories\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Combine all trajectories}
        \PYG{n}{all\PYGZus{}points} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{n}{trajectories}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Fit GMM to capture distribution of states over time}
        \PYG{n}{n\PYGZus{}components} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{all\PYGZus{}points}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Heuristic}
        \PYG{n}{gmm} \PYG{o}{=} \PYG{n}{GaussianMixture}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{n}{n\PYGZus{}components}\PYG{p}{)}
        \PYG{n}{gmm}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{all\PYGZus{}points}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create dynamic model (placeholder)}
        \PYG{n}{model} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{gmm}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trajectories}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{trajectories}
        \PYG{p}{\PYGZcb{}}
        
        \PYG{k}{return} \PYG{n}{model}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}classify\PYGZus{}context}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{context}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Classify context to select action model (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would use the context classifier to select}
        \PYG{c+c1}{\PYGZsh{} the most appropriate action model}
        \PYG{k}{return} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{action\PYGZus{}model\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}  \PYG{c+c1}{\PYGZsh{} Default}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}generate\PYGZus{}from\PYGZus{}model}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{start\PYGZus{}state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate trajectory from probabilistic model (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} This would generate a new trajectory from the model}
        \PYG{c+c1}{\PYGZsh{} conditioned on the start state}
        \PYG{n}{gmm} \PYG{o}{=} \PYG{n}{model}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gmm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Sample trajectory (highly simplified)}
        \PYG{n}{n\PYGZus{}points} \PYG{o}{=} \PYG{l+m+mi}{20}
        \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n\PYGZus{}points}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{n}{trajectory} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Simple generation heuristic}
        \PYG{n}{current\PYGZus{}state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{start\PYGZus{}state}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{time\PYGZus{}point} \PYG{o+ow}{in} \PYG{n}{t}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Predict next state}
            \PYG{n}{state\PYGZus{}with\PYGZus{}time} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{(}\PYG{p}{[}\PYG{n}{time\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{current\PYGZus{}state}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Sample from GMM (simplified)}
            \PYG{n}{means} \PYG{o}{=} \PYG{n}{gmm}\PYG{o}{.}\PYG{n}{means\PYGZus{}}
            \PYG{n}{weights} \PYG{o}{=} \PYG{n}{gmm}\PYG{o}{.}\PYG{n}{weights\PYGZus{}}
            
            \PYG{c+c1}{\PYGZsh{} Find closest component in time}
            \PYG{n}{time\PYGZus{}diffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{means}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{time\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{closest\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmin}\PYG{p}{(}\PYG{n}{time\PYGZus{}diffs}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Use mean of closest component}
            \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{means}\PYG{p}{[}\PYG{n}{closest\PYGZus{}idx}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Add to trajectory}
            \PYG{n}{trajectory}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{time\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{velocity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}
            \PYG{p}{\PYGZcb{}}\PYG{p}{)}
            
            \PYG{n}{current\PYGZus{}state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}
        
        \PYG{k}{return} \PYG{n}{trajectory}
\end{sphinxVerbatim}

\sphinxAtStartPar
Learning from demonstration taps into mechanisms similar to those humans use for social learning:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Goal inference}: Understanding the demonstrator’s objective

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context sensitivity}: Learning when and how to apply the demonstrated skills

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generalization}: Adapting learned skills to new situations

\end{enumerate}


\section{22.5 Code Lab: Simple Neuro\sphinxhyphen{}Inspired Robot Controller}
\label{\detokenize{part6/ch22_embodied_ai_robotics:code-lab-simple-neuro-inspired-robot-controller}}
\sphinxAtStartPar
Let’s implement a simplified robot controller that integrates several brain\sphinxhyphen{}inspired principles:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{animation}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{FuncAnimation}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuroBotController}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Neuro\PYGZhy{}inspired robot controller integrating multiple brain\PYGZhy{}like mechanisms}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Motor primitive system}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives} \PYG{o}{=} \PYG{l+m+mi}{4}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}motors} \PYG{o}{=} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Left and right wheel motors}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}create\PYGZus{}primitives}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Predictive forward model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Predicts [dx, dy, dθ] from [left, right]}
        
        \PYG{c+c1}{\PYGZsh{} Cerebellar adaptive component}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}cerebellum} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Corrective signal for motor commands}
        
        \PYG{c+c1}{\PYGZsh{} Sensory system}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors} \PYG{o}{=} \PYG{l+m+mi}{5}  \PYG{c+c1}{\PYGZsh{} 5 directional distance sensors}
        
        \PYG{c+c1}{\PYGZsh{} Place cell system for navigation}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{place\PYGZus{}cells} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}create\PYGZus{}place\PYGZus{}cells}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 20 place cells}
        
        \PYG{c+c1}{\PYGZsh{} Learning rates}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}lr} \PYG{o}{=} \PYG{l+m+mf}{0.01}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cerebellum\PYGZus{}lr} \PYG{o}{=} \PYG{l+m+mf}{0.005}
        
        \PYG{c+c1}{\PYGZsh{} Experience buffer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Performance metrics}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}create\PYGZus{}primitives}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create set of motor primitives\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{primitives} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}motors}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Forward motion}
        \PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Turn left}
        \PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Turn right}
        \PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Backward motion}
        \PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Normalize}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}primitives}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{primitives}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{primitives}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{primitives}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}create\PYGZus{}place\PYGZus{}cells}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}cells}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create place cell centers in 2D environment\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Randomly distribute place cells in 10×10 environment}
        \PYG{n}{centers} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}cells}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Each place cell has a preferred heading direction}
        \PYG{n}{preferred\PYGZus{}dirs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{n\PYGZus{}cells}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine into place cell definitions}
        \PYG{n}{place\PYGZus{}cells} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{column\PYGZus{}stack}\PYG{p}{(}\PYG{p}{(}\PYG{n}{centers}\PYG{p}{,} \PYG{n}{preferred\PYGZus{}dirs}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{place\PYGZus{}cells}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sense\PYGZus{}environment}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{position}\PYG{p}{,} \PYG{n}{heading}\PYG{p}{,} \PYG{n}{obstacles}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Get sensory input from environment}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} position: [x, y] position}
\PYG{l+s+sd}{        \PYGZhy{} heading: Heading direction in radians}
\PYG{l+s+sd}{        \PYGZhy{} obstacles: List of obstacle positions}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} sensor\PYGZus{}readings: Distance readings from sensors}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{sensor\PYGZus{}readings} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{10.0}  \PYG{c+c1}{\PYGZsh{} Max range = 10 units}
        
        \PYG{c+c1}{\PYGZsh{} Sensor angles relative to heading}
        \PYG{n}{sensor\PYGZus{}angles} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check distance to each obstacle along each sensor direction}
        \PYG{k}{for} \PYG{n}{obstacle} \PYG{o+ow}{in} \PYG{n}{obstacles}\PYG{p}{:}
            \PYG{n}{obs\PYGZus{}vec} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{obstacle}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{position}\PYG{p}{)}
            \PYG{n}{distance} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{obs\PYGZus{}vec}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Direction to obstacle in global frame}
            \PYG{n}{obs\PYGZus{}dir} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arctan2}\PYG{p}{(}\PYG{n}{obs\PYGZus{}vec}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{obs\PYGZus{}vec}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Convert to robot frame}
            \PYG{n}{rel\PYGZus{}angle} \PYG{o}{=} \PYG{p}{(}\PYG{n}{obs\PYGZus{}dir} \PYG{o}{\PYGZhy{}} \PYG{n}{heading} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}
            
            \PYG{c+c1}{\PYGZsh{} Find closest sensor}
            \PYG{n}{sensor\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{sensor\PYGZus{}angles} \PYG{o}{\PYGZhy{}} \PYG{n}{rel\PYGZus{}angle}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update sensor if obstacle is within its field of view and closer than previous readings}
            \PYG{n}{angle\PYGZus{}diff} \PYG{o}{=} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{sensor\PYGZus{}angles}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}idx}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{rel\PYGZus{}angle}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{angle\PYGZus{}diff} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.2} \PYG{o+ow}{and} \PYG{n}{distance} \PYG{o}{\PYGZlt{}} \PYG{n}{sensor\PYGZus{}readings}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}idx}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{sensor\PYGZus{}readings}\PYG{p}{[}\PYG{n}{sensor\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{distance}
        
        \PYG{k}{return} \PYG{n}{sensor\PYGZus{}readings}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{activate\PYGZus{}place\PYGZus{}cells}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{position}\PYG{p}{,} \PYG{n}{heading}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Calculate activation of place cells for current position}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} position: [x, y] position}
\PYG{l+s+sd}{        \PYGZhy{} heading: Heading direction in radians}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} activations: Activation level of each place cell}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Calculate distance to each place cell center}
        \PYG{n}{distances} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{place\PYGZus{}cells}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{position}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Place cell activation falls off with distance (Gaussian)}
        \PYG{n}{spatial\PYGZus{}activation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{distances}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{4.0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Heading direction modulation}
        \PYG{n}{heading\PYGZus{}diffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{place\PYGZus{}cells}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{heading}\PYG{p}{)}
        \PYG{n}{heading\PYGZus{}diffs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{minimum}\PYG{p}{(}\PYG{n}{heading\PYGZus{}diffs}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{\PYGZhy{}} \PYG{n}{heading\PYGZus{}diffs}\PYG{p}{)}
        \PYG{n}{heading\PYGZus{}activation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{heading\PYGZus{}diffs}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{1.0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combine spatial and heading modulation}
        \PYG{n}{activations} \PYG{o}{=} \PYG{n}{spatial\PYGZus{}activation} \PYG{o}{*} \PYG{n}{heading\PYGZus{}activation}
        
        \PYG{k}{return} \PYG{n}{activations}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}motor\PYGZus{}command}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{sensor\PYGZus{}readings}\PYG{p}{,} \PYG{n}{place\PYGZus{}cell\PYGZus{}activations}\PYG{p}{,} \PYG{n}{goal\PYGZus{}position}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Generate motor command using multiple neural systems}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} sensor\PYGZus{}readings: Current sensor readings}
\PYG{l+s+sd}{        \PYGZhy{} place\PYGZus{}cell\PYGZus{}activations: Current place cell activations}
\PYG{l+s+sd}{        \PYGZhy{} goal\PYGZus{}position: [x, y] goal position}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} motor\PYGZus{}command: Commands for left and right motors}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} 1. Reactive obstacle avoidance}
        \PYG{n}{danger\PYGZus{}level} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n}{sensor\PYGZus{}readings} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{p}{)}
        \PYG{n}{left\PYGZus{}danger} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{danger\PYGZus{}level}\PYG{p}{[}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{right\PYGZus{}danger} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{danger\PYGZus{}level}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Turn away from obstacles}
        \PYG{n}{obstacle\PYGZus{}response} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}motors}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{left\PYGZus{}danger} \PYG{o}{\PYGZgt{}} \PYG{n}{right\PYGZus{}danger}\PYG{p}{:}
            \PYG{n}{obstacle\PYGZus{}response} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Turn right}
        \PYG{k}{elif} \PYG{n}{right\PYGZus{}danger} \PYG{o}{\PYGZgt{}} \PYG{n}{left\PYGZus{}danger}\PYG{p}{:}
            \PYG{n}{obstacle\PYGZus{}response} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Turn left}
        
        \PYG{c+c1}{\PYGZsh{} 2. Goal\PYGZhy{}seeking behavior}
        \PYG{c+c1}{\PYGZsh{} Compute goal direction and activation}
        \PYG{n}{goal\PYGZus{}vec} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{goal\PYGZus{}position}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{place\PYGZus{}cell\PYGZus{}activations}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{place\PYGZus{}cell\PYGZus{}activations}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{goal\PYGZus{}distance} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{goal\PYGZus{}vec}\PYG{p}{)}
        
        \PYG{n}{goal\PYGZus{}seeking} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}motors}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{goal\PYGZus{}distance} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Forward motion with bias toward goal}
            \PYG{n}{goal\PYGZus{}seeking} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Forward}
            
            \PYG{c+c1}{\PYGZsh{} Add turning bias}
            \PYG{k}{if} \PYG{n}{goal\PYGZus{}vec}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{goal\PYGZus{}seeking} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Right bias}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{goal\PYGZus{}seeking} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{primitives}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Left bias}
        
        \PYG{c+c1}{\PYGZsh{} 3. Cerebellar correction}
        \PYG{c+c1}{\PYGZsh{} Expand sensory input using random projection (cerebellum\PYGZhy{}like)}
        \PYG{n}{expanded\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{p}{)}\PYG{p}{)} \PYG{o}{@} \PYG{n}{sensor\PYGZus{}readings}\PYG{p}{)}
        \PYG{n}{cerebellar\PYGZus{}correction} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}cerebellum} \PYG{o}{@} \PYG{n}{expanded\PYGZus{}input}
        
        \PYG{c+c1}{\PYGZsh{} Integrate all components}
        \PYG{c+c1}{\PYGZsh{} Obstacle avoidance has highest priority}
        \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.7}  \PYG{c+c1}{\PYGZsh{} Weight for obstacle avoidance vs. goal seeking}
        \PYG{n}{beta} \PYG{o}{=} \PYG{l+m+mf}{0.2}   \PYG{c+c1}{\PYGZsh{} Weight for cerebellar correction}
        
        \PYG{n}{motor\PYGZus{}command} \PYG{o}{=} \PYG{p}{(}
            \PYG{n}{alpha} \PYG{o}{*} \PYG{n}{obstacle\PYGZus{}response} \PYG{o}{+}
            \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{alpha}\PYG{p}{)} \PYG{o}{*} \PYG{n}{goal\PYGZus{}seeking} \PYG{o}{+}
            \PYG{n}{beta} \PYG{o}{*} \PYG{n}{cerebellar\PYGZus{}correction}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Normalize command to valid range [\PYGZhy{}1, 1]}
        \PYG{n}{motor\PYGZus{}command} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{motor\PYGZus{}command}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{motor\PYGZus{}command}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict\PYGZus{}next\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{current\PYGZus{}state}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Predict next state using forward model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} current\PYGZus{}state: [x, y, θ] current position and heading}
\PYG{l+s+sd}{        \PYGZhy{} motor\PYGZus{}command: [left, right] motor commands}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} predicted\PYGZus{}next\PYGZus{}state: Predicted next state}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Predict state change}
        \PYG{n}{predicted\PYGZus{}change} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{@} \PYG{n}{motor\PYGZus{}command}
        
        \PYG{c+c1}{\PYGZsh{} Calculate next state}
        \PYG{n}{predicted\PYGZus{}next\PYGZus{}state} \PYG{o}{=} \PYG{n}{current\PYGZus{}state} \PYG{o}{+} \PYG{n}{predicted\PYGZus{}change}
        
        \PYG{k}{return} \PYG{n}{predicted\PYGZus{}next\PYGZus{}state}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}models}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{current\PYGZus{}state}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Update internal models based on experience}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} current\PYGZus{}state: [x, y, θ] state before action}
\PYG{l+s+sd}{        \PYGZhy{} motor\PYGZus{}command: [left, right] executed motor command}
\PYG{l+s+sd}{        \PYGZhy{} next\PYGZus{}state: [x, y, θ] state after action}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} prediction\PYGZus{}error: Magnitude of prediction error}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Observed state change}
        \PYG{n}{actual\PYGZus{}change} \PYG{o}{=} \PYG{n}{next\PYGZus{}state} \PYG{o}{\PYGZhy{}} \PYG{n}{current\PYGZus{}state}
        
        \PYG{c+c1}{\PYGZsh{} Predicted state change}
        \PYG{n}{predicted\PYGZus{}change} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{@} \PYG{n}{motor\PYGZus{}command}
        
        \PYG{c+c1}{\PYGZsh{} Prediction error}
        \PYG{n}{prediction\PYGZus{}error} \PYG{o}{=} \PYG{n}{actual\PYGZus{}change} \PYG{o}{\PYGZhy{}} \PYG{n}{predicted\PYGZus{}change}
        \PYG{n}{error\PYGZus{}magnitude} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{error\PYGZus{}magnitude}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update forward model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}forward} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward\PYGZus{}lr} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{prediction\PYGZus{}error}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}\PYG{p}{)} 
        
        \PYG{c+c1}{\PYGZsh{} Store experience for later learning}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{state}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{current\PYGZus{}state}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{action}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{motor\PYGZus{}command}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{next\PYGZus{}state}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{next\PYGZus{}state}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{prediction\PYGZus{}error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{prediction\PYGZus{}error}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Limit buffer size}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{100}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update cerebellar model from random experiences (replay)}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{10}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Sample random experience}
            \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{exp} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{experience\PYGZus{}buffer}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
            
            \PYG{c+c1}{\PYGZsh{} Expand sensory representation}
            \PYG{n}{expanded\PYGZus{}input} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{p}{)}\PYG{p}{)} 
                                     \PYG{o}{@} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}sensors}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Simplified}
            
            \PYG{c+c1}{\PYGZsh{} Update cerebellar weights to reduce prediction error}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W\PYGZus{}cerebellum} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{cerebellum\PYGZus{}lr} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{exp}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{prediction\PYGZus{}error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{expanded\PYGZus{}input}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{error\PYGZus{}magnitude}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}trajectory}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{trajectory}\PYG{p}{,} \PYG{n}{obstacles}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{goal}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Visualize robot trajectory}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} trajectory: List of [x, y, θ] states}
\PYG{l+s+sd}{        \PYGZhy{} obstacles: Optional list of obstacle positions}
\PYG{l+s+sd}{        \PYGZhy{} goal: Optional goal position}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} fig: Matplotlib figure}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot obstacles}
        \PYG{k}{if} \PYG{n}{obstacles}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{obs} \PYG{o+ow}{in} \PYG{n}{obstacles}\PYG{p}{:}
                \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
                \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot goal}
        \PYG{k}{if} \PYG{n}{goal}\PYG{p}{:}
            \PYG{n}{circle} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Circle}\PYG{p}{(}\PYG{n}{goal}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
            \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{circle}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot trajectory}
        \PYG{n}{trajectory} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{trajectory}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{trajectory}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{trajectory}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Robot representation}
        \PYG{n}{robot} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Rectangle}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{add\PYGZus{}patch}\PYG{p}{(}\PYG{n}{robot}\PYG{p}{)}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{trajectory}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{θ} \PYG{o}{=} \PYG{n}{trajectory}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{c+c1}{\PYGZsh{} Update robot position and orientation}
                \PYG{n}{robot}\PYG{o}{.}\PYG{n}{set\PYGZus{}xy}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.15}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{trans} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Affine2D}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{rotate\PYGZus{}around}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{θ}\PYG{p}{)}
                \PYG{n}{robot}\PYG{o}{.}\PYG{n}{set\PYGZus{}transform}\PYG{p}{(}\PYG{n}{trans} \PYG{o}{+} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{transData}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{robot}\PYG{p}{,}
        
        \PYG{c+c1}{\PYGZsh{} Create animation}
        \PYG{n}{anim} \PYG{o}{=} \PYG{n}{FuncAnimation}\PYG{p}{(}\PYG{n}{fig}\PYG{p}{,} \PYG{n}{update}\PYG{p}{,} \PYG{n}{frames}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{trajectory}\PYG{p}{)}\PYG{p}{,} 
                             \PYG{n}{interval}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{blit}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Set plot limits and labels}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Robot Trajectory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}aspect}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{fig}\PYG{p}{,} \PYG{n}{anim}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}learning\PYGZus{}curve}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot learning curve of prediction errors\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{prediction\PYGZus{}errors}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Learning Step}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Prediction Error}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Forward Model Learning Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{ax}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{fig}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}robot\PYGZus{}simulation}\PYG{p}{(}\PYG{n}{controller}\PYG{p}{,} \PYG{n}{n\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Run robot simulation with the neuro\PYGZhy{}inspired controller}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} controller: NeuroBotController instance}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}steps: Number of simulation steps}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} trajectory: Recorded robot trajectory}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Environment setup}
    \PYG{n}{obstacles} \PYG{o}{=} \PYG{p}{[}
        \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]}
    \PYG{p}{]}
    \PYG{n}{goal} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Initial state}
    \PYG{n}{state} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [x, y, θ]}
    \PYG{n}{trajectory} \PYG{o}{=} \PYG{p}{[}\PYG{n}{state}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Simulation loop}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Sense environment}
        \PYG{n}{sensor\PYGZus{}readings} \PYG{o}{=} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{sense\PYGZus{}environment}\PYG{p}{(}
            \PYG{n}{state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{state}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{obstacles}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Activate place cells}
        \PYG{n}{place\PYGZus{}cell\PYGZus{}activations} \PYG{o}{=} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{activate\PYGZus{}place\PYGZus{}cells}\PYG{p}{(}
            \PYG{n}{state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{state}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate motor command}
        \PYG{n}{motor\PYGZus{}command} \PYG{o}{=} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{generate\PYGZus{}motor\PYGZus{}command}\PYG{p}{(}
            \PYG{n}{sensor\PYGZus{}readings}\PYG{p}{,} \PYG{n}{place\PYGZus{}cell\PYGZus{}activations}\PYG{p}{,} \PYG{n}{goal}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Predict next state}
        \PYG{n}{predicted\PYGZus{}next\PYGZus{}state} \PYG{o}{=} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{predict\PYGZus{}next\PYGZus{}state}\PYG{p}{(}
            \PYG{n}{state}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}
        \PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simulate robot movement (simplified physics)}
        \PYG{c+c1}{\PYGZsh{} In real robot, this would be the actual physical movement}
        \PYG{n}{next\PYGZus{}state} \PYG{o}{=} \PYG{n}{state}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Convert motor commands to motion}
        \PYG{n}{speed} \PYG{o}{=} \PYG{p}{(}\PYG{n}{motor\PYGZus{}command}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{motor\PYGZus{}command}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{2.0}
        \PYG{n}{turn\PYGZus{}rate} \PYG{o}{=} \PYG{p}{(}\PYG{n}{motor\PYGZus{}command}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{motor\PYGZus{}command}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{0.5}
        
        \PYG{c+c1}{\PYGZsh{} Update position and orientation}
        \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{turn\PYGZus{}rate} \PYG{o}{*} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Update heading}
        \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{speed} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Update x}
        \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{speed} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} Update y}
        
        \PYG{c+c1}{\PYGZsh{} Boundary checks (keep within environment)}
        \PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{next\PYGZus{}state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update models}
        \PYG{n}{controller}\PYG{o}{.}\PYG{n}{update\PYGZus{}models}\PYG{p}{(}\PYG{n}{state}\PYG{p}{,} \PYG{n}{motor\PYGZus{}command}\PYG{p}{,} \PYG{n}{next\PYGZus{}state}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update state}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{next\PYGZus{}state}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{trajectory}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{state}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Check if goal reached}
        \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{state}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{goal}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mf}{0.5}\PYG{p}{:}
            \PYG{k}{break}
    
    \PYG{k}{return} \PYG{n}{trajectory}

\PYG{c+c1}{\PYGZsh{} Create controller and run simulation}
\PYG{c+c1}{\PYGZsh{} controller = NeuroBotController()}
\PYG{c+c1}{\PYGZsh{} trajectory = run\PYGZus{}robot\PYGZus{}simulation(controller, 200)}
\PYG{c+c1}{\PYGZsh{} fig, anim = controller.visualize\PYGZus{}trajectory(trajectory, }
\PYG{c+c1}{\PYGZsh{}                                           obstacles=[[3, 3], [5, 7], [7, 4]], }
\PYG{c+c1}{\PYGZsh{}                                           goal=[8, 8])}
\PYG{c+c1}{\PYGZsh{} learning\PYGZus{}fig = controller.plot\PYGZus{}learning\PYGZus{}curve()}
\end{sphinxVerbatim}

\sphinxAtStartPar
This example integrates several neuro\sphinxhyphen{}inspired mechanisms:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Motor primitives}: Basic movement patterns similar to the brain’s movement synergies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Forward models}: Predictive coding for anticipating the results of actions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cerebellar\sphinxhyphen{}like correction}: Adaptive fine\sphinxhyphen{}tuning of movements based on experience

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Place cells}: Hippocampus\sphinxhyphen{}inspired spatial representation for navigation

\end{enumerate}


\section{22.6 Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch22_embodied_ai_robotics:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Embodiment is essential for intelligence}: Physical interaction with the environment shapes learning and cognition

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Brain\sphinxhyphen{}inspired control architectures} offer alternatives to traditional planning\sphinxhyphen{}sensing\sphinxhyphen{}acting loops

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Predictive coding} principles can improve control by anticipating the sensory consequences of actions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Motor primitives} provide an efficient framework for complex movement generation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Social robotics} requires specialized mechanisms for interaction, similar to the brain’s social cognition areas

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Affordance\sphinxhyphen{}based perception} links perception directly to action possibilities, bridging the gap between seeing and doing

\end{itemize}


\section{22.7 Further Reading}
\label{\detokenize{part6/ch22_embodied_ai_robotics:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Pfeifer, R., \& Bongard, J. (2006). \sphinxhref{https://mitpress.mit.edu/books/how-body-shapes-way-we-think}{How the Body Shapes the Way We Think: A New View of Intelligence}. MIT Press. Explores the fundamental role of embodiment in intelligence.

\item {} 
\sphinxAtStartPar
Wolpert, D. M., \& Ghahramani, Z. (2000). \sphinxhref{https://www.nature.com/articles/nn0900\_1212}{Computational principles of movement neuroscience}. Nature Neuroscience, 3(11), 1212\sphinxhyphen{}1217. Discusses predictive forward models in motor control.

\item {} 
\sphinxAtStartPar
Brooks, R. A. (1991). \sphinxhref{https://people.csail.mit.edu/brooks/papers/representation.pdf}{Intelligence without representation}. Artificial Intelligence, 47(1\sphinxhyphen{}3), 139\sphinxhyphen{}159. Classic paper on reactive, behavior\sphinxhyphen{}based robotics.

\item {} 
\sphinxAtStartPar
Abbeel, P., \& Ng, A. Y. (2004). \sphinxhref{https://dl.acm.org/doi/10.1145/1015330.1015430}{Apprenticeship learning via inverse reinforcement learning}. Proceedings of the Twenty\sphinxhyphen{}first International Conference on Machine Learning (ICML). Explores learning from human demonstrations.

\item {} 
\sphinxAtStartPar
Gibson, J. J. (1979). \sphinxhref{https://www.taylorfrancis.com/books/mono/10.4324/9781315740218/ecological-approach-visual-perception-james-gibson}{The Ecological Approach to Visual Perception}. Psychology Press. Foundational work on affordances.

\item {} 
\sphinxAtStartPar
Kawato, M. (1999). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S0959438899000288}{Internal models for motor control and trajectory planning}. Current Opinion in Neurobiology, 9(6), 718\sphinxhyphen{}727. Reviews cerebellar models and their applications in robotics.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 24: Quantum Computing and NeuroAI}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:chapter-24-quantum-computing-and-neuroai}}\label{\detokenize{part6/ch24_quantum_computing_neuroai::doc}}

\section{24.0 Chapter Goals}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the fundamentals of quantum computing relevant to neural processing

\item {} 
\sphinxAtStartPar
Explore potential synergies between quantum computing and neuroscience\sphinxhyphen{}inspired AI

\item {} 
\sphinxAtStartPar
Learn about quantum neural networks and their unique capabilities

\item {} 
\sphinxAtStartPar
Implement a simple quantum machine learning algorithm

\end{itemize}


\section{24.1 Quantum Computing Fundamentals for NeuroAI}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-computing-fundamentals-for-neuroai}}
\sphinxAtStartPar
Quantum computing represents a fundamentally different paradigm from classical computing, with unique properties that may offer advantages for certain neural computation tasks.


\subsection{24.1.1 Quantum Bits and Superposition}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-bits-and-superposition}}
\sphinxAtStartPar
While classical bits exist in definite states (0 or 1), quantum bits (qubits) can exist in a superposition of states:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{QuantumCircuit}\PYG{p}{,} \PYG{n}{Aer}\PYG{p}{,} \PYG{n}{execute}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{visualization}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{plot\PYGZus{}histogram}\PYG{p}{,} \PYG{n}{plot\PYGZus{}bloch\PYGZus{}multivector}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}superposition}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate quantum superposition}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a quantum circuit with one qubit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Put qubit in superposition using Hadamard gate}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure the qubit}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate the circuit}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{counts}\PYG{p}{,} \PYG{n}{qc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{visualize\PYGZus{}qubit\PYGZus{}state}\PYG{p}{(}\PYG{n}{theta}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{phi}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Visualize a qubit state on the Bloch sphere}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} theta: Polar angle (0 to π)}
\PYG{l+s+sd}{    \PYGZhy{} phi: Azimuthal angle (0 to 2π)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} state\PYGZus{}vector: Quantum state vector}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a quantum circuit with one qubit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply rotations to set the state}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{ry}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Rotation around Y\PYGZhy{}axis}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{phi}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} Rotation around Z\PYGZhy{}axis}
    
    \PYG{c+c1}{\PYGZsh{} Simulate to get statevector}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statevector\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{)}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{state\PYGZus{}vector} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{get\PYGZus{}statevector}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute probability amplitudes}
    \PYG{n}{alpha} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{beta} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{n}{j}\PYG{o}{*}\PYG{n}{phi}\PYG{p}{)} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{n}{state\PYGZus{}description} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{|ψ⟩ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{alpha}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{|0⟩ + }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{beta}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{|1⟩}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{k}{return} \PYG{n}{state\PYGZus{}vector}\PYG{p}{,} \PYG{n}{state\PYGZus{}description}\PYG{p}{,} \PYG{n}{qc}
\end{sphinxVerbatim}

\sphinxAtStartPar
The ability of qubits to exist in superposition states allows quantum computers to explore multiple computational paths simultaneously, potentially offering exponential speedups for certain problems relevant to neural network training.


\subsection{24.1.2 Quantum Entanglement and Information Transfer}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-entanglement-and-information-transfer}}
\sphinxAtStartPar
Entanglement is a quantum phenomenon where two or more qubits become correlated in ways that can’t be described classically:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}entangled\PYGZus{}pair}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create an entangled pair of qubits (Bell state)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a quantum circuit with two qubits}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Put first qubit in superposition}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Entangle the qubits using CNOT gate}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure both qubits}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate the circuit}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{counts}\PYG{p}{,} \PYG{n}{qc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}nonlocal\PYGZus{}correlation}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate nonlocal correlation of entangled qubits}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a quantum circuit with two qubits}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create Bell state}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure in different bases}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Original Bell state}
    \PYG{n}{bell\PYGZus{}qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{bell\PYGZus{}qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure first qubit in X basis}
    \PYG{n}{x\PYGZus{}basis\PYGZus{}qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{x\PYGZus{}basis\PYGZus{}qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{x\PYGZus{}basis\PYGZus{}qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure both qubits in X basis}
    \PYG{n}{both\PYGZus{}x\PYGZus{}qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{both\PYGZus{}x\PYGZus{}qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{both\PYGZus{}x\PYGZus{}qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{both\PYGZus{}x\PYGZus{}qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate all circuits}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Execute and collect results}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{circ} \PYG{o+ow}{in} \PYG{p}{[}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Bell}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{bell\PYGZus{}qc}\PYG{p}{)}\PYG{p}{,} 
                        \PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{X basis on first}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{x\PYGZus{}basis\PYGZus{}qc}\PYG{p}{)}\PYG{p}{,}
                        \PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{X basis on both}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{both\PYGZus{}x\PYGZus{}qc}\PYG{p}{)}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{circ}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
        \PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{circ}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{results}\PYG{p}{,} \PYG{n}{bell\PYGZus{}qc}
\end{sphinxVerbatim}

\sphinxAtStartPar
Entanglement provides a mechanism for creating distributed representations where information is encoded across multiple qubits, similar to how neural networks distribute representations across multiple neurons.


\subsection{24.1.3 Quantum Gates and Transformations}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-gates-and-transformations}}
\sphinxAtStartPar
Quantum neural networks require understanding how information is processed through quantum gates:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}rotation\PYGZus{}gates}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate basic quantum rotation gates}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a state vector to visualize}
    \PYG{n}{initial\PYGZus{}state} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} |+⟩ state}
    
    \PYG{c+c1}{\PYGZsh{} Create circuits for different rotations}
    \PYG{n}{circuits} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} X gate (NOT gate)}
    \PYG{n}{qc\PYGZus{}x} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}x}\PYG{o}{.}\PYG{n}{initialize}\PYG{p}{(}\PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}x}\PYG{o}{.}\PYG{n}{x}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{circuits}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{X gate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{qc\PYGZus{}x}
    
    \PYG{c+c1}{\PYGZsh{} Y gate}
    \PYG{n}{qc\PYGZus{}y} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}y}\PYG{o}{.}\PYG{n}{initialize}\PYG{p}{(}\PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}y}\PYG{o}{.}\PYG{n}{y}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{circuits}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y gate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{qc\PYGZus{}y}
    
    \PYG{c+c1}{\PYGZsh{} Z gate}
    \PYG{n}{qc\PYGZus{}z} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}z}\PYG{o}{.}\PYG{n}{initialize}\PYG{p}{(}\PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}z}\PYG{o}{.}\PYG{n}{z}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{circuits}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Z gate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{qc\PYGZus{}z}
    
    \PYG{c+c1}{\PYGZsh{} Hadamard gate}
    \PYG{n}{qc\PYGZus{}h} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}h}\PYG{o}{.}\PYG{n}{initialize}\PYG{p}{(}\PYG{n}{initial\PYGZus{}state}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc\PYGZus{}h}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{circuits}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{H gate}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{qc\PYGZus{}h}
    
    \PYG{c+c1}{\PYGZsh{} Simulate to get statevectors}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statevector\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{circ} \PYG{o+ow}{in} \PYG{n}{circuits}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{circ}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{)}
        \PYG{n}{state} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}statevector}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{results}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{state}
    
    \PYG{k}{return} \PYG{n}{results}\PYG{p}{,} \PYG{n}{circuits}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}interference}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate quantum interference}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a circuit with 2 qubits}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply Hadamard gates to create superposition}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add a phase shift gate}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{s}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply another layer of Hadamard gates}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure the qubits}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate the circuit}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{counts}\PYG{p}{,} \PYG{n}{qc}
\end{sphinxVerbatim}

\sphinxAtStartPar
Quantum gates provide reversible transformations of qubit states, allowing for the implementation of neural network\sphinxhyphen{}like operations in the quantum domain.


\section{24.2 Quantum Neural Networks}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-neural-networks}}
\sphinxAtStartPar
Quantum Neural Networks (QNNs) combine principles from quantum computing and neural networks to create hybrid models with unique capabilities.


\subsection{24.2.1 Parameterized Quantum Circuits as Neural Networks}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:parameterized-quantum-circuits-as-neural-networks}}
\sphinxAtStartPar
Parameterized quantum circuits can be trained similarly to classical neural networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{circuit}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Parameter}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{algorithms}\PYG{n+nn}{.}\PYG{n+nn}{optimizers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{COBYLA}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}quantum\PYGZus{}neural\PYGZus{}network}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a parameterized quantum circuit that can be used as a QNN}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}layers: Number of repeating layers}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Quantum circuit}
\PYG{l+s+sd}{    \PYGZhy{} parameters: List of Parameters objects}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create parameters}
    \PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Initial layer of Hadamards}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Layers of parameterized rotations and entanglement}
    \PYG{k}{for} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Parameterized rotations}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} RY rotation with parameter}
            \PYG{n}{theta} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{θ\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{parameters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{ry}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} RZ rotation with parameter}
            \PYG{n}{phi} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{φ\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{parameters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{phi}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{phi}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Entanglement}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Connect last qubit to first for circular entanglement}
        \PYG{k}{if} \PYG{n}{n\PYGZus{}qubits} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Final measurements}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}neural\PYGZus{}network\PYGZus{}inference}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{parameter\PYGZus{}values}\PYG{p}{,} \PYG{n}{n\PYGZus{}shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Run inference with a quantum neural network}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Parameterized quantum circuit}
\PYG{l+s+sd}{    \PYGZhy{} parameters: List of Parameter objects}
\PYG{l+s+sd}{    \PYGZhy{} parameter\PYGZus{}values: Values to assign to parameters}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}shots: Number of measurement shots}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} counts: Measurement results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Bind parameters}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)} \PYG{o}{!=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameter\PYGZus{}values}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Expected }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ values, got }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameter\PYGZus{}values}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{parameter\PYGZus{}dict} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{,} \PYG{n}{parameter\PYGZus{}values}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{bound\PYGZus{}qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{bind\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{parameter\PYGZus{}dict}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{n}{n\PYGZus{}shots}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{counts}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}quantum\PYGZus{}neural\PYGZus{}network}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{n\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Train a quantum neural network}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Parameterized quantum circuit}
\PYG{l+s+sd}{    \PYGZhy{} parameters: List of Parameter objects}
\PYG{l+s+sd}{    \PYGZhy{} X\PYGZus{}train: Training inputs}
\PYG{l+s+sd}{    \PYGZhy{} y\PYGZus{}train: Training targets (binary labels)}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}epochs: Number of training epochs}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} optimal\PYGZus{}parameters: Trained parameter values}
\PYG{l+s+sd}{    \PYGZhy{} loss\PYGZus{}history: Training loss history}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Number of parameters in the model}
    \PYG{n}{n\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Initialize parameters}
    \PYG{n}{initial\PYGZus{}params} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}params}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
    
    \PYG{c+c1}{\PYGZsh{} Loss history}
    \PYG{n}{loss\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Define cost function for given parameters}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{cost\PYGZus{}function}\PYG{p}{(}\PYG{n}{params}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{loss} \PYG{o}{=} \PYG{l+m+mf}{0.0}
        
        \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Encode input data}
            \PYG{n}{input\PYGZus{}params} \PYG{o}{=} \PYG{n}{params}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{x\PYGZus{}i} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Use data to adjust the first layer parameters}
                \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}params}\PYG{p}{:}
                    \PYG{n}{input\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{x\PYGZus{}i}
            
            \PYG{c+c1}{\PYGZsh{} Run quantum circuit}
            \PYG{n}{counts} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}neural\PYGZus{}network\PYGZus{}inference}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{input\PYGZus{}params}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate prediction (probability of measuring all 0s)}
            \PYG{n}{prediction} \PYG{o}{=} \PYG{n}{counts}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{*} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{num\PYGZus{}qubits}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}
            
            \PYG{c+c1}{\PYGZsh{} Binary cross\PYGZhy{}entropy loss}
            \PYG{n}{epsilon} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}10}  \PYG{c+c1}{\PYGZsh{} Small value to prevent log(0)}
            \PYG{k}{if} \PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{loss} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{prediction} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{loss} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{prediction} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Average loss}
        \PYG{n}{loss} \PYG{o}{/}\PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
        \PYG{n}{loss\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{loss}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{loss}
    
    \PYG{c+c1}{\PYGZsh{} Use classical optimizer to train quantum circuit}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{COBYLA}\PYG{p}{(}\PYG{n}{maxiter}\PYG{o}{=}\PYG{n}{n\PYGZus{}epochs}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{minimize}\PYG{p}{(}\PYG{n}{cost\PYGZus{}function}\PYG{p}{,} \PYG{n}{initial\PYGZus{}params}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{result}\PYG{o}{.}\PYG{n}{x}\PYG{p}{,} \PYG{n}{loss\PYGZus{}history}
\end{sphinxVerbatim}

\sphinxAtStartPar
Unlike classical ANNs, QNNs can leverage quantum properties such as superposition and entanglement to potentially learn more complex patterns with fewer parameters.


\subsection{24.2.2 Quantum Associative Memory}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-associative-memory}}
\sphinxAtStartPar
Quantum systems can store patterns in a manner analogous to associative memory in neural networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}quantum\PYGZus{}memory}\PYG{p}{(}\PYG{n}{patterns}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a quantum memory that stores binary patterns}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} patterns: List of binary patterns to store}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits (defaults to pattern length)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Quantum circuit implementing the memory}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{patterns}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No patterns provided}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{pattern\PYGZus{}length} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{patterns}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{n\PYGZus{}qubits} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{n\PYGZus{}qubits} \PYG{o}{=} \PYG{n}{pattern\PYGZus{}length}
    
    \PYG{c+c1}{\PYGZsh{} Create circuit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply Hadamard gates to create equal superposition}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Encode each pattern}
    \PYG{k}{for} \PYG{n}{pattern} \PYG{o+ow}{in} \PYG{n}{patterns}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{pattern}\PYG{p}{)} \PYG{o}{!=} \PYG{n}{pattern\PYGZus{}length}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{All patterns must have the same length}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a subcircuit that marks this pattern}
        \PYG{c+c1}{\PYGZsh{} First, flip qubits that should be 0 in the pattern}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{bit} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pattern}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{bit} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{x}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply a multi\PYGZhy{}controlled Z gate}
        \PYG{k}{if} \PYG{n}{n\PYGZus{}qubits} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} For simplicity, we\PYGZsq{}ll use a series of CNOT gates and a Z}
            \PYG{c+c1}{\PYGZsh{} In a real quantum computer, this would be more efficient}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{z}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Flip qubits back}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{bit} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{pattern}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{bit} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{x}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Final Hadamard gates}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{qc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{query\PYGZus{}quantum\PYGZus{}memory}\PYG{p}{(}\PYG{n}{memory\PYGZus{}qc}\PYG{p}{,} \PYG{n}{partial\PYGZus{}pattern}\PYG{p}{,} \PYG{n}{measure\PYGZus{}qubits}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Query the quantum memory with a partial pattern}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} memory\PYGZus{}qc: Quantum circuit implementing the memory}
\PYG{l+s+sd}{    \PYGZhy{} partial\PYGZus{}pattern: Partial pattern with None for unknown bits}
\PYG{l+s+sd}{    \PYGZhy{} measure\PYGZus{}qubits: Which qubits to measure (defaults to unknown bits)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} results: Measurement results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}qubits} \PYG{o}{=} \PYG{n}{memory\PYGZus{}qc}\PYG{o}{.}\PYG{n}{num\PYGZus{}qubits}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{partial\PYGZus{}pattern}\PYG{p}{)} \PYG{o}{!=} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pattern length }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{partial\PYGZus{}pattern}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ doesn}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{t match circuit qubits }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{n\PYGZus{}qubits}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a circuit for querying}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Copy the memory circuit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{compose}\PYG{p}{(}\PYG{n}{memory\PYGZus{}qc}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply constraints based on known bits in partial pattern}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{bit} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{partial\PYGZus{}pattern}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{bit} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Project onto the known value}
            \PYG{k}{if} \PYG{n}{bit} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{x}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{bit} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{x}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Determine which qubits to measure}
    \PYG{k}{if} \PYG{n}{measure\PYGZus{}qubits} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{measure\PYGZus{}qubits} \PYG{o}{=} \PYG{p}{[}\PYG{n}{i} \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{bit} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{partial\PYGZus{}pattern}\PYG{p}{)} \PYG{k}{if} \PYG{n}{bit} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Add measurement operations}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{measure\PYGZus{}qubits}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{results} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{results}\PYG{p}{,} \PYG{n}{qc}
\end{sphinxVerbatim}

\sphinxAtStartPar
Quantum associative memory can potentially store and retrieve patterns with quantum advantages in capacity and retrieval efficiency.


\subsection{24.2.3 Quantum Boltzmann Machines}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-boltzmann-machines}}
\sphinxAtStartPar
Quantum Boltzmann Machines (QBMs) extend classical Boltzmann machines by replacing binary units with qubits:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}quantum\PYGZus{}boltzmann\PYGZus{}machine}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Create a simplified quantum Boltzmann machine}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}visible: Number of visible qubits}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}hidden: Number of hidden qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Quantum circuit}
\PYG{l+s+sd}{    \PYGZhy{} parameters: Dictionary of parameters}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Total number of qubits}
    \PYG{n}{n\PYGZus{}qubits} \PYG{o}{=} \PYG{n}{n\PYGZus{}visible} \PYG{o}{+} \PYG{n}{n\PYGZus{}hidden}
    
    \PYG{c+c1}{\PYGZsh{} Create circuit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}visible}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create parameters for bias terms and coupling terms}
    \PYG{n}{parameters} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Bias parameters for visible units}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visible\PYGZus{}bias\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Bias parameters for hidden units}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hidden\PYGZus{}bias\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Coupling parameters between visible and hidden units}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coupling\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply initialization (Hadamard gates)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply bias terms for visible units}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visible\PYGZus{}bias\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply bias terms for hidden units}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hidden\PYGZus{}bias\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{n\PYGZus{}visible} \PYG{o}{+} \PYG{n}{j}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply coupling terms}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create interaction using CNOT and RZ gates}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{n\PYGZus{}visible} \PYG{o}{+} \PYG{n}{j}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coupling\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{j}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{n\PYGZus{}visible} \PYG{o}{+} \PYG{n}{j}\PYG{p}{)}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{n\PYGZus{}visible} \PYG{o}{+} \PYG{n}{j}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure visible units}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}visible}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample\PYGZus{}quantum\PYGZus{}boltzmann\PYGZus{}machine}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{parameter\PYGZus{}values}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Generate samples from a quantum Boltzmann machine}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} qc: Quantum circuit for the QBM}
\PYG{l+s+sd}{    \PYGZhy{} parameters: Dictionary of parameters}
\PYG{l+s+sd}{    \PYGZhy{} parameter\PYGZus{}values: Dictionary of parameter values}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}samples: Number of samples to generate}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} samples: Measurement results}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Bind parameters}
    \PYG{n}{bound\PYGZus{}qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{bind\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n}{parameters}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{:} \PYG{n}{value} 
                                   \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n}{parameter\PYGZus{}values}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{counts}
\end{sphinxVerbatim}

\sphinxAtStartPar
QBMs can potentially model more complex probability distributions than their classical counterparts due to quantum effects, potentially leading to more powerful generative models.


\section{24.3 Potential Applications in NeuroAI}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:potential-applications-in-neuroai}}
\sphinxAtStartPar
Quantum computing may offer advantages for several neural computing applications.


\subsection{24.3.1 Quantum Speedups for Neural Network Training}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-speedups-for-neural-network-training}}
\sphinxAtStartPar
Quantum algorithms could potentially speed up certain neural network training tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}gradient\PYGZus{}estimation}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{depth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate quantum gradient estimation for neural network training}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    \PYGZhy{} depth: Circuit depth}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} gradient\PYGZus{}estimates: Estimated gradients}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create parameterized circuit}
    \PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters} \PYG{o}{=} \PYG{n}{create\PYGZus{}quantum\PYGZus{}neural\PYGZus{}network}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{depth}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Number of parameters}
    \PYG{n}{n\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Random parameter values}
    \PYG{n}{param\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}params}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate gradients using parameter shift rule}
    \PYG{n}{gradients} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Create shifted parameter sets}
        \PYG{n}{shift} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}
        
        \PYG{n}{plus\PYGZus{}params} \PYG{o}{=} \PYG{n}{param\PYGZus{}values}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plus\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{shift}
        
        \PYG{n}{minus\PYGZus{}params} \PYG{o}{=} \PYG{n}{param\PYGZus{}values}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{minus\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{shift}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate at shifted points}
        \PYG{n}{plus\PYGZus{}counts} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}neural\PYGZus{}network\PYGZus{}inference}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{plus\PYGZus{}params}\PYG{p}{)}
        \PYG{n}{minus\PYGZus{}counts} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}neural\PYGZus{}network\PYGZus{}inference}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}\PYG{p}{,} \PYG{n}{minus\PYGZus{}params}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate expectation values (probability of measuring all 0s)}
        \PYG{n}{plus\PYGZus{}expectation} \PYG{o}{=} \PYG{n}{plus\PYGZus{}counts}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{*} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}
        \PYG{n}{minus\PYGZus{}expectation} \PYG{o}{=} \PYG{n}{minus\PYGZus{}counts}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{*} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}
        
        \PYG{c+c1}{\PYGZsh{} Estimate gradient using parameter shift rule}
        \PYG{n}{gradient} \PYG{o}{=} \PYG{p}{(}\PYG{n}{plus\PYGZus{}expectation} \PYG{o}{\PYGZhy{}} \PYG{n}{minus\PYGZus{}expectation}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{shift}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{gradients}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{gradient}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{gradients}\PYG{p}{,} \PYG{n}{param\PYGZus{}values}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}enhanced\PYGZus{}optimization}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate a quantum\PYGZhy{}enhanced optimization algorithm (simplified)}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} optimization\PYGZus{}results: Results of the optimization process}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Define a simple test function to optimize}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{test\PYGZus{}function}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Starting point}
    \PYG{n}{initial\PYGZus{}point} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+m+mf}{2.0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Optimization results with different methods}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Classical gradient descent (simplified)}
    \PYG{n}{learning\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mf}{0.1}
    \PYG{n}{current\PYGZus{}point} \PYG{o}{=} \PYG{n}{initial\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{classical\PYGZus{}trajectory} \PYG{o}{=} \PYG{p}{[}\PYG{n}{current\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate gradient}
        \PYG{n}{gradient} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{current\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{current\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update}
        \PYG{n}{current\PYGZus{}point} \PYG{o}{=} \PYG{n}{current\PYGZus{}point} \PYG{o}{\PYGZhy{}} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradient}
        \PYG{n}{classical\PYGZus{}trajectory}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{classical}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final\PYGZus{}point}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{current\PYGZus{}point}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final\PYGZus{}value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{test\PYGZus{}function}\PYG{p}{(}\PYG{n}{current\PYGZus{}point}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trajectory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{classical\PYGZus{}trajectory}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Quantum\PYGZhy{}inspired optimization (simplified simulation)}
    \PYG{c+c1}{\PYGZsh{} In reality, this would use quantum amplitude estimation or QAE}
    \PYG{n}{current\PYGZus{}point} \PYG{o}{=} \PYG{n}{initial\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{quantum\PYGZus{}trajectory} \PYG{o}{=} \PYG{p}{[}\PYG{n}{current\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Simulate quantum advantage with larger initial steps}
    \PYG{c+c1}{\PYGZsh{} that then adapt with a learning scheduler}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Calculate gradient (with simulated quantum advantage)}
        \PYG{n}{gradient} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{current\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{current\PYGZus{}point}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add quantum noise which can help escape local minima}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{10}\PYG{p}{:}
            \PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{n}{gradient} \PYG{o}{+}\PYG{o}{=} \PYG{n}{noise}
        
        \PYG{c+c1}{\PYGZsh{} Adaptive learning rate (simulating quantum advantage)}
        \PYG{n}{adaptive\PYGZus{}lr} \PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{i}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Update}
        \PYG{n}{current\PYGZus{}point} \PYG{o}{=} \PYG{n}{current\PYGZus{}point} \PYG{o}{\PYGZhy{}} \PYG{n}{adaptive\PYGZus{}lr} \PYG{o}{*} \PYG{n}{gradient}
        \PYG{n}{quantum\PYGZus{}trajectory}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{current\PYGZus{}point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{quantum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final\PYGZus{}point}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{current\PYGZus{}point}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final\PYGZus{}value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{test\PYGZus{}function}\PYG{p}{(}\PYG{n}{current\PYGZus{}point}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trajectory}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{quantum\PYGZus{}trajectory}\PYG{p}{)}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}

\sphinxAtStartPar
Quantum algorithms like the Quantum Amplitude Estimation (QAE) could provide quadratic speedups for gradient estimation in neural network training.


\subsection{24.3.2 Quantum\sphinxhyphen{}Enhanced Feature Spaces}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-enhanced-feature-spaces}}
\sphinxAtStartPar
Quantum circuits can map classical data into higher\sphinxhyphen{}dimensional feature spaces, similar to kernel methods in classical machine learning:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}kernel}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute a quantum kernel between two data points}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} x1, x2: Data points}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} kernel\PYGZus{}value: Kernel similarity}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Normalize input vectors}
    \PYG{n}{x1} \PYG{o}{=} \PYG{n}{x1} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{)}
    \PYG{n}{x2} \PYG{o}{=} \PYG{n}{x2} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{x2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a circuit with n\PYGZus{}qubits}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Define a feature map circuit}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{feature\PYGZus{}map}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{qc}\PYG{p}{,} \PYG{n}{qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} First layer of Hadamards}
        \PYG{k}{for} \PYG{n}{q} \PYG{o+ow}{in} \PYG{n}{qubits}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{q}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Feature mapping layer 1}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{q} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{qubits}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{q}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Entanglement}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{qubits}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{qubits}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{qubits}\PYG{p}{[}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Feature mapping layer 2}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{q} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{qubits}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{q}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create test circuits}
    \PYG{n}{qc1} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    \PYG{n}{feature\PYGZus{}map}\PYG{p}{(}\PYG{n}{x1}\PYG{p}{,} \PYG{n}{qc1}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{qc2} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    \PYG{n}{feature\PYGZus{}map}\PYG{p}{(}\PYG{n}{x2}\PYG{p}{,} \PYG{n}{qc2}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a circuit to compute their overlap}
    \PYG{c+c1}{\PYGZsh{} We can take advantage of the fact that K(x,y) = |⟨ϕ(x)|ϕ(y)⟩|²}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{qc1}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} Apply inverse of second feature map}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{qc}\PYG{o}{.}\PYG{n}{compose}\PYG{p}{(}\PYG{n}{qc2}\PYG{o}{.}\PYG{n}{inverse}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statevector\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{)}
    \PYG{n}{state} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}statevector}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Kernel value is probability of measuring all zeros}
    \PYG{n}{kernel\PYGZus{}value} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{state}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
    
    \PYG{k}{return} \PYG{n}{kernel\PYGZus{}value}\PYG{p}{,} \PYG{n}{qc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}kernel\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute quantum kernel matrix for a dataset}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} X: Dataset}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} kernel\PYGZus{}matrix: Matrix of kernel values}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n}{kernel\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{kernel\PYGZus{}value}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}kernel}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
            \PYG{n}{kernel\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{kernel\PYGZus{}value}
            \PYG{n}{kernel\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{kernel\PYGZus{}value}  \PYG{c+c1}{\PYGZsh{} Symmetric}
    
    \PYG{k}{return} \PYG{n}{kernel\PYGZus{}matrix}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}enhanced\PYGZus{}classification}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Perform classification using a quantum kernel}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} X\PYGZus{}train: Training data}
\PYG{l+s+sd}{    \PYGZhy{} y\PYGZus{}train: Training labels}
\PYG{l+s+sd}{    \PYGZhy{} X\PYGZus{}test: Test data}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} predictions: Predicted labels for test data}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{svm}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{SVC}
    
    \PYG{c+c1}{\PYGZsh{} Compute kernel matrix for training data}
    \PYG{n}{train\PYGZus{}kernel} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}kernel\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train a classifier with the precomputed kernel}
    \PYG{n}{svc} \PYG{o}{=} \PYG{n}{SVC}\PYG{p}{(}\PYG{n}{kernel}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precomputed}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{svc}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{train\PYGZus{}kernel}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute kernel between test and training points}
    \PYG{n}{test\PYGZus{}kernel} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{x\PYGZus{}test} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{x\PYGZus{}train} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{kernel\PYGZus{}value}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}kernel}\PYG{p}{(}\PYG{n}{x\PYGZus{}test}\PYG{p}{,} \PYG{n}{x\PYGZus{}train}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
            \PYG{n}{test\PYGZus{}kernel}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{kernel\PYGZus{}value}
    
    \PYG{c+c1}{\PYGZsh{} Predict using the trained model}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{svc}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{test\PYGZus{}kernel}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{predictions}
\end{sphinxVerbatim}

\sphinxAtStartPar
The ability to implicitly work in an exponentially large feature space is a unique advantage of quantum computers for machine learning tasks.


\subsection{24.3.3 Quantum\sphinxhyphen{}Inspired Classical Algorithms}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-inspired-classical-algorithms}}
\sphinxAtStartPar
Quantum principles can also inspire new classical algorithms for neural networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{tensor\PYGZus{}network\PYGZus{}layer}\PYG{p}{(}\PYG{n}{input\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{weight\PYGZus{}tensor}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implement a tensor network layer for neural networks}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} input\PYGZus{}tensor: Input data tensor}
\PYG{l+s+sd}{    \PYGZhy{} weight\PYGZus{}tensor: Weight tensor}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} output\PYGZus{}tensor: Output after tensor contraction}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Contract along appropriate dimensions}
    \PYG{n}{output\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tensordot}\PYG{p}{(}\PYG{n}{input\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{weight\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{axes}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{output\PYGZus{}tensor}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{TensorNetworkModel}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simple tensor network model inspired by quantum computing}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}dim: Input dimension}
\PYG{l+s+sd}{        \PYGZhy{} hidden\PYGZus{}dim: Hidden dimension}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}dim: Output dimension}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}dim} \PYG{o}{=} \PYG{n}{input\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}dim} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}dim}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}dim} \PYG{o}{=} \PYG{n}{output\PYGZus{}dim}
        
        \PYG{c+c1}{\PYGZsh{} Initialize weights as tensors}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{input\PYGZus{}dim}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{output\PYGZus{}dim}\PYG{p}{)} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output: Network output}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} First layer}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{tensor\PYGZus{}network\PYGZus{}layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W1}\PYG{p}{)}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Nonlinearity}
        
        \PYG{c+c1}{\PYGZsh{} Second layer}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{tensor\PYGZus{}network\PYGZus{}layer}\PYG{p}{(}\PYG{n}{h}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W2}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{n\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the tensor network model}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} X\PYGZus{}train: Training inputs}
\PYG{l+s+sd}{        \PYGZhy{} y\PYGZus{}train: Training targets}
\PYG{l+s+sd}{        \PYGZhy{} learning\PYGZus{}rate: Learning rate}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}epochs: Number of training epochs}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} loss\PYGZus{}history: Training loss history}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{loss\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{total\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
            
            \PYG{c+c1}{\PYGZsh{} Shuffle training data}
            \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{permutation}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{X\PYGZus{}shuffled} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{]}
            \PYG{n}{y\PYGZus{}shuffled} \PYG{o}{=} \PYG{n}{y\PYGZus{}train}\PYG{p}{[}\PYG{n}{indices}\PYG{p}{]}
            
            \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{X\PYGZus{}shuffled}\PYG{p}{,} \PYG{n}{y\PYGZus{}shuffled}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Forward pass}
                \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Compute loss (mean squared error)}
                \PYG{n}{loss} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
                \PYG{n}{total\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}
                
                \PYG{c+c1}{\PYGZsh{} Backward pass (simplified gradient descent)}
                \PYG{c+c1}{\PYGZsh{} In a real implementation, backpropagation would be used}
                
                \PYG{c+c1}{\PYGZsh{} Output layer gradients}
                \PYG{n}{d\PYGZus{}output} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{output}\PYG{p}{)}
                \PYG{n}{d\PYGZus{}W2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{tensor\PYGZus{}network\PYGZus{}layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{d\PYGZus{}output}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Hidden layer gradients}
                \PYG{n}{d\PYGZus{}hidden} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{d\PYGZus{}output}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W2}\PYG{o}{.}\PYG{n}{T}\PYG{p}{)}
                \PYG{n}{d\PYGZus{}hidden\PYGZus{}input} \PYG{o}{=} \PYG{n}{d\PYGZus{}hidden} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{tanh}\PYG{p}{(}\PYG{n}{tensor\PYGZus{}network\PYGZus{}layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W1}\PYG{p}{)}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
                \PYG{n}{d\PYGZus{}W1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{outer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{d\PYGZus{}hidden\PYGZus{}input}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update weights}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W2} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{d\PYGZus{}W2}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{W1} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{d\PYGZus{}W1}
            
            \PYG{c+c1}{\PYGZsh{} Average loss for the epoch}
            \PYG{n}{avg\PYGZus{}loss} \PYG{o}{=} \PYG{n}{total\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
            \PYG{n}{loss\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{avg\PYGZus{}loss}\PYG{p}{)}
            
            \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{avg\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{loss\PYGZus{}history}
\end{sphinxVerbatim}

\sphinxAtStartPar
Tensor networks, inspired by quantum physics, offer efficient ways to represent and manipulate high\sphinxhyphen{}dimensional data, potentially leading to more powerful classical neural networks.


\section{24.4 Challenges and Open Questions}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:challenges-and-open-questions}}
\sphinxAtStartPar
While quantum computing shows promise for neural network applications, several challenges remain.


\subsection{24.4.1 Quantum Decoherence and Error Correction}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-decoherence-and-error-correction}}
\sphinxAtStartPar
Quantum systems are fragile and susceptible to environmental noise:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}decoherence}\PYG{p}{(}\PYG{n}{noise\PYGZus{}level}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate quantum decoherence effects}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} noise\PYGZus{}level: Level of simulated noise}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} results: Simulation results with different noise levels}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple circuit that should maintain coherence}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Create Bell state}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Noise\PYGZhy{}free simulation}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{counts}
    
    \PYG{c+c1}{\PYGZsh{} Simulate with noise}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{providers}\PYG{n+nn}{.}\PYG{n+nn}{aer}\PYG{n+nn}{.}\PYG{n+nn}{noise}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{NoiseModel}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{providers}\PYG{n+nn}{.}\PYG{n+nn}{aer}\PYG{n+nn}{.}\PYG{n+nn}{noise}\PYG{n+nn}{.}\PYG{n+nn}{errors}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{pauli\PYGZus{}error}\PYG{p}{,} \PYG{n}{depolarizing\PYGZus{}error}
    
    \PYG{c+c1}{\PYGZsh{} Create a noise model}
    \PYG{n}{noise\PYGZus{}model} \PYG{o}{=} \PYG{n}{NoiseModel}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Bit flip errors}
    \PYG{n}{error\PYGZus{}prob} \PYG{o}{=} \PYG{n}{noise\PYGZus{}level}
    \PYG{n}{bit\PYGZus{}flip} \PYG{o}{=} \PYG{n}{pauli\PYGZus{}error}\PYG{p}{(}\PYG{p}{[}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{error\PYGZus{}prob}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{error\PYGZus{}prob}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{noise\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}all\PYGZus{}qubit\PYGZus{}quantum\PYGZus{}error}\PYG{p}{(}\PYG{n}{bit\PYGZus{}flip}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Depolarizing error (general quantum noise)}
    \PYG{n}{depol\PYGZus{}error} \PYG{o}{=} \PYG{n}{depolarizing\PYGZus{}error}\PYG{p}{(}\PYG{n}{noise\PYGZus{}level}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{noise\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}all\PYGZus{}qubit\PYGZus{}quantum\PYGZus{}error}\PYG{p}{(}\PYG{n}{depol\PYGZus{}error}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate with noise}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{noise\PYGZus{}model}\PYG{o}{=}\PYG{n}{noise\PYGZus{}model}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    \PYG{n}{results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{noisy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{counts}
    
    \PYG{k}{return} \PYG{n}{results}\PYG{p}{,} \PYG{n}{qc}
\end{sphinxVerbatim}

\sphinxAtStartPar
Quantum error correction and fault\sphinxhyphen{}tolerant quantum computing are essential for practical quantum neural networks, but they require significant qubit overhead.


\subsection{24.4.2 Quantum\sphinxhyphen{}Classical Interfaces}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-classical-interfaces}}
\sphinxAtStartPar
Efficient data transfer between classical and quantum systems is a key challenge:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}classical\PYGZus{}interface\PYGZus{}demo}\PYG{p}{(}\PYG{n}{classical\PYGZus{}data}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate the quantum\PYGZhy{}classical interface}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} classical\PYGZus{}data: Classical data to encode}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} results: Results of quantum processing}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Normalize and prepare classical data}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{classical\PYGZus{}data}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Warning: Data dimension (}\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{classical\PYGZus{}data}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{) exceeds qubit count (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{n\PYGZus{}qubits}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize data}
    \PYG{n}{norm\PYGZus{}data} \PYG{o}{=} \PYG{n}{classical\PYGZus{}data} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{classical\PYGZus{}data}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create encoding circuit}
    \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Amplitude encoding (simplified)}
    \PYG{c+c1}{\PYGZsh{} In reality, this would require more complex circuits for arbitrary data}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{norm\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{ry}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arcsin}\PYG{p}{(}\PYG{n}{value}\PYG{p}{)}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply entanglement}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Apply a parameterized rotation (quantum processing)}
    \PYG{n}{theta} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Measure all qubits}
    \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Simulate}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Process results (decode)}
    \PYG{c+c1}{\PYGZsh{} Here we simply return the measurement results}
    \PYG{c+c1}{\PYGZsh{} In a real application, we would need to post\PYGZhy{}process these results}
    
    \PYG{k}{return} \PYG{n}{counts}\PYG{p}{,} \PYG{n}{qc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{batch\PYGZus{}quantum\PYGZus{}processing}\PYG{p}{(}\PYG{n}{data\PYGZus{}batch}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate batch processing for quantum\PYGZhy{}classical interface}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} data\PYGZus{}batch: Batch of classical data}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} results: Results of batch processing}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{results} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{circuits} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Create a quantum circuit for each data point}
    \PYG{k}{for} \PYG{n}{data\PYGZus{}point} \PYG{o+ow}{in} \PYG{n}{data\PYGZus{}batch}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Encode data}
        \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simplified amplitude encoding}
        \PYG{n}{norm\PYGZus{}data} \PYG{o}{=} \PYG{n}{data\PYGZus{}point} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{data\PYGZus{}point}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{norm\PYGZus{}data}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{ry}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arcsin}\PYG{p}{(}\PYG{n}{value}\PYG{p}{)}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply quantum processing}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{rz}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Measure}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n}{circuits}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{qc}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Batch execution}
    \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{circuits}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Extract results}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{circuits}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{counts} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{circuits}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{results}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{counts}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{results}
\end{sphinxVerbatim}

\sphinxAtStartPar
Efficient data encoding and result extraction are critical bottlenecks for quantum neural networks, as they often require exponential resources in the classical\sphinxhyphen{}quantum interface.


\subsection{24.4.3 Quantum Machine Learning Theory}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:quantum-machine-learning-theory}}
\sphinxAtStartPar
We need better theoretical understanding of when quantum neural networks offer advantages:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{quantum\PYGZus{}classical\PYGZus{}expressivity\PYGZus{}comparison}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compare expressivity of quantum vs classical neural networks}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}qubits: Number of qubits in quantum circuit}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}layers: Number of layers in both networks}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} expressivity\PYGZus{}metrics: Metrics comparing expressivity}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create a parameterized quantum circuit}
    \PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters} \PYG{o}{=} \PYG{n}{create\PYGZus{}quantum\PYGZus{}neural\PYGZus{}network}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}params\PYGZus{}quantum} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate state space dimension}
    \PYG{n}{quantum\PYGZus{}state\PYGZus{}dim} \PYG{o}{=} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{o}{*}\PYG{n}{n\PYGZus{}qubits}
    
    \PYG{c+c1}{\PYGZsh{} Create a classical neural network with similar parameter count}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
    
    \PYG{c+c1}{\PYGZsh{} Design classical network to have similar parameter count}
    \PYG{n}{hidden\PYGZus{}dim} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{n\PYGZus{}params\PYGZus{}quantum}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{classical\PYGZus{}model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}dim}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Count parameters in classical model}
    \PYG{n}{n\PYGZus{}params\PYGZus{}classical} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{numel}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{classical\PYGZus{}model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate classical network\PYGZsq{}s representational capacity}
    \PYG{c+c1}{\PYGZsh{} (simplified metric)}
    \PYG{n}{classical\PYGZus{}capacity} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}dim}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Compare expressivity}
    \PYG{n}{expressivity\PYGZus{}metrics} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quantum\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}params\PYGZus{}quantum}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{classical\PYGZus{}parameters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}params\PYGZus{}classical}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quantum\PYGZus{}state\PYGZus{}space\PYGZus{}dimension}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{quantum\PYGZus{}state\PYGZus{}dim}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{classical\PYGZus{}capacity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{classical\PYGZus{}capacity}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quantum\PYGZus{}advantage\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{quantum\PYGZus{}state\PYGZus{}dim} \PYG{o}{/} \PYG{n}{n\PYGZus{}params\PYGZus{}quantum}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{classical\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{classical\PYGZus{}capacity} \PYG{o}{/} \PYG{n}{n\PYGZus{}params\PYGZus{}classical}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{expressivity\PYGZus{}metrics}
\end{sphinxVerbatim}

\sphinxAtStartPar
The promise of quantum neural networks lies in their potentially exponential expressivity with respect to parameter count, but theoretical guarantees are still being developed.


\section{24.5 Code Lab: Implementing a Quantum\sphinxhyphen{}Enhanced Neural Network}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:code-lab-implementing-a-quantum-enhanced-neural-network}}
\sphinxAtStartPar
Let’s implement a simple hybrid quantum\sphinxhyphen{}classical neural network for a classification task:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{QuantumCircuit}\PYG{p}{,} \PYG{n}{Aer}\PYG{p}{,} \PYG{n}{execute}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{qiskit}\PYG{n+nn}{.}\PYG{n+nn}{circuit}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Parameter}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{QuantumEnhancedNN}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Hybrid quantum\PYGZhy{}classical neural network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}qubits: Number of qubits in quantum circuit}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}layers: Number of layers in quantum circuit}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits} \PYG{o}{=} \PYG{n}{n\PYGZus{}qubits}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}layers} \PYG{o}{=} \PYG{n}{n\PYGZus{}layers}
        
        \PYG{c+c1}{\PYGZsh{} Create quantum circuit}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{qc}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}create\PYGZus{}quantum\PYGZus{}circuit}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}params} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Initialize parameters randomly}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{param\PYGZus{}values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}params}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        
        \PYG{c+c1}{\PYGZsh{} Classical post\PYGZhy{}processing layer}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}weight} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}bias} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
        
        \PYG{c+c1}{\PYGZsh{} Training history}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{loss\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}create\PYGZus{}quantum\PYGZus{}circuit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create parameterized quantum circuit\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{qc} \PYG{o}{=} \PYG{n}{QuantumCircuit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create parameters}
        \PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Initial Hadamard layer}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{qc}\PYG{o}{.}\PYG{n}{h}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Parameterized layers}
        \PYG{k}{for} \PYG{n}{layer} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}layers}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Rotation gates with parameters}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{theta} \PYG{o}{=} \PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{θ\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{layer}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                \PYG{n}{parameters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{ry}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{,} \PYG{n}{i}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Entanglement}
            \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n}{i}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Connect last qubit to first (circular entanglement)}
            \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{qc}\PYG{o}{.}\PYG{n}{cx}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Measure expectation value of first qubit}
        \PYG{n}{qc}\PYG{o}{.}\PYG{n}{measure}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{qc}\PYG{p}{,} \PYG{n}{parameters}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}encode\PYGZus{}input}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Encode classical input into quantum circuit parameters}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input data point}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} circuit\PYGZus{}params: Parameters for quantum circuit}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Use input data to set parameters of first layer}
        \PYG{n}{circuit\PYGZus{}params} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{param\PYGZus{}values}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Encode data into the first layer parameters}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{feature} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Scale feature to appropriate range}
                \PYG{n}{scaled\PYGZus{}feature} \PYG{o}{=} \PYG{n}{feature} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}  \PYG{c+c1}{\PYGZsh{} Scale to [0, π]}
                \PYG{n}{circuit\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{scaled\PYGZus{}feature}
        
        \PYG{k}{return} \PYG{n}{circuit\PYGZus{}params}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}quantum\PYGZus{}forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Run quantum circuit with encoded input}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input data point}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} expectation: Expectation value of measurement}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Encode input into circuit parameters}
        \PYG{n}{circuit\PYGZus{}params} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}encode\PYGZus{}input}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create parameter dictionary}
        \PYG{n}{param\PYGZus{}dict} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{,} \PYG{n}{circuit\PYGZus{}params}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Bind parameters}
        \PYG{n}{bound\PYGZus{}qc} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{qc}\PYG{o}{.}\PYG{n}{bind\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{param\PYGZus{}dict}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Execute circuit}
        \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{job} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
        \PYG{n}{result} \PYG{o}{=} \PYG{n}{job}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{counts} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{bound\PYGZus{}qc}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Calculate expectation value}
        \PYG{n}{expectation} \PYG{o}{=} \PYG{n}{counts}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}  \PYG{c+c1}{\PYGZsh{} Probability of measuring 0}
        
        \PYG{k}{return} \PYG{n}{expectation}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through hybrid network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input data point}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output: Network output}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Quantum layer}
        \PYG{n}{quantum\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}quantum\PYGZus{}forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Classical post\PYGZhy{}processing}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}output} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}weight} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}bias}
        
        \PYG{k}{return} \PYG{n}{output}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{n\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train the hybrid quantum\PYGZhy{}classical network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} X\PYGZus{}train: Training inputs}
\PYG{l+s+sd}{        \PYGZhy{} y\PYGZus{}train: Training targets (binary)}
\PYG{l+s+sd}{        \PYGZhy{} learning\PYGZus{}rate: Learning rate}
\PYG{l+s+sd}{        \PYGZhy{} n\PYGZus{}epochs: Number of training epochs}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mf}{0.0}
            
            \PYG{c+c1}{\PYGZsh{} Process each training example}
            \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Forward pass}
                \PYG{n}{pred} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Binary cross entropy loss}
                \PYG{n}{epsilon} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}10}  \PYG{c+c1}{\PYGZsh{} Small value to prevent log(0)}
                \PYG{k}{if} \PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                    \PYG{n}{loss} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{loss} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                
                \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}
                
                \PYG{c+c1}{\PYGZsh{} Parameter shift method for quantum gradients}
                \PYG{n}{quantum\PYGZus{}gradients} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}quantum\PYGZus{}gradients}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update quantum parameters}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{param\PYGZus{}values} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{quantum\PYGZus{}gradients}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update classical parameters}
                \PYG{n}{quantum\PYGZus{}output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}quantum\PYGZus{}forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Gradient for classical weight}
                \PYG{k}{if} \PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                    \PYG{n}{d\PYGZus{}weight} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{quantum\PYGZus{}output} \PYG{o}{/} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{d\PYGZus{}weight} \PYG{o}{=} \PYG{n}{quantum\PYGZus{}output} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Gradient for classical bias}
                \PYG{k}{if} \PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                    \PYG{n}{d\PYGZus{}bias} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{d\PYGZus{}bias} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{pred} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update classical parameters}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}weight} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{d\PYGZus{}weight}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}bias} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{d\PYGZus{}bias}
            
            \PYG{c+c1}{\PYGZsh{} Record average loss}
            \PYG{n}{avg\PYGZus{}loss} \PYG{o}{=} \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{loss\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{avg\PYGZus{}loss}\PYG{p}{)}
            
            \PYG{k}{if} \PYG{n}{epoch} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{10} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: Loss = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{avg\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}quantum\PYGZus{}gradients}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Calculate gradients for quantum parameters using parameter shift rule}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input data point}
\PYG{l+s+sd}{        \PYGZhy{} y: Target output}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} gradients: List of gradients for quantum parameters}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{gradients} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}params}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create shifted parameter sets}
            \PYG{n}{shift} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}
            
            \PYG{n}{plus\PYGZus{}params} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{param\PYGZus{}values}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{plus\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{shift}
            
            \PYG{n}{minus\PYGZus{}params} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{param\PYGZus{}values}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{minus\PYGZus{}params}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}}\PYG{o}{=} \PYG{n}{shift}
            
            \PYG{c+c1}{\PYGZsh{} Encode input}
            \PYG{n}{circuit\PYGZus{}params\PYGZus{}plus} \PYG{o}{=} \PYG{n}{plus\PYGZus{}params}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{circuit\PYGZus{}params\PYGZus{}minus} \PYG{o}{=} \PYG{n}{minus\PYGZus{}params}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
            
            \PYG{k}{for} \PYG{n}{j}\PYG{p}{,} \PYG{n}{feature} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{j} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{n\PYGZus{}qubits}\PYG{p}{:}
                    \PYG{n}{scaled\PYGZus{}feature} \PYG{o}{=} \PYG{n}{feature} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}
                    \PYG{n}{circuit\PYGZus{}params\PYGZus{}plus}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{scaled\PYGZus{}feature}
                    \PYG{n}{circuit\PYGZus{}params\PYGZus{}minus}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{scaled\PYGZus{}feature}
            
            \PYG{c+c1}{\PYGZsh{} Evaluate at shifted points}
            \PYG{n}{plus\PYGZus{}dict} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{,} \PYG{n}{circuit\PYGZus{}params\PYGZus{}plus}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{minus\PYGZus{}dict} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{,} \PYG{n}{circuit\PYGZus{}params\PYGZus{}minus}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Bind parameters}
            \PYG{n}{plus\PYGZus{}qc} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{qc}\PYG{o}{.}\PYG{n}{bind\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{plus\PYGZus{}dict}\PYG{p}{)}
            \PYG{n}{minus\PYGZus{}qc} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{qc}\PYG{o}{.}\PYG{n}{bind\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{minus\PYGZus{}dict}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Execute circuits}
            \PYG{n}{simulator} \PYG{o}{=} \PYG{n}{Aer}\PYG{o}{.}\PYG{n}{get\PYGZus{}backend}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qasm\PYGZus{}simulator}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{job\PYGZus{}plus} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{plus\PYGZus{}qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
            \PYG{n}{job\PYGZus{}minus} \PYG{o}{=} \PYG{n}{execute}\PYG{p}{(}\PYG{n}{minus\PYGZus{}qc}\PYG{p}{,} \PYG{n}{simulator}\PYG{p}{,} \PYG{n}{shots}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
            
            \PYG{n}{counts\PYGZus{}plus} \PYG{o}{=} \PYG{n}{job\PYGZus{}plus}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{plus\PYGZus{}qc}\PYG{p}{)}
            \PYG{n}{counts\PYGZus{}minus} \PYG{o}{=} \PYG{n}{job\PYGZus{}minus}\PYG{o}{.}\PYG{n}{result}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}counts}\PYG{p}{(}\PYG{n}{minus\PYGZus{}qc}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Calculate expectation values}
            \PYG{n}{expect\PYGZus{}plus} \PYG{o}{=} \PYG{n}{counts\PYGZus{}plus}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}
            \PYG{n}{expect\PYGZus{}minus} \PYG{o}{=} \PYG{n}{counts\PYGZus{}minus}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{1000}
            
            \PYG{c+c1}{\PYGZsh{} Calculate classical outputs}
            \PYG{n}{output\PYGZus{}plus} \PYG{o}{=} \PYG{n}{expect\PYGZus{}plus} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}weight} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}bias}
            \PYG{n}{output\PYGZus{}minus} \PYG{o}{=} \PYG{n}{expect\PYGZus{}minus} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}weight} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{classical\PYGZus{}bias}
            
            \PYG{c+c1}{\PYGZsh{} Calculate losses}
            \PYG{n}{epsilon} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}10}
            \PYG{k}{if} \PYG{n}{y} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{loss\PYGZus{}plus} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{output\PYGZus{}plus} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                \PYG{n}{loss\PYGZus{}minus} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{output\PYGZus{}minus} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{loss\PYGZus{}plus} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{output\PYGZus{}plus} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
                \PYG{n}{loss\PYGZus{}minus} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{output\PYGZus{}minus} \PYG{o}{+} \PYG{n}{epsilon}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Estimate gradient using parameter shift rule}
            \PYG{n}{gradient} \PYG{o}{=} \PYG{p}{(}\PYG{n}{loss\PYGZus{}plus} \PYG{o}{\PYGZhy{}} \PYG{n}{loss\PYGZus{}minus}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{shift}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{gradients}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{gradient}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{gradients}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{predict}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Make predictions for test data}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} X\PYGZus{}test: Test inputs}
\PYG{l+s+sd}{        \PYGZhy{} threshold: Classification threshold}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} predictions: Binary predictions}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{predictions} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{X\PYGZus{}test}\PYG{p}{:}
            \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
            \PYG{n}{prediction} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{k}{if} \PYG{n}{output} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{threshold} \PYG{k}{else} \PYG{l+m+mi}{0}
            \PYG{n}{predictions}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{prediction}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{predictions}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}loss}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Plot training loss history\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{loss\PYGZus{}history}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Example usage:}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}quantum\PYGZus{}classification\PYGZus{}demo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Run a demo of quantum\PYGZhy{}enhanced classification\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Generate synthetic binary classification data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{l+m+mi}{20}
    \PYG{n}{n\PYGZus{}features} \PYG{o}{=} \PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Create two clusters}
    \PYG{n}{X\PYGZus{}0} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}features}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{X\PYGZus{}1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}features}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{vstack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{X\PYGZus{}0}\PYG{p}{,} \PYG{n}{X\PYGZus{}1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{+} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize features}
    \PYG{n}{X} \PYG{o}{=} \PYG{p}{(}\PYG{n}{X} \PYG{o}{\PYGZhy{}} \PYG{n}{X}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n}{X}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create and train quantum model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{QuantumEnhancedNN}\PYG{p}{(}\PYG{n}{n\PYGZus{}qubits}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{n\PYGZus{}layers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{n\PYGZus{}epochs}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot decision boundary}
    \PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
    \PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
    \PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{,}
                          \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Make predictions for grid points}
    \PYG{n}{Z} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{model}\PYG{o}{.}\PYG{n}{forward}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Z} \PYG{o}{=} \PYG{n}{Z}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{RdBu}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{RdBu}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Quantum\PYGZhy{}Enhanced Neural Network Decision Boundary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training loss}
    \PYG{n}{loss\PYGZus{}fig} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{plot\PYGZus{}loss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}\PYG{p}{,} \PYG{n}{loss\PYGZus{}fig}

\PYG{c+c1}{\PYGZsh{} Run the demo}
\PYG{c+c1}{\PYGZsh{} model, loss\PYGZus{}fig = run\PYGZus{}quantum\PYGZus{}classification\PYGZus{}demo()}
\end{sphinxVerbatim}

\sphinxAtStartPar
This hybrid approach combines quantum computing’s potential advantages with classical neural network techniques, offering a practical path forward as quantum hardware continues to improve.


\section{24.6 Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Quantum computing offers unique capabilities} for neural network processing through superposition, entanglement, and quantum parallelism

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Quantum Neural Networks} can potentially represent complex functions with fewer parameters than classical counterparts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Quantum kernels} allow classical data to be mapped into exponentially large feature spaces

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hybrid quantum\sphinxhyphen{}classical approaches} currently offer the most practical path forward

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Significant challenges remain}, including quantum error correction, efficient data encoding, and clear theoretical understanding of quantum advantages

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{The field is rapidly evolving} with new algorithms, hardware, and theoretical insights

\end{itemize}


\section{24.7 Further Reading}
\label{\detokenize{part6/ch24_quantum_computing_neuroai:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Schuld, M., Sinayskiy, I., \& Petruccione, F. (2015). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S1574013714000598}{An introduction to quantum machine learning}. Contemporary Physics, 56(2), 172\sphinxhyphen{}185. Provides an accessible introduction to quantum machine learning concepts.

\item {} 
\sphinxAtStartPar
Biamonte, J., Wittek, P., Pancotti, N., Rebentrost, P., Wiebe, N., \& Lloyd, S. (2017). \sphinxhref{https://www.nature.com/articles/nature23474}{Quantum machine learning}. Nature, 549(7671), 195\sphinxhyphen{}202. Comprehensive overview of quantum approaches to machine learning.

\item {} 
\sphinxAtStartPar
Havlíček, V., Córcoles, A. D., Temme, K., Harrow, A. W., Kandala, A., Chow, J. M., \& Gambetta, J. M. (2019). \sphinxhref{https://www.nature.com/articles/s41586-019-0980-2}{Supervised learning with quantum\sphinxhyphen{}enhanced feature spaces}. Nature, 567(7747), 209\sphinxhyphen{}212. Demonstrates quantum kernel methods.

\item {} 
\sphinxAtStartPar
Cerezo, M., et al. (2021). \sphinxhref{https://www.nature.com/articles/s42254-021-00348-9}{Variational quantum algorithms}. Nature Reviews Physics, 3(9), 625\sphinxhyphen{}644. Reviews the theory and applications of variational quantum circuits for machine learning.

\item {} 
\sphinxAtStartPar
Abbas, A., et al. (2021). \sphinxhref{https://www.nature.com/articles/s41534-021-00372-8}{The power of quantum neural networks}. npj Quantum Information, 7(1), 1\sphinxhyphen{}8. Explores the theoretical capabilities and limitations of quantum neural networks.

\item {} 
\sphinxAtStartPar
Dunjko, V., \& Briegel, H. J. (2018). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S0034487718300053}{Machine learning \& artificial intelligence in the quantum domain: a review of recent progress}. Reports on Progress in Physics, 81(7), 074001. Reviews quantum approaches to machine learning and AI.

\end{itemize}

\sphinxstepscope


\chapter{Chapter 23: Lifelong Learning}
\label{\detokenize{part6/ch23_lifelong_learning:chapter-23-lifelong-learning}}\label{\detokenize{part6/ch23_lifelong_learning::doc}}

\section{23.0 Chapter Goals}
\label{\detokenize{part6/ch23_lifelong_learning:chapter-goals}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Understand the challenge of catastrophic forgetting in artificial neural networks

\item {} 
\sphinxAtStartPar
Explore biological solutions to the stability\sphinxhyphen{}plasticity dilemma

\item {} 
\sphinxAtStartPar
Learn about computational approaches for continual learning

\item {} 
\sphinxAtStartPar
Implement mechanisms for memory consolidation and replay

\end{itemize}


\section{23.1 The Stability\sphinxhyphen{}Plasticity Dilemma}
\label{\detokenize{part6/ch23_lifelong_learning:the-stability-plasticity-dilemma}}
\sphinxAtStartPar
One of the major limitations of current artificial neural networks is their inability to learn continuously throughout their lifecycle. While humans and other animals can accumulate knowledge over time, neural networks typically suffer from “catastrophic forgetting” \sphinxhyphen{} when trained on new tasks, they tend to rapidly overwrite previously learned information.

\sphinxAtStartPar
\sphinxincludegraphics{{continual_learning1}.svg}

\sphinxAtStartPar
This tension between maintaining stability (preserving existing knowledge) and having plasticity (acquiring new information) is fundamental to any learning system:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Too much stability}: The system becomes rigid and unable to learn new information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Too much plasticity}: The system constantly overwrites old knowledge with new experiences

\end{itemize}


\subsection{23.1.1 Catastrophic Forgetting Problem}
\label{\detokenize{part6/ch23_lifelong_learning:catastrophic-forgetting-problem}}
\sphinxAtStartPar
When an artificial neural network is trained sequentially on different tasks, learning new tasks can overwrite weights that were critical for previous tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{demonstrate\PYGZus{}catastrophic\PYGZus{}forgetting}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate catastrophic forgetting in a simple network}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Simplified experiment}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate two synthetic tasks}
    \PYG{n}{task\PYGZus{}A\PYGZus{}data} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{task\PYGZus{}A\PYGZus{}targets} \PYG{o}{=} \PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{task\PYGZus{}B\PYGZus{}data} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{task\PYGZus{}B\PYGZus{}targets} \PYG{o}{=} \PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{BCEWithLogitsLoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Initial training on task A}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pred\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}A} \PYG{o}{==} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}A}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{output\PYGZus{}B} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{pred\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output\PYGZus{}B} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}B} \PYG{o}{==} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}B}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Switch to training on task B}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate}
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pred\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{model}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}data}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}A} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}A} \PYG{o}{==} \PYG{n}{task\PYGZus{}A\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}A}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            
            \PYG{n}{pred\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{output} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{acc\PYGZus{}B} \PYG{o}{=} \PYG{p}{(}\PYG{n}{pred\PYGZus{}B} \PYG{o}{==} \PYG{n}{task\PYGZus{}B\PYGZus{}targets}\PYG{p}{)}\PYG{o}{.}\PYG{n}{float}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{acc\PYGZus{}B}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{task\PYGZus{}A\PYGZus{}accuracy}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task A Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{task\PYGZus{}B\PYGZus{}accuracy}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task B Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Switch to Task B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Steps}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Catastrophic Forgetting Demonstration}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Running this function would show how accuracy on Task A drops rapidly }
\PYG{c+c1}{\PYGZsh{} when the model is trained on Task B}
\end{sphinxVerbatim}

\sphinxAtStartPar
This code demonstrates the classic catastrophic forgetting problem: as the network learns Task B, its performance on Task A deteriorates rapidly. This is because the network parameters needed for Task A are overwritten by those needed for Task B.


\section{23.2 Biological Solutions for Lifelong Learning}
\label{\detokenize{part6/ch23_lifelong_learning:biological-solutions-for-lifelong-learning}}
\sphinxAtStartPar
The brain employs several mechanisms to balance stability and plasticity, allowing humans and animals to learn continuously throughout life without catastrophic forgetting.


\subsection{23.2.1 Complementary Learning Systems}
\label{\detokenize{part6/ch23_lifelong_learning:complementary-learning-systems}}
\sphinxAtStartPar
The brain manages memory through complementary systems that operate at different timescales:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Hippocampus}: Fast\sphinxhyphen{}learning system for episodic memories
\begin{itemize}
\item {} 
\sphinxAtStartPar
Rapidly encodes new experiences

\item {} 
\sphinxAtStartPar
High plasticity but limited capacity

\item {} 
\sphinxAtStartPar
Temporary storage for recent experiences

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Neocortex}: Slow\sphinxhyphen{}learning system for semantic knowledge
\begin{itemize}
\item {} 
\sphinxAtStartPar
Gradually integrates information over time

\item {} 
\sphinxAtStartPar
More stable weights for long\sphinxhyphen{}term storage

\item {} 
\sphinxAtStartPar
Learns general patterns across many experiences

\end{itemize}

\end{enumerate}

\sphinxAtStartPar
This division allows new information to be quickly stored in the hippocampus while being slowly transferred to the neocortex through a process called “consolidation.”

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ComplementaryLearningSystems}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{fast\PYGZus{}learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{consolidation\PYGZus{}strength}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Fast\PYGZhy{}learning episodic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}  \PYG{c+c1}{\PYGZsh{} Slow\PYGZhy{}learning semantic memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fast\PYGZus{}learn\PYGZus{}rate} \PYG{o}{=} \PYG{n}{fast\PYGZus{}learn\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate} \PYG{o}{=} \PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength} \PYG{o}{=} \PYG{n}{consolidation\PYGZus{}strength}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Learn a new experience\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} First, store in hippocampus (fast learning)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{experience}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Then, slowly integrate into neocortex}
        \PYG{k}{if} \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Update existing knowledge}
            \PYG{n}{current} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{current}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{p}{)} \PYG{o}{+} 
                           \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{slow\PYGZus{}learn\PYGZus{}rate}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{current}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength}
            \PYG{p}{\PYGZcb{}}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create new knowledge}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{features}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}
            \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{consolidate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{replay\PYGZus{}count}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Consolidate memories from hippocampus to neocortex\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Simulate memory replay during sleep}
        \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{replay\PYGZus{}count}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Replay random experiences from hippocampus}
                \PYG{n}{replay\PYGZus{}idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{replay\PYGZus{}experience} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hippocampus}\PYG{p}{[}\PYG{n}{replay\PYGZus{}idx}\PYG{p}{]}
                
                \PYG{c+c1}{\PYGZsh{} Strengthen in neocortex}
                \PYG{n}{concept} \PYG{o}{=} \PYG{n}{replay\PYGZus{}experience}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{concept}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
                \PYG{k}{if} \PYG{n}{concept} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{:}
                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{neocortex}\PYG{p}{[}\PYG{n}{concept}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{importance}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{consolidation\PYGZus{}strength}
\end{sphinxVerbatim}


\subsection{23.2.2 Synaptic Consolidation Mechanisms}
\label{\detokenize{part6/ch23_lifelong_learning:synaptic-consolidation-mechanisms}}
\sphinxAtStartPar
In biological brains, synapses important for existing memories become less plastic over time through several mechanisms:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Structural changes}: Formation of dendritic spines and physical growth of synaptic connections

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Protein synthesis}: Creation of proteins that stabilize important synapses

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Synaptic tagging}: “Tagging” of important synapses for later consolidation

\end{enumerate}

\sphinxAtStartPar
These mechanisms create a “continuum of plasticity” across the brain’s synapses, where some connections remain plastic while others become more stable.


\subsection{23.2.3 Neuromodulation of Learning Rates}
\label{\detokenize{part6/ch23_lifelong_learning:neuromodulation-of-learning-rates}}
\sphinxAtStartPar
Neuromodulatory systems (using chemicals like dopamine, acetylcholine, and norepinephrine) regulate plasticity based on context:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dopamine}: Signals importance/reward, enhancing learning for valuable experiences

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Acetylcholine}: Modulates attention and encoding of new information

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Norepinephrine}: Adjusts overall plasticity based on surprise/novelty

\end{itemize}

\sphinxAtStartPar
This adaptive regulation helps prioritize what should be learned and retained.


\section{23.3 Computational Approaches to Continual Learning}
\label{\detokenize{part6/ch23_lifelong_learning:computational-approaches-to-continual-learning}}
\sphinxAtStartPar
Inspired by biological mechanisms, several computational approaches have been developed to enable continual learning in artificial systems.


\subsection{23.3.1 Memory Replay Techniques}
\label{\detokenize{part6/ch23_lifelong_learning:memory-replay-techniques}}
\sphinxAtStartPar
One of the most successful approaches involves replaying past experiences to maintain performance on previous tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ExperienceReplayBuffer}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{capacity}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Experience replay buffer for continual learning}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} capacity: Maximum number of experiences to store}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity} \PYG{o}{=} \PYG{n}{capacity}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{experience}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add an experience to the buffer\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{k+kc}{None}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position}\PYG{p}{]} \PYG{o}{=} \PYG{n}{experience}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{position} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{capacity}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Sample a batch of experiences randomly\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{k}{return} \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{indices}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{is\PYGZus{}empty}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Check if buffer is empty\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{buffer}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{0}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}with\PYGZus{}replay}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{new\PYGZus{}data}\PYG{p}{,} \PYG{n}{replay\PYGZus{}buffer}\PYG{p}{,} \PYG{n}{optimizer}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Train a model using experience replay to prevent forgetting\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Add new experiences to buffer}
    \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{new\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{new\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Train with a mix of new data and replayed experiences}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Multiple passes through the data}
        \PYG{c+c1}{\PYGZsh{} Sample from replay buffer}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{is\PYGZus{}empty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{replayed} \PYG{o}{=} \PYG{n}{replay\PYGZus{}buffer}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{)}
            \PYG{n}{x\PYGZus{}replay} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{x} \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n}{replayed}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{y\PYGZus{}replay} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{y} \PYG{k}{for} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n}{replayed}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{c+c1}{\PYGZsh{} Update model with replayed data}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x\PYGZus{}replay}\PYG{p}{)}
            \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{y\PYGZus{}replay}\PYG{p}{)}
            \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}
\end{sphinxVerbatim}

\sphinxAtStartPar
There are various forms of replay:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Exact Replay}: Store and replay actual data points

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Generative Replay}: Train a generative model to produce synthetic examples of past tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Feature Replay}: Store and replay high\sphinxhyphen{}level features rather than raw inputs

\end{enumerate}


\subsection{23.3.2 Regularization\sphinxhyphen{}Based Methods}
\label{\detokenize{part6/ch23_lifelong_learning:regularization-based-methods}}
\sphinxAtStartPar
Instead of explicitly storing past data, regularization methods constrain weight updates to prevent overwriting important parameters:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{elastic\PYGZus{}weight\PYGZus{}consolidation}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{new\PYGZus{}data}\PYG{p}{,} \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{,} \PYG{n}{old\PYGZus{}params}\PYG{p}{,} 
                                \PYG{n}{lambda\PYGZus{}reg}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{optimizer}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{criterion}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implement Elastic Weight Consolidation (EWC) for continual learning}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} model: Neural network model}
\PYG{l+s+sd}{    \PYGZhy{} new\PYGZus{}data: Data for the new task (x, y)}
\PYG{l+s+sd}{    \PYGZhy{} fisher\PYGZus{}diag: Diagonal of the Fisher information matrix from previous task}
\PYG{l+s+sd}{    \PYGZhy{} old\PYGZus{}params: Parameters from after learning the previous task}
\PYG{l+s+sd}{    \PYGZhy{} lambda\PYGZus{}reg: Regularization strength}
\PYG{l+s+sd}{    \PYGZhy{} optimizer: Optimizer for new task}
\PYG{l+s+sd}{    \PYGZhy{} criterion: Loss function}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} Updated model}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} If no optimizer is provided, create one}
    \PYG{k}{if} \PYG{n}{optimizer} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} If no criterion is provided, use MSE}
    \PYG{k}{if} \PYG{n}{criterion} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training loop}
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{new\PYGZus{}data}
        
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Task loss}
        \PYG{n}{task\PYGZus{}loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} EWC regularization loss}
        \PYG{n}{ewc\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Calculate weighted squared distance from old parameters}
                \PYG{n}{ewc\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{p}{(}\PYG{n}{fisher\PYGZus{}diag}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{*} 
                            \PYG{p}{(}\PYG{n}{param} \PYG{o}{\PYGZhy{}} \PYG{n}{old\PYGZus{}params}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{pow}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Combined loss}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{task\PYGZus{}loss} \PYG{o}{+} \PYG{n}{lambda\PYGZus{}reg} \PYG{o}{*} \PYG{n}{ewc\PYGZus{}loss}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass and optimization}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{model}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}fisher\PYGZus{}diagonal}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{criterion}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Compute diagonal of the Fisher Information Matrix}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} model: Neural network model}
\PYG{l+s+sd}{    \PYGZhy{} data: Data samples (x, y)}
\PYG{l+s+sd}{    \PYGZhy{} criterion: Loss function}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} fisher\PYGZus{}diag: Dictionary of parameter names to Fisher diagonal values}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{fisher\PYGZus{}diag} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Store current parameters}
    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{param}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute Fisher diagonal}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Set to evaluation mode}
    
    \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{o}{*}\PYG{n}{data}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{model}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute loss}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{y}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass to get gradients}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add squared gradients to Fisher diagonal}
        \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{param}\PYG{o}{.}\PYG{n}{grad} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{n}{param}\PYG{o}{.}\PYG{n}{grad}\PYG{o}{.}\PYG{n}{pow}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Normalize by number of samples}
    \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{:}
        \PYG{n}{fisher\PYGZus{}diag}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{fisher\PYGZus{}diag}
\end{sphinxVerbatim}

\sphinxAtStartPar
Popular regularization methods include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Elastic Weight Consolidation (EWC)}: Uses Fisher information to estimate parameter importance

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Synaptic Intelligence}: Measures the contribution of each parameter during training

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Memory Aware Synapses}: Estimates importance based on the sensitivity of output to each weight

\end{enumerate}


\subsection{23.3.3 Architecture\sphinxhyphen{}Based Approaches}
\label{\detokenize{part6/ch23_lifelong_learning:architecture-based-approaches}}
\sphinxAtStartPar
Some approaches modify the network architecture itself to accommodate continual learning:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Progressive Neural Networks}: Add new columns for each new task while freezing previous ones

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Dynamically Expanding Networks}: Grow the network when needed for new tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Context\sphinxhyphen{}Dependent Gating}: Route information differently depending on the task

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ProgressiveNetwork}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Progressive Neural Network that adds columns for new tasks}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} input\PYGZus{}size: Dimension of input features}
\PYG{l+s+sd}{        \PYGZhy{} hidden\PYGZus{}size: Dimension of hidden layer}
\PYG{l+s+sd}{        \PYGZhy{} output\PYGZus{}size: Dimension of output}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{adapters} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size} \PYG{o}{=} \PYG{n}{input\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size} \PYG{o}{=} \PYG{n}{hidden\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}size} \PYG{o}{=} \PYG{n}{output\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Add first column}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{add\PYGZus{}column}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add\PYGZus{}column}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add a new column for a new task\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{column\PYGZus{}id} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create new column}
        \PYG{n}{column} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{output\PYGZus{}size}\PYG{p}{)}
        \PYG{p}{)}
        
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{column}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create lateral connections from previous columns}
        \PYG{k}{if} \PYG{n}{column\PYGZus{}id} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{adapters} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ModuleList}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{for} \PYG{n}{prev\PYGZus{}col} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{column\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Create adapter from previous column\PYGZsq{}s hidden layer}
                \PYG{n}{adapter} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{bias}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
                \PYG{n}{adapters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{adapter}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{adapters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{adapters}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Forward pass through the network}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} x: Input tensor}
\PYG{l+s+sd}{        \PYGZhy{} task\PYGZus{}id: ID of the task to perform}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} output: Network output for the specified task}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n}{task\PYGZus{}id} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Task ID }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{task\PYGZus{}id}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ out of range (only }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ tasks learned)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Get the column for this task}
        \PYG{n}{column} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} For the first column, just do a standard forward pass}
        \PYG{k}{if} \PYG{n}{task\PYGZus{}id} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{column}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} For later columns, need to include lateral connections}
        \PYG{c+c1}{\PYGZsh{} Extract features from first layer of current column}
        \PYG{n}{first\PYGZus{}layer} \PYG{o}{=} \PYG{n}{column}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{first\PYGZus{}layer}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add features from lateral connections}
        \PYG{n}{adapters} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{adapters}\PYG{p}{[}\PYG{n}{task\PYGZus{}id} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{adapter} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{adapters}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{prev\PYGZus{}h} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{h} \PYG{o}{+}\PYG{o}{=} \PYG{n}{adapter}\PYG{p}{(}\PYG{n}{prev\PYGZus{}h}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Apply final layer}
        \PYG{n}{output} \PYG{o}{=} \PYG{n}{column}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{(}\PYG{n}{h}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{output}
\end{sphinxVerbatim}


\subsection{23.3.4 Meta\sphinxhyphen{}Learning Approaches}
\label{\detokenize{part6/ch23_lifelong_learning:meta-learning-approaches}}
\sphinxAtStartPar
Meta\sphinxhyphen{}learning (“learning to learn”) approaches aim to discover algorithms or network structures that naturally resist catastrophic forgetting:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MetaContinualLearner}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{meta\PYGZus{}lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Meta\PYGZhy{}learning approach for continual learning}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} model: Base model to train}
\PYG{l+s+sd}{        \PYGZhy{} meta\PYGZus{}lr: Meta\PYGZhy{}learning rate}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n}{model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{meta\PYGZus{}lr}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{learn\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Learn a specific task\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Create optimizer for this task if it doesn\PYGZsq{}t exist}
        \PYG{k}{if} \PYG{n}{task\PYGZus{}id} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{lr}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{MSELoss}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{optimizer} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}
        \PYG{n}{criterion} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Save initial weights}
        \PYG{n}{initial\PYGZus{}weights} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{name}\PYG{p}{:} \PYG{n}{param}\PYG{o}{.}\PYG{n}{clone}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{param} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{named\PYGZus{}parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
        
        \PYG{c+c1}{\PYGZsh{} First, compute gradients on the current task}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{targets}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Meta\PYGZhy{}update: consider performance on all previous tasks}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{meta\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{for} \PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{,} \PYG{n}{prev\PYGZus{}optimizer} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}optimizers}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{prev\PYGZus{}task\PYGZus{}id} \PYG{o}{!=} \PYG{n}{task\PYGZus{}id}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Sample data from previous task (simplified)}
                \PYG{n}{prev\PYGZus{}data} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}task\PYGZus{}sample}\PYG{p}{(}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{)}
                \PYG{n}{prev\PYGZus{}targets} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}task\PYGZus{}targets}\PYG{p}{(}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Evaluate on previous task}
                \PYG{n}{prev\PYGZus{}outputs} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{prev\PYGZus{}data}\PYG{p}{)}
                \PYG{n}{prev\PYGZus{}loss} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}losses}\PYG{p}{[}\PYG{n}{prev\PYGZus{}task\PYGZus{}id}\PYG{p}{]}\PYG{p}{(}\PYG{n}{prev\PYGZus{}outputs}\PYG{p}{,} \PYG{n}{prev\PYGZus{}targets}\PYG{p}{)}
                \PYG{n}{meta\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{prev\PYGZus{}loss}
        
        \PYG{c+c1}{\PYGZsh{} Include current task loss}
        \PYG{n}{meta\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}
        
        \PYG{c+c1}{\PYGZsh{} Update model using meta\PYGZhy{}loss}
        \PYG{n}{meta\PYGZus{}loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{meta\PYGZus{}optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}task\PYGZus{}sample}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Get a sample from a task (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real implementation, this would retrieve stored examples}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}task\PYGZus{}targets}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Get targets for a task sample (placeholder)\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} In a real implementation, this would retrieve stored targets}
        \PYG{k}{return} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\end{sphinxVerbatim}


\section{23.4 Practical Applications of Lifelong Learning}
\label{\detokenize{part6/ch23_lifelong_learning:practical-applications-of-lifelong-learning}}

\subsection{23.4.1 Robotics and Embodied AI}
\label{\detokenize{part6/ch23_lifelong_learning:robotics-and-embodied-ai}}
\sphinxAtStartPar
Continual learning is crucial for robots that need to adapt to new environments and tasks without forgetting previously acquired skills:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Skill composition}: Learning new skills while reusing components of existing ones

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Environmental adaptation}: Adjusting to changes in the physical environment

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Human interaction}: Learning from ongoing human feedback and demonstration

\end{itemize}


\subsection{23.4.2 Personal AI Assistants}
\label{\detokenize{part6/ch23_lifelong_learning:personal-ai-assistants}}
\sphinxAtStartPar
Personalized AI systems must learn continuously from interactions with their users:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Preference adaptation}: Learning user preferences without forgetting basic functionality

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contextual awareness}: Adapting to changing user needs across different contexts

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Knowledge accumulation}: Building a growing knowledge base about the user and their world

\end{itemize}


\subsection{23.4.3 Autonomous Systems}
\label{\detokenize{part6/ch23_lifelong_learning:autonomous-systems}}
\sphinxAtStartPar
Systems operating in the real world need to learn and adapt throughout their operational lifetime:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}driving vehicles}: Adapting to new road conditions, traffic patterns, etc.

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Manufacturing systems}: Learning new production tasks while maintaining existing capabilities

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Medical diagnosis systems}: Updating diagnostic models with new medical knowledge

\end{itemize}


\section{23.5 Code Lab: Implementing a Replay\sphinxhyphen{}Based Continual Learning System}
\label{\detokenize{part6/ch23_lifelong_learning:code-lab-implementing-a-replay-based-continual-learning-system}}
\sphinxAtStartPar
Let’s implement a simple experience replay\sphinxhyphen{}based continual learning system and test it on a sequence of tasks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{n+nn}{.}\PYG{n+nn}{data}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{TensorDataset}\PYG{p}{,} \PYG{n}{DataLoader}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{28}\PYG{o}{*}\PYG{l+m+mi}{28}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{view}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Flatten}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x}

\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{ContinualLearner}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{optimizer}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{criterion}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Continual learning system using experience replay}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} model: Neural network model}
\PYG{l+s+sd}{        \PYGZhy{} memory\PYGZus{}size: Maximum size of memory buffer}
\PYG{l+s+sd}{        \PYGZhy{} optimizer: Optimizer function (will create Adam if None)}
\PYG{l+s+sd}{        \PYGZhy{} criterion: Loss function (will create CrossEntropyLoss if None)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model} \PYG{o}{=} \PYG{n}{model}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}size} \PYG{o}{=} \PYG{n}{memory\PYGZus{}size}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}y} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Create optimizer and loss function if not provided}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optimizer} \PYG{k}{if} \PYG{n}{optimizer} \PYG{k}{else} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{criterion} \PYG{o}{=} \PYG{n}{criterion} \PYG{k}{if} \PYG{n}{criterion} \PYG{k}{else} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Track performance}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}accuracies} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{add\PYGZus{}to\PYGZus{}memory}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Add examples to memory buffer\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{Tensor}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{Tensor}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{y} \PYG{o}{=} \PYG{n}{y}\PYG{o}{.}\PYG{n}{detach}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
            
        \PYG{c+c1}{\PYGZsh{} Convert single examples to lists if needed}
        \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}  \PYG{c+c1}{\PYGZsh{} Single image [C,H,W]}
            \PYG{n}{x} \PYG{o}{=} \PYG{n}{x}\PYG{o}{.}\PYG{n}{unsqueeze}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{n}{y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{p}{[}\PYG{n}{y}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add examples to memory}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{x}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}size}\PYG{p}{:}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{x}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}y}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{y}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{c+c1}{\PYGZsh{} Replace random item}
                \PYG{n}{idx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}size}\PYG{p}{)}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{x}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}y}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{y}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}memory\PYGZus{}batch}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Get a batch of examples from memory\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{:}
            \PYG{k}{return} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}
            
        \PYG{c+c1}{\PYGZsh{} Sample indices}
        \PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Gather examples}
        \PYG{n}{x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{indices}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{tensor}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}y}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{indices}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{k}{return} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{memory\PYGZus{}batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cpu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Train on a new task while using memory replay}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} task\PYGZus{}id: Identifier for the task}
\PYG{l+s+sd}{        \PYGZhy{} train\PYGZus{}loader: DataLoader for training data}
\PYG{l+s+sd}{        \PYGZhy{} epochs: Number of training epochs}
\PYG{l+s+sd}{        \PYGZhy{} memory\PYGZus{}batch\PYGZus{}size: Batch size for memory replay}
\PYG{l+s+sd}{        \PYGZhy{} device: Device to use for training}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{total\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
            \PYG{n}{correct} \PYG{o}{=} \PYG{l+m+mi}{0}
            \PYG{n}{total} \PYG{o}{=} \PYG{l+m+mi}{0}
            
            \PYG{k}{for} \PYG{n}{batch\PYGZus{}idx}\PYG{p}{,} \PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{target}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{train\PYGZus{}loader}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{data}\PYG{p}{,} \PYG{n}{target} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Regular update on current task data}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
                \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
                \PYG{n}{loss} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{target}\PYG{p}{)}
                \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Update using memory replay}
                \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{memory\PYGZus{}x}\PYG{p}{:}
                    \PYG{n}{memory\PYGZus{}x}\PYG{p}{,} \PYG{n}{memory\PYGZus{}y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}memory\PYGZus{}batch}\PYG{p}{(}\PYG{n}{memory\PYGZus{}batch\PYGZus{}size}\PYG{p}{)}
                    \PYG{k}{if} \PYG{n}{memory\PYGZus{}x} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
                        \PYG{n}{memory\PYGZus{}x}\PYG{p}{,} \PYG{n}{memory\PYGZus{}y} \PYG{o}{=} \PYG{n}{memory\PYGZus{}x}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}\PYG{p}{,} \PYG{n}{memory\PYGZus{}y}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
                        
                        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
                        \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{memory\PYGZus{}x}\PYG{p}{)}
                        \PYG{n}{replay\PYGZus{}loss} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{criterion}\PYG{p}{(}\PYG{n}{output}\PYG{p}{,} \PYG{n}{memory\PYGZus{}y}\PYG{p}{)}
                        \PYG{n}{replay\PYGZus{}loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
                        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Calculate accuracy}
                \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{predicted} \PYG{o}{=} \PYG{n}{output}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
                \PYG{n}{total} \PYG{o}{+}\PYG{o}{=} \PYG{n}{target}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
                \PYG{n}{correct} \PYG{o}{+}\PYG{o}{=} \PYG{n}{predicted}\PYG{o}{.}\PYG{n}{eq}\PYG{p}{(}\PYG{n}{target}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
                
                \PYG{c+c1}{\PYGZsh{} Store examples in memory}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}memory}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{target}\PYG{p}{)}
                
            \PYG{c+c1}{\PYGZsh{} Print epoch statistics}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{task\PYGZus{}id}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{: Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{l+m+mf}{100.}\PYG{o}{*}\PYG{n}{correct}\PYG{o}{/}\PYG{n}{total}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{test\PYGZus{}loader}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cpu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Evaluate performance on a specific task\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{correct} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{total} \PYG{o}{=} \PYG{l+m+mi}{0}
        
        \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{data}\PYG{p}{,} \PYG{n}{target} \PYG{o+ow}{in} \PYG{n}{test\PYGZus{}loader}\PYG{p}{:}
                \PYG{n}{data}\PYG{p}{,} \PYG{n}{target} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target}\PYG{o}{.}\PYG{n}{to}\PYG{p}{(}\PYG{n}{device}\PYG{p}{)}
                \PYG{n}{output} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
                
                \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{predicted} \PYG{o}{=} \PYG{n}{output}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
                \PYG{n}{total} \PYG{o}{+}\PYG{o}{=} \PYG{n}{target}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
                \PYG{n}{correct} \PYG{o}{+}\PYG{o}{=} \PYG{n}{predicted}\PYG{o}{.}\PYG{n}{eq}\PYG{p}{(}\PYG{n}{target}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{accuracy} \PYG{o}{=} \PYG{l+m+mf}{100.} \PYG{o}{*} \PYG{n}{correct} \PYG{o}{/} \PYG{n}{total}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{task\PYGZus{}accuracies}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{accuracy}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{task\PYGZus{}id}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s1}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{accuracy}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{evaluate\PYGZus{}all\PYGZus{}tasks}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task\PYGZus{}loaders}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cpu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Evaluate performance on all tasks\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{loader} \PYG{o+ow}{in} \PYG{n}{task\PYGZus{}loaders}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{accuracy} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{evaluate\PYGZus{}task}\PYG{p}{(}\PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{loader}\PYG{p}{,} \PYG{n}{device}\PYG{p}{)}
            \PYG{n}{results}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{n}{accuracy}
        \PYG{k}{return} \PYG{n}{results}

\PYG{c+c1}{\PYGZsh{} Example usage (with placeholder data)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{create\PYGZus{}rotated\PYGZus{}mnist\PYGZus{}tasks}\PYG{p}{(}\PYG{n}{n\PYGZus{}tasks}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create a series of tasks based on rotated MNIST digits\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} This is a placeholder \PYGZhy{} in a real implementation, you would load MNIST}
    \PYG{c+c1}{\PYGZsh{} and create rotated versions}
    
    \PYG{n}{task\PYGZus{}loaders} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    
    \PYG{k}{for} \PYG{n}{task\PYGZus{}id} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}tasks}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Simulate different rotations of MNIST}
        \PYG{n}{angle} \PYG{o}{=} \PYG{n}{task\PYGZus{}id} \PYG{o}{*} \PYG{l+m+mi}{15}  \PYG{c+c1}{\PYGZsh{} Rotate by 0°, 15°, 30°, etc.}
        
        \PYG{c+c1}{\PYGZsh{} Placeholder data \PYGZhy{} in real code, you would load and rotate MNIST}
        \PYG{c+c1}{\PYGZsh{} Here we just create random tensors of the right shape}
        \PYG{n}{train\PYGZus{}x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}
        \PYG{n}{train\PYGZus{}y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1000}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}x} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}y} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create data loaders}
        \PYG{n}{train\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{train\PYGZus{}x}\PYG{p}{,} \PYG{n}{train\PYGZus{}y}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{test\PYGZus{}x}\PYG{p}{,} \PYG{n}{test\PYGZus{}y}\PYG{p}{)}
        
        \PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{train\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{test\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{test\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{n}{batch\PYGZus{}size}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        
        \PYG{n}{task\PYGZus{}loaders}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{train}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{train\PYGZus{}loader}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{test}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{test\PYGZus{}loader}
        \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{task\PYGZus{}loaders}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}continual\PYGZus{}learning\PYGZus{}experiment}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Run a complete continual learning experiment\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleNN}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create learning systems}
    \PYG{n}{replay\PYGZus{}learner} \PYG{o}{=} \PYG{n}{ContinualLearner}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{)}
    \PYG{n}{vanilla\PYGZus{}learner} \PYG{o}{=} \PYG{n}{ContinualLearner}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{memory\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} No replay}
    
    \PYG{c+c1}{\PYGZsh{} Create tasks}
    \PYG{n}{task\PYGZus{}loaders} \PYG{o}{=} \PYG{n}{create\PYGZus{}rotated\PYGZus{}mnist\PYGZus{}tasks}\PYG{p}{(}\PYG{n}{n\PYGZus{}tasks}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Training and evaluation}
    \PYG{k}{for} \PYG{n}{task\PYGZus{}id} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Training on task }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{task\PYGZus{}id}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{task\PYGZus{}loaders}\PYG{p}{[}\PYG{n}{task\PYGZus{}id}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{train}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Train on the task}
        \PYG{n}{replay\PYGZus{}learner}\PYG{o}{.}\PYG{n}{train\PYGZus{}task}\PYG{p}{(}\PYG{n}{task\PYGZus{}id}\PYG{p}{,} \PYG{n}{train\PYGZus{}loader}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Evaluate on all previous tasks}
        \PYG{n}{test\PYGZus{}loaders} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{i}\PYG{p}{:} \PYG{n}{task\PYGZus{}loaders}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{test}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{task\PYGZus{}id}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
        \PYG{n}{results} \PYG{o}{=} \PYG{n}{replay\PYGZus{}learner}\PYG{o}{.}\PYG{n}{evaluate\PYGZus{}all\PYGZus{}tasks}\PYG{p}{(}\PYG{n}{test\PYGZus{}loaders}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Display current results}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Task }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{task\PYGZus{}id}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ complete. Current accuracies:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{t}\PYG{p}{,} \PYG{n}{acc} \PYG{o+ow}{in} \PYG{n}{results}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  Task }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{acc}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot final results}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{tasks} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{replay\PYGZus{}learner}\PYG{o}{.}\PYG{n}{task\PYGZus{}accuracies}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{accs} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{replay\PYGZus{}learner}\PYG{o}{.}\PYG{n}{task\PYGZus{}accuracies}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{tasks}\PYG{p}{,} \PYG{n}{accs}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Task ID}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy (}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Final Performance Across Tasks}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{tasks}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{plt}

\PYG{c+c1}{\PYGZsh{} Calling this function would run the complete experiment}
\PYG{c+c1}{\PYGZsh{} run\PYGZus{}continual\PYGZus{}learning\PYGZus{}experiment()}
\end{sphinxVerbatim}

\sphinxAtStartPar
This implementation demonstrates a simple replay\sphinxhyphen{}based approach to continual learning. The system maintains a buffer of past experiences and regularly replays them alongside new data to prevent catastrophic forgetting.


\section{23.6 Take\sphinxhyphen{}aways}
\label{\detokenize{part6/ch23_lifelong_learning:take-aways}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Catastrophic forgetting is a major challenge} for neural networks, preventing them from learning continuously like humans do

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Biological brains solve the stability\sphinxhyphen{}plasticity dilemma} through complementary learning systems, synaptic consolidation, and neuromodulation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Computational approaches to lifelong learning include}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Memory replay methods that revisit past experiences

\item {} 
\sphinxAtStartPar
Regularization techniques that constrain important weights

\item {} 
\sphinxAtStartPar
Architectural approaches that allocate new capacity for new tasks

\item {} 
\sphinxAtStartPar
Meta\sphinxhyphen{}learning strategies that learn how to avoid forgetting

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Practical applications of lifelong learning} are numerous in robotics, personal AI assistants, and autonomous systems

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Combining multiple approaches} often yields the best performance for real\sphinxhyphen{}world continual learning systems

\end{itemize}


\section{23.7 Further Reading}
\label{\detokenize{part6/ch23_lifelong_learning:further-reading}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Kirkpatrick, J., et al. (2017). \sphinxhref{https://www.pnas.org/content/114/13/3521}{Overcoming catastrophic forgetting in neural networks}. Proceedings of the National Academy of Sciences, 114(13), 3521\sphinxhyphen{}3526.

\item {} 
\sphinxAtStartPar
McClelland, J. L., McNaughton, B. L., \& O’Reilly, R. C. (1995). \sphinxhref{https://psycnet.apa.org/record/1995-42327-001}{Why there are complementary learning systems in the hippocampus and neocortex: Insights from the successes and failures of connectionist models of learning and memory}. Psychological Review, 102(3), 419\sphinxhyphen{}457.

\item {} 
\sphinxAtStartPar
Parisi, G. I., Kemker, R., Part, J. L., Kanan, C., \& Wermter, S. (2019). \sphinxhref{https://www.sciencedirect.com/science/article/pii/S0893608019300231}{Continual lifelong learning with neural networks: A review}. Neural Networks, 113, 54\sphinxhyphen{}71.

\item {} 
\sphinxAtStartPar
Zenke, F., Poole, B., \& Ganguli, S. (2017). \sphinxhref{http://proceedings.mlr.press/v70/zenke17a.html}{Continual learning through synaptic intelligence}. In Proceedings of the 34th International Conference on Machine Learning, 3987\sphinxhyphen{}3995.

\item {} 
\sphinxAtStartPar
Lopez\sphinxhyphen{}Paz, D., \& Ranzato, M. (2017). \sphinxhref{https://papers.nips.cc/paper/2017/hash/f87522788a2be2d171666752f97ddebb-Abstract.html}{Gradient episodic memory for continual learning}. In Advances in Neural Information Processing Systems, 6467\sphinxhyphen{}6476.

\item {} 
\sphinxAtStartPar
van de Ven, G. M., \& Tolias, A. S. (2019). \sphinxhref{https://arxiv.org/abs/1904.07734}{Three scenarios for continual learning}. arXiv preprint arXiv:1904.07734.

\end{itemize}

\sphinxstepscope


\part{Appendices}

\sphinxstepscope


\chapter{Glossary}
\label{\detokenize{appendices/glossary:glossary}}\label{\detokenize{appendices/glossary::doc}}
\sphinxAtStartPar
This glossary provides definitions for key terms used throughout the NeuroAI Handbook. Terms are organized alphabetically and include cross\sphinxhyphen{}references to relevant chapters where the concepts are discussed in detail.


\section{A}
\label{\detokenize{appendices/glossary:a}}
\sphinxAtStartPar
\sphinxstylestrong{Action Potential}\\
The electrical signal that neurons use to transmit information along their axons. Characterized by a rapid rise and fall in voltage caused by ion channel activity. Also called a “spike.”\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{Activation Function}\\
A mathematical function that determines the output of a neuron in artificial neural networks. Common examples include ReLU, sigmoid, and tanh.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}, {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Attention Mechanism}\\
A component in neural networks that allows the model to focus on specific parts of the input when generating output. Crucial for transformer models.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}, {[}Chapter 20 (Case Studies in NeuroAI){]}}

\sphinxAtStartPar
\sphinxstylestrong{Axon}\\
The long, slender projection of a neuron that conducts electrical impulses (action potentials) away from the cell body to target cells.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}


\section{B}
\label{\detokenize{appendices/glossary:b}}
\sphinxAtStartPar
\sphinxstylestrong{Backpropagation}\\
An algorithm for training artificial neural networks by calculating gradients of the loss function with respect to the network weights, propagating backward from the output.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Batch Normalization}\\
A technique used to improve the stability and performance of neural networks by normalizing the activations of each layer.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Basal Ganglia}\\
A group of subcortical nuclei involved in motor control, procedural learning, and action selection. Often analogized to reinforcement learning systems.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}


\section{C}
\label{\detokenize{appendices/glossary:c}}
\sphinxAtStartPar
\sphinxstylestrong{Channel Capacity}\\
In information theory, the maximum rate at which information can be reliably transmitted over a communication channel.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}

\sphinxAtStartPar
\sphinxstylestrong{Convolution}\\
An operation that applies a filter to an input, producing a feature map that indicates where features are located in the input. Fundamental to convolutional neural networks.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Corpus}\\
A large collection of text used for training language models.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}


\section{D}
\label{\detokenize{appendices/glossary:d}}
\sphinxAtStartPar
\sphinxstylestrong{Dendrite}\\
Branched extensions of neural cell bodies that receive signals from other neurons at synapses.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{Deep Learning}\\
A subset of machine learning based on artificial neural networks with multiple layers that progressively extract higher\sphinxhyphen{}level features from raw input.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Dropout}\\
A regularization technique in neural networks where randomly selected neurons are ignored during training to prevent overfitting.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}


\section{E}
\label{\detokenize{appendices/glossary:e}}
\sphinxAtStartPar
\sphinxstylestrong{Efficient Coding Hypothesis}\\
The hypothesis that sensory systems have evolved to efficiently represent natural stimuli by reducing redundancy and maximizing information transmission given metabolic constraints.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}

\sphinxAtStartPar
\sphinxstylestrong{Emergent Abilities}\\
Capabilities that appear in large language models only after reaching a certain scale, not present in smaller models.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Entropy}\\
A measure of uncertainty or randomness in a probability distribution, central to information theory.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}


\section{F}
\label{\detokenize{appendices/glossary:f}}
\sphinxAtStartPar
\sphinxstylestrong{Fine\sphinxhyphen{}tuning}\\
The process of taking a pre\sphinxhyphen{}trained model and adapting it to a specific task by training it further on a smaller, task\sphinxhyphen{}specific dataset.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Few\sphinxhyphen{}shot Learning}\\
A learning paradigm where a model can learn new tasks or concepts from only a few examples.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}


\section{G}
\label{\detokenize{appendices/glossary:g}}
\sphinxAtStartPar
\sphinxstylestrong{Gradient Descent}\\
An optimization algorithm that iteratively adjusts parameters to minimize a loss function by moving in the direction of steepest descent of the gradient.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Gated Recurrent Unit (GRU)}\\
A type of recurrent neural network architecture similar to LSTMs but with a simpler structure, designed to capture dependencies in sequential data.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}}


\section{H}
\label{\detokenize{appendices/glossary:h}}
\sphinxAtStartPar
\sphinxstylestrong{Hebbian Learning}\\
A theory describing how synaptic connections strengthen when neurons fire together (“cells that fire together wire together”).\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{Hippocampus}\\
A brain structure in the medial temporal lobe critical for forming new episodic memories and spatial navigation.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}


\section{I}
\label{\detokenize{appendices/glossary:i}}
\sphinxAtStartPar
\sphinxstylestrong{Information Bottleneck}\\
A framework that quantifies the tradeoff between compression (minimal representation) and prediction (preserving relevant information) in neural networks.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}


\section{K}
\label{\detokenize{appendices/glossary:k}}
\sphinxAtStartPar
\sphinxstylestrong{KL Divergence (Kullback\sphinxhyphen{}Leibler Divergence)}\\
A measure of how one probability distribution differs from a reference probability distribution.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}


\section{L}
\label{\detokenize{appendices/glossary:l}}
\sphinxAtStartPar
\sphinxstylestrong{Latent Factor Analysis via Dynamical Systems (LFADS)}\\
A deep learning method that uses recurrent neural networks to model neural population dynamics and extract meaningful low\sphinxhyphen{}dimensional representations from high\sphinxhyphen{}dimensional neural data.\\
\sphinxstyleemphasis{See: {[}Chapter 20 (Case Studies in NeuroAI){]}}

\sphinxAtStartPar
\sphinxstylestrong{LSTM (Long Short\sphinxhyphen{}Term Memory)}\\
A type of recurrent neural network architecture designed to address the vanishing gradient problem and better capture long\sphinxhyphen{}term dependencies in sequential data.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Large Language Model (LLM)}\\
Neural network models with billions to trillions of parameters, trained on vast text corpora, capable of generating human\sphinxhyphen{}like text and performing a wide range of language tasks.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}


\section{M}
\label{\detokenize{appendices/glossary:m}}
\sphinxAtStartPar
\sphinxstylestrong{Mutual Information}\\
A measure of the mutual dependence between two random variables, quantifying how much information one variable contains about another.\\
\sphinxstyleemphasis{See: {[}Chapter 7 (Information Theory){]}}

\sphinxAtStartPar
\sphinxstylestrong{Multi\sphinxhyphen{}head Attention}\\
An extension of the attention mechanism that runs multiple attention computations in parallel, allowing the model to focus on different parts of the input for different purposes.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}}


\section{N}
\label{\detokenize{appendices/glossary:n}}
\sphinxAtStartPar
\sphinxstylestrong{Neuromorphic Computing}\\
Computing systems that mimic the neuro\sphinxhyphen{}biological architectures of the brain, often implementing neural networks in hardware for efficiency.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{Neurotransmitter}\\
Chemical messengers that transmit signals across synapses from a neuron to a target cell.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}


\section{O}
\label{\detokenize{appendices/glossary:o}}
\sphinxAtStartPar
\sphinxstylestrong{Overfitting}\\
When a model learns the training data too well, including noise and outliers, resulting in poor generalization to new data.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}


\section{P}
\label{\detokenize{appendices/glossary:p}}
\sphinxAtStartPar
\sphinxstylestrong{Parameter\sphinxhyphen{}Efficient Fine\sphinxhyphen{}Tuning (PEFT)}\\
Techniques to adapt large language models to new tasks by updating only a small subset of parameters, saving computational resources.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Perceptron}\\
The simplest type of artificial neuron, which computes a weighted sum of its inputs, applies a step function, and outputs the result.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{PredNet}\\
A deep learning architecture that implements hierarchical predictive coding, modeling how the brain constantly generates predictions about incoming sensory information and learns from prediction errors.\\
\sphinxstyleemphasis{See: {[}Chapter 20 (Case Studies in NeuroAI){]}}

\sphinxAtStartPar
\sphinxstylestrong{Predictive Coding}\\
A neuroscience theory proposing that the brain constantly generates predictions about incoming sensory information and updates its internal models based on prediction errors.\\
\sphinxstyleemphasis{See: {[}Chapter 20 (Case Studies in NeuroAI){]}}

\sphinxAtStartPar
\sphinxstylestrong{Prioritized Experience Replay (PER)}\\
A biologically\sphinxhyphen{}inspired reinforcement learning technique that preferentially revisits experiences with high learning value, paralleling how the hippocampus selectively consolidates important memories.\\
\sphinxstyleemphasis{See: {[}Chapter 20 (Case Studies in NeuroAI){]}}

\sphinxAtStartPar
\sphinxstylestrong{Prompting}\\
The practice of crafting input text to elicit specific behaviors or responses from language models.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}


\section{R}
\label{\detokenize{appendices/glossary:r}}
\sphinxAtStartPar
\sphinxstylestrong{Recurrent Neural Network (RNN)}\\
A class of neural networks that have connections between nodes forming a directed graph along a temporal sequence, allowing them to exhibit temporal dynamic behavior.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Regularization}\\
Techniques used during model training to prevent overfitting by adding a penalty on the complexity of the model.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}}

\sphinxAtStartPar
\sphinxstylestrong{Reinforcement Learning from Human Feedback (RLHF)}\\
A technique to align language models with human preferences by training them using human feedback.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}


\section{S}
\label{\detokenize{appendices/glossary:s}}
\sphinxAtStartPar
\sphinxstylestrong{Scaling Law}\\
Empirical relationships showing how model performance improves as a function of model size, dataset size, and computation.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Self\sphinxhyphen{}Attention}\\
A mechanism where a sequence attends to itself, allowing the model to weigh the importance of different positions within the same sequence.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Spike\sphinxhyphen{}Timing\sphinxhyphen{}Dependent Plasticity (STDP)}\\
A biological learning mechanism where the strength of connections between neurons is adjusted based on the relative timing of a neuron’s action potentials.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}

\sphinxAtStartPar
\sphinxstylestrong{Synapse}\\
The junction between two neurons where signals are transmitted from one neuron to another.\\
\sphinxstyleemphasis{See: {[}Chapter 2 (Neuroscience Foundations){]}}


\section{T}
\label{\detokenize{appendices/glossary:t}}
\sphinxAtStartPar
\sphinxstylestrong{Tokenization}\\
The process of converting text into tokens (words, subwords, or characters) that can be processed by language models.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Transfer Learning}\\
A machine learning technique where a model developed for one task is reused as the starting point for a model on a second task.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}, {[}Chapter 12 (Large Language Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Transformer}\\
A neural network architecture that uses self\sphinxhyphen{}attention mechanisms to process sequential data, enabling parallel computation and capturing long\sphinxhyphen{}range dependencies effectively.\\
\sphinxstyleemphasis{See: {[}Chapter 11 (Sequence Models){]}, {[}Chapter 12 (Large Language Models){]}}


\section{V}
\label{\detokenize{appendices/glossary:v}}
\sphinxAtStartPar
\sphinxstylestrong{Vanishing Gradient Problem}\\
A difficulty encountered in training deep neural networks where gradients become extremely small during backpropagation, making learning ineffective in early layers.\\
\sphinxstyleemphasis{See: {[}Chapter 10 (Deep Learning){]}, {[}Chapter 11 (Sequence Models){]}}

\sphinxAtStartPar
\sphinxstylestrong{Vision Transformer (ViT)}\\
A neural network architecture for computer vision that applies the transformer model to image processing, dividing images into patches and processing them using self\sphinxhyphen{}attention mechanisms, inspired by how the human visual system allocates attention.\\
\sphinxstyleemphasis{See: {[}Chapter 20 (Case Studies in NeuroAI){]}}


\section{Z}
\label{\detokenize{appendices/glossary:z}}
\sphinxAtStartPar
\sphinxstylestrong{Zero\sphinxhyphen{}shot Learning}\\
The ability of a model to perform tasks it wasn’t explicitly trained on, without requiring any examples.\\
\sphinxstyleemphasis{See: {[}Chapter 12 (Large Language Models){]}}

\sphinxstepscope


\chapter{Appendix A: Math \& Python Mini\sphinxhyphen{}Refresher}
\label{\detokenize{appendices/math_python_refresher:appendix-a-math-python-mini-refresher}}\label{\detokenize{appendices/math_python_refresher::doc}}
\sphinxAtStartPar
This appendix provides a concise refresher on key mathematical concepts and Python programming skills that are essential for understanding the neuroAI content in this handbook.


\section{A.1 Mathematical Foundations}
\label{\detokenize{appendices/math_python_refresher:a-1-mathematical-foundations}}

\subsection{Linear Algebra Essentials}
\label{\detokenize{appendices/math_python_refresher:linear-algebra-essentials}}
\sphinxAtStartPar
Linear algebra forms the backbone of modern machine learning and neural data analysis.


\subsubsection{Vectors and Matrices}
\label{\detokenize{appendices/math_python_refresher:vectors-and-matrices}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Creating vectors}
\PYG{n}{v} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{w} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Vector operations}
\PYG{n}{dot\PYGZus{}product} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{v}\PYG{p}{,} \PYG{n}{w}\PYG{p}{)}      \PYG{c+c1}{\PYGZsh{} Dot product: 32}
\PYG{n}{norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{v}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{} Euclidean norm: 3.74}
\PYG{n}{unit\PYGZus{}v} \PYG{o}{=} \PYG{n}{v} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{v}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Unit vector}

\PYG{c+c1}{\PYGZsh{} Creating matrices}
\PYG{n}{A} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 3x2 matrix}
\PYG{n}{B} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} 2x3 matrix}

\PYG{c+c1}{\PYGZsh{} Matrix operations}
\PYG{n}{C} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{B}\PYG{p}{,} \PYG{n}{A}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Matrix multiplication: 2x2 matrix}
\PYG{n}{transpose} \PYG{o}{=} \PYG{n}{A}\PYG{o}{.}\PYG{n}{T}   \PYG{c+c1}{\PYGZsh{} Transpose: 2x3 matrix}
\end{sphinxVerbatim}


\subsubsection{Matrix Operations and Decompositions}
\label{\detokenize{appendices/math_python_refresher:matrix-operations-and-decompositions}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Square matrix for demonstration}
\PYG{n}{M} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Matrix inverse}
\PYG{n}{M\PYGZus{}inv} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{inv}\PYG{p}{(}\PYG{n}{M}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M * M\PYGZca{}\PYGZhy{}1 =}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{M}\PYG{p}{,} \PYG{n}{M\PYGZus{}inv}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Should be identity matrix}

\PYG{c+c1}{\PYGZsh{} Matrix determinant}
\PYG{n}{det} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{det}\PYG{p}{(}\PYG{n}{M}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 8.0}

\PYG{c+c1}{\PYGZsh{} Singular Value Decomposition (SVD)}
\PYG{n}{U}\PYG{p}{,} \PYG{n}{S}\PYG{p}{,} \PYG{n}{Vt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{svd}\PYG{p}{(}\PYG{n}{M}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Reconstruct original matrix}
\PYG{n}{M\PYGZus{}reconstructed} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{U}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{S}\PYG{p}{)}\PYG{p}{,} \PYG{n}{Vt}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Eigenvalues and eigenvectors}
\PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{M}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Eigenvalues:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{eigenvalues}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Eigenvectors:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{eigenvectors}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Principal Component Analysis (simplified)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simple\PYGZus{}pca}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Perform PCA on data matrix X}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} X: Data matrix (samples x features)}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}components: Number of principal components to keep}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} X\PYGZus{}reduced: Data projected onto principal components}
\PYG{l+s+sd}{    \PYGZhy{} components: Principal components}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Center the data}
    \PYG{n}{X\PYGZus{}centered} \PYG{o}{=} \PYG{n}{X} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute covariance matrix}
    \PYG{n}{cov\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cov}\PYG{p}{(}\PYG{n}{X\PYGZus{}centered}\PYG{p}{,} \PYG{n}{rowvar}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Eigendecomposition}
    \PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eigh}\PYG{p}{(}\PYG{n}{cov\PYGZus{}matrix}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Sort eigenvalues and eigenvectors in descending order}
    \PYG{n}{idx} \PYG{o}{=} \PYG{n}{eigenvalues}\PYG{o}{.}\PYG{n}{argsort}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{eigenvalues} \PYG{o}{=} \PYG{n}{eigenvalues}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{]}
    \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{eigenvectors}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{idx}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Select top n\PYGZus{}components}
    \PYG{n}{components} \PYG{o}{=} \PYG{n}{eigenvectors}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{n\PYGZus{}components}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Project data onto principal components}
    \PYG{n}{X\PYGZus{}reduced} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{X\PYGZus{}centered}\PYG{p}{,} \PYG{n}{components}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{X\PYGZus{}reduced}\PYG{p}{,} \PYG{n}{components}
\end{sphinxVerbatim}


\subsection{Calculus Fundamentals}
\label{\detokenize{appendices/math_python_refresher:calculus-fundamentals}}
\sphinxAtStartPar
Calculus concepts are critical for understanding neural network training and many neuroscience models.


\subsubsection{Derivatives and Gradients}
\label{\detokenize{appendices/math_python_refresher:derivatives-and-gradients}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{cm}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Axes3D}

\PYG{c+c1}{\PYGZsh{} Define a simple function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}

\PYG{c+c1}{\PYGZsh{} Plot function and its derivative}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
\PYG{n}{dydx} \PYG{o}{=} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{x}  \PYG{c+c1}{\PYGZsh{} Analytical derivative}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{f(x) = x²}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{dydx}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{f}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+s1}{(x) = 2x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Function and its Derivative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Multivariate function and gradient}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{g}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{y}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}

\PYG{c+c1}{\PYGZsh{} Analytical gradient}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{grad\PYGZus{}g}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{x}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{y}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Example of gradient descent}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{gradient\PYGZus{}descent}\PYG{p}{(}\PYG{n}{grad\PYGZus{}func}\PYG{p}{,} \PYG{n}{start}\PYG{p}{,} \PYG{n}{learning\PYGZus{}rate}\PYG{p}{,} \PYG{n}{n\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simple gradient descent implementation\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{path} \PYG{o}{=} \PYG{p}{[}\PYG{n}{start}\PYG{p}{]}
    \PYG{n}{point} \PYG{o}{=} \PYG{n}{start}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{gradient} \PYG{o}{=} \PYG{n}{grad\PYGZus{}func}\PYG{p}{(}\PYG{n}{point}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{point}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{point} \PYG{o}{=} \PYG{n}{point} \PYG{o}{\PYGZhy{}} \PYG{n}{learning\PYGZus{}rate} \PYG{o}{*} \PYG{n}{gradient}
        \PYG{n}{path}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{point}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{path}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Run gradient descent}
\PYG{n}{start} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{4.0}\PYG{p}{,} \PYG{l+m+mf}{4.0}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{path} \PYG{o}{=} \PYG{n}{gradient\PYGZus{}descent}\PYG{p}{(}\PYG{n}{grad\PYGZus{}g}\PYG{p}{,} \PYG{n}{start}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the function and gradient descent path}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
\PYG{n}{Z} \PYG{o}{=} \PYG{n}{g}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{)}

\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{surf} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot\PYGZus{}surface}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{Y}\PYG{p}{,} \PYG{n}{Z}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{coolwarm}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{g}\PYG{p}{(}\PYG{n}{path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{path}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} 
           \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gradient Descent Path}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gradient Descent Optimization}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{The Chain Rule and Backpropagation}
\label{\detokenize{appendices/math_python_refresher:the-chain-rule-and-backpropagation}}
\sphinxAtStartPar
The chain rule is the foundation of backpropagation, the algorithm used to train neural networks:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{chain\PYGZus{}rule\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Demonstrate the chain rule for a simple neural network with:}
\PYG{l+s+sd}{    \PYGZhy{} Input x}
\PYG{l+s+sd}{    \PYGZhy{} Hidden layer h = sigmoid(w1*x + b1)}
\PYG{l+s+sd}{    \PYGZhy{} Output y = w2*h + b2}
\PYG{l+s+sd}{    \PYGZhy{} Loss L = (y \PYGZhy{} target)²}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{sigmoid}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{z}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward\PYGZus{}pass}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{w1}\PYG{p}{,} \PYG{n}{b1}\PYG{p}{,} \PYG{n}{w2}\PYG{p}{,} \PYG{n}{b2}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Hidden layer}
        \PYG{n}{z1} \PYG{o}{=} \PYG{n}{w1} \PYG{o}{*} \PYG{n}{x} \PYG{o}{+} \PYG{n}{b1}
        \PYG{n}{h} \PYG{o}{=} \PYG{n}{sigmoid}\PYG{p}{(}\PYG{n}{z1}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Output layer}
        \PYG{n}{y} \PYG{o}{=} \PYG{n}{w2} \PYG{o}{*} \PYG{n}{h} \PYG{o}{+} \PYG{n}{b2}
        
        \PYG{k}{return} \PYG{n}{y}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{z1}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{compute\PYGZus{}gradients}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{target}\PYG{p}{,} \PYG{n}{w1}\PYG{p}{,} \PYG{n}{b1}\PYG{p}{,} \PYG{n}{w2}\PYG{p}{,} \PYG{n}{b2}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{y}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{z1} \PYG{o}{=} \PYG{n}{forward\PYGZus{}pass}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{w1}\PYG{p}{,} \PYG{n}{b1}\PYG{p}{,} \PYG{n}{w2}\PYG{p}{,} \PYG{n}{b2}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Compute loss}
        \PYG{n}{loss} \PYG{o}{=} \PYG{p}{(}\PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{n}{target}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
        
        \PYG{c+c1}{\PYGZsh{} Backpropagation}
        \PYG{c+c1}{\PYGZsh{} dL/dy = 2(y \PYGZhy{} target)}
        \PYG{n}{dL\PYGZus{}dy} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{p}{(}\PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{n}{target}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} dy/dw2 = h}
        \PYG{n}{dL\PYGZus{}dw2} \PYG{o}{=} \PYG{n}{dL\PYGZus{}dy} \PYG{o}{*} \PYG{n}{h}
        
        \PYG{c+c1}{\PYGZsh{} dy/db2 = 1}
        \PYG{n}{dL\PYGZus{}db2} \PYG{o}{=} \PYG{n}{dL\PYGZus{}dy} \PYG{o}{*} \PYG{l+m+mi}{1}
        
        \PYG{c+c1}{\PYGZsh{} dy/dh = w2}
        \PYG{n}{dL\PYGZus{}dh} \PYG{o}{=} \PYG{n}{dL\PYGZus{}dy} \PYG{o}{*} \PYG{n}{w2}
        
        \PYG{c+c1}{\PYGZsh{} dh/dz1 = h * (1 \PYGZhy{} h)  [derivative of sigmoid]}
        \PYG{n}{dh\PYGZus{}dz1} \PYG{o}{=} \PYG{n}{h} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{h}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} dz1/dw1 = x}
        \PYG{n}{dL\PYGZus{}dw1} \PYG{o}{=} \PYG{n}{dL\PYGZus{}dh} \PYG{o}{*} \PYG{n}{dh\PYGZus{}dz1} \PYG{o}{*} \PYG{n}{x}
        
        \PYG{c+c1}{\PYGZsh{} dz1/db1 = 1}
        \PYG{n}{dL\PYGZus{}db1} \PYG{o}{=} \PYG{n}{dL\PYGZus{}dh} \PYG{o}{*} \PYG{n}{dh\PYGZus{}dz1} \PYG{o}{*} \PYG{l+m+mi}{1}
        
        \PYG{k}{return} \PYG{n}{loss}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw2}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db2}
    
    \PYG{c+c1}{\PYGZsh{} Initialize parameters}
    \PYG{n}{x} \PYG{o}{=} \PYG{l+m+mf}{2.0}
    \PYG{n}{target} \PYG{o}{=} \PYG{l+m+mf}{0.5}
    \PYG{n}{w1}\PYG{p}{,} \PYG{n}{b1} \PYG{o}{=} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.1}
    \PYG{n}{w2}\PYG{p}{,} \PYG{n}{b2} \PYG{o}{=} \PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.2}
    
    \PYG{c+c1}{\PYGZsh{} Compute gradients}
    \PYG{n}{loss}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw2}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db2} \PYG{o}{=} \PYG{n}{compute\PYGZus{}gradients}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{target}\PYG{p}{,} \PYG{n}{w1}\PYG{p}{,} \PYG{n}{b1}\PYG{p}{,} \PYG{n}{w2}\PYG{p}{,} \PYG{n}{b2}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gradients:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  dL/dw1: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dL\PYGZus{}dw1}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  dL/db1: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dL\PYGZus{}db1}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  dL/dw2: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dL\PYGZus{}dw2}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  dL/db2: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dL\PYGZus{}db2}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{loss}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db1}\PYG{p}{,} \PYG{n}{dL\PYGZus{}dw2}\PYG{p}{,} \PYG{n}{dL\PYGZus{}db2}
\end{sphinxVerbatim}


\subsection{Probability and Statistics}
\label{\detokenize{appendices/math_python_refresher:probability-and-statistics}}
\sphinxAtStartPar
Probability theory is essential for understanding generative models, variational inference, and neural coding.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}

\PYG{c+c1}{\PYGZsh{} Normal distribution}
\PYG{n}{mu}\PYG{p}{,} \PYG{n}{sigma} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{n}{pdf} \PYG{o}{=} \PYG{n}{stats}\PYG{o}{.}\PYG{n}{norm}\PYG{o}{.}\PYG{n}{pdf}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{mu}\PYG{p}{,} \PYG{n}{sigma}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{pdf}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{fill\PYGZus{}between}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{pdf}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Normal Distribution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Probability Density}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Bayes\PYGZsq{} theorem example: Disease testing}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{bayes\PYGZus{}theorem\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Example using Bayes\PYGZsq{} theorem for medical testing:}
\PYG{l+s+sd}{    \PYGZhy{} Prior probability of disease: P(D) = 0.01}
\PYG{l+s+sd}{    \PYGZhy{} True positive rate: P(+|D) = 0.95}
\PYG{l+s+sd}{    \PYGZhy{} False positive rate: P(+|¬D) = 0.05}
\PYG{l+s+sd}{    \PYGZhy{} What is the probability of disease given positive test? P(D|+)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Prior probability of disease}
    \PYG{n}{p\PYGZus{}disease} \PYG{o}{=} \PYG{l+m+mf}{0.01}
    
    \PYG{c+c1}{\PYGZsh{} Conditional probabilities}
    \PYG{n}{p\PYGZus{}positive\PYGZus{}given\PYGZus{}disease} \PYG{o}{=} \PYG{l+m+mf}{0.95}        \PYG{c+c1}{\PYGZsh{} True positive rate}
    \PYG{n}{p\PYGZus{}positive\PYGZus{}given\PYGZus{}no\PYGZus{}disease} \PYG{o}{=} \PYG{l+m+mf}{0.05}     \PYG{c+c1}{\PYGZsh{} False positive rate}
    
    \PYG{c+c1}{\PYGZsh{} Calculate joint probabilities}
    \PYG{n}{p\PYGZus{}disease\PYGZus{}and\PYGZus{}positive} \PYG{o}{=} \PYG{n}{p\PYGZus{}disease} \PYG{o}{*} \PYG{n}{p\PYGZus{}positive\PYGZus{}given\PYGZus{}disease}
    \PYG{n}{p\PYGZus{}no\PYGZus{}disease\PYGZus{}and\PYGZus{}positive} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{p\PYGZus{}disease}\PYG{p}{)} \PYG{o}{*} \PYG{n}{p\PYGZus{}positive\PYGZus{}given\PYGZus{}no\PYGZus{}disease}
    
    \PYG{c+c1}{\PYGZsh{} Calculate marginal probability of positive test}
    \PYG{n}{p\PYGZus{}positive} \PYG{o}{=} \PYG{n}{p\PYGZus{}disease\PYGZus{}and\PYGZus{}positive} \PYG{o}{+} \PYG{n}{p\PYGZus{}no\PYGZus{}disease\PYGZus{}and\PYGZus{}positive}
    
    \PYG{c+c1}{\PYGZsh{} Apply Bayes\PYGZsq{} theorem}
    \PYG{n}{p\PYGZus{}disease\PYGZus{}given\PYGZus{}positive} \PYG{o}{=} \PYG{n}{p\PYGZus{}disease\PYGZus{}and\PYGZus{}positive} \PYG{o}{/} \PYG{n}{p\PYGZus{}positive}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Probability of disease given positive test: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{p\PYGZus{}disease\PYGZus{}given\PYGZus{}positive}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{p\PYGZus{}disease\PYGZus{}given\PYGZus{}positive}

\PYG{c+c1}{\PYGZsh{} Information theory \PYGZhy{} Entropy and KL divergence}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{information\PYGZus{}theory\PYGZus{}example}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Calculate entropy and KL divergence for discrete distributions}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Two probability distributions}
    \PYG{n}{p} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{q} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.4}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Entropy of p}
    \PYG{n}{entropy\PYGZus{}p} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} KL divergence between p and q}
    \PYG{n}{kl\PYGZus{}div} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{p} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log2}\PYG{p}{(}\PYG{n}{p} \PYG{o}{/} \PYG{n}{q}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Entropy of p: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{entropy\PYGZus{}p}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{KL divergence from p to q: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{kl\PYGZus{}div}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ bits}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{entropy\PYGZus{}p}\PYG{p}{,} \PYG{n}{kl\PYGZus{}div}
\end{sphinxVerbatim}


\section{A.2 Python Fundamentals}
\label{\detokenize{appendices/math_python_refresher:a-2-python-fundamentals}}

\subsection{Core Python}
\label{\detokenize{appendices/math_python_refresher:core-python}}
\sphinxAtStartPar
Python’s simplicity and readability make it ideal for neuroscience and AI research.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Data structures}
\PYG{c+c1}{\PYGZsh{} Lists}
\PYG{n}{my\PYGZus{}list} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{my\PYGZus{}list}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{my\PYGZus{}list}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Indexing: 1}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{my\PYGZus{}list}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Negative indexing: 4}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{my\PYGZus{}list}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Slicing: [2, 3]}

\PYG{c+c1}{\PYGZsh{} Dictionaries}
\PYG{n}{my\PYGZus{}dict} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pyramidal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{location}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{my\PYGZus{}dict}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Accessing value: Pyramidal}
\PYG{n}{my\PYGZus{}dict}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{active}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{k+kc}{True}  \PYG{c+c1}{\PYGZsh{} Adding new key\PYGZhy{}value pair}

\PYG{c+c1}{\PYGZsh{} List comprehension}
\PYG{n}{squares} \PYG{o}{=} \PYG{p}{[}\PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{]}
\PYG{n}{even\PYGZus{}squares} \PYG{o}{=} \PYG{p}{[}\PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)} \PYG{k}{if} \PYG{n}{x} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{2} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Functions and lambda expressions}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{calculate\PYGZus{}firing\PYGZus{}rate}\PYG{p}{(}\PYG{n}{spike\PYGZus{}count}\PYG{p}{,} \PYG{n}{time\PYGZus{}window}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Calculate firing rate in Hz\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{return} \PYG{n}{spike\PYGZus{}count} \PYG{o}{/} \PYG{n}{time\PYGZus{}window}

\PYG{c+c1}{\PYGZsh{} Lambda function for the same calculation}
\PYG{n}{firing\PYGZus{}rate} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{spike\PYGZus{}count}\PYG{p}{,} \PYG{n}{time\PYGZus{}window}\PYG{p}{:} \PYG{n}{spike\PYGZus{}count} \PYG{o}{/} \PYG{n}{time\PYGZus{}window}

\PYG{c+c1}{\PYGZsh{} Classes and OOP}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Neuron}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simple neuron model\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{rest\PYGZus{}potential}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{70}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{55}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{n}{rest\PYGZus{}potential}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rest\PYGZus{}potential} \PYG{o}{=} \PYG{n}{rest\PYGZus{}potential}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold} \PYG{o}{=} \PYG{n}{threshold}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{receive\PYGZus{}input}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}current}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Process input current and update membrane potential\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{+}\PYG{o}{=} \PYG{n}{input\PYGZus{}current}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{threshold}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{return} \PYG{k+kc}{True}
        \PYG{k}{return} \PYG{k+kc}{False}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{spike}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate an action potential\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rest\PYGZus{}potential}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Reset neuron state\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rest\PYGZus{}potential}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{spike\PYGZus{}history} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Creating and using a neuron instance}
\PYG{n}{my\PYGZus{}neuron} \PYG{o}{=} \PYG{n}{Neuron}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{my\PYGZus{}neuron}\PYG{o}{.}\PYG{n}{receive\PYGZus{}input}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Membrane potential: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{my\PYGZus{}neuron}\PYG{o}{.}\PYG{n}{membrane\PYGZus{}potential}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mV}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Scientific Python Ecosystem}
\label{\detokenize{appendices/math_python_refresher:scientific-python-ecosystem}}
\sphinxAtStartPar
The scientific Python ecosystem provides powerful tools for data analysis, visualization, and modeling.


\subsubsection{NumPy: Numerical Computing}
\label{\detokenize{appendices/math_python_refresher:numpy-numerical-computing}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Creating arrays}
\PYG{n}{a} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{b} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [0, 1, 2, ..., 9]}
\PYG{n}{c} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} [0.0, 0.25, 0.5, 0.75, 1.0]}
\PYG{n}{zeros} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 3x3 matrix of zeros}
\PYG{n}{ones} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 2x2 matrix of ones}
\PYG{n}{rand} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 2x2 matrix of random numbers from U(0,1)}

\PYG{c+c1}{\PYGZsh{} Array operations}
\PYG{n}{a} \PYG{o}{+} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Element\PYGZhy{}wise addition: [3, 4, 5, 6, 7]}
\PYG{n}{a} \PYG{o}{*} \PYG{l+m+mi}{2}  \PYG{c+c1}{\PYGZsh{} Element\PYGZhy{}wise multiplication: [2, 4, 6, 8, 10]}
\PYG{n}{a} \PYG{o}{*} \PYG{n}{a}  \PYG{c+c1}{\PYGZsh{} Element\PYGZhy{}wise product: [1, 4, 9, 16, 25]}

\PYG{c+c1}{\PYGZsh{} Matrix operations}
\PYG{n}{M} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{v} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{M}\PYG{p}{,} \PYG{n}{v}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Matrix\PYGZhy{}vector product: [5, 11]}
\PYG{n}{eigvals}\PYG{p}{,} \PYG{n}{eigvecs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{M}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Eigendecomposition}

\PYG{c+c1}{\PYGZsh{} Statistical operations}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Mean: 3.0}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} Standard deviation: \PYGZti{}1.41}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} Maximum: 5}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} Minimum: 1}
\end{sphinxVerbatim}


\subsubsection{Matplotlib: Visualization}
\label{\detokenize{appendices/math_python_refresher:matplotlib-visualization}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Basic line plot}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sin(x)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sine Function}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sin(x)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Scatter plot with coloring}
\PYG{n}{n} \PYG{o}{=} \PYG{l+m+mi}{100}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}
\PYG{n}{colors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}
\PYG{n}{sizes} \PYG{o}{=} \PYG{l+m+mi}{1000} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{n}{sizes}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Scatter Plot with Size and Color Mapping}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Color Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Multiple plots in a grid}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} First plot: line}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Line Plot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Second plot: scatter}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Scatter Plot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Third plot: histogram}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Histogram}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Fourth plot: bar chart}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Bar Chart}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Pandas: Data Manipulation}
\label{\detokenize{appendices/math_python_refresher:pandas-data-manipulation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Creating a DataFrame}
\PYG{n}{data} \PYG{o}{=} \PYG{p}{\PYGZob{}}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{neuron\PYGZus{}id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pyramidal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stellate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pyramidal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Basket}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pyramidal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{resting\PYGZus{}potential}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{70}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{65}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{72}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{68}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{71}\PYG{p}{]}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mf}{5.2}\PYG{p}{,} \PYG{l+m+mf}{10.1}\PYG{p}{,} \PYG{l+m+mf}{3.5}\PYG{p}{,} \PYG{l+m+mf}{15.0}\PYG{p}{,} \PYG{l+m+mf}{4.8}\PYG{p}{]}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{location}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MT}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{p}{\PYGZcb{}}

\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{df}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Basic operations}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{df}\PYG{o}{.}\PYG{n}{describe}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Summary statistics}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Mean of a column}

\PYG{c+c1}{\PYGZsh{} Filtering}
\PYG{n}{pyramidal\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pyramidal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{high\PYGZus{}firing} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{10}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Grouping and aggregation}
\PYG{n}{type\PYGZus{}stats} \PYG{o}{=} \PYG{n}{df}\PYG{o}{.}\PYG{n}{groupby}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{agg}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{resting\PYGZus{}potential}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mean}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mean}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{std}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{type\PYGZus{}stats}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Adding a new column}
\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{active}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{firing\PYGZus{}rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{5}
\end{sphinxVerbatim}


\subsubsection{SciPy: Scientific Computing}
\label{\detokenize{appendices/math_python_refresher:scipy-scientific-computing}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}\PYG{p}{,} \PYG{n}{optimize}\PYG{p}{,} \PYG{n}{integrate}\PYG{p}{,} \PYG{n}{signal}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Statistical tests}
\PYG{n}{x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{t\PYGZus{}stat}\PYG{p}{,} \PYG{n}{p\PYGZus{}value} \PYG{o}{=} \PYG{n}{stats}\PYG{o}{.}\PYG{n}{ttest\PYGZus{}ind}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{t\PYGZhy{}statistic: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t\PYGZus{}stat}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{, p\PYGZhy{}value: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{p\PYGZus{}value}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Optimization}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{objective}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{x}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{optimize}\PYG{o}{.}\PYG{n}{minimize}\PYG{p}{(}\PYG{n}{objective}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Minimum found at: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{result}\PYG{o}{.}\PYG{n}{x}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Minimum value: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{result}\PYG{o}{.}\PYG{n}{fun}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Integration}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{f}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{x}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}

\PYG{n}{integral}\PYG{p}{,} \PYG{n}{error} \PYG{o}{=} \PYG{n}{integrate}\PYG{o}{.}\PYG{n}{quad}\PYG{p}{(}\PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Integral of x\PYGZca{}2 from 0 to 1: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{integral}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ± }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{error}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Signal processing: filtering}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{endpoint}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{noise} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{t}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
\PYG{n}{signal\PYGZus{}clean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz sine wave}
\PYG{n}{signal\PYGZus{}noisy} \PYG{o}{=} \PYG{n}{signal\PYGZus{}clean} \PYG{o}{+} \PYG{n}{noise}

\PYG{c+c1}{\PYGZsh{} Design a low\PYGZhy{}pass filter}
\PYG{n}{b}\PYG{p}{,} \PYG{n}{a} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 4th order Butterworth filter with cutoff at 0.2 * Nyquist frequency}
\PYG{n}{filtered\PYGZus{}signal} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{signal\PYGZus{}noisy}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{signal\PYGZus{}noisy}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noisy signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{signal\PYGZus{}clean}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{filtered\PYGZus{}signal}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{1.5}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Filtered signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time [s]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Signal Filtering Example}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Machine Learning Libraries}
\label{\detokenize{appendices/math_python_refresher:machine-learning-libraries}}

\subsubsection{PyTorch Fundamentals}
\label{\detokenize{appendices/math_python_refresher:pytorch-fundamentals}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Create a simple neural network}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{SimpleNN}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{SimpleNN}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{hidden\PYGZus{}size}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{layer2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x}

\PYG{c+c1}{\PYGZsh{} Create a synthetic dataset}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Generate two\PYGZhy{}class classification data}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int64}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to PyTorch tensors}
    \PYG{n}{X\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
    \PYG{n}{y\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{LongTensor}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{X\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{y\PYGZus{}tensor}

\PYG{c+c1}{\PYGZsh{} Training function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{train\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{SGD}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{n}{lr}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Track losses}
    \PYG{n}{losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    
    \PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass and optimize}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Save loss}
        \PYG{n}{losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Print progress}
        \PYG{k}{if} \PYG{p}{(}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{100} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{losses}

\PYG{c+c1}{\PYGZsh{} Prepare data}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{generate\PYGZus{}data}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create and train model}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{SimpleNN}\PYG{p}{(}\PYG{n}{input\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{hidden\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{output\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{losses} \PYG{o}{=} \PYG{n}{train\PYGZus{}model}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot decision boundary}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}decision\PYGZus{}boundary}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Define grid for plotting}
    \PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
    \PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max} \PYG{o}{=} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
    \PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{,}
                         \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{y\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}max}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get predictions for all grid points}
    \PYG{n}{grid} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{grid}\PYG{p}{)}
        \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reshape predictions back to grid}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{predictions}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot decision boundary}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{contourf}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{predictions}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot training points}
    \PYG{n}{scatter} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{X}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{edgecolors}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{o}{*}\PYG{n}{scatter}\PYG{o}{.}\PYG{n}{legend\PYGZus{}elements}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Classes}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Feature 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Decision Boundary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{losses}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}decision\PYGZus{}boundary}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{TensorFlow/Keras Example}
\label{\detokenize{appendices/math_python_refresher:tensorflow-keras-example}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{keras}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Load a built\PYGZhy{}in dataset (MNIST)}
\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)} \PYG{o}{=} \PYG{n}{keras}\PYG{o}{.}\PYG{n}{datasets}\PYG{o}{.}\PYG{n}{mnist}\PYG{o}{.}\PYG{n}{load\PYGZus{}data}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Preprocess data}
\PYG{n}{x\PYGZus{}train} \PYG{o}{=} \PYG{n}{x\PYGZus{}train}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{float32}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{255.0}
\PYG{n}{x\PYGZus{}test} \PYG{o}{=} \PYG{n}{x\PYGZus{}test}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{float32}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{255.0}

\PYG{c+c1}{\PYGZsh{} Build a convolutional neural network}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{keras}\PYG{o}{.}\PYG{n}{Sequential}\PYG{p}{(}\PYG{p}{[}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Input}\PYG{p}{(}\PYG{n}{shape}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Reshape}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{28}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Conv2D}\PYG{p}{(}\PYG{l+m+mi}{64}\PYG{p}{,} \PYG{n}{kernel\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{MaxPooling2D}\PYG{p}{(}\PYG{n}{pool\PYGZus{}size}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{relu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{keras}\PYG{o}{.}\PYG{n}{layers}\PYG{o}{.}\PYG{n}{Dense}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{activation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{softmax}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compile the model}
\PYG{n}{model}\PYG{o}{.}\PYG{n}{compile}\PYG{p}{(}\PYG{n}{optimizer}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{adam}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
              \PYG{n}{loss}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sparse\PYGZus{}categorical\PYGZus{}crossentropy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
              \PYG{n}{metrics}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Train the model (using a subset for demonstration)}
\PYG{n}{history} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{x\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{10000}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{10000}\PYG{p}{]}\PYG{p}{,} 
                    \PYG{n}{validation\PYGZus{}split}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,}
                    \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{128}\PYG{p}{,} 
                    \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Evaluate on test data}
\PYG{n}{test\PYGZus{}loss}\PYG{p}{,} \PYG{n}{test\PYGZus{}acc} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{evaluate}\PYG{p}{(}\PYG{n}{x\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{test\PYGZus{}acc}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot training history}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{history}\PYG{o}{.}\PYG{n}{history}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{history}\PYG{o}{.}\PYG{n}{history}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val\PYGZus{}loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Validation Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{history}\PYG{o}{.}\PYG{n}{history}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{history}\PYG{o}{.}\PYG{n}{history}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val\PYGZus{}accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Validation Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Accuracy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize predictions}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{plot\PYGZus{}predictions}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{x\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{n}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Get model predictions}
    \PYG{n}{predictions} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{x\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{n}{n}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{predicted\PYGZus{}classes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{predictions}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{n}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{x\PYGZus{}test}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{color} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{if} \PYG{n}{predicted\PYGZus{}classes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{==} \PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{else} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pred: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{predicted\PYGZus{}classes}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{True: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}predictions}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{x\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}test}\PYG{p}{)}
\end{sphinxVerbatim}


\section{A.3 Neuroscience Data Processing}
\label{\detokenize{appendices/math_python_refresher:a-3-neuroscience-data-processing}}

\subsection{Common Data Formats}
\label{\detokenize{appendices/math_python_refresher:common-data-formats}}
\sphinxAtStartPar
Neuroscience data comes in various formats, each with its own characteristics:


\subsubsection{Spike Trains and Rasters}
\label{\detokenize{appendices/math_python_refresher:spike-trains-and-rasters}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Simulate spike trains for 5 neurons over 1 second}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}poisson\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{t\PYGZus{}max}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate a Poisson spike train\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{t\PYGZus{}max}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}steps} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Probability of spike in each time bin}
    \PYG{n}{prob\PYGZus{}spike} \PYG{o}{=} \PYG{n}{rate} \PYG{o}{*} \PYG{n}{dt}
    
    \PYG{c+c1}{\PYGZsh{} Generate spikes}
    \PYG{n}{spikes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}steps}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{prob\PYGZus{}spike}
    
    \PYG{c+c1}{\PYGZsh{} Get spike times}
    \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{n}{t}\PYG{p}{[}\PYG{n}{spikes}\PYG{p}{]}
    
    \PYG{k}{return} \PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{spikes}

\PYG{c+c1}{\PYGZsh{} Simulation parameters}
\PYG{n}{t\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mf}{1.0}  \PYG{c+c1}{\PYGZsh{} seconds}
\PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mf}{0.001}   \PYG{c+c1}{\PYGZsh{} 1 ms resolution}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{5}
\PYG{n}{firing\PYGZus{}rates} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{25}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Hz}

\PYG{c+c1}{\PYGZsh{} Generate spike trains}
\PYG{n}{spike\PYGZus{}trains} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{spike\PYGZus{}rasters} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{rate} \PYG{o+ow}{in} \PYG{n}{firing\PYGZus{}rates}\PYG{p}{:}
    \PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{spikes} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}poisson\PYGZus{}spike\PYGZus{}train}\PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{t\PYGZus{}max}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}trains}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}rasters}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot raster plot}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot spike raster}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{p}{(}\PYG{n}{rate}\PYG{p}{,} \PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{firing\PYGZus{}rates}\PYG{p}{,} \PYG{n}{spike\PYGZus{}trains}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rate}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ Hz}\PYG{l+s+s1}{\PYGZsq{}} \PYG{k}{for} \PYG{n}{rate} \PYG{o+ow}{in} \PYG{n}{firing\PYGZus{}rates}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster Plot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot PSTH (Peri\PYGZhy{}Stimulus Time Histogram)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{bin\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mf}{0.05}  \PYG{c+c1}{\PYGZsh{} 50 ms bins}
\PYG{n}{bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{t\PYGZus{}max} \PYG{o}{+} \PYG{n}{bin\PYGZus{}size}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{p}{)}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{t\PYGZus{}max}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{spikes} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{spike\PYGZus{}rasters}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{counts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram}\PYG{p}{(}\PYG{n}{t}\PYG{p}{[}\PYG{n}{spikes}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bins}\PYG{p}{)}
    \PYG{n}{rate} \PYG{o}{=} \PYG{n}{counts} \PYG{o}{/} \PYG{n}{bin\PYGZus{}size}  \PYG{c+c1}{\PYGZsh{} Convert to Hz}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{rate}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peri\PYGZhy{}Stimulus Time Histogram (PSTH)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Time Series Data}
\label{\detokenize{appendices/math_python_refresher:time-series-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{c+c1}{\PYGZsh{} Simulate EEG data (multi\PYGZhy{}channel time series)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}eeg}\PYG{p}{(}\PYG{n}{fs}\PYG{o}{=}\PYG{l+m+mi}{250}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate multi\PYGZhy{}channel EEG data with different frequency bands}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} fs: Sampling frequency (Hz)}
\PYG{l+s+sd}{    \PYGZhy{} duration: Duration of the signal (seconds)}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}channels: Number of channels}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} time: Time points}
\PYG{l+s+sd}{    \PYGZhy{} eeg: Simulated EEG data (channels x time points)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{fs}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}points} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate different frequency components}
    \PYG{n}{delta} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 2 Hz (delta band: 0.5\PYGZhy{}4 Hz)}
    \PYG{n}{theta} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{6} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 6 Hz (theta band: 4\PYGZhy{}8 Hz)}
    \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz (alpha band: 8\PYGZhy{}13 Hz)}
    \PYG{n}{beta} \PYG{o}{=} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 20 Hz (beta band: 13\PYGZhy{}30 Hz)}
    \PYG{n}{gamma} \PYG{o}{=} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{40} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 40 Hz (gamma band: \PYGZgt{}30 Hz)}
    
    \PYG{c+c1}{\PYGZsh{} Create channels with different mixtures of frequency components}
    \PYG{n}{eeg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}points}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 1: Mostly delta and theta}
    \PYG{n}{eeg}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{delta} \PYG{o}{+} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{n}{theta} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{alpha} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{o}{*}\PYG{n}{beta} \PYG{o}{+} \PYG{l+m+mf}{0.05}\PYG{o}{*}\PYG{n}{gamma} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 2: Mostly alpha}
    \PYG{n}{eeg}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{delta} \PYG{o}{+} \PYG{l+m+mf}{0.3}\PYG{o}{*}\PYG{n}{theta} \PYG{o}{+} \PYG{n}{alpha} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{beta} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{o}{*}\PYG{n}{gamma} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 3: Mostly beta}
    \PYG{n}{eeg}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.1}\PYG{o}{*}\PYG{n}{delta} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{theta} \PYG{o}{+} \PYG{l+m+mf}{0.3}\PYG{o}{*}\PYG{n}{alpha} \PYG{o}{+} \PYG{n}{beta} \PYG{o}{+} \PYG{l+m+mf}{0.3}\PYG{o}{*}\PYG{n}{gamma} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Channel 4: Mostly gamma}
    \PYG{n}{eeg}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.05}\PYG{o}{*}\PYG{n}{delta} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{o}{*}\PYG{n}{theta} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{alpha} \PYG{o}{+} \PYG{l+m+mf}{0.3}\PYG{o}{*}\PYG{n}{beta} \PYG{o}{+} \PYG{n}{gamma} \PYG{o}{+} \PYG{l+m+mf}{0.2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{t}\PYG{p}{,} \PYG{n}{eeg}

\PYG{c+c1}{\PYGZsh{} Simulate EEG data}
\PYG{n}{fs} \PYG{o}{=} \PYG{l+m+mi}{250}  \PYG{c+c1}{\PYGZsh{} sampling frequency (Hz)}
\PYG{n}{t}\PYG{p}{,} \PYG{n}{eeg} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}eeg}\PYG{p}{(}\PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot time domain signals}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{channel\PYGZus{}names} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frontal (Fz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Central (Cz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Parietal (Pz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Occipital (Oz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{eeg}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{n}{channel\PYGZus{}names}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simulated EEG Data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compute and plot power spectrum}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute power spectrum}
    \PYG{n}{f}\PYG{p}{,} \PYG{n}{Pxx} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{welch}\PYG{p}{(}\PYG{n}{eeg}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot power spectrum}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{semilogy}\PYG{p}{(}\PYG{n}{f}\PYG{p}{,} \PYG{n}{Pxx}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Power Spectral Density}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Channel: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{channel\PYGZus{}names}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{13}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.3}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Preprocessing Techniques}
\label{\detokenize{appendices/math_python_refresher:preprocessing-techniques}}
\sphinxAtStartPar
Preprocessing is a critical step in neuroscience data analysis:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{signal}

\PYG{c+c1}{\PYGZsh{} Generate noisy signal}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{generate\PYGZus{}noisy\PYGZus{}eeg}\PYG{p}{(}\PYG{n}{fs}\PYG{o}{=}\PYG{l+m+mi}{250}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Generate a noisy EEG\PYGZhy{}like signal with various artifacts\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{fs}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}points} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate clean signal (mixture of oscillations)}
    \PYG{n}{clean} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)} \PYG{o}{+}  \PYG{c+c1}{\PYGZsh{} Alpha (10 Hz)}
             \PYG{l+m+mf}{0.25} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)} \PYG{o}{+}  \PYG{c+c1}{\PYGZsh{} Theta (5 Hz)}
             \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} Beta (20 Hz)}
    
    \PYG{c+c1}{\PYGZsh{} Add noise}
    \PYG{n}{noise} \PYG{o}{=} \PYG{l+m+mf}{0.2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add power line noise (50 Hz)}
    \PYG{n}{line\PYGZus{}noise} \PYG{o}{=} \PYG{l+m+mf}{0.15} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{50} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add ocular artifact (slow wave at specific timepoints)}
    \PYG{n}{artifact} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}points}\PYG{p}{)}
    \PYG{n}{artifact\PYGZus{}times} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{1.2}\PYG{p}{,} \PYG{l+m+mf}{3.7}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Times of artifacts (seconds)}
    
    \PYG{k}{for} \PYG{n}{art\PYGZus{}time} \PYG{o+ow}{in} \PYG{n}{artifact\PYGZus{}times}\PYG{p}{:}
        \PYG{n}{idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{art\PYGZus{}time} \PYG{o}{*} \PYG{n}{fs}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Create a slow wave artifact}
        \PYG{n}{window} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{gaussian}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{std}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{idx} \PYG{o}{+} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{window}\PYG{p}{)} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{n\PYGZus{}points}\PYG{p}{:}
            \PYG{n}{artifact}\PYG{p}{[}\PYG{n}{idx}\PYG{p}{:}\PYG{n}{idx}\PYG{o}{+}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{window}\PYG{p}{)}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{window}
    
    \PYG{c+c1}{\PYGZsh{} Combine all components}
    \PYG{n}{noisy\PYGZus{}signal} \PYG{o}{=} \PYG{n}{clean} \PYG{o}{+} \PYG{n}{noise} \PYG{o}{+} \PYG{n}{line\PYGZus{}noise} \PYG{o}{+} \PYG{n}{artifact}
    
    \PYG{k}{return} \PYG{n}{t}\PYG{p}{,} \PYG{n}{clean}\PYG{p}{,} \PYG{n}{noisy\PYGZus{}signal}\PYG{p}{,} \PYG{n}{artifact}

\PYG{c+c1}{\PYGZsh{} Generate signal}
\PYG{n}{fs} \PYG{o}{=} \PYG{l+m+mi}{250}
\PYG{n}{t}\PYG{p}{,} \PYG{n}{clean}\PYG{p}{,} \PYG{n}{noisy}\PYG{p}{,} \PYG{n}{artifact} \PYG{o}{=} \PYG{n}{generate\PYGZus{}noisy\PYGZus{}eeg}\PYG{p}{(}\PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot raw signals}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{clean}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Clean EEG Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{noisy}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noisy EEG Signal with Artifacts}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{artifact}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Artifacts Component}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Apply filtering}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{apply\PYGZus{}filters}\PYG{p}{(}\PYG{n}{signal\PYGZus{}data}\PYG{p}{,} \PYG{n}{fs}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Apply various filters to the signal\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Notch filter for line noise (50 Hz)}
    \PYG{n}{b\PYGZus{}notch}\PYG{p}{,} \PYG{n}{a\PYGZus{}notch} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{iirnotch}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{fs}\PYG{p}{)}
    \PYG{n}{notch\PYGZus{}filtered} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b\PYGZus{}notch}\PYG{p}{,} \PYG{n}{a\PYGZus{}notch}\PYG{p}{,} \PYG{n}{signal\PYGZus{}data}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Bandpass filter for EEG frequencies of interest (1\PYGZhy{}40 Hz)}
    \PYG{n}{b\PYGZus{}bandpass}\PYG{p}{,} \PYG{n}{a\PYGZus{}bandpass} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{butter}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{]}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{btype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bandpass}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{bandpass\PYGZus{}filtered} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{filtfilt}\PYG{p}{(}\PYG{n}{b\PYGZus{}bandpass}\PYG{p}{,} \PYG{n}{a\PYGZus{}bandpass}\PYG{p}{,} \PYG{n}{notch\PYGZus{}filtered}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{notch\PYGZus{}filtered}\PYG{p}{,} \PYG{n}{bandpass\PYGZus{}filtered}

\PYG{c+c1}{\PYGZsh{} Apply filters}
\PYG{n}{notch\PYGZus{}filtered}\PYG{p}{,} \PYG{n}{bandpass\PYGZus{}filtered} \PYG{o}{=} \PYG{n}{apply\PYGZus{}filters}\PYG{p}{(}\PYG{n}{noisy}\PYG{p}{,} \PYG{n}{fs}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot filtered signals}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{clean}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original Clean EEG Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{noisy}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Noisy EEG Signal with Artifacts}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{notch\PYGZus{}filtered}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{After Notch Filter (50 Hz removed)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{bandpass\PYGZus{}filtered}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{After Bandpass Filter (1\PYGZhy{}40 Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Amplitude}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compute and plot spectrograms}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{f}\PYG{p}{,} \PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{spectrogram}\PYG{p}{(}\PYG{n}{noisy}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{noverlap}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx}\PYG{p}{)}\PYG{p}{,} \PYG{n}{shading}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gouraud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency [Hz]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spectrogram of Noisy Signal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PSD [dB]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{60}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{f}\PYG{p}{,} \PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{spectrogram}\PYG{p}{(}\PYG{n}{notch\PYGZus{}filtered}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{noverlap}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx}\PYG{p}{)}\PYG{p}{,} \PYG{n}{shading}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gouraud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency [Hz]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spectrogram after Notch Filter}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PSD [dB]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{60}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{f}\PYG{p}{,} \PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{Sxx} \PYG{o}{=} \PYG{n}{signal}\PYG{o}{.}\PYG{n}{spectrogram}\PYG{p}{(}\PYG{n}{bandpass\PYGZus{}filtered}\PYG{p}{,} \PYG{n}{fs}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{,} \PYG{n}{nperseg}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{noverlap}\PYG{o}{=}\PYG{n}{fs}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{t\PYGZus{}spec}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log10}\PYG{p}{(}\PYG{n}{Sxx}\PYG{p}{)}\PYG{p}{,} \PYG{n}{shading}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gouraud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time [s]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Frequency [Hz]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spectrogram after Bandpass Filter}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PSD [dB]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{60}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{A.4 Code Examples}
\label{\detokenize{appendices/math_python_refresher:a-4-code-examples}}
\sphinxAtStartPar
Here are some integrated examples demonstrating common tasks in computational neuroscience and AI:


\subsection{Neural Decoding Example}
\label{\detokenize{appendices/math_python_refresher:neural-decoding-example}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{,} \PYG{n}{confusion\PYGZus{}matrix}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{nn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nn}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{optim}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{optim}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torch}\PYG{n+nn}{.}\PYG{n+nn}{utils}\PYG{n+nn}{.}\PYG{n+nn}{data}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{DataLoader}\PYG{p}{,} \PYG{n}{TensorDataset}

\PYG{c+c1}{\PYGZsh{} Simulate neural data and behavior}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}neural\PYGZus{}decoding\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Simulate neural population activity encoding different behaviors}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}neurons: Number of neurons}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}samples: Number of samples (trials)}
\PYG{l+s+sd}{    \PYGZhy{} n\PYGZus{}classes: Number of behavioral classes}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns:}
\PYG{l+s+sd}{    \PYGZhy{} X: Neural activity data (n\PYGZus{}samples, n\PYGZus{}neurons)}
\PYG{l+s+sd}{    \PYGZhy{} y: Behavioral labels (n\PYGZus{}samples,)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create class\PYGZhy{}specific activity patterns}
    \PYG{n}{neuron\PYGZus{}templates} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Initialize data}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate samples}
    \PYG{n}{samples\PYGZus{}per\PYGZus{}class} \PYG{o}{=} \PYG{n}{n\PYGZus{}samples} \PYG{o}{/}\PYG{o}{/} \PYG{n}{n\PYGZus{}classes}
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{start\PYGZus{}idx} \PYG{o}{=} \PYG{n}{c} \PYG{o}{*} \PYG{n}{samples\PYGZus{}per\PYGZus{}class}
        \PYG{n}{end\PYGZus{}idx} \PYG{o}{=} \PYG{p}{(}\PYG{n}{c} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{samples\PYGZus{}per\PYGZus{}class} \PYG{k}{if} \PYG{n}{c} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}classes} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{n}{n\PYGZus{}samples}
        
        \PYG{c+c1}{\PYGZsh{} Assign class labels}
        \PYG{n}{y}\PYG{p}{[}\PYG{n}{start\PYGZus{}idx}\PYG{p}{:}\PYG{n}{end\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{c}
        
        \PYG{c+c1}{\PYGZsh{} Generate neural activity based on class template}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{start\PYGZus{}idx}\PYG{p}{,} \PYG{n}{end\PYGZus{}idx}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Add noise to template}
            \PYG{n}{X}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{neuron\PYGZus{}templates}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5}
    
    \PYG{k}{return} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}

\PYG{c+c1}{\PYGZsh{} Generate simulated data}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}neural\PYGZus{}decoding\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Preprocess data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Standardize features}
\PYG{n}{scaler} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{X\PYGZus{}train} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
\PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Convert to PyTorch tensors}
\PYG{n}{X\PYGZus{}train\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
\PYG{n}{y\PYGZus{}train\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{LongTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}train}\PYG{p}{)}
\PYG{n}{X\PYGZus{}test\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{FloatTensor}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
\PYG{n}{y\PYGZus{}test\PYGZus{}tensor} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{LongTensor}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create dataset and dataloader}
\PYG{n}{train\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{TensorDataset}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}tensor}\PYG{p}{,} \PYG{n}{y\PYGZus{}train\PYGZus{}tensor}\PYG{p}{)}
\PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{train\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define neural network model}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{NeuralDecoder}\PYG{p}{(}\PYG{n}{nn}\PYG{o}{.}\PYG{n}{Module}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{NeuralDecoder}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{ReLU}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Dropout}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{Linear}\PYG{p}{(}\PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{forward}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc1}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{relu}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dropout}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fc2}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{x}

\PYG{c+c1}{\PYGZsh{} Initialize model and optimizer}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{n}{X\PYGZus{}train}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
\PYG{n}{n\PYGZus{}hidden} \PYG{o}{=} \PYG{l+m+mi}{64}
\PYG{n}{n\PYGZus{}classes} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{NeuralDecoder}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}hidden}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{p}{)}
\PYG{n}{criterion} \PYG{o}{=} \PYG{n}{nn}\PYG{o}{.}\PYG{n}{CrossEntropyLoss}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{optimizer} \PYG{o}{=} \PYG{n}{optim}\PYG{o}{.}\PYG{n}{Adam}\PYG{p}{(}\PYG{n}{model}\PYG{o}{.}\PYG{n}{parameters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{lr}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Train the model}
\PYG{n}{n\PYGZus{}epochs} \PYG{o}{=} \PYG{l+m+mi}{20}
\PYG{n}{train\PYGZus{}losses} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{epoch} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}epochs}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{model}\PYG{o}{.}\PYG{n}{train}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{=} \PYG{l+m+mi}{0}
    
    \PYG{k}{for} \PYG{n}{inputs}\PYG{p}{,} \PYG{n}{labels} \PYG{o+ow}{in} \PYG{n}{train\PYGZus{}loader}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Forward pass}
        \PYG{n}{outputs} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{inputs}\PYG{p}{)}
        \PYG{n}{loss} \PYG{o}{=} \PYG{n}{criterion}\PYG{p}{(}\PYG{n}{outputs}\PYG{p}{,} \PYG{n}{labels}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Backward pass and optimization}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{zero\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{loss}\PYG{o}{.}\PYG{n}{backward}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{optimizer}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{+}\PYG{o}{=} \PYG{n}{loss}\PYG{o}{.}\PYG{n}{item}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{avg\PYGZus{}loss} \PYG{o}{=} \PYG{n}{epoch\PYGZus{}loss} \PYG{o}{/} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{train\PYGZus{}loader}\PYG{p}{)}
    \PYG{n}{train\PYGZus{}losses}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{avg\PYGZus{}loss}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{epoch}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{n\PYGZus{}epochs}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, Loss: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{avg\PYGZus{}loss}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Evaluate model}
\PYG{n}{model}\PYG{o}{.}\PYG{n}{eval}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{with} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{no\PYGZus{}grad}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}tensor}\PYG{p}{)}
    \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{predicted} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{y\PYGZus{}pred}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{predicted}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{conf\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{predicted}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Test Accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s1}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot training loss}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{train\PYGZus{}losses}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Epoch}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Training Loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot confusion matrix}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{conf\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Blues}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Confusion Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add text annotations to confusion matrix}
\PYG{n}{thresh} \PYG{o}{=} \PYG{n}{conf\PYGZus{}matrix}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{conf\PYGZus{}matrix}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{conf\PYGZus{}matrix}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{j}\PYG{p}{,} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{conf\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                 \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{white}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{conf\PYGZus{}matrix}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{n}{thresh} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{black}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Simple Neuron Simulation}
\label{\detokenize{appendices/math_python_refresher:simple-neuron-simulation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{integrate}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{odeint}

\PYG{c+c1}{\PYGZsh{} Hodgkin\PYGZhy{}Huxley Neuron Model}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{HodgkinHuxleyNeuron}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Implementation of the Hodgkin\PYGZhy{}Huxley neuron model}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    The model describes the evolution of membrane voltage V and}
\PYG{l+s+sd}{    three gating variables m, n, and h using a system of ODEs}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Maximal conductances (mS/cm\PYGZca{}2)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{120.0}  \PYG{c+c1}{\PYGZsh{} Sodium}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}K} \PYG{o}{=} \PYG{l+m+mf}{36.0}    \PYG{c+c1}{\PYGZsh{} Potassium}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}L} \PYG{o}{=} \PYG{l+m+mf}{0.3}     \PYG{c+c1}{\PYGZsh{} Leak}
        
        \PYG{c+c1}{\PYGZsh{} Reversal potentials (mV)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}Na} \PYG{o}{=} \PYG{l+m+mf}{50.0}   \PYG{c+c1}{\PYGZsh{} Sodium}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}K} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{77.0}   \PYG{c+c1}{\PYGZsh{} Potassium}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}L} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{54.387} \PYG{c+c1}{\PYGZsh{} Leak}
        
        \PYG{c+c1}{\PYGZsh{} Membrane capacitance (µF/cm\PYGZca{}2)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{C\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{1.0}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Na+ activation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{40.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Na+ deactivation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{4.0} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{18.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Na+ inactivation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{0.07} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{65.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{20.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Na+ deinactivation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{35.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}K+ activation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{0.01} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{1.0} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mf}{55.0}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{10.0}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}K+ deactivation rate\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{l+m+mf}{0.125} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{V} \PYG{o}{+} \PYG{l+m+mi}{65}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mf}{80.0}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{I\PYGZus{}Na}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Na+ current\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}Na} \PYG{o}{*} \PYG{n}{m}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{h} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}Na}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{I\PYGZus{}K}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}K+ current\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}K} \PYG{o}{*} \PYG{n}{n}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{4} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}K}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{I\PYGZus{}L}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Leak current\PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g\PYGZus{}L} \PYG{o}{*} \PYG{p}{(}\PYG{n}{V} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{E\PYGZus{}L}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{dALLdt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}ext}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Compute derivatives for the complete system of ODEs}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} X: State vector [V, m, h, n]}
\PYG{l+s+sd}{        \PYGZhy{} t: Time}
\PYG{l+s+sd}{        \PYGZhy{} I\PYGZus{}ext: External current}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} dXdt: Derivatives [dV/dt, dm/dt, dh/dt, dn/dt]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{n} \PYG{o}{=} \PYG{n}{X}
        
        \PYG{c+c1}{\PYGZsh{} Steady\PYGZhy{}state values}
        \PYG{n}{m\PYGZus{}inf} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h\PYGZus{}inf} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{n\PYGZus{}inf} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Time constants}
        \PYG{n}{tau\PYGZus{}m} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{tau\PYGZus{}h} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{tau\PYGZus{}n} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Ionic currents}
        \PYG{n}{I\PYGZus{}Na} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{I\PYGZus{}Na}\PYG{p}{(}\PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}K} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{I\PYGZus{}K}\PYG{p}{(}\PYG{n}{V}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}
        \PYG{n}{I\PYGZus{}L} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{I\PYGZus{}L}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Membrane voltage derivative}
        \PYG{n}{dVdt} \PYG{o}{=} \PYG{p}{(}\PYG{n}{I\PYGZus{}ext} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}Na} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}K} \PYG{o}{\PYGZhy{}} \PYG{n}{I\PYGZus{}L}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{C\PYGZus{}m}
        
        \PYG{c+c1}{\PYGZsh{} Gating variables derivatives}
        \PYG{n}{dmdt} \PYG{o}{=} \PYG{p}{(}\PYG{n}{m\PYGZus{}inf} \PYG{o}{\PYGZhy{}} \PYG{n}{m}\PYG{p}{)} \PYG{o}{/} \PYG{n}{tau\PYGZus{}m}
        \PYG{n}{dhdt} \PYG{o}{=} \PYG{p}{(}\PYG{n}{h\PYGZus{}inf} \PYG{o}{\PYGZhy{}} \PYG{n}{h}\PYG{p}{)} \PYG{o}{/} \PYG{n}{tau\PYGZus{}h}
        \PYG{n}{dndt} \PYG{o}{=} \PYG{p}{(}\PYG{n}{n\PYGZus{}inf} \PYG{o}{\PYGZhy{}} \PYG{n}{n}\PYG{p}{)} \PYG{o}{/} \PYG{n}{tau\PYGZus{}n}
        
        \PYG{k}{return} \PYG{p}{[}\PYG{n}{dVdt}\PYG{p}{,} \PYG{n}{dmdt}\PYG{p}{,} \PYG{n}{dhdt}\PYG{p}{,} \PYG{n}{dndt}\PYG{p}{]}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}ext\PYGZus{}func}\PYG{p}{,} \PYG{n}{V0}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{65.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{        }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Simulate the neuron}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Parameters:}
\PYG{l+s+sd}{        \PYGZhy{} t: Time array}
\PYG{l+s+sd}{        \PYGZhy{} I\PYGZus{}ext\PYGZus{}func: Function that returns external current at time t}
\PYG{l+s+sd}{        \PYGZhy{} V0: Initial membrane voltage}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        Returns:}
\PYG{l+s+sd}{        \PYGZhy{} result: Solution array with columns [V, m, h, n]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Initial conditions [V, m, h, n]}
        \PYG{n}{m0} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}m}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}m}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{h0} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}h}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}h}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{n0} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{alpha\PYGZus{}n}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{beta\PYGZus{}n}\PYG{p}{(}\PYG{n}{V0}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{X0} \PYG{o}{=} \PYG{p}{[}\PYG{n}{V0}\PYG{p}{,} \PYG{n}{m0}\PYG{p}{,} \PYG{n}{h0}\PYG{p}{,} \PYG{n}{n0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Create I\PYGZus{}ext array}
        \PYG{n}{I\PYGZus{}ext} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{I\PYGZus{}ext\PYGZus{}func}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)} \PYG{k}{for} \PYG{n}{time} \PYG{o+ow}{in} \PYG{n}{t}\PYG{p}{]}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Solve ODE system for each time step}
        \PYG{n}{result} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{result}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{X0}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{t\PYGZus{}span} \PYG{o}{=} \PYG{p}{[}\PYG{n}{t}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{t}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{sol} \PYG{o}{=} \PYG{n}{odeint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dALLdt}\PYG{p}{,} \PYG{n}{result}\PYG{p}{[}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{t\PYGZus{}span}\PYG{p}{,} \PYG{n}{args}\PYG{o}{=}\PYG{p}{(}\PYG{n}{I\PYGZus{}ext}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{result}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{sol}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        
        \PYG{k}{return} \PYG{n}{result}

\PYG{c+c1}{\PYGZsh{} Create and simulate the Hodgkin\PYGZhy{}Huxley neuron}
\PYG{n}{neuron} \PYG{o}{=} \PYG{n}{HodgkinHuxleyNeuron}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Simulation parameters}
\PYG{n}{t\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mf}{50.0}  \PYG{c+c1}{\PYGZsh{} ms}
\PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mf}{0.01}  \PYG{c+c1}{\PYGZsh{} ms}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{t\PYGZus{}max}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} External current function (10µA/cm² pulse from 5ms to 30ms)}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{I\PYGZus{}ext}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{if} \PYG{l+m+mi}{5} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{n}{t} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{30}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{10.0}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+m+mf}{0.0}

\PYG{c+c1}{\PYGZsh{} Run simulation}
\PYG{n}{result} \PYG{o}{=} \PYG{n}{neuron}\PYG{o}{.}\PYG{n}{simulate}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}ext}\PYG{p}{)}
\PYG{n}{V}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{n}{n} \PYG{o}{=} \PYG{n}{result}\PYG{o}{.}\PYG{n}{T}

\PYG{c+c1}{\PYGZsh{} Create I\PYGZus{}ext array for plotting}
\PYG{n}{I\PYGZus{}ext\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{I\PYGZus{}ext}\PYG{p}{(}\PYG{n}{time}\PYG{p}{)} \PYG{k}{for} \PYG{n}{time} \PYG{o+ow}{in} \PYG{n}{t}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot results}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Membrane voltage}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{V}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Voltage (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Hodgkin\PYGZhy{}Huxley Neuron Model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Gating variables}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{m}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{m (Na+ activation)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{h}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{h (Na+ inactivation)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{n}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n (K+ activation)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gating Value}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Ionic currents}
\PYG{n}{I\PYGZus{}Na} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{neuron}\PYG{o}{.}\PYG{n}{I\PYGZus{}Na}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{m}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{h}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{I\PYGZus{}K} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{neuron}\PYG{o}{.}\PYG{n}{I\PYGZus{}K}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{n}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{I\PYGZus{}L} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{neuron}\PYG{o}{.}\PYG{n}{I\PYGZus{}L}\PYG{p}{(}\PYG{n}{V}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}Na}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Na+ Current}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}K}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{K+ Current}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}L}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Leak Current}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Current (µA/cm²)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} External current}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{I\PYGZus{}ext\PYGZus{}array}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (ms)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Stimulus (µA/cm²)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
These examples and refreshers should provide the necessary background for understanding the more advanced concepts presented in the handbook chapters.

\sphinxstepscope


\chapter{Appendix B: Dataset Catalogue}
\label{\detokenize{appendices/dataset_catalogue:appendix-b-dataset-catalogue}}\label{\detokenize{appendices/dataset_catalogue::doc}}
\sphinxAtStartPar
This appendix provides a comprehensive list of datasets relevant for neuroAI research, along with access information and example code for loading and working with these datasets.


\section{B.1 Neuroscience Datasets}
\label{\detokenize{appendices/dataset_catalogue:b-1-neuroscience-datasets}}

\subsection{Electrophysiology Data}
\label{\detokenize{appendices/dataset_catalogue:electrophysiology-data}}

\subsubsection{Allen Brain Observatory}
\label{\detokenize{appendices/dataset_catalogue:allen-brain-observatory}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Single\sphinxhyphen{}cell recordings from visual cortex of mice during visual stimulation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Neural activity from \textasciitilde{}75,000 neurons across multiple cortical areas and layers

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://observatory.brain-map.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://allensdk.readthedocs.io/en/latest/brain\_observatory.html}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Loading Allen Brain Observatory data}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{allensdk}\PYG{n+nn}{.}\PYG{n+nn}{core}\PYG{n+nn}{.}\PYG{n+nn}{brain\PYGZus{}observatory\PYGZus{}cache}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BrainObservatoryCache}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Initialize the cache}
\PYG{n}{boc} \PYG{o}{=} \PYG{n}{BrainObservatoryCache}\PYG{p}{(}\PYG{n}{manifest\PYGZus{}file}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{boc\PYGZus{}manifest.json}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get experiment containers for specific targeted structures and imaging depths}
\PYG{n}{experiments} \PYG{o}{=} \PYG{n}{boc}\PYG{o}{.}\PYG{n}{get\PYGZus{}experiment\PYGZus{}containers}\PYG{p}{(}\PYG{n}{targeted\PYGZus{}structures}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{VISp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} 
                                       \PYG{n}{imaging\PYGZus{}depths}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{175}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Access the first experiment}
\PYG{n}{container\PYGZus{}id} \PYG{o}{=} \PYG{n}{experiments}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Get experiment with natural scenes stimulus}
\PYG{n}{experiment\PYGZus{}id} \PYG{o}{=} \PYG{n}{boc}\PYG{o}{.}\PYG{n}{get\PYGZus{}ophys\PYGZus{}experiments}\PYG{p}{(}
    \PYG{n}{experiment\PYGZus{}container\PYGZus{}ids}\PYG{o}{=}\PYG{p}{[}\PYG{n}{container\PYGZus{}id}\PYG{p}{]}\PYG{p}{,}
    \PYG{n}{stimuli}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{natural\PYGZus{}scenes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Get neural data}
\PYG{n}{data\PYGZus{}set} \PYG{o}{=} \PYG{n}{boc}\PYG{o}{.}\PYG{n}{get\PYGZus{}ophys\PYGZus{}experiment\PYGZus{}data}\PYG{p}{(}\PYG{n}{experiment\PYGZus{}id}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get fluorescence traces for all cells}
\PYG{n}{timestamps}\PYG{p}{,} \PYG{n}{traces} \PYG{o}{=} \PYG{n}{data\PYGZus{}set}\PYG{o}{.}\PYG{n}{get\PYGZus{}fluorescence\PYGZus{}traces}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Recorded }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{traces}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ neurons for }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{timestamps}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ timepoints}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot example trace from first neuron}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{timestamps}\PYG{p}{,} \PYG{n}{traces}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Fluorescence (a.u.)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Example Neuron Activity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Collaborative Research in Computational Neuroscience (CRCNS)}
\label{\detokenize{appendices/dataset_catalogue:collaborative-research-in-computational-neuroscience-crcns}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Diverse electrophysiology datasets from various labs and species

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Single\sphinxhyphen{}unit and multi\sphinxhyphen{}unit recordings, EEG, MEG, and more

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://crcns.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: Varies by dataset

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Loading CRCNS data (HC1 \PYGZhy{} hippocampal recordings from rats)}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{h5py}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Open the HDF5 file (you would need to download this)}
\PYG{k}{with} \PYG{n}{h5py}\PYG{o}{.}\PYG{n}{File}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{example\PYGZus{}data.h5}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} List all groups}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Keys: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{\PYGZpc{}} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{f}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get spike times for a specific cell}
    \PYG{n}{spikes} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{f}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spikes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{times}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot raster}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spikes}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Neurodata Without Borders (NWB)}
\label{\detokenize{appendices/dataset_catalogue:neurodata-without-borders-nwb}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Standardized format for neurophysiology data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Various datasets following the NWB format standard

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.nwb.org/example-datasets/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://pynwb.readthedocs.io/}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Reading NWB formatted data}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pynwb}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{NWBHDF5IO}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Open NWB file (you would need to download an example file)}
\PYG{k}{with} \PYG{n}{NWBHDF5IO}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{example.nwb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{io}\PYG{p}{:}
    \PYG{n}{nwbfile} \PYG{o}{=} \PYG{n}{io}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print available acquisition data}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{nwbfile}\PYG{o}{.}\PYG{n}{acquisition}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Access LFP data if available}
    \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{nwbfile}\PYG{o}{.}\PYG{n}{acquisition}\PYG{p}{:}
        \PYG{n}{lfp\PYGZus{}data} \PYG{o}{=} \PYG{n}{nwbfile}\PYG{o}{.}\PYG{n}{acquisition}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}
        \PYG{n}{lfp\PYGZus{}timestamps} \PYG{o}{=} \PYG{n}{nwbfile}\PYG{o}{.}\PYG{n}{acquisition}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{timestamps}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Plot LFP}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lfp\PYGZus{}timestamps}\PYG{p}{,} \PYG{n}{lfp\PYGZus{}data}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Voltage (mV)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LFP Recording}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Neuroimaging Data}
\label{\detokenize{appendices/dataset_catalogue:neuroimaging-data}}

\subsubsection{Human Connectome Project (HCP)}
\label{\detokenize{appendices/dataset_catalogue:human-connectome-project-hcp}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: High\sphinxhyphen{}quality neuroimaging data from 1,200+ healthy young adults

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: MRI (structural, functional, diffusion), MEG, behavioral, and genetic data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.humanconnectome.org/study/hcp-young-adult}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://www.humanconnectome.org/study/hcp-young-adult/documentation}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with HCP data using nilearn}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{nilearn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{datasets}\PYG{p}{,} \PYG{n}{plotting}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Download a preprocessed resting\PYGZhy{}state fMRI from HCP}
\PYG{c+c1}{\PYGZsh{} Note: You need to register and get credentials for actual HCP data}
\PYG{c+c1}{\PYGZsh{} This example uses a sample from nilearn, not the actual HCP dataset}
\PYG{n}{hcp\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{datasets}\PYG{o}{.}\PYG{n}{fetch\PYGZus{}development\PYGZus{}fmri}\PYG{p}{(}\PYG{n}{n\PYGZus{}subjects}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get the first subject\PYGZsq{}s data}
\PYG{n}{func\PYGZus{}filename} \PYG{o}{=} \PYG{n}{hcp\PYGZus{}dataset}\PYG{o}{.}\PYG{n}{func}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Plot the mean image}
\PYG{n}{mean\PYGZus{}img} \PYG{o}{=} \PYG{n}{plotting}\PYG{o}{.}\PYG{n}{plot\PYGZus{}epi}\PYG{p}{(}\PYG{n}{func\PYGZus{}filename}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean fMRI image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the temporal variance}
\PYG{n}{var\PYGZus{}img} \PYG{o}{=} \PYG{n}{plotting}\PYG{o}{.}\PYG{n}{plot\PYGZus{}stat\PYGZus{}map}\PYG{p}{(}\PYG{n}{plotting}\PYG{o}{.}\PYG{n}{mean\PYGZus{}img}\PYG{p}{(}\PYG{n}{func\PYGZus{}filename}\PYG{p}{)}\PYG{p}{,} 
                              \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Temporal variance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{OpenNeuro}
\label{\detokenize{appendices/dataset_catalogue:openneuro}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Open platform for sharing BIDS\sphinxhyphen{}compatible neuroimaging data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: fMRI, EEG, MEG, iEEG datasets from various studies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://openneuro.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: Varies by dataset

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using openneuro\PYGZhy{}py to download data}
\PYG{c+c1}{\PYGZsh{} !pip install openneuro\PYGZhy{}py}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{openneuro}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}

\PYG{c+c1}{\PYGZsh{} Create a download instance}
\PYG{n}{api} \PYG{o}{=} \PYG{n}{openneuro}\PYG{o}{.}\PYG{n}{OpenNeuroAPI}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Specify dataset ID (ds002422 is an example, you can find many on the website)}
\PYG{n}{dataset\PYGZus{}id} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ds002422}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Set download directory}
\PYG{n}{download\PYGZus{}dir} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./openneuro\PYGZus{}data}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{download\PYGZus{}dir}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Download a specific dataset}
\PYG{c+c1}{\PYGZsh{} This downloads the dataset metadata}
\PYG{n}{downloader} \PYG{o}{=} \PYG{n}{api}\PYG{o}{.}\PYG{n}{download}\PYG{p}{(}\PYG{n}{dataset\PYGZus{}id}\PYG{p}{,} \PYG{n}{download\PYGZus{}dir}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} List all files (doesn\PYGZsq{}t download them yet)}
\PYG{n}{files} \PYG{o}{=} \PYG{p}{[}\PYG{n}{f} \PYG{k}{for} \PYG{n}{f} \PYG{o+ow}{in} \PYG{n}{downloader}\PYG{o}{.}\PYG{n}{files} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{f}\PYG{o}{.}\PYG{n}{endswith}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{]}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Total files: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{files}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Download a specific file}
\PYG{c+c1}{\PYGZsh{} downloader.download([files[0]])  \PYGZsh{} Uncomment to actually download}

\PYG{c+c1}{\PYGZsh{} For working with the data, you would typically use BIDS tools}
\PYG{c+c1}{\PYGZsh{} !pip install pybids}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{bids}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BIDSLayout}

\PYG{c+c1}{\PYGZsh{} Create a layout to work with the BIDS dataset (only metadata)}
\PYG{n}{layout} \PYG{o}{=} \PYG{n}{BIDSLayout}\PYG{p}{(}\PYG{n}{download\PYGZus{}dir}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get all available sessions}
\PYG{n}{sessions} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get\PYGZus{}sessions}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Available sessions: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sessions}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get functional MRI runs}
\PYG{n}{runs} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{datatype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{func}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{extension}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.nii.gz}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Number of fMRI runs: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{runs}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{NeuroVault}
\label{\detokenize{appendices/dataset_catalogue:neurovault}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Repository for statistical maps of the human brain

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: fMRI and PET statistical maps

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://neurovault.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/NeuroVault/NeuroVault}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using neurovault\PYGZsq{}s API}
\PYG{c+c1}{\PYGZsh{} !pip install requests}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{requests}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{nilearn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{plotting}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{nibabel}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}

\PYG{c+c1}{\PYGZsh{} Get collection info (collection 1952 is an example)}
\PYG{n}{base\PYGZus{}url} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{https://neurovault.org/api/collections/1952/}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{base\PYGZus{}url}\PYG{p}{)}
\PYG{n}{collection\PYGZus{}data} \PYG{o}{=} \PYG{n}{response}\PYG{o}{.}\PYG{n}{json}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get images in the collection}
\PYG{n}{images\PYGZus{}url} \PYG{o}{=} \PYG{n}{base\PYGZus{}url} \PYG{o}{+} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{images/}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{images\PYGZus{}url}\PYG{p}{)}
\PYG{n}{images\PYGZus{}data} \PYG{o}{=} \PYG{n}{response}\PYG{o}{.}\PYG{n}{json}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{results}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Found }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{images\PYGZus{}data}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ images}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Download and display the first image}
\PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{images\PYGZus{}data}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Get download URL for the first image}
    \PYG{n}{img\PYGZus{}url} \PYG{o}{=} \PYG{n}{images\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{file}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    \PYG{n}{img\PYGZus{}name} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{n}{img\PYGZus{}url}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Download the image}
    \PYG{n}{img\PYGZus{}response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{img\PYGZus{}url}\PYG{p}{)}
    \PYG{k}{with} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{img\PYGZus{}name}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{n}{f}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n}{img\PYGZus{}response}\PYG{o}{.}\PYG{n}{content}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Load and display the image}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{nib}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{img\PYGZus{}name}\PYG{p}{)}
    \PYG{n}{plotting}\PYG{o}{.}\PYG{n}{plot\PYGZus{}stat\PYGZus{}map}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{n}{images\PYGZus{}data}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Behavior and Cognition}
\label{\detokenize{appendices/dataset_catalogue:behavior-and-cognition}}

\subsubsection{International Brain Laboratory (IBL)}
\label{\detokenize{appendices/dataset_catalogue:international-brain-laboratory-ibl}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Standardized mouse behavioral and neural data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Neural recordings during decision\sphinxhyphen{}making tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.internationalbrainlab.com/public-resources}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://docs.internationalbrainlab.org/}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Loading IBL data}
\PYG{c+c1}{\PYGZsh{} !pip install ONE\PYGZhy{}api}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{one}\PYG{n+nn}{.}\PYG{n+nn}{api}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{ONE}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Initialize ONE}
\PYG{n}{one} \PYG{o}{=} \PYG{n}{ONE}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Search for sessions with available data types}
\PYG{n}{selection} \PYG{o}{=} \PYG{n}{one}\PYG{o}{.}\PYG{n}{search}\PYG{p}{(}\PYG{n}{dataset\PYGZus{}types}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spikes.times}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Found }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{selection}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ sessions}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Select the first session}
\PYG{n}{eid} \PYG{o}{=} \PYG{n}{selection}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} List all available data for this session}
\PYG{n}{datasets} \PYG{o}{=} \PYG{n}{one}\PYG{o}{.}\PYG{n}{list\PYGZus{}datasets}\PYG{p}{(}\PYG{n}{eid}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Available datasets: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{datasets}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load spike data}
\PYG{n}{spikes\PYGZus{}times}\PYG{p}{,} \PYG{n}{spikes\PYGZus{}clusters} \PYG{o}{=} \PYG{n}{one}\PYG{o}{.}\PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{n}{eid}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spikes.times}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{one}\PYG{o}{.}\PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{n}{eid}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{spikes.clusters}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load trial data}
\PYG{n}{trials} \PYG{o}{=} \PYG{n}{one}\PYG{o}{.}\PYG{n}{load\PYGZus{}object}\PYG{p}{(}\PYG{n}{eid}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{trials}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot raster for a few neurons}
\PYG{n}{unique\PYGZus{}clusters} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{spikes\PYGZus{}clusters}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Total neurons: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{unique\PYGZus{}clusters}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot raster for 5 clusters}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{cluster\PYGZus{}id} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{unique\PYGZus{}clusters}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{cluster\PYGZus{}spikes} \PYG{o}{=} \PYG{n}{spikes\PYGZus{}times}\PYG{p}{[}\PYG{n}{spikes\PYGZus{}clusters} \PYG{o}{==} \PYG{n}{cluster\PYGZus{}id}\PYG{p}{]}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{cluster\PYGZus{}spikes}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{cluster\PYGZus{}spikes}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron ID}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{Brain Imaging Data Structure (BIDS) Examples}
\label{\detokenize{appendices/dataset_catalogue:brain-imaging-data-structure-bids-examples}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Standardized datasets following BIDS format

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Various types of brain imaging and behavioral data

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://github.com/bids-standard/bids-examples}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://bids.neuroimaging.io/}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with BIDS datasets}
\PYG{c+c1}{\PYGZsh{} !pip install pybids}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{bids}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BIDSLayout}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}

\PYG{c+c1}{\PYGZsh{} Path to the BIDS dataset}
\PYG{n}{bids\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./bids\PYGZus{}dataset}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} You would need to download or have a BIDS dataset}

\PYG{c+c1}{\PYGZsh{} Check if path exists}
\PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{bids\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Initialize layout}
    \PYG{n}{layout} \PYG{o}{=} \PYG{n}{BIDSLayout}\PYG{p}{(}\PYG{n}{bids\PYGZus{}path}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get participant information}
    \PYG{n}{subjects} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get\PYGZus{}subjects}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Subjects: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{subjects}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get available modalities}
    \PYG{n}{modalities} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get\PYGZus{}modalities}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modalities: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{modalities}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get all T1w images}
    \PYG{n}{t1w\PYGZus{}images} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{suffix}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T1w}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{extension}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.nii.gz}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Found }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t1w\PYGZus{}images}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ T1w images}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get task fMRI data}
    \PYG{n}{func\PYGZus{}runs} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{datatype}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{func}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{suffix}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Found }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{func\PYGZus{}runs}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ functional runs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Access metadata for a specific file}
    \PYG{k}{if} \PYG{n}{func\PYGZus{}runs}\PYG{p}{:}
        \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{layout}\PYG{o}{.}\PYG{n}{get\PYGZus{}metadata}\PYG{p}{(}\PYG{n}{func\PYGZus{}runs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{path}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Sample metadata:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{key}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{metadata}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{:}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{key}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{value}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{BIDS dataset not found at }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{bids\PYGZus{}path}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{B.2 AI Benchmark Datasets}
\label{\detokenize{appendices/dataset_catalogue:b-2-ai-benchmark-datasets}}

\subsection{Computer Vision}
\label{\detokenize{appendices/dataset_catalogue:computer-vision}}

\subsubsection{ImageNet}
\label{\detokenize{appendices/dataset_catalogue:imagenet}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Large\sphinxhyphen{}scale image classification benchmark

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: \textasciitilde{}14 million images across 20,000+ categories

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.image-net.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://www.image-net.org/challenges/LSVRC/}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using PyTorch\PYGZsq{}s ImageNet loader}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{datasets}\PYG{p}{,} \PYG{n}{transforms}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Define transformations}
\PYG{n}{transform} \PYG{o}{=} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Compose}\PYG{p}{(}\PYG{p}{[}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Resize}\PYG{p}{(}\PYG{l+m+mi}{256}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{CenterCrop}\PYG{p}{(}\PYG{l+m+mi}{224}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ToTensor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Normalize}\PYG{p}{(}\PYG{n}{mean}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.485}\PYG{p}{,} \PYG{l+m+mf}{0.456}\PYG{p}{,} \PYG{l+m+mf}{0.406}\PYG{p}{]}\PYG{p}{,} 
                         \PYG{n}{std}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.229}\PYG{p}{,} \PYG{l+m+mf}{0.224}\PYG{p}{,} \PYG{l+m+mf}{0.225}\PYG{p}{]}\PYG{p}{)}
\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load ImageNet validation set (you need to have this downloaded)}
\PYG{c+c1}{\PYGZsh{} Replace \PYGZsq{}path/to/imagenet/val\PYGZsq{} with your actual path}
\PYG{k}{try}\PYG{p}{:}
    \PYG{n}{val\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{datasets}\PYG{o}{.}\PYG{n}{ImageNet}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{path/to/imagenet/val}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{split}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{transform}\PYG{p}{)}
    \PYG{n}{val\PYGZus{}loader} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{utils}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{val\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get a batch of images}
    \PYG{n}{images}\PYG{p}{,} \PYG{n}{labels} \PYG{o}{=} \PYG{n+nb}{next}\PYG{p}{(}\PYG{n+nb}{iter}\PYG{p}{(}\PYG{n}{val\PYGZus{}loader}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Display images}
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Unnormalize}
        \PYG{n}{inv\PYGZus{}normalize} \PYG{o}{=} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Normalize}\PYG{p}{(}
            \PYG{n}{mean}\PYG{o}{=}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.485}\PYG{o}{/}\PYG{l+m+mf}{0.229}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.456}\PYG{o}{/}\PYG{l+m+mf}{0.224}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.406}\PYG{o}{/}\PYG{l+m+mf}{0.225}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{std}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{l+m+mf}{0.229}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{l+m+mf}{0.224}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{l+m+mf}{0.225}\PYG{p}{]}
        \PYG{p}{)}
        \PYG{n}{img} \PYG{o}{=} \PYG{n}{inv\PYGZus{}normalize}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}
        \PYG{n}{npimg} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{npimg}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{imshow}\PYG{p}{(}\PYG{n}{torchvision}\PYG{o}{.}\PYG{n}{utils}\PYG{o}{.}\PYG{n}{make\PYGZus{}grid}\PYG{p}{(}\PYG{n}{images}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ImageNet Samples}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error loading ImageNet: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Note: You need to download the ImageNet dataset separately due to its size and license.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{CIFAR\sphinxhyphen{}10/100}
\label{\detokenize{appendices/dataset_catalogue:cifar-10-100}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Small\sphinxhyphen{}scale image classification datasets

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: 60,000 32x32 color images in 10 or 100 classes

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.cs.toronto.edu/~kriz/cifar.html}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: Built into most deep learning frameworks

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using CIFAR\PYGZhy{}10 with PyTorch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torchvision}\PYG{n+nn}{.}\PYG{n+nn}{transforms}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{transforms}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Define transformations}
\PYG{n}{transform} \PYG{o}{=} \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Compose}\PYG{p}{(}\PYG{p}{[}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{ToTensor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{transforms}\PYG{o}{.}\PYG{n}{Normalize}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{)}
\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load CIFAR\PYGZhy{}10 (downloaded automatically if not present)}
\PYG{n}{train\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{torchvision}\PYG{o}{.}\PYG{n}{datasets}\PYG{o}{.}\PYG{n}{CIFAR10}\PYG{p}{(}\PYG{n}{root}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{train}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
                                             \PYG{n}{download}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{transform}\PYG{p}{)}
\PYG{n}{train\PYGZus{}loader} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{utils}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{train\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
                                           \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{num\PYGZus{}workers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}

\PYG{n}{test\PYGZus{}dataset} \PYG{o}{=} \PYG{n}{torchvision}\PYG{o}{.}\PYG{n}{datasets}\PYG{o}{.}\PYG{n}{CIFAR10}\PYG{p}{(}\PYG{n}{root}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{train}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,}
                                            \PYG{n}{download}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{transform}\PYG{p}{)}
\PYG{n}{test\PYGZus{}loader} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{utils}\PYG{o}{.}\PYG{n}{data}\PYG{o}{.}\PYG{n}{DataLoader}\PYG{p}{(}\PYG{n}{test\PYGZus{}dataset}\PYG{p}{,} \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
                                          \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{num\PYGZus{}workers}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Class labels}
\PYG{n}{classes} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{plane}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{car}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bird}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{deer}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dog}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{frog}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{horse}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ship}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{truck}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Function to display images}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{img} \PYG{o}{/} \PYG{l+m+mi}{2} \PYG{o}{+} \PYG{l+m+mf}{0.5}  \PYG{c+c1}{\PYGZsh{} Unnormalize}
    \PYG{n}{npimg} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{numpy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{npimg}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get some random training images}
\PYG{n}{dataiter} \PYG{o}{=} \PYG{n+nb}{iter}\PYG{p}{(}\PYG{n}{train\PYGZus{}loader}\PYG{p}{)}
\PYG{n}{images}\PYG{p}{,} \PYG{n}{labels} \PYG{o}{=} \PYG{n+nb}{next}\PYG{p}{(}\PYG{n}{dataiter}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Show images}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{torchvision}\PYG{o}{.}\PYG{n}{utils}\PYG{o}{.}\PYG{n}{make\PYGZus{}grid}\PYG{p}{(}\PYG{n}{images}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZpc{}5s}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}} \PYG{n}{classes}\PYG{p}{[}\PYG{n}{labels}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{]} \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{MS COCO}
\label{\detokenize{appendices/dataset_catalogue:ms-coco}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Dataset for object detection, segmentation, and captioning

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: 330,000+ images with 80 object categories

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://cocodataset.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/cocodataset/cocoapi}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with COCO dataset}
\PYG{c+c1}{\PYGZsh{} !pip install pycocotools}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pycocotools}\PYG{n+nn}{.}\PYG{n+nn}{coco}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{COCO}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{io}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{requests}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{io}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BytesIO}

\PYG{c+c1}{\PYGZsh{} Initialize COCO API for instance annotations}
\PYG{n}{dataType} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{val2017}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{annFile} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./annotations/instances\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{dataType}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{.json}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} You need to download this}

\PYG{k}{try}\PYG{p}{:}
    \PYG{n}{coco} \PYG{o}{=} \PYG{n}{COCO}\PYG{p}{(}\PYG{n}{annFile}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get categories and supercategories}
    \PYG{n}{cats} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{loadCats}\PYG{p}{(}\PYG{n}{coco}\PYG{o}{.}\PYG{n}{getCatIds}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{cat\PYGZus{}names} \PYG{o}{=} \PYG{p}{[}\PYG{n}{cat}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{cat} \PYG{o+ow}{in} \PYG{n}{cats}\PYG{p}{]}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{COCO categories: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{cat\PYGZus{}names}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get all images containing specific categories}
    \PYG{n}{catIds} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{getCatIds}\PYG{p}{(}\PYG{n}{catNms}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{person}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dog}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{skateboard}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{imgIds} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{getImgIds}\PYG{p}{(}\PYG{n}{catIds}\PYG{o}{=}\PYG{n}{catIds}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Found }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{imgIds}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ images with specified categories}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Load and display an image}
    \PYG{k}{if} \PYG{n}{imgIds}\PYG{p}{:}
        \PYG{n}{img} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{loadImgs}\PYG{p}{(}\PYG{n}{imgIds}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{imgIds}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Use URL to load image}
        \PYG{n}{I} \PYG{o}{=} \PYG{n}{io}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n}{img}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coco\PYGZus{}url}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{I}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Load and display instance annotations}
        \PYG{n}{annIds} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{getAnnIds}\PYG{p}{(}\PYG{n}{imgIds}\PYG{o}{=}\PYG{n}{img}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{catIds}\PYG{o}{=}\PYG{n}{catIds}\PYG{p}{,} \PYG{n}{iscrowd}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}
        \PYG{n}{anns} \PYG{o}{=} \PYG{n}{coco}\PYG{o}{.}\PYG{n}{loadAnns}\PYG{p}{(}\PYG{n}{annIds}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{I}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{coco}\PYG{o}{.}\PYG{n}{showAnns}\PYG{p}{(}\PYG{n}{anns}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error working with COCO: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Note: You need to download the COCO dataset separately.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Display a sample image from the COCO website instead}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{n}{url} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{http://images.cocodataset.org/val2017/000000013729.jpg}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{url}\PYG{p}{)}
        \PYG{n}{I} \PYG{o}{=} \PYG{n}{io}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n}{BytesIO}\PYG{p}{(}\PYG{n}{response}\PYG{o}{.}\PYG{n}{content}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{I}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Sample COCO Image}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{except}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Could not display sample image}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Natural Language Processing}
\label{\detokenize{appendices/dataset_catalogue:natural-language-processing}}

\subsubsection{GLUE Benchmark}
\label{\detokenize{appendices/dataset_catalogue:glue-benchmark}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: General Language Understanding Evaluation benchmark

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Collection of 9 NLP tasks for evaluating language understanding

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://gluebenchmark.com/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/nyu-mll/GLUE-baselines}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Loading GLUE tasks with the datasets library}
\PYG{c+c1}{\PYGZsh{} !pip install datasets transformers}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}dataset}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{transformers}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{AutoTokenizer}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}

\PYG{c+c1}{\PYGZsh{} Load a GLUE task (MNLI for example)}
\PYG{n}{dataset} \PYG{o}{=} \PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{glue}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mnli}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Print dataset structure}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dataset structure:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{dataset}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load a tokenizer}
\PYG{n}{tokenizer} \PYG{o}{=} \PYG{n}{AutoTokenizer}\PYG{o}{.}\PYG{n}{from\PYGZus{}pretrained}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bert\PYGZhy{}base\PYGZhy{}uncased}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Display some examples}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Example data:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{dataset}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{premise}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{hypothesis}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{label}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define a function to tokenize the data}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{tokenize\PYGZus{}function}\PYG{p}{(}\PYG{n}{examples}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{tokenizer}\PYG{p}{(}
        \PYG{n}{examples}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{premise}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{examples}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{hypothesis}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{padding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{max\PYGZus{}length}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{truncation}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
    \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Tokenize the dataset}
\PYG{n}{tokenized\PYGZus{}datasets} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{map}\PYG{p}{(}\PYG{n}{tokenize\PYGZus{}function}\PYG{p}{,} \PYG{n}{batched}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Tokenized dataset features:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{tokenized\PYGZus{}datasets}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{column\PYGZus{}names}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{SQuAD}
\label{\detokenize{appendices/dataset_catalogue:squad}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Stanford Question Answering Dataset

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: 100,000+ question\sphinxhyphen{}answer pairs on Wikipedia articles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://rajpurkar.github.io/SQuAD-explorer/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/rajpurkar/SQuAD-explorer}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with SQuAD dataset}
\PYG{c+c1}{\PYGZsh{} !pip install datasets transformers}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}dataset}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{random}

\PYG{c+c1}{\PYGZsh{} Load SQuAD dataset}
\PYG{n}{squad} \PYG{o}{=} \PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{squad}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Print dataset structure}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dataset structure:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{squad}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Convert a few examples to DataFrame for easier viewing}
\PYG{n}{train\PYGZus{}examples} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{example} \PYG{o+ow}{in} \PYG{n}{squad}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{:}
    \PYG{n}{train\PYGZus{}examples}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{question}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{example}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{question}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{example}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{context}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{100}\PYG{p}{]} \PYG{o}{+} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Truncate for display}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{answers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{example}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{answers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{train\PYGZus{}examples}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Sample questions and answers:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{df}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Select a random example and show full context}
\PYG{n}{random\PYGZus{}idx} \PYG{o}{=} \PYG{n}{random}\PYG{o}{.}\PYG{n}{randint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{squad}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{example} \PYG{o}{=} \PYG{n}{squad}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{random\PYGZus{}idx}\PYG{p}{]}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Random example:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Question: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{example}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{question}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Answer: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{example}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{answers}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Context: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{example}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{context}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{WikiText}
\label{\detokenize{appendices/dataset_catalogue:wikitext}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Language modeling dataset of Wikipedia articles

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: 103 million words with long\sphinxhyphen{}context dependencies

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://blog.salesforceairesearch.com/the-wikitext-long-term-dependency-language-modeling-dataset/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/salesforce/awd-lstm-lm}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Loading WikiText dataset}
\PYG{c+c1}{\PYGZsh{} !pip install datasets}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datasets}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{load\PYGZus{}dataset}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} Load WikiText\PYGZhy{}2 dataset}
\PYG{n}{wikitext} \PYG{o}{=} \PYG{n}{load\PYGZus{}dataset}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wikitext}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wikitext\PYGZhy{}2\PYGZhy{}raw\PYGZhy{}v1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Print dataset structure}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Dataset structure:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{wikitext}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Display a sample from the training set}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Sample from training set:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{wikitext}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{100}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compute statistics}
\PYG{n}{train\PYGZus{}lens} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sample}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{k}{for} \PYG{n}{sample} \PYG{o+ow}{in} \PYG{n}{wikitext}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{k}{if} \PYG{n}{sample}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{strip}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Plot distribution of sequence lengths}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sequence Length (words)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribution of Sequence Lengths in WikiText\PYGZhy{}2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{)}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dashed}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{)}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dashed}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Median: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s1}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Count total words}
\PYG{n}{total\PYGZus{}words} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{n}{train\PYGZus{}lens}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Total words in training set: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{total\PYGZus{}words}\PYG{l+s+si}{:}\PYG{l+s+s2}{,}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Compute vocabulary size (unique words)}
\PYG{n}{all\PYGZus{}text} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ }\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{[}\PYG{n}{sample}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{k}{for} \PYG{n}{sample} \PYG{o+ow}{in} \PYG{n}{wikitext}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{train}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{k}{if} \PYG{n}{sample}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{text}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{strip}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{vocab} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{all\PYGZus{}text}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Vocabulary size: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{vocab}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{,}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ unique words}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Reinforcement Learning}
\label{\detokenize{appendices/dataset_catalogue:reinforcement-learning}}

\subsubsection{OpenAI Gym}
\label{\detokenize{appendices/dataset_catalogue:openai-gym}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Toolkit for developing and comparing RL algorithms

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Collection of environments from simple to complex

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://gym.openai.com/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/openai/gym}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Basic usage of OpenAI Gym}
\PYG{c+c1}{\PYGZsh{} !pip install gym}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gym}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{animation}

\PYG{c+c1}{\PYGZsh{} Create an environment}
\PYG{n}{env} \PYG{o}{=} \PYG{n}{gym}\PYG{o}{.}\PYG{n}{make}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CartPole\PYGZhy{}v1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Reset the environment}
\PYG{n}{observation} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Run a simple random policy}
\PYG{n}{frames} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{done} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Render the environment}
    \PYG{n}{frames}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{render}\PYG{p}{(}\PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rgb\PYGZus{}array}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Take a random action}
    \PYG{n}{action} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{action\PYGZus{}space}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Step in the environment}
    \PYG{n}{observation}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{info} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{action}\PYG{p}{)}
    
    \PYG{k}{if} \PYG{n}{done}\PYG{p}{:}
        \PYG{n}{observation} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{env}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Display the animation}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}frame}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{clf}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{frames}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{[}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}

\PYG{n}{ani} \PYG{o}{=} \PYG{n}{animation}\PYG{o}{.}\PYG{n}{FuncAnimation}\PYG{p}{(}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gcf}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{update\PYGZus{}frame}\PYG{p}{,} \PYG{n}{frames}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{frames}\PYG{p}{)}\PYG{p}{,} \PYG{n}{interval}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Print environment details}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Observation space: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{env}\PYG{o}{.}\PYG{n}{observation\PYGZus{}space}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Action space: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{env}\PYG{o}{.}\PYG{n}{action\PYGZus{}space}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{DeepMind Lab}
\label{\detokenize{appendices/dataset_catalogue:deepmind-lab}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: 3D learning environment based on Quake III Arena

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Navigation and puzzle\sphinxhyphen{}solving tasks in 3D environment

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://github.com/deepmind/lab}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/deepmind/lab/blob/master/docs/users/python\_api.md}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using DeepMind Lab (note: requires separate installation)}
\PYG{k}{try}\PYG{p}{:}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{deepmind\PYGZus{}lab}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple DeepMind Lab environment}
    \PYG{n}{lab} \PYG{o}{=} \PYG{n}{deepmind\PYGZus{}lab}\PYG{o}{.}\PYG{n}{Lab}\PYG{p}{(}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seekavoid\PYGZus{}arena\PYGZus{}01}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Level name}
        \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RGB\PYGZus{}INTERLEAVED}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Observations to return}
        \PYG{n}{config}\PYG{o}{=}\PYG{p}{\PYGZob{}}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{320}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{height}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{240}\PYG{p}{,}
            \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fps}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{60}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reset the environment}
    \PYG{n}{lab}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run a few random actions and display observations}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Generate a random action (forward/backward, strafe, look)}
        \PYG{n}{action} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{7}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{intc}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} DeepMind Lab actions are 7D}
        \PYG{n}{action}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Forward/backward}
        \PYG{n}{action}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Strafe left/right}
        
        \PYG{c+c1}{\PYGZsh{} Step in the environment}
        \PYG{n}{reward} \PYG{o}{=} \PYG{n}{lab}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{action}\PYG{p}{,} \PYG{n}{num\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Execute 4 frames}
        
        \PYG{c+c1}{\PYGZsh{} Get observation}
        \PYG{n}{obs} \PYG{o}{=} \PYG{n}{lab}\PYG{o}{.}\PYG{n}{observations}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RGB\PYGZus{}INTERLEAVED}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        
        \PYG{c+c1}{\PYGZsh{} Display observation}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Reward: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{reward}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{lab}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{ImportError}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DeepMind Lab not installed. It requires a separate installation.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{See: https://github.com/deepmind/lab for installation instructions.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsubsection{MuJoCo}
\label{\detokenize{appendices/dataset_catalogue:mujoco}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Physics\sphinxhyphen{}based robot simulation environment

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Various robot control tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://github.com/openai/mujoco-py}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://www.gymlibrary.ml/environments/mujoco/}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using MuJoCo environments in Gym}
\PYG{c+c1}{\PYGZsh{} !pip install gym mujoco\PYGZhy{}py}
\PYG{k}{try}\PYG{p}{:}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gym}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{animation}
    
    \PYG{c+c1}{\PYGZsh{} Create a MuJoCo environment}
    \PYG{n}{env} \PYG{o}{=} \PYG{n}{gym}\PYG{o}{.}\PYG{n}{make}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{HalfCheetah\PYGZhy{}v2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{observation} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Run a random policy}
    \PYG{n}{frames} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Render}
        \PYG{n}{frames}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{env}\PYG{o}{.}\PYG{n}{render}\PYG{p}{(}\PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rgb\PYGZus{}array}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Random action}
        \PYG{n}{action} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{action\PYGZus{}space}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Step}
        \PYG{n}{observation}\PYG{p}{,} \PYG{n}{reward}\PYG{p}{,} \PYG{n}{done}\PYG{p}{,} \PYG{n}{info} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{step}\PYG{p}{(}\PYG{n}{action}\PYG{p}{)}
        
        \PYG{k}{if} \PYG{n}{done}\PYG{p}{:}
            \PYG{n}{observation} \PYG{o}{=} \PYG{n}{env}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{n}{env}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Display the animation}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{update\PYGZus{}frame}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{clf}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{frames}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{p}{[}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{n}{ani} \PYG{o}{=} \PYG{n}{animation}\PYG{o}{.}\PYG{n}{FuncAnimation}\PYG{p}{(}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gcf}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{update\PYGZus{}frame}\PYG{p}{,} \PYG{n}{frames}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{frames}\PYG{p}{)}\PYG{p}{,} \PYG{n}{interval}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print environment details}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Observation space: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{env}\PYG{o}{.}\PYG{n}{observation\PYGZus{}space}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Action space: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{env}\PYG{o}{.}\PYG{n}{action\PYGZus{}space}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{ImportError} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MuJoCo requires a separate installation and license.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{See: https://github.com/openai/mujoco\PYGZhy{}py for installation instructions.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{B.3 NeuroAI Specific Datasets}
\label{\detokenize{appendices/dataset_catalogue:b-3-neuroai-specific-datasets}}

\subsection{Brain\sphinxhyphen{}Score}
\label{\detokenize{appendices/dataset_catalogue:brain-score}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Benchmark for neural network models of the visual system

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Neural and behavioral data for evaluating computational models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://www.brain-score.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/brain-score/brain-score}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Using Brain\PYGZhy{}Score to evaluate models}
\PYG{c+c1}{\PYGZsh{} !pip install brain\PYGZhy{}score}
\PYG{k}{try}\PYG{p}{:}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{brainscore}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{brainscore}\PYG{n+nn}{.}\PYG{n+nn}{benchmarks}\PYG{n+nn}{.}\PYG{n+nn}{public\PYGZus{}benchmarks}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{MajajHongITPublicBenchmark}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{brainscore}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}interface}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{BrainModel}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple mock model for illustration}
    \PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{MockModel}\PYG{p}{(}\PYG{n}{BrainModel}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recording\PYGZus{}target} \PYG{o}{=} \PYG{k+kc}{None}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stimuli\PYGZus{}identifier} \PYG{o}{=} \PYG{k+kc}{None}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{look\PYGZus{}at}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{stimuli}\PYG{p}{,} \PYG{n}{number\PYGZus{}of\PYGZus{}trials}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
            \PYG{c+c1}{\PYGZsh{} Return random activations}
            \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{stimuli}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 neurons}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{start\PYGZus{}task}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{task}\PYG{p}{,} \PYG{n}{fitting\PYGZus{}stimuli}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{pass}
        
        \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{start\PYGZus{}recording}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{recording\PYGZus{}target}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{IT}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{time\PYGZus{}bins}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{recording\PYGZus{}target} \PYG{o}{=} \PYG{n}{recording\PYGZus{}target}
    
    \PYG{c+c1}{\PYGZsh{} Create the model}
    \PYG{n}{model} \PYG{o}{=} \PYG{n}{MockModel}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create benchmark}
    \PYG{n}{benchmark} \PYG{o}{=} \PYG{n}{MajajHongITPublicBenchmark}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Score the model}
    \PYG{n}{score} \PYG{o}{=} \PYG{n}{benchmark}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{score}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{ImportError}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{brain\PYGZhy{}score not installed. Use: pip install brain\PYGZhy{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Note: brain\PYGZhy{}score may have specific dependencies and requirements.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Neural Data Challenge}
\label{\detokenize{appendices/dataset_catalogue:neural-data-challenge}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Neural decoding competitions

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: Neural recordings with specific decoding tasks

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{https://neurodatachallenge.org/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: Varies by challenge

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Generic neural decoding pipeline (using simulated data)}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{train\PYGZus{}test\PYGZus{}split}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LogisticRegression}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{,} \PYG{n}{classification\PYGZus{}report}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} Simulate neural data with 3 target classes}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{n\PYGZus{}classes}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Create class\PYGZhy{}specific patterns}
    \PYG{n}{X} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{int}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate different patterns for each class}
    \PYG{n}{patterns} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}
    
    \PYG{n}{samples\PYGZus{}per\PYGZus{}class} \PYG{o}{=} \PYG{n}{n\PYGZus{}samples} \PYG{o}{/}\PYG{o}{/} \PYG{n}{n\PYGZus{}classes}
    \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}classes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{start\PYGZus{}idx} \PYG{o}{=} \PYG{n}{c} \PYG{o}{*} \PYG{n}{samples\PYGZus{}per\PYGZus{}class}
        \PYG{n}{end\PYGZus{}idx} \PYG{o}{=} \PYG{p}{(}\PYG{n}{c} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{samples\PYGZus{}per\PYGZus{}class} \PYG{k}{if} \PYG{n}{c} \PYG{o}{\PYGZlt{}} \PYG{n}{n\PYGZus{}classes} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{n}{n\PYGZus{}samples}
        
        \PYG{c+c1}{\PYGZsh{} Assign class labels}
        \PYG{n}{y}\PYG{p}{[}\PYG{n}{start\PYGZus{}idx}\PYG{p}{:}\PYG{n}{end\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{c}
        
        \PYG{c+c1}{\PYGZsh{} Generate neural activity}
        \PYG{n}{X}\PYG{p}{[}\PYG{n}{start\PYGZus{}idx}\PYG{p}{:}\PYG{n}{end\PYGZus{}idx}\PYG{p}{]} \PYG{o}{=} \PYG{n}{patterns}\PYG{p}{[}\PYG{n}{c}\PYG{p}{]} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{end\PYGZus{}idx} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}idx}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.5}
    
    \PYG{k}{return} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}

\PYG{c+c1}{\PYGZsh{} Generate simulated data}
\PYG{n}{X}\PYG{p}{,} \PYG{n}{y} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}neural\PYGZus{}data}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Split data}
\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{train\PYGZus{}test\PYGZus{}split}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{test\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Preprocess: Standardize features}
\PYG{n}{scaler} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{X\PYGZus{}train\PYGZus{}scaled} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{)}
\PYG{n}{X\PYGZus{}test\PYGZus{}scaled} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{transform}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Train a decoder}
\PYG{n}{model} \PYG{o}{=} \PYG{n}{LogisticRegression}\PYG{p}{(}\PYG{n}{max\PYGZus{}iter}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{n}{model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train\PYGZus{}scaled}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Evaluate}
\PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test\PYGZus{}scaled}\PYG{p}{)}
\PYG{n}{accuracy} \PYG{o}{=} \PYG{n}{accuracy\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Decoding accuracy: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{accuracy}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{classification\PYGZus{}report}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot confusion matrix}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{confusion\PYGZus{}matrix}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}

\PYG{n}{cm} \PYG{o}{=} \PYG{n}{confusion\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{heatmap}\PYG{p}{(}\PYG{n}{cm}\PYG{p}{,} \PYG{n}{annot}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{fmt}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Blues}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Predicted Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Label}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Confusion Matrix}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize feature importance}
\PYG{n}{coef} \PYG{o}{=} \PYG{n}{model}\PYG{o}{.}\PYG{n}{coef\PYGZus{}}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{coef}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{coef}\PYG{p}{)}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{c}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Class }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{ vs Rest}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron ID}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Weight}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Algonauts Project}
\label{\detokenize{appendices/dataset_catalogue:algonauts-project}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Description}: Bridging human and machine vision

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Contents}: fMRI data for training and evaluating computer vision models

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Access}: \sphinxurl{http://algonauts.csail.mit.edu/}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Documentation}: \sphinxurl{https://github.com/Brain-Bridge-Lab/Algonauts2023}

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with Algonauts data (simulated)}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PCA}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{cross\PYGZus{}decomposition}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{PLSRegression}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{KFold}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{r2\PYGZus{}score}

\PYG{c+c1}{\PYGZsh{} Simulate fMRI data and CNN features}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}algonauts\PYGZus{}data}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{o}{=}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{n}{n\PYGZus{}voxels}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{n\PYGZus{}cnn\PYGZus{}features}\PYG{o}{=}\PYG{l+m+mi}{4096}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Simulate CNN features}
    \PYG{n}{cnn\PYGZus{}features} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}cnn\PYGZus{}features}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create \PYGZdq{}true\PYGZdq{} mapping weights}
    \PYG{n}{true\PYGZus{}weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}cnn\PYGZus{}features}\PYG{p}{,} \PYG{n}{n\PYGZus{}voxels}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.01}
    
    \PYG{c+c1}{\PYGZsh{} Generate fMRI data using the features and weights}
    \PYG{n}{fmri\PYGZus{}data} \PYG{o}{=} \PYG{n}{cnn\PYGZus{}features} \PYG{o}{@} \PYG{n}{true\PYGZus{}weights} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{,} \PYG{n}{n\PYGZus{}voxels}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mf}{0.1}
    
    \PYG{k}{return} \PYG{n}{cnn\PYGZus{}features}\PYG{p}{,} \PYG{n}{fmri\PYGZus{}data}

\PYG{c+c1}{\PYGZsh{} Generate simulated data}
\PYG{n}{cnn\PYGZus{}features}\PYG{p}{,} \PYG{n}{fmri\PYGZus{}data} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}algonauts\PYGZus{}data}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Reduce dimensionality of CNN features for visualization}
\PYG{n}{pca} \PYG{o}{=} \PYG{n}{PCA}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{cnn\PYGZus{}reduced} \PYG{o}{=} \PYG{n}{pca}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{cnn\PYGZus{}features}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set up cross\PYGZhy{}validation}
\PYG{n}{kf} \PYG{o}{=} \PYG{n}{KFold}\PYG{p}{(}\PYG{n}{n\PYGZus{}splits}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Train a model to predict fMRI responses from CNN features}
\PYG{n}{pls} \PYG{o}{=} \PYG{n}{PLSRegression}\PYG{p}{(}\PYG{n}{n\PYGZus{}components}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} For simplicity, just train on a subset of voxels}
\PYG{n}{voxel\PYGZus{}subset} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{choice}\PYG{p}{(}\PYG{n}{fmri\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{replace}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{fmri\PYGZus{}subset} \PYG{o}{=} \PYG{n}{fmri\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{voxel\PYGZus{}subset}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Cross\PYGZhy{}validation}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Running cross\PYGZhy{}validation...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{train\PYGZus{}idx}\PYG{p}{,} \PYG{n}{test\PYGZus{}idx} \PYG{o+ow}{in} \PYG{n}{kf}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{cnn\PYGZus{}features}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Train/test split}
    \PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{X\PYGZus{}test} \PYG{o}{=} \PYG{n}{cnn\PYGZus{}features}\PYG{p}{[}\PYG{n}{train\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cnn\PYGZus{}features}\PYG{p}{[}\PYG{n}{test\PYGZus{}idx}\PYG{p}{]}
    \PYG{n}{y\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}test} \PYG{o}{=} \PYG{n}{fmri\PYGZus{}subset}\PYG{p}{[}\PYG{n}{train\PYGZus{}idx}\PYG{p}{]}\PYG{p}{,} \PYG{n}{fmri\PYGZus{}subset}\PYG{p}{[}\PYG{n}{test\PYGZus{}idx}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Fit model}
    \PYG{n}{pls}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X\PYGZus{}train}\PYG{p}{,} \PYG{n}{y\PYGZus{}train}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Predict}
    \PYG{n}{y\PYGZus{}pred} \PYG{o}{=} \PYG{n}{pls}\PYG{o}{.}\PYG{n}{predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}test}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute R² for each voxel}
    \PYG{n}{r2} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{y\PYGZus{}test}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{]}
    \PYG{n}{r2\PYGZus{}scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2}\PYG{p}{)}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mean R² across folds: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualize distribution of R² scores}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{r2\PYGZus{}scores}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mean R² Score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribution of R² Scores Across CV Folds}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\section{B.4 Data Loading Examples}
\label{\detokenize{appendices/dataset_catalogue:b-4-data-loading-examples}}
\sphinxAtStartPar
The examples below demonstrate how to load specific file formats common in neuroscience research.


\subsection{Loading NIfTI Files}
\label{\detokenize{appendices/dataset_catalogue:loading-nifti-files}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with NIfTI files (neuroimaging data)}
\PYG{c+c1}{\PYGZsh{} !pip install nibabel matplotlib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{nibabel}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{requests}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}

\PYG{c+c1}{\PYGZsh{} Download a sample NIfTI file if needed}
\PYG{n}{nifti\PYGZus{}url} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{https://ndownloader.figshare.com/files/12965017}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{filename} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{example.nii.gz}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Downloading }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{filename}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{requests}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{nifti\PYGZus{}url}\PYG{p}{)}
        \PYG{k}{with} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
            \PYG{n}{f}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n}{response}\PYG{o}{.}\PYG{n}{content}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Download complete.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error downloading file: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Load NIfTI file}
\PYG{k}{try}\PYG{p}{:}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{nib}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get data as numpy array}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{get\PYGZus{}fdata}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Image shape: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Data type: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{data}\PYG{o}{.}\PYG{n}{dtype}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Get header information}
    \PYG{n}{header} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{header}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Voxel dimensions: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{header}\PYG{o}{.}\PYG{n}{get\PYGZus{}zooms}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Units: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{header}\PYG{o}{.}\PYG{n}{get\PYGZus{}xyzt\PYGZus{}units}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Display central slices}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{3}\PYG{p}{:}
        \PYG{n}{middle\PYGZus{}x} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
        \PYG{n}{middle\PYGZus{}y} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
        \PYG{n}{middle\PYGZus{}z} \PYG{o}{=} \PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{131}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{middle\PYGZus{}x}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sagittal View}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{132}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{middle\PYGZus{}y}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Coronal View}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{133}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{middle\PYGZus{}z}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Axial View}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error processing NIfTI file: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Will use a simulated 3D volume instead for demonstration:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a simple simulated volume}
    \PYG{n}{sim\PYGZus{}data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Add a sphere in the middle}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{z} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ogrid}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{15}\PYG{p}{:}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{15}\PYG{p}{:}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{15}\PYG{p}{:}\PYG{l+m+mi}{15}\PYG{p}{]}
    \PYG{n}{sphere} \PYG{o}{=} \PYG{n}{x}\PYG{o}{*}\PYG{n}{x} \PYG{o}{+} \PYG{n}{y}\PYG{o}{*}\PYG{n}{y} \PYG{o}{+} \PYG{n}{z}\PYG{o}{*}\PYG{n}{z} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{10}\PYG{o}{*}\PYG{l+m+mi}{10}
    \PYG{n}{sim\PYGZus{}data}\PYG{p}{[}\PYG{n}{sphere}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Display central slices}
    \PYG{n}{middle\PYGZus{}x} \PYG{o}{=} \PYG{n}{sim\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    \PYG{n}{middle\PYGZus{}y} \PYG{o}{=} \PYG{n}{sim\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    \PYG{n}{middle\PYGZus{}z} \PYG{o}{=} \PYG{n}{sim\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{131}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{sim\PYGZus{}data}\PYG{p}{[}\PYG{n}{middle\PYGZus{}x}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sagittal View (Simulated)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{132}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{sim\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{middle\PYGZus{}y}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Coronal View (Simulated)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{133}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{sim\PYGZus{}data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{middle\PYGZus{}z}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Axial View (Simulated)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Working with EEG Data}
\label{\detokenize{appendices/dataset_catalogue:working-with-eeg-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with EEG data}
\PYG{c+c1}{\PYGZsh{} !pip install mne}
\PYG{k}{try}\PYG{p}{:}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{mne}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
    
    \PYG{c+c1}{\PYGZsh{} Download sample EEG data}
    \PYG{n}{sample\PYGZus{}data\PYGZus{}folder} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{datasets}\PYG{o}{.}\PYG{n}{sample}\PYG{o}{.}\PYG{n}{data\PYGZus{}path}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{sample\PYGZus{}data\PYGZus{}raw\PYGZus{}file} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sample\PYGZus{}data\PYGZus{}folder}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/MEG/sample/sample\PYGZus{}audvis\PYGZus{}raw.fif}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Load the data}
    \PYG{n}{raw} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{io}\PYG{o}{.}\PYG{n}{read\PYGZus{}raw\PYGZus{}fif}\PYG{p}{(}\PYG{n}{sample\PYGZus{}data\PYGZus{}raw\PYGZus{}file}\PYG{p}{,} \PYG{n}{preload}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print information about the dataset}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{raw}\PYG{o}{.}\PYG{n}{info}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Extract EEG channels only}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{pick\PYGZus{}types}\PYG{p}{(}\PYG{n}{meg}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{eeg}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{eog}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{stim}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Filter the data}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{filter}\PYG{p}{(}\PYG{n}{l\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{h\PYGZus{}freq}\PYG{o}{=}\PYG{l+m+mf}{40.0}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot EEG data}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{scalings}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Extract events}
    \PYG{n}{events} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{find\PYGZus{}events}\PYG{p}{(}\PYG{n}{raw}\PYG{p}{,} \PYG{n}{stim\PYGZus{}channel}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{STI 014}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{event\PYGZus{}id} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auditory/left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auditory/right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visual/left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{visual/right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{4}\PYG{p}{\PYGZcb{}}
    
    \PYG{c+c1}{\PYGZsh{} Create epochs}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{Epochs}\PYG{p}{(}\PYG{n}{raw}\PYG{p}{,} \PYG{n}{events}\PYG{p}{,} \PYG{n}{event\PYGZus{}id}\PYG{p}{,} \PYG{n}{tmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{tmax}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,}
                      \PYG{n}{proj}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{baseline}\PYG{o}{=}\PYG{p}{(}\PYG{k+kc}{None}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{preload}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot evoked responses}
    \PYG{n}{evoked} \PYG{o}{=} \PYG{n}{epochs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auditory/left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{average}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{evoked}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create and plot a topographic map}
    \PYG{n}{evoked}\PYG{o}{.}\PYG{n}{plot\PYGZus{}topomap}\PYG{p}{(}\PYG{n}{times}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ch\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{eeg}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot time\PYGZhy{}frequency representation}
    \PYG{n}{frequencies} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Frequencies from 6\PYGZhy{}20Hz}
    \PYG{n}{power} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{time\PYGZus{}frequency}\PYG{o}{.}\PYG{n}{tfr\PYGZus{}morlet}\PYG{p}{(}\PYG{n}{epochs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auditory/left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{freqs}\PYG{o}{=}\PYG{n}{frequencies}\PYG{p}{,} 
                                        \PYG{n}{n\PYGZus{}cycles}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{return\PYGZus{}itc}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{n}{power}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
\PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error processing EEG data: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Note: MNE\PYGZhy{}Python requires sample data to be downloaded.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{You can still work with EEG data by following these steps:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. Install MNE: pip install mne}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2. Download sample data: mne.datasets.sample.data\PYGZus{}path()}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. Load and process EEG data as shown in the example}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Create a simulated EEG dataset for demonstration}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
        \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
        
        \PYG{c+c1}{\PYGZsh{} Parameters}
        \PYG{n}{n\PYGZus{}channels} \PYG{o}{=} \PYG{l+m+mi}{16}
        \PYG{n}{sfreq} \PYG{o}{=} \PYG{l+m+mi}{256}  \PYG{c+c1}{\PYGZsh{} Hz}
        \PYG{n}{duration} \PYG{o}{=} \PYG{l+m+mi}{5}  \PYG{c+c1}{\PYGZsh{} seconds}
        \PYG{n}{t} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{sfreq}\PYG{p}{)}
        \PYG{n}{n\PYGZus{}samples} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Generate simulated EEG signals}
        \PYG{n}{sim\PYGZus{}eeg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{,} \PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Combine different frequency components with channel\PYGZhy{}specific weights}
            \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{10} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 10 Hz alpha}
            \PYG{n}{beta} \PYG{o}{=} \PYG{l+m+mf}{0.25} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{20} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 20 Hz beta}
            \PYG{n}{theta} \PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 5 Hz theta}
            \PYG{n}{delta} \PYG{o}{=} \PYG{l+m+mf}{0.4} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{t}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 2 Hz delta}
            
            \PYG{c+c1}{\PYGZsh{} Mix components with random weights and add noise}
            \PYG{n}{weights} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}
            \PYG{n}{weights} \PYG{o}{=} \PYG{n}{weights} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{weights}\PYG{p}{)}
            \PYG{n}{sim\PYGZus{}eeg}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{weights}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{n}{alpha} \PYG{o}{+} 
                         \PYG{n}{weights}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{*} \PYG{n}{beta} \PYG{o}{+} 
                         \PYG{n}{weights}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{*} \PYG{n}{theta} \PYG{o}{+} 
                         \PYG{n}{weights}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{*} \PYG{n}{delta} \PYG{o}{+} 
                         \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{randn}\PYG{p}{(}\PYG{n}{n\PYGZus{}samples}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot simulated EEG data}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{sim\PYGZus{}eeg}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ch }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simulated EEG Data}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{7}\PYG{p}{:}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a simulated topographic map}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{channel\PYGZus{}locs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}\PYG{p}{:}
            \PYG{c+c1}{\PYGZsh{} Create circular layout}
            \PYG{n}{angle} \PYG{o}{=} \PYG{n}{i} \PYG{o}{*} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{/} \PYG{n}{n\PYGZus{}channels}
            \PYG{n}{x} \PYG{o}{=} \PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}
            \PYG{n}{y} \PYG{o}{=} \PYG{l+m+mf}{0.8} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{angle}\PYG{p}{)}
            \PYG{n}{channel\PYGZus{}locs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Create a grid for interpolation}
        \PYG{n}{grid\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mi}{100}
        \PYG{n}{xi} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{grid\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{yi} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{grid\PYGZus{}size}\PYG{p}{)}
        \PYG{n}{X}\PYG{p}{,} \PYG{n}{Y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{xi}\PYG{p}{,} \PYG{n}{yi}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Simulate some values at a given time point}
        \PYG{n}{values} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{n}{n\PYGZus{}channels}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Plot values at channel locations}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{p}{[}\PYG{n}{loc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{k}{for} \PYG{n}{loc} \PYG{o+ow}{in} \PYG{n}{channel\PYGZus{}locs}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{loc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{k}{for} \PYG{n}{loc} \PYG{o+ow}{in} \PYG{n}{channel\PYGZus{}locs}\PYG{p}{]}\PYG{p}{,} 
                   \PYG{n}{c}\PYG{o}{=}\PYG{n}{values}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RdBu\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Add channel labels}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{loc} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{channel\PYGZus{}locs}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{n}{loc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{loc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{white}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontweight}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simulated EEG Topographic Map}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Activation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{equal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error creating simulated EEG data: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Working with Spike Train Data}
\label{\detokenize{appendices/dataset_catalogue:working-with-spike-train-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Example: Working with spike train data}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{ticker}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{MaxNLocator}

\PYG{c+c1}{\PYGZsh{} Simulate spike train data for multiple neurons}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{simulate\PYGZus{}spike\PYGZus{}trains}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{rate}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mf}{5.0}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Simulate Poisson spike trains for multiple neurons\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Create time bins}
    \PYG{n}{bins} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration} \PYG{o}{+} \PYG{n}{bin\PYGZus{}size}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}bins} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}
    
    \PYG{c+c1}{\PYGZsh{} Initialize spike rasters and times}
    \PYG{n}{spike\PYGZus{}rasters} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{n\PYGZus{}bins}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}
    \PYG{n}{spike\PYGZus{}times} \PYG{o}{=} \PYG{p}{[}\PYG{p}{[}\PYG{p}{]} \PYG{k}{for} \PYG{n}{\PYGZus{}} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Generate spikes for each neuron}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Rate might vary between neurons}
        \PYG{n}{neuron\PYGZus{}rate} \PYG{o}{=} \PYG{n}{rate} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        
        \PYG{c+c1}{\PYGZsh{} Probability of spike in each bin}
        \PYG{n}{spike\PYGZus{}prob} \PYG{o}{=} \PYG{n}{neuron\PYGZus{}rate} \PYG{o}{*} \PYG{n}{bin\PYGZus{}size}
        
        \PYG{c+c1}{\PYGZsh{} Generate spikes}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}bins}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{rand}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{spike\PYGZus{}prob}\PYG{p}{:}
                \PYG{n}{spike\PYGZus{}rasters}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,} \PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{k+kc}{True}
                \PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{bins}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{spike\PYGZus{}rasters}\PYG{p}{,} \PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{bins}

\PYG{c+c1}{\PYGZsh{} Simulate data}
\PYG{n}{n\PYGZus{}neurons} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{duration} \PYG{o}{=} \PYG{l+m+mf}{5.0}  \PYG{c+c1}{\PYGZsh{} seconds}
\PYG{n}{bin\PYGZus{}size} \PYG{o}{=} \PYG{l+m+mf}{0.001}  \PYG{c+c1}{\PYGZsh{} 1 ms bins}
\PYG{n}{spike\PYGZus{}rasters}\PYG{p}{,} \PYG{n}{spike\PYGZus{}times}\PYG{p}{,} \PYG{n}{bins} \PYG{o}{=} \PYG{n}{simulate\PYGZus{}spike\PYGZus{}trains}\PYG{p}{(}
    \PYG{n}{n\PYGZus{}neurons}\PYG{o}{=}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n}{rate}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{duration}\PYG{o}{=}\PYG{n}{duration}\PYG{p}{,} \PYG{n}{bin\PYGZus{}size}\PYG{o}{=}\PYG{n}{bin\PYGZus{}size}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot spike raster}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Raster plot}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{*} \PYG{n}{i}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{|}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Neuron ID}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spike Raster Plot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{n\PYGZus{}neurons} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{yaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}major\PYGZus{}locator}\PYG{p}{(}\PYG{n}{MaxNLocator}\PYG{p}{(}\PYG{n}{integer}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} PSTH (Population Peristimulus Time Histogram)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{bin\PYGZus{}edges} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{duration} \PYG{o}{+} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 100 ms bins for PSTH}
\PYG{n}{population\PYGZus{}rate} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{bin\PYGZus{}edges}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{n\PYGZus{}neurons}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Count spikes in each time bin}
    \PYG{n}{counts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{histogram}\PYG{p}{(}\PYG{n}{spike\PYGZus{}times}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{bin\PYGZus{}edges}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Convert to firing rate (Hz)}
    \PYG{n}{population\PYGZus{}rate}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{counts} \PYG{o}{/} \PYG{l+m+mf}{0.1}  \PYG{c+c1}{\PYGZsh{} 0.1s bin size}

\PYG{c+c1}{\PYGZsh{} Average across neurons}
\PYG{n}{avg\PYGZus{}population\PYGZus{}rate} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{population\PYGZus{}rate}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot PSTH}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{bin\PYGZus{}edges}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{avg\PYGZus{}population\PYGZus{}rate}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Population PSTH}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Calculate and plot various spike train statistics}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 1. Calculate ISI (Inter\PYGZhy{}Spike Intervals) for all neurons}
\PYG{n}{isis} \PYG{o}{=} \PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{times}\PYG{p}{)} \PYG{k}{for} \PYG{n}{times} \PYG{o+ow}{in} \PYG{n}{spike\PYGZus{}times} \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{times}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} 2. Calculate CV (Coefficient of Variation) of ISIs}
\PYG{n}{cvs} \PYG{o}{=} \PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{isi}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan} \PYG{k}{for} \PYG{n}{isi} \PYG{o+ow}{in} \PYG{n}{isis}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} 3. Calculate mean firing rates}
\PYG{n}{rates} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{times}\PYG{p}{)}\PYG{o}{/}\PYG{n}{duration} \PYG{k}{for} \PYG{n}{times} \PYG{o+ow}{in} \PYG{n}{spike\PYGZus{}times}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Plot ISI histogram}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{all\PYGZus{}isis} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{n}{isis}\PYG{p}{)} \PYG{k}{if} \PYG{n}{isis} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{all\PYGZus{}isis}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{all\PYGZus{}isis}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{n}{density}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Inter\PYGZhy{}Spike Interval (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Density}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ISI Distribution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No sufficient spikes for ISI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot CV distribution}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{valid\PYGZus{}cvs} \PYG{o}{=} \PYG{p}{[}\PYG{n}{cv} \PYG{k}{for} \PYG{n}{cv} \PYG{o+ow}{in} \PYG{n}{cvs} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isnan}\PYG{p}{(}\PYG{n}{cv}\PYG{p}{)}\PYG{p}{]}
\PYG{k}{if} \PYG{n}{valid\PYGZus{}cvs}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{valid\PYGZus{}cvs}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axvline}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Poisson}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CV of ISI}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CV Distribution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No sufficient spikes for CV}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot firing rate distribution}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{rates}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate (Hz)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Firing Rate Distribution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot autocorrelation for the first neuron}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}
\PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{spike\PYGZus{}rasters}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Convert spike raster to 0/1 array}
    \PYG{n}{spikes\PYGZus{}01} \PYG{o}{=} \PYG{n}{spike\PYGZus{}rasters}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Compute autocorrelation}
    \PYG{n}{max\PYGZus{}lag} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.5} \PYG{o}{/} \PYG{n}{bin\PYGZus{}size}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 500 ms max lag}
    \PYG{n}{lags} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{max\PYGZus{}lag}\PYG{p}{,} \PYG{n}{max\PYGZus{}lag} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{bin\PYGZus{}size}
    
    \PYG{c+c1}{\PYGZsh{} Manual autocorrelation (numpy.correlate doesn\PYGZsq{}t handle this well)}
    \PYG{n}{autocorr} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{lags}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{lag} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{max\PYGZus{}lag}\PYG{p}{,} \PYG{n}{max\PYGZus{}lag} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{lag} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{autocorr}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{spikes\PYGZus{}01}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{]} \PYG{o}{*} \PYG{n}{spikes\PYGZus{}01}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{lag}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{autocorr}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{spikes\PYGZus{}01}\PYG{p}{[}\PYG{n}{lag}\PYG{p}{:}\PYG{p}{]} \PYG{o}{*} \PYG{n}{spikes\PYGZus{}01}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{n}{lag} \PYG{k}{if} \PYG{n}{lag} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{]}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot autocorrelation}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{lags}\PYG{p}{,} \PYG{n}{autocorr}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Lag (s)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Autocorrelation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Autocorrelation (Neuron 0)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No spikes for autocorrelation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
These examples and resources should provide a comprehensive starting point for working with a wide range of neuroscience and AI datasets.

\sphinxstepscope


\chapter{Appendix C: Google Colab Setup for NeuroAI}
\label{\detokenize{appendices/colab_setup:appendix-c-google-colab-setup-for-neuroai}}\label{\detokenize{appendices/colab_setup::doc}}

\section{C.1 Getting Started with Google Colab}
\label{\detokenize{appendices/colab_setup:c-1-getting-started-with-google-colab}}

\subsection{What is Google Colab?}
\label{\detokenize{appendices/colab_setup:what-is-google-colab}}
\sphinxAtStartPar
Google Colaboratory (Colab) is a free cloud\sphinxhyphen{}based Jupyter notebook environment that requires no setup and runs entirely in the cloud. It’s particularly useful for machine learning and data analysis tasks in the NeuroAI domain because:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Zero Configuration}: Run Python code through your browser with no installation required

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Free GPU/TPU Access}: Accelerate neural network training with free GPU (NVIDIA K80, T4, P100, or V100) and TPU resources

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Easy Sharing}: Collaborate with colleagues through Google Drive integration

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Pre\sphinxhyphen{}installed Libraries}: Comes with many ML libraries (TensorFlow, PyTorch, scikit\sphinxhyphen{}learn) pre\sphinxhyphen{}installed

\end{itemize}


\subsection{Basic Setup}
\label{\detokenize{appendices/colab_setup:basic-setup}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Accessing Colab}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Go to \sphinxurl{https://colab.research.google.com/}

\item {} 
\sphinxAtStartPar
Sign in with your Google account

\item {} 
\sphinxAtStartPar
Create a new notebook or open an existing one

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Notebook Interface}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Menu Bar}: File operations, runtime management, and help resources

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Toolbar}: Common operations like adding cells and running code

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cells}: Individual code or text blocks (similar to Jupyter)

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Cell Types}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Code Cells}: For Python code execution

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Text Cells}: For markdown documentation

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Output Cells}: Display results of executed code

\end{itemize}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Runtime Management}:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Select \sphinxstylestrong{Runtime > Change runtime type} to choose hardware accelerator (None, GPU, or TPU)

\item {} 
\sphinxAtStartPar
Runtimes automatically disconnect after 90 minutes of inactivity or 12 hours of total usage

\end{itemize}

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Check what type of hardware you\PYGZsq{}re using}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TensorFlow version:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{GPU Available:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{list\PYGZus{}physical\PYGZus{}devices}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{GPU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TPU Available:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{list\PYGZus{}physical\PYGZus{}devices}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{TPU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}


\section{C.2 Setting Up NeuroAI\sphinxhyphen{}Handbook Environment}
\label{\detokenize{appendices/colab_setup:c-2-setting-up-neuroai-handbook-environment}}

\subsection{Cloning the NeuroAI\sphinxhyphen{}Handbook Repository}
\label{\detokenize{appendices/colab_setup:cloning-the-neuroai-handbook-repository}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Clone the repository}
\PYG{o}{!}git\PYG{+w}{ }clone\PYG{+w}{ }https://github.com/yourusername/NeuroAI\PYGZhy{}Handbook.git

\PYG{c+c1}{\PYGZsh{} Change to the repository directory}
\PYG{o}{\PYGZpc{}}\PYG{k}{cd} NeuroAI\PYGZhy{}Handbook

\PYG{c+c1}{\PYGZsh{} Install required packages}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}r\PYG{+w}{ }book/requirements.txt
\end{sphinxVerbatim}


\subsection{Required Package Installation}
\label{\detokenize{appendices/colab_setup:required-package-installation}}
\sphinxAtStartPar
For the exercises in this handbook, you’ll need various neuroscience and ML libraries:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Install essential packages for NeuroAI}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }torch\PYG{+w}{ }torchvision\PYG{+w}{ }tensorflow\PYG{+w}{ }matplotlib\PYG{+w}{ }numpy\PYG{+w}{ }pandas\PYG{+w}{ }scipy\PYG{+w}{ }scikit\PYGZhy{}learn

\PYG{c+c1}{\PYGZsh{} Install neuroscience\PYGZhy{}specific packages}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }nibabel\PYG{+w}{ }nilearn\PYG{+w}{ }mne\PYG{+w}{ }seaborn\PYG{+w}{ }allensdk\PYG{+w}{ }neurom\PYG{+w}{ }pynwb

\PYG{c+c1}{\PYGZsh{} Install JupyterBook for building the handbook (optional)}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }jupyter\PYGZhy{}book

\PYG{c+c1}{\PYGZsh{} Verify key installations}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{sys}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{mne}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{nibabel}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{allensdk}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Python version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{version}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PyTorch version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TensorFlow version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{tf}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MNE version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mne}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NiBabel version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{nib}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{AllenSDK version: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{allensdk}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{GPU Configuration and Management}
\label{\detokenize{appendices/colab_setup:gpu-configuration-and-management}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Check GPU details}
\PYG{o}{!}nvidia\PYGZhy{}smi

\PYG{c+c1}{\PYGZsh{} Configure TensorFlow for GPU memory growth (prevents memory errors)}
\PYG{n}{gpus} \PYG{o}{=} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{experimental}\PYG{o}{.}\PYG{n}{list\PYGZus{}physical\PYGZus{}devices}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{GPU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{if} \PYG{n}{gpus}\PYG{p}{:}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{gpu} \PYG{o+ow}{in} \PYG{n}{gpus}\PYG{p}{:}
            \PYG{n}{tf}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{experimental}\PYG{o}{.}\PYG{n}{set\PYGZus{}memory\PYGZus{}growth}\PYG{p}{(}\PYG{n}{gpu}\PYG{p}{,} \PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Memory growth enabled for }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{gpus}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ GPUs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{except} \PYG{n+ne}{RuntimeError} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error setting memory growth: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Configure PyTorch to use GPU}
\PYG{n}{device} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{device}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cuda}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{is\PYGZus{}available}\PYG{p}{(}\PYG{p}{)} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cpu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PyTorch is using: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{device}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Directory Structure Setup}
\label{\detokenize{appendices/colab_setup:directory-structure-setup}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Create standard directory structure for NeuroAI projects}
\PYG{o}{!}mkdir\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }./data/raw\PYG{+w}{ }./data/processed\PYG{+w}{ }./models\PYG{+w}{ }./results\PYG{+w}{ }./figures

\PYG{c+c1}{\PYGZsh{} Define and export path variables}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}

\PYG{c+c1}{\PYGZsh{} Define key paths}
\PYG{n}{RAW\PYGZus{}DATA\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./data/raw}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{PROCESSED\PYGZus{}DATA\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./data/processed}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{MODEL\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./models}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{RESULTS\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./results}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{FIGURES\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./figures}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Create a function to create needed directories}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{ensure\PYGZus{}directories}\PYG{p}{(}\PYG{n}{paths}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Create directories if they don\PYGZsq{}t exist.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{for} \PYG{n}{path} \PYG{o+ow}{in} \PYG{n}{paths}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Directory available: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{path}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        
\PYG{n}{ensure\PYGZus{}directories}\PYG{p}{(}\PYG{p}{[}\PYG{n}{RAW\PYGZus{}DATA\PYGZus{}PATH}\PYG{p}{,} \PYG{n}{PROCESSED\PYGZus{}DATA\PYGZus{}PATH}\PYG{p}{,} \PYG{n}{MODEL\PYGZus{}PATH}\PYG{p}{,} \PYG{n}{RESULTS\PYGZus{}PATH}\PYG{p}{,} \PYG{n}{FIGURES\PYGZus{}PATH}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}


\section{C.3 Data Management in Colab}
\label{\detokenize{appendices/colab_setup:c-3-data-management-in-colab}}

\subsection{Mounting Google Drive}
\label{\detokenize{appendices/colab_setup:mounting-google-drive}}
\sphinxAtStartPar
For persistent storage, mount your Google Drive:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{google}\PYG{n+nn}{.}\PYG{n+nn}{colab}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{drive}
\PYG{n}{drive}\PYG{o}{.}\PYG{n}{mount}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/drive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a dedicated folder for NeuroAI work}
\PYG{n}{DRIVE\PYGZus{}PATH} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/drive/MyDrive/NeuroAI\PYGZhy{}Handbook}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{o}{!}mkdir\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}DRIVE\PYGZus{}PATH}

\PYG{c+c1}{\PYGZsh{} Create symbolic links for convenient access}
\PYG{o}{!}ln\PYG{+w}{ }\PYGZhy{}s\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}DRIVE\PYGZus{}PATH}/data\PYG{+w}{ }./drive\PYGZus{}data
\PYG{o}{!}ln\PYG{+w}{ }\PYGZhy{}s\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}DRIVE\PYGZus{}PATH}/models\PYG{+w}{ }./drive\PYGZus{}models

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Google Drive mounted at: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{DRIVE\PYGZus{}PATH}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Data Transfer Methods}
\label{\detokenize{appendices/colab_setup:data-transfer-methods}}

\subsubsection{From Google Drive to Colab VM}
\label{\detokenize{appendices/colab_setup:from-google-drive-to-colab-vm}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Copy datasets from Drive to Colab (faster processing)}
\PYG{o}{!}cp\PYG{+w}{ }\PYGZhy{}r\PYG{+w}{ }/content/drive/MyDrive/NeuroAI\PYGZhy{}Handbook/data/raw/*\PYG{+w}{ }./data/raw/
\end{sphinxVerbatim}


\subsubsection{From External Sources}
\label{\detokenize{appendices/colab_setup:from-external-sources}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Method 1: Download using wget}
\PYG{o}{!}wget\PYG{+w}{ }\PYGZhy{}P\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}\PYG{+w}{ }https://openneuro.org/crn/datasets/ds003031/snapshots/2.0.0/files/sub\PYGZhy{}01:func:sub\PYGZhy{}01\PYGZus{}task\PYGZhy{}imagery\PYGZus{}run\PYGZhy{}01\PYGZus{}bold.nii.gz

\PYG{c+c1}{\PYGZsh{} Method 2: From GitHub}
\PYG{o}{!}curl\PYG{+w}{ }\PYGZhy{}L\PYG{+w}{ }\PYGZhy{}o\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/sample\PYGZus{}data.zip\PYG{+w}{ }https://github.com/username/repo/raw/main/data/sample\PYGZus{}data.zip
\PYG{o}{!}unzip\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/sample\PYGZus{}data.zip\PYG{+w}{ }\PYGZhy{}d\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}

\PYG{c+c1}{\PYGZsh{} Method 3: From Kaggle (requires API key setup)}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }kaggle
\PYG{o}{!}mkdir\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }\PYGZti{}/.kaggle

\PYG{c+c1}{\PYGZsh{} Create Kaggle API token (replace with your token details)}
\PYG{c+c1}{\PYGZsh{} Get your token from https://www.kaggle.com/account}
\PYG{o}{!}\PYG{n+nb}{echo}\PYG{+w}{ }\PYG{l+s+s1}{\PYGZsq{}\PYGZob{}\PYGZdq{}username\PYGZdq{}:\PYGZdq{}YOUR\PYGZus{}USERNAME\PYGZdq{},\PYGZdq{}key\PYGZdq{}:\PYGZdq{}YOUR\PYGZus{}API\PYGZus{}KEY\PYGZdq{}\PYGZcb{}\PYGZsq{}}\PYG{+w}{ }\PYGZgt{}\PYG{+w}{ }\PYGZti{}/.kaggle/kaggle.json
\PYG{o}{!}chmod\PYG{+w}{ }\PYG{l+m}{600}\PYG{+w}{ }\PYGZti{}/.kaggle/kaggle.json

\PYG{c+c1}{\PYGZsh{} Download dataset from Kaggle}
\PYG{o}{!}kaggle\PYG{+w}{ }datasets\PYG{+w}{ }download\PYG{+w}{ }\PYGZhy{}d\PYG{+w}{ }codingdisciple/brain\PYGZhy{}mri\PYGZhy{}dataset\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}
\PYG{o}{!}unzip\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/brain\PYGZhy{}mri\PYGZhy{}dataset.zip\PYG{+w}{ }\PYGZhy{}d\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}
\end{sphinxVerbatim}


\subsection{Saving Results Back to Drive}
\label{\detokenize{appendices/colab_setup:saving-results-back-to-drive}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Save processed data and models to Google Drive for persistence}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}to\PYGZus{}drive}\PYG{p}{(}\PYG{n}{source\PYGZus{}path}\PYG{p}{,} \PYG{n}{drive\PYGZus{}destination}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Save files to Google Drive with logging.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{shutil}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}
    
    \PYG{c+c1}{\PYGZsh{} Create destination directory if it doesn\PYGZsq{}t exist}
    \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{dirname}\PYG{p}{(}\PYG{n}{drive\PYGZus{}destination}\PYG{p}{)}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Copy data}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n}{source\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copytree}\PYG{p}{(}\PYG{n}{source\PYGZus{}path}\PYG{p}{,} \PYG{n}{drive\PYGZus{}destination}\PYG{p}{,} \PYG{n}{dirs\PYGZus{}exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copy2}\PYG{p}{(}\PYG{n}{source\PYGZus{}path}\PYG{p}{,} \PYG{n}{drive\PYGZus{}destination}\PYG{p}{)}
        \PYG{k}{return} \PYG{k+kc}{True}
    \PYG{k}{except} \PYG{n+ne}{Exception} \PYG{k}{as} \PYG{n}{e}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error saving to Drive: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{e}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{return} \PYG{k+kc}{False}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{n}{model\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./models/trained\PYGZus{}cnn.h5}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{drive\PYGZus{}model\PYGZus{}path} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{DRIVE\PYGZus{}PATH}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{/models/trained\PYGZus{}cnn.h5}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{model\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{if} \PYG{n}{save\PYGZus{}to\PYGZus{}drive}\PYG{p}{(}\PYG{n}{model\PYGZus{}path}\PYG{p}{,} \PYG{n}{drive\PYGZus{}model\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model saved to Drive: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{drive\PYGZus{}model\PYGZus{}path}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{C.4 Optimizing Colab for NeuroAI Computations}
\label{\detokenize{appendices/colab_setup:c-4-optimizing-colab-for-neuroai-computations}}

\subsection{Memory Management}
\label{\detokenize{appendices/colab_setup:memory-management}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Check and monitor memory usage}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }psutil
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{psutil}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{print\PYGZus{}memory\PYGZus{}usage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Print current memory usage of the Colab instance.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{mem} \PYG{o}{=} \PYG{n}{psutil}\PYG{o}{.}\PYG{n}{virtual\PYGZus{}memory}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MEMORY STATUS:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  Total:     }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mem}\PYG{o}{.}\PYG{n}{total}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{1e9}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ GB}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  Available: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mem}\PYG{o}{.}\PYG{n}{available}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{1e9}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ GB}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  Used:      }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mem}\PYG{o}{.}\PYG{n}{used}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{1e9}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ GB (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mem}\PYG{o}{.}\PYG{n}{percent}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{})}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{  Free:      }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mem}\PYG{o}{.}\PYG{n}{free}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{1e9}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ GB}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
\PYG{n}{print\PYGZus{}memory\PYGZus{}usage}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Memory optimization function}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{optimize\PYGZus{}memory}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Perform garbage collection and clear GPU memory if available.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Clear memory}
    \PYG{n}{gc}\PYG{o}{.}\PYG{n}{collect}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Clear PyTorch cache if using GPU}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
    \PYG{k}{if} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{is\PYGZus{}available}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{empty\PYGZus{}cache}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PyTorch GPU cache cleared}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Clear TensorFlow GPU memory}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
    \PYG{k}{if} \PYG{n}{tf}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{list\PYGZus{}physical\PYGZus{}devices}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{GPU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{backend}\PYG{o}{.}\PYG{n}{clear\PYGZus{}session}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TensorFlow session cleared}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Report memory after optimization}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Memory after optimization:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{print\PYGZus{}memory\PYGZus{}usage}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Use after heavy computations}
\PYG{c+c1}{\PYGZsh{} optimize\PYGZus{}memory()}
\end{sphinxVerbatim}


\subsection{Session Management}
\label{\detokenize{appendices/colab_setup:session-management}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Function to prevent Colab from disconnecting (prevents idle timeouts)}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{display}\PYG{p}{,} \PYG{n}{Javascript}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{time}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{keep\PYGZus{}alive}\PYG{p}{(}\PYG{n}{delay\PYGZus{}minutes}\PYG{o}{=}\PYG{l+m+mi}{55}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Prevents Colab from disconnecting due to inactivity.}
\PYG{l+s+sd}{    Note: Use responsibly and only when needed for long computations.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{delay\PYGZus{}seconds} \PYG{o}{=} \PYG{n}{delay\PYGZus{}minutes} \PYG{o}{*} \PYG{l+m+mi}{60}
    \PYG{n}{display}\PYG{p}{(}\PYG{n}{Javascript}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        function click\PYGZus{}connect()}\PYG{l+s+s1}{\PYGZob{}}
\PYG{l+s+s1}{            console.log(}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Clicking connect button}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{);}
\PYG{l+s+s1}{            document.querySelector(}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{colab\PYGZhy{}connect\PYGZhy{}button}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{).click()}
\PYG{l+s+s1}{        \PYGZcb{}}
\PYG{l+s+s1}{        setInterval(click\PYGZus{}connect, }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{delay\PYGZus{}seconds} \PYG{o}{*} \PYG{l+m+mi}{1000}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{l+s+s1}{);}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Keep\PYGZhy{}alive service started. Will refresh every }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{delay\PYGZus{}minutes}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ minutes.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Uncomment to use (be considerate of resources)}
\PYG{c+c1}{\PYGZsh{} keep\PYGZus{}alive(delay\PYGZus{}minutes=55)}
\end{sphinxVerbatim}


\subsection{Visualization Configuration for Neuroscience}
\label{\detokenize{appendices/colab_setup:visualization-configuration-for-neuroscience}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Standardized visualization setup for NeuroAI plots}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{setup\PYGZus{}neuro\PYGZus{}visualization}\PYG{p}{(}\PYG{n}{style}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{whitegrid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{context}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{talk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{palette}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Set up standardized visualization environment for neuroscience.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{set\PYGZus{}theme}\PYG{p}{(}\PYG{n}{style}\PYG{o}{=}\PYG{n}{style}\PYG{p}{,} \PYG{n}{context}\PYG{o}{=}\PYG{n}{context}\PYG{p}{,} \PYG{n}{palette}\PYG{o}{=}\PYG{n}{palette}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Configure matplotlib}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{figure.figsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{figure.dpi}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{100}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{savefig.dpi}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{300}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font.family}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sans\PYGZhy{}serif}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.titlesize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{18}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{14}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xtick.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{12}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ytick.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{12}
    
    \PYG{c+c1}{\PYGZsh{} Scientific notation settings}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.formatter.use\PYGZus{}mathtext}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{k+kc}{True}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{rcParams}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font.sans\PYGZhy{}serif}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Arial}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Helvetica}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{DejaVu Sans}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
    
    \PYG{c+c1}{\PYGZsh{} Default colormap options}
    \PYG{n}{cmap\PYGZus{}options} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brain}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}           \PYG{c+c1}{\PYGZsh{} Structural brain images}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{activation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Activation maps}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{connectivity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coolwarm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Connectivity matrices}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{category}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tab10}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Categorical data}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{continuous}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}    \PYG{c+c1}{\PYGZsh{} Continuous data}
    \PYG{p}{\PYGZcb{}}
    
    \PYG{k}{return} \PYG{n}{cmap\PYGZus{}options}

\PYG{c+c1}{\PYGZsh{} Set up visualization}
\PYG{n}{cmap\PYGZus{}options} \PYG{o}{=} \PYG{n}{setup\PYGZus{}neuro\PYGZus{}visualization}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Visualization environment configured for NeuroAI}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}


\section{C.5 Working with Specific NeuroAI Datasets}
\label{\detokenize{appendices/colab_setup:c-5-working-with-specific-neuroai-datasets}}

\subsection{Example: Loading and Processing MRI Data}
\label{\detokenize{appendices/colab_setup:example-loading-and-processing-mri-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Install necessary libraries}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }nibabel\PYG{+w}{ }nilearn\PYG{+w}{ }matplotlib

\PYG{c+c1}{\PYGZsh{} Sample code to download a test MRI dataset}
\PYG{o}{!}mkdir\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/mri\PYGZus{}sample
\PYG{o}{!}curl\PYG{+w}{ }\PYGZhy{}L\PYG{+w}{ }\PYGZhy{}o\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/mri\PYGZus{}sample/brain.nii.gz\PYG{+w}{ }https://github.com/nilearn/nilearn/raw/main/nilearn/datasets/data/avg152T1\PYGZus{}brain.nii.gz

\PYG{c+c1}{\PYGZsh{} Load and visualize MRI data}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{nibabel}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{nib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{nilearn}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{plotting}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}and\PYGZus{}view\PYGZus{}mri}\PYG{p}{(}\PYG{n}{filepath}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Load and display a 3D brain image.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load the NIfTI file}
    \PYG{n}{img} \PYG{o}{=} \PYG{n}{nib}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{filepath}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Image shape: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Image affine:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{img}\PYG{o}{.}\PYG{n}{affine}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Extract data array}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{get\PYGZus{}fdata}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot using nilearn}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Calculate middle slices}
    \PYG{n}{x\PYGZus{}mid}\PYG{p}{,} \PYG{n}{y\PYGZus{}mid}\PYG{p}{,} \PYG{n}{z\PYGZus{}mid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}
    
    \PYG{c+c1}{\PYGZsh{} Display middle slices}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{n}{x\PYGZus{}mid}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sagittal (x=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{x\PYGZus{}mid}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{y\PYGZus{}mid}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Coronal (y=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{y\PYGZus{}mid}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{z\PYGZus{}mid}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Axial (z=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{z\PYGZus{}mid}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Also show a nilearn 3D plot}
    \PYG{n}{plotting}\PYG{o}{.}\PYG{n}{plot\PYGZus{}anat}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3D MRI Visualization}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{img}\PYG{p}{,} \PYG{n}{data}

\PYG{c+c1}{\PYGZsh{} Load and view the sample MRI}
\PYG{n}{mri\PYGZus{}path} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{RAW\PYGZus{}DATA\PYGZus{}PATH}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/mri\PYGZus{}sample/brain.nii.gz}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{brain\PYGZus{}img}\PYG{p}{,} \PYG{n}{brain\PYGZus{}data} \PYG{o}{=} \PYG{n}{load\PYGZus{}and\PYGZus{}view\PYGZus{}mri}\PYG{p}{(}\PYG{n}{mri\PYGZus{}path}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Example: Working with EEG Data}
\label{\detokenize{appendices/colab_setup:example-working-with-eeg-data}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Install MNE for EEG/MEG data analysis}
\PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }mne

\PYG{c+c1}{\PYGZsh{} Download sample EEG data}
\PYG{o}{!}mkdir\PYG{+w}{ }\PYGZhy{}p\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/eeg\PYGZus{}sample
\PYG{o}{!}curl\PYG{+w}{ }\PYGZhy{}L\PYG{+w}{ }\PYGZhy{}o\PYG{+w}{ }\PYG{n+nv}{\PYGZdl{}RAW\PYGZus{}DATA\PYGZus{}PATH}/eeg\PYGZus{}sample/sample\PYGZus{}eeg.fif.gz\PYG{+w}{ }https://mne.tools/stable/\PYGZus{}downloads/e00c9bc516cb10e35d4d49e374ea8001/sample\PYGZus{}audvis\PYGZus{}raw.fif.gz

\PYG{c+c1}{\PYGZsh{} Process and visualize EEG data}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{mne}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{explore\PYGZus{}eeg\PYGZus{}data}\PYG{p}{(}\PYG{n}{filepath}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Load and explore EEG data using MNE\PYGZhy{}Python.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Load the data}
    \PYG{n}{raw} \PYG{o}{=} \PYG{n}{mne}\PYG{o}{.}\PYG{n}{io}\PYG{o}{.}\PYG{n}{read\PYGZus{}raw\PYGZus{}fif}\PYG{p}{(}\PYG{n}{filepath}\PYG{p}{,} \PYG{n}{preload}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Print basic information}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{EEG data loaded: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{filepath}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Number of channels: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{raw}\PYG{o}{.}\PYG{n}{ch\PYGZus{}names}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Sampling frequency: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{raw}\PYG{o}{.}\PYG{n}{info}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sfreq}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ Hz}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Duration: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{raw}\PYG{o}{.}\PYG{n}{times}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ seconds}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Basic preprocessing}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{filter}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Bandpass filter between 1\PYGZhy{}40 Hz}
    
    \PYG{c+c1}{\PYGZsh{} Plot the data}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{duration}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{n\PYGZus{}channels}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{scalings}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot the power spectral density}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{plot\PYGZus{}psd}\PYG{p}{(}\PYG{n}{fmax}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Plot channel locations}
    \PYG{n}{raw}\PYG{o}{.}\PYG{n}{plot\PYGZus{}sensors}\PYG{p}{(}\PYG{n}{show\PYGZus{}names}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{raw}

\PYG{c+c1}{\PYGZsh{} Load and explore the sample EEG data}
\PYG{n}{eeg\PYGZus{}path} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{RAW\PYGZus{}DATA\PYGZus{}PATH}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/eeg\PYGZus{}sample/sample\PYGZus{}eeg.fif.gz}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{eeg\PYGZus{}data} \PYG{o}{=} \PYG{n}{explore\PYGZus{}eeg\PYGZus{}data}\PYG{p}{(}\PYG{n}{eeg\PYGZus{}path}\PYG{p}{)}
\end{sphinxVerbatim}


\section{C.6 Collaboration and Sharing}
\label{\detokenize{appendices/colab_setup:c-6-collaboration-and-sharing}}

\subsection{Sharing Your Notebooks}
\label{\detokenize{appendices/colab_setup:sharing-your-notebooks}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Generate a link to share your notebook}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{google}\PYG{n+nn}{.}\PYG{n+nn}{colab}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{files}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{HTML}\PYG{p}{,} \PYG{n}{display}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}share\PYGZus{}link}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Display instructions for sharing the current notebook.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{display}\PYG{p}{(}\PYG{n}{HTML}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    \PYGZlt{}div style=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{background\PYGZhy{}color:\PYGZsh{}f8f9fa; padding:12px; border\PYGZhy{}radius:5px; margin\PYGZhy{}bottom:12px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}h3 style=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{margin\PYGZhy{}top:0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZgt{}Share this Notebook\PYGZlt{}/h3\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}p\PYGZgt{}To share this notebook:\PYGZlt{}/p\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}ol\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Click \PYGZlt{}b\PYGZgt{}File → Share\PYGZlt{}/b\PYGZgt{} in the menu\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Adjust sharing settings (View only, Comment, or Edit)\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Copy the link and share with collaborators\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}/ol\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}p\PYGZgt{}For version control, consider saving to GitHub:\PYGZlt{}/p\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}ol\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Click \PYGZlt{}b\PYGZgt{}File → Save a copy in GitHub\PYGZlt{}/b\PYGZgt{}\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Connect to your GitHub account if prompted\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{            \PYGZlt{}li\PYGZgt{}Select repository and file path\PYGZlt{}/li\PYGZgt{}}
\PYG{l+s+s2}{        \PYGZlt{}/ol\PYGZgt{}}
\PYG{l+s+s2}{    \PYGZlt{}/div\PYGZgt{}}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Show sharing instructions}
\PYG{n}{get\PYGZus{}share\PYGZus{}link}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Exporting Your Work}
\label{\detokenize{appendices/colab_setup:exporting-your-work}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Export notebook to different formats}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{google}\PYG{n+nn}{.}\PYG{n+nn}{colab}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{files}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{export\PYGZus{}notebook}\PYG{p}{(}\PYG{n}{format\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ipynb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Export the current notebook in the specified format.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    format\PYGZus{}type : str}
\PYG{l+s+sd}{        Format to export (\PYGZsq{}ipynb\PYGZsq{}, \PYGZsq{}py\PYGZsq{}, or \PYGZsq{}html\PYGZsq{})}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}
    \PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{json}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}ipython}
    
    \PYG{c+c1}{\PYGZsh{} Get the notebook filename}
    \PYG{n}{notebook\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/drive/MyDrive/temp\PYGZus{}notebook.ipynb}\PYG{l+s+s1}{\PYGZsq{}}
    
    \PYG{k}{if} \PYG{n}{format\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ipynb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Just download the notebook directly}
        \PYG{n}{files}\PYG{o}{.}\PYG{n}{download}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/notebook.ipynb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{elif} \PYG{n}{format\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{py}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Convert to Python script using nbconvert}
        \PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }nbconvert
        \PYG{o}{!}jupyter\PYG{+w}{ }nbconvert\PYG{+w}{ }\PYGZhy{}\PYGZhy{}to\PYG{+w}{ }python\PYG{+w}{ }/content/notebook.ipynb
        \PYG{n}{py\PYGZus{}filename} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/notebook.py}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{files}\PYG{o}{.}\PYG{n}{download}\PYG{p}{(}\PYG{n}{py\PYGZus{}filename}\PYG{p}{)}
    
    \PYG{k}{elif} \PYG{n}{format\PYGZus{}type} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{html}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Convert to HTML using nbconvert}
        \PYG{o}{!}pip\PYG{+w}{ }install\PYG{+w}{ }\PYGZhy{}q\PYG{+w}{ }nbconvert
        \PYG{o}{!}jupyter\PYG{+w}{ }nbconvert\PYG{+w}{ }\PYGZhy{}\PYGZhy{}to\PYG{+w}{ }html\PYG{+w}{ }/content/notebook.ipynb
        \PYG{n}{html\PYGZus{}filename} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/notebook.html}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{files}\PYG{o}{.}\PYG{n}{download}\PYG{p}{(}\PYG{n}{html\PYGZus{}filename}\PYG{p}{)}
    
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unsupported format: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{format\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Supported formats: }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{ipynb}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{py}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{html}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Export as Python script}
\PYG{c+c1}{\PYGZsh{} export\PYGZus{}notebook(format\PYGZus{}type=\PYGZsq{}py\PYGZsq{})}
\end{sphinxVerbatim}


\section{C.7 Troubleshooting Common Issues}
\label{\detokenize{appendices/colab_setup:c-7-troubleshooting-common-issues}}

\subsection{GPU Memory Issues}
\label{\detokenize{appendices/colab_setup:gpu-memory-issues}}
\sphinxAtStartPar
If you encounter GPU memory errors:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Check current GPU memory usage}
\PYG{o}{!}nvidia\PYGZhy{}smi

\PYG{c+c1}{\PYGZsh{} Reset runtime environment}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{tensorflow}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{tf}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{torch}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gc}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{reset\PYGZus{}gpu\PYGZus{}memory}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Reset GPU memory when you hit Out of Memory errors.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} Clear memory}
    \PYG{n}{gc}\PYG{o}{.}\PYG{n}{collect}\PYG{p}{(}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Clear PyTorch cache}
    \PYG{k}{if} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{is\PYGZus{}available}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{torch}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{empty\PYGZus{}cache}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PyTorch CUDA memory cleared}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Reset TensorFlow session}
    \PYG{n}{tf}\PYG{o}{.}\PYG{n}{keras}\PYG{o}{.}\PYG{n}{backend}\PYG{o}{.}\PYG{n}{clear\PYGZus{}session}\PYG{p}{(}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TensorFlow session reset}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Check GPU memory after clearing}
    \PYG{o}{!}nvidia\PYGZhy{}smi

\PYG{c+c1}{\PYGZsh{} Call when you get OOM errors}
\PYG{n}{reset\PYGZus{}gpu\PYGZus{}memory}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Connection Issues}
\label{\detokenize{appendices/colab_setup:connection-issues}}
\sphinxAtStartPar
To address connection issues:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Save your progress frequently}
\PYG{c+c1}{\PYGZsh{} 1. Auto\PYGZhy{}backup function for important variables}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pickle}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{os}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datetime}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{datetime}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{backup\PYGZus{}variables}\PYG{p}{(}\PYG{n}{variables\PYGZus{}dict}\PYG{p}{,} \PYG{n}{backup\PYGZus{}dir}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{./backup}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Save important variables to Google Drive as a backup.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Parameters:}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    variables\PYGZus{}dict : dict}
\PYG{l+s+sd}{        Dictionary of variable names and their values to backup}
\PYG{l+s+sd}{    backup\PYGZus{}dir : str}
\PYG{l+s+sd}{        Directory to save backups}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{backup\PYGZus{}dir}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Generate timestamp}
    \PYG{n}{timestamp} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{strftime}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{Y}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s2}{\PYGZus{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{H}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{M}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{S}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{backup\PYGZus{}file} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{backup\PYGZus{}dir}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/backup\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{timestamp}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.pkl}\PYG{l+s+s2}{\PYGZdq{}}
    
    \PYG{c+c1}{\PYGZsh{} Save variables}
    \PYG{k}{with} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{backup\PYGZus{}file}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{n}{pickle}\PYG{o}{.}\PYG{n}{dump}\PYG{p}{(}\PYG{n}{variables\PYGZus{}dict}\PYG{p}{,} \PYG{n}{f}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Backup saved to }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{backup\PYGZus{}file}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{c+c1}{\PYGZsh{} Also save to Drive if mounted}
    \PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/drive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{drive\PYGZus{}backup\PYGZus{}dir} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/content/drive/MyDrive/NeuroAI\PYGZhy{}Handbook/backups}\PYG{l+s+s1}{\PYGZsq{}}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{drive\PYGZus{}backup\PYGZus{}dir}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{drive\PYGZus{}backup\PYGZus{}file} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{drive\PYGZus{}backup\PYGZus{}dir}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/backup\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{timestamp}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.pkl}\PYG{l+s+s2}{\PYGZdq{}}
        
        \PYG{k}{with} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{drive\PYGZus{}backup\PYGZus{}file}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
            \PYG{n}{pickle}\PYG{o}{.}\PYG{n}{dump}\PYG{p}{(}\PYG{n}{variables\PYGZus{}dict}\PYG{p}{,} \PYG{n}{f}\PYG{p}{)}
        
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Backup also saved to Google Drive: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{drive\PYGZus{}backup\PYGZus{}file}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{backup\PYGZus{}file}

\PYG{c+c1}{\PYGZsh{} Example usage}
\PYG{c+c1}{\PYGZsh{} important\PYGZus{}vars = \PYGZob{}}
\PYG{c+c1}{\PYGZsh{}     \PYGZsq{}trained\PYGZus{}model\PYGZsq{}: model,}
\PYG{c+c1}{\PYGZsh{}     \PYGZsq{}history\PYGZsq{}: training\PYGZus{}history,}
\PYG{c+c1}{\PYGZsh{}     \PYGZsq{}test\PYGZus{}results\PYGZsq{}: test\PYGZus{}results}
\PYG{c+c1}{\PYGZsh{} \PYGZcb{}}
\PYG{c+c1}{\PYGZsh{} backup\PYGZus{}path = backup\PYGZus{}variables(important\PYGZus{}vars)}

\PYG{c+c1}{\PYGZsh{} Function to restore from backup}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{restore\PYGZus{}from\PYGZus{}backup}\PYG{p}{(}\PYG{n}{backup\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Restore variables from backup file.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{with} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{backup\PYGZus{}file}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rb}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{n}{variables} \PYG{o}{=} \PYG{n}{pickle}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{f}\PYG{p}{)}
    
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Restored variables from }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{backup\PYGZus{}file}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Available variables: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{variables}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    
    \PYG{k}{return} \PYG{n}{variables}

\PYG{c+c1}{\PYGZsh{} Example: Restore from most recent backup}
\PYG{c+c1}{\PYGZsh{} latest\PYGZus{}backup = max(glob.glob(\PYGZsq{}./backup/backup\PYGZus{}*.pkl\PYGZsq{}), key=os.path.getctime)}
\PYG{c+c1}{\PYGZsh{} restored\PYGZus{}vars = restore\PYGZus{}from\PYGZus{}backup(latest\PYGZus{}backup)}
\end{sphinxVerbatim}


\section{C.8 Resources and References}
\label{\detokenize{appendices/colab_setup:c-8-resources-and-references}}

\subsection{Useful Links}
\label{\detokenize{appendices/colab_setup:useful-links}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://colab.research.google.com/notebooks/basic\_features\_overview.ipynb}{Google Colab Documentation}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://colab.research.google.com/signup}{Google Colab Pro Features}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://colab.research.google.com/notebooks/keyboardshortcuts.ipynb}{Colab Keyboard Shortcuts}

\end{itemize}


\subsection{NeuroAI\sphinxhyphen{}Specific Resources}
\label{\detokenize{appendices/colab_setup:neuroai-specific-resources}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://portal.brain-map.org/}{Allen Brain Atlas}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.humanconnectome.org/}{Human Connectome Project}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://neuralensemble.org/}{NeuralEnsemble}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://openneuro.org/}{OpenNeuro}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.nitrc.org/}{NeuroImaging Tools \& Resources Collaboratory}

\end{itemize}


\subsection{Citation}
\label{\detokenize{appendices/colab_setup:citation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nd}{@book}\PYG{p}{\PYGZob{}}\PYG{n}{neuroai\PYGZus{}handbook\PYGZus{}2024}\PYG{p}{,}
  \PYG{n}{title}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{n}{NeuroAI} \PYG{n}{Handbook}\PYG{p}{:} \PYG{n}{Bridging} \PYG{n}{Neuroscience} \PYG{o+ow}{and} \PYG{n}{Artificial} \PYG{n}{Intelligence}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
  \PYG{n}{author}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{n}{NeuroAI} \PYG{n}{Contributors}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
  \PYG{n}{year}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+m+mi}{2024}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
  \PYG{n}{publisher}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{n}{Online} \PYG{n}{Resource}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
  \PYG{n}{url}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{n}{https}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{github}\PYG{o}{.}\PYG{n}{com}\PYG{o}{/}\PYG{n}{yourusername}\PYG{o}{/}\PYG{n}{NeuroAI}\PYG{o}{\PYGZhy{}}\PYG{n}{Handbook}\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}







\renewcommand{\indexname}{Index}
\printindex
\end{document}